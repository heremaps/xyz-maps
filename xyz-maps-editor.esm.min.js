/*
 * @here/xyz-maps-editor
 * (c) 2019-2022 HERE
 */
import{JSUtils as e,geometry as t,vec3 as i,geotools as r,global as o,Listener as s,Map as n,Set as a}from"@here/xyz-maps-common";import{Feature as l,webMercator as c,XYZLayerStyle as d,LocalProvider as h,TileLayer as p,EditableFeatureProvider as g,GeoPoint as u,PixelPoint as A}from"@here/xyz-maps-core";import{styleTools as f}from"@here/xyz-maps-display";var y,m=(e,t,i)=>{e.editState("modified",Date.now());const r=e._e(),{history:o}=r.objects;if(t.isGeoMod&&!t.isMarking){t.isMarking=!0;const i=o.getHistoryFeature(e).geometry.coordinates;r.hooks.trigger("Coordinates.update",{feature:e,previousCoordinates:i},e.getProvider()),t.isGeoMod=!1,t.isMarking=!1}return(null==i||i)&&o.saveChanges(),e};!function(e){e[e.GEOMETRY=1]="GEOMETRY",e[e.REMOVE=2]="REMOVE"}(y||(y={}));const v={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,snapTolerance:2,intersectionScale:5,routingPointPrecision:5,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,snapOnDrag:!0};let _;function S(e,t,i){e._e().listeners.trigger(t,e,i)}function L(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,isGeoMod:!1}),t?i[t]:i}function b(e){this.editState("hovered","pointerenter"==e.type),this._e().listeners.trigger(e,this)}const E={private:L,_evl:{pointerdown:function(e){const t=L(this);t.moved=!1;const i=this.geometry.coordinates,r=e.detail.display.geoToPixel(i[0],i[1]);t.x=r.x,t.y=r.y,t.button=e.button,t.z=i[2]||0,S(this,e,"pointerdown")},pointerup:function(e){const t=L(this),i=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?E._select(this):i&&E.markAsModified(this),S(this,e,i?"dragStop":"pointerup")},pointerenter:b,pointerleave:b},deHighlight:function(e){const t=L(e);t.selector&&(e.editState("selected",!1),e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=_,t.pressmove=_)},_editable:function(e,t){const i=L(e);return t!=_&&(i.isEditable=!!t),E.deHighlight(e),i.isEditable},_select:function(e){const t=e._e();if(t.objects.selection.select(e)){const i=L(e),r=t.getStyleProperty(e,"altitude");if(e.editState("selected",!0),i.pressmove=(o,s,n)=>{if(i.isEditable&&i.isSelected&&!t._config.editRestrictions(e,y.GEOMETRY)){let s=[...e.geometry.coordinates];"number"==typeof r&&(s[2]=r),s=_t(o.mapX,o.mapY,e,s,t),E._setCoords(e,s),S(e,o,i.moved?"dragMove":"dragStart"),i.moved=!0}},!i.selector){const o=t.getMaxZLayer(e);i.selector=t.objects.overlay.addCircle(e.coord(),_,{type:"MARKER_SELECTOR",parentType:"MARKER",MARKER:{properties:e.prop(),altitude:r,zLayer:o}})}}},_setCoords:function(e,t){e._e().objects.history.origin(e);const i=L(e,"selector");i&&i._provider.setFeatureCoordinates(i,t),e.getProvider().setFeatureCoordinates(e,t.slice()),L(e).isGeoMod=!0},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),E.deHighlight(e)},markAsModified:function(e,t){return m(e,L(e),t)}},x=Math,k=x.PI,C=x.pow,P=x.sqrt,I=(e,t,i=0,o=e.length,s=[])=>{let n=0,a=0;o--;for(let t=i+1;t<o;t++){const s=D(e[t],e[i],e[o],r.distance);s>n&&(a=t,n=s)}return n>t?(I(e,t,i,a,s),I(e,t,a,o+1,s)):(s.push(e[i]),o-i>0&&s.push(e[o])),s},R=t.intersectBBox,O=(e,t,r)=>{null==e[2]&&(e=[e[0],e[1],0]);const o=[t[0]-e[0],t[1]-e[1],(t[2]||0)-e[2]];return i.scale(o,i.normalize(o,o),r),i.add(o,o,e)},w=(e,t)=>{let i=999999,r=!1;for(let o=0;o<e.length-1;o++){const s=o+1,n=M(e[o],e[s],t);if(n){const e=z(n,t);e<i&&(i=e,r=o)}}return r},N=(e,t,r,o)=>{const s=i.sub([],t,e),n=i.sub([],o,r),a=i.sub([],e,r),l=i.dot(a,s),c=i.dot(a,n),d=i.dot(s,n),h=i.dot(s,s),p=i.dot(n,n),g=(c*d-l*p)/(h*p-d*d),u=(c+g*d)/p,A=i.add([],e,i.scale([],s,g)),f=i.add([],r,i.scale([],n,u)),y=0<=g&&g<=1&&0<=u&&u<=1,m=i.length(i.sub([],A,f));return{p0:A,p1:f,onSegment:y,intersects:m<=1e-7,distance:m}},F=(e,t,i,r,o)=>{const s=(r[1]-i[1])*(t[0]-e[0])-(r[0]-i[0])*(t[1]-e[1]);if(0!=s){const n=((r[0]-i[0])*(e[1]-i[1])-(r[1]-i[1])*(e[0]-i[0]))/s,a=((t[0]-e[0])*(e[1]-i[1])-(t[1]-e[1])*(e[0]-i[0]))/s,l=e[2]||0,c=t[2]||0;if(0<=n&&n<=1&&0<=a&&a<=1)return!o||[e[0]+n*(t[0]-e[0]),e[1]+n*(t[1]-e[1]),l+n*(c-l)]}return!1},M=(e,t,i)=>{if(e[0]==t[0]){let r=[e[0],i[1]];return!!K(e,t,r)&&r}if(e[1]==t[1]){let r=[i[0],e[1]];return!!K(e,t,r)&&r}const r=(t[1]-e[1])/(t[0]-e[0]),o=e[1]-r*e[0],s=-1/r,n=(i[1]-s*i[0]-o)/(r-s),a=[n,r*n+o];return!!K(e,t,a)&&a},T=(e,t,r,o)=>{const s=i.sub([],r,e),n=i.sub([],t,e),a=i.sub([],t,e);let l=i.dot(n,s)/i.dot(n,n);return o&&(l=Math.max(0,Math.min(1,l))),i.scale(a,a,l),i.add(a,a,e)},j=(e,t,r,o,s)=>{const n=i.sub([],t,o),a=i.dot(n,r)/i.dot(e,r);return a==1/0?null:i.sub([],t,i.scale([],e,a))},B=(e,t,i)=>{let r=e[2]||0,o=t[2]||0;return[(t[0]-e[0])*i+e[0],(t[1]-e[1])*i+e[1],r+(o-r)*i]},D=(e,t,i,r=z)=>{const o=e[0],s=e[1],n=t[0],a=t[1],l=i[0],c=i[1],d=l-n,h=c-a,p=((o-n)*d+(s-a)*h)/(d*d+h*h);let g;return g=p<0?[n,a]:p>1?[l,c]:[n+p*d,a+p*h],r([o,s],g)},G=(e,t)=>{let i=1/0;const r=t.length-1;for(let o=0;o<r;o++){const r=D(e,t[o],t[o+1]);r<i&&(i=r)}return i},z=(e,t)=>P(C(e[0]-t[0],2)+C(e[1]-t[1],2)),K=(e,t,i,r)=>{r=r||1e-7;const o=i[0]-e[0],s=i[1]-e[1];let n=t[0]-e[0],a=t[1]-e[1],l=(o*n+s*a)/(n*n+a*a);return l=l<0?0:l>1?1:l,n=o-l*n,a=s-l*a,l=n*n+a*a,l<r*r},H=e=>{let t=0;for(let i=0;i<e.length-1;i++)t+=z(e[i],e[i+1]);return t},V=(e,t,i=!0)=>{let r,o,s,n,a=0;for(let l=0;l<e.length-1;l++)if(o=e[l],s=e[l+1],a+=r=z(o,s),!i||a>=t)return n=(t-(a-r))/r,[(s[0]-o[0])*n+o[0],(s[1]-o[1])*n+o[1]];return s},Y=(e,t,i)=>{const r=z(i,e),o=((e,t)=>{const i=t[0]-e[0],r=t[1]-e[1];return i||r?(180+180*x.atan2(r,i)/k)%360:0})(e,i);return[i[0]+r*x.cos((t+o)/180*k),i[1]+r*x.sin((t+o)/180*k)]};function Z(e,t,i){for(let r=0,o=i.length-1;r<o;r++)if(F(e,t,i[r],i[r+1]))return 1}function U(e,t){for(let i=0,r=e.length-1;i<r;i++)if(Z(e[i],e[i+1],t))return 1}function W(e,t){const i=e[0],r=e[1];let o=!1;for(let e=0,s=t.length-1;e<t.length;s=e++){const n=t[e][0],a=t[e][1],l=t[s][0],c=t[s][1];a>r!=c>r&&i<(l-n)*(r-a)/(c-a)+n&&(o=!o)}return o}function Q(e,t,i){for(let r=0^i,o=e.length;r<o;r++)for(let i=0;i<e[r].length;i++)if(!W(e[r][i],t))return 0;return 1}let X;const J=(e,t,i,r=0,o=0,s)=>{const n=X.getCoords(e),a=n[o],l=a[r],c=l[i];if(!X.willSelfIntersect(l,t,i)){if(l[i]=t,i||(l[l.length-1]=t),!function(e,t,i){for(let r=0,o=t.length;r<o;r++)if(r!=i&&U(e,t[r]))return 1}(l,a,r)&&Q(a,a[0],1)){const i=X.private(e,"shapePnts");if(s=s||X.getConnectedAreas(e,c),e.behavior("snapCoordinates"))for(let e=0;e<s.length;e++){let i=s[e];const{coordinates:r,polyIndex:o,lineIndex:n,coordIndex:a}=i,l=r[o],c=l[n];if(i.area.behavior("snapCoordinates")){c[a][0]=t[0],c[a][1]=t[1],a||(c[c.length-1]=t);if(!(!X.willSelfIntersect(c,t,a)&&Q(l,l[0],1)))return!1}else r.splice(e,1)}for(let{area:e,coordinates:t}of s)X._setCoords(e,t,!1);X._setCoords(e,n,!1);for(let e of i){const{coordinates:i}=e.geometry;i[0]==c[0]&&i[1]==c[1]&&e.getProvider().setFeatureCoordinates(e,t.slice())}}return!0}};let q;class $ extends l{constructor(e,t,i,r,o){X=o;const s=e._e(),n=s.display.getLayers().indexOf(s.getLayer(e))+1;super({type:"Feature",geometry:{type:"Point",coordinates:[t,i]},properties:{type:"AREA_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:s.getStyle(e),zLayer:n?n+1:q}}},s.objects.overlay.layer.getProvider());const a=this,l=s.objects.overlay;function c(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,s.setStyle(this)}function d(e,t){s.listeners.trigger(e,a,t)}let h=!1;return this.__={area:e,pointerdown:function(){h=!1,a.__.cAreas=X.getConnectedAreas(e,a.geometry.coordinates)},pressmove:function(t,i,r,o,n){var c;const p=s._config;if(p.editRestrictions(e,y.GEOMETRY))return;h||(h=!0,X.hideShape(X.private(e,"midShapePnts"),l),null===(c=e.__.hk)||void 0===c||c.hide(),d(t,"dragStart"));const g=a.getIndex(),u=a.properties.poly,A=a.properties.hole;let f=s.map.getGeoCoord(t.mapX,t.mapY);e.behavior("snapCoordinates")&&(f=X.snapShape(a,f,p.snapTolerance)||f),J(e,f,g,A,u,a.__.cAreas)},pointerup:function(t){var i;if(h){if(e.behavior("snapCoordinates")){const e=a.__.cAreas;for(let{area:t}of e)X.markAsModified(t,!1)}X.markAsModified(e),null===(i=e.__.hk)||void 0===i||i.show(),X.addVShapes(e)}d(t,h?"dragStop":q)},pointerenter:c,pointerleave:c},a}getArea(){return this.__.area}remove(){return X.deleteShape(this.getArea(),this)}getIndex(){return this.properties.index}removeGeometry(){const e=this.getArea(),t=this.properties.poly,i=this.properties.hole,r=e.coord();r[t].splice(i,1),X._setCoords(e,r,!1),X.deHighlight(e),X._select(e),X.markAsModified(e)}}$.prototype.class="AREA_SHAPE";class ee extends l{constructor(e,t,i,r,o){const s=e._e(),n=s.display.getLayers().indexOf(s.getLayer(e))+1,a=s.objects.overlay;super({type:"Feature",geometry:{type:"Point",coordinates:[t,i]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:r[0],index:r[1],hole:r[2],AREA:{style:s.getStyle(e),zLayer:n?n+1:undefined}}},a.layer.getProvider());const l=this;let c;function d(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,s.setStyle(this)}l.__={area:e,pointerdown:function(){c=null},pressmove:function(t,i,r,s,n){const a=l.properties,d=a.index+1,h=a.poly,p=l.geometry.coordinates;if(!c){const t=o.private(e,"midShapePnts");for(let i,r,s,n=0;n<t.length;n++)i=t[n],r=i.geometry.coordinates,r[0]==p[0]&&r[1]==p[1]&&(s=i.properties,o.addShp(e,p.slice(),s.poly,s.hole,s.index+1));c=o.getShp(e,h,a.hole,d),c.__.pointerdown.apply(c)}c.__.pressmove.apply(c,arguments)},pointerup:function(t){if(c){const{poly:i,hole:r,index:s}=l.properties,n=o.getShp(e,i,r,s+1);n.__.pointerup.call(n,t)}},pointerenter:d,pointerleave:d}}getArea(){return this.__.area}}const te=t.centroid;let ie;const re=e=>{const{geometry:t}=e;return te("Polygon"==t.type?t.coordinates:t.coordinates[0])};class oe extends l{constructor(e,t,i){ie=i;const r=e._e(),o=r.display.getLayers().indexOf(r.getLayer(e))+1,[s,n]=re(e);function a(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,r.setStyle(this)}super({type:"Feature",geometry:{type:"Point",coordinates:[s,n,t]},properties:{type:"AREA_HEIGHT_KNOB",offsetZ:0,AREA:{style:r.getStyle(e),zLayer:o?o+1:undefined}}},r.objects.overlay.layer.getProvider()),this.__={area:e,iEditor:r,overlay:r.objects.overlay,pointerdown:function(){this.properties.isMoved=!1,this.properties.offsetZ=this.__.iEditor.getStyleProperty(this,"offsetZ")||0},pressmove:function(e,t,i,r,o){const{area:s,iEditor:n}=this.__;let{offsetZ:a}=this.properties,l=n.map.translateZ(this.geometry.coordinates,a);l=_t(e.mapX,e.mapY,this,l,n,{axis:[0,0,1]});let[,,c]=n.map.translateZ(l,-a);c=Math.max(0,c),this.update(c),s.getProvider().writeFeatureHeight(s,c),ie._setCoords(s,s.geometry.coordinates),this.properties.isMoved=!0},pointerup:function(e){this.properties.isMoved&&ie.markAsModified(this.__.area)},pointerenter:a,pointerleave:a}}update(e){const t=re(this.__.area);t[2]=e,this.__.overlay.setFeatureCoordinates(this,t)}remove(){this.__.overlay.remove(this)}hide(){this.__.overlay.hideFeature(this)}show(){this.update(this.geometry.coordinates[2]),this.__.overlay.showFeature(this)}getArea(){return this.__.area}}function se(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?i[t]:i}function ne(e){const t=se(e),i=e._e().objects.overlay;pe.hideShape(t.shapePnts,i),pe.hideShape(t.midShapePnts,i)}function ae(e,t,i,r){const o=e._e().objects.overlay;for(let e=0;e<i.length;e++){let s=i[e];for(let i=0;i<s.length-1;i++){let n=r(s[i],s[i+1],i,e);o.addFeature(n),t.push(n)}}}function le(e){const t=se(e,"midShapePnts"),i=pe.getCoords(e);for(let r=0;r<i.length;r++)ae(e,t,i[r],((t,i,o,s)=>new ee(e,(t[0]+i[0])/2,(t[1]+i[1])/2,[r,o,s],pe)))}function ce(e){if(se(e,"isSelected")){ne(e),function(e){const t=se(e,"shapePnts"),i=pe.getCoords(e);for(let r=0;r<i.length;r++)ae(e,t,i[r],((t,i,o,s)=>new $(e,t[0],t[1],[r,o,s],pe)))}(e),le(e);const t=e.getProvider().readFeatureHeight(e);if(pe.isExtruded(e)&&"number"==typeof t){let i=e.__.hk;if(i)i.show();else{i=e.__.hk=new oe(e,t,pe);e._e().objects.overlay.addFeature(i)}i.update(t)}}}function de(e){const t=this,i=se(t);i.allowEdit&&!i.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function he(e){const t=this,i=se(t);i.isSelected||this._e()._config.featureSelectionByDefault&&i.allowEdit&&pe._select(t),t._e().listeners.trigger(e,t)}const pe={private:se,_evl:{pointerenter:de,pointerleave:de,dbltap:he,pointerup:he},deHighlight:function(e){var t;const i=se(e);i.isSelected&&(ne(e),null===(t=e.__.hk)||void 0===t||t.remove(),e.__.hk=null,e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),i.isSelected=!1)},_editable:function(e,t){const i=se(e);t&&t!=i.allowEdit?document.body.style.cursor="pointer":t||t==i.allowEdit||(pe.deHighlight(e),document.body.style.cursor="default"),i.allowEdit=t},isExtruded(e){if("number"==typeof e._e().getStyleProperty(e,"extrude"))return!0},_select:function(e){const t=se(e),i=e._e();t.isSelected||(i.objects.selection.select(e),i.dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),i.setStyle(e),ce(e))},_setCoords:function(e,t,i){"number"==typeof t[0][0][0]&&(t=[t]);let r=t.length;for(;r--;){const e=t[r];let i=e.length;for(;i--;){const t=e[i];t[t.length-1]=t[0]}}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),se(e).isGeoMod=!0,e.getProvider().setFeatureCoordinates(e,t),i&&ce(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),pe.deHighlight(e)},markAsModified:function(e,t){return m(e,se(e),t)},deleteShape:function(e,t){const i=t.properties,r=pe.getCoords(e),o=r[i.poly][i.hole];return!(o.length<=4)&&(o.splice(t.getIndex(),1),pe._setCoords(e,r),pe.deHighlight(e),pe._select(e),pe.markAsModified(e),!0)},getCoords:e=>{let t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:e=>{let t=0;for(let i,r=0,o=e.length-1;r<o;r++)i=(r+1)%o,t+=e[r][0]*e[i][1],t-=e[i][0]*e[r][1];return t<0},getMaxSpace:function(e,t,i){const r=e._e(),o=t[0],s=t[1];let n=1e5;const a=[[o+n,s-n],[o-n,s+n],[o+n,s+n],[o-n,s-n]];n=1/0;for(let e=0,o=i.length-1;e<o;e++){const s=(e+1)%o,l=r.map.getPixelCoord(i[e]),c=r.map.getPixelCoord(i[s]);let d=0;for(;d<4;){const e=F(a[d++],a[d++],l,c,!0);if(e){const i=z(t,e);i<n&&(n=0^i)}}}return n},getPoly:function(e,t){let i=pe.getCoords(e),r=1/0,o=null;for(let e,s=0;s<i.length;s++)e=G(t,i[s][0]),e<r&&(r=e,o=s);return o},addVShapes:le,getShp:function(e,t,i,r){const o=se(e,"shapePnts");for(let e,s=0;s<o.length;s++)if(e=o[s].properties,e.poly==t&&e.index==r&&e.hole==i)return o[s]},addShp:function(e,t,i,r,o){const s=pe.getCoords(e),n=s[i][r],a="number"==typeof o?o:w(n,t)+1;for(let e=0;e<n.length;e++)if(n[e][0]==t[0]&&n[e][1]==t[1])return!1;return n.splice(a,0,t),pe._setCoords(e,s),ce(e),a},hideShape:function(e,t){Array.isArray(e)||(e=[e]);for(let i=0;i<e.length;i++)t.remove(e[i]);e.length=0},snapShape:(e,t,i)=>{const r=e.getArea(),{cAreas:o}=e.__,s=r._e(),n=i,a=r.getProvider().search({point:t,radius:n});for(let e of a)if(e.id!=r.id&&"AREA"==e.class)for(let i of pe.getCoords(e)){const r=i[0],a=s.map.searchPointOnLine(r,t,n,undefined,n);if(a&&!o.find((({area:t})=>t==e)))return a.point}},willSelfIntersect:(e,t,i)=>{let r=0==i?e.length-2:i-1,o=i+1;for(let s,n=0,a=e.length-1;n<a;n++){if(s=n+1,o==a){if(n&&n<r&&F(t,e[o],e[n],e[n+1]))return!0}else if(n!=o&&(s%=a,i!=s&&n!=i&&F(t,e[o],e[n],e[s])))return!0;if(n>i){if(s%=a,s!=r&&n!=r&&F(e[r],t,e[n],e[s]))return!0}else if(s<r&&n!=i&&F(e[r],t,e[n],e[s]))return!0}return!1},validateGeometry:e=>{for(let t=1;t<e.length-1;t+=1)if(pe.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:(e,t)=>{let i=[];const r=e._e(),o=r.getLayer(e),s=e=>Math.round(1e9*e),n=s(t[0]),a=s(t[1]),l=r.objects.getInBBox([t[0],t[1],t[0],t[1]],o);let c=l.length;for(;c--;){const t=l[c],r=pe.getCoords(t);let o=r.length;for(;o--;){let l=r[o].length;for(;l--;){const c=r[o][l];let d=c.length-1;for(;d--;)s(c[d][0])==n&&s(c[d][1])==a&&t!=e&&i.push({area:t,polyIndex:o,lineIndex:l,coordIndex:d,coordinates:r})}}}return i}};let ge;const ue={dragPlane:"XY"},Ae="@ns:com:here:editor";class fe extends l{constructor(e,t,i,r,o,s){ge=s;const n=e._e().getResolvedStyle(e);super({type:"Feature",properties:{lineStringIndex:i,index:r,LINE:{properties:e.prop(),style:n,zLayer:o}},geometry:{type:"Point",coordinates:t}}),this._l=e,this.properties[Ae]={selected:this.isSelected()}}behavior(e,t){let i=((e,t)=>{const i=e.__||(e.__={b:Object.assign({},ue)});return t?i[t]:i})(this,"b");switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const r={};r[e]=t,e=r}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}getLine(){return this._l}getLength(){return this._l.geometry.coordinates.length}getIndex(){return this.properties.index}getLineStringIndex(){return this.properties.lineStringIndex}remove(){const e=this.getLine();ge.removeCoord(e,this.properties.index,this.properties.lineStringIndex),ge.markAsModified(e)}select(){const e=this,t=e.getLine(),i=ge.private(t,"selectedShapes"),{lineStringIndex:r,index:o}=e.properties;i[r]||(i[r]=[]),i[r][o]=!0,e.properties[Ae].selected=!0,ge.displayShapes(t)}unselect(){const e=this,t=e.getLine();t._e(),e.properties[Ae].selected=!1;const i=ge.private(t,"selectedShapes"),{lineStringIndex:r,index:o}=e.properties;i[r]&&(i[r][o]=!1),ge.displayShapes(t)}isSelected(){var e;const t=ge.private(this.getLine(),"selectedShapes"),{lineStringIndex:i,index:r}=this.properties;return!!(null===(e=t[i])||void 0===e?void 0:e[r])}pointerdown(e){const t=this,i=t.properties,r=t.geometry.coordinates,o=e.detail.display,s=t.getLine();i.moved=!1;const n=o.geoToPixel(...r);i.x=n.x,i.y=n.y,i.button=e.button,i.z=r[2]||0,ge.removeShapes(s,"vShps","LINE_VIRTUAL_SHAPE"==t.class&&this),s._e().listeners.trigger(e,this,"pointerdown")}getSelectedShapes(e,t){var i;const r=this.getLine();let o=ge.private(r,"selectedShapes"),s=ge.private(r,"shps"),n=[];for(let r=0;r<o.length;r++)for(let a=0;a<(null===(i=o[r])||void 0===i?void 0:i.length);a++)o[r][a]&&(arguments.length&&t==r&&e==a||n.push(s[r][a]));return n}pressmove(e,t,r){const o=this,s=this.properties,{lineStringIndex:n,index:a}=s,l=o.getLine(),c=l._e(),d=ge.getCoordinates(l),h=d[n],p=!c.getStyleProperty(l,"altitude"),g=h[a][2],u=o.geometry.coordinates.slice(0,p?2:3);s.moved||(s.moved=!0,c.listeners.trigger(e,this,"dragStart"));let A=h[a]=_t(e.mapX,e.mapY,o,u,c);if(p&&"number"==typeof g&&(A[2]=g),this.isSelected()){const e=c.display,t=e._g2w(u),r=e._g2w(A),o=i.sub(r,r,t);for(let t of this.getSelectedShapes(s.index,n)){const{properties:r}=t,s=e._g2w(t.geometry.coordinates);i.add(s,s,o);const n=e._w2g(s);d[r.lineStringIndex][r.index]=n,t.getProvider().setFeatureCoordinates(t,n)}}o.getProvider().setFeatureCoordinates(o,A.slice()),ge._setCoords(l,d)}pointerup(e){const t=this.getLine(),i=this.properties.moved;i&&ge.markAsModified(t),ge.displayShapes(t),t._e().listeners.trigger(e,this,i?"dragStop":undefined)}}let ye,me;fe.prototype.class="LINE_SHAPE";class ve extends fe{constructor(e,t,i,r,o,s){ye=s,super(e,t,i,r,o,s)}pointerdown(e){super.pointerdown(e)}pressmove(e,t,i){const{properties:r}=this,o=this,s=o.getLine();r.moved||(r.index++,ye.addCoord(s,o.geometry.coordinates.slice(),r.index,r.lineStringIndex),ye.removeShapes(s,"vShps",o)),super.pressmove(e,t,i)}pointerup(e){this.getProvider().removeFeature(this),super.pointerup(e)}}function _e(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[],selectedShapes:[],isGeoMod:!1}),t?i[t]:i}ve.prototype.class="LINE_VIRTUAL_SHAPE";const Se=(e,t,i=!1)=>{t&&e.editState(t,i),e._e().setStyle(e,me)};function Le(e){_e(this,"isEditable")&&this._e().listeners.trigger(e,this)}const be={private:_e,_evl:{pointerenter:Le,pointerleave:Le,pointerup:function(e){const t=this,i=_e(t);i.isEditable&&(!i.isSelected&&t._e()._config.featureSelectionByDefault&&be._select(t),t._e().listeners.trigger(e,t))}},addCoord:(e,t,i,r)=>{var o;let s=be.getCoordinates(e,r);if(i==me){const e=w(s,t);if(!1===e)return e;i=e+1}return s.splice(i,0,t),be._setCoords(e,s,r),null===(o=_e(e,"selectedShapes")[r])||void 0===o||o.splice(i,0,me),i},removeCoord:(e,t,i)=>{var r;let o=be.getCoordinates(e,i);const s=o.length;let n;return s>2&&t>=0&&t<s&&(n=o.splice(t,1),null===(r=_e(e,"selectedShapes")[i])||void 0===r||r.splice(t,1),be._setCoords(e,o,i),be.displayShapes(e)),n},createShapes:(e,t,i,r,o)=>{const s=_e(e,r),n=s[t]=s[t]||[],a=e._e(),l=a.getMaxZLayer(e)-1,c=a.getStyleProperty(e,"altitude");for(let r=0;r<i.length;r++){let s=i[r].slice();"number"==typeof c&&(s[2]=c),n[r]=new o(e,s,t,r,l,be),a.objects.overlay.addFeature(n[r])}},createVShapes:(e,t=0,i)=>{const r=[];for(let e=1;e<i.length;e++)r.push(B(i[e-1],i[e],.5));be.createShapes(e,t,r,"vShps",ve)},displayShapes:e=>{if(_e(e,"isSelected")){const{geometry:t}=e;let i;i="LineString"==t.type?[t.coordinates]:t.coordinates,be.removeShapes(e,"shps"),be.removeShapes(e,"vShps");for(let t=0;t<i.length;t++)be.createShapes(e,t,i[t],"shps",fe),be.createVShapes(e,t,i[t])}},removeShapes:(e,t,i)=>{const r=_e(e,t);r.forEach((t=>{t!=i&&e._e().objects.overlay.remove(t)})),r.length=0},deHighlight:function(e){_e(e,"isSelected")&&(Se(e,"selected",!1),be.removeShapes(e,"shps"),be.removeShapes(e,"vShps"))},_editable:function(e,t){const i=_e(e);return t!=me&&(i.isEditable=!!t),be.deHighlight(e),i.isEditable},simplifyGeometry(e,t){if("string"==typeof t){const i=t.endsWith("m");if(t=parseFloat(t),i){const[i,r,o,s]=e.getBBox(),n=r-(s-r)/2;t*=c.earthCircumference(n)/c.mapSizePixel(256,e._e().display.getZoomlevel())}}const{type:i}=e.geometry,r="LineString"==i,o=e.coord(),s=r?[o]:o;for(let e=0;e<s.length;e++)s[e]=I(s[e],t);e.coord(r?s[0]:s)},_select:function(e){e._e().objects.selection.select(e)&&(_e(e,"selectedShapes").length=0,Se(e,"selected",!0),be.displayShapes(e))},isMultiLineString:e=>"MultiLineString"==e.geometry.type,getCoordinates(e,t){let i=e.coord();return be.isMultiLineString(e)||(i=[i]),t>=0?i[t]:i},_setCoords:function(e,t,i){e._e().objects.history.origin(e),_e(e).isGeoMod=!0;let r=t;be.isMultiLineString(e)?i>=0&&(r=e.coord(),r[i]=t):"number"!=typeof r[0][0]&&(r=r[0]),e.getProvider().setFeatureCoordinates(e,r)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),be.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return m(e,_e(e),t)}};class Ee{constructor(e,t){this.offset=e,this.distance=t}}const xe=(e,t)=>{let i=0,r=0;for(let o=0;o<t.length-1;o++){const s=t[o],n=t[o+1];0!=K(t[o],t[o+1],e)&&(r=i+z(s,e)),i+=z(s,n)}return r/i},ke=(e,t)=>{let i=0;const r={lenPntToLine:1/0,lenTotal:0,shp:0};for(var o=0;o<e.length-1;o++){const n=e[o],a=e[o+1];var s=M(e[o],e[o+1],t);if(0!=s){const e=z(s,t);e<r.lenPntToLine&&(r.shp=o,r.lenPntToLine=e,r.lenTotal=i+z(n,s))}i+=z(n,a)}let n=0;const a={shp:-1,distancePoi:1/0,length:-1};for(o=0;o<e.length;o++){const i=z(e[o],t);o>0&&(n+=z(e[o],e[o-1])),i<a.distancePoi&&(a.shp=o,a.distancePoi=i,a.length=n)}return r.lenPntToLine<a.distancePoi?new Ee(r.lenTotal/i,r.lenPntToLine):new Ee(a.length/i,a.distancePoi)},Ce=(e,t,i)=>{const[r,o,s]=t,[n,a,l]=i;return s+(l-s)*xe(e,[[r,o,0],[n,a,0]])},Pe=(e,t,i,r)=>{e.target=i||"display",e._e().listeners.trigger(t,e,r)};let Ie,Re,Oe;class we{constructor(e,t,i){Re=i,Ie=t,this.location=e,this.iEditor=e._e()}updateDisplayedRoutingPoint(){const e=this.getLink(),t=this.coord();if(e){const i=e.coord(),r=H(i),o=0^ke(i,t).offset,s=V(i,r*o),n=V(i,r*o+(o<1?1:-1));if(s[0]!=n[0]||n[1]!=s[1]){const{rpFeature:e}=this;e&&(this.updateStreetLine(),this.iEditor.objects.overlay.setFeatureCoordinates(e,t.slice()))}}}createDisplayedRoutingPoint(e,t,i){const r=this,o=this.iEditor;r.rpFeature=r.iEditor.objects.overlay.addPoint(r.routingPoint.slice(),Object.assign({type:e,zLayer:t},i));const s=r.rpFeature;return s.pointerdown=function(){r.dragged=!1},s.pressmove=function(e,t,i){const{cLink:s,location:n,ignoreZ:a}=r;if(s&&!o._config.editRestrictions(n,y.GEOMETRY)){r.dragged||(r.dragged=!0,Pe(n,e,"routing","dragStart"));let{longitude:t,latitude:i}=o.display.pixelToGeo(e.mapX,e.mapY),l=o.objects.searchLine([t,i],s.getProvider(),{ignoreZ:a},n.geometry.coordinates);if(l||(l=o.objects.searchLine([t,i],[s],{ignoreZ:a},n.geometry.coordinates)),l){const{line:e,point:t}=l;e!=s&&(Re.defaults(s),Re.displayAsSelected(e,n.id,!0)),r.setRoutingPoint(e,t),r.updateDisplayedRoutingPoint()}}},s.pointerup=function(e){r.dragged&&(Ie.setRoutingData(r.location),r.updateDisplayedRoutingPoint(),Ie.markAsModified(r.location)),Pe(r.location,e,"routing",r.dragged?"dragStop":Oe)},r.rpFeature}updateStreetLine(){const{iEditor:e,location:t}=this,{display:i}=e;if(this.streetLine){let r=t.coord();const o=Ie.private(t),s=this.coord();if(o.isSelected){const t=e.getStyle(o.selector)[0]||{},n=t.radius||t.width/2,a=t.scaleByAltitude,l=i._g2w(r),c=i._scaleOffsetXYByAltitude(l,a);r=i._w2g(O(l,i._g2w(s),n*c))}e.objects.overlay.setFeatureCoordinates(this.streetLine,[s].concat([r]))}}getLink(){return this.cLink}coord(){return this.routingPoint}show(){const e=this,{cLink:t,location:i,iEditor:r}=e;if(t){const o=r.getStyleProperty(i,"altitude"),s=i.class;if(e.ignoreZ=!o,!e.rpFeature){let t=r.display.getLayers().indexOf(r.getLayer(e.getLink()))+1;t=t?t+1:Oe;const n={parentType:s};n[s]={altitude:o},e.streetLine=r.objects.overlay.addPath([i.coord().slice(),this.routingPoint.slice()],Oe,Object.assign(Object.assign({},n),{type:s+"_LINE",zLayer:t})),e.rpFeature=this.createDisplayedRoutingPoint(s+"_ROUTING_POINT",t,n)}e.updateDisplayedRoutingPoint(),Re.displayAsSelected(t,i.id)}return e.cLink}hide(){const e=this,t=e.rpFeature,i=e.iEditor;t&&(t.pointerdown=t.pressmove=t.pointerup=Oe,i.objects.overlay.remove(t),i.objects.overlay.remove(e.streetLine),e.rpFeature=e.streetLine=null)}updateRoutingPoint(){const e=Ie.getRoutingData(this.location),t=e.link,i=Ie.getRoutingProvider(this.location),r=e.position;let o,s;if(this.cLink=this.routingPoint=null,t&&i&&(this.cLink=i.search(t)),this.cLink){if(r){s=this.cLink.coord();for(let e=0;e<s.length-1;e++)if(K(s[e],s[e+1],r,1e-6))return this.routingPoint=r,this.cLink;o=r}else o=this.location.coord();const e=this.iEditor.objects.getNearestLine(o,[this.cLink]);e&&(this.cLink=e.line,this.routingPoint=e.point)}return this.cLink}searchLink(){const{iEditor:e,location:t}=this,i=Ie.getRoutingProvider(t);return i&&e.objects.getNearestLine(t.coord(),i,{maxDistance:e._config.maxRoutingPointDistance})}setRoutingPoint(e,t){if(this.routingPoint=this.cLink=null,e)this.cLink=e,this.routingPoint=t;else{const e=this.searchLink();e&&(this.cLink=e.line,this.routingPoint=e.point)}return this.cLink}clearRoutingPoint(){this.cLink=this.routingPoint=null,this.hide()}}let Ne,Fe;const Me=(e,t)=>{let i=e.__;return i||(i=e.__={isEditable:!0,allowEdit:!0,isGeoMod:!1,isHovered:!1,cLink:null,moved:!1}),t?i[t]:i};const Te=e=>"PLACE"==e.class,je=e=>{const t=Me(e);return null==t._rp&&(t._rp=new we(e,Ke,Ne)),t._rp};function Be(e,t){const i=!Te(e),r=Ke.getRoutingData(e).link,o=Me(e);o.isHovered=t;const s=r||i;if(r||i){const t=je(e);(t.updateRoutingPoint()||t.setRoutingPoint())&&(o.cLink=t.show(),s&&Ke.setRoutingData(e))}t&&Pe(e,t)}function De(e,t){const i=Me(e,"cLink");Me(e).isHovered=!t,i&&Ne.defaults(i,e.id)&&Ne.private(i,"isSelected")&&Ne.displayAsSelected(i),t&&Pe(e,t),je(e).hide()}function Ge(e){const t=this,i=Me(t),r="pointerenter"==e.type;i.allowEdit&&(t.editState("hovered",r),i.isSelected||(r?Be(t,e):De(t,e)))}function ze(e,t,i,r,o){const s=this,n=Me(s),a=s._e();if(n.isSelected&&!a._config.editRestrictions(s,1)){n.moved||Ke.getRoutingData(s).link!=Fe&&Ke.connect(s,null),Pe(s,e,"display",n.moved?"dragMove":"dragStart");let t=[...s.geometry.coordinates];a.getStyleProperty(s,"altitude")||(t[2]=0),t=_t(e.mapX,e.mapY,s,t,a),Ke._setCoords(s,t),n.moved=!0,je(s).updateStreetLine()}}const Ke={private:Me,setLinkTools:function(e){Ne=e},_evl:{pointerenter:Ge,pointerleave:Ge,dbltap:function(e){Pe(this,e)},pointerup:function(e){const t=Me(this),i=t.moved,r=this._e();t.allowEdit&&(t.isSelected||(r.dump(this),r._config.featureSelectionByDefault&&Ke._select(this)),i&&(je(this).show(),Ke.markAsModified(this)),Pe(this,e,"display",i?"dragStop":"pointerup"),t.moved=!1)},pointerdown:function(e){const t=Me(this);t.allowEdit&&(t.isSelected&&(t.moved=!1),Pe(this,e,"display","pointerdown"))}},deHighlight:function(e){const t=Me(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(De(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&Ne.defaults(t.cLink,e.id)),e},_editable:function(e,t){const i=Me(e);t!=i.allowEdit&&(t||(Ke.deHighlight(e),i.isHovered&&(i.isHovered.type="mouseout",De(e,i.isHovered))),i.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),Me(e).pressmove=ze,Ke.highlight(e),Be(e))},_setCoords:function(e,t){return E._setCoords(e,t)},markAsRemoved:E.markAsRemoved,markAsModified:function(e,t){return m(e,Me(e),t)},_props:function(t,i){const r=arguments.length,o=t.getProvider().getFeatureProperties(t);if(r>1){if(2==r&&"string"==typeof i)return o[i];if(3==r){const e=i;(i={})[e]=arguments[2]}t._e().objects.history.origin(t),e.extend(o,i)}return o},highlight:function(e){const t=Me(e);if(!t.selector){const i={type:e.class+"_SELECTOR",parentType:e.class},r=e._e(),o=r.display.getLayers().indexOf(r.getLayer(e));i[e.class]={altitude:e._e().getStyleProperty(e,"altitude"),zLayer:o},t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,Fe,i)}},getRoutingProvider:e=>{const t=e._e(),i=e.getProvider().readRoutingProvider(e,t.layers.map((e=>e.getProvider())));return t.getProviderById(i)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){const t=je(e),i=t.getLink(),r=t.coord(),o=Me(e);o.cLink=i;const s=Number("1e"+e._e()._config.routingPointPrecision),n=e=>Math.round(e*s)/s,a=r?[n(r[0]),n(r[1]),0|r[2]]:[],l=Ke.getRoutingData(e),c=l.position||[],d=i?i.id:null;l.link==d&&a[0]==n(c[0])&&a[1]==n(c[1])||(e._e().objects.history.batch((()=>{o.writeProp=!0,e.getProvider().writeRoutingPoint(e,i,r?a:r),delete o.writeProp})),Ke._setCoords(e,e.geometry.coordinates))},connect:function(e,t,i){const r=Me(e);if(r.writeProp)return;const o=je(e),s=o.getLink(),n=(Ke.getRoutingData(e).position||[]).slice();s&&Ne.defaults(s),t?r.cLink=o.setRoutingPoint(t,i):(r.cLink=o.updateRoutingPoint())||!1===t||(r.cLink=o.setRoutingPoint()),(Te(e)||r.cLink)&&Ke.setRoutingData(e),r.isSelected&&(r.cLink?Be(e):De(e));const a=Ke.getRoutingData(e).position||[];s==r.cLink&&n[0]==a[0]&&n[1]==a[1]||Ke.markAsModified(e,!1)},disconnect:function(e){let t=Me(e);t.writeProp||(De(e),je(e).clearRoutingPoint(),t.cLink=null,Te(e)||je(e).setRoutingPoint(),Ke.setRoutingData(e),Ke.markAsModified(e,!1))},getRoutingPosition:function(e){const t=je(e);let i=t.coord();return i||(t.updateRoutingPoint(),i=t.coord()),i&&[i[0],i[1],i[2]||0]||Fe}};class He{constructor(e,t,i,r){}isPntInFence(){return!0}isHidden(){return!0}remove(){}}const Ve="@ns:com:here:editor";let Ye,Ze;const Ue=e=>e.__||(e.__={});function We(e,t){Ue(this).line._e().listeners.trigger(e,this,t)}function Qe(e){const t=this;const i=(n=Ue(t)).line,r=i._e();n._cls=n.cLinks.map((e=>e.link)),n.drg=!1;const o=this.geometry.coordinates,s=r.display.geoToPixel.apply(r.display,o);var n;(n=Ue(t)).x=s.x,n.y=s.y,n.z=o[2],r.dump(t),Ye.removeShapePnts(i,!0),r.listeners.trigger("_clearOverlay"),Ye.hideDirection(i),Ze=new He(r,o[0],o[1]),We.call(t,e,"pointerdown")}function Xe(e,t,r){const o=this,s=Ue(o),n=s.line,a=n._e(),l=a._config,c=Ye.ignoreZ(n),d=o.geometry.coordinates.slice(0,c?2:3);let h=_t(e.mapX,e.mapY,o,d,a);if(c&&(h[2]=o.geometry.coordinates[2]||0),!l.editRestrictions(n,y.GEOMETRY))if(Ze.isPntInFence(h)){if(!Ze.isHidden()&&Ze.hide(),l.snapOnDrag&&n.behavior("snapCoordinates")&&(h=Ye.snapShape(o,h,c,l.snapTolerance)||h),Ye.moveShapeAtIndexTo(n,s.index,h),this.isSelected()){const e=a.display,t=e._g2w(d),r=e._g2w(h),o=i.sub(r,r,t);for(let t of((e,t)=>{const i=Ye.private(e,"selectedShapes"),r=Ye.private(e,"shps"),o=[];for(let e=0;e<i.length;e++)!i[e]||void 0!==t&&t==e||o.push(r[e]);return o})(n,s.index)){const r=e._g2w(t.geometry.coordinates);i.add(r,r,o);const s=e._w2g(r);Ye.moveShapeAtIndexTo(n,Ue(t).index,s)}}s.drg||(s.drg=!0,We.call(o,e,"dragStart"))}else Ze.isHidden()&&Ze.show()}function Je(e){const t=Ue(this);let i=t.index;const r=t.drg;let o=!1;const s=t.line;let n=!1,a=!1;const l=t.cLinks;let c,d;t._cls=null,r&&(d=Ye.fixGeo(s,i),"boolean"==typeof d?n=!d:(n=d>=0,(a=i!=d)&&(i=d)),qe(this)),Ye.showDirection(s),s.behavior("snapCoordinates")&&Ze.isHidden()&&!n&&r&&(c=((e,t)=>{let i=e.coord()[t];const r=Ye.ignoreZ(e),o=e.getConnectedLinks(t),s=e._e();let n,a;return o.push(e),n=s.objects.getNearestLine(i,e.getProvider(),{maxDistance:s._config.snapTolerance,ignore:e=>"NAVLINK"==e.class&&(-1!=o.indexOf(e)||!e.behavior("snapCoordinates")),ignoreZ:r}),n&&(a=n.point,a[2]||(a[2]=0),null===Ye.connectShpToLink(e,t,n=n.line,a,void 0,r)&&(n=null)),n})(s,i)),c||(r&&((!1===d?l:s.getConnectedLinks(i,!0)).forEach((e=>{const t=Ye.fixGeo(e.link,e.index);a="number"==typeof t||!t||a,Ye.markAsModified(e.link,!1,!1)})),o=!0),Ye.createAddShapePnts(s)),Ze&&Ze.remove(),t.drg=!1,(a||r)&&Ye.refreshGeometry(s),s._e().listeners.trigger(e,s.editState("removed")?this:Ye.private(s,"shps")[i],r?"dragStop":void 0),o&&Ye.markAsModified(s,!0,!1)}const qe=e=>{var t;null===(t=Ue(e).cLinks)||void 0===t||t.forEach((e=>{Ye.defaults(e.link,null,!0)}))};function $e(){const e=Ue(this);document.body.style.cursor="default",qe(this),delete this.properties[Ve].hovered,e.line._e().setStyle(this)}function et(){const t=Ue(this),i=t.line._e();document.body.style.cursor="move",t.cLinks.forEach((({link:t})=>{const r=i.getCustomStyle(t);let o;if(r?(o=e.extend(!0,[],r),o.__default=r):o=i.getStyle(t),Array.isArray(o)){for(let e=0;e<o.length;e++)o[e].opacity=.5;i.setStyle(t,o)}})),this.properties[Ve].hovered=!0,i.setStyle(this)}class tt extends l{constructor(t,i,r,o){Ye=o;const s=t._e(),n=t.getConnectedLinks(r,!0),a=0==r||r==t.geometry.coordinates.length-1;super({type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{isNode:a,isConnected:!!n.length,NAVLINK:{properties:e.extend(!0,{},t.properties),style:s.getStyle(t)},parent:t,"@ns:com:here:editor":{selected:!!Ye.private(t,"selectedShapes")[r]}}},s.objects.overlay.layer.getProvider());const l=Ue(this);l.index=r,l.line=t,l.drg=!1,l.cLinks=n,l.dblclick=We,l.pressmove=Xe,l.pointerdown=Qe,l.pointerup=Je,s._config.editRestrictions(t,y.GEOMETRY)||(l.pointerenter=et,l.pointerleave=$e)}behavior(e,t){let i=Ye.private(this,"b")||Object.assign({},ue);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const r={};r[e]=t,e=r}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}getLink(){return this.properties.parent}isNode(){return this.properties.isNode}isOverlapping(){return Ye.checkOverlapping(this.properties.parent,this.getIndex())}getIndex(){return Ue(this).index}editTurnRestrictions(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]}getConnectedLinks(){return this.getLink().getConnectedLinks(this.getIndex())}remove(){const e=this.getLink();e._e()._config.editRestrictions(e||this,y.REMOVE)||Ye.deleteShape(e,this)}disconnect(){const e=Ue(this),t=e.line._e();if(this.isNode()&&e.cLinks.length){const i=e.line,o=e.index,s=i.coord(),n=s[o],a=s[o+(o?-1:1)],l=r.calcBearing(n,a),c=t.map.movePoint(n,t._config.disconnectShapeDistance,l);t.hooks.trigger("Navlink.disconnect",{link:i,index:o},i.getProvider()),s[o][0]=c[0],s[o][1]=c[1],Ye._setCoords(i,s),Ye.fixGeo(i),Ye.refreshGeometry(i),Ye.markAsModified(i)}}select(){const e=this,t=e.getLink(),i=Ye.private(t,"selectedShapes"),{index:r}=Ue(e);i[r]=!0,e.properties[Ve].selected=!0,Ye.refreshGeometry(t)}unselect(){const e=this,t=e.getLink();e.properties[Ve].selected=!1;const i=Ye.private(t,"selectedShapes"),{index:r}=Ue(e);i[r]=!1,Ye.refreshGeometry(t)}splitLink(){let e;const t=this.getLink(),i=t._e();return this.isNode()||(e=i.objects.splitLinkAt({link:t,index:this.getIndex()}),e.length&&i.objects.history.saveChanges()),e}isSelected(){const e=Ye.private(this.getLink(),"selectedShapes"),{index:t}=Ue(this);return!!e[t]}}let it;tt.prototype.class="NAVLINK_SHAPE";class rt extends l{constructor(t,i,r,o){const s=t._e(),n=s.display;let a;super({type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:e.extend(!0,{},t.properties),style:s.getStyle(t)},parent:t}},s.objects.overlay.layer.getProvider());const l=this;l.pointerdown=function(){const e=l.properties.parent,{coordinates:t}=l.geometry;l.moved=!1,o.hideDirection(e);const i=n.geoToPixel.apply(n,t);a=new He(s,l.x=i.x,l.y=i.y,l.z=t[2])},l.pressmove=function(e,t,i,s,n){const c=l.properties.parent,d=l.geometry.coordinates.slice();if(a.isPntInFence(d)){a.isHidden()||a.hide();const e=o.private(c,"shps");if(!l.moved){o.addShp(c,d,r,!1,!0),o.removeShapePnts(c,!0,l.id),l.pointerenter=l.pointerleave=undefined,l.moved=!0;const t=e[r];t.x=l.x,t.y=l.y,t.z=l.z,t.__.pointerdown.apply(t,arguments)}const t=e[r];t.__.pressmove.apply(t,arguments)}else a.isHidden()&&a.show()},l.pointerup=function(e){const t=l.properties.parent,i=o.private(t);if(l.moved){const t=i.shps[r];t.__.pointerup.call(t,e),this.getProvider().removeFeature(this)}else i.isSelected&&o.showDirection(t)},s._config.editRestrictions(t,1)||(l.pointerenter=l.pointerleave=function(e){const t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,s.setStyle(this)})}getLink(){return this.properties.parent}}class ot{}const st=(e,t)=>{let i=e.__;return i||(i=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],selectedShapes:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?i[t]:i};function nt(t,i){const r=arguments.length,o=t.getProvider().getFeatureProperties(t);if(r>1){if(2==r&&"string"==typeof i)return o[i];if(3==r){const e=i;(i={})[e]=arguments[2]}t._e().objects.history.origin(t),e.extend(o,i)}return o}function at(e){const t=this,i=e.type;st(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==i||"pointerup"==i)&&At._select(t),t._e().listeners.trigger(e,t)}function lt(e,t,i){if(t)for(let i in t)e.editState(i,t[i]);e._e().setStyle(e,i?"default":it)}function ct(e){const t=st(e);return At.getConnectedObjects(e,r.mergeBBoxes(t.prevBBox=t.prevBBox||e.bbox.slice(),e.bbox))}function dt(e,t){st(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function ht(e,t){if(e._e().objects.overlay.remove(t),t.class){for(const e in t)"id"!=e&&"type"!=e&&"class"!=e&&"properties"!=e&&"geometry"!=e&&(t[e]=it);t.isDeleted=!0}}function pt(e,t){const i=e.__.ol;e.properties.isOverlapping=t,i!=(e.__.ol=t)&&e.getLink()._e().setStyle(e)}function gt(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function ut(e){const t=this,i=st(t);i.allowEdit&&(document.body.style.cursor="default",at.call(t,e),i.isSelected||(e=>{const t=At.getConnectedObjects(e);for(let e=0;e<t.length;e++)if(Ke.private(t[e],"isSelected"))return!0})(t)||lt(t,{hovered:!1}),i.isHovered=null)}var At={private:st,_evl:{pointerenter:function(e){const t=this,i=st(t);i.allowEdit&&(document.body.style.cursor="Pointer",i.isHovered=e,at.call(t,e),lt(t,{hovered:!0}))},pointerleave:ut,dbltap:at,pointerup:at},deHighlight:function(e){return st(e,"isSelected")&&(lt(e,{selected:!1,hovered:!1}),At.removeShapePnts(e),At.hideDirection(e)),e},_editable:function(e,t){const i=st(e);if(t!=i.allowEdit){if(!t){const t=i.isHovered;t&&(t.type="mouseout",ut.call(t.target,t)),At.deHighlight(e)}i.allowEdit=t}},_select:function(e){st(e,"isSelected")||(st(e,"selectedShapes").length=0,e._e().objects.selection.select(e),e._e().dump(e,"info"),At.refreshGeometry(e))},_setCoords:function(e,t){let i=t.length;for(;i--;)t[i][2]=t[i][2]||0;ct(e),dt(e,t),At.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),At.hideDirection(e),ct(e).forEach((e=>{Ke.disconnect(e)})),At._editable(e,!1);const t=e.coord(),i=t[0],r=t[t.length-1];i[0]==r[0]&&i[1]==r[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,dt(e,t))},markAsModified:function(e,t=!0,i=!0){const r=e.editState("modified"),o=st(e);if(o.isGeoMod){const t=e.coord();ct(e).forEach((i=>{const r=V(t,H(t)*ke(t,Ke.getRoutingPosition(i)).offset);Ke.connect(i,e,r)}))}return m(e,o,t),r||(lt(e),!o.isSelected&&i&&At.defaults(e)),e},ignoreZ:e=>!e._e().getStyleProperty(e,"altitude"),_props:nt,getConnectedObjects:function(e,t){const i=e._e();return i.objects.getInBBox(r.extendBBox(t||e.bbox,i._config.maxRoutingPointDistance)).filter((t=>{const i=t.class;if("PLACE"==i||"ADDRESS"==i)return t.getLink()==e}))},refreshGeometry:function(e){At.removeShapePnts(e),st(e,"isSelected")&&(At.displayAsSelected(e),At.showDirection(e),At.createShapes(e),At.createAddShapePnts(e))},checkOverlapping(e,t){const i=e.coord(),r=t==it,o=r?1:t;let s=r?i.length-1:o+1;const n=[];s==i.length&&s--;const a=e._e().objects.getInBBox(e.bbox,e.getProvider());let l,c=a.length;for(;c--;)if(l=a[c],l.id!=e.id&&"NAVLINK"==l.class)for(let e=o;e<s;e++)for(let t=0,r=l.coord();t<r.length;t++)if(i[e][0]==r[t][0]&&i[e][1]==r[t][1]){n.push(e);break}return r?n:!!n.pop()},createLinkShape:function(e,t,i){return e._e().objects.overlay.addFeature(new tt(e,t,i,At))},createShapes:function(e){const t=st(e,"shps"),i=e.geometry.coordinates,r=i.length;if(!e.editState("removed")){const o=At.checkOverlapping(e);if(t.length)t.forEach(((t,i)=>{t.__.cLinks=e.getConnectedLinks(i,!0)}));else for(let s=0;s<r;s++){const r=At.createLinkShape(e,[...i[s]],s);pt(r,o.indexOf(s)>=0),t[s]=r}}},createAddShapePnts:function(e){const t=st(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,y.GEOMETRY)){const i=e.geometry.coordinates;for(let r,o,s=1;s<i.length;s++)r=i[s-1],o=i[s],t.push(e._e().objects.overlay.addFeature(new rt(e,B(r,o,.5),s,At)))}},removeShapePnts:function(e,t,i){function r(t){for(let r=0;r<t.length;r++)t[r].id!=i&&ht(e,t[r]);t.length=0}const o=st(e),s=o.vShps;return t||r(o.shps),(s.length||t)&&r(s),e},moveShapeAtIndexTo:function(e,t,i,r){const o=e.coord(),s=st(e,"shps");i=[...i];const[n,a,l]=i,c=o[t][0]!=n||o[t][1]!=a||(o[t][2]||0)!=(l||0);o[t][0]=n,o[t][1]=a,"number"==typeof l&&(o[t][2]=l),ct(e),dt(e,o),At.hideDirection(e);const d=s[t];return!r&&d&&(e._e().objects.overlay.setFeatureCoordinates(d,i),d.__.cLinks.forEach((t=>{let r=t.link;!e._e()._config.editRestrictions(r,y.GEOMETRY)&&At.moveShapeAtIndexTo(r,t.index,i)})),pt(d,At.checkOverlapping(e,t))),c},deleteShape:function(e,t,i){const r="number"==typeof t?t:t.getIndex(),o=e.coord();if(o.length>2){o.splice(r,1);const t=st(e),s=t.shps;s.length&&(ht(e,s[r]),s.splice(r,1),s.forEach((e=>{e.__.index-=Number(e.getIndex()>=r)})),st(e,"selectedShapes").splice(r,1)),ct(e),dt(e,o);const n=e.getZLevels();n.splice(r,1),e._e().objects.history.batch((()=>{e.getProvider().writeZLevels(e,n)})),i||At.markAsModified(e),t.isSelected&&At.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){const t=(""+e.getProvider().readDirection(e)).toUpperCase();let i,o,s,n,a;if(At.hideDirection(e),"START_TO_END"==t?n=90:"END_TO_START"==t&&(n=-90),n!=it){const t=st(e).arrows=[];i=e.geometry.coordinates;for(let l=0;l<i.length-1;l++)o=i[l],s=i[l+1],a=90-r.calcBearing(o,s)-n,t.push(e._e().objects.overlay.addPoint(B(o,s,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return e},displayAsSelected:function(e,t,i){const r=st(e);r.isSelected||(r._cPnt=t),lt(e,{selected:!0})},addShp:(e,t,i,r,o,s)=>{const n=e.coord(),a=e._e(),l=At.ignoreZ(e),c=a.map.searchPointOnLine(n,t,a._config.snapTolerance,s,it,l);if(i="number"==typeof i?i:null==c?void 0:c.index,!(null==c?void 0:c.existingShape)||o){const r=e.getZLevels();(null==c?void 0:c.existingShape)&&(i=w(n,t)+1),a.map.clipGeoCoord(t),n.splice(i,0,t),function(e,t){const i=nt(e,"bn")||[];for(let e=0;e<i.length;e++)i[e]+=i[e]>=t}(e,i),ct(e),dt(e,n);let o=Math.round(t[2]<10&&t[2])||0;r.splice(i,0,o),a.objects.history.batch((()=>{e.getProvider().writeZLevels(e,r)}));const s=st(e,"shps");s.length&&(s.splice(i,0,At.createLinkShape(e,t,i)),s.forEach((e=>{e.__.index+=Number(e.getIndex()>i)})),s.forEach((t=>{pt(t,At.checkOverlapping(e,t.getIndex()))})),st(e,"selectedShapes").splice(i,0,!1)),At.refreshGeometry(e)}else if(!r)return!1;return i},snapShape:(e,t,i,r)=>{const o=e.getLink(),s=st(e),n=o._e(),a=o.getProvider().search({point:t,radius:r});let l,c=a.length;for(;l=a[--c];)if("NAVLINK"==l.class&&l.id!=o.id&&-1==s._cls.indexOf(l)&&l.behavior("snapCoordinates")){const e=n.map.searchPointOnLine(l.geometry.coordinates,t,r,it,r,i);if(e)return i&&(e.point[2]=t[2]||0),e.point}},defaults:function(e,t,i){const r=st(e);return(!t||t==r._cPnt)&&(r._cPnt=null,lt(e,{selected:!1,hovered:!1},i),e)},hideDirection:function(e){const t=st(e,"arrows");if(t){for(let i=0;i<t.length;i++)e._e().objects.overlay.remove(t[i]);t.length=0}return e},fixGeo:function(e,t,i,r){return ft(e,t,i,r)},connectShpToLink:function(e,t,i,r,o,s=At.ignoreZ(e)){const n=new ot;let a;const l=e._e().objects;if(i.id!=e.id){const c=function(e,t,i,r,o,s){const n=e._e(),a=e.coord();let l=null;const c=e.getConnectedLinks(t,!0),[d,h,p]=r,g=n._config.snapTolerance,u=n.map.searchPointOnLine(i.coord(),r,g,o,it,s);if(a[t][0]=d,a[t][1]=h,a[t][2]=p||0,At._setCoords(e,a),u){const r=n.map.clipGeoCoord(u.point),a=u.existingShape;l=n.objects.splitLinkAt(a?{link:i,index:u.index,avoidSnapping:!0,ignoreZ:s}:{link:i,point:r,preferSegment:o,avoidSnapping:!0,ignoreZ:s}),At.moveShapeAtIndexTo(e,t,r),c.forEach((e=>{const t=e.link;At.moveShapeAtIndexTo(t,e.index,r),ft(t,e.index),At.markAsModified(t,!1,!1),At.defaults(t)}))}return l}(e,t,i,r,o,s);if(null===c)return null;t>0&&t<e.geometry.coordinates.length-1&&(st(e,"isSelected")&&gt(e._e()),At.deHighlight(e),a=l.splitLinkAt({link:e,index:t}));const d=e.geometry.coordinates;2==d.length&&d[0][0]==d[1][0]&&d[0][1]==d[1][1]&&l.remove(e),At.markAsModified(e),st(e,"isSelected")&&At.refreshGeometry(e),c&&(n.targetSplittedInto=c),a&&(n.splittedInto=a)}return n},isIntersection(e,t,i,r){const o=Math.pow(10,e._config.intersectionScale),s=e=>Math.round(e*o);return s(t[0])==s(i[0])&&s(t[1])==s(i[1])&&(r||s(t[2]||0)==s(i[2]||0))}};function ft(e,t,i,r){const o=e._e(),s=o.objects,n=!i;let a=t||0;const l=e.getZLevels(),c=l.length,d=t===it?c:a+1;let h=!0,{snapTolerance:p}=o._config;function g(e,t,i,r,s=1){return Number(i)==Number(r)&&o.map.distance(e,t)<=s}function u(o){if(r==o)return!0;function a(e){return 0==e||e==u-1}function c(t){const i=e.getConnectedLinks(t,!0);for(let{link:e,index:t}of i){At.moveShapeAtIndexTo(e,t,f,!0)&&At.markAsModified(e,!1)}return i}const d=e.coord(),h=st(e),u=d.length;let A,f,y=!1,m=!1;for(let r=0;r<u;r++)if(o!=r){if(g(d[r],d[o],l[r],l[o],p)){if(A=Math.abs(o-r)-1,a(r)&&a(o)?1==A?y=o:m=r:a(o)?A<=1?y=o:m=r:a(r)?(1==A&&o>r&&(y=r),0==A?y=o:A>0?m=o:y=r):0==A?y=o:m=r,!1!==m){let a,l,h;if(f=d[m],2==u){const i=c(t);At.moveShapeAtIndexTo(e,o==m?r:o,f),gt(e._e()),s.remove(At.deHighlight(e)),i.forEach((e=>{n||ft(e.link,e.index)}))}else c(o),At.moveShapeAtIndexTo(e,o,f),l=s.splitLinkAt({link:e,index:m===u-1||0===m?~~(u/2):m}),l.forEach(((t,r)=>{ft(t,it,i.concat(e,l[Number(0==r)]))})),h=l[Number(o>=m)],!h.editState("removed")&&Math.abs(o-m)>=2&&(h.coord().forEach(((e,t)=>{e[0]==f[0]&&e[1]==f[1]&&(a=t)})),a&&s.splitLinkAt({link:h,index:a}));return!1}if(!1!==y){const t=d[r][0],l=d[r][1];let c=!1;e.getConnectedLinks(y,!0).forEach((e=>{const r=e.link;var o;At.markAsModified(r,!1),At.moveShapeAtIndexTo(r,e.index,[t,l],!0),o=r,c=!(n||-1!=i.indexOf(o))})),At.moveShapeAtIndexTo(e,o==r?r:o,[t,l],!0),At.deleteShape(e,y,!0),a(y)&&(!a(o)&&o-1>0&&At.moveShapeAtIndexTo(e,o-1,[t,l],!0),h.isSelected&&At.refreshGeometry(e),c&&d.length>2&&s.splitLinkAt({link:e,index:r-Number(0===y)}));const p=o-r;let g;return p>0?g=o-1-A:p<0&&(g=o+A),g}}}return!0}if(p==it&&(p=2),!e.editState("removed")&&a<c)for(i=n||!i?[]:i;a<d&&!0===(h=u(a));a++);return h}const yt={MARKER:E,AREA:pe,LINE:be,NAVLINK:At,PLACE:Ke,ADDRESS:Ke};Ke.setLinkTools(At);const mt=e=>function(t){const i=t.class,r=yt[i][e];if(r)return r.apply(r,arguments)},vt={getTools:function(e){return yt[e.class]},getTool:function(e,t){const i=this.getTools(e);return i&&t?i[t]:i},private:mt("private"),getEventListener:function(e,t){const i=this.getTools(e);return i?i._evl[t]||i.private(e,t):e.__&&e.__[t]||e[t]}};for(const e in yt)for(const t in yt[e])vt[t]||(vt[t]=mt(t));const _t=(e,t,r,o,s,n=(e=>{var t;if("terrain"===(null===(t=e.behavior)||void 0===t?void 0:t.call(e,"dragSurface")))return{terrain:!0};const i=(t,i)=>{var r;let o=null===(r=e.behavior)||void 0===r?void 0:r.call(e,t);if(o)return"string"==typeof o&&(o=i[o.split("").sort().join("").toUpperCase()]),o},r=i("dragPlane",{XY:[0,0,1],XZ:[0,1,0],YZ:[1,0,0]});if(r)return{plane:r};const o=i("dragAxis",{X:[1,0,0],Y:[0,1,0],Z:[0,0,1]});return o?{axis:o}:{plane:[0,0,1]}})(r))=>{const a=(s=s||r._e()).display,l=a._unprj(e,t,-1),c=a._unprj(e,t,0),d=i.sub([],c,l),h=a._g2w(o),p=void 0===o[2];let g;if(n.terrain){const i=a.getTerrainPointAt({x:e,y:t});g=i&&[i.longitude,i.latitude,i.altitude]}else if(n.plane){const e=j(d,l,n.plane,h);g=a._w2g(e)}else{const r=n.axis,o=a._prj(h)[2],s=h,c=i.add([],h,r),p=a._unprj(e,t,o),u=i.normalize([],i.cross([],i.sub([],p,c),i.sub([],s,c))),A=j(d,l,u,h);if(A){const e=i.add([],h,r),t=T(e,h,A);g=a._w2g(t)}}return g&&((o=s.map.clipGeoCoord(g,!0))[2]<0&&(o[2]=0),p&&0===o[2]&&o.pop()),o};class St{}const Lt=St.prototype;let bt;Lt.created=!1,Lt.modified=!1,Lt.removed=!1,Lt.split=!1,Lt.selected=!1,Lt.hovered=!1;const Et=e=>3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]],xt=e=>{const t=[];for(let i=0;i<e.length;i++){const r=e[i],o=t[t.length]=[];for(let e=0;e<r.length;e++)o[e]=Et(r[e])}return t};class kt extends l{constructor(e,t){super(e,t),this.properties=this.properties||{},this.properties["@ns:com:here:editor"]=new St}toString(){return this.class+" 🌎 "+this.id}getProvider(){return this._provider}_e(){return this._provider._e}_t(e){return e?vt.getTool(this,e):vt.getTools(this)}editState(e,t){const i=arguments.length,r=this,o=r.properties["@ns:com:here:editor"];if(!i)return o;if(2==i){if(this._esu)return;t?o[e]=t:delete o[e],"hovered"!=e&&"selected"!=e&&r._e().objects.history.batch((()=>{r._esu=!0,r.getProvider().writeEditState(r,e),r._esu=bt}))}return o[e]}style(e){const t=this;if("string"==typeof e||0==arguments.length)return this._e().getStyle(t,bt);this._e().setStyle(t,e,!0)}prop(t,i){const r=this;let o=!1;const s=arguments.length,n=r.getProvider().getFeatureProperties(r);if(!s||1==s&&"string"==typeof t)return"object"==typeof(t=t?n[t]:n)?e.extend(!0,new t.constructor,t):t;if(2==s){const e={};e[t]=arguments[1],t=e}for(const e in t){const i=t[e],s="object"==typeof i,a=n[e];(s&&JSON.stringify(i)!=JSON.stringify(a)||!s&&a!==i)&&(o||(this._e().objects.history.origin(r),o=!0),n[e]=i)}o&&(this._e().setStyle(r),vt.markAsModified(r))}getCoordinates(){return this.coord()}coord(e){const t=this,i=t.geometry.type;if(!(e instanceof Array))return e=t.getProvider().decCoord(t),"Point"==i?Et(e):"Polygon"==i||"MultiLineString"==i?xt(e):"MultiPolygon"==i?e.map((e=>xt(e))):xt([e])[0];vt.deHighlight(t),vt._setCoords(t,e),vt.markAsModified(t)}editable(e){return vt._editable(this,e),this.unselect(),this}select(){vt._select(this)}unselect(){vt.private(this,"isSelected")&&this._e().objects.selection.clearSelected()}transform(){this._e().transformer.show(this)}remove(){this._e().objects.remove(this,{save:!0})}}kt.prototype.id=null;const Ct=null;class Pt{constructor(e,t,i,r,o,s,n){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=i,this.nativeEvent=r,this.button=o,this.target=s,this.detail=n}}const It=Pt.prototype;It.nativeEvent=Ct,It.detail=Ct,It.target=Ct,It.mapX=Ct,It.mapY=Ct,It.type=Ct,It.button=Ct,It.timeStamp=Ct,It.toString=function(){return"EditorEvent "+this.type};class Rt extends l{constructor(t,i,r,o,s){super({type:"Feature",geometry:{type:"Point",coordinates:o},properties:{"@ns:com:here:editor":{},index:r,isMoved:!1}},t.overlay.getProvider());const n=t.getFeature().geojson,a=this;let l=s.toUpperCase();a.properties[l]={properties:e.extend(!0,{},n.properties),style:i.getStyle(n)},a._b=t,a.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=i.display.geoToPixel.apply(i.display,this.geometry.coordinates)},pressmove:function(e,r,o,s,n){const a=this,l=this.properties.p,c=i.map.getGeoCoord(l.x+r,l.y+o);t.getFeature().update(this.properties.index,c),a._provider.setFeatureCoordinates(a,c.slice()),a.isMoved=!0},pointerup:function(e){this.properties.isMoved||i.listeners.trigger(e,this)}},this.class=l+"_SHAPE"}remove(){const e=this;e.__=null,e._b.removeShape(e.properties.index)}getLength(){return this._b.getLength()}getIndex(){return this.properties.index}}class Ot{constructor(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}update(e,t){const i=this.path;t&&(i[e]=t),i.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(i))}removeAt(e){this.path.splice(e,1)}createGeo(e){if(e.length>1)return e.slice()}isValid(e){return!!e||this.path.length>1}}class wt{constructor(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}update(e,t){const i=this.path;if(t&&(i[e]=t),i.length>2){const e=this.createGeo(i);e&&this.overlay.setFeatureCoordinates(this.geojson,e)}}createGeo(e){if(e.length>2)return[[e.concat([e[0]])]]}removeAt(e){this.path.splice(e,1)}isValid(e){return e?(e.push(e[0].slice()),e.length<4||pe.validateGeometry(e)):this.path.length>2}}const Nt=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],Ft=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Mt(t,i){const r=e.clone(t||Nt);return r.forEach((e=>e.zIndex=(0^e.zIndex)+i)),r}let Tt;class jt{constructor(e,t,i){this.shapes=[],this.originLink=null,this.originPos=null;const r=this;r.overlay=e,r.iEdit=t,r.display=i,r.onBoardUp=r.onBoardUp.bind(r),r.updateCursor=r.updateCursor.bind(r)}onBoardUp(){this.mousedown=!1}updateCursor(e){const{iEdit:t,feature:i,shapes:r,display:o,cursor:s,mousedown:n,overlay:a}=this;if(n){const i=t.map.getEventsMapXY(e),{prevPos:r}=s.properties;o.lockViewport().pan||o.pan(i[0]-r[0],i[1]-r[1],0,0),r[0]=i[0],r[1]=i[1]}else{const o=t.map.getGeoCoord(t.map.getEventsMapXY(e)),n=r.map((e=>e.geometry.coordinates));n.push(o);const l=i.isValid(n);if(l!=!this.inValid){let e=this.style.feature;l?(e=this.inValid,this.inValid=!1):(this.inValid=e,e=[Object.assign(Object.assign({},e[0]),{fill:"rgba(0,0,0,0)"})]),t.setStyle(i.geojson,e)}i.update(r.length,o),a.setFeatureCoordinates(s,o)}}init(){const e=this,{iEdit:t,display:i,overlay:r,updateCursor:s}=e,n=i.getViewBounds(),a=[n.minLon,n.maxLat];this.feature=new this.FeatureClass(r,a);const l=r.addCircle(a,Mt(Nt,1));l.pointerdown=i=>{const{properties:r}=l;r.prevPos=t.map.getEventsMapXY(i),e.mousedown=!0,r.panned=!1},l.pressmove=e=>{s(e),l.properties.panned=!0},l.pointerup=i=>{l.properties.panned||e.addShape(t.map.getGeoCoord(i.mapX,i.mapY),Tt,i),e.onBoardUp()},this.cursor=l,this.inValid=!1,o.addEventListener("mousemove",this.updateCursor),o.addEventListener("mouseup",this.onBoardUp)}addShape(e,t,i){const{iEdit:r,settings:o,shapes:s,feature:n}=this;let a;if(t){if(this.originLink=t,a=t.geometry.coordinates,"number"==typeof e)e=a[e].slice(0);else{let t=r.map.searchPointOnLine(a,e,r._config.snapTolerance);!(null==t?void 0:t.existingShape)||0!=t.index&&t.index!=a.length-1||(this.originLink=null),e=null==t?void 0:t.point}this.originPos=e}const l=this.overlay.addFeature(new Rt(this,r,s.length,e,o.mode),Mt(this.style.shape,9));return n.update(s.length,e),s.push(l),o.onShapeAdd&&o.onShapeAdd(new Pt("onShapeAdd",e[0],e[1],i,i&&i.button,l,{index:l.properties.index})),l}setGeom(e,t){const{settings:i}=this;if(e!=this.feature.type)return;this.hide(),this.show(i);let r="LineString"==e?t:t[0][0].slice(0,-1);const{onShapeAdd:o}=i;i.onShapeAdd=null;for(let e of r)this.addShape(e);i.onShapeAdd=o}removeShape(e){const{shapes:t,iEdit:i,overlay:r,feature:o,settings:s}=this;e==Tt&&(e=t.length-1);let n=t[e],a=i.map.getGeoCoord(n.geometry.coordinates);r.remove(n),t.splice(e,1),o.removeAt(e);for(let i=e;i<t.length;i++)t[i].properties.index--;o.update(),s.onShapeRemove&&s.onShapeRemove(new Pt("onShapeRemove",a[0],a[1],Tt,Tt,Tt,{index:e}))}getFeature(){return this.feature}getLength(){return this.shapes.length}setAttributes(t){const{feature:i,iEdit:r,cursor:o,settings:s,shapes:n}=this;if(t){e.extend(i.properties,t);const a=((t,i)=>{let r,o,s,n;const a=t.mode;if(t.styleGroup)r=t.styleGroup;else if("Navlink"!=a&&"Area"!=a||(i.editState=()=>({}),i.class=a),r=t.layer.getStyleGroup(i),"Area"!=a)return n=e.clone(Nt),n[0].fill=r[0].stroke,s=e.clone(Ft),s[0].stroke=(r[1]||r[0]).stroke,{feature:s,shape:n};const l=e=>-1!=["Circle","Image","Rect","Text"].indexOf(e.type);if(s=r.filter((e=>!l(e))),n=r.filter(l),s.length||(s=t.layer.getStyleGroup(i)),!t.styleGroup||!n.length){n=e.clone(Nt);const t=s[0];let i;o=t.stroke,"Area"==a?(i=t.fill,o&&(n[0].stroke=o)):i=o,i&&(n[0].fill=i)}return{feature:s,shape:n}})(s,i.geojson);this.style=a,i.geojson.class=Tt,r.setStyle(i.geojson,a.feature),n.concat(o).forEach((e=>{r.setStyle(e,Mt(a.shape,r.getStyle(e)[0].zIndex))}))}}createGeom(){const{feature:e,shapes:t,settings:i}=this,{tolerance:r}=i;let o=t.map((e=>e.geometry.coordinates));"Area"!=i.mode&&r&&(o=I(o,r));let s=e.createGeo(o);if(s)return{type:e.type,coordinates:s}}create(e){const{iEdit:t,FeatureClass:i,shapes:r,feature:o,originLink:s,originPos:n,settings:a}=this;if(this.setAttributes(e),i==Ot){const e=r[0].geometry.coordinates;s&&n[0]==e[0]&&n[1]==e[1]&&t.objects.splitLinkAt({link:t.objects.get(s),point:e})}let l=r.map((e=>e.geometry.coordinates));if(o.isValid(l)){const e=this.createGeom();let i;return e&&(i=t.objects.create({feature:{type:"Feature",geometry:e,properties:o.properties},provider:a.layer.getProvider()}),i&&t.objects.history.saveChanges(),this.hide()),i}throw new Error("Invalid Geometry")}isActive(){return this.active}show(e){if(!this.active){const t=this.overlay.layer,{iEdit:i,display:r}=this;i.objects.listenDisplay(!1),r.removeLayer(t),r.addLayer(t),i.objects.listenDisplay(!0),this.settings=e,"Area"==e.mode?this.FeatureClass=wt:this.FeatureClass=Ot,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}}hide(){const e=this,{display:t,overlay:i,shapes:r,feature:s}=e;if(e.active){e.active=!1;const n=i.layer;t.removeLayer(n),t.addLayer(n),i.remove(s.geojson),e.feature=null,r.forEach((e=>i.remove(e))),r.length=0,i.remove(e.cursor),e.cursor=null,o.removeEventListener("mousemove",e.updateCursor),o.removeEventListener("mouseup",e.onBoardUp)}}}const Bt="Area",Dt="Navlink",Gt=o.here.xyz.maps.editor;class zt{constructor(e){this._e=e,this._b=new jt(e.objects.overlay,e,e.display),this._a=!1}addShape(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)}removeShape(e){this._a&&this._b.removeShape(e)}getLength(){return this._b.getLength()}cancel(){this._b.hide(),this._a=!1}setProperties(e){this._a&&this._b.setAttributes(e)}setAttributes(e){return this.setProperties(e)}create(e){if(this._a){let t=this._b.create(e);return t&&(this._a=!1),t}}start(e){const t=(e=Object.assign({tolerance:1},e||{})).connectTo;let i=e.mode||Dt;return i="string"!=typeof i?i===Gt.features.Area?Bt:Dt:i.charAt(0).toUpperCase()+i.slice(1).toLowerCase(),e.mode=i,e.attributes=e.properties||e.attributes||{},this.cancel(),e.layer=e.layer||this._e.getLayerForClass(i.toUpperCase()),(i!=Bt||e.layer)&&(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=!0,e.position&&this.addShape(e.position,t)),this._a}isActive(){return this._a}getGeometry(){return this._b.createGeom()}setGeometry(e){this._b.setGeom(e.type,e.coordinates)}}function Kt(e,t){const i=4096,r=e.coord().map((e=>{let t=c.geoToPixel(e[0],e[1],i);return[t.x,t.y]}));let o;if("number"==typeof t)o=t;else{let e=c.geoToPixel(t.longitude,t.latitude,i);o=ke(r,[e.x,e.y]).offset}const s=V(r,H(r)*o),n=c.pixelToGeo(s[0],s[1],i);return{coordinate:[n.longitude,n.latitude],offset:o}}class Ht extends l{constructor(e,t,i,r,o,s,n,a){super({type:"Feature",properties:{relPos:i,dragged:!1,style:Ht.initStyle(r)},geometry:{type:"Point",coordinates:Kt(t.getMultiLink(),i).coordinate}}),this.snapped=[],this.range=t,this.iEditor=e,this.isLocked=o,this.dragStart=s,this.dragMove=n,this.dragEnd=a;e.objects.overlay.addFeature(this,this.properties.style),this.updatePosition(this.geometry.coordinates,i)}static initStyle(t){let i=e.clone(t);for(let e of i)e._offsetX=e.offsetX||0,e._offsetY=e.offsetY||0;return i}isSnapped(e){return e?this.snapped.indexOf(e)>=0:Boolean(this.snapped.length)}getSnapped(e){return this.snapped.find((t=>t.range==e))}snap(e){if(!this.isSnapped(e)){for(let{range:t}of this.snapped)if(t==e.range)return!1;return this.snapped.push(e),!0}}validatePosition(e,t){const i=this,o=i.range,s=o.options.snapTolerance||1;let n={coordinate:e=e||i.geometry.coordinates,offset:t,adjusted:!1},a=o.getOffsets();const l=o.getFromMarker()==this;let c;a[Number(!l)]=t,a=a.sort(((e,t)=>e-t));for(let n of i.range.getMultiLink().getRanges()){if(n==i.range)continue;let l=n.getOffsets();const[d,h]=n.getMarkers(),p=n.getSide();if(o.allowSnap(p)&&!this.isSnapped(d)&&!this.isSnapped(h)){const t=r.distance(e,d.geometry.coordinates),i=r.distance(e,h.geometry.coordinates);if(Math.min(t,i)<s||o.overlaps(l,a)){const e=t<i?d:h;this.snap(e)}}const g=this.getSnapped(n);if(g){const e=l.indexOf(g.getRelPos());l[e]=t,l=l.sort(((e,t)=>e-t))}if(!o.allowOverlap(p)&&o.overlaps(l,a)){c=n;break}}if(c){const[e,t]=c.getMarkers(),i=this.range.getFromMarker()==this?t:e;n.offset=i.getRelPos(),n.coordinate=i.geometry.coordinates,n.adjusted=!0}return n}updatePosition(e,t){const i=this,r=i.properties.style,o=i.range.getMultiLink().coord(),s=w(o,e),n=i.range.getSide(),a=o[s],l=o[s+1],c=l[0]-a[0],d=l[1]-a[1],h=180*-Math.atan2(d,c)/Math.PI,p=Math.sqrt(c*c+d*d);let g=d,u=c;p&&(g/=p,u/=p);for(let e of r)if(e.rotation=h,"B"!=n){let{_offsetX:t,_offsetY:i,lineOffset:r}=e;i+=r,e.offsetX=g*i+u*t,e.offsetY=u*i+-g*t}i.getProvider().setFeatureCoordinates(i,e),i.properties.relPos=t;for(let i of this.snapped)i.updatePosition([e[0],e[1]],t),i.range.update();return e.slice()}pressmove(e){const t=this;if(!t.isLocked()){const i=e.detail.display,r=t.range.getMultiLink(),{offset:o,coordinate:s}=Kt(r,i.pixelToGeo(e.mapX,e.mapY)),n=this.validatePosition(s,o);t.updatePosition(n.coordinate,n.offset),t.dragMove(e),t.properties.dragged=!0}}pointerdown(e){this.dragStart(e),this.properties.dragged=!1,this.validatePosition(this.geometry.coordinates,this.getRelPos())}pointerup(e){this.properties.dragged&&this.dragEnd(e),this.snapped.length=0}remove(){this.getProvider().removeFeature(this)}getRelPos(){return this.properties.relPos}getRelPosOfSubLink(e){const{iEditor:t}=this,i=this.geometry.coordinates,r=t.map.getPixelCoord(i),o=w(this.range.getMultiLink().coord().map((e=>t.map.getPixelCoord(e))),r);if(o>=e.from&&o<e.to){const i=e.lineString.map((e=>t.map.getPixelCoord(e))),o=xe(r,e.reversed?i.reverse():i);return o>.995?1:Math.round(1e9*o)/1e9}return o<e.from?0:1}}let Vt;var Yt;!function(e){e.L="#ff4040",e.R="#4cdd4c",e.B="#35b2ee"}(Yt||(Yt={}));class Zt{constructor(e,t,i){this.options=Object.assign({_dragStart:(e,t)=>{},_dragMove:(e,t)=>{},_dragStop:(e,t)=>{}},i);const{id:r}=i;r!=Vt&&(this.id=r);const o=JSON.parse(JSON.stringify(i.style||{}));this.ml=e;let s=this.getSide(),{opacity:n,fill:a,stroke:l}=o;a&&!l&&(l=a,a=!1),a||(a=l,l="#fff"),a=a||Yt[s];let c=i.lineStyle||((e,t,i)=>{const r=e.layer.getStyle().styleGroups.RANGESELECTOR_RANGE_LINE,o=[];for(let e of r)o.push(Object.assign(Object.assign({},e),{opacity:null!=i?i:e.opacity,stroke:t}));return o})(t,a,n),d=0;for(let t of c)t.zLayer=e.zLayer,d=t.offset||d;this.line=t.addPath(e.coord(),this.style=c);let h=i.markerStyle||((e,t,i,r)=>{let o="R"==r?1:"L"==r?-1:0;const s=e.layer.getStyle().styleGroups.RANGESELECTOR_RANGE_MARKER;return[Object.assign(Object.assign({},s[0]),{fill:i,offsetY:o*s[0].offsetY}),Object.assign(Object.assign({},s[1]),{fill:t,stroke:i,offsetY:o*s[1].offsetY}),Object.assign(Object.assign({},s[2]),{stroke:i})]})(t,a,l,s);for(let t of h)t.lineOffset==Vt&&(t.lineOffset=d,t.zLayer=e.zLayer);this.markers=["from","to"].map((t=>new Ht(e.iEdit,this,i[t],h,(()=>this.locked()),(e=>{this.options._dragStart(e,this)}),(e=>{this.update(),this.updateSegments(),this.options._dragMove(e,this)}),(e=>{this.options._dragStop(e,this)})))),this.overlay=t,this.updateSegments()}updateSegments(){this.segments=this.ml.getZoneSegments(this)}getSide(){return this.options.side.toUpperCase()}getOffsets(){let e=this.markers[0].getRelPos(),t=this.markers[1].getRelPos();if(e>t){const i=e;e=t,t=i}return[e,t]}allowSide(e,t){let i=[];return"boolean"==typeof(t=t||[])?t:("string"==typeof t?i.push(t):Array.isArray(t)&&(i=t),-1!=i.indexOf(e))}allowOverlap(e){return this.allowSide(e,this.options.allowOverlap)}allowSnap(e){return this.allowSide(e,this.options.snap)}getMarkers(){return this.markers.sort(((e,t)=>e.getRelPos()-t.getRelPos()))}getFromMarker(){const{markers:e}=this,t=e[0].getRelPos(),i=e[1].getRelPos();return e[Number(t>i)]}getMultiLink(){return this.ml}remove(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()}locked(){return!!this.options.locked}overlaps(e,t){t=Array.isArray(t)?t:this.getOffsets(),e=Array.isArray(e)?e:e.getOffsets();const[i,r]=t.sort(((e,t)=>e-t)),[o,s]=e.sort(((e,t)=>e-t));return Math.max(0,Math.min(r,s)-Math.max(i,o))>0}update(){const[e,t]=this.getOffsets();for(let i of this.style)i.from=e,i.to=t;this.overlay.layer.setStyleGroup(this.line,this.style),this.updateSegments()}}function Ut(e,t){return e.concat(t.slice(1))}function Wt(e,t,i,r){return{zIndex:e,type:"Line",stroke:t,strokeWidth:i,strokeDasharray:r||"none",strokeLinejoin:"round",strokeLinecap:r?"butt":"round"}}const Qt=()=>[Wt(0,"white",23),Wt(1,"grey",20),Wt(2,"white",3,[5,4])];class Xt{constructor(e,t,i,r){this.ranges=[],this.links=[];const o=e.objects.overlay;this.iEdit=e,this.completePath=t,this.style=i||Qt(),this.overlay=o,this.feature=o.addPath(t,this.style,{type:"RANGESELECTOR_LINE"}),this.hide(),this.links.push({from:0,to:t.length-1,feature:r,lineString:t,reversed:!1}),o.setFeatureCoordinates(this.feature,this.completePath)}updateStyle(e){e=e||Qt(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)}removeZones(){this.ranges.forEach((e=>{e.remove()})),this.ranges.length=0}coord(){return this.completePath.map((e=>e.slice()))}hide(){this.overlay.remove(this.feature)}getMaxZLayer(){let e=this.iEdit.getZLayer(this.overlay.layer);for(let{feature:t}of this.links){let i=this.iEdit.getMaxZLayer(t);i>e&&(e=i)}return e+1}show(e){const{overlay:t}=this;this.removeZones();let i=this.getMaxZLayer();this.zLayer=i;for(let e of this.style)e.zLayer=i;t.addFeature(this.feature,this.style),e.forEach((e=>{if(-1!=["L","R","B"].indexOf(e.side)){let i=new Zt(this,t,e);this.ranges.push(i),i.update()}}))}addLink(t,i){const{links:r}=this;function o(e,t){return e[0]===t[0]&&e[1]===t[1]}i instanceof l&&At.defaults(i);const s=(o,s,a)=>{const l=e.clone(t);if(a&&l.reverse(),0===o){for(let e=0;e<r.length;e++)r[e].from+=s,r[e].to+=s;this.completePath=Ut(l,n)}else this.completePath=Ut(n,l);r.unshift({from:o,to:s,feature:i,lineString:t,reversed:!!a})},n=this.completePath;o(t[t.length-1],n[0])?s(0,t.length-1):o(t[0],n[0])?s(0,t.length-1,!0):o(t[0],n[n.length-1])?s(n.length-1,n.length+t.length-2):o(t[t.length-1],n[n.length-1])&&s(n.length-1,n.length+t.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)}destroy(){this.hide(),this.removeZones()}getRanges(){return this.ranges}getZoneSegments(e){const t=e.markers[0],i=e.markers[1],r=[];function o(e){const t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach((e=>{const s=[t.getRelPosOfSubLink(e),i.getRelPosOfSubLink(e)];s[0]>s[1]&&o(s),e.reversed&&(o(s),s[0]=1-s[0],s[1]=1-s[1]),r.push({navlink:e.feature,feature:e.feature,from:s[0],to:s[1],reversed:e.reversed})})),r}}class Jt{constructor(e){this.multiLink=null,this.lines=[],this.iEditor=e,this.display=e.display}isConnected(e,t,i){const r=[0,e.length-1],o="number"==typeof i?[i]:[0,t.length-1];for(let i of o){const o=t[i];for(let t of r)if(At.isIntersection(this.iEditor,e[t],o))return{i1:t,i2:i}}return null}getOppositeNodeIndex(e,t){return 0==t?e.length-1:0}getCollection(){return this.multiLink}show(e){this.multiLink&&this.multiLink.show(e)}hide(){const{multiLink:e,lines:t}=this;for(let{feature:e}of t)e instanceof kt&&At.defaults(e);this.lines=[],e&&(e.destroy(),this.multiLink=null)}addLineSegment(e){let t,i,{multiLink:r,lines:o}=this;const s=e.coordinates,n=e.feature;if(null!=s){if(t=!o.length,t)r=new Xt(this.iEditor,s,this.mlStyle,n),this.multiLink=r,this.first={lineString:s,index:null},i=!0;else{for(let{id:t}of o)if(e.id==t)return!1;const t=this.first.lineString;let i=this.isConnected(s,t,this.first.index);i?this.last?this.first={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)}:(this.first.index=this.getOppositeNodeIndex(t,i.i2),this.last={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)}):this.last&&(i=this.isConnected(s,this.last.lineString,this.last.index),i&&(this.last={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)})),i&&r.addLink(s,n)}i&&(n instanceof kt&&At.deHighlight(n),o.push(e))}return!!t}setMLStyle(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)}}class qt{constructor(){this.listeners=new s(["tap","dbltap","pointerdown","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay","_beforeSubmit","_afterSubmit"]).sync(!0)}static createEditorEvent(e,t,i,r){return new Pt(i||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,r||e.detail)}trigger(e,t,i){const r=this,o=i||e.type||e;let s,n,a;var l;return(l=t)&&l.class?(n=e.detail,a=t):n=t,"touchend"==e.type&&(e=e.changedTouches[0]),s=r.listeners.trigger(o,qt.createEditorEvent(e,a,o,n),(e=>"_"==e[0])(o)),"pointerup"==o&&(s=r.listeners.trigger("tap",[new Pt("tap",e.mapX,e.mapY,e.nativeEvent,e.button,a,n)],!1)||s),s}add(e,t,i){return this.listeners.add(e,t,i)}remove(e,t,i){return this.listeners.remove(e,t,i)}supported(){return this.listeners.getEvents()}destroy(){this.listeners=null}}let $t;const ei=e=>{const{id:t,from:i,to:r,side:o,style:s}=e.options;return{id:t,from:i,to:r,side:o,style:s,segments:e.segments}};class ti{constructor(e){this.links=new Jt(e)}add(e){var t;const i=Array.isArray(e)?e:[].slice.call(arguments);for(let e of i){let i;(e instanceof kt||"LineString"==(null===(t=e.geometry)||void 0===t?void 0:t.type))&&(i=e.geometry.coordinates),i&&this.links.addLineSegment({id:e.id||1e9*Math.random()^0,coordinates:i,feature:e})}}show(e){const t=this.ranges=e instanceof Array?e:[].slice.call(arguments);t.forEach((e=>{e.from=e.from||0,e.to=(e.to==$t?1:e.to)||0,e.allowOverlap==$t&&(e.allowOverlap=!0);for(let t of["markerStyle","lineStyle"]){let i=e[t];i&&!Array.isArray(i)&&(e[t]=[i])}for(let t of["dragStart","dragMove","dragStop"]){const i=e[t];i&&(e["_"+t]=(e,r)=>{e.detail.range=e.detail.zone=ei(r),i(qt.createEditorEvent(e,e.target,t))})}})),this.links.show(t)}hide(){return this.links.hide()}info(){const e=[],t=this.links.getCollection();if(t){t.getRanges().forEach((t=>{e.push(ei(t))}))}return e}setStyleGroup(e){this.links.setMLStyle(e)}}class ii extends l{constructor(e,t,i,r,o={},s){super({type:"Feature",geometry:{type:"Point",coordinates:t},properties:o},i.layer.getProvider()),this._o=i,this.transformer=r,i.addFeature(this,s)}setPosition(e,t){this.getProvider().setFeatureCoordinates(this,[e,t])}getCenter(){return this.geometry.coordinates.slice()}hide(){this._o.hideFeature(this)}show(){this._o.showFeature(this)}remove(){this._o.remove(this)}enableHover(e,t){this.__.pointerenter=this.__.pointerleave=t=>{const i="pointerenter"==t.type;document.body.style.cursor=i?e:"default",this.properties["@ns:com:here:editor"].hovered=i,this.properties.hovered=i,this._o.layer.setStyleGroup(this)}}}class ri extends ii{constructor(e,t,i,o){let s,n,a;super(e,t,i,o,{type:"TRANSFORMER_ROTATE_KNOB"});let l,c=null;l=0,this.__={pressmove:(t,i,d)=>{s=!0;const h=90-r.calcBearing(a,e.map.getGeoCoord(t.mapX,t.mapY))-c;o.setRotation(h);for(let t of n)vt._setCoords(t,e.map.rotateGeometry(t.geometry,a,h-l));l=h},pointerdown:t=>{s=!1,a=o.getCenter(),null==c&&(c=90-r.calcBearing(a,e.map.getGeoCoord(t.mapX,t.mapY))),n=o.getFeatures()},pointerup:()=>{s&&(n.length>1||"Point"!=n[0].geometry.type)&&o.markObjsAsMod(),n=null,a=null}},this.enableHover("move")}update(){const e=this.transformer.getCorner(ai.bottomRight,15,15);this.setPosition(e[0],e[1])}}class oi extends ii{constructor(e,t,i,r){let o,s,n,a,l,c;super(e,t,i,r,{type:"TRANSFORMER_SCALE_KNOB"}),this.__={pressmove:(t,i,n)=>{const d=e.map.getGeoCoord(t.mapX,t.mapY);let h=T(l,a,d);const p=z(h,a)/c,g=p/s;o||r.visible(!(o=!0)),r.scale(g,g),s=p},pointerdown:e=>{o=!1,a=r.getCenter(),a[2]=0,l=this.geometry.coordinates.slice(0,2),l[2]=0,c=z(l,a),n=r.getFeatures(),s=1},pointerup:()=>{o&&(n.length>1||"Point"!=n[0].geometry.type)&&r.markObjsAsMod(),n=null,a=null,r.visible(!0)}},this.enableHover("nwse-resize")}update(){const e=this.transformer.getCorner(ai.topLeft,-15,-15);this.setPosition(e[0],e[1])}}class si extends ii{constructor(e,t,i,r){super(e,t,i,r,{type:"TRANSFORMER_TRANSLATE_KNOB"}),this.internalEditor=e,this.__={pointerdown:()=>{const e=this.properties;e.moved=!1,e._dx=0,e._dy=0},pressmove:(e,t,i)=>{const o=this.properties;o.moved=!0,r.pan(t-o._dx,i-o._dy),o._dx=t,o._dy=i},pointerup:()=>{this.properties.moved&&r.markObjsAsMod()}},this.enableHover("move")}update(){const e=this.transformer.getRotatedBoundingBox(),t=[e[0],e[2]],i=V(t,.5*H(t));this.setPosition(i[0],i[1])}}class ni{constructor(e,t,i,r){const o=this,{map:s}=i;let n,a=!1;this.transformer=e,this.buffer=t;const l=[r.addRect(0,0,0,0,{type:"TRANSFORMER_SCALE_BOX"})],c=i.getStyle(l[0]);for(let e=0;e<4;e++)l.push(r.addPath([[0,0],[0,0]],[{zIndex:c[0].zIndex+1,zLayer:c[0].zLayer||0,type:"Line",strokeWidth:6}],{index:e,vertical:e%2}));let d,h=!1;function p(t,i,r){if(a)return;const{index:c,vertical:p}=this.properties;let g=c==ai.topLeft?ai.bottomLeft:c-1,u=l[g+1].geometry.coordinates;h&&(u=u.reverse(),g=p?g==ai.bottomRight?ai.bottomLeft:ai.bottomRight:g==ai.bottomLeft?ai.topRight:ai.bottomRight);const[A,f]=u,y=e.getCenter(),m=e.rotation;let v=s.getPixelCoord(y),_=s.getPixelCoord(A),S=s.getPixelCoord(f),L=T(_,S,[t.mapX,t.mapY,0]);_=Y(_,m,v),S=Y(S,m,v),L=Y(L,m,v);let b,E=1,x=1;if(p){const e=S[0]-_[0];b=L[0]-_[0],E=b/e}else{const e=S[1]-_[1];b=L[1]-_[1],x=b/e}d!=b>0&&(d=!d,h=!h),Math.abs(b)>o.buffer+6&&(e.scale(E,x,e.getCorner(g)),n=!0)}function g(){const t=e.getFeatures();a=1==t.length&&"Point"==t[0].geometry.type,n=!1;const{index:i,vertical:r}=this.properties,o=i==ai.topLeft?ai.bottomLeft:i-1,[c,p]=l[o+1].geometry.coordinates;let g=s.getPixelCoord(c),u=s.getPixelCoord(p);const A=e.getCenter(),f=e.rotation;let y=s.getPixelCoord(A);g=Y(g,f,y),u=Y(u,f,y),d=r?u[0]-g[0]>0:u[1]-g[1]>0,h=!1}function u(){n&&e.markObjsAsMod()}function A(){document.body.style.cursor="move"}function f(){document.body.style.cursor="default"}for(let e=1;e<l.length;e++){const t=l[e];t.pointerdown=g,t.pressmove=p,t.pointerup=u,t.pointerenter=A,t.pointerleave=f}this.overlay=r,this.features=l,this.iEdit=i,this.update()}setScale(e,t,i){this.transformer.scaleFeatures(this.features,e,t,i)}setRotation(e,t){for(let i of this.features)i.getProvider().setFeatureCoordinates(i,this.iEdit.map.rotateGeometry(i.geometry,t,e))}update(){let{buffer:e,transformer:t,features:i,overlay:r}=this;const o=r.getProvider(),s=t.getCorner(ai.topLeft,-e,-e),n=t.getCorner(ai.topRight,e,-e),a=t.getCorner(ai.bottomRight,e,e),l=t.getCorner(ai.bottomLeft,-e,e);o.setFeatureCoordinates(i[0],[[s,n,a,l,s]]),o.setFeatureCoordinates(i[1],[s,n]),o.setFeatureCoordinates(i[2],[n,a]),o.setFeatureCoordinates(i[3],[a,l]),o.setFeatureCoordinates(i[4],[l,s])}hide(){const{overlay:e,features:t}=this;e.hideFeature(t)}show(){const{overlay:e,features:t}=this;e.showFeature(t)}remove(){const{overlay:e,features:t}=this;e.remove(t)}pan(e,t){for(let i of this.features)this.iEdit.map.pixelMove(i,e,t)}}var ai;!function(e){e[e.topLeft=0]="topLeft",e[e.topRight=1]="topRight",e[e.bottomRight=2]="bottomRight",e[e.bottomLeft=3]="bottomLeft"}(ai||(ai={}));class li{constructor(e){this.buffer=15,this.features=null,this.scaleBox=null,this.moveKnob=null,this.rotateKnob=null,this.scaleKnob=null,this.allowEditIds=[],this.rotation=0,this.iEditor=e}scaleFeatures(e,t,i,r){const o=[t,i],s=this.iEditor.map,{rotation:n}=this,a=this.getCenter();r=s.rotatePoint(r,a,-n);for(let t of e){const e={type:t.geometry.type,coordinates:t.geometry.coordinates};e.coordinates=s.rotateGeometry(e,a,-n),e.coordinates=s.scaleGeometry(e,o,r),e.coordinates=s.rotateGeometry(e,a,n);try{vt._setCoords(t,e.coordinates)}catch(i){t.geometry.coordinates=e.coordinates}}}restoreFeaturesEditable(){for(let e of this.features)this.allowEditIds.indexOf(e.id)>=0&&vt._editable(e,!0)}setRotation(e){const t=e-this.rotation,i=this.getCenter(),{geometry:r}=this.bbox;r.coordinates=this.iEditor.map.rotateGeometry(r,i,t),this.scaleBox.setRotation(t,i),this.scaleKnob.update(),this.rotateKnob.update(),this.rotation=e}markObjsAsMod(){const{features:e}=this;for(let t of e)vt.markAsModified(t,!1);e.length&&this.iEditor.objects.history.saveChanges()}getFeatures(){return this.features}visible(e){const{rotateKnob:t,scaleKnob:i,moveKnob:r,scaleBox:o}=this;t&&(e?(o.show(),t.show(),i.show(),r.show()):(o.hide(),t.hide(),i.hide(),r.hide()))}isActive(){return null!==this.scaleBox}hide(){const{features:e,rotateKnob:t,scaleKnob:i,moveKnob:r,scaleBox:o}=this;o&&(o.remove(),t.remove(),i.remove(),r.remove()),this.scaleBox=this.moveKnob=this.rotateKnob=null,this.rotation=0,null!=e&&(this.restoreFeaturesEditable(),this.allowEditIds.length=0,this.features=null)}update(){this.scaleBox.update(),this.scaleKnob.update(),this.rotateKnob.update(),this.moveKnob.update()}offsetCorner(e,t,i){const r=this.iEditor.map,o=this.getCenter(),s=this.rotation;return e=r.rotateGeometry({type:"Point",coordinates:e},o,-s),e=[(e=r.getPixelCoord(e))[0]-t,e[1]-i],e=r.getGeoCoord(e),r.rotateGeometry({type:"Point",coordinates:e},o,s)}scale(e,t,i=this.getCenter()){this.scaleFeatures(this.getFeatures(),e,t,i),this.scaleFeatures([this.bbox],e,t,i),this.update()}getCorner(e,t=0,i=0){let r=this.bbox.geometry.coordinates[e][0];return(t||i)&&(r=this.offsetCorner(r,-t,-i)),r}getRotatedBoundingBox(e){return e?this.bbox.geometry.coordinates.slice():this.bbox.geometry.coordinates.map((e=>e[0]))}pan(e,t){const i=this.iEditor.map;for(let r of this.getFeatures())i.pixelMove(r,e,t);const{geometry:r}=this.bbox;r.coordinates=i.translateGeo(r.coordinates,e,t),this.update()}getCenter(){return this.moveKnob.getCenter()}getBBox(){const e=[1/0,1/0,-1/0,-1/0];for(let t of this.features){const i=t.getBBox?t.getBBox():t.bbox;i[0]<e[0]&&(e[0]=i[0]),i[1]<e[1]&&(e[1]=i[1]),i[2]>e[2]&&(e[2]=i[2]),i[3]>e[3]&&(e[3]=i[3])}return e}show(e){Array.isArray(e)||(e=[e]);let t,{allowEditIds:i}=this;this.iEditor.listeners.trigger("_clearOverlay"),null!=this.features&&this.restoreFeaturesEditable(),i.length=0,this.features=e;for(let r,o=0;o<e.length;o++)t=e[o],r=vt.private(t),vt.deHighlight(t),r.isSelected=!1,r.allowEdit&&(i.push(t.id),vt._editable(t,!1));this.initUI()}initUI(){const e=this,{iEditor:t}=e,i=t.objects.overlay;if(this.scaleBox)return;const[r,o,s,n]=this.getBBox(),a=r+(s-r)/2,l=o+(n-o)/2,c=((e,t,i,r)=>[[[e,r],[i,r]],[[i,r],[i,t]],[[i,t],[e,t]],[[e,t],[e,r]]])(r,o,s,n);this.bbox={type:"Feature",geometry:{type:"MultiLineString",coordinates:c}};const d=new si(t,[a,l],i,e);d.update(),e.moveKnob=d;const h=new ni(e,e.buffer,t,i),p=new ri(t,[s,o],i,e),g=new oi(t,[r,n],i,e);p.update(),g.update(),e.rotateKnob=p,e.scaleKnob=g,e.scaleBox=h}}const ci=["ready","active","history.current","history.length","changes.length"],di={ready:void 0,active:null};class hi{constructor(){this.listeners=new s(ci).sync(!0),this.val={};const e=this.val;let t,i,r=ci.length;for(;t=ci[--r];)i=di[t],e[t]=undefined!==i&&i}addObserver(e,t,i){const r=this,o=r.val;if("*"==e)for(const e in o)r.addObserver(e,t,i);else r.listeners.add(e,t,i)}removeObserver(e,t,i){const r=this,o=r.val;if("*"==e)for(const e in o)r.removeObserver(e,t,i);else r.listeners.remove(e,t,i)}get(e){return this.val[e]}change(e,t,i){const r=this,o=r.val[e];(i||o!=t&&r.get("active"))&&(r.val[e]=t,r.listeners.trigger(e,[e,t,o]))}}class pi{constructor(e,t){this.s=[],this.ie=e,this.display=t}add(e){vt.private(e).isSelected=!0,this.s.push(e)}remove(e){const{s:t}=this;vt.private(e).isSelected=!1,t.splice(t.indexOf(e),1)}select(e){const t=this.display.getZoomlevel(),i=this.ie.getLayer(e);if(t>=(null==i?void 0:i.min)&&t<=(null==i?void 0:i.max))return this.clearSelected(),this.add(e),!0}getCurSelObj(){return this.s[0]}unselectFeature(e){let t,i=this;const r=i.ie;if(e||!r._config.keepFeatureSelection){if(t=i.getCurSelObj()){const e=vt.private(t,"xt");e&&e.clear(),r.listeners.trigger("featureUnselected",{featureUnselected:!0})}i.clearSelected()}}clearSelected(){var e;let t,i=this.s;const r=this.ie;return r.listeners.trigger("_clearOverlay"),i.forEach((e=>{const i=vt.getTool(e,"deHighlight");i&&(t=e,i(e,!0),this.remove(e)),vt.private(e).isSelected=!1})),i.length=0,r.transformer.hide(),null===(e=r._rngSel)||void 0===e||e.hide(),t}}const gi="@ns:com:here:editor";class ui{constructor(){this.steps={}}clone(e){return e?JSON.parse(JSON.stringify(e)):e}add(e,t,i){const r=this.steps[e]||{},o=r[t]=r[t]||{},s=i.id;if(!o[s])return o[s]=i,this.set(e,r),!0}remove(e,t,i){try{let r=this.steps[e][t],o=i.id;if(r[o])return delete r[o],this.set(e,this.steps[e]),!0}catch(e){}return!1}get(e){return this.clone(this.steps[e])}set(e,t){this.steps[e]=this.clone(t)}clear(){const e=this.steps;for(const t in e)delete e[t]}}const Ai=e=>e.properties[gi],fi=e=>{const t=e.toJSON(),i=Ai(t);return t.class=e.class,i&&(delete i.hovered,delete i.selected),t},yi=e=>{const t=Ai(e);return t.created&&t.removed},mi=e=>{const t=Ai(e);return t.modified||t.removed||t.split||t.created};class vi{constructor(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new ui}updateObservers(e){let t=this,i=t.iEdit.observers;i.change("changes.length",t.getLength()),i.change("history.length",t.total),i.change("history.current",t.current,e)}getTotal(){return this.total}getLength(){const e=this.getChanges();let t=0;for(const i in e)for(const r in e[i])Ai(e[i][r]).origin||t++;return t}remove(e){const t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)}origin(e,t){const i=e.id,r=e.getProvider().id,o=this.storage,s=this.changes,n=this.current,a=o[n];let l=s[r];if(l||(l=s[r]={}),l[i]=e,!a||!a[r]||!a[r][i]){const i=fi(e),s=Ai(i);t&&(s.removed=!0),s.origin=!0,o.add(n,r,i)}}saveChanges(){const e=this;let t=0;if(e.active()){e.cached=null;let i=(e=>{const t={};let i=0;for(const r in e){t[r]={};for(const o in e[r])t[r][o]=fi(e[r][o]),i++}return{data:t,length:i}})(e.changes);if(t=i.length){const t=++e.current;e.storage.set(t,i.data),t>e.total?e.total++:e.total=t,e.iEdit.dump("History step saved...",t,"warn"),e.changes={},e.updateObservers()}}return t}getHistoryFeature(e,t=this.current){const i=this.storage.get(t),r=e.getProvider().id;return i&&i[r][e.id]}getChanges(){if(!this.cached){const e=this.storage,t=this.current,i={};for(let r,o=1;o<=t;o++){r=e.get(o);for(const e in r)for(const t in r[e]){const o=r[e][t];yi(o)?i[e]&&i[e][t]&&delete i[e][t]:mi(o)&&((i[e]=i[e]||{})[t]=o)}}this.cached=i}return this.cached}clear(){const e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)}import(t){const i=this,r=i.storage;for(const o in t)for(const s in t[o]){const n=i.iEdit.objects.get(s,o);if(n)i.origin(n);else{const n=e.extend(!0,{},t[o][s]),a=n.properties[gi]=n.properties[gi]||{};a.removed=!0,a.origin=!0,r.add(i.current,o,n)}}i.total=++i.current,r.set(i.current,t),i.recoverViewport(0)}recoverViewport(e,t){const i=+new Date,r=this.current+e,o=this.storage.get(r),s=this.iEdit;if(this.cached=null,r>=0&&r<=this.total){s.objects.selection.unselectFeature(),s.dump(arguments,r,"REBUILDED VIEW IN",+new Date-i,"ms"),s.objects.selection.getCurSelObj()&&s.listeners.trigger("featureUnselected",{featureUnselected:!0}),s.objects.selection.clearSelected();const e=[];for(let t in o){let i=o[t];for(let r in i){let o=i[r];e["NAVLINk"==o.class?"unshift":"push"]({provider:s.getProviderById(t),feature:o})}}for(let{feature:t,provider:i}of e){let e=i.search(t.id);e&&i.removeFeature(e);const r=Ai(t);if(!r.removed){t=s.objects.create({feature:t,provider:i,history:!0});for(const e in r)t.properties[gi][e]=r[e];s.setStyle(t)}}this.current=r,t||this.updateObservers()}}active(e){return arguments.length&&(this._a=!!e),this._a}batch(e){const t=this.active();this.active(!1),e(),this.active(t)}}let _i,Si;class Li{constructor(e){this.type="CONTAINER",this.length=0,this._e=e}push(e,t){const i=this,r={};let o,s;t&&"Feature"==t.type&&(e=arguments,t=_i),e.length==_i&&(e=[e]);const n=i._e;for(let a of e)(s=n.objects.add(a,t,r))&&(a=s,o=!0),i[i.length++]=a;return o&&n.objects.history.saveChanges(),i.length}forEach(e,t){for(let i=0;i<this.length;i++)e.call(t,this[i],i)}toArray(){const e=[];for(let t=0;t<this.length;t++)e[e.length]=this[t];return e}highlight(){const e=this;let t,i=e.length;for(;t=e[--i];)vt.highlight(t)}remove(){const e=this,t=e._e.objects;let i=!1,r=e.length;for(;r--;)i=t.remove(e[r],{animation:!1,save:!1})||i,delete e[r];i&&(e.length=0,t.history.saveChanges())}transform(){const e=this;e.length&&e._e.transformer.show(e.toArray())}unHighlight(){const e=this;let t,i=e.length;for(;t=e[--i];)vt.deHighlight(t)}unhighlight(){return this.unHighlight()}pop(){const e=this;if(e.length){const t=e[--e.length];return delete e[e.length],t}}getBBox(){const e=this,t=[1/0,1/0,-1/0,-1/0];let i;for(let r=0;r<e.length;r++)i=e[r].getBBox?e[r].getBBox():e[r].bbox,i[0]<t[0]&&(t[0]=i[0]),i[1]<t[1]&&(t[1]=i[1]),i[2]>t[2]&&(t[2]=i[2]),i[3]>t[3]&&(t[3]=i[3]);return e.length?t:[0,0,0,0]}}const bi=(e,t,i)=>({geometry:{coordinates:t,type:e},type:"Feature",properties:i||{}}),Ei=(e,t)=>{for(let i=0;i<e.length;i++)e[i].opacity!=Si&&(e[i]._opacity=e[i]._opacity||e[i].opacity),e[i].opacity=t;return e},xi=e=>{for(let t=0;t<e.length;t++)e[t].opacity=e[t]._opacity==Si?1:e[t]._opacity,delete e[t]._opacity;return e},ki=e=>e=e?e instanceof Array?e:[e]:Si,Ci=(e,t,i,r)=>[[[e,t],[e,r],[i,r],[i,t],[e,t]]];class Pi{constructor(e){this.layer=e}getProvider(){return this.layer.getProvider()}hideFeature(){const e=this,t=e.layer;let i;for(let r=0;r<arguments.length;r++)i=arguments[r],i instanceof Li&&(i=i.toArray()),i instanceof Array?e.hideFeature.apply(e,i):t.setStyleGroup(i,Ei(t.getStyleGroup(i),0))}showFeature(){const e=this,t=e.layer;let i;for(let r=0;r<arguments.length;r++)i=arguments[r],i instanceof Li&&(i=i.toArray()),i instanceof Array?e.showFeature.apply(e,i):t.setStyleGroup(i,xi(t.getStyleGroup(i)))}addFeature(e,t){const i=this.layer.addFeature(e,ki(t));return i.properties["@ns:com:here:editor"]=i.properties["@ns:com:here:editor"]||new St,i}addCircle(e,t,i){return this.addFeature(bi("Point",e,i),t)}remove(e){const t=this.layer;if(e instanceof Li)for(let i=0;i<e.length;i++)t.removeFeature(e[i]);else e&&t.removeFeature(e)}setFeatureCoordinates(e,t){e._provider.setFeatureCoordinates(e,t)}getStyles(e){return this.layer.getStyleGroup(e)}setZLayer(e){let t=this.layer.getStyle();null==e?delete t.zLayer:t.zLayer=e,this.layer.setStyle(t)}modifyRect(e,t,i,r,o){this.setFeatureCoordinates(e,Ci(t,i,r,o))}addRect(e,t,i,r,o){return this.addFeature(bi("Polygon",Ci(e,t,i,r),o))}addPolygon(e,t,i){return this.addFeature(bi("Polygon",[e],i),t)}addSquare(e,t,i,o,s){const n=r.movePoint;return i^=0,this.addPolygon([n(e,t,-45+i),n(e,t,45+i),n(e,t,135+i),n(e,t,225+i),n(e,t,-45+i)],o,s)}addPath(e,t,i){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:i||{}},ki(t))}addPoint(e,t,i){t instanceof Array||(i=t,t=Si);const r={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:i||{}};return this.addFeature(r,ki(t))}addImage(e,t,i){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:i||{}},ki(t))}}var Ii="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==";let Ri;const Oi="#111111",wi=e=>e.properties["@ns:com:here:editor"].hovered,Ni=e=>e.properties["@ns:com:here:editor"].selected,Fi=(e,t,i)=>"function"==typeof e?e(t,i):e,Mi=e=>[{zLayer:e=>e.properties.zLayer,zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000",altitude:!!e}],Ti=e=>{const t=[{zIndex:4,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20,pointerEvents:!1,altitude:e}];return e&&t.push({zIndex:3,type:"VerticalLine",stroke:Oi,altitude:({properties:e})=>e[e.parentType].altitude},{zIndex:1,type:"Circle",radius:4,fill:Oi,opacity:.6,zLayer:({properties:e})=>e[e.parentType].zLayer}),t},ji=e=>e?[{zLayer:e=>e.properties.zLayer,zIndex:999992,type:"Sphere",radius:8,fill:"#FF0000",stroke:"#FF0000",altitude:({properties:e})=>e[e.parentType].altitude},{zLayer:e=>e.properties.zLayer,zIndex:999991,type:"VerticalLine",stroke:"#000",altitude:!0},{zIndex:999990,type:"Circle",radius:4,fill:Oi,opacity:.6,altitude:0,zLayer:e=>e.properties.zLayer}]:[{zLayer:e=>e.properties.zLayer,zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:e=>e.properties.zLayer,zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],Bi=e=>[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:Oi,strokeWidth:1.5},{zIndex:1,type:"Text",fill:Oi,font:"normal 16px Arial",text:e}],Di=e=>[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:e=>e.properties.rotation}];class Gi extends d{constructor(){super(...arguments),this.styleGroups={ADDRESS_LINE:Mi(),ADDRESS_LINE_3D:Mi(!0),ADDRESS_ROUTING_POINT:ji(),ADDRESS_ROUTING_POINT_3D:ji(!0),ADDRESS_SELECTOR:Ti(),ADDRESS_SELECTOR_3D:Ti(!0),PLACE_LINE:Mi(),PLACE_LINE_3D:Mi(!0),PLACE_ROUTING_POINT:ji(),PLACE_ROUTING_POINT_3D:ji(!0),AREA_SHAPE:[{zIndex:0,zLayer:({properties:e})=>e.AREA.zLayer,type:"Circle",strokeWidth:2,stroke:Oi,radius:e=>wi(e)?8:6,fill:(e,t)=>{const{fill:i,stroke:r}=e.properties.AREA.style[0];return wi(e)?Oi:Fi(i,e.getArea(),t)||Fi(r,e.getArea(),t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,zLayer:({properties:e})=>e.AREA.zLayer,type:"Circle",strokeWidth:1,fill:Oi,stroke:Oi,radius:e=>wi(e)?6:4}],AREA_HEIGHT_KNOB:[{zIndex:4,type:"Sphere",altitude:!0,fill:(e,t)=>{const{fill:i,stroke:r}=e.properties.AREA.style[0];return wi(e)?"#777":Fi(i,e.getArea(),t)||Fi(r,e.getArea(),t)},radius:10,offsetZ:50},{zIndex:3,type:"VerticalLine",stroke:"#000",offsetZ:50}],LINE_SHAPE_3D:[{zIndex:4,type:e=>Ni(e)?"Sphere":null,radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return 6+(r/2+4^0)},fill:"red",opacity:.5,strokeWidth:5,altitude:!0},{zIndex:3,type:"Sphere",alignment:"map",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return r/2+4^0},stroke:(e,t)=>{const i=e.properties.LINE.style.filter((e=>"Line"==e.type));return i[i.length-1].stroke||"BLACK"},fill:(e,t)=>{let i=e.properties.LINE.style;return i.length>1?i[0].stroke:"#e9e9e9"},strokeWidth:2,altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:Oi,opacity:.6,zLayer:({properties:e})=>e.LINE.zLayer}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return r/2+4^0},stroke:(e,t)=>{var i;const r=e.properties.LINE.style.filter((e=>"Line"==e.type));return(null===(i=r[r.length-1])||void 0===i?void 0:i.stroke)||"BLACK"},fill:(e,t)=>{let i=e.properties.LINE.style;return i.length>1?i[0].stroke:"#151515"},strokeWidth:2},{zIndex:4,type:e=>Ni(e)?"Circle":null,radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return 6+(r/2+4^0)},stroke:"red",strokeWidth:3}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return r/2^0},fill:"#151515"}],LINE_VIRTUAL_SHAPE_3D:[{zIndex:3,type:"Sphere",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=f.getLineWidth(i,e.getLine(),t,0);return r/2^0},fill:"red",altitude:({properties:e})=>{var t;return null===(t=e.LINE.style.find((e=>e.altitude)))||void 0===t?void 0:t.altitude}},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:Oi,opacity:.6,zLayer:({properties:e})=>e.LINE.zLayer}],MARKER_SELECTOR:Ti(),MARKER_SELECTOR_3D:Ti(!0),PLACE_SELECTOR:Ti(),PLACE_SELECTOR_3D:Ti(!0),NAVLINK_SHAPE:[{zIndex:0,type:e=>e.properties.isConnected?"Rect":"Circle",width:e=>wi(e)?18:12,rotation:45,radius:e=>wi(e)?9:6,strokeWidth:2,fill:(e,t)=>e.isOverlapping()?"#FFFFFF":Fi(e.properties.NAVLINK.style[0].stroke,e.getLink(),t),stroke:e=>e.isOverlapping()?"#FF0000":"#FFFFFF"},{zIndex:1,type:e=>Ni(e)?"Circle":null,radius:e=>wi(e)?18:14,stroke:"red",strokeWidth:3}],NAVLINK_SHAPE_3D:[{zIndex:0,type:e=>e.properties.isConnected?"Box":"Sphere",width:e=>wi(e)?18:12,rotation:45,radius:e=>wi(e)?9:6,strokeWidth:2,fill:(e,t)=>e.isOverlapping()?"#FFFFFF":Fi(e.properties.NAVLINK.style[0].stroke,e.getLink(),t),stroke:e=>e.isOverlapping()?"#FF0000":"#FFFFFF",alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:Oi,opacity:.6,zLayer:({properties:e})=>e.NAVLINK.zLayer}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.NAVLINK;let[r]=f.getLineWidth(i,e.getLink(),t,0);return r/5},opacity:.7,fill:Oi,stroke:Oi,strokeWidth:2}],NAVLINK_VIRTUAL_SHAPE_3D:[{zIndex:1,type:"Sphere",radius:(e,t)=>{const{style:i}=e.properties.NAVLINK;let[r]=f.getLineWidth(i,e.getLink(),t,0);return r/5},opacity:.7,fill:Oi,stroke:Oi,strokeWidth:2,alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:Oi,opacity:.6,zLayer:({properties:e})=>e.NAVLINK.zLayer}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:e=>e.properties.bearing,width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:e=>e.properties.bearing,width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:Ii,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:Bi("A"),NAVLINK_DIRECTION_HINT_B:Bi("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:e=>-e.properties.bearing,opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:Ii,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:e=>e.properties.rotation,alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:e=>"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}],TURN_RESTRICTION_ONEWAY:Di(Ii),TURN_RESTRICTION_FORBIDDEN:Di("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:Di("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:Di("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),TRANSFORMER_TRANSLATE_KNOB:[{type:"Circle",zIndex:0,zLayer:1e4,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}],TRANSFORMER_ROTATE_KNOB:[{type:"Image",zIndex:4,zLayer:1e4,src:({properties:e})=>e.hovered?"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=":"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",width:18}],TRANSFORMER_SCALE_KNOB:[{type:"Circle",zIndex:4,zLayer:1e4,fill:({properties:e})=>e.hovered?"white":"black",radius:9},{zIndex:5,zLayer:1e4,type:"Text",fill:({properties:e})=>e.hovered?"black":"white",font:"20px Arial",text:"⤡"}],TRANSFORMER_SCALE_BOX:[{type:"Line",zIndex:0,zLayer:1e4,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}],RANGESELECTOR_LINE:[{zIndex:0,type:"Line",stroke:"white",strokeWidth:23},{zIndex:1,type:"Line",stroke:"grey",strokeWidth:20},{zIndex:2,type:"Line",stroke:"white",strokeWidth:3,strokeDasharray:[5,4],strokeLinecap:"butt"}],RANGESELECTOR_RANGE_MARKER:[{zIndex:110,type:"Rect",fill:"#fff",width:2,height:20,alignment:"map",offsetY:8},{zIndex:111,type:"Circle",fill:"#000",radius:7,alignment:"map",stroke:"#fff",strokeWidth:1,offsetY:20},{zIndex:110,type:"Circle",stroke:"#fff",radius:5,alignment:"map"}],RANGESELECTOR_RANGE_LINE:[{zIndex:4,type:"Line",strokeWidth:9,opacity:.75,stroke:"#fff"}],UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}assign(e){var t,i;const{styleGroups:r}=this,{properties:o}=e;let s=e.class||o.type,n=!1;if("LINE_SHAPE"==s||"LINE_VIRTUAL_SHAPE"==s||"NAVLINK_SHAPE"==s||"NAVLINK_VIRTUAL_SHAPE"==s?n=null===(t=(o.LINE||o.NAVLINK).style.find((e=>e.altitude)))||void 0===t?void 0:t.altitude:"MARKER_SELECTOR"==s?(n=o.MARKER.altitude,n==Ri&&(n=!!e.geometry.coordinates[2])):n=null===(i=o[o.parentType])||void 0===i?void 0:i.altitude,n){const e=s+"_3D";s=r[e]?e:s}return r[s]!==Ri?s:"UNKNOWN"}}class zi extends h{constructor(e={}){e.name="EOP",super(e),this.id="EOP-"+this.id}}let Ki;let Hi;const Vi="pointerenter pointerleave pointerup pressmove pointerdown dbltap",Yi="addLayer removeLayer",Zi=e=>e.class;class Ui{constructor(e,t){this.listen=!1;const i=this;i.iEdit=e,i.display=t,i.history=new vi(e),i.selection=new pi(e,t);const r=(e=>{const t=new zi;return t._e=()=>e,new p({name:"EditorOverlay",min:1,max:28,style:new Gi,provider:t})})(e);i.overlay=new Pi(r);let o=new n([[r.id,r]]);this.layers=o,t.addLayer(r,(e=>{let t,i=e.length;for(;i--;)if((t=e[i].getProvider())&&"NAVLINK"==t.class)return i+1;return e.length})(t.getLayers())),i.arrangeOverlay=i.arrangeOverlay.bind(i),i.pointerListener=i.pointerListener.bind(i),e.listeners.add("_layerAdd",(e=>{const t=e.detail.layer;o.set(t.id,t);const i=o.values().filter((e=>e!==r));r.min=Math.min(...i.map((({min:e})=>e))),r.max=Math.max(...i.map((({max:e})=>e)))})),e.listeners.add("_layerRemove",(t=>{const i=t.detail.layer;o.delete(i.id);const r=e.objects.selection.getCurSelObj();r&&e.getLayer(r)==i&&e.objects.selection.clearSelected()})),i.onMVCStart=i.onMVCStart.bind(i)}onMVCStart(){this.selection.unselectFeature()}splitLinkAt(t){return((t,i)=>{const r=i.link;let o=i.index;const s=i.preferSegment,n=i.avoidSnapping;let a=r.coord();const l=a.length-1,c=At._props(r),d=r.getProvider().readZLevels(r),h=t._config.snapTolerance,{point:p,ignoreZ:g}=i;let u,A,f;if(p&&(u=p[0],A=p[1],f=p[2]||0),0===o||o===l||u==a[0][0]&&A==a[0][1]||u==a[l][0]&&A==a[l][1])return!1;if(t.objects.history.origin(r),o===Ki){const e=t.map.searchPointOnLine(a,p,h,s,Ki,g);if(o=null==e?void 0:e.index,(0===o||o===l)&&e.existingShape)return!1;o=At.addShp(r,[u,A,f],null,!0,null,s),a=r.coord()}At.deHighlight(r);const y=r.getProvider(),m=(i,r,o)=>{const s=e.extend(!0,{},c),n={type:"Feature",geometry:{type:"LineString",coordinates:i},properties:s};return delete s["@ns:com:here:editor"],t.objects.create({feature:n,provider:y,zLevels:r,preferIndex:o})},v=m(a.slice(0,o+1),d.slice(0,o+1),n&&o),_=m(a.slice(o),d.slice(o),n&&0);let S=xe(a[o],a);S>.995&&(S=1);const L=ke(a,a[o]).offset,b=At.getConnectedObjects(r);for(var E in b){const e=b[E],t=Ke.getRoutingPosition(e),i=L>ke(a,t).offset?v:_;Ke.connect(e,i,t),Ke.markAsModified(e,!1)}return t.hooks.trigger("Navlink.split",{link:r,index:o,children:[v,_],relativePosition:S},y),r.editState("split",Date.now()),t.objects.remove(r,{animation:!1,split:!0}),[v,_]})(this.iEdit,t)}destroy(){this.display.removeLayer(this.overlay.layer)}arrangeOverlay(e){const t=e&&e.detail.layer,i=this.display,r=this.overlay.layer;if(!i.getLayers)return;const o=i.getLayers();if(!(t.getProvider()instanceof zi)){const e=o.map((e=>{const t=e.getProvider();return t&&t.class})).indexOf("NAVLINK");i.removeLayer(r),e>=0?i.addLayer(r,e+1):i.addLayer(r)}}pointerListener(e){const t=this.iEdit,i=e.target,r=e.type;if(i){const t=e.detail.layer;if(!this.layers.has(t.id))return;const o=vt.getEventListener(i,r);if(o)return e.stopPropagation(),o.apply(i,arguments)}"pointerup"!=r&&"dbltap"!=r||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)}listenDisplay(e){const t=this.display,i=this.listen,r=this.pointerListener,o=this.arrangeOverlay;e?i||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Vi,r),t.addEventListener(Yi,o)):i&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Vi,r),t.removeEventListener(Yi,o))}get(e,t){const i=this.iEdit;return t?"object"!=typeof t&&(t=i.getLayer(t)):t=i.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null}getInBBox(e,t,i){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);const r=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-r,e[1]-r,e[2]+r,e[3]+r];const o=[];let s,n=(t=t||this.layers.values())instanceof Array?t:[t];for(let t of n)if(s=t.search(e))for(let e of s)i&&!i(e)||o.push(e);return o}remove(e,t){const i=this;let r=!1;if((t=t||{}).split||!i.iEdit._config.editRestrictions(e,y.REMOVE)){const o=null==t.animation||t.animation;o&&vt.private(e,"isSelected")&&i.selection.clearSelected(),Zi(e)&&(i.history.origin(e),vt.markAsRemoved(e,o),t.save&&i.history.saveChanges(),r=!0);const s=e.getProvider();return e.editState&&!e.editState("created")&&s.blockFeature(e,!0),s.removeFeature(e),r}}add(e,t,i){const r=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=r.getLayerForClass(Zi(e))),t)){const r=e.id,o=r!=Hi&&t.search(r);return r!=Hi&&o?o:this.create({feature:e,provider:t.getProvider(),idMap:i})}}create(e){const t=this.iEdit,i=t.objects.history,r=[];let o=e.feature;Array.isArray(o)||(o=[o]);const s=e.idMap||{},{provider:n,preferIndex:a,history:l,zLevels:c}=e,d=e=>(l&&n.blockFeature(e,!1),e=n.addFeature(e),e=n.search(e.id),l||(e.editState("created",Date.now()),vt.markAsModified(e,!1),i.origin(e,!0),c&&i.batch((()=>{n.writeZLevels(e,c)}))),r.push(e),e);for(let e=0;e<o.length;e++){let c,h=o[e],p=h.id;if(l||n.enforceRandomFeatureId&&(h.id=Hi),h=n.prepareFeature(h),c=n.detectFeatureClass(h),p==Hi&&(p=h.id),s[p]=h.id,h=d(h),"NAVLINK"===c){if(h.geometry.coordinates.forEach((e=>e[2]||(e[2]=0))),!l){!1===At.fixGeo(h,Hi,Hi,a)&&(i.remove(h),n.removeFeature(r.pop()))}}else if("PLACE"===c||"ADDRESS"===c){let e=Ke.getRoutingData(h),o=e.link;if(s[o]){const t=Ke.getRoutingProvider(h),r=t&&t.search(s[o]);i.batch((()=>{h.getProvider().writeRoutingPoint(h,r,e.position)}))}"ADDRESS"!==c||l||(Ke.connect(h),h.getLink()||(i.remove(h),n.removeFeature(r.pop()),t.dump("No Link found within "+t._config.maxRoutingPointDistance+" meters","warn")))}}return r.length>1?r:r[0]}getNearestLine(t,i,o){const{iEdit:s}=this;o=e.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},o||{});const n={line:null,point:null,distance:1/0,shpIndex:null,segment:null};let{maxDistance:a}=o,l=a<1/0?r.getPointBBox(t,a):null;i instanceof g&&(i=this.getInBBox(l,i));for(let e of i){if(o.ignore&&o.ignore(e))continue;const{bbox:i}=e;if(a==1/0||R(l[0],l[2],l[1],l[3],i[0],i[2],i[1],i[3])){const i=s.map.searchPointOnLine(e.geometry.coordinates,t,-1,Hi,Hi,o.ignoreZ);(null==i?void 0:i.distance)<Math.min(n.distance,o.maxDistance)&&(n.point=i.point,n.distance=i.distance,n.shpIndex=i.existingShape?i.index:null,n.segment=i.index-Number(!i.existingShape),n.line=e,a=r.distance(i.point,t),l=r.getPointBBox(t,a))}}if(n.line){if(o.ignoreZ){const{line:e,segment:t,point:i}=n,r=e.geometry.coordinates;i[2]=Ce(i,r[t],r[t+1])}return n}}searchLine(t,o,s,n){const{iEdit:a}=this;s=e.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},s||{});const l={line:null,point:null,distance:1/0,shpIndex:null,segment:null};let{maxDistance:c,ignoreZ:d}=s,h=c<1/0?r.getPointBBox(t,c):null;o instanceof g&&(o=this.getInBBox(h,o,(e=>"NAVLINK"==e.class)));const{display:p}=a,{x:u,y:A}=p.geoToPixel(t[0],t[1]),f=p._unprj(u,A,-1),y=p._unprj(u,A,1),m=i.sub([],y,f);for(let e of o){if(s.ignore&&s.ignore(e))continue;const{bbox:t}=e;if(!h||R(h[0],h[2],h[1],h[3],t[0],t[2],t[1],t[3])){const t=e.geometry.coordinates;let o,s=t[0],n=p._g2w(s[0],s[1],d?0:s[2]);for(let a=1;a<t.length;a++){s=t[a],o=n,n=p._g2w(s[0],s[1],d?0:s[2]);const[h,g]=i.sub([],o,n);if(!h&&!g)continue;const u=o,A=i.add([],o,[-g,h,0]),y=n,v=i.normalize([],i.cross([],i.sub([],y,A),i.sub([],u,A)));let _=j(m,f,v,u),S=p._w2g(_);_=T(u,y,_,!0);let L=p._w2g(_),b=r.distance(L,S);b<Math.min(l.distance,c)&&(l.point=L,l.distance=b,l.line=e)}}}return l.line?l:null}}class Wi{constructor(e,t){this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.add("_layerAdd",(e=>{this.observers.change("ready",!1),this.display.setCenter(this.display.getCenter()),e.detail.layer.addEventListener("viewportReady",this.onStop)})),e.listeners.add("_layerRemove",(e=>{var t,i;e.detail.layer.removeEventListener("viewportReady",this.onStop),null===(t=this.busy)||void 0===t||t.delete(e.detail.layer),(null===(i=this.busy)||void 0===i?void 0:i.size)||this.iEdit.layers.length||this.observers.change("ready",!0)}))}onStart(){if(!this.busy){const e=this.iEdit.layers;this.busy=new a(e),e.length&&this.observers.change("ready",!1)}}onStop(e){const t=e.detail.layer,i=this.busy;i&&(i.delete(t),i.size||(this.observers.change("ready",!0),this.busy=null))}start(){this.display.addEventListener("mapviewchangestart",this.onStart)}stop(){this.display.removeEventListener("mapviewchangestart",this.onStart)}}const Qi=["Navlink.split","Navlink.disconnect","Feature.remove","Coordinates.update"],Xi=(e,t)=>{let i=e.__=e.__||String(1e9*Math.random()^0);return t&&(i+=";"+t.id),i};class Ji{constructor(e){this.h=new s(Qi),this.h.sync(!0),this.history=e,this.w=new Map}add(e,t,i){const r=Xi(t,i);let o=this.w.get(r);return o||this.w.set(r,o=((e,t)=>{const i=(i,r)=>{t&&r!=t||e(i)};return i.h=e,i})(t,i)),this.h.add(e,o)}remove(e,t,i){return this.h.remove(e,this.w.get(Xi(t,i)))}get(e){return this.h.get(e).map((e=>e[0].h))}trigger(e,t,i){let r=this.history,o=r.active();r.active(!1),this.h.trigger(e,[t,i]),r.active(o)}}const qi=1e9,$i=Math.PI/180;let er,tr=class{constructor(e,t,i,r){this.point=e,this.index=t,this.distance=i,this.existingShape=r}};function ir(e,t){if("number"==typeof e[0])return t(e);const i=[];let r=e.length;for(;r--;)i[r]=ir(e[r],t);return i}let rr=class{constructor(e){this.display=e}distance(e,t){return r.distance(e,t)}rotatePoint(e,t,i){return this.clipGeoCoord(function(e,t,i){const r=e[0]-t[0],o=e[1]-t[1],s=i*$i;return[t[0]+(Math.cos(s)*r-Math.sin(s)*o/Math.abs(Math.cos(t[1]*$i))),t[1]+(Math.sin(s)*r*Math.abs(Math.cos(t[1]*$i))+Math.cos(s)*o),0^e[2]]}(e,t,i))}movePoint(e,t,i,o){return this.clipGeoCoord(r.movePoint(e,t,i,o))}scaleGeometry(e,t,i){return ir(e.coordinates,(e=>this.clipGeoCoord([i[0]+(e[0]-i[0])*t[0],i[1]+(e[1]-i[1])*t[1],0^e[2]])))}rotateGeometry(e,t,i){const r=this;return ir(e.coordinates,(e=>r.rotatePoint(e,t,i)))}getClosestPoint(e,t,i){const r=e[0]-t[0],o=e[1]-t[1],s=e[1]*t[0]-e[0]*t[1],n=r*i[0]+o*i[1],a=1/(r*r+o*o);return[(n*r+s*o)*a,(n*o-s*r)*a]}searchPointOnLine(e,t,i,r,o,s){const n=this;let a,l,c=null,d=o||1/0,h=!1,p=null,g=null,u=null;if(r!=er){const a=n.searchPointOnLine(e.slice(r,r+2),t,i,er,o,s);return a&&(a.index+=r),a}s&&(t=[t[0],t[1]]);for(let i=0;i<e.length;i++){let r=e[i];a=n.distance(r,t),a<=d&&(d=a,p=r[0],g=r[1],u=r[2],c=i,h=!0)}if(d>i||!h){const i=e.map((e=>n.display._g2w(e[0],e[1],s?er:e[2]))),r=n.display._g2w(t);
// const path = pathGeo.map((c) => map.getPixelCoord(c));
for(var A=0;A<i.length;A++)if(A<i.length-1&&(l=T(i[A],i[A+1],r,!0))){const e=n.clipGeoCoord(n.display._w2g(l));a=n.distance(e,t),a<d&&(d=a,c=A+1,p=e[0],g=e[1],u=l[2],h=!1)}}return null!==c?(s&&(u=h?e[c][2]:Ce([p,g],e[c-1],e[c])),new tr([p,g,u||0],c,d,h)):null}translateGeo(e,t,i){const r=this,o=r.display;return ir(e,(e=>{const s=o.geoToPixel(e[0],e[1]);return r.getGeoCoord(s.x+t,s.y+i,e[2])}))}translateZ(e,t){return this.display._translateGeoCoord(e,0,0,t)}pixelMove(e,t,i){const r=e.getProvider(),o=this.translateGeo(r.decCoord(e),t,i),s=vt.getTool(e,"_setCoords");s?s(e,o):r.setFeatureCoordinates(e,o)}clipGeoCoord(e,t){const[i,r,o]=e;return e[0]=Math.round(i*qi)/qi,e[1]=Math.round(r*qi)/qi,t&&"number"==typeof o&&(e[2]=Math.round(1e3*o)/1e3),e}getGeoCoord(e,t,i){const r=this.display;let o;return arguments.length>1?o=r.pixelToGeo(e,t):(o=e,o.x!=er&&o.y!=er?(i=o.z,o=r.pixelToGeo(o.x,o.y)):e[0]!=er&&e[1]!=er&&(i=o[2],o=r.pixelToGeo(o[0],o[1]))),this.clipGeoCoord([o.longitude,o.latitude,0|i])}getPixelCoord(e,t,i){const r=this.display;return 2==arguments.length?e=r.geoToPixel(e,t):e.longitude!=er&&e.latitude!=er?e=r.geoToPixel(e.longitude,e.latitude):e[0]!=er&&e[1]!=er&&(e=r.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]}getEventsMapXY(e){const t=this.display;let i,r;if(e.mapX!=er)i=e.mapX,r=e.mapY;else{const o=t.getContainer().getBoundingClientRect();i=e.pageX-o.left,r=e.pageY-o.top}return[i,r]}};const or="error";let sr;class nr{constructor(t,i){this.isCommitInProcess=!1,this._config=t;const r=this;r.layers=[],r.layerMap={},r.observers=new hi,r.listeners=new qt,r.objects=new Ui(r,i),r.hooks=new Ji(r.objects.history),this._dListener=new Wi(r,i),this._dListener.start();const o=r.objects.overlay.layer,s=this.prvIdLayerMap={};function n(e){r.listeners.trigger(or,e)}s[o.getProvider().id]=o,r.listeners.add("_layerAdd",(e=>{const t=e.detail.layer,i=t.getProvider();for(let e of["src","base","delta","id"]){const r=i[e];r&&(s[r]=t)}t.removeEventListener(or,n),t.addEventListener(or,n)})),r.map=new rr(i),r.transformer=new li(r),r.display=i,r.dump=e.dump}getLayerForClass(e){let t,i,r,o;for(let s of this.layers)s.getProvider&&(o=s.getProvider()),i=o.class,i?e==i&&(r=s):t||(t=s);return r||t}getProviderById(e){const t=this.prvIdLayerMap[e];if(t)return t.getProvider()}getLayerById(e){for(let t of this.layers)if(t.id==e)return t}getLayer(e){let t;if("object"==typeof e){const t=e.getProvider();e=t.src||t.delta||t.base||t.id}return e&&(t=this.prvIdLayerMap[e]),t}destroy(){this._dListener.stop(),this.objects.destroy(),this.listeners.destroy()}getStyle(t,i){const r=this.getLayer(t).getStyleGroup(t,0^this.display.getZoomlevel(),i);return e.extend(!0,[],r)}getResolvedStyle(e,t){const i=this.getStyle(e,t),r=0^this.display.getZoomlevel();for(let t of i)for(let i in t)t[i]=f.getValue(i,t,e,r);return i}getCustomStyle(e){return this.getLayer(e)._getCustomStyleGroup(e)}getStyleProperty(e,t){const i=this.getStyle(e);for(let r of i)if(r[t]!=sr)return f.getValue(t,r,e,0^this.display.getZoomlevel())}getZLayer(e){const t=e.getStyle().zLayer;return null!=t?t:1+this.display.getLayers().indexOf(e)}getMaxZLayer(e){const t=this.getLayer(e),i=t.getStyleGroup(e);let r=-1;if(i){let t=0^this.display.getZoomlevel();for(let o of i){let i=f.getValue("zLayer",o,e,t);i>r&&(r=i)}}return r>-1?r:this.getZLayer(t)}setStyle(e,t,i){var r;const o=this.getLayer(e);t==sr?t=o._getCustomStyleGroup(e):"default"==t&&(t=(null===(r=o._getCustomStyleGroup(e))||void 0===r?void 0:r.__default)||sr),o.setStyleGroup(e,t,i)}}const ar=(e,t,i,r)=>e.getProvider().readTurnRestriction({link:e,index:t},{link:i,index:r}),lr=(e,t,i,r,o)=>{t.getProvider().writeTurnRestriction(e,{link:t,index:i},{link:r,index:o})};var cr={"Navlink.split":[e=>{let t=e.link,i=e.children,r=i[0],o=i[1];const s=t.coord().length-1,n=r.coord().length-1,a=o.coord().length-1;for(let{link:e,index:i}of t.getConnectedLinks(0,!0))ar(t,0,e,i)&&(lr(!0,r,0,e,i),lr(!1,o,0,e,i)),ar(e,i,t,0)&&(lr(!0,e,i,r,0),lr(!1,e,i,o,0));for(let{link:e,index:i}of t.getConnectedLinks(s,!0))ar(t,s,e,i)&&(lr(!0,o,a,e,i),lr(!1,r,n,e,i)),ar(e,i,t,s)&&(lr(!0,e,i,o,a),lr(!1,e,i,r,n))}],"Feature.remove":e=>{let t=e.feature;if("NAVLINK"==t.class){const e=0,i=t.coord().length-1;for(let{link:i,index:r}of t.getConnectedLinks(e,!0))lr(!1,t,e,i,r);for(let{link:e,index:r}of t.getConnectedLinks(i,!0))lr(!1,t,i,e,r)}},"Navlink.disconnect":e=>{let t=e.link;const i=e.index;t.getConnectedLinks(i,!0).forEach((e=>{const r=e.link,o=e.index;lr(!1,t,i,r,o),lr(!1,r,o,t,i)}))}};const dr="info",hr=e=>e.properties["@ns:com:here:editor"],pr=e=>!!hr(e).created,gr=e=>!!hr(e).removed;class ur{constructor(e){this.pIds={},this.iEdit=e}reserveIds(e,t,i,r){const{pIds:s}=this,n=e.id,a=[];for(const e in t)pr(t[e])&&(s[n][e]||a.push(t[e]));a.length>0?e.reserveId(a,(e=>{for(const i in t){const r=t[i];pr(r)&&!s[n][i]&&(s[n][i]=e.shift())}i(s[n],n)}),r):o.setTimeout((()=>{i(s[n],n)}),0)}replaceIds(t,i,r){const{pIds:o,iEdit:s}=this,n="id";let a,l,c,d=0;c=JSON.stringify(t);for(const h in t){d++,l=!1;for(const e in t[h])if(pr(t[h][e])){l=!0;break}o[h]||(o[h]={}),l?(s.dump("REQUESTING PERMANENT IDs..",dr),this.reserveIds(s.getProviderById(h),t[h],((r,o)=>{const l="#"+e.String.random()+"#";let h,p;for(const e in r)(a=t[o][e])&&(h="number"==typeof r[e]?r[e]:'"'+r[e]+'"',p=a[n],"string"==typeof p&&(p=`"${a[n].replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\")}"`),h!=p&&(c=c.replace(p+":{",l).replace(new RegExp('"link":'+p,"g"),'"link":"'+h+'"').replace(new RegExp(p,"g"),h).replace(l,h+":{")),s.dump(a[n]+" -> "+h,dr));--d||i(JSON.parse(c))}),r)):d--}!d&&i(t)}send(t,i,r,o){const{pIds:s,iEdit:n}=this;let a=0;function l(){--a||i(e.clone(s))}for(const e in t){a++;const i=n.getProviderById(e),c=t[e],d=[],h=[];let p;for(const e in c)p=c[e],(gr(p)?h:d).push(p);const g=s[e],u={};for(const e in g)u[g[e]]=e;d.length|h.length?i.commit({put:d,remove:h},l,(e=>{r&&r(e)}),o):l()}}submit(t,i,r,o=e.String.random()){const{iEdit:s}=this,n=s._config.services.reverseGeocoder.getISOCC;let a=0;s.dump("COMMIT",o,dr);const l=()=>{this.replaceIds(t,(e=>{this.send(e,i,r,o)}),r)};function c(e){if(e)return"number"==typeof e[0]?e:c(e[0])}for(const e in t)for(const i in t[e]){const r=t[e][i],o=s.getProviderById(e);gr(r)?pr(r)&&delete t[e][i]:n&&(o.isoCC(r)||(a++,s.dump(r.id,"["+o.detectFeatureClass(r)+"] MISSING ISOCC -> REVERSE GEOCODING..",dr),((e,t)=>{n(t[0],t[1],(t=>{t&&o.isoCC(e,t),--a||l()}))})(r,c(r.geometry.coordinates))))}a||l()}}const Ar="NAVLINK";let fr;const yr=e=>{const t=e.class;return t==Ar?Ar:String(t)+(e.src||e.base+e.delta||e.id)},mr=(e,t,i)=>{const r=t.hooks;if(r)for(let o in r){let s=r[o];s instanceof Array||(s=[s]);for(let r of s)i.hooks[e](o,r,t)}},vr=e=>{(e=>{const t=e.objects.history.getChanges(),i=[];let r,o;for(const s in t){o=e.getProviderById(s);for(const e in t[s])r=o.search(e),o._clearOnCommit?(r&&(r.properties["@ns:com:here:editor"].drop=!0),i.push(o,t[s][e].bbox)):r&&(r.properties["@ns:com:here:editor"]={})}for(let e=0;e<i.length;e+=2)o=i[e],o.clear(i[e+1])})(e),e.objects.history.clear(),e.display.refresh()};class _r{constructor(t,i){this._b=0;const r=this,o=(i=(t=>{const i=e.extend(!0,{},v);for(const r in t)switch(r){case"services":e.extend(!0,i[r],t[r]);break;case"editRestrictions":if("function"!=typeof t[r])break;default:i[r]=t[r]}return i})(i||{})).layers;delete i.layers,e.loglevel=i.debug&&"debug";let s=new nr(i,t);var n;r._i=()=>s,n=s,(e=>{let t;for(let i in e){t=e[i],"function"==typeof t&&(t=[t]);for(let e of t)n.hooks.add(i,e)}})(cr),r.container=t.getContainer(),o instanceof Array&&o.forEach((e=>this.addLayer(e))),r.active(!0),setTimeout((()=>{const e=s.observers,t=e.get("active"),i=t;e.change("active",t,i),s.layers.length||e.change("ready",!0)}),0)}active(e){let t=this._i(),i=t.observers.get("active");return null!=e&&(e=!!e)!=i&&(i=e,t.objects.listenDisplay(e),t.observers.change("active",e,!0)),i}addEventListener(t,i,r){const{listeners:o}=this._i(),s=o.supported().filter((e=>"_"!=e[0]));String(t).split(" ").forEach((t=>{s.indexOf(t)>-1?o.add.call(o,t,i,r):e.dump(t+" is not a valid event. Use: "+s.join(", "),"warn")}))}removeEventListener(e,t){const{listeners:i}=this._i();i.remove.apply(i,arguments)}addFeature(e,t,i){const r=this._i(),o=arguments,s=[],n={};let a,l,c={};const d=e=>e.x!=fr&&e.y!=fr||e.longitude!=fr&&e.latitude!=fr,h=(e,t)=>{if(d(e)&&(e=r.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],r.map.clipGeoCoord(e);const i=[];for(let r=0;r<e.length;r++)i[r]=h(e[r],t);return i},p=(e,t)=>{const i=t&&t.id;(c[i]=c[i]||[]).push(e)};if("Feature"==e.type)p(e,t);else if(e instanceof Array)e.forEach((e=>p(e,t)));else{c=e;for(let t in c)"Feature"==(e=c[t]).type&&(c[t]=[e])}if(d(i=o[o.length-1])){i=r.map.getGeoCoord(i);const e=r.display.getViewBounds();l=[i[0]-e.minLon,i[1]-e.maxLat]}else l=[0,0];for(let e in c){c[e].forEach((t=>{const i=t.geometry;i.coordinates=h(i.coordinates,l),"Feature"!=t.type||t instanceof kt||(t=new kt(t)),(t=r.objects.add(t,"undefined"==e?fr:e,n))&&(a=!0,s.push(t))}))}return a&&r.objects.history.saveChanges(),s.length>1?this.createFeatureContainer.apply(this,s):s[0]}addHook(e,t,i){return this._i().hooks.add(e,t,i)}batch(e){if("function"==typeof e){this.beginBatch();try{e()}finally{this.endBatch()}}}beginBatch(){this._b++,this._i().objects.history.active(!1)}endBatch(){const e=this._i().objects.history;this._b>0&&0==--this._b&&(e.active(!0),e.saveChanges())}removeHook(e,t,i){return this._i().hooks.remove(e,t,i)}getHooks(e){return this._i().hooks.get(e)}getFeature(e,t){return this._i().objects.get(e,t)||null}config(e,t){const i=this._i()._config;switch(arguments.length){case 2:i[e]=t;break;case 1:return i[e];case 0:return Object.assign({},i)}}createFeatureContainer(...e){const t=new Li(this._i());return t.push(e.flat()),t}getSelectedFeature(){return this._i().objects.selection.getCurSelObj()||null}clearFeatureSelection(){return this._i().objects.selection.clearSelected()||null}search(e){const t=this._i(),i=[];let r;if("object"==typeof e){const o=e.filter,s=e.layers||t.layers;let n=s.length;for(;n--;){let t=s[n].search(e);t instanceof Array||(t=[t]);let a=t.length;for(;r=t[--a];)o&&!o(r)||i.push(r)}}return i}addLayer(e){if(e){const t=this._i(),i=t.layerMap,r=e.getProvider();if(r&&"FeatureProvider"==r.__type&&r.editable&&(!i[yr(r)]||r.class==Ar)){if(r._e instanceof nr){if(r._e===t)return!1;throw new Error("Provider already in use by another editor")}return r._e=t,e.class=r.class,t.listeners.trigger("_layerAdd",{layer:e}),i[yr(r)]=e,t.layers.push(e),mr("add",r,t),!0}}return!1}getLayers(e){const{layers:t}=this._i();return e?t[e]:t.slice()}removeLayer(e){if(e){const t=this._i(),{layerMap:i,layers:r}=t;let o=e.getProvider();const s=yr(o);if("FeatureProvider"==o.__type&&o.editable&&i[s])return delete i[s],r.splice(r.indexOf(e),1),t.listeners.trigger("_layerRemove",{layer:e}),mr("remove",o,t),delete o._e,!0}return!1}addObserver(e,t){this._i().observers.addObserver(e,t,arguments[2])}get(e){return this._i().observers.get(e)}removeObserver(e,t){this._i().observers.removeObserver(e,t,arguments[2])}destroy(){const e=this;let t=e._i();e.getLayers().forEach((t=>e.removeLayer(t))),e.active(!1),t.destroy();for(let t in e)delete e[t];return e.__proto__={},null}setZoomLevel(e){this._i().display.setZoomlevel(e)}getZoomLevel(){return this._i().display.getZoomlevel()}pixelToGeo(e){const t=this._i().map.getGeoCoord(e);return t?new u(t[0],t[1]):null}geoToPixel(e){const t=this._i().map.getPixelCoord(e);return t?new A(t[0],t[1]):null}revert(){const e=this._i();let t=e.observers.get("history.current");for(;t--;)e.objects.history.recoverViewport(-1,!0);vr(e)}getDrawingBoard(){const e=this._i();return e._db=e._db||new zt(e)}getZoneSelector(){return this.getRangeSelector()}getRangeSelector(){const e=this._i();return e._rngSel=e._rngSel||new ti(e)}getOverlay(){return this._i().objects.overlay.layer}undo(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)}redo(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)}submit(e){let t,i=!1;const r=[],o=(e=e||{}).ignoreEventBlock;let s=e.layer;const n=e.onError,a=e.onSuccess,l=e.transactionId,c=this._i();if("function"==typeof o)throw new Error("Invalid parameter!");if(o||!c.isCommitInProcess){s=s instanceof Array?s:[s];for(const e in s){const t=s[e];t&&t instanceof p&&"MARKER"==t.type&&(t.base&&r.push(t.base),t.delta&&r.push(t.delta),t.src&&r.push(t.src))}t=c.objects.history.getChanges();for(const e in t)r.length>0&&r.indexOf(e)<0?delete t[e]:i=!0;if(i)return c.listeners.trigger("_beforeSubmit"),((e,t,i,r,o)=>{e.isCommitInProcess||(e.objects.selection.clearSelected(),e.observers.change("ready",e.isCommitInProcess),e.isCommitInProcess=!0,new ur(e).submit(t,(t=>{e.isCommitInProcess=!1,i.call(null,t)}),(t=>{e.isCommitInProcess=!1,r.call(null,t)}),o))})(c,t,(function(e){vr(c),c.listeners.trigger("_afterSubmit"),a&&a({permanentIDMap:e})}),(function(e){c.listeners.trigger("_afterSubmit"),n&&n(e)}),l),!0}return!1}info(){const t=[],i=this._i().objects.history.getChanges();for(const r in i)for(const o in i[r])t[t.length]=e.clone(i[r][o]);return t}export(){const e=this._i();return JSON.stringify(e.objects.history.getChanges())}import(e){const t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)}toGeoJSONCoordinates(e){if(Array.isArray(e)&&"number"!=typeof e[0]){let t=[];for(let i of e)t.push(this.toGeoJSONCoordinates(i));return t}return this._i().map.getGeoCoord(e)}}const Sr={dragPlane:"XY"};class Lr extends kt{behavior(e,t){let i=pe.private(this,"b")||Object.assign({},Sr);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const r={};r[e]=t,e=r}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}}Lr.prototype.class="MARKER";class br extends Lr{constructor(e,t){super(e,t)}coord(e){return super.coord(e)}getBBox(){const e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]}getLink(){const e=Ke.getRoutingData(this);let t;if(e.link){const i=Ke.getRoutingProvider(this);t=i&&i.search(e.link)}return t||null}}class Er extends br{constructor(e,t){super(e,t)}createRoutingPoint(){const e=this;Ke.getRoutingData(e).link||(Ke.connect(e),Ke.getRoutingData(e).link&&Ke.markAsModified(e))}removeRoutingPoint(){const e=this;Ke.getRoutingData(e).link&&(Ke.disconnect(e),Ke.markAsModified(e))}prop(t,i){const r=this,o=arguments.length,s=r.getProvider().getFeatureProperties(r);let n=!1;if(!o||1==o&&"string"==typeof t)return null!=(t=t?s[t]:s)&&"object"==typeof t?e.extend(!0,new t.constructor,t):t;if(2==o){const e={};e[t]=arguments[1],t=e}for(const e in t){const i=t[e],o="object"==typeof i,a=s[e];(o&&JSON.stringify(i)!=JSON.stringify(a)||!o&&a!==i)&&(n||(r._e().objects.history.origin(r),n=!0),s[e]=i)}Ke.getRoutingData(r).link?Ke.connect(r,null):Ke.disconnect(r),n&&(r._e().setStyle(r),Ke.markAsModified(r))}}Er.prototype.class="PLACE";class xr extends br{prop(t,i){const r=this;let o=!1;const s=arguments.length,n=r.getProvider().getFeatureProperties(r);if(!s||1==s&&"string"==typeof t)return null!=(t=t?n[t]:n)&&"object"==typeof t?e.extend(!0,new t.constructor,t):t;if(2==s){const e={};e[t]=arguments[1],t=e}for(const e in t){const i=t[e],s="object"==typeof i,a=n[e];(s&&JSON.stringify(i)!=JSON.stringify(a)||!s&&a!==i)&&(o||(r._e().objects.history.origin(r),o=!0),n[e]=i)}Ke.connect(r,null),o&&(r._e().setStyle(r),Ke.markAsModified(r))}}var kr;xr.prototype.class="ADDRESS",function(e){e.CROSSING="CROSSING",e.CROSSING_CANDIDATE="CROSSING_CANDIDATE"}(kr||(kr={}));const Cr="#FFFFFF",Pr="#FF0000",Ir={zIndex:0,type:"Line",stroke:Pr,strokeWidth:22,strokeLinecap:"round",opacity:.5},Rr={zIndex:1,type:"Line",stroke:Cr,strokeWidth:18,strokeLinecap:"round",opacity:.8},Or={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},wr={zIndex:3,type:"Circle",stroke:Pr,strokeWidth:1,opacity:.5,radius:12,fill:Pr},Nr={zIndex:4,type:"Circle",stroke:Cr,strokeWidth:2,opacity:1,radius:10,fill:Cr},Fr={zIndex:5,type:"Circle",stroke:Cr,radius:3,fill:Cr};let Mr,Tr;function jr(e,t){const i=e.coord();for(let e=0;e<i.length;e++)if(t[0]==i[e][0]&&t[1]==i[e][1])return e;return w(i,t)}class Br{constructor(e,t,i,r,o){this.type="Feature";const{iEditor:s}=e,n=o||r,a=[(n[0]-r[0])/2+r[0],(n[1]-r[1])/2+r[1]],l=s.map.getPixelCoord(a);this._={iEditor:s,xTester:e,link:t,candidate:i,searchPnt:r,foundPnt:o},this.x=l[0],this.y=l[1];const c=!!o;o=o||r;const d=s.display.geoToPixel(r[0],r[1]),h=s.display.geoToPixel(o[0],o[1]);this.distance=z([d.x,d.y],[h.x,h.y]),this.class=c?kr.CROSSING_CANDIDATE:kr.CROSSING,this.type="Feature",this.geometry=c?{type:"LineString",coordinates:[r,o]}:{type:"Point",coordinates:a}}getLinkIndex(){let e=this._;return jr(e.link,e.searchPnt)}getCandidateIndex(){let e=this._;return jr(e.candidate,e.foundPnt||e.searchPnt)}getRelatedLink(){return this._.candidate}connect(){const e=this.getRelatedLink(),t=this._,{iEditor:i,xTester:r}=t,o=this.getLink();if(!e.id||!o.id||e.editState("removed")||e.editState("modified")>r.createTS||o.editState("removed")||o.editState("modified")>r.createTS)return!1;const s=this.class==kr.CROSSING_CANDIDATE,n=this.getCandidateIndex(),a=(t.foundPnt||t.searchPnt).slice(),l=[];let c,d;if(s||(d=At.addShp(o,i.map.clipGeoCoord(a),null,!0)),c=s?this.getLinkIndex():d,!1!==this.getLinkIndex()){s&&o.getConnectedLinks(c).forEach((e=>{At.markAsModified(e,!1,!1)})),(At.connectShpToLink(o,c,e,i.map.clipGeoCoord(a),"number"==typeof n?n:Mr).splittedInto||[]).forEach((e=>{null!=e&&l.push(e)}))}this.hide();for(const e in this)"type"!==e&&(this[e]=Mr);return r.getCrossings({links:l,croLink:o})}show(){const e=this,t=e._,{iEditor:i,xTester:r}=t,o=i.objects.overlay,s=t.foundPnt||t.searchPnt,n=t.set=t.set||((t,s,n,a)=>{const l=r.getStyle(),c=i.getStyle(n)[0].stroke,d=i.getStyle(a)[0].stroke,h=e=>o.addPath([t,s],e),p=(e,t)=>o.addCircle(e,t),g=t=>i.listeners.trigger(t,e),u=i.getStyleProperty(n,"altitude");if(c&&d){const e=[h(Object.assign(Object.assign(Object.assign({},Ir),l.connector1),{altitude:u})),h(Object.assign(Object.assign(Object.assign({},Rr),l.connector2),{altitude:u})),h(Object.assign(Object.assign(Object.assign({},Or),l.connector3),{altitude:u})),p(t,Object.assign(Object.assign(Object.assign({},wr),l.search1),{altitude:u})),p(t,Object.assign(Object.assign(Object.assign(Object.assign({},Nr),{fill:c}),l.search2),{altitude:u})),p(s,Object.assign(Object.assign(Object.assign(Object.assign({},Fr),{fill:d,stroke:d}),l.found),{altitude:u}))];return e.forEach((e=>e.pointerup=g)),e}})(t.searchPnt,s,this.getLink(),this.getRelatedLink());i.objects.overlay.showFeature(n)}hide(){var e;const t=this._;t&&(null===(e=t.set)||void 0===e||e.forEach((e=>e._provider.removeFeature(e))),t.set=null)}getLink(){return this._.link}getConnectedLinks(){return this.class==kr.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]}}const Dr="CROSSING",Gr=Dr+"_CANDIDATE";class zr{constructor(e,t){this.foundCrossings=[],this.simpleCrossings=[],this.iEditor=e,this.setRelatedLink(t)}clear(){const{foundCrossings:e,simpleCrossings:t}=this;t.forEach((e=>{e.hide&&e.hide()})),e.length=0,t.length=0,this.createTS=0}checkRealCrossing(e,t){let i=[];const r=e._e().getStyleProperty(e,"altitude")?void 0:0,o=(e,t)=>{const i=[],r="number"==typeof t;for(let o of e){let e=r?t:o[2]||0;i[i.length]=[o[0],o[1],e]}return i},s=o(e.geometry.coordinates,r),n=(t,i)=>{let n=!1;const a=[],l=function(e,t){const i=[];for(let r=0;r<e.length-1;r++)for(let o=0;o<t.length-1;o++){const s=N(e[r],e[r+1],t[o],t[o+1]);s.intersects&&s.onSegment&&i.push({point:s.p0,s1:r+1,s2:o+1})}return i}(s,o(t.geometry.coordinates,r));for(var c=0,d=0,h=l.length;c<h-1;d=++c){const e=l[c],{point:t}=e;let i;for(;++d<h;){i=l[d];const r=i.point;t[0]==r[0]&&t[1]==r[1]&&Math.abs(i.s1-e.s1)<=1&&Math.abs(i.s2-e.s2)<=1&&(l.splice(d--,1),h--)}}for(c=0;c<l.length;c++){const{point:o}=l[c];n=!1;for(let e,s=0;s<i.length;s++)if(e=i[s],e.link.id==t.id&&At.isIntersection(this.iEditor,o,e.link.coord()[e.index],!r)){n=!0;break}n||a.push(new Br(this,e,t,o))}return a};if(!e.editState("removed")){const r=e.getConnectedLinks(0,!0).concat(e.getConnectedLinks(s.length-1,!0));t.forEach((e=>{i=i.concat(n(e,r))}))}return i}getNearestLineCandidate(e,t,i,r){if(r===Tr){r=[e.id];const i=e.getConnectedLinks(t,!0);for(const e in i)r.push(i[e].link.id)}const o=e.coord(),s=this.iEditor.objects.getNearestLine(o[t],i,{ignore:e=>-1!=r.indexOf(e.id),maxDistance:this.maxDistance});if(s){if(((e,t)=>{for(const i in e)if(-1!=t.indexOf(e[i].link.id))return!0;return!1})(s.line.getConnectedLinks(s.shpIndex,!0),r))return r.push(s.line.id),this.getNearestLineCandidate(e,t,i,r)}return s}calculateCrossings(e,t){let i,o=[];return this.createTS=+new Date,(Array.isArray(e)?e:[e]).forEach((e=>{if(!(e.editState("removed")||t&&t!=Dr&&t!=Gr)){const s=r.extendBBox(e.getBBox(),this.maxDistance),n=this.iEditor.objects.getInBBox(s,e.getProvider()),a=n.indexOf(e);-1!=a&&n.splice(a,1),t!=Gr&&(o=o.concat(this.checkRealCrossing(e,n))),t!=Dr&&e.coord().forEach(((t,r)=>{(i=this.getNearestLineCandidate(e,r,n))&&i.distance>.001&&o.push(new Br(this,e,i.line,t,i.point))}))}})),o}getRelatedLink(){return this.linkOrig}getCrossings(e){const t=this;return e=e||{},t.setRelatedLink(Tr),e.links?e.croLink&&e.links.length&&(t.relatedLink=t.relatedLink.concat(e.links)):(t.searchType==e.class&&t.maxDistance==e.maxDistance||(t.createTS=0),t.cStyles=e.styles||{},t.searchType=e.class),t.maxDistance=e.maxDistance||t.iEditor._config.snapTolerance||3,(!t.createTS||t.linkOrig.editState("modified")>t.createTS||e.links)&&(t.clear(),t.foundCrossings=t.calculateCrossings(t.relatedLink,t.searchType)),t.getSimplifiedCrossings()}getSimplifiedCrossings(){this.simpleCrossings.length=0;for(let e of this.foundCrossings)this.simpleCrossings.push(e);return this.simpleCrossings}setRelatedLink(e){e&&(this.linkOrig=e,this.relatedLink=[e])}getStyle(){return this.cStyles}}const Kr=e=>e.getProvider().readPedestrianOnly(e),Hr=e=>e.getProvider().readDirection(e),Vr=(e,t,i,r)=>{const o=Hr(i);return i.getZLevels()[r]===e.getZLevels()[t]&&("BOTH"==o||(0==r?"START_TO_END":"END_TO_START")==o)},Yr="TURN_RESTRICTION_";class Zr{constructor(e,t,i,o,s,n){const a=e.objects.overlay,l=0==s?1:o.coord().length-2,c=o.coord(),d=c[s].slice(),h=c[l].slice();At.ignoreZ(t)&&(d[2]=0,h[2]=0);const p=O(d,h,8e-5);let g=((e,t,i,r)=>{const o=((e,t,i,r)=>e.getProvider().readTurnRestriction({link:e,index:t},{link:i,index:r}))(e,t,i,r);return Vr(e,t,i,r)?o?"FORBIDDEN":Kr(i)?"PEDESTRIAN":"ALLOWED":"ONEWAY"})(t,i,o,s);const u=a.addPath([p,d,n],null,{type:Yr+"LINE",sign:Yr+g}),A=a.addImage(p,null,{type:Yr+g,rotation:r.calcBearing(d,p)-90});this.sign=A,this.line=u,this.overlay=a,this.to=o,this.from=t,At.showDirection(o),a.remove(u),A.pointerenter=()=>{a.addFeature(u)},A.pointerleave=()=>{a.remove(u)},A.pointerup=()=>{Vr(t,i,o,s)&&!Kr(o)&&(e.objects.history.batch((()=>{((e,t,i,r,o)=>{t.getProvider().writeTurnRestriction(e,{index:i,link:t},{index:o,link:r})})("ALLOWED"==g,t,i,o,s)})),g="ALLOWED"==g?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(A.properties.type=Yr+g,u.properties.sign=A.properties.type,e.setStyle(A),e.setStyle(u)))}}hide(){At.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null}}var Ur;!function(e){e.BOTH="BOTH",e.FROM_RN="START_TO_END",e.TO_RN="END_TO_START"}(Ur||(Ur={}));class Wr{constructor(e,t){const i=e._e();this._overlay=i.objects.overlay,this._trs=[];const r=()=>{this.hide(),i.listeners.remove("_clearOverlay",r)};i.listeners.add("_clearOverlay",r),this._l=e,this._i=t,this.show()}_hideOrigin(){this._origin&&this._overlay.remove(this._origin),this._origin=null}_showOrigin(e,t){const i=e.coord(),o=0==t?1:i.length-2;let s=i[t],n=i[o];At.ignoreZ(e)&&(s=[s[0],s[1],0],n=[n[0],n[1],0]);const a={geometry:{coordinates:O(s,n,1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:r.calcBearing(s,n)-90}};this._origin=this._overlay.addFeature(a)}show(){const e=this._l,t=this._i,i=Hr(e),r=0==t?Ur.FROM_RN:Ur.TO_RN;if(i!=Ur.BOTH&&r==i||Kr(e))return;const o=e.getConnectedLinks(t,!0);o.length&&this._showOrigin(e,t),this._trs=o.map((i=>new Zr(e._e(),e,t,i.link,i.index,this._origin.geometry.coordinates)))}hide(){const e=this._trs;for(const t in e)e[t].hide(),e[t]=null;e.length=0,this._hideOrigin()}isActive(){return this._trs.length>0}}const Qr="NAVLINK_DIRECTION_HINT_",Xr=Qr+"A",Jr=Qr+"B",qr=Qr+"1WAY",$r=Qr+"2WAY",eo=Qr+"BLOCKED";class to{constructor(e,t,i,o){const s=t.coord(),n="END_TO_START"==i?180:0,a=[];o||a.push(e.addPoint(s[0].slice(),{type:Xr}),e.addPoint(s[s.length-1].slice(),{type:Jr}));for(let t=0;t<s.length-1;t++){const o=s[t],l=s[t+1],c={type:"BLOCKED"==i?eo:"BOTH"==i?$r:qr};"BLOCKED"!=i&&(c.bearing=n+r.calcBearing(o,l)-90),a.push(e.addPoint(B(o,l,.5),c))}this.overlay=e,this.points=a}destroy(){this.overlay.remove(this.points),this.points=null}}let io;const ro=e=>{throw new Error(e)},oo={snapCoordinates:!0};class so extends kt{constructor(){super(...arguments),this.setGeoFence=e=>{(isNaN(e)||e<0)&&ro("Geofence radius should be a positive Number"),this._e()._config.geoFence=+e}}coord(e){return super.coord(e)}checkCrossings(e){const t=this,i=At.private(t),r=i.xt||new zr(t._e(),t);return i.xt=r,r.getCrossings(e)}showDirectionHint(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;const i=At.private(this),r=i.dh;r&&r.destroy(),i.dh=e&&new to(this._e().objects.overlay,this,e,t)}addShape(e,t){let i=!1;const r=this,o=this._e().map.getGeoCoord(e);return o?!1!==(i=At.addShp(r,o,t,io,!0))&&At.markAsModified(r):ro("Invalid coordinate"),i}behavior(e,t){let i=At.private(this,"b")||Object.assign({},oo);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];i=Object.assign(Object.assign({},i),e);break;case 2:i[e]=t}this.__.b=i}getConnectedLinks(e,t=!1){const i=this,r=i._e(),o=i.coord(),s=o[e],n=[];let a,l;const c=0==e||e==o.length-1,d=At.ignoreZ(i);if(c)for(let o of r.objects.getInBBox(i.bbox,i.getProvider()))o.id!=i.id&&"NAVLINK"==o.class&&(a=o.coord(),l=a.length-1,null!=(e=At.isIntersection(r,a[0],s,d)?0:At.isIntersection(r,a[l],s,d)?l:null)&&n.push(t?{index:e,link:o}:o));return n}getZLevels(e){let t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)}getSelectedShapes(){const e=At.private(this,"selectedShapes"),t=this.geometry.coordinates,i=[];for(let r=0;r<t.length;r++)i[r]=!!e[r];return i}setSelectedShapes(e){const t=this,i=At.private(t,"selectedShapes"),r=t.geometry.coordinates;for(let t=0;t<r.length;t++)i[t]=Boolean(e[t]);At.refreshGeometry(t)}setZLevels(e){const t=this,i=t.getZLevels(),r=t._e().objects.history,o=t.geometry.coordinates.length;e instanceof Array||ro("Invalid 'zlevel' argument given, no array"),e.length!==o&&ro("Given 'zlevel' argument is of an invalid size, a length of "+o+" is required!"),r.origin(t);let s=!1;for(let t,r=0;r<e.length;r++)t=0^e[r],t!=i[r]&&(e[r]=t,s=!0);s&&(r.batch((()=>{t.getProvider().writeZLevels(t,e)})),At.refreshGeometry(this),At.markAsModified(this))}simplifyGeometry(e){return be.simplifyGeometry(this,e)}editTurnRestrictions(e){const t=this,i=t.coord(),r=t._e(),o=0==e||e==i.length-1?[e]:e===io?[0,i.length-1]:[];r.listeners.trigger("_clearOverlay");const s=o.map((e=>new Wr(t,e)));return e===io?s:s[0]}prop(t,i){const r=this,o=r._e();let s=!1;const n=arguments.length,a=r.getProvider().getFeatureProperties(r);if(0==n||1==n&&"string"==typeof t){let i=t?a[t]:a;return"object"==typeof i?e.extend(!0,new i.constructor,i):i}let l=t;if(2==n){const e={};e[t]=arguments[1],l=e}for(const e in l){const t=l[e],i="object"==typeof t,n=a[e];(i&&JSON.stringify(t)!=JSON.stringify(n)||!i&&n!==t)&&(s||(o.objects.history.origin(r),s=!0),a[e]=t)}s&&(o.setStyle(r),r.editState("selected")&&At.showDirection(r),At.markAsModified(r))}}so.prototype.class="NAVLINK";class no extends kt{addShape(e,t,i){const r=this,o=r._e().map.getGeoCoord(e);let s=i;return o?((s=be.addCoord(r,o,s,t||0))&&(be.displayShapes(r),be.markAsModified(r)),s):((e=>{throw new Error(e)})("Invalid coordinate"),!1)}coord(e){return super.coord(e)}getSelectedShapes(){var e;const t=this,i=be.private(t,"selectedShapes"),r=be.getCoordinates(t),o=[];for(let t=0;t<r.length;t++){o[t]=[];for(let s=0;s<r[t].length;s++)o[t][s]=!!(null===(e=i[t])||void 0===e?void 0:e[s])}return be.isMultiLineString(t)?o:o[0]}setSelectedShapes(e){var t;const i=this,r=be.private(i,"selectedShapes"),o=be.getCoordinates(i);Array.isArray(null==e?void 0:e[0])||(e=[e]);for(let i=0;i<o.length;i++){r[i]||(r[i]=[]);for(let s=0;s<o[i].length;s++)r[i][s]=Boolean(null===(t=null==e?void 0:e[i])||void 0===t?void 0:t[s])}be.displayShapes(i)}simplifyGeometry(e){return be.simplifyGeometry(this,e)}}no.prototype.class="LINE";const ao={snapCoordinates:!0};class lo extends kt{addShape(e,t,i){let r=!1;const o=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=pe.getPoly(this,o)),!1!==(r=pe.addShp(this,o,0^t,0,i))&&pe.markAsModified(this)):(e=>{throw new Error(e)})("Invalid coordinate"),r}addHole(e){if(e){e=this._e().map.getPixelCoord(e);const t=this,i=pe.getPoly(t,e),r=pe.getCoords(t),o=r[i];let s=1/0;for(let i=0;i<o.length;i++){const r=pe.getMaxSpace(t,e,o[i]);r<s&&(s=r)}if(s!=1/0&&(s=Math.floor(.5*s),s>8)){const i=e[0],n=e[1],a=[[i-s,n+s],[i+s,n+s],[i+s,n-s],[i-s,n-s],[i-s,n+s]].map((e=>this._e().map.getGeoCoord(e)));return pe.isClockwise(o[0])||a.reverse(),o.push(a),pe._setCoords(t,r,!0),pe.markAsModified(t),!0}return!1}}behavior(e,t){let i=pe.private(this,"b")||Object.assign({},ao);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];i=Object.assign(Object.assign({},i),e);break;case 2:i[e]=t}this.__.b=i}coord(e){return super.coord(e)}}lo.prototype.class="AREA";const co={};let ho;co.NAVLINK="Navlink",co.AREA="Area",co.PLACE="Place",co.ADDRESS="Address",co.MARKER="Marker",co.LINE="Line";const po=(()=>{function t(t){const i=e=>{if("number"==typeof(e.x!=ho?e.x:e.longitude!=ho?e.longitude:e[0]))return e;const t=[];for(let r of e)t[t.length]=i(r);return t};function r(r,o,s){const n=this;"number"!=typeof r&&"string"!=typeof r?(s=o,o=r):n.id=r,n.type="Feature",n.class=t,n.properties=e.extend({"@ns:com:here:editor":new St},s||{}),n.geometry={type:"PLACE"==t||"ADDRESS"==t||"MARKER"==t?"Point":"AREA"==t?"MultiPolygon":"LineString",coordinates:i(o)}}return r.prototype=kt.prototype,r}const i={};for(const e in co)i[co[e]]=t(e);return i})(),go="here.xyz.maps.editor".split(".");let uo=o;for(let e=0;e<go.length-1;e++)uo=uo[go[e]]=uo[go[e]]||{};const Ao=uo[go.pop()]={Editor:_r,features:po,PixelCoordinate:function(e,t,i){this.x=e,this.y=t,this.z=i||0},GeoCoordinate:function(e,t,i){this.longitude=e,this.latitude=t,this.z=i||0}};o.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return so;case"PLACE":return Er;case"ADDRESS":return xr;case"AREA":return lo;case"MARKER":return Lr;case"LINE":return no;default:return this.Feature}};export{xr as Address,lo as Area,$ as AreaShape,Br as Crossing,St as DefaultEditorProperties,zt as DrawingBoard,Rt as DrawingShape,_r as Editor,Pt as EditorEvent,kt as Feature,no as Line,fe as LineShape,Lr as Marker,so as Navlink,tt as NavlinkShape,Er as Place,ti as RangeSelector,Ao as default,ue as defaultBehavior,po as features};
