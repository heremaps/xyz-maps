/*
 * @here/xyz-maps-editor
 * (c) 2019-2022 HERE
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core"),require("@here/xyz-maps-display")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core","@here/xyz-maps-display"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).here=e.here||{},e.here.xyz=e.here.xyz||{},e.here.xyz.maps=e.here.xyz.maps||{},e.here.xyz.maps.editor={}),e.here.xyz.maps.common,e.here.xyz.maps,e.here.xyz.maps)}(this,(function(e,t,i,o){"use strict";var r,s=(e,t,i)=>{e.editState("modified",Date.now());const o=e._e(),{history:r}=o.objects;if(t.isGeoMod&&!t.isMarking){t.isMarking=!0;const i=r.getHistoryFeature(e).geometry.coordinates;o.hooks.trigger("Coordinates.update",{feature:e,previousCoordinates:i},e.getProvider()),t.isGeoMod=!1,t.isMarking=!1}return(null==i||i)&&r.saveChanges(),e};!function(e){e[e.GEOMETRY=1]="GEOMETRY",e[e.REMOVE=2]="REMOVE"}(r||(r={}));const n={debug:!0,editRestrictions:function(){return!1},services:{reverseGeocoder:{}},geoFence:!1,snapTolerance:2,intersectionScale:5,routingPointPrecision:5,disconnectShapeDistance:3,keepFeatureSelection:"viewportChange",featureSelectionByDefault:!0,maxRoutingPointDistance:1e3,snapOnDrag:!0};let a;function l(e,t,i){e._e().listeners.trigger(t,e,i)}function c(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,isGeoMod:!1}),t?i[t]:i}function d(e){this.editState("hovered","pointerenter"==e.type),this._e().listeners.trigger(e,this)}const h={private:c,_evl:{pointerdown:function(e){const t=c(this);t.moved=!1;const i=this.geometry.coordinates,o=e.detail.display.geoToPixel(i[0],i[1]);t.x=o.x,t.y=o.y,t.button=e.button,t.z=i[2]||0,l(this,e,"pointerdown")},pointerup:function(e){const t=c(this),i=t.moved;!t.isSelected&&this._e()._config.featureSelectionByDefault?h._select(this):i&&h.markAsModified(this),l(this,e,i?"dragStop":"pointerup")},pointerenter:d,pointerleave:d},deHighlight:function(e){const t=c(e);t.selector&&(e.editState("selected",!1),e._e().objects.overlay.remove(t.selector),t.selector=null,t.pointerdown=a,t.pressmove=a)},_editable:function(e,t){const i=c(e);return t!=a&&(i.isEditable=!!t),h.deHighlight(e),i.isEditable},_select:function(e){const t=e._e();if(t.objects.selection.select(e)){const i=c(e),o=t.getStyleProperty(e,"altitude");if(e.editState("selected",!0),i.pressmove=(s,n,a)=>{if(i.isEditable&&i.isSelected&&!t._config.editRestrictions(e,r.GEOMETRY)){let r=[...e.geometry.coordinates];"number"==typeof o&&(r[2]=o),r=at(s.mapX,s.mapY,e,r,t),h._setCoords(e,r),l(e,s,i.moved?"dragMove":"dragStart"),i.moved=!0}},!i.selector){const r=t.getMaxZLayer(e);i.selector=t.objects.overlay.addCircle(e.coord(),a,{type:"MARKER_SELECTOR",parentType:"MARKER",MARKER:{properties:e.prop(),altitude:o,zLayer:r}})}}},_setCoords:function(e,t){e._e().objects.history.origin(e);const i=c(e,"selector");i&&i._provider.setFeatureCoordinates(i,t),e.getProvider().setFeatureCoordinates(e,t.slice()),c(e).isGeoMod=!0},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),h.deHighlight(e)},markAsModified:function(e,t){return s(e,c(e),t)}},p=Math,g=p.PI,u=p.pow,A=p.sqrt,f=(e,i,o=0,r=e.length,s=[])=>{let n=0,a=0;r--;for(let i=o+1;i<r;i++){const s=k(e[i],e[o],e[r],t.geotools.distance);s>n&&(a=i,n=s)}return n>i?(f(e,i,o,a,s),f(e,i,a,r+1,s)):(s.push(e[o]),r-o>0&&s.push(e[r])),s},y=t.geometry.intersectBBox,v=(e,i,o)=>{null==e[2]&&(e=[e[0],e[1],0]);const r=[i[0]-e[0],i[1]-e[1],(i[2]||0)-e[2]];return t.vec3.scale(r,t.vec3.normalize(r,r),o),t.vec3.add(r,r,e)},m=(e,t)=>{let i=999999,o=!1;for(let r=0;r<e.length-1;r++){const s=r+1,n=L(e[r],e[s],t);if(n){const e=P(n,t);e<i&&(i=e,o=r)}}return o},S=(e,i,o,r)=>{const s=t.vec3.sub([],i,e),n=t.vec3.sub([],r,o),a=t.vec3.sub([],e,o),l=t.vec3.dot(a,s),c=t.vec3.dot(a,n),d=t.vec3.dot(s,n),h=t.vec3.dot(s,s),p=t.vec3.dot(n,n),g=(c*d-l*p)/(h*p-d*d),u=(c+g*d)/p,A=t.vec3.add([],e,t.vec3.scale([],s,g)),f=t.vec3.add([],o,t.vec3.scale([],n,u)),y=0<=g&&g<=1&&0<=u&&u<=1,v=t.vec3.length(t.vec3.sub([],A,f));return{p0:A,p1:f,onSegment:y,intersects:v<=1e-7,distance:v}},_=(e,t,i,o,r)=>{const s=(o[1]-i[1])*(t[0]-e[0])-(o[0]-i[0])*(t[1]-e[1]);if(0!=s){const n=((o[0]-i[0])*(e[1]-i[1])-(o[1]-i[1])*(e[0]-i[0]))/s,a=((t[0]-e[0])*(e[1]-i[1])-(t[1]-e[1])*(e[0]-i[0]))/s,l=e[2]||0,c=t[2]||0;if(0<=n&&n<=1&&0<=a&&a<=1)return!r||[e[0]+n*(t[0]-e[0]),e[1]+n*(t[1]-e[1]),l+n*(c-l)]}return!1},L=(e,t,i)=>{if(e[0]==t[0]){let o=[e[0],i[1]];return!!I(e,t,o)&&o}if(e[1]==t[1]){let o=[i[0],e[1]];return!!I(e,t,o)&&o}const o=(t[1]-e[1])/(t[0]-e[0]),r=e[1]-o*e[0],s=-1/o,n=(i[1]-s*i[0]-r)/(o-s),a=[n,o*n+r];return!!I(e,t,a)&&a},b=(e,i,o,r)=>{const s=t.vec3.sub([],o,e),n=t.vec3.sub([],i,e),a=t.vec3.sub([],i,e);let l=t.vec3.dot(n,s)/t.vec3.dot(n,n);return r&&(l=Math.max(0,Math.min(1,l))),t.vec3.scale(a,a,l),t.vec3.add(a,a,e)},E=(e,i,o,r,s)=>{const n=t.vec3.sub([],i,r),a=t.vec3.dot(n,o)/t.vec3.dot(e,o);return a==1/0?null:t.vec3.sub([],i,t.vec3.scale([],e,a))},x=(e,t,i)=>{let o=e[2]||0,r=t[2]||0;return[(t[0]-e[0])*i+e[0],(t[1]-e[1])*i+e[1],o+(r-o)*i]},k=(e,t,i,o=P)=>{const r=e[0],s=e[1],n=t[0],a=t[1],l=i[0],c=i[1],d=l-n,h=c-a,p=((r-n)*d+(s-a)*h)/(d*d+h*h);let g;return g=p<0?[n,a]:p>1?[l,c]:[n+p*d,a+p*h],o([r,s],g)},C=(e,t)=>{let i=1/0;const o=t.length-1;for(let r=0;r<o;r++){const o=k(e,t[r],t[r+1]);o<i&&(i=o)}return i},P=(e,t)=>A(u(e[0]-t[0],2)+u(e[1]-t[1],2)),I=(e,t,i,o)=>{o=o||1e-7;const r=i[0]-e[0],s=i[1]-e[1];let n=t[0]-e[0],a=t[1]-e[1],l=(r*n+s*a)/(n*n+a*a);return l=l<0?0:l>1?1:l,n=r-l*n,a=s-l*a,l=n*n+a*a,l<o*o},R=e=>{let t=0;for(let i=0;i<e.length-1;i++)t+=P(e[i],e[i+1]);return t},O=(e,t,i=!0)=>{let o,r,s,n,a=0;for(let l=0;l<e.length-1;l++)if(r=e[l],s=e[l+1],a+=o=P(r,s),!i||a>=t)return n=(t-(a-o))/o,[(s[0]-r[0])*n+r[0],(s[1]-r[1])*n+r[1]];return s},w=(e,t,i)=>{const o=P(i,e),r=((e,t)=>{const i=t[0]-e[0],o=t[1]-e[1];return i||o?(180+180*p.atan2(o,i)/g)%360:0})(e,i);return[i[0]+o*p.cos((t+r)/180*g),i[1]+o*p.sin((t+r)/180*g)]};function F(e,t,i){for(let o=0,r=i.length-1;o<r;o++)if(_(e,t,i[o],i[o+1]))return 1}function N(e,t){for(let i=0,o=e.length-1;i<o;i++)if(F(e[i],e[i+1],t))return 1}function M(e,t){const i=e[0],o=e[1];let r=!1;for(let e=0,s=t.length-1;e<t.length;s=e++){const n=t[e][0],a=t[e][1],l=t[s][0],c=t[s][1];a>o!=c>o&&i<(l-n)*(o-a)/(c-a)+n&&(r=!r)}return r}function T(e,t,i){for(let o=0^i,r=e.length;o<r;o++)for(let i=0;i<e[o].length;i++)if(!M(e[o][i],t))return 0;return 1}let j;const B=(e,t,i,o=0,r=0,s)=>{const n=j.getCoords(e),a=n[r],l=a[o],c=l[i];if(!j.willSelfIntersect(l,t,i)){if(l[i]=t,i||(l[l.length-1]=t),!function(e,t,i){for(let o=0,r=t.length;o<r;o++)if(o!=i&&N(e,t[o]))return 1}(l,a,o)&&T(a,a[0],1)){const i=j.private(e,"shapePnts");if(s=s||j.getConnectedAreas(e,c),e.behavior("snapCoordinates"))for(let e=0;e<s.length;e++){let i=s[e];const{coordinates:o,polyIndex:r,lineIndex:n,coordIndex:a}=i,l=o[r],c=l[n];if(i.area.behavior("snapCoordinates")){c[a][0]=t[0],c[a][1]=t[1],a||(c[c.length-1]=t);if(!(!j.willSelfIntersect(c,t,a)&&T(l,l[0],1)))return!1}else o.splice(e,1)}for(let{area:e,coordinates:t}of s)j._setCoords(e,t,!1);j._setCoords(e,n,!1);for(let e of i){const{coordinates:i}=e.geometry;i[0]==c[0]&&i[1]==c[1]&&e.getProvider().setFeatureCoordinates(e,t.slice())}}return!0}};let D;class G extends i.Feature{constructor(e,t,i,o,s){j=s;const n=e._e(),a=n.display.getLayers().indexOf(n.getLayer(e))+1;super({type:"Feature",geometry:{type:"Point",coordinates:[t,i]},properties:{type:"AREA_SHAPE",poly:o[0],index:o[1],hole:o[2],AREA:{style:n.getStyle(e),zLayer:a?a+1:D}}},n.objects.overlay.layer.getProvider());const l=this,c=n.objects.overlay;function d(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,n.setStyle(this)}function h(e,t){n.listeners.trigger(e,l,t)}let p=!1;return this.__={area:e,pointerdown:function(){p=!1,l.__.cAreas=j.getConnectedAreas(e,l.geometry.coordinates)},pressmove:function(t,i,o,s,a){var d;const g=n._config;if(g.editRestrictions(e,r.GEOMETRY))return;p||(p=!0,j.hideShape(j.private(e,"midShapePnts"),c),null===(d=e.__.hk)||void 0===d||d.hide(),h(t,"dragStart"));const u=l.getIndex(),A=l.properties.poly,f=l.properties.hole;let y=n.map.getGeoCoord(t.mapX,t.mapY);e.behavior("snapCoordinates")&&(y=j.snapShape(l,y,g.snapTolerance)||y),B(e,y,u,f,A,l.__.cAreas)},pointerup:function(t){var i;if(p){if(e.behavior("snapCoordinates")){const e=l.__.cAreas;for(let{area:t}of e)j.markAsModified(t,!1)}j.markAsModified(e),null===(i=e.__.hk)||void 0===i||i.show(),j.addVShapes(e)}h(t,p?"dragStop":D)},pointerenter:d,pointerleave:d},l}getArea(){return this.__.area}remove(){return j.deleteShape(this.getArea(),this)}getIndex(){return this.properties.index}removeGeometry(){const e=this.getArea(),t=this.properties.poly,i=this.properties.hole,o=e.coord();o[t].splice(i,1),j._setCoords(e,o,!1),j.deHighlight(e),j._select(e),j.markAsModified(e)}}G.prototype.class="AREA_SHAPE";class z extends i.Feature{constructor(e,t,i,o,r){const s=e._e(),n=s.display.getLayers().indexOf(s.getLayer(e))+1,a=s.objects.overlay;super({type:"Feature",geometry:{type:"Point",coordinates:[t,i]},properties:{type:"AREA_VIRTUAL_SHAPE",poly:o[0],index:o[1],hole:o[2],AREA:{style:s.getStyle(e),zLayer:n?n+1:undefined}}},a.layer.getProvider());const l=this;let c;function d(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,s.setStyle(this)}l.__={area:e,pointerdown:function(){c=null},pressmove:function(t,i,o,s,n){const a=l.properties,d=a.index+1,h=a.poly,p=l.geometry.coordinates;if(!c){const t=r.private(e,"midShapePnts");for(let i,o,s,n=0;n<t.length;n++)i=t[n],o=i.geometry.coordinates,o[0]==p[0]&&o[1]==p[1]&&(s=i.properties,r.addShp(e,p.slice(),s.poly,s.hole,s.index+1));c=r.getShp(e,h,a.hole,d),c.__.pointerdown.apply(c)}c.__.pressmove.apply(c,arguments)},pointerup:function(t){if(c){const{poly:i,hole:o,index:s}=l.properties,n=r.getShp(e,i,o,s+1);n.__.pointerup.call(n,t)}},pointerenter:d,pointerleave:d}}getArea(){return this.__.area}}const K=t.geometry.centroid;let H;const V=e=>{const{geometry:t}=e;return K("Polygon"==t.type?t.coordinates:t.coordinates[0])};class U extends i.Feature{constructor(e,t,i){H=i;const o=e._e(),r=o.display.getLayers().indexOf(o.getLayer(e))+1,[s,n]=V(e);function a(e){let t;const i=this.properties["@ns:com:here:editor"];"pointerleave"==e.type?(delete i.hovered,t="default"):(i.hovered=!0,t="move"),document.body.style.cursor=t,o.setStyle(this)}super({type:"Feature",geometry:{type:"Point",coordinates:[s,n,t]},properties:{type:"AREA_HEIGHT_KNOB",offsetZ:0,AREA:{style:o.getStyle(e),zLayer:r?r+1:undefined}}},o.objects.overlay.layer.getProvider()),this.__={area:e,iEditor:o,overlay:o.objects.overlay,pointerdown:function(){this.properties.isMoved=!1,this.properties.offsetZ=this.__.iEditor.getStyleProperty(this,"offsetZ")||0},pressmove:function(e,t,i,o,r){const{area:s,iEditor:n}=this.__;let{offsetZ:a}=this.properties,l=n.map.translateZ(this.geometry.coordinates,a);l=at(e.mapX,e.mapY,this,l,n,{axis:[0,0,1]});let[,,c]=n.map.translateZ(l,-a);c=Math.max(0,c),this.update(c),s.getProvider().writeFeatureHeight(s,c),H._setCoords(s,s.geometry.coordinates),this.properties.isMoved=!0},pointerup:function(e){this.properties.isMoved&&H.markAsModified(this.__.area)},pointerenter:a,pointerleave:a}}update(e){const t=V(this.__.area);t[2]=e,this.__.overlay.setFeatureCoordinates(this,t)}remove(){this.__.overlay.remove(this)}hide(){this.__.overlay.hideFeature(this)}show(){this.update(this.geometry.coordinates[2]),this.__.overlay.showFeature(this)}getArea(){return this.__.area}}function Y(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,allowEdit:!0,shapePnts:[],midShapePnts:[]}),t?i[t]:i}function Z(e){const t=Y(e),i=e._e().objects.overlay;$.hideShape(t.shapePnts,i),$.hideShape(t.midShapePnts,i)}function J(e,t,i,o){const r=e._e().objects.overlay;for(let e=0;e<i.length;e++){let s=i[e];for(let i=0;i<s.length-1;i++){let n=o(s[i],s[i+1],i,e);r.addFeature(n),t.push(n)}}}function W(e){const t=Y(e,"midShapePnts"),i=$.getCoords(e);for(let o=0;o<i.length;o++)J(e,t,i[o],((t,i,r,s)=>new z(e,(t[0]+i[0])/2,(t[1]+i[1])/2,[o,r,s],$)))}function Q(e){if(Y(e,"isSelected")){Z(e),function(e){const t=Y(e,"shapePnts"),i=$.getCoords(e);for(let o=0;o<i.length;o++)J(e,t,i[o],((t,i,r,s)=>new G(e,t[0],t[1],[o,r,s],$)))}(e),W(e);const t=e.getProvider().readFeatureHeight(e);if($.isExtruded(e)&&"number"==typeof t){let i=e.__.hk;if(i)i.show();else{i=e.__.hk=new U(e,t,$);e._e().objects.overlay.addFeature(i)}i.update(t)}}}function X(e){const t=this,i=Y(t);i.allowEdit&&!i.isSelected&&(t._e().listeners.trigger(e,t),t.editState("hovered","pointerenter"==e.type),t._e().setStyle(this))}function q(e){const t=this,i=Y(t);i.isSelected||this._e()._config.featureSelectionByDefault&&i.allowEdit&&$._select(t),t._e().listeners.trigger(e,t)}const $={private:Y,_evl:{pointerenter:X,pointerleave:X,dbltap:q,pointerup:q},deHighlight:function(e){var t;const i=Y(e);i.isSelected&&(Z(e),null===(t=e.__.hk)||void 0===t||t.remove(),e.__.hk=null,e.editState("hovered",!1),e.editState("selected",!1),e._e().setStyle(e),i.isSelected=!1)},_editable:function(e,t){const i=Y(e);t&&t!=i.allowEdit?document.body.style.cursor="pointer":t||t==i.allowEdit||($.deHighlight(e),document.body.style.cursor="default"),i.allowEdit=t},isExtruded(e){if("number"==typeof e._e().getStyleProperty(e,"extrude"))return!0},_select:function(e){const t=Y(e),i=e._e();t.isSelected||(i.objects.selection.select(e),i.dump(e,"info"),t.isSelected=!0,e.editState("selected",!0),i.setStyle(e),Q(e))},_setCoords:function(e,t,i){"number"==typeof t[0][0][0]&&(t=[t]);let o=t.length;for(;o--;){const e=t[o];let i=e.length;for(;i--;){const t=e[i];t[t.length-1]=t[0]}}e._e().objects.history.origin(e),"Polygon"==e.geometry.type&&(1==t.length?t=t[0]:e.geometry.type="MultiPolygon"),Y(e).isGeoMod=!0,e.getProvider().setFeatureCoordinates(e,t),i&&Q(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),$.deHighlight(e)},markAsModified:function(e,t){return s(e,Y(e),t)},deleteShape:function(e,t){const i=t.properties,o=$.getCoords(e),r=o[i.poly][i.hole];return!(r.length<=4)&&(r.splice(t.getIndex(),1),$._setCoords(e,o),$.deHighlight(e),$._select(e),$.markAsModified(e),!0)},getCoords:e=>{let t=e.coord();return"Polygon"==e.geometry.type?[t]:t},isClockwise:e=>{let t=0;for(let i,o=0,r=e.length-1;o<r;o++)i=(o+1)%r,t+=e[o][0]*e[i][1],t-=e[i][0]*e[o][1];return t<0},getMaxSpace:function(e,t,i){const o=e._e(),r=t[0],s=t[1];let n=1e5;const a=[[r+n,s-n],[r-n,s+n],[r+n,s+n],[r-n,s-n]];n=1/0;for(let e=0,r=i.length-1;e<r;e++){const s=(e+1)%r,l=o.map.getPixelCoord(i[e]),c=o.map.getPixelCoord(i[s]);let d=0;for(;d<4;){const e=_(a[d++],a[d++],l,c,!0);if(e){const i=P(t,e);i<n&&(n=0^i)}}}return n},getPoly:function(e,t){let i=$.getCoords(e),o=1/0,r=null;for(let e,s=0;s<i.length;s++)e=C(t,i[s][0]),e<o&&(o=e,r=s);return r},addVShapes:W,getShp:function(e,t,i,o){const r=Y(e,"shapePnts");for(let e,s=0;s<r.length;s++)if(e=r[s].properties,e.poly==t&&e.index==o&&e.hole==i)return r[s]},addShp:function(e,t,i,o,r){const s=$.getCoords(e),n=s[i][o],a="number"==typeof r?r:m(n,t)+1;for(let e=0;e<n.length;e++)if(n[e][0]==t[0]&&n[e][1]==t[1])return!1;return n.splice(a,0,t),$._setCoords(e,s),Q(e),a},hideShape:function(e,t){Array.isArray(e)||(e=[e]);for(let i=0;i<e.length;i++)t.remove(e[i]);e.length=0},snapShape:(e,t,i)=>{const o=e.getArea(),{cAreas:r}=e.__,s=o._e(),n=i,a=o.getProvider().search({point:t,radius:n});for(let e of a)if(e.id!=o.id&&"AREA"==e.class)for(let i of $.getCoords(e)){const o=i[0],a=s.map.searchPointOnLine(o,t,n,undefined,n);if(a&&!r.find((({area:t})=>t==e)))return a.point}},willSelfIntersect:(e,t,i)=>{let o=0==i?e.length-2:i-1,r=i+1;for(let s,n=0,a=e.length-1;n<a;n++){if(s=n+1,r==a){if(n&&n<o&&_(t,e[r],e[n],e[n+1]))return!0}else if(n!=r&&(s%=a,i!=s&&n!=i&&_(t,e[r],e[n],e[s])))return!0;if(n>i){if(s%=a,s!=o&&n!=o&&_(e[o],t,e[n],e[s]))return!0}else if(s<o&&n!=i&&_(e[o],t,e[n],e[s]))return!0}return!1},validateGeometry:e=>{for(let t=1;t<e.length-1;t+=1)if($.willSelfIntersect(e,e[t],t))return!1;return!0},getConnectedAreas:(e,t)=>{let i=[];const o=e._e(),r=o.getLayer(e),s=e=>Math.round(1e9*e),n=s(t[0]),a=s(t[1]),l=o.objects.getInBBox([t[0],t[1],t[0],t[1]],r);let c=l.length;for(;c--;){const t=l[c],o=$.getCoords(t);let r=o.length;for(;r--;){let l=o[r].length;for(;l--;){const c=o[r][l];let d=c.length-1;for(;d--;)s(c[d][0])==n&&s(c[d][1])==a&&t!=e&&i.push({area:t,polyIndex:r,lineIndex:l,coordIndex:d,coordinates:o})}}}return i}};let ee;const te={dragPlane:"XY"},ie="@ns:com:here:editor";class oe extends i.Feature{constructor(e,t,i,o,r,s){ee=s;const n=e._e().getResolvedStyle(e);super({type:"Feature",properties:{lineStringIndex:i,index:o,LINE:{properties:e.prop(),style:n,zLayer:r}},geometry:{type:"Point",coordinates:t}}),this._l=e,this.properties[ie]={selected:this.isSelected()}}behavior(e,t){let i=((e,t)=>{const i=e.__||(e.__={b:Object.assign({},te)});return t?i[t]:i})(this,"b");switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const o={};o[e]=t,e=o}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}getLine(){return this._l}getLength(){return this._l.geometry.coordinates.length}getIndex(){return this.properties.index}getLineStringIndex(){return this.properties.lineStringIndex}remove(){const e=this.getLine();ee.removeCoord(e,this.properties.index,this.properties.lineStringIndex),ee.markAsModified(e)}select(){const e=this,t=e.getLine(),i=ee.private(t,"selectedShapes"),{lineStringIndex:o,index:r}=e.properties;i[o]||(i[o]=[]),i[o][r]=!0,e.properties[ie].selected=!0,ee.displayShapes(t)}unselect(){const e=this,t=e.getLine();t._e(),e.properties[ie].selected=!1;const i=ee.private(t,"selectedShapes"),{lineStringIndex:o,index:r}=e.properties;i[o]&&(i[o][r]=!1),ee.displayShapes(t)}isSelected(){var e;const t=ee.private(this.getLine(),"selectedShapes"),{lineStringIndex:i,index:o}=this.properties;return!!(null===(e=t[i])||void 0===e?void 0:e[o])}pointerdown(e){const t=this,i=t.properties,o=t.geometry.coordinates,r=e.detail.display,s=t.getLine();i.moved=!1;const n=r.geoToPixel(...o);i.x=n.x,i.y=n.y,i.button=e.button,i.z=o[2]||0,ee.removeShapes(s,"vShps","LINE_VIRTUAL_SHAPE"==t.class&&this),s._e().listeners.trigger(e,this,"pointerdown")}getSelectedShapes(e,t){var i;const o=this.getLine();let r=ee.private(o,"selectedShapes"),s=ee.private(o,"shps"),n=[];for(let o=0;o<r.length;o++)for(let a=0;a<(null===(i=r[o])||void 0===i?void 0:i.length);a++)r[o][a]&&(arguments.length&&t==o&&e==a||n.push(s[o][a]));return n}pressmove(e,i,o){const r=this,s=this.properties,{lineStringIndex:n,index:a}=s,l=r.getLine(),c=l._e(),d=ee.getCoordinates(l),h=d[n],p=!c.getStyleProperty(l,"altitude"),g=h[a][2],u=r.geometry.coordinates.slice(0,p?2:3);s.moved||(s.moved=!0,c.listeners.trigger(e,this,"dragStart"));let A=h[a]=at(e.mapX,e.mapY,r,u,c);if(p&&"number"==typeof g&&(A[2]=g),this.isSelected()){const e=c.display,i=e._g2w(u),o=e._g2w(A),r=t.vec3.sub(o,o,i);for(let i of this.getSelectedShapes(s.index,n)){const{properties:o}=i,s=e._g2w(i.geometry.coordinates);t.vec3.add(s,s,r);const n=e._w2g(s);d[o.lineStringIndex][o.index]=n,i.getProvider().setFeatureCoordinates(i,n)}}r.getProvider().setFeatureCoordinates(r,A.slice()),ee._setCoords(l,d)}pointerup(e){const t=this.getLine(),i=this.properties.moved;i&&ee.markAsModified(t),ee.displayShapes(t),t._e().listeners.trigger(e,this,i?"dragStop":undefined)}}let re,se;oe.prototype.class="LINE_SHAPE";class ne extends oe{constructor(e,t,i,o,r,s){re=s,super(e,t,i,o,r,s)}pointerdown(e){super.pointerdown(e)}pressmove(e,t,i){const{properties:o}=this,r=this,s=r.getLine();o.moved||(o.index++,re.addCoord(s,r.geometry.coordinates.slice(),o.index,o.lineStringIndex),re.removeShapes(s,"vShps",r)),super.pressmove(e,t,i)}pointerup(e){this.getProvider().removeFeature(this),super.pointerup(e)}}function ae(e,t){let i=e.__;return i||(i=e.__={isEditable:!0,highlight:!0,moved:!1,shps:[],vShps:[],selectedShapes:[],isGeoMod:!1}),t?i[t]:i}ne.prototype.class="LINE_VIRTUAL_SHAPE";const le=(e,t,i=!1)=>{t&&e.editState(t,i),e._e().setStyle(e,se)};function ce(e){ae(this,"isEditable")&&this._e().listeners.trigger(e,this)}const de={private:ae,_evl:{pointerenter:ce,pointerleave:ce,pointerup:function(e){const t=this,i=ae(t);i.isEditable&&(!i.isSelected&&t._e()._config.featureSelectionByDefault&&de._select(t),t._e().listeners.trigger(e,t))}},addCoord:(e,t,i,o)=>{var r;let s=de.getCoordinates(e,o);if(i==se){const e=m(s,t);if(!1===e)return e;i=e+1}return s.splice(i,0,t),de._setCoords(e,s,o),null===(r=ae(e,"selectedShapes")[o])||void 0===r||r.splice(i,0,se),i},removeCoord:(e,t,i)=>{var o;let r=de.getCoordinates(e,i);const s=r.length;let n;return s>2&&t>=0&&t<s&&(n=r.splice(t,1),null===(o=ae(e,"selectedShapes")[i])||void 0===o||o.splice(t,1),de._setCoords(e,r,i),de.displayShapes(e)),n},createShapes:(e,t,i,o,r)=>{const s=ae(e,o),n=s[t]=s[t]||[],a=e._e(),l=a.getMaxZLayer(e)-1,c=a.getStyleProperty(e,"altitude");for(let o=0;o<i.length;o++){let s=i[o].slice();"number"==typeof c&&(s[2]=c),n[o]=new r(e,s,t,o,l,de),a.objects.overlay.addFeature(n[o])}},createVShapes:(e,t=0,i)=>{const o=[];for(let e=1;e<i.length;e++)o.push(x(i[e-1],i[e],.5));de.createShapes(e,t,o,"vShps",ne)},displayShapes:e=>{if(ae(e,"isSelected")){const{geometry:t}=e;let i;i="LineString"==t.type?[t.coordinates]:t.coordinates,de.removeShapes(e,"shps"),de.removeShapes(e,"vShps");for(let t=0;t<i.length;t++)de.createShapes(e,t,i[t],"shps",oe),de.createVShapes(e,t,i[t])}},removeShapes:(e,t,i)=>{const o=ae(e,t);o.forEach((t=>{t!=i&&e._e().objects.overlay.remove(t)})),o.length=0},deHighlight:function(e){ae(e,"isSelected")&&(le(e,"selected",!1),de.removeShapes(e,"shps"),de.removeShapes(e,"vShps"))},_editable:function(e,t){const i=ae(e);return t!=se&&(i.isEditable=!!t),de.deHighlight(e),i.isEditable},simplifyGeometry(e,t){if("string"==typeof t){const o=t.endsWith("m");if(t=parseFloat(t),o){const[o,r,s,n]=e.getBBox(),a=r-(n-r)/2;t*=i.webMercator.earthCircumference(a)/i.webMercator.mapSizePixel(256,e._e().display.getZoomlevel())}}const{type:o}=e.geometry,r="LineString"==o,s=e.coord(),n=r?[s]:s;for(let e=0;e<n.length;e++)n[e]=f(n[e],t);e.coord(r?n[0]:n)},_select:function(e){e._e().objects.selection.select(e)&&(ae(e,"selectedShapes").length=0,le(e,"selected",!0),de.displayShapes(e))},isMultiLineString:e=>"MultiLineString"==e.geometry.type,getCoordinates(e,t){let i=e.coord();return de.isMultiLineString(e)||(i=[i]),t>=0?i[t]:i},_setCoords:function(e,t,i){e._e().objects.history.origin(e),ae(e).isGeoMod=!0;let o=t;de.isMultiLineString(e)?i>=0&&(o=e.coord(),o[i]=t):"number"!=typeof o[0][0]&&(o=o[0]),e.getProvider().setFeatureCoordinates(e,o)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),de.deHighlight(e),e.getProvider().removeFeature(e)},markAsModified:function(e,t){return s(e,ae(e),t)}};class he{constructor(e,t){this.offset=e,this.distance=t}}const pe=(e,t)=>{let i=0,o=0;for(let r=0;r<t.length-1;r++){const s=t[r],n=t[r+1];0!=I(t[r],t[r+1],e)&&(o=i+P(s,e)),i+=P(s,n)}return o/i},ge=(e,t)=>{let i=0;const o={lenPntToLine:1/0,lenTotal:0,shp:0};for(var r=0;r<e.length-1;r++){const n=e[r],a=e[r+1];var s=L(e[r],e[r+1],t);if(0!=s){const e=P(s,t);e<o.lenPntToLine&&(o.shp=r,o.lenPntToLine=e,o.lenTotal=i+P(n,s))}i+=P(n,a)}let n=0;const a={shp:-1,distancePoi:1/0,length:-1};for(r=0;r<e.length;r++){const i=P(e[r],t);r>0&&(n+=P(e[r],e[r-1])),i<a.distancePoi&&(a.shp=r,a.distancePoi=i,a.length=n)}return o.lenPntToLine<a.distancePoi?new he(o.lenTotal/i,o.lenPntToLine):new he(a.length/i,a.distancePoi)},ue=(e,t,i)=>{const[o,r,s]=t,[n,a,l]=i;return s+(l-s)*pe(e,[[o,r,0],[n,a,0]])},Ae=(e,t,i,o)=>{e.target=i||"display",e._e().listeners.trigger(t,e,o)};let fe,ye,ve;class me{constructor(e,t,i){ye=i,fe=t,this.location=e,this.iEditor=e._e()}updateDisplayedRoutingPoint(){const e=this.getLink(),t=this.coord();if(e){const i=e.coord(),o=R(i),r=0^ge(i,t).offset,s=O(i,o*r),n=O(i,o*r+(r<1?1:-1));if(s[0]!=n[0]||n[1]!=s[1]){const{rpFeature:e}=this;e&&(this.updateStreetLine(),this.iEditor.objects.overlay.setFeatureCoordinates(e,t.slice()))}}}createDisplayedRoutingPoint(e,t,i){const o=this,s=this.iEditor;o.rpFeature=o.iEditor.objects.overlay.addPoint(o.routingPoint.slice(),Object.assign({type:e,zLayer:t},i));const n=o.rpFeature;return n.pointerdown=function(){o.dragged=!1},n.pressmove=function(e,t,i){const{cLink:n,location:a,ignoreZ:l}=o;if(n&&!s._config.editRestrictions(a,r.GEOMETRY)){o.dragged||(o.dragged=!0,Ae(a,e,"routing","dragStart"));let{longitude:t,latitude:i}=s.display.pixelToGeo(e.mapX,e.mapY),r=s.objects.searchLine([t,i],n.getProvider(),{ignoreZ:l},a.geometry.coordinates);if(r||(r=s.objects.searchLine([t,i],[n],{ignoreZ:l},a.geometry.coordinates)),r){const{line:e,point:t}=r;e!=n&&(ye.defaults(n),ye.displayAsSelected(e,a.id,!0)),o.setRoutingPoint(e,t),o.updateDisplayedRoutingPoint()}}},n.pointerup=function(e){o.dragged&&(fe.setRoutingData(o.location),o.updateDisplayedRoutingPoint(),fe.markAsModified(o.location)),Ae(o.location,e,"routing",o.dragged?"dragStop":ve)},o.rpFeature}updateStreetLine(){const{iEditor:e,location:t}=this,{display:i}=e;if(this.streetLine){let o=t.coord();const r=fe.private(t),s=this.coord();if(r.isSelected){const t=e.getStyle(r.selector)[0]||{},n=t.radius||t.width/2,a=t.scaleByAltitude,l=i._g2w(o),c=i._scaleOffsetXYByAltitude(l,a);o=i._w2g(v(l,i._g2w(s),n*c))}e.objects.overlay.setFeatureCoordinates(this.streetLine,[s].concat([o]))}}getLink(){return this.cLink}coord(){return this.routingPoint}show(){const e=this,{cLink:t,location:i,iEditor:o}=e;if(t){const r=o.getStyleProperty(i,"altitude"),s=i.class;if(e.ignoreZ=!r,!e.rpFeature){let t=o.display.getLayers().indexOf(o.getLayer(e.getLink()))+1;t=t?t+1:ve;const n={parentType:s};n[s]={altitude:r},e.streetLine=o.objects.overlay.addPath([i.coord().slice(),this.routingPoint.slice()],ve,Object.assign(Object.assign({},n),{type:s+"_LINE",zLayer:t})),e.rpFeature=this.createDisplayedRoutingPoint(s+"_ROUTING_POINT",t,n)}e.updateDisplayedRoutingPoint(),ye.displayAsSelected(t,i.id)}return e.cLink}hide(){const e=this,t=e.rpFeature,i=e.iEditor;t&&(t.pointerdown=t.pressmove=t.pointerup=ve,i.objects.overlay.remove(t),i.objects.overlay.remove(e.streetLine),e.rpFeature=e.streetLine=null)}updateRoutingPoint(){const e=fe.getRoutingData(this.location),t=e.link,i=fe.getRoutingProvider(this.location),o=e.position;let r,s;if(this.cLink=this.routingPoint=null,t&&i&&(this.cLink=i.search(t)),this.cLink){if(o){s=this.cLink.coord();for(let e=0;e<s.length-1;e++)if(I(s[e],s[e+1],o,1e-6))return this.routingPoint=o,this.cLink;r=o}else r=this.location.coord();const e=this.iEditor.objects.getNearestLine(r,[this.cLink]);e&&(this.cLink=e.line,this.routingPoint=e.point)}return this.cLink}searchLink(){const{iEditor:e,location:t}=this,i=fe.getRoutingProvider(t);return i&&e.objects.getNearestLine(t.coord(),i,{maxDistance:e._config.maxRoutingPointDistance})}setRoutingPoint(e,t){if(this.routingPoint=this.cLink=null,e)this.cLink=e,this.routingPoint=t;else{const e=this.searchLink();e&&(this.cLink=e.line,this.routingPoint=e.point)}return this.cLink}clearRoutingPoint(){this.cLink=this.routingPoint=null,this.hide()}}let Se,_e;const Le=(e,t)=>{let i=e.__;return i||(i=e.__={isEditable:!0,allowEdit:!0,isGeoMod:!1,isHovered:!1,cLink:null,moved:!1}),t?i[t]:i};const be=e=>"PLACE"==e.class,Ee=e=>{const t=Le(e);return null==t._rp&&(t._rp=new me(e,Ie,Se)),t._rp};function xe(e,t){const i=!be(e),o=Ie.getRoutingData(e).link,r=Le(e);r.isHovered=t;const s=o||i;if(o||i){const t=Ee(e);(t.updateRoutingPoint()||t.setRoutingPoint())&&(r.cLink=t.show(),s&&Ie.setRoutingData(e))}t&&Ae(e,t)}function ke(e,t){const i=Le(e,"cLink");Le(e).isHovered=!t,i&&Se.defaults(i,e.id)&&Se.private(i,"isSelected")&&Se.displayAsSelected(i),t&&Ae(e,t),Ee(e).hide()}function Ce(e){const t=this,i=Le(t),o="pointerenter"==e.type;i.allowEdit&&(t.editState("hovered",o),i.isSelected||(o?xe(t,e):ke(t,e)))}function Pe(e,t,i,o,r){const s=this,n=Le(s),a=s._e();if(n.isSelected&&!a._config.editRestrictions(s,1)){n.moved||Ie.getRoutingData(s).link!=_e&&Ie.connect(s,null),Ae(s,e,"display",n.moved?"dragMove":"dragStart");let t=[...s.geometry.coordinates];a.getStyleProperty(s,"altitude")||(t[2]=0),t=at(e.mapX,e.mapY,s,t,a),Ie._setCoords(s,t),n.moved=!0,Ee(s).updateStreetLine()}}const Ie={private:Le,setLinkTools:function(e){Se=e},_evl:{pointerenter:Ce,pointerleave:Ce,dbltap:function(e){Ae(this,e)},pointerup:function(e){const t=Le(this),i=t.moved,o=this._e();t.allowEdit&&(t.isSelected||(o.dump(this),o._config.featureSelectionByDefault&&Ie._select(this)),i&&(Ee(this).show(),Ie.markAsModified(this)),Ae(this,e,"display",i?"dragStop":"pointerup"),t.moved=!1)},pointerdown:function(e){const t=Le(this);t.allowEdit&&(t.isSelected&&(t.moved=!1),Ae(this,e,"display","pointerdown"))}},deHighlight:function(e){const t=Le(e);return t.selector&&e._e().objects.overlay.remove(t.selector),t.selector=null,t.isSelected&&(ke(e),t.pressmove=null,t.isSelected=!1,e.editState("selected",!1),t.cLink&&Se.defaults(t.cLink,e.id)),e},_editable:function(e,t){const i=Le(e);t!=i.allowEdit&&(t||(Ie.deHighlight(e),i.isHovered&&(i.isHovered.type="mouseout",ke(e,i.isHovered))),i.allowEdit=t)},_select:function(e){e._e().objects.selection.select(e)&&(e.editState("selected",!0),Le(e).pressmove=Pe,Ie.highlight(e),xe(e))},_setCoords:function(e,t){return h._setCoords(e,t)},markAsRemoved:h.markAsRemoved,markAsModified:function(e,t){return s(e,Le(e),t)},_props:function(e,i){const o=arguments.length,r=e.getProvider().getFeatureProperties(e);if(o>1){if(2==o&&"string"==typeof i)return r[i];if(3==o){const e=i;(i={})[e]=arguments[2]}e._e().objects.history.origin(e),t.JSUtils.extend(r,i)}return r},highlight:function(e){const t=Le(e);if(!t.selector){const i={type:e.class+"_SELECTOR",parentType:e.class},o=e._e(),r=o.display.getLayers().indexOf(o.getLayer(e));i[e.class]={altitude:e._e().getStyleProperty(e,"altitude"),zLayer:r},t.selector=e._e().objects.overlay.addCircle(e.geometry.coordinates,_e,i)}},getRoutingProvider:e=>{const t=e._e(),i=e.getProvider().readRoutingProvider(e,t.layers.map((e=>e.getProvider())));return t.getProviderById(i)},getRoutingData:function(e){return e.getProvider().readRoutingPoint(e)},setRoutingData:function(e){const t=Ee(e),i=t.getLink(),o=t.coord(),r=Le(e);r.cLink=i;const s=Number("1e"+e._e()._config.routingPointPrecision),n=e=>Math.round(e*s)/s,a=o?[n(o[0]),n(o[1]),0|o[2]]:[],l=Ie.getRoutingData(e),c=l.position||[],d=i?i.id:null;l.link==d&&a[0]==n(c[0])&&a[1]==n(c[1])||(e._e().objects.history.batch((()=>{r.writeProp=!0,e.getProvider().writeRoutingPoint(e,i,o?a:o),delete r.writeProp})),Ie._setCoords(e,e.geometry.coordinates))},connect:function(e,t,i){const o=Le(e);if(o.writeProp)return;const r=Ee(e),s=r.getLink(),n=(Ie.getRoutingData(e).position||[]).slice();s&&Se.defaults(s),t?o.cLink=r.setRoutingPoint(t,i):(o.cLink=r.updateRoutingPoint())||!1===t||(o.cLink=r.setRoutingPoint()),(be(e)||o.cLink)&&Ie.setRoutingData(e),o.isSelected&&(o.cLink?xe(e):ke(e));const a=Ie.getRoutingData(e).position||[];s==o.cLink&&n[0]==a[0]&&n[1]==a[1]||Ie.markAsModified(e,!1)},disconnect:function(e){let t=Le(e);t.writeProp||(ke(e),Ee(e).clearRoutingPoint(),t.cLink=null,be(e)||Ee(e).setRoutingPoint(),Ie.setRoutingData(e),Ie.markAsModified(e,!1))},getRoutingPosition:function(e){const t=Ee(e);let i=t.coord();return i||(t.updateRoutingPoint(),i=t.coord()),i&&[i[0],i[1],i[2]||0]||_e}};class Re{constructor(e,t,i,o){}isPntInFence(){return!0}isHidden(){return!0}remove(){}}const Oe="@ns:com:here:editor";let we,Fe;const Ne=e=>e.__||(e.__={});function Me(e,t){Ne(this).line._e().listeners.trigger(e,this,t)}function Te(e){const t=this;const i=(n=Ne(t)).line,o=i._e();n._cls=n.cLinks.map((e=>e.link)),n.drg=!1;const r=this.geometry.coordinates,s=o.display.geoToPixel.apply(o.display,r);var n;(n=Ne(t)).x=s.x,n.y=s.y,n.z=r[2],o.dump(t),we.removeShapePnts(i,!0),o.listeners.trigger("_clearOverlay"),we.hideDirection(i),Fe=new Re(o,r[0],r[1]),Me.call(t,e,"pointerdown")}function je(e,i,o){const s=this,n=Ne(s),a=n.line,l=a._e(),c=l._config,d=we.ignoreZ(a),h=s.geometry.coordinates.slice(0,d?2:3);let p=at(e.mapX,e.mapY,s,h,l);if(d&&(p[2]=s.geometry.coordinates[2]||0),!c.editRestrictions(a,r.GEOMETRY))if(Fe.isPntInFence(p)){if(!Fe.isHidden()&&Fe.hide(),c.snapOnDrag&&a.behavior("snapCoordinates")&&(p=we.snapShape(s,p,d,c.snapTolerance)||p),we.moveShapeAtIndexTo(a,n.index,p),this.isSelected()){const e=l.display,i=e._g2w(h),o=e._g2w(p),r=t.vec3.sub(o,o,i);for(let i of((e,t)=>{const i=we.private(e,"selectedShapes"),o=we.private(e,"shps"),r=[];for(let e=0;e<i.length;e++)!i[e]||void 0!==t&&t==e||r.push(o[e]);return r})(a,n.index)){const o=e._g2w(i.geometry.coordinates);t.vec3.add(o,o,r);const s=e._w2g(o);we.moveShapeAtIndexTo(a,Ne(i).index,s)}}n.drg||(n.drg=!0,Me.call(s,e,"dragStart"))}else Fe.isHidden()&&Fe.show()}function Be(e){const t=Ne(this);let i=t.index;const o=t.drg;let r=!1;const s=t.line;let n=!1,a=!1;const l=t.cLinks;let c,d;t._cls=null,o&&(d=we.fixGeo(s,i),"boolean"==typeof d?n=!d:(n=d>=0,(a=i!=d)&&(i=d)),De(this)),we.showDirection(s),s.behavior("snapCoordinates")&&Fe.isHidden()&&!n&&o&&(c=((e,t)=>{let i=e.coord()[t];const o=we.ignoreZ(e),r=e.getConnectedLinks(t),s=e._e();let n,a;return r.push(e),n=s.objects.getNearestLine(i,e.getProvider(),{maxDistance:s._config.snapTolerance,ignore:e=>"NAVLINK"==e.class&&(-1!=r.indexOf(e)||!e.behavior("snapCoordinates")),ignoreZ:o}),n&&(a=n.point,a[2]||(a[2]=0),null===we.connectShpToLink(e,t,n=n.line,a,void 0,o)&&(n=null)),n})(s,i)),c||(o&&((!1===d?l:s.getConnectedLinks(i,!0)).forEach((e=>{const t=we.fixGeo(e.link,e.index);a="number"==typeof t||!t||a,we.markAsModified(e.link,!1,!1)})),r=!0),we.createAddShapePnts(s)),Fe&&Fe.remove(),t.drg=!1,(a||o)&&we.refreshGeometry(s),s._e().listeners.trigger(e,s.editState("removed")?this:we.private(s,"shps")[i],o?"dragStop":void 0),r&&we.markAsModified(s,!0,!1)}const De=e=>{var t;null===(t=Ne(e).cLinks)||void 0===t||t.forEach((e=>{we.defaults(e.link,null,!0)}))};function Ge(){const e=Ne(this);document.body.style.cursor="default",De(this),delete this.properties[Oe].hovered,e.line._e().setStyle(this)}function ze(){const e=Ne(this),i=e.line._e();document.body.style.cursor="move",e.cLinks.forEach((({link:e})=>{const o=i.getCustomStyle(e);let r;if(o?(r=t.JSUtils.extend(!0,[],o),r.__default=o):r=i.getStyle(e),Array.isArray(r)){for(let e=0;e<r.length;e++)r[e].opacity=.5;i.setStyle(e,r)}})),this.properties[Oe].hovered=!0,i.setStyle(this)}class Ke extends i.Feature{constructor(e,i,o,s){we=s;const n=e._e(),a=e.getConnectedLinks(o,!0),l=0==o||o==e.geometry.coordinates.length-1;super({type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{isNode:l,isConnected:!!a.length,NAVLINK:{properties:t.JSUtils.extend(!0,{},e.properties),style:n.getStyle(e)},parent:e,"@ns:com:here:editor":{selected:!!we.private(e,"selectedShapes")[o]}}},n.objects.overlay.layer.getProvider());const c=Ne(this);c.index=o,c.line=e,c.drg=!1,c.cLinks=a,c.dblclick=Me,c.pressmove=je,c.pointerdown=Te,c.pointerup=Be,n._config.editRestrictions(e,r.GEOMETRY)||(c.pointerenter=ze,c.pointerleave=Ge)}behavior(e,t){let i=we.private(this,"b")||Object.assign({},te);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const o={};o[e]=t,e=o}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}getLink(){return this.properties.parent}isNode(){return this.properties.isNode}isOverlapping(){return we.checkOverlapping(this.properties.parent,this.getIndex())}getIndex(){return Ne(this).index}editTurnRestrictions(){if(this.isNode())return this.getLink().editTurnRestrictions(this.getIndex())[0]}getConnectedLinks(){return this.getLink().getConnectedLinks(this.getIndex())}remove(){const e=this.getLink();e._e()._config.editRestrictions(e||this,r.REMOVE)||we.deleteShape(e,this)}disconnect(){const e=Ne(this),i=e.line._e();if(this.isNode()&&e.cLinks.length){const o=e.line,r=e.index,s=o.coord(),n=s[r],a=s[r+(r?-1:1)],l=t.geotools.calcBearing(n,a),c=i.map.movePoint(n,i._config.disconnectShapeDistance,l);i.hooks.trigger("Navlink.disconnect",{link:o,index:r},o.getProvider()),s[r][0]=c[0],s[r][1]=c[1],we._setCoords(o,s),we.fixGeo(o),we.refreshGeometry(o),we.markAsModified(o)}}select(){const e=this,t=e.getLink(),i=we.private(t,"selectedShapes"),{index:o}=Ne(e);i[o]=!0,e.properties[Oe].selected=!0,we.refreshGeometry(t)}unselect(){const e=this,t=e.getLink();e.properties[Oe].selected=!1;const i=we.private(t,"selectedShapes"),{index:o}=Ne(e);i[o]=!1,we.refreshGeometry(t)}splitLink(){let e;const t=this.getLink(),i=t._e();return this.isNode()||(e=i.objects.splitLinkAt({link:t,index:this.getIndex()}),e.length&&i.objects.history.saveChanges()),e}isSelected(){const e=we.private(this.getLink(),"selectedShapes"),{index:t}=Ne(this);return!!e[t]}}let He;Ke.prototype.class="NAVLINK_SHAPE";class Ve extends i.Feature{constructor(e,i,o,r){const s=e._e(),n=s.display;let a;super({type:"Feature",geometry:{type:"Point",coordinates:i.slice()},properties:{type:"NAVLINK_VIRTUAL_SHAPE",NAVLINK:{properties:t.JSUtils.extend(!0,{},e.properties),style:s.getStyle(e)},parent:e}},s.objects.overlay.layer.getProvider());const l=this;l.pointerdown=function(){const e=l.properties.parent,{coordinates:t}=l.geometry;l.moved=!1,r.hideDirection(e);const i=n.geoToPixel.apply(n,t);a=new Re(s,l.x=i.x,l.y=i.y,l.z=t[2])},l.pressmove=function(e,t,i,s,n){const c=l.properties.parent,d=l.geometry.coordinates.slice();if(a.isPntInFence(d)){a.isHidden()||a.hide();const e=r.private(c,"shps");if(!l.moved){r.addShp(c,d,o,!1,!0),r.removeShapePnts(c,!0,l.id),l.pointerenter=l.pointerleave=undefined,l.moved=!0;const t=e[o];t.x=l.x,t.y=l.y,t.z=l.z,t.__.pointerdown.apply(t,arguments)}const t=e[o];t.__.pressmove.apply(t,arguments)}else a.isHidden()&&a.show()},l.pointerup=function(e){const t=l.properties.parent,i=r.private(t);if(l.moved){const t=i.shps[o];t.__.pointerup.call(t,e),this.getProvider().removeFeature(this)}else i.isSelected&&r.showDirection(t)},s._config.editRestrictions(e,1)||(l.pointerenter=l.pointerleave=function(e){const t="pointerenter"==e.type;document.body.style.cursor=t?"move":"default",this.properties["@ns:com:here:editor"].hovered=t,s.setStyle(this)})}getLink(){return this.properties.parent}}class Ue{}const Ye=(e,t)=>{let i=e.__;return i||(i=e.__={isSelected:!1,isEditable:!0,allowEdit:!0,shps:[],vShps:[],selectedShapes:[],isHovered:null,_cPnt:null,arrows:null,prevBBox:null,isGeoMod:!1,dh:null,xt:null}),t?i[t]:i};function Ze(e,i){const o=arguments.length,r=e.getProvider().getFeatureProperties(e);if(o>1){if(2==o&&"string"==typeof i)return r[i];if(3==o){const e=i;(i={})[e]=arguments[2]}e._e().objects.history.origin(e),t.JSUtils.extend(r,i)}return r}function Je(e){const t=this,i=e.type;Ye(t,"allowEdit")&&t._e()._config.featureSelectionByDefault&&("dbltap"==i||"pointerup"==i)&&it._select(t),t._e().listeners.trigger(e,t)}function We(e,t,i){if(t)for(let i in t)e.editState(i,t[i]);e._e().setStyle(e,i?"default":He)}function Qe(e){const i=Ye(e);return it.getConnectedObjects(e,t.geotools.mergeBBoxes(i.prevBBox=i.prevBBox||e.bbox.slice(),e.bbox))}function Xe(e,t){Ye(e).isGeoMod=!0,e._e().objects.history.origin(e),e._provider.setFeatureCoordinates(e,t)}function qe(e,t){if(e._e().objects.overlay.remove(t),t.class){for(const e in t)"id"!=e&&"type"!=e&&"class"!=e&&"properties"!=e&&"geometry"!=e&&(t[e]=He);t.isDeleted=!0}}function $e(e,t){const i=e.__.ol;e.properties.isOverlapping=t,i!=(e.__.ol=t)&&e.getLink()._e().setStyle(e)}function et(e){e.listeners.trigger("featureUnselected",{featureUnselected:!0})}function tt(e){const t=this,i=Ye(t);i.allowEdit&&(document.body.style.cursor="default",Je.call(t,e),i.isSelected||(e=>{const t=it.getConnectedObjects(e);for(let e=0;e<t.length;e++)if(Ie.private(t[e],"isSelected"))return!0})(t)||We(t,{hovered:!1}),i.isHovered=null)}var it={private:Ye,_evl:{pointerenter:function(e){const t=this,i=Ye(t);i.allowEdit&&(document.body.style.cursor="Pointer",i.isHovered=e,Je.call(t,e),We(t,{hovered:!0}))},pointerleave:tt,dbltap:Je,pointerup:Je},deHighlight:function(e){return Ye(e,"isSelected")&&(We(e,{selected:!1,hovered:!1}),it.removeShapePnts(e),it.hideDirection(e)),e},_editable:function(e,t){const i=Ye(e);if(t!=i.allowEdit){if(!t){const t=i.isHovered;t&&(t.type="mouseout",tt.call(t.target,t)),it.deHighlight(e)}i.allowEdit=t}},_select:function(e){Ye(e,"isSelected")||(Ye(e,"selectedShapes").length=0,e._e().objects.selection.select(e),e._e().dump(e,"info"),it.refreshGeometry(e))},_setCoords:function(e,t){let i=t.length;for(;i--;)t[i][2]=t[i][2]||0;Qe(e),Xe(e,t),it.refreshGeometry(e)},markAsRemoved:function(e){e._e().hooks.trigger("Feature.remove",{feature:e},e.getProvider()),e.editState("removed",Date.now()),it.hideDirection(e),Qe(e).forEach((e=>{Ie.disconnect(e)})),it._editable(e,!1);const t=e.coord(),i=t[0],o=t[t.length-1];i[0]==o[0]&&i[1]==o[1]&&(t[0][0]+=1e-5,t[0][1]+=1e-5,Xe(e,t))},markAsModified:function(e,t=!0,i=!0){const o=e.editState("modified"),r=Ye(e);if(r.isGeoMod){const t=e.coord();Qe(e).forEach((i=>{const o=O(t,R(t)*ge(t,Ie.getRoutingPosition(i)).offset);Ie.connect(i,e,o)}))}return s(e,r,t),o||(We(e),!r.isSelected&&i&&it.defaults(e)),e},ignoreZ:e=>!e._e().getStyleProperty(e,"altitude"),_props:Ze,getConnectedObjects:function(e,i){const o=e._e();return o.objects.getInBBox(t.geotools.extendBBox(i||e.bbox,o._config.maxRoutingPointDistance)).filter((t=>{const i=t.class;if("PLACE"==i||"ADDRESS"==i)return t.getLink()==e}))},refreshGeometry:function(e){it.removeShapePnts(e),Ye(e,"isSelected")&&(it.displayAsSelected(e),it.showDirection(e),it.createShapes(e),it.createAddShapePnts(e))},checkOverlapping(e,t){const i=e.coord(),o=t==He,r=o?1:t;let s=o?i.length-1:r+1;const n=[];s==i.length&&s--;const a=e._e().objects.getInBBox(e.bbox,e.getProvider());let l,c=a.length;for(;c--;)if(l=a[c],l.id!=e.id&&"NAVLINK"==l.class)for(let e=r;e<s;e++)for(let t=0,o=l.coord();t<o.length;t++)if(i[e][0]==o[t][0]&&i[e][1]==o[t][1]){n.push(e);break}return o?n:!!n.pop()},createLinkShape:function(e,t,i){return e._e().objects.overlay.addFeature(new Ke(e,t,i,it))},createShapes:function(e){const t=Ye(e,"shps"),i=e.geometry.coordinates,o=i.length;if(!e.editState("removed")){const r=it.checkOverlapping(e);if(t.length)t.forEach(((t,i)=>{t.__.cLinks=e.getConnectedLinks(i,!0)}));else for(let s=0;s<o;s++){const o=it.createLinkShape(e,[...i[s]],s);$e(o,r.indexOf(s)>=0),t[s]=o}}},createAddShapePnts:function(e){const t=Ye(e,"vShps");if(!t.length&&!e.editState("removed")&&!e._e()._config.editRestrictions(e,r.GEOMETRY)){const i=e.geometry.coordinates;for(let o,r,s=1;s<i.length;s++)o=i[s-1],r=i[s],t.push(e._e().objects.overlay.addFeature(new Ve(e,x(o,r,.5),s,it)))}},removeShapePnts:function(e,t,i){function o(t){for(let o=0;o<t.length;o++)t[o].id!=i&&qe(e,t[o]);t.length=0}const r=Ye(e),s=r.vShps;return t||o(r.shps),(s.length||t)&&o(s),e},moveShapeAtIndexTo:function(e,t,i,o){const s=e.coord(),n=Ye(e,"shps");i=[...i];const[a,l,c]=i,d=s[t][0]!=a||s[t][1]!=l||(s[t][2]||0)!=(c||0);s[t][0]=a,s[t][1]=l,"number"==typeof c&&(s[t][2]=c),Qe(e),Xe(e,s),it.hideDirection(e);const h=n[t];return!o&&h&&(e._e().objects.overlay.setFeatureCoordinates(h,i),h.__.cLinks.forEach((t=>{let o=t.link;!e._e()._config.editRestrictions(o,r.GEOMETRY)&&it.moveShapeAtIndexTo(o,t.index,i)})),$e(h,it.checkOverlapping(e,t))),d},deleteShape:function(e,t,i){const o="number"==typeof t?t:t.getIndex(),r=e.coord();if(r.length>2){r.splice(o,1);const t=Ye(e),s=t.shps;s.length&&(qe(e,s[o]),s.splice(o,1),s.forEach((e=>{e.__.index-=Number(e.getIndex()>=o)})),Ye(e,"selectedShapes").splice(o,1)),Qe(e),Xe(e,r);const n=e.getZLevels();n.splice(o,1),e._e().objects.history.batch((()=>{e.getProvider().writeZLevels(e,n)})),i||it.markAsModified(e),t.isSelected&&it.refreshGeometry(e)}},showDirection:function(e){if(!e.editState("removed")){const i=(""+e.getProvider().readDirection(e)).toUpperCase();let o,r,s,n,a;if(it.hideDirection(e),"START_TO_END"==i?n=90:"END_TO_START"==i&&(n=-90),n!=He){const i=Ye(e).arrows=[];o=e.geometry.coordinates;for(let l=0;l<o.length-1;l++)r=o[l],s=o[l+1],a=90-t.geotools.calcBearing(r,s)-n,i.push(e._e().objects.overlay.addPoint(x(r,s,.5),{type:"NAVLINK_DIRECTION",bearing:a}))}}return e},displayAsSelected:function(e,t,i){const o=Ye(e);o.isSelected||(o._cPnt=t),We(e,{selected:!0})},addShp:(e,t,i,o,r,s)=>{const n=e.coord(),a=e._e(),l=it.ignoreZ(e),c=a.map.searchPointOnLine(n,t,a._config.snapTolerance,s,He,l);if(i="number"==typeof i?i:null==c?void 0:c.index,!(null==c?void 0:c.existingShape)||r){const o=e.getZLevels();(null==c?void 0:c.existingShape)&&(i=m(n,t)+1),a.map.clipGeoCoord(t),n.splice(i,0,t),function(e,t){const i=Ze(e,"bn")||[];for(let e=0;e<i.length;e++)i[e]+=i[e]>=t}(e,i),Qe(e),Xe(e,n);let r=Math.round(t[2]<10&&t[2])||0;o.splice(i,0,r),a.objects.history.batch((()=>{e.getProvider().writeZLevels(e,o)}));const s=Ye(e,"shps");s.length&&(s.splice(i,0,it.createLinkShape(e,t,i)),s.forEach((e=>{e.__.index+=Number(e.getIndex()>i)})),s.forEach((t=>{$e(t,it.checkOverlapping(e,t.getIndex()))})),Ye(e,"selectedShapes").splice(i,0,!1)),it.refreshGeometry(e)}else if(!o)return!1;return i},snapShape:(e,t,i,o)=>{const r=e.getLink(),s=Ye(e),n=r._e(),a=r.getProvider().search({point:t,radius:o});let l,c=a.length;for(;l=a[--c];)if("NAVLINK"==l.class&&l.id!=r.id&&-1==s._cls.indexOf(l)&&l.behavior("snapCoordinates")){const e=n.map.searchPointOnLine(l.geometry.coordinates,t,o,He,o,i);if(e)return i&&(e.point[2]=t[2]||0),e.point}},defaults:function(e,t,i){const o=Ye(e);return(!t||t==o._cPnt)&&(o._cPnt=null,We(e,{selected:!1,hovered:!1},i),e)},hideDirection:function(e){const t=Ye(e,"arrows");if(t){for(let i=0;i<t.length;i++)e._e().objects.overlay.remove(t[i]);t.length=0}return e},fixGeo:function(e,t,i,o){return ot(e,t,i,o)},connectShpToLink:function(e,t,i,o,r,s=it.ignoreZ(e)){const n=new Ue;let a;const l=e._e().objects;if(i.id!=e.id){const c=function(e,t,i,o,r,s){const n=e._e(),a=e.coord();let l=null;const c=e.getConnectedLinks(t,!0),[d,h,p]=o,g=n._config.snapTolerance,u=n.map.searchPointOnLine(i.coord(),o,g,r,He,s);if(a[t][0]=d,a[t][1]=h,a[t][2]=p||0,it._setCoords(e,a),u){const o=n.map.clipGeoCoord(u.point),a=u.existingShape;l=n.objects.splitLinkAt(a?{link:i,index:u.index,avoidSnapping:!0,ignoreZ:s}:{link:i,point:o,preferSegment:r,avoidSnapping:!0,ignoreZ:s}),it.moveShapeAtIndexTo(e,t,o),c.forEach((e=>{const t=e.link;it.moveShapeAtIndexTo(t,e.index,o),ot(t,e.index),it.markAsModified(t,!1,!1),it.defaults(t)}))}return l}(e,t,i,o,r,s);if(null===c)return null;t>0&&t<e.geometry.coordinates.length-1&&(Ye(e,"isSelected")&&et(e._e()),it.deHighlight(e),a=l.splitLinkAt({link:e,index:t}));const d=e.geometry.coordinates;2==d.length&&d[0][0]==d[1][0]&&d[0][1]==d[1][1]&&l.remove(e),it.markAsModified(e),Ye(e,"isSelected")&&it.refreshGeometry(e),c&&(n.targetSplittedInto=c),a&&(n.splittedInto=a)}return n},isIntersection(e,t,i,o){const r=Math.pow(10,e._config.intersectionScale),s=e=>Math.round(e*r);return s(t[0])==s(i[0])&&s(t[1])==s(i[1])&&(o||s(t[2]||0)==s(i[2]||0))}};function ot(e,t,i,o){const r=e._e(),s=r.objects,n=!i;let a=t||0;const l=e.getZLevels(),c=l.length,d=t===He?c:a+1;let h=!0,{snapTolerance:p}=r._config;function g(e,t,i,o,s=1){return Number(i)==Number(o)&&r.map.distance(e,t)<=s}function u(r){if(o==r)return!0;function a(e){return 0==e||e==u-1}function c(t){const i=e.getConnectedLinks(t,!0);for(let{link:e,index:t}of i){it.moveShapeAtIndexTo(e,t,f,!0)&&it.markAsModified(e,!1)}return i}const d=e.coord(),h=Ye(e),u=d.length;let A,f,y=!1,v=!1;for(let o=0;o<u;o++)if(r!=o){if(g(d[o],d[r],l[o],l[r],p)){if(A=Math.abs(r-o)-1,a(o)&&a(r)?1==A?y=r:v=o:a(r)?A<=1?y=r:v=o:a(o)?(1==A&&r>o&&(y=o),0==A?y=r:A>0?v=r:y=o):0==A?y=r:v=o,!1!==v){let a,l,h;if(f=d[v],2==u){const i=c(t);it.moveShapeAtIndexTo(e,r==v?o:r,f),et(e._e()),s.remove(it.deHighlight(e)),i.forEach((e=>{n||ot(e.link,e.index)}))}else c(r),it.moveShapeAtIndexTo(e,r,f),l=s.splitLinkAt({link:e,index:v===u-1||0===v?~~(u/2):v}),l.forEach(((t,o)=>{ot(t,He,i.concat(e,l[Number(0==o)]))})),h=l[Number(r>=v)],!h.editState("removed")&&Math.abs(r-v)>=2&&(h.coord().forEach(((e,t)=>{e[0]==f[0]&&e[1]==f[1]&&(a=t)})),a&&s.splitLinkAt({link:h,index:a}));return!1}if(!1!==y){const t=d[o][0],l=d[o][1];let c=!1;e.getConnectedLinks(y,!0).forEach((e=>{const o=e.link;var r;it.markAsModified(o,!1),it.moveShapeAtIndexTo(o,e.index,[t,l],!0),r=o,c=!(n||-1!=i.indexOf(r))})),it.moveShapeAtIndexTo(e,r==o?o:r,[t,l],!0),it.deleteShape(e,y,!0),a(y)&&(!a(r)&&r-1>0&&it.moveShapeAtIndexTo(e,r-1,[t,l],!0),h.isSelected&&it.refreshGeometry(e),c&&d.length>2&&s.splitLinkAt({link:e,index:o-Number(0===y)}));const p=r-o;let g;return p>0?g=r-1-A:p<0&&(g=r+A),g}}}return!0}if(p==He&&(p=2),!e.editState("removed")&&a<c)for(i=n||!i?[]:i;a<d&&!0===(h=u(a));a++);return h}const rt={MARKER:h,AREA:$,LINE:de,NAVLINK:it,PLACE:Ie,ADDRESS:Ie};Ie.setLinkTools(it);const st=e=>function(t){const i=t.class,o=rt[i][e];if(o)return o.apply(o,arguments)},nt={getTools:function(e){return rt[e.class]},getTool:function(e,t){const i=this.getTools(e);return i&&t?i[t]:i},private:st("private"),getEventListener:function(e,t){const i=this.getTools(e);return i?i._evl[t]||i.private(e,t):e.__&&e.__[t]||e[t]}};for(const e in rt)for(const t in rt[e])nt[t]||(nt[t]=st(t));const at=(e,i,o,r,s,n=(e=>{var t;if("terrain"===(null===(t=e.behavior)||void 0===t?void 0:t.call(e,"dragSurface")))return{terrain:!0};const i=(t,i)=>{var o;let r=null===(o=e.behavior)||void 0===o?void 0:o.call(e,t);if(r)return"string"==typeof r&&(r=i[r.split("").sort().join("").toUpperCase()]),r},o=i("dragPlane",{XY:[0,0,1],XZ:[0,1,0],YZ:[1,0,0]});if(o)return{plane:o};const r=i("dragAxis",{X:[1,0,0],Y:[0,1,0],Z:[0,0,1]});return r?{axis:r}:{plane:[0,0,1]}})(o))=>{const a=(s=s||o._e()).display,l=a._unprj(e,i,-1),c=a._unprj(e,i,0),d=t.vec3.sub([],c,l),h=a._g2w(r),p=void 0===r[2];let g;if(n.terrain){const t=a.getTerrainPointAt({x:e,y:i});g=t&&[t.longitude,t.latitude,t.altitude]}else if(n.plane){const e=E(d,l,n.plane,h);g=a._w2g(e)}else{const o=n.axis,r=a._prj(h)[2],s=h,c=t.vec3.add([],h,o),p=a._unprj(e,i,r),u=t.vec3.normalize([],t.vec3.cross([],t.vec3.sub([],p,c),t.vec3.sub([],s,c))),A=E(d,l,u,h);if(A){const e=t.vec3.add([],h,o),i=b(e,h,A);g=a._w2g(i)}}return g&&((r=s.map.clipGeoCoord(g,!0))[2]<0&&(r[2]=0),p&&0===r[2]&&r.pop()),r};class lt{}const ct=lt.prototype;let dt;ct.created=!1,ct.modified=!1,ct.removed=!1,ct.split=!1,ct.selected=!1,ct.hovered=!1;const ht=e=>3==e.length?[e[0],e[1],e[2]]:[e[0],e[1]],pt=e=>{const t=[];for(let i=0;i<e.length;i++){const o=e[i],r=t[t.length]=[];for(let e=0;e<o.length;e++)r[e]=ht(o[e])}return t};class gt extends i.Feature{constructor(e,t){super(e,t),this.properties=this.properties||{},this.properties["@ns:com:here:editor"]=new lt}toString(){return this.class+"  "+this.id}getProvider(){return this._provider}_e(){return this._provider._e}_t(e){return e?nt.getTool(this,e):nt.getTools(this)}editState(e,t){const i=arguments.length,o=this,r=o.properties["@ns:com:here:editor"];if(!i)return r;if(2==i){if(this._esu)return;t?r[e]=t:delete r[e],"hovered"!=e&&"selected"!=e&&o._e().objects.history.batch((()=>{o._esu=!0,o.getProvider().writeEditState(o,e),o._esu=dt}))}return r[e]}style(e){const t=this;if("string"==typeof e||0==arguments.length)return this._e().getStyle(t,dt);this._e().setStyle(t,e,!0)}prop(e,i){const o=this;let r=!1;const s=arguments.length,n=o.getProvider().getFeatureProperties(o);if(!s||1==s&&"string"==typeof e)return"object"==typeof(e=e?n[e]:n)?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==s){const t={};t[e]=arguments[1],e=t}for(const t in e){const i=e[t],s="object"==typeof i,a=n[t];(s&&JSON.stringify(i)!=JSON.stringify(a)||!s&&a!==i)&&(r||(this._e().objects.history.origin(o),r=!0),n[t]=i)}r&&(this._e().setStyle(o),nt.markAsModified(o))}getCoordinates(){return this.coord()}coord(e){const t=this,i=t.geometry.type;if(!(e instanceof Array))return e=t.getProvider().decCoord(t),"Point"==i?ht(e):"Polygon"==i||"MultiLineString"==i?pt(e):"MultiPolygon"==i?e.map((e=>pt(e))):pt([e])[0];nt.deHighlight(t),nt._setCoords(t,e),nt.markAsModified(t)}editable(e){return nt._editable(this,e),this.unselect(),this}select(){nt._select(this)}unselect(){nt.private(this,"isSelected")&&this._e().objects.selection.clearSelected()}transform(){this._e().transformer.show(this)}remove(){this._e().objects.remove(this,{save:!0})}}gt.prototype.id=null;const ut=null;class At{constructor(e,t,i,o,r,s,n){this.type=e,this.timeStamp=Date.now(),this.mapX=t,this.mapY=i,this.nativeEvent=o,this.button=r,this.target=s,this.detail=n}}const ft=At.prototype;ft.nativeEvent=ut,ft.detail=ut,ft.target=ut,ft.mapX=ut,ft.mapY=ut,ft.type=ut,ft.button=ut,ft.timeStamp=ut,ft.toString=function(){return"EditorEvent "+this.type};class yt extends i.Feature{constructor(e,i,o,r,s){super({type:"Feature",geometry:{type:"Point",coordinates:r},properties:{"@ns:com:here:editor":{},index:o,isMoved:!1}},e.overlay.getProvider());const n=e.getFeature().geojson,a=this;let l=s.toUpperCase();a.properties[l]={properties:t.JSUtils.extend(!0,{},n.properties),style:i.getStyle(n)},a._b=e,a.__={pointerdown:function(){this.properties.isMoved=!1,this.properties.p=i.display.geoToPixel.apply(i.display,this.geometry.coordinates)},pressmove:function(t,o,r,s,n){const a=this,l=this.properties.p,c=i.map.getGeoCoord(l.x+o,l.y+r);e.getFeature().update(this.properties.index,c),a._provider.setFeatureCoordinates(a,c.slice()),a.isMoved=!0},pointerup:function(e){this.properties.isMoved||i.listeners.trigger(e,this)}},this.class=l+"_SHAPE"}remove(){const e=this;e.__=null,e._b.removeShape(e.properties.index)}getLength(){return this._b.getLength()}getIndex(){return this.properties.index}}class vt{constructor(e,t){this.type="LineString",this.path=[],this.geojson=e.addFeature({type:"feature",geometry:{type:"LineString",coordinates:[t,[t[0]-1e-6,t[1]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}update(e,t){const i=this.path;t&&(i[e]=t),i.length>1&&this.overlay.setFeatureCoordinates(this.geojson,this.createGeo(i))}removeAt(e){this.path.splice(e,1)}createGeo(e){if(e.length>1)return e.slice()}isValid(e){return!!e||this.path.length>1}}class mt{constructor(e,t){this.path=[],this.type="MultiPolygon",this.geojson=e.addFeature({type:"feature",geometry:{type:"MultiPolygon",coordinates:[[[t,[t[0]-1e-6,t[1]],[t[0]-1e-6,t[1]-1e-6],t]]]},properties:{}}),this.properties=this.geojson.properties,this.overlay=e}update(e,t){const i=this.path;if(t&&(i[e]=t),i.length>2){const e=this.createGeo(i);e&&this.overlay.setFeatureCoordinates(this.geojson,e)}}createGeo(e){if(e.length>2)return[[e.concat([e[0]])]]}removeAt(e){this.path.splice(e,1)}isValid(e){return e?(e.push(e[0].slice()),e.length<4||$.validateGeometry(e)):this.path.length>2}}const St=[{type:"Circle",zIndex:0,stroke:"#FFFFFF",fill:"#000000",strokeWidth:2,radius:6}],_t=[{zIndex:0,type:"Line",strokeWidth:2,stroke:"#ffffff"}];function Lt(e,i){const o=t.JSUtils.clone(e||St);return o.forEach((e=>e.zIndex=(0^e.zIndex)+i)),o}let bt;class Et{constructor(e,t,i){this.shapes=[],this.originLink=null,this.originPos=null;const o=this;o.overlay=e,o.iEdit=t,o.display=i,o.onBoardUp=o.onBoardUp.bind(o),o.updateCursor=o.updateCursor.bind(o)}onBoardUp(){this.mousedown=!1}updateCursor(e){const{iEdit:t,feature:i,shapes:o,display:r,cursor:s,mousedown:n,overlay:a}=this;if(n){const i=t.map.getEventsMapXY(e),{prevPos:o}=s.properties;r.lockViewport().pan||r.pan(i[0]-o[0],i[1]-o[1],0,0),o[0]=i[0],o[1]=i[1]}else{const r=t.map.getGeoCoord(t.map.getEventsMapXY(e)),n=o.map((e=>e.geometry.coordinates));n.push(r);const l=i.isValid(n);if(l!=!this.inValid){let e=this.style.feature;l?(e=this.inValid,this.inValid=!1):(this.inValid=e,e=[Object.assign(Object.assign({},e[0]),{fill:"rgba(0,0,0,0)"})]),t.setStyle(i.geojson,e)}i.update(o.length,r),a.setFeatureCoordinates(s,r)}}init(){const e=this,{iEdit:i,display:o,overlay:r,updateCursor:s}=e,n=o.getViewBounds(),a=[n.minLon,n.maxLat];this.feature=new this.FeatureClass(r,a);const l=r.addCircle(a,Lt(St,1));l.pointerdown=t=>{const{properties:o}=l;o.prevPos=i.map.getEventsMapXY(t),e.mousedown=!0,o.panned=!1},l.pressmove=e=>{s(e),l.properties.panned=!0},l.pointerup=t=>{l.properties.panned||e.addShape(i.map.getGeoCoord(t.mapX,t.mapY),bt,t),e.onBoardUp()},this.cursor=l,this.inValid=!1,t.global.addEventListener("mousemove",this.updateCursor),t.global.addEventListener("mouseup",this.onBoardUp)}addShape(e,t,i){const{iEdit:o,settings:r,shapes:s,feature:n}=this;let a;if(t){if(this.originLink=t,a=t.geometry.coordinates,"number"==typeof e)e=a[e].slice(0);else{let t=o.map.searchPointOnLine(a,e,o._config.snapTolerance);!(null==t?void 0:t.existingShape)||0!=t.index&&t.index!=a.length-1||(this.originLink=null),e=null==t?void 0:t.point}this.originPos=e}const l=this.overlay.addFeature(new yt(this,o,s.length,e,r.mode),Lt(this.style.shape,9));return n.update(s.length,e),s.push(l),r.onShapeAdd&&r.onShapeAdd(new At("onShapeAdd",e[0],e[1],i,i&&i.button,l,{index:l.properties.index})),l}setGeom(e,t){const{settings:i}=this;if(e!=this.feature.type)return;this.hide(),this.show(i);let o="LineString"==e?t:t[0][0].slice(0,-1);const{onShapeAdd:r}=i;i.onShapeAdd=null;for(let e of o)this.addShape(e);i.onShapeAdd=r}removeShape(e){const{shapes:t,iEdit:i,overlay:o,feature:r,settings:s}=this;e==bt&&(e=t.length-1);let n=t[e],a=i.map.getGeoCoord(n.geometry.coordinates);o.remove(n),t.splice(e,1),r.removeAt(e);for(let i=e;i<t.length;i++)t[i].properties.index--;r.update(),s.onShapeRemove&&s.onShapeRemove(new At("onShapeRemove",a[0],a[1],bt,bt,bt,{index:e}))}getFeature(){return this.feature}getLength(){return this.shapes.length}setAttributes(e){const{feature:i,iEdit:o,cursor:r,settings:s,shapes:n}=this;if(e){t.JSUtils.extend(i.properties,e);const a=((e,i)=>{let o,r,s,n;const a=e.mode;if(e.styleGroup)o=e.styleGroup;else if("Navlink"!=a&&"Area"!=a||(i.editState=()=>({}),i.class=a),o=e.layer.getStyleGroup(i),"Area"!=a)return n=t.JSUtils.clone(St),n[0].fill=o[0].stroke,s=t.JSUtils.clone(_t),s[0].stroke=(o[1]||o[0]).stroke,{feature:s,shape:n};const l=e=>-1!=["Circle","Image","Rect","Text"].indexOf(e.type);if(s=o.filter((e=>!l(e))),n=o.filter(l),s.length||(s=e.layer.getStyleGroup(i)),!e.styleGroup||!n.length){n=t.JSUtils.clone(St);const e=s[0];let i;r=e.stroke,"Area"==a?(i=e.fill,r&&(n[0].stroke=r)):i=r,i&&(n[0].fill=i)}return{feature:s,shape:n}})(s,i.geojson);this.style=a,i.geojson.class=bt,o.setStyle(i.geojson,a.feature),n.concat(r).forEach((e=>{o.setStyle(e,Lt(a.shape,o.getStyle(e)[0].zIndex))}))}}createGeom(){const{feature:e,shapes:t,settings:i}=this,{tolerance:o}=i;let r=t.map((e=>e.geometry.coordinates));"Area"!=i.mode&&o&&(r=f(r,o));let s=e.createGeo(r);if(s)return{type:e.type,coordinates:s}}create(e){const{iEdit:t,FeatureClass:i,shapes:o,feature:r,originLink:s,originPos:n,settings:a}=this;if(this.setAttributes(e),i==vt){const e=o[0].geometry.coordinates;s&&n[0]==e[0]&&n[1]==e[1]&&t.objects.splitLinkAt({link:t.objects.get(s),point:e})}let l=o.map((e=>e.geometry.coordinates));if(r.isValid(l)){const e=this.createGeom();let i;return e&&(i=t.objects.create({feature:{type:"Feature",geometry:e,properties:r.properties},provider:a.layer.getProvider()}),i&&t.objects.history.saveChanges(),this.hide()),i}throw new Error("Invalid Geometry")}isActive(){return this.active}show(e){if(!this.active){const t=this.overlay.layer,{iEdit:i,display:o}=this;i.objects.listenDisplay(!1),o.removeLayer(t),o.addLayer(t),i.objects.listenDisplay(!0),this.settings=e,"Area"==e.mode?this.FeatureClass=mt:this.FeatureClass=vt,this.originLink=null,this.originPos=null,this.active=!0,this.init(),this.setAttributes(e.attributes)}}hide(){const e=this,{display:i,overlay:o,shapes:r,feature:s}=e;if(e.active){e.active=!1;const n=o.layer;i.removeLayer(n),i.addLayer(n),o.remove(s.geojson),e.feature=null,r.forEach((e=>o.remove(e))),r.length=0,o.remove(e.cursor),e.cursor=null,t.global.removeEventListener("mousemove",e.updateCursor),t.global.removeEventListener("mouseup",e.onBoardUp)}}}const xt="Area",kt="Navlink",Ct=t.global.here.xyz.maps.editor;class Pt{constructor(e){this._e=e,this._b=new Et(e.objects.overlay,e,e.display),this._a=!1}addShape(e,t){if(this._a)return this._b.addShape(this._e.map.getGeoCoord(e),t)}removeShape(e){this._a&&this._b.removeShape(e)}getLength(){return this._b.getLength()}cancel(){this._b.hide(),this._a=!1}setProperties(e){this._a&&this._b.setAttributes(e)}setAttributes(e){return this.setProperties(e)}create(e){if(this._a){let t=this._b.create(e);return t&&(this._a=!1),t}}start(e){const t=(e=Object.assign({tolerance:1},e||{})).connectTo;let i=e.mode||kt;return i="string"!=typeof i?i===Ct.features.Area?xt:kt:i.charAt(0).toUpperCase()+i.slice(1).toLowerCase(),e.mode=i,e.attributes=e.properties||e.attributes||{},this.cancel(),e.layer=e.layer||this._e.getLayerForClass(i.toUpperCase()),(i!=xt||e.layer)&&(this._e.listeners.trigger("_clearOverlay"),this._b.show(e),this._a=!0,e.position&&this.addShape(e.position,t)),this._a}isActive(){return this._a}getGeometry(){return this._b.createGeom()}setGeometry(e){this._b.setGeom(e.type,e.coordinates)}}function It(e,t){const o=4096,r=e.coord().map((e=>{let t=i.webMercator.geoToPixel(e[0],e[1],o);return[t.x,t.y]}));let s;if("number"==typeof t)s=t;else{let e=i.webMercator.geoToPixel(t.longitude,t.latitude,o);s=ge(r,[e.x,e.y]).offset}const n=O(r,R(r)*s),a=i.webMercator.pixelToGeo(n[0],n[1],o);return{coordinate:[a.longitude,a.latitude],offset:s}}class Rt extends i.Feature{constructor(e,t,i,o,r,s,n,a){super({type:"Feature",properties:{relPos:i,dragged:!1,style:Rt.initStyle(o)},geometry:{type:"Point",coordinates:It(t.getMultiLink(),i).coordinate}}),this.snapped=[],this.range=t,this.iEditor=e,this.isLocked=r,this.dragStart=s,this.dragMove=n,this.dragEnd=a;e.objects.overlay.addFeature(this,this.properties.style),this.updatePosition(this.geometry.coordinates,i)}static initStyle(e){let i=t.JSUtils.clone(e);for(let e of i)e._offsetX=e.offsetX||0,e._offsetY=e.offsetY||0;return i}isSnapped(e){return e?this.snapped.indexOf(e)>=0:Boolean(this.snapped.length)}getSnapped(e){return this.snapped.find((t=>t.range==e))}snap(e){if(!this.isSnapped(e)){for(let{range:t}of this.snapped)if(t==e.range)return!1;return this.snapped.push(e),!0}}validatePosition(e,i){const o=this,r=o.range,s=r.options.snapTolerance||1;let n={coordinate:e=e||o.geometry.coordinates,offset:i,adjusted:!1},a=r.getOffsets();const l=r.getFromMarker()==this;let c;a[Number(!l)]=i,a=a.sort(((e,t)=>e-t));for(let n of o.range.getMultiLink().getRanges()){if(n==o.range)continue;let l=n.getOffsets();const[d,h]=n.getMarkers(),p=n.getSide();if(r.allowSnap(p)&&!this.isSnapped(d)&&!this.isSnapped(h)){const i=t.geotools.distance(e,d.geometry.coordinates),o=t.geotools.distance(e,h.geometry.coordinates);if(Math.min(i,o)<s||r.overlaps(l,a)){const e=i<o?d:h;this.snap(e)}}const g=this.getSnapped(n);if(g){const e=l.indexOf(g.getRelPos());l[e]=i,l=l.sort(((e,t)=>e-t))}if(!r.allowOverlap(p)&&r.overlaps(l,a)){c=n;break}}if(c){const[e,t]=c.getMarkers(),i=this.range.getFromMarker()==this?t:e;n.offset=i.getRelPos(),n.coordinate=i.geometry.coordinates,n.adjusted=!0}return n}updatePosition(e,t){const i=this,o=i.properties.style,r=i.range.getMultiLink().coord(),s=m(r,e),n=i.range.getSide(),a=r[s],l=r[s+1],c=l[0]-a[0],d=l[1]-a[1],h=180*-Math.atan2(d,c)/Math.PI,p=Math.sqrt(c*c+d*d);let g=d,u=c;p&&(g/=p,u/=p);for(let e of o)if(e.rotation=h,"B"!=n){let{_offsetX:t,_offsetY:i,lineOffset:o}=e;i+=o,e.offsetX=g*i+u*t,e.offsetY=u*i+-g*t}i.getProvider().setFeatureCoordinates(i,e),i.properties.relPos=t;for(let i of this.snapped)i.updatePosition([e[0],e[1]],t),i.range.update();return e.slice()}pressmove(e){const t=this;if(!t.isLocked()){const i=e.detail.display,o=t.range.getMultiLink(),{offset:r,coordinate:s}=It(o,i.pixelToGeo(e.mapX,e.mapY)),n=this.validatePosition(s,r);t.updatePosition(n.coordinate,n.offset),t.dragMove(e),t.properties.dragged=!0}}pointerdown(e){this.dragStart(e),this.properties.dragged=!1,this.validatePosition(this.geometry.coordinates,this.getRelPos())}pointerup(e){this.properties.dragged&&this.dragEnd(e),this.snapped.length=0}remove(){this.getProvider().removeFeature(this)}getRelPos(){return this.properties.relPos}getRelPosOfSubLink(e){const{iEditor:t}=this,i=this.geometry.coordinates,o=t.map.getPixelCoord(i),r=m(this.range.getMultiLink().coord().map((e=>t.map.getPixelCoord(e))),o);if(r>=e.from&&r<e.to){const i=e.lineString.map((e=>t.map.getPixelCoord(e))),r=pe(o,e.reversed?i.reverse():i);return r>.995?1:Math.round(1e9*r)/1e9}return r<e.from?0:1}}let Ot;var wt;!function(e){e.L="#ff4040",e.R="#4cdd4c",e.B="#35b2ee"}(wt||(wt={}));class Ft{constructor(e,t,i){this.options=Object.assign({_dragStart:(e,t)=>{},_dragMove:(e,t)=>{},_dragStop:(e,t)=>{}},i);const{id:o}=i;o!=Ot&&(this.id=o);const r=JSON.parse(JSON.stringify(i.style||{}));this.ml=e;let s=this.getSide(),{opacity:n,fill:a,stroke:l}=r;a&&!l&&(l=a,a=!1),a||(a=l,l="#fff"),a=a||wt[s];let c=i.lineStyle||((e,t,i)=>{const o=e.layer.getStyle().styleGroups.RANGESELECTOR_RANGE_LINE,r=[];for(let e of o)r.push(Object.assign(Object.assign({},e),{opacity:null!=i?i:e.opacity,stroke:t}));return r})(t,a,n),d=0;for(let t of c)t.zLayer=e.zLayer,d=t.offset||d;this.line=t.addPath(e.coord(),this.style=c);let h=i.markerStyle||((e,t,i,o)=>{let r="R"==o?1:"L"==o?-1:0;const s=e.layer.getStyle().styleGroups.RANGESELECTOR_RANGE_MARKER;return[Object.assign(Object.assign({},s[0]),{fill:i,offsetY:r*s[0].offsetY}),Object.assign(Object.assign({},s[1]),{fill:t,stroke:i,offsetY:r*s[1].offsetY}),Object.assign(Object.assign({},s[2]),{stroke:i})]})(t,a,l,s);for(let t of h)t.lineOffset==Ot&&(t.lineOffset=d,t.zLayer=e.zLayer);this.markers=["from","to"].map((t=>new Rt(e.iEdit,this,i[t],h,(()=>this.locked()),(e=>{this.options._dragStart(e,this)}),(e=>{this.update(),this.updateSegments(),this.options._dragMove(e,this)}),(e=>{this.options._dragStop(e,this)})))),this.overlay=t,this.updateSegments()}updateSegments(){this.segments=this.ml.getZoneSegments(this)}getSide(){return this.options.side.toUpperCase()}getOffsets(){let e=this.markers[0].getRelPos(),t=this.markers[1].getRelPos();if(e>t){const i=e;e=t,t=i}return[e,t]}allowSide(e,t){let i=[];return"boolean"==typeof(t=t||[])?t:("string"==typeof t?i.push(t):Array.isArray(t)&&(i=t),-1!=i.indexOf(e))}allowOverlap(e){return this.allowSide(e,this.options.allowOverlap)}allowSnap(e){return this.allowSide(e,this.options.snap)}getMarkers(){return this.markers.sort(((e,t)=>e.getRelPos()-t.getRelPos()))}getFromMarker(){const{markers:e}=this,t=e[0].getRelPos(),i=e[1].getRelPos();return e[Number(t>i)]}getMultiLink(){return this.ml}remove(){this.overlay.remove(this.line),this.markers[0].remove(),this.markers[1].remove()}locked(){return!!this.options.locked}overlaps(e,t){t=Array.isArray(t)?t:this.getOffsets(),e=Array.isArray(e)?e:e.getOffsets();const[i,o]=t.sort(((e,t)=>e-t)),[r,s]=e.sort(((e,t)=>e-t));return Math.max(0,Math.min(o,s)-Math.max(i,r))>0}update(){const[e,t]=this.getOffsets();for(let i of this.style)i.from=e,i.to=t;this.overlay.layer.setStyleGroup(this.line,this.style),this.updateSegments()}}function Nt(e,t){return e.concat(t.slice(1))}function Mt(e,t,i,o){return{zIndex:e,type:"Line",stroke:t,strokeWidth:i,strokeDasharray:o||"none",strokeLinejoin:"round",strokeLinecap:o?"butt":"round"}}const Tt=()=>[Mt(0,"white",23),Mt(1,"grey",20),Mt(2,"white",3,[5,4])];class jt{constructor(e,t,i,o){this.ranges=[],this.links=[];const r=e.objects.overlay;this.iEdit=e,this.completePath=t,this.style=i||Tt(),this.overlay=r,this.feature=r.addPath(t,this.style,{type:"RANGESELECTOR_LINE"}),this.hide(),this.links.push({from:0,to:t.length-1,feature:o,lineString:t,reversed:!1}),r.setFeatureCoordinates(this.feature,this.completePath)}updateStyle(e){e=e||Tt(),this.style=e,this.overlay.layer.setStyleGroup(this.feature,e)}removeZones(){this.ranges.forEach((e=>{e.remove()})),this.ranges.length=0}coord(){return this.completePath.map((e=>e.slice()))}hide(){this.overlay.remove(this.feature)}getMaxZLayer(){let e=this.iEdit.getZLayer(this.overlay.layer);for(let{feature:t}of this.links){let i=this.iEdit.getMaxZLayer(t);i>e&&(e=i)}return e+1}show(e){const{overlay:t}=this;this.removeZones();let i=this.getMaxZLayer();this.zLayer=i;for(let e of this.style)e.zLayer=i;t.addFeature(this.feature,this.style),e.forEach((e=>{if(-1!=["L","R","B"].indexOf(e.side)){let i=new Ft(this,t,e);this.ranges.push(i),i.update()}}))}addLink(e,o){const{links:r}=this;function s(e,t){return e[0]===t[0]&&e[1]===t[1]}o instanceof i.Feature&&it.defaults(o);const n=(i,s,n)=>{const l=t.JSUtils.clone(e);if(n&&l.reverse(),0===i){for(let e=0;e<r.length;e++)r[e].from+=s,r[e].to+=s;this.completePath=Nt(l,a)}else this.completePath=Nt(a,l);r.unshift({from:i,to:s,feature:o,lineString:e,reversed:!!n})},a=this.completePath;s(e[e.length-1],a[0])?n(0,e.length-1):s(e[0],a[0])?n(0,e.length-1,!0):s(e[0],a[a.length-1])?n(a.length-1,a.length+e.length-2):s(e[e.length-1],a[a.length-1])&&n(a.length-1,a.length+e.length-2,!0),this.overlay.setFeatureCoordinates(this.feature,this.completePath)}destroy(){this.hide(),this.removeZones()}getRanges(){return this.ranges}getZoneSegments(e){const t=e.markers[0],i=e.markers[1],o=[];function r(e){const t=e[0];e[0]=e[1],e[1]=t}return this.links.forEach((e=>{const s=[t.getRelPosOfSubLink(e),i.getRelPosOfSubLink(e)];s[0]>s[1]&&r(s),e.reversed&&(r(s),s[0]=1-s[0],s[1]=1-s[1]),o.push({navlink:e.feature,feature:e.feature,from:s[0],to:s[1],reversed:e.reversed})})),o}}class Bt{constructor(e){this.multiLink=null,this.lines=[],this.iEditor=e,this.display=e.display}isConnected(e,t,i){const o=[0,e.length-1],r="number"==typeof i?[i]:[0,t.length-1];for(let i of r){const r=t[i];for(let t of o)if(it.isIntersection(this.iEditor,e[t],r))return{i1:t,i2:i}}return null}getOppositeNodeIndex(e,t){return 0==t?e.length-1:0}getCollection(){return this.multiLink}show(e){this.multiLink&&this.multiLink.show(e)}hide(){const{multiLink:e,lines:t}=this;for(let{feature:e}of t)e instanceof gt&&it.defaults(e);this.lines=[],e&&(e.destroy(),this.multiLink=null)}addLineSegment(e){let t,i,{multiLink:o,lines:r}=this;const s=e.coordinates,n=e.feature;if(null!=s){if(t=!r.length,t)o=new jt(this.iEditor,s,this.mlStyle,n),this.multiLink=o,this.first={lineString:s,index:null},i=!0;else{for(let{id:t}of r)if(e.id==t)return!1;const t=this.first.lineString;let i=this.isConnected(s,t,this.first.index);i?this.last?this.first={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)}:(this.first.index=this.getOppositeNodeIndex(t,i.i2),this.last={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)}):this.last&&(i=this.isConnected(s,this.last.lineString,this.last.index),i&&(this.last={lineString:s,index:this.getOppositeNodeIndex(s,i.i1)})),i&&o.addLink(s,n)}i&&(n instanceof gt&&it.deHighlight(n),r.push(e))}return!!t}setMLStyle(e){this.mlStyle=e,this.multiLink&&this.multiLink.updateStyle(e)}}class Dt{constructor(){this.listeners=new t.Listener(["tap","dbltap","pointerdown","pointerup","pointerenter","pointerleave","dragStart","dragStop","dragMove","featureUnselected","error","_domResize","_panMap","_layerAdd","_layerRemove","_clearOverlay","_beforeSubmit","_afterSubmit"]).sync(!0)}static createEditorEvent(e,t,i,o){return new At(i||e.type,e.mapX,e.mapY,e.nativeEvent,e.button,t,o||e.detail)}trigger(e,t,i){const o=this,r=i||e.type||e;let s,n,a;var l;return(l=t)&&l.class?(n=e.detail,a=t):n=t,"touchend"==e.type&&(e=e.changedTouches[0]),s=o.listeners.trigger(r,Dt.createEditorEvent(e,a,r,n),(e=>"_"==e[0])(r)),"pointerup"==r&&(s=o.listeners.trigger("tap",[new At("tap",e.mapX,e.mapY,e.nativeEvent,e.button,a,n)],!1)||s),s}add(e,t,i){return this.listeners.add(e,t,i)}remove(e,t,i){return this.listeners.remove(e,t,i)}supported(){return this.listeners.getEvents()}destroy(){this.listeners=null}}let Gt;const zt=e=>{const{id:t,from:i,to:o,side:r,style:s}=e.options;return{id:t,from:i,to:o,side:r,style:s,segments:e.segments}};class Kt{constructor(e){this.links=new Bt(e)}add(e){var t;const i=Array.isArray(e)?e:[].slice.call(arguments);for(let e of i){let i;(e instanceof gt||"LineString"==(null===(t=e.geometry)||void 0===t?void 0:t.type))&&(i=e.geometry.coordinates),i&&this.links.addLineSegment({id:e.id||1e9*Math.random()^0,coordinates:i,feature:e})}}show(e){const t=this.ranges=e instanceof Array?e:[].slice.call(arguments);t.forEach((e=>{e.from=e.from||0,e.to=(e.to==Gt?1:e.to)||0,e.allowOverlap==Gt&&(e.allowOverlap=!0);for(let t of["markerStyle","lineStyle"]){let i=e[t];i&&!Array.isArray(i)&&(e[t]=[i])}for(let t of["dragStart","dragMove","dragStop"]){const i=e[t];i&&(e["_"+t]=(e,o)=>{e.detail.range=e.detail.zone=zt(o),i(Dt.createEditorEvent(e,e.target,t))})}})),this.links.show(t)}hide(){return this.links.hide()}info(){const e=[],t=this.links.getCollection();if(t){t.getRanges().forEach((t=>{e.push(zt(t))}))}return e}setStyleGroup(e){this.links.setMLStyle(e)}}class Ht extends i.Feature{constructor(e,t,i,o,r={},s){super({type:"Feature",geometry:{type:"Point",coordinates:t},properties:r},i.layer.getProvider()),this._o=i,this.transformer=o,i.addFeature(this,s)}setPosition(e,t){this.getProvider().setFeatureCoordinates(this,[e,t])}getCenter(){return this.geometry.coordinates.slice()}hide(){this._o.hideFeature(this)}show(){this._o.showFeature(this)}remove(){this._o.remove(this)}enableHover(e,t){this.__.pointerenter=this.__.pointerleave=t=>{const i="pointerenter"==t.type;document.body.style.cursor=i?e:"default",this.properties["@ns:com:here:editor"].hovered=i,this.properties.hovered=i,this._o.layer.setStyleGroup(this)}}}class Vt extends Ht{constructor(e,i,o,r){let s,n,a;super(e,i,o,r,{type:"TRANSFORMER_ROTATE_KNOB"});let l,c=null;l=0,this.__={pressmove:(i,o,d)=>{s=!0;const h=90-t.geotools.calcBearing(a,e.map.getGeoCoord(i.mapX,i.mapY))-c;r.setRotation(h);for(let t of n)nt._setCoords(t,e.map.rotateGeometry(t.geometry,a,h-l));l=h},pointerdown:i=>{s=!1,a=r.getCenter(),null==c&&(c=90-t.geotools.calcBearing(a,e.map.getGeoCoord(i.mapX,i.mapY))),n=r.getFeatures()},pointerup:()=>{s&&(n.length>1||"Point"!=n[0].geometry.type)&&r.markObjsAsMod(),n=null,a=null}},this.enableHover("move")}update(){const e=this.transformer.getCorner(Jt.bottomRight,15,15);this.setPosition(e[0],e[1])}}class Ut extends Ht{constructor(e,t,i,o){let r,s,n,a,l,c;super(e,t,i,o,{type:"TRANSFORMER_SCALE_KNOB"}),this.__={pressmove:(t,i,n)=>{const d=e.map.getGeoCoord(t.mapX,t.mapY);let h=b(l,a,d);const p=P(h,a)/c,g=p/s;r||o.visible(!(r=!0)),o.scale(g,g),s=p},pointerdown:e=>{r=!1,a=o.getCenter(),a[2]=0,l=this.geometry.coordinates.slice(0,2),l[2]=0,c=P(l,a),n=o.getFeatures(),s=1},pointerup:()=>{r&&(n.length>1||"Point"!=n[0].geometry.type)&&o.markObjsAsMod(),n=null,a=null,o.visible(!0)}},this.enableHover("nwse-resize")}update(){const e=this.transformer.getCorner(Jt.topLeft,-15,-15);this.setPosition(e[0],e[1])}}class Yt extends Ht{constructor(e,t,i,o){super(e,t,i,o,{type:"TRANSFORMER_TRANSLATE_KNOB"}),this.internalEditor=e,this.__={pointerdown:()=>{const e=this.properties;e.moved=!1,e._dx=0,e._dy=0},pressmove:(e,t,i)=>{const r=this.properties;r.moved=!0,o.pan(t-r._dx,i-r._dy),r._dx=t,r._dy=i},pointerup:()=>{this.properties.moved&&o.markObjsAsMod()}},this.enableHover("move")}update(){const e=this.transformer.getRotatedBoundingBox(),t=[e[0],e[2]],i=O(t,.5*R(t));this.setPosition(i[0],i[1])}}class Zt{constructor(e,t,i,o){const r=this,{map:s}=i;let n,a=!1;this.transformer=e,this.buffer=t;const l=[o.addRect(0,0,0,0,{type:"TRANSFORMER_SCALE_BOX"})],c=i.getStyle(l[0]);for(let e=0;e<4;e++)l.push(o.addPath([[0,0],[0,0]],[{zIndex:c[0].zIndex+1,zLayer:c[0].zLayer||0,type:"Line",strokeWidth:6}],{index:e,vertical:e%2}));let d,h=!1;function p(t,i,o){if(a)return;const{index:c,vertical:p}=this.properties;let g=c==Jt.topLeft?Jt.bottomLeft:c-1,u=l[g+1].geometry.coordinates;h&&(u=u.reverse(),g=p?g==Jt.bottomRight?Jt.bottomLeft:Jt.bottomRight:g==Jt.bottomLeft?Jt.topRight:Jt.bottomRight);const[A,f]=u,y=e.getCenter(),v=e.rotation;let m=s.getPixelCoord(y),S=s.getPixelCoord(A),_=s.getPixelCoord(f),L=b(S,_,[t.mapX,t.mapY,0]);S=w(S,v,m),_=w(_,v,m),L=w(L,v,m);let E,x=1,k=1;if(p){const e=_[0]-S[0];E=L[0]-S[0],x=E/e}else{const e=_[1]-S[1];E=L[1]-S[1],k=E/e}d!=E>0&&(d=!d,h=!h),Math.abs(E)>r.buffer+6&&(e.scale(x,k,e.getCorner(g)),n=!0)}function g(){const t=e.getFeatures();a=1==t.length&&"Point"==t[0].geometry.type,n=!1;const{index:i,vertical:o}=this.properties,r=i==Jt.topLeft?Jt.bottomLeft:i-1,[c,p]=l[r+1].geometry.coordinates;let g=s.getPixelCoord(c),u=s.getPixelCoord(p);const A=e.getCenter(),f=e.rotation;let y=s.getPixelCoord(A);g=w(g,f,y),u=w(u,f,y),d=o?u[0]-g[0]>0:u[1]-g[1]>0,h=!1}function u(){n&&e.markObjsAsMod()}function A(){document.body.style.cursor="move"}function f(){document.body.style.cursor="default"}for(let e=1;e<l.length;e++){const t=l[e];t.pointerdown=g,t.pressmove=p,t.pointerup=u,t.pointerenter=A,t.pointerleave=f}this.overlay=o,this.features=l,this.iEdit=i,this.update()}setScale(e,t,i){this.transformer.scaleFeatures(this.features,e,t,i)}setRotation(e,t){for(let i of this.features)i.getProvider().setFeatureCoordinates(i,this.iEdit.map.rotateGeometry(i.geometry,t,e))}update(){let{buffer:e,transformer:t,features:i,overlay:o}=this;const r=o.getProvider(),s=t.getCorner(Jt.topLeft,-e,-e),n=t.getCorner(Jt.topRight,e,-e),a=t.getCorner(Jt.bottomRight,e,e),l=t.getCorner(Jt.bottomLeft,-e,e);r.setFeatureCoordinates(i[0],[[s,n,a,l,s]]),r.setFeatureCoordinates(i[1],[s,n]),r.setFeatureCoordinates(i[2],[n,a]),r.setFeatureCoordinates(i[3],[a,l]),r.setFeatureCoordinates(i[4],[l,s])}hide(){const{overlay:e,features:t}=this;e.hideFeature(t)}show(){const{overlay:e,features:t}=this;e.showFeature(t)}remove(){const{overlay:e,features:t}=this;e.remove(t)}pan(e,t){for(let i of this.features)this.iEdit.map.pixelMove(i,e,t)}}var Jt;!function(e){e[e.topLeft=0]="topLeft",e[e.topRight=1]="topRight",e[e.bottomRight=2]="bottomRight",e[e.bottomLeft=3]="bottomLeft"}(Jt||(Jt={}));class Wt{constructor(e){this.buffer=15,this.features=null,this.scaleBox=null,this.moveKnob=null,this.rotateKnob=null,this.scaleKnob=null,this.allowEditIds=[],this.rotation=0,this.iEditor=e}scaleFeatures(e,t,i,o){const r=[t,i],s=this.iEditor.map,{rotation:n}=this,a=this.getCenter();o=s.rotatePoint(o,a,-n);for(let t of e){const e={type:t.geometry.type,coordinates:t.geometry.coordinates};e.coordinates=s.rotateGeometry(e,a,-n),e.coordinates=s.scaleGeometry(e,r,o),e.coordinates=s.rotateGeometry(e,a,n);try{nt._setCoords(t,e.coordinates)}catch(i){t.geometry.coordinates=e.coordinates}}}restoreFeaturesEditable(){for(let e of this.features)this.allowEditIds.indexOf(e.id)>=0&&nt._editable(e,!0)}setRotation(e){const t=e-this.rotation,i=this.getCenter(),{geometry:o}=this.bbox;o.coordinates=this.iEditor.map.rotateGeometry(o,i,t),this.scaleBox.setRotation(t,i),this.scaleKnob.update(),this.rotateKnob.update(),this.rotation=e}markObjsAsMod(){const{features:e}=this;for(let t of e)nt.markAsModified(t,!1);e.length&&this.iEditor.objects.history.saveChanges()}getFeatures(){return this.features}visible(e){const{rotateKnob:t,scaleKnob:i,moveKnob:o,scaleBox:r}=this;t&&(e?(r.show(),t.show(),i.show(),o.show()):(r.hide(),t.hide(),i.hide(),o.hide()))}isActive(){return null!==this.scaleBox}hide(){const{features:e,rotateKnob:t,scaleKnob:i,moveKnob:o,scaleBox:r}=this;r&&(r.remove(),t.remove(),i.remove(),o.remove()),this.scaleBox=this.moveKnob=this.rotateKnob=null,this.rotation=0,null!=e&&(this.restoreFeaturesEditable(),this.allowEditIds.length=0,this.features=null)}update(){this.scaleBox.update(),this.scaleKnob.update(),this.rotateKnob.update(),this.moveKnob.update()}offsetCorner(e,t,i){const o=this.iEditor.map,r=this.getCenter(),s=this.rotation;return e=o.rotateGeometry({type:"Point",coordinates:e},r,-s),e=[(e=o.getPixelCoord(e))[0]-t,e[1]-i],e=o.getGeoCoord(e),o.rotateGeometry({type:"Point",coordinates:e},r,s)}scale(e,t,i=this.getCenter()){this.scaleFeatures(this.getFeatures(),e,t,i),this.scaleFeatures([this.bbox],e,t,i),this.update()}getCorner(e,t=0,i=0){let o=this.bbox.geometry.coordinates[e][0];return(t||i)&&(o=this.offsetCorner(o,-t,-i)),o}getRotatedBoundingBox(e){return e?this.bbox.geometry.coordinates.slice():this.bbox.geometry.coordinates.map((e=>e[0]))}pan(e,t){const i=this.iEditor.map;for(let o of this.getFeatures())i.pixelMove(o,e,t);const{geometry:o}=this.bbox;o.coordinates=i.translateGeo(o.coordinates,e,t),this.update()}getCenter(){return this.moveKnob.getCenter()}getBBox(){const e=[1/0,1/0,-1/0,-1/0];for(let t of this.features){const i=t.getBBox?t.getBBox():t.bbox;i[0]<e[0]&&(e[0]=i[0]),i[1]<e[1]&&(e[1]=i[1]),i[2]>e[2]&&(e[2]=i[2]),i[3]>e[3]&&(e[3]=i[3])}return e}show(e){Array.isArray(e)||(e=[e]);let t,{allowEditIds:i}=this;this.iEditor.listeners.trigger("_clearOverlay"),null!=this.features&&this.restoreFeaturesEditable(),i.length=0,this.features=e;for(let o,r=0;r<e.length;r++)t=e[r],o=nt.private(t),nt.deHighlight(t),o.isSelected=!1,o.allowEdit&&(i.push(t.id),nt._editable(t,!1));this.initUI()}initUI(){const e=this,{iEditor:t}=e,i=t.objects.overlay;if(this.scaleBox)return;const[o,r,s,n]=this.getBBox(),a=o+(s-o)/2,l=r+(n-r)/2,c=((e,t,i,o)=>[[[e,o],[i,o]],[[i,o],[i,t]],[[i,t],[e,t]],[[e,t],[e,o]]])(o,r,s,n);this.bbox={type:"Feature",geometry:{type:"MultiLineString",coordinates:c}};const d=new Yt(t,[a,l],i,e);d.update(),e.moveKnob=d;const h=new Zt(e,e.buffer,t,i),p=new Vt(t,[s,r],i,e),g=new Ut(t,[o,n],i,e);p.update(),g.update(),e.rotateKnob=p,e.scaleKnob=g,e.scaleBox=h}}const Qt=["ready","active","history.current","history.length","changes.length"],Xt={ready:void 0,active:null};class qt{constructor(){this.listeners=new t.Listener(Qt).sync(!0),this.val={};const e=this.val;let i,o,r=Qt.length;for(;i=Qt[--r];)o=Xt[i],e[i]=undefined!==o&&o}addObserver(e,t,i){const o=this,r=o.val;if("*"==e)for(const e in r)o.addObserver(e,t,i);else o.listeners.add(e,t,i)}removeObserver(e,t,i){const o=this,r=o.val;if("*"==e)for(const e in r)o.removeObserver(e,t,i);else o.listeners.remove(e,t,i)}get(e){return this.val[e]}change(e,t,i){const o=this,r=o.val[e];(i||r!=t&&o.get("active"))&&(o.val[e]=t,o.listeners.trigger(e,[e,t,r]))}}class $t{constructor(e,t){this.s=[],this.ie=e,this.display=t}add(e){nt.private(e).isSelected=!0,this.s.push(e)}remove(e){const{s:t}=this;nt.private(e).isSelected=!1,t.splice(t.indexOf(e),1)}select(e){const t=this.display.getZoomlevel(),i=this.ie.getLayer(e);if(t>=(null==i?void 0:i.min)&&t<=(null==i?void 0:i.max))return this.clearSelected(),this.add(e),!0}getCurSelObj(){return this.s[0]}unselectFeature(e){let t,i=this;const o=i.ie;if(e||!o._config.keepFeatureSelection){if(t=i.getCurSelObj()){const e=nt.private(t,"xt");e&&e.clear(),o.listeners.trigger("featureUnselected",{featureUnselected:!0})}i.clearSelected()}}clearSelected(){var e;let t,i=this.s;const o=this.ie;return o.listeners.trigger("_clearOverlay"),i.forEach((e=>{const i=nt.getTool(e,"deHighlight");i&&(t=e,i(e,!0),this.remove(e)),nt.private(e).isSelected=!1})),i.length=0,o.transformer.hide(),null===(e=o._rngSel)||void 0===e||e.hide(),t}}const ei="@ns:com:here:editor";class ti{constructor(){this.steps={}}clone(e){return e?JSON.parse(JSON.stringify(e)):e}add(e,t,i){const o=this.steps[e]||{},r=o[t]=o[t]||{},s=i.id;if(!r[s])return r[s]=i,this.set(e,o),!0}remove(e,t,i){try{let o=this.steps[e][t],r=i.id;if(o[r])return delete o[r],this.set(e,this.steps[e]),!0}catch(e){}return!1}get(e){return this.clone(this.steps[e])}set(e,t){this.steps[e]=this.clone(t)}clear(){const e=this.steps;for(const t in e)delete e[t]}}const ii=e=>e.properties[ei],oi=e=>{const t=e.toJSON(),i=ii(t);return t.class=e.class,i&&(delete i.hovered,delete i.selected),t},ri=e=>{const t=ii(e);return t.created&&t.removed},si=e=>{const t=ii(e);return t.modified||t.removed||t.split||t.created};class ni{constructor(e){this.current=0,this.total=0,this.changes={},this.cached=null,this._a=!0;this.iEdit=e,this.storage=new ti}updateObservers(e){let t=this,i=t.iEdit.observers;i.change("changes.length",t.getLength()),i.change("history.length",t.total),i.change("history.current",t.current,e)}getTotal(){return this.total}getLength(){const e=this.getChanges();let t=0;for(const i in e)for(const o in e[i])ii(e[i][o]).origin||t++;return t}remove(e){const t=e.getProvider().id;this.storage.remove(this.current,t,e)&&(delete this.changes[t][e.id],this.cached=null)}origin(e,t){const i=e.id,o=e.getProvider().id,r=this.storage,s=this.changes,n=this.current,a=r[n];let l=s[o];if(l||(l=s[o]={}),l[i]=e,!a||!a[o]||!a[o][i]){const i=oi(e),s=ii(i);t&&(s.removed=!0),s.origin=!0,r.add(n,o,i)}}saveChanges(){const e=this;let t=0;if(e.active()){e.cached=null;let i=(e=>{const t={};let i=0;for(const o in e){t[o]={};for(const r in e[o])t[o][r]=oi(e[o][r]),i++}return{data:t,length:i}})(e.changes);if(t=i.length){const t=++e.current;e.storage.set(t,i.data),t>e.total?e.total++:e.total=t,e.iEdit.dump("History step saved...",t,"warn"),e.changes={},e.updateObservers()}}return t}getHistoryFeature(e,t=this.current){const i=this.storage.get(t),o=e.getProvider().id;return i&&i[o][e.id]}getChanges(){if(!this.cached){const e=this.storage,t=this.current,i={};for(let o,r=1;r<=t;r++){o=e.get(r);for(const e in o)for(const t in o[e]){const r=o[e][t];ri(r)?i[e]&&i[e][t]&&delete i[e][t]:si(r)&&((i[e]=i[e]||{})[t]=r)}}this.cached=i}return this.cached}clear(){const e=this;e.storage.clear(),e.current=0,e.total=0,e.changes={},e.cached=null,this.updateObservers(!0)}import(e){const i=this,o=i.storage;for(const r in e)for(const s in e[r]){const n=i.iEdit.objects.get(s,r);if(n)i.origin(n);else{const n=t.JSUtils.extend(!0,{},e[r][s]),a=n.properties[ei]=n.properties[ei]||{};a.removed=!0,a.origin=!0,o.add(i.current,r,n)}}i.total=++i.current,o.set(i.current,e),i.recoverViewport(0)}recoverViewport(e,t){const i=+new Date,o=this.current+e,r=this.storage.get(o),s=this.iEdit;if(this.cached=null,o>=0&&o<=this.total){s.objects.selection.unselectFeature(),s.dump(arguments,o,"REBUILDED VIEW IN",+new Date-i,"ms"),s.objects.selection.getCurSelObj()&&s.listeners.trigger("featureUnselected",{featureUnselected:!0}),s.objects.selection.clearSelected();const e=[];for(let t in r){let i=r[t];for(let o in i){let r=i[o];e["NAVLINk"==r.class?"unshift":"push"]({provider:s.getProviderById(t),feature:r})}}for(let{feature:t,provider:i}of e){let e=i.search(t.id);e&&i.removeFeature(e);const o=ii(t);if(!o.removed){t=s.objects.create({feature:t,provider:i,history:!0});for(const e in o)t.properties[ei][e]=o[e];s.setStyle(t)}}this.current=o,t||this.updateObservers()}}active(e){return arguments.length&&(this._a=!!e),this._a}batch(e){const t=this.active();this.active(!1),e(),this.active(t)}}let ai,li;class ci{constructor(e){this.type="CONTAINER",this.length=0,this._e=e}push(e,t){const i=this,o={};let r,s;t&&"Feature"==t.type&&(e=arguments,t=ai),e.length==ai&&(e=[e]);const n=i._e;for(let a of e)(s=n.objects.add(a,t,o))&&(a=s,r=!0),i[i.length++]=a;return r&&n.objects.history.saveChanges(),i.length}forEach(e,t){for(let i=0;i<this.length;i++)e.call(t,this[i],i)}toArray(){const e=[];for(let t=0;t<this.length;t++)e[e.length]=this[t];return e}highlight(){const e=this;let t,i=e.length;for(;t=e[--i];)nt.highlight(t)}remove(){const e=this,t=e._e.objects;let i=!1,o=e.length;for(;o--;)i=t.remove(e[o],{animation:!1,save:!1})||i,delete e[o];i&&(e.length=0,t.history.saveChanges())}transform(){const e=this;e.length&&e._e.transformer.show(e.toArray())}unHighlight(){const e=this;let t,i=e.length;for(;t=e[--i];)nt.deHighlight(t)}unhighlight(){return this.unHighlight()}pop(){const e=this;if(e.length){const t=e[--e.length];return delete e[e.length],t}}getBBox(){const e=this,t=[1/0,1/0,-1/0,-1/0];let i;for(let o=0;o<e.length;o++)i=e[o].getBBox?e[o].getBBox():e[o].bbox,i[0]<t[0]&&(t[0]=i[0]),i[1]<t[1]&&(t[1]=i[1]),i[2]>t[2]&&(t[2]=i[2]),i[3]>t[3]&&(t[3]=i[3]);return e.length?t:[0,0,0,0]}}const di=(e,t,i)=>({geometry:{coordinates:t,type:e},type:"Feature",properties:i||{}}),hi=(e,t)=>{for(let i=0;i<e.length;i++)e[i].opacity!=li&&(e[i]._opacity=e[i]._opacity||e[i].opacity),e[i].opacity=t;return e},pi=e=>{for(let t=0;t<e.length;t++)e[t].opacity=e[t]._opacity==li?1:e[t]._opacity,delete e[t]._opacity;return e},gi=e=>e=e?e instanceof Array?e:[e]:li,ui=(e,t,i,o)=>[[[e,t],[e,o],[i,o],[i,t],[e,t]]];class Ai{constructor(e){this.layer=e}getProvider(){return this.layer.getProvider()}hideFeature(){const e=this,t=e.layer;let i;for(let o=0;o<arguments.length;o++)i=arguments[o],i instanceof ci&&(i=i.toArray()),i instanceof Array?e.hideFeature.apply(e,i):t.setStyleGroup(i,hi(t.getStyleGroup(i),0))}showFeature(){const e=this,t=e.layer;let i;for(let o=0;o<arguments.length;o++)i=arguments[o],i instanceof ci&&(i=i.toArray()),i instanceof Array?e.showFeature.apply(e,i):t.setStyleGroup(i,pi(t.getStyleGroup(i)))}addFeature(e,t){const i=this.layer.addFeature(e,gi(t));return i.properties["@ns:com:here:editor"]=i.properties["@ns:com:here:editor"]||new lt,i}addCircle(e,t,i){return this.addFeature(di("Point",e,i),t)}remove(e){const t=this.layer;if(e instanceof ci)for(let i=0;i<e.length;i++)t.removeFeature(e[i]);else e&&t.removeFeature(e)}setFeatureCoordinates(e,t){e._provider.setFeatureCoordinates(e,t)}getStyles(e){return this.layer.getStyleGroup(e)}setZLayer(e){let t=this.layer.getStyle();null==e?delete t.zLayer:t.zLayer=e,this.layer.setStyle(t)}modifyRect(e,t,i,o,r){this.setFeatureCoordinates(e,ui(t,i,o,r))}addRect(e,t,i,o,r){return this.addFeature(di("Polygon",ui(e,t,i,o),r))}addPolygon(e,t,i){return this.addFeature(di("Polygon",[e],i),t)}addSquare(e,i,o,r,s){const n=t.geotools.movePoint;return o^=0,this.addPolygon([n(e,i,-45+o),n(e,i,45+o),n(e,i,135+o),n(e,i,225+o),n(e,i,-45+o)],r,s)}addPath(e,t,i){return this.addFeature({geometry:{coordinates:e,type:"LineString"},type:"Feature",properties:i||{}},gi(t))}addPoint(e,t,i){t instanceof Array||(i=t,t=li);const o={geometry:{coordinates:e,type:"Point"},type:"Feature",properties:i||{}};return this.addFeature(o,gi(t))}addImage(e,t,i){return this.addFeature({geometry:{coordinates:e,type:"Point"},type:"Feature",properties:i||{}},gi(t))}}var fi="data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO8AAPACAvoCAvoMDPAODvASEvoXF/oZGfAdHfAkJPAqKv1BQf1KSv5QUP9dXf9paf9zc/95ef+Ghv+Njf+Skv+dnf+lpf+rq/vFxf3MzPzW1vfa2vvc3P3i4v7q6v/y8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACIALAAAAAAYABgAAAb/QJFwKAyBOpnMBhQiOp2hDSZSsVgqkYum+SR6LoJAoBMKecICCrkbbQQECwHZLFAkAoPtcxNeFARyZWcCBnECekMeboYGgXSEdYAdQyEXAYYCBWOCgI1wARRcGwOZgKVzg54BjRoiIRgBCqannJCACgEWZRMBCbMGm4+eAr4QHx8Pq78BHLXDjQgbHQzKpn/NwtaNHdPVgH+ondpyHsnDtNmdAQcbIby+1o6ppsUfr7Gz4M6muLoiGwRKfXPUQdzAVq4sYdIXgoPBBaC4iPDg4FImhh3eNMI1YBIRPpcKMEwF8ZDEIhvcRAqXABgBRE88WAgTzIMYARXWdEGJQUKVDStZYO6kdCRJByY7gwAAOw==";let yi;const vi="#111111",mi=e=>e.properties["@ns:com:here:editor"].hovered,Si=e=>e.properties["@ns:com:here:editor"].selected,_i=(e,t,i)=>"function"==typeof e?e(t,i):e,Li=e=>[{zLayer:e=>e.properties.zLayer,zIndex:999990,type:"Line",strokeWidth:2,stroke:"#FF0000",altitude:!!e}],bi=e=>{const t=[{zIndex:4,type:"Circle",strokeWidth:2,stroke:"#FF0F00",radius:20,pointerEvents:!1,altitude:e}];return e&&t.push({zIndex:3,type:"VerticalLine",stroke:vi,altitude:({properties:e})=>e[e.parentType].altitude},{zIndex:1,type:"Circle",radius:4,fill:vi,opacity:.6,zLayer:({properties:e})=>e[e.parentType].zLayer}),t},Ei=e=>e?[{zLayer:e=>e.properties.zLayer,zIndex:999992,type:"Sphere",radius:8,fill:"#FF0000",stroke:"#FF0000",altitude:({properties:e})=>e[e.parentType].altitude},{zLayer:e=>e.properties.zLayer,zIndex:999991,type:"VerticalLine",stroke:"#000",altitude:!0},{zIndex:999990,type:"Circle",radius:4,fill:vi,opacity:.6,altitude:0,zLayer:e=>e.properties.zLayer}]:[{zLayer:e=>e.properties.zLayer,zIndex:999991,type:"Circle",radius:8,fill:"#FF0000",stroke:"#FF0000"},{zLayer:e=>e.properties.zLayer,zIndex:999992,type:"Circle",radius:5,fill:"#FF0000",stroke:"#FFFFFF",strokeWidth:2}],xi=e=>[{zIndex:0,type:"Circle",radius:13,fill:"#ffffff",stroke:vi,strokeWidth:1.5},{zIndex:1,type:"Text",fill:vi,font:"normal 16px Arial",text:e}],ki=e=>[{zIndex:1,type:"Image",src:e,width:24,height:24,alignment:"map",rotation:e=>e.properties.rotation}];class Ci extends i.XYZLayerStyle{constructor(){super(...arguments),this.styleGroups={ADDRESS_LINE:Li(),ADDRESS_LINE_3D:Li(!0),ADDRESS_ROUTING_POINT:Ei(),ADDRESS_ROUTING_POINT_3D:Ei(!0),ADDRESS_SELECTOR:bi(),ADDRESS_SELECTOR_3D:bi(!0),PLACE_LINE:Li(),PLACE_LINE_3D:Li(!0),PLACE_ROUTING_POINT:Ei(),PLACE_ROUTING_POINT_3D:Ei(!0),AREA_SHAPE:[{zIndex:0,zLayer:({properties:e})=>e.AREA.zLayer,type:"Circle",strokeWidth:2,stroke:vi,radius:e=>mi(e)?8:6,fill:(e,t)=>{const{fill:i,stroke:o}=e.properties.AREA.style[0];return mi(e)?vi:_i(i,e.getArea(),t)||_i(o,e.getArea(),t)}}],AREA_VIRTUAL_SHAPE:[{zIndex:0,zLayer:({properties:e})=>e.AREA.zLayer,type:"Circle",strokeWidth:1,fill:vi,stroke:vi,radius:e=>mi(e)?6:4}],AREA_HEIGHT_KNOB:[{zIndex:4,type:"Sphere",altitude:!0,fill:(e,t)=>{const{fill:i,stroke:o}=e.properties.AREA.style[0];return mi(e)?"#777":_i(i,e.getArea(),t)||_i(o,e.getArea(),t)},radius:10,offsetZ:50},{zIndex:3,type:"VerticalLine",stroke:"#000",offsetZ:50}],LINE_SHAPE_3D:[{zIndex:4,type:e=>Si(e)?"Sphere":null,radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return 6+(r/2+4^0)},fill:"red",opacity:.5,strokeWidth:5,altitude:!0},{zIndex:3,type:"Sphere",alignment:"map",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return r/2+4^0},stroke:(e,t)=>{const i=e.properties.LINE.style.filter((e=>"Line"==e.type));return i[i.length-1].stroke||"BLACK"},fill:(e,t)=>{let i=e.properties.LINE.style;return i.length>1?i[0].stroke:"#e9e9e9"},strokeWidth:2,altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vi,opacity:.6,zLayer:({properties:e})=>e.LINE.zLayer}],LINE_SHAPE:[{zIndex:0,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return r/2+4^0},stroke:(e,t)=>{var i;const o=e.properties.LINE.style.filter((e=>"Line"==e.type));return(null===(i=o[o.length-1])||void 0===i?void 0:i.stroke)||"BLACK"},fill:(e,t)=>{let i=e.properties.LINE.style;return i.length>1?i[0].stroke:"#151515"},strokeWidth:2},{zIndex:4,type:e=>Si(e)?"Circle":null,radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return 6+(r/2+4^0)},stroke:"red",strokeWidth:3}],LINE_VIRTUAL_SHAPE:[{zIndex:0,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return r/2^0},fill:"#151515"}],LINE_VIRTUAL_SHAPE_3D:[{zIndex:3,type:"Sphere",radius:(e,t)=>{const{style:i}=e.properties.LINE,[r]=o.styleTools.getLineWidth(i,e.getLine(),t,0);return r/2^0},fill:"red",altitude:({properties:e})=>{var t;return null===(t=e.LINE.style.find((e=>e.altitude)))||void 0===t?void 0:t.altitude}},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vi,opacity:.6,zLayer:({properties:e})=>e.LINE.zLayer}],MARKER_SELECTOR:bi(),MARKER_SELECTOR_3D:bi(!0),PLACE_SELECTOR:bi(),PLACE_SELECTOR_3D:bi(!0),NAVLINK_SHAPE:[{zIndex:0,type:e=>e.properties.isConnected?"Rect":"Circle",width:e=>mi(e)?18:12,rotation:45,radius:e=>mi(e)?9:6,strokeWidth:2,fill:(e,t)=>e.isOverlapping()?"#FFFFFF":_i(e.properties.NAVLINK.style[0].stroke,e.getLink(),t),stroke:e=>e.isOverlapping()?"#FF0000":"#FFFFFF"},{zIndex:1,type:e=>Si(e)?"Circle":null,radius:e=>mi(e)?18:14,stroke:"red",strokeWidth:3}],NAVLINK_SHAPE_3D:[{zIndex:0,type:e=>e.properties.isConnected?"Box":"Sphere",width:e=>mi(e)?18:12,rotation:45,radius:e=>mi(e)?9:6,strokeWidth:2,fill:(e,t)=>e.isOverlapping()?"#FFFFFF":_i(e.properties.NAVLINK.style[0].stroke,e.getLink(),t),stroke:e=>e.isOverlapping()?"#FF0000":"#FFFFFF",alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vi,opacity:.6,zLayer:({properties:e})=>e.NAVLINK.zLayer}],NAVLINK_VIRTUAL_SHAPE:[{zIndex:1,type:"Circle",radius:(e,t)=>{const{style:i}=e.properties.NAVLINK;let[r]=o.styleTools.getLineWidth(i,e.getLink(),t,0);return r/5},opacity:.7,fill:vi,stroke:vi,strokeWidth:2}],NAVLINK_VIRTUAL_SHAPE_3D:[{zIndex:1,type:"Sphere",radius:(e,t)=>{const{style:i}=e.properties.NAVLINK;let[r]=o.styleTools.getLineWidth(i,e.getLink(),t,0);return r/5},opacity:.7,fill:vi,stroke:vi,strokeWidth:2,alignment:"map",altitude:!0},{zIndex:2,type:"VerticalLine",stroke:"#000"},{zIndex:9e5,type:"Circle",radius:4,fill:vi,opacity:.6,zLayer:({properties:e})=>e.NAVLINK.zLayer}],NAVLINK_DIRECTION_HINT_1WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACUcHCMfICMgICklJSsnKS4qKzMvLzMvMTo3OD05OlpXWGVjY2pnZ25rbHFub5mXmJ6dncXExMjHx9bV1eXl5e7u7vHx8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABkALAAAAAAfAAwAAAVcYCaO5FgUZaquo7EQyMDOQ20PBGVFikHMKkHDQSQ+KpjkxEE4BIAjwSVJrVItkIQPKrV6qxJGU7bqfr/hMct8TmK1P6CwaEQqmU6o6GbL7XpxeiwuMGSCMwQohyEAOw==",rotation:e=>e.properties.bearing,width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_2WAY:[{zIndex:1,type:"Image",src:"data:image/gif;base64,R0lGODdhHwAMAMQAAAAAACMeISMfHyQhISklJisnKS0pKjIuLjMvMUNAQElFRVJPUG5rbHh1do2LjJORkrWztM/OztbW1uvr6////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABUALAAAAAAfAAwAAAV6YCWOpBgYoxGUbEsWhnKMh2IUbl4dBBNRicAgkKBEGISZTjQ4IB4TitTBqDqklMkDcRi4bgsIdkwmQxawkQBBaEjK8LikQUAIBDx3fD+eJwUpBWF8cGdpLU1PUVNVDFdSWlxeSzs9P0FDRUdJlCwwMjQ2OJ0uJykrSyEAOw==",rotation:e=>e.properties.bearing,width:31,height:12,alignment:"map"}],NAVLINK_DIRECTION_HINT_BLOCKED:[{zIndex:1,type:"Image",src:fi,rotation:90,width:24,height:24,alignment:"map"}],NAVLINK_DIRECTION_HINT_A:xi("A"),NAVLINK_DIRECTION_HINT_B:xi("B"),NAVLINK_DIRECTION:[{zIndex:0,type:"Image",src:"data:image/gif;base64,R0lGODdhEAAcALMAAAAAACgbGxwcHCMfHyMfICMhISsrK////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAAAgALAAAAAAQABwAAAQ/EMlJq5WE3Jt3HdngTVk3FiVRjGApbmkKx2ZFy9Qd53pJ9jggjjfk7Dy0URJ5nBUtS6eP+bQ1jVXiVFrDbiURADs=",width:16,height:28,rotation:e=>-e.properties.bearing,opacity:.7,alignment:"map"}],NAVLINK_DIRECTION_NONE:[{zIndex:0,type:"Image",src:fi,width:24,height:24,rotation:90,alignment:"map"}],TURN_RESTRICTION_START:[{type:"Image",zIndex:1,src:"data:image/gif;base64,R0lGODdhJAAUAMQAAAAAAAAA/wBAvwBA/wBNzBRO2ABV/wtV2gxVzgdW0wpX1ApY1Qpa3BJbyABd0Qtd4wtf6Ath6wBmzABm/wBt2wCAgACA/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABgALAAAAAAkABQAAAW/ICZiC6Ocijmu43KaqMq+aMwwT6Tv0fPANZlIAQGmaidSjeRCniKK4aPWvNFYypeveZpijqjH4quYpm5oXGna5Lq+XCHZGUtKa2Z8dKXgBvcjZVRODGOBeUheKwuIdIaHdIIzjUhvfJRdgHeRfZpfmJKXnCePm06KkKOFi6CoIoyjoYF+dZODnVeBqnafeoJhY5lnaWo4t529KFUwqzMxW3pDRX9UTAvXcJERpS5GLzc5PDo+3kdYX0ZyWHUxpSEAOw==",width:36,height:20,rotation:e=>e.properties.rotation,alignment:"map"}],TURN_RESTRICTION_LINE:[{type:"Line",zIndex:0,strokeWidth:5,strokeLinecap:"round",stroke:e=>"TURN_RESTRICTION_ALLOWED"==e.properties.sign?"#0000ff":"#ff0000"}],TURN_RESTRICTION_ONEWAY:ki(fi),TURN_RESTRICTION_FORBIDDEN:ki("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAO0AAO4ACPAAAPYlK/YpL/YrMO4sMu9VV/tVV/xWWfxYWu9aW/BaXPBkZvBnafBpav9zdf93efOOj/+Oj/OPkP+PkP+RkvOSk/SenvSfoPSjo/WnqPWpqfe/v/XDxP/Dw/bHyPnOzvnR0fni4v309P749////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKACgALAAAAAAYABgAAAb2QJRwKDyRRp/PiHQiOp2lz2VhGAwIi8un9CSeRpKAeEyOjJrPE2gQEAQYGA4HwxgPQOihOnAIOEQlJ4InJSIPfAF4RCMDfRmDkIMZfAMjQyURYo+RnJMBEVwoH2IOnKYnhwEeKCcXYiKnnCJiF0YLAQiBsZF1CkcFARW7nBgBBCIhbBvDkR1iScrMkM4BSgYBE9KDxcckCri60g0BCUyuAbDSI2IWTaN+2hBiqyiYYsvDGmKgQyKNAfhObaAkwgsIRA5GmIBUSF4fRQbZiGmAoUMHDOPGQHRyQkQmMiAjwOpyyQOFBATEEEhAwUMokl6OhFDChGQQADs="),TURN_RESTRICTION_ALLOWED:ki("data:image/gif;base64,R0lGODdhGAAYANUAAAAAAAA/qgBFqgBLrABTrgBWsQBZrwBdsQJlswBnuAtnsxFntBNoswBpuR5qtSNrtClstj10uEt+w0+AxFCBxG6Pwm6TzXWTxHKVznuXxnyYxoGax4OcyIym1Y+p15Cp1papz5ms0KGy06q41q672LG+2bTA2rzH3r7I3r/J4MLL37/M6MHO6cXO4MfQ4c7V5tDX59DY59Tb6d7j7uDl7uLm8OXp8uns9PHz9/P0+f///wAAAAAAAAAAAAAAAAAAACH5BAkKADsALAAAAAAYABgAAAb/wJ1wKNTVZK0WrKYjOp05VGfSOBwaFA8K9yTqXpgB4YBgMBAHwgDzaj51rALh4VgoEAjFwvEYs9xDcAIKD3iGCw90CA8KAn9ELwV6hngKBwNiDmUIBS9DOBZzlGUHFSUjHKJ9GFw7KAOFo3cRMzo6ILCLBCo7Oh0EEA7Cww4QaDK2IbAOBB5GElYE0tPSlwNttwMQBxM1MAkIFRoZ4xrm4xsXGje2IAIODTEuBQg2tvf4+bYiBgctLgTq6Rt4j98BFS/AXeCwgYPDhw3NsdOhDN4SaGmoTbOGTdm2br6AERtm7AAyigLoEPjQ5EQuWQhoJcv1YEAKIaAIaKLEoJQJThKpCjHDkGNIJAYLRi04ICDTpk5eWAyKdSiRJgcKAjzyskIOnTuU+BAosNXJFwtiyAhDo4YNoC44pEhIIC2BhA5bunTRQeNFkhc03hIJAgA7"),TURN_RESTRICTION_PEDESTRIAN:ki("data:image/gif;base64,R0lGODdhGAAYAOYAAAAAAO0AAO4ACPAAAPYlK/YpLy0rK/YrMO4tMjMxMUVDRFRTU+9UVvtVV/xVWF9WVvxYWvBZW+9bXWNdXfBjZe9kZmhnZ/BnafBpa2xsbHJxcv9zdf93eX18fISEhIuLi/OOj/+Oj/OPkP+PkP+RkvOSk5iVlZ2dnfSenvSkpPWpqaysrLO0tLy8vPe/v8PDw//Dw/XExMjHyPbHyPnOzsbPz8/Pz8fQ0PnR0dPT09zc3Pri4uPj4+rq6vLy8v3z8////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkKAEEALAAAAAAYABgAAAf/gEGCg4JAOzgxMzg7QISOjj8xJBAHAwMFECQxP4+EQDQbAaKjpBs4jY9AMAOjDCApKSIMowMwqIOqAQgBFDQ/QMBAPzQUugG2hDQDuynBzsEougM4gz+hASjP2kDRARycQS6iFdvbFAIBMUFAIaI4NT3OPNs0oiSGDQEMQCwAK8EvFuh49iNCAAiHCAQoAYxHBwUtgOnIwAJYDx9ARAQ4gGOGKBXOcmTw0GLFBwAedACYAERFgAExYnx85iPDAgAADAB48cFEy5cxcChkGIxFghM5ZNiwoMFZiQAEFuWTACyghoE9WKzIgBFYwYOM2gXAceNBjmA+WrCIF6xegHvhUERhKKftgih1QayJakYXWLcN4ILU25WNbjQE0zzBMIbh1DMadnchU8xKlIQSKlSUkEBrsqNP10iVOtWpmosRDRRCdUDCReDSuHbQiEmDUelAADs="),TRANSFORMER_TRANSLATE_KNOB:[{type:"Circle",zIndex:0,zLayer:1e4,stroke:"#FFFFFF",fill:"#010B1E",strokeWidth:3,opacity:.3,radius:9}],TRANSFORMER_ROTATE_KNOB:[{type:"Image",zIndex:4,zLayer:1e4,src:({properties:e})=>e.hovered?"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAELHhAZKyApOTA4R0BHVlBXZGBmcnB1gICFjo+UnK+yuL/Cx8/R1d/g4+/w8f///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABEALAAAAAATABMAAAVpYCSOEWSaZDqeLKqWbQylck2aTgM5SqI4rZWJIUAEjkdEEAZhHAUHxkEQOLCYzacO8qBuYw+G+JsIJGq1hhktK5/ZrUGAcW0FCAtIwxAoXLEQB0hHBQ9/gA0JinSHgGw0cDMvaC+QJy8hADs=":"data:image/gif;base64,R0lGODdhEwATAMQAAAAAAAAKIAELHhEaLCEqOjE5SEFIVlFYZXF2gYCFj5CVnaCkq7CzucDDx9DS1uDh5PDx8v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAkAABIALAAAAAATABMAAAVpoCSOkmCaZDqeLKqWbSykck2aRCEQSIIQrZXJAFFEjkdFECYwHCELwwISWbCYzadOMKBuYwOD+JuIJGq1ghktK5/ZrUfEcG1FHAdBgRFpXLECC0hHDQN/gAUJinSHgGw0cDMvaC+QJy8hADs=",width:18}],TRANSFORMER_SCALE_KNOB:[{type:"Circle",zIndex:4,zLayer:1e4,fill:({properties:e})=>e.hovered?"white":"black",radius:9},{zIndex:5,zLayer:1e4,type:"Text",fill:({properties:e})=>e.hovered?"black":"white",font:"20px Arial",text:""}],TRANSFORMER_SCALE_BOX:[{type:"Line",zIndex:0,zLayer:1e4,strokeDasharray:[4,4],strokeWidth:2,stroke:"#010B1E"}],RANGESELECTOR_LINE:[{zIndex:0,type:"Line",stroke:"white",strokeWidth:23},{zIndex:1,type:"Line",stroke:"grey",strokeWidth:20},{zIndex:2,type:"Line",stroke:"white",strokeWidth:3,strokeDasharray:[5,4],strokeLinecap:"butt"}],RANGESELECTOR_RANGE_MARKER:[{zIndex:110,type:"Rect",fill:"#fff",width:2,height:20,alignment:"map",offsetY:8},{zIndex:111,type:"Circle",fill:"#000",radius:7,alignment:"map",stroke:"#fff",strokeWidth:1,offsetY:20},{zIndex:110,type:"Circle",stroke:"#fff",radius:5,alignment:"map"}],RANGESELECTOR_RANGE_LINE:[{zIndex:4,type:"Line",strokeWidth:9,opacity:.75,stroke:"#fff"}],UNKNOWN:[{zIndex:0,type:"Circle",strokeWidth:1,stroke:"#FF0000",fill:"#0000FF",radius:10}]}}assign(e){var t,i;const{styleGroups:o}=this,{properties:r}=e;let s=e.class||r.type,n=!1;if("LINE_SHAPE"==s||"LINE_VIRTUAL_SHAPE"==s||"NAVLINK_SHAPE"==s||"NAVLINK_VIRTUAL_SHAPE"==s?n=null===(t=(r.LINE||r.NAVLINK).style.find((e=>e.altitude)))||void 0===t?void 0:t.altitude:"MARKER_SELECTOR"==s?(n=r.MARKER.altitude,n==yi&&(n=!!e.geometry.coordinates[2])):n=null===(i=r[r.parentType])||void 0===i?void 0:i.altitude,n){const e=s+"_3D";s=o[e]?e:s}return o[s]!==yi?s:"UNKNOWN"}}class Pi extends i.LocalProvider{constructor(e={}){e.name="EOP",super(e),this.id="EOP-"+this.id}}let Ii;let Ri;const Oi="pointerenter pointerleave pointerup pressmove pointerdown dbltap",wi="addLayer removeLayer",Fi=e=>e.class;class Ni{constructor(e,o){this.listen=!1;const r=this;r.iEdit=e,r.display=o,r.history=new ni(e),r.selection=new $t(e,o);const s=(e=>{const t=new Pi;return t._e=()=>e,new i.TileLayer({name:"EditorOverlay",min:1,max:28,style:new Ci,provider:t})})(e);r.overlay=new Ai(s);let n=new t.Map([[s.id,s]]);this.layers=n,o.addLayer(s,(e=>{let t,i=e.length;for(;i--;)if((t=e[i].getProvider())&&"NAVLINK"==t.class)return i+1;return e.length})(o.getLayers())),r.arrangeOverlay=r.arrangeOverlay.bind(r),r.pointerListener=r.pointerListener.bind(r),e.listeners.add("_layerAdd",(e=>{const t=e.detail.layer;n.set(t.id,t);const i=n.values().filter((e=>e!==s));s.min=Math.min(...i.map((({min:e})=>e))),s.max=Math.max(...i.map((({max:e})=>e)))})),e.listeners.add("_layerRemove",(t=>{const i=t.detail.layer;n.delete(i.id);const o=e.objects.selection.getCurSelObj();o&&e.getLayer(o)==i&&e.objects.selection.clearSelected()})),r.onMVCStart=r.onMVCStart.bind(r)}onMVCStart(){this.selection.unselectFeature()}splitLinkAt(e){return((e,i)=>{const o=i.link;let r=i.index;const s=i.preferSegment,n=i.avoidSnapping;let a=o.coord();const l=a.length-1,c=it._props(o),d=o.getProvider().readZLevels(o),h=e._config.snapTolerance,{point:p,ignoreZ:g}=i;let u,A,f;if(p&&(u=p[0],A=p[1],f=p[2]||0),0===r||r===l||u==a[0][0]&&A==a[0][1]||u==a[l][0]&&A==a[l][1])return!1;if(e.objects.history.origin(o),r===Ii){const t=e.map.searchPointOnLine(a,p,h,s,Ii,g);if(r=null==t?void 0:t.index,(0===r||r===l)&&t.existingShape)return!1;r=it.addShp(o,[u,A,f],null,!0,null,s),a=o.coord()}it.deHighlight(o);const y=o.getProvider(),v=(i,o,r)=>{const s=t.JSUtils.extend(!0,{},c),n={type:"Feature",geometry:{type:"LineString",coordinates:i},properties:s};return delete s["@ns:com:here:editor"],e.objects.create({feature:n,provider:y,zLevels:o,preferIndex:r})},m=v(a.slice(0,r+1),d.slice(0,r+1),n&&r),S=v(a.slice(r),d.slice(r),n&&0);let _=pe(a[r],a);_>.995&&(_=1);const L=ge(a,a[r]).offset,b=it.getConnectedObjects(o);for(var E in b){const e=b[E],t=Ie.getRoutingPosition(e),i=L>ge(a,t).offset?m:S;Ie.connect(e,i,t),Ie.markAsModified(e,!1)}return e.hooks.trigger("Navlink.split",{link:o,index:r,children:[m,S],relativePosition:_},y),o.editState("split",Date.now()),e.objects.remove(o,{animation:!1,split:!0}),[m,S]})(this.iEdit,e)}destroy(){this.display.removeLayer(this.overlay.layer)}arrangeOverlay(e){const t=e&&e.detail.layer,i=this.display,o=this.overlay.layer;if(!i.getLayers)return;const r=i.getLayers();if(!(t.getProvider()instanceof Pi)){const e=r.map((e=>{const t=e.getProvider();return t&&t.class})).indexOf("NAVLINK");i.removeLayer(o),e>=0?i.addLayer(o,e+1):i.addLayer(o)}}pointerListener(e){const t=this.iEdit,i=e.target,o=e.type;if(i){const t=e.detail.layer;if(!this.layers.has(t.id))return;const r=nt.getEventListener(i,o);if(r)return e.stopPropagation(),r.apply(i,arguments)}"pointerup"!=o&&"dbltap"!=o||t.objects.selection.unselectFeature("viewportChange"==t._config.keepFeatureSelection),t.listeners.trigger(e,null)}listenDisplay(e){const t=this.display,i=this.listen,o=this.pointerListener,r=this.arrangeOverlay;e?i||(this.listen=!0,t.addEventListener("mapviewchangestart",this.onMVCStart),t.addEventListener(Oi,o),t.addEventListener(wi,r)):i&&(this.listen=!1,t.removeEventListener("mapviewchangestart",this.onMVCStart),t.removeEventListener(Oi,o),t.removeEventListener(wi,r))}get(e,t){const i=this.iEdit;return t?"object"!=typeof t&&(t=i.getLayer(t)):t=i.getLayer(e),"object"!=typeof e&&t&&(e=t.search(e)),e&&t?e:null}getInBBox(e,t,i){e||(e=[(e=this.display.getViewBounds()).minLon,e.minLat,e.maxLon,e.maxLat]);const o=1/Math.pow(10,this.iEdit._config.intersectionScale);e=[e[0]-o,e[1]-o,e[2]+o,e[3]+o];const r=[];let s,n=(t=t||this.layers.values())instanceof Array?t:[t];for(let t of n)if(s=t.search(e))for(let e of s)i&&!i(e)||r.push(e);return r}remove(e,t){const i=this;let o=!1;if((t=t||{}).split||!i.iEdit._config.editRestrictions(e,r.REMOVE)){const r=null==t.animation||t.animation;r&&nt.private(e,"isSelected")&&i.selection.clearSelected(),Fi(e)&&(i.history.origin(e),nt.markAsRemoved(e,r),t.save&&i.history.saveChanges(),o=!0);const s=e.getProvider();return e.editState&&!e.editState("created")&&s.blockFeature(e,!0),s.removeFeature(e),o}}add(e,t,i){const o=this.iEdit;if(!e.getProvider()&&("string"==typeof t?t=this.layers.get(t):t||(t=o.getLayerForClass(Fi(e))),t)){const o=e.id,r=o!=Ri&&t.search(o);return o!=Ri&&r?r:this.create({feature:e,provider:t.getProvider(),idMap:i})}}create(e){const t=this.iEdit,i=t.objects.history,o=[];let r=e.feature;Array.isArray(r)||(r=[r]);const s=e.idMap||{},{provider:n,preferIndex:a,history:l,zLevels:c}=e,d=e=>(l&&n.blockFeature(e,!1),e=n.addFeature(e),e=n.search(e.id),l||(e.editState("created",Date.now()),nt.markAsModified(e,!1),i.origin(e,!0),c&&i.batch((()=>{n.writeZLevels(e,c)}))),o.push(e),e);for(let e=0;e<r.length;e++){let c,h=r[e],p=h.id;if(l||n.enforceRandomFeatureId&&(h.id=Ri),h=n.prepareFeature(h),c=n.detectFeatureClass(h),p==Ri&&(p=h.id),s[p]=h.id,h=d(h),"NAVLINK"===c){if(h.geometry.coordinates.forEach((e=>e[2]||(e[2]=0))),!l){!1===it.fixGeo(h,Ri,Ri,a)&&(i.remove(h),n.removeFeature(o.pop()))}}else if("PLACE"===c||"ADDRESS"===c){let e=Ie.getRoutingData(h),r=e.link;if(s[r]){const t=Ie.getRoutingProvider(h),o=t&&t.search(s[r]);i.batch((()=>{h.getProvider().writeRoutingPoint(h,o,e.position)}))}"ADDRESS"!==c||l||(Ie.connect(h),h.getLink()||(i.remove(h),n.removeFeature(o.pop()),t.dump("No Link found within "+t._config.maxRoutingPointDistance+" meters","warn")))}}return o.length>1?o:o[0]}getNearestLine(e,o,r){const{iEdit:s}=this;r=t.JSUtils.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},r||{});const n={line:null,point:null,distance:1/0,shpIndex:null,segment:null};let{maxDistance:a}=r,l=a<1/0?t.geotools.getPointBBox(e,a):null;o instanceof i.EditableFeatureProvider&&(o=this.getInBBox(l,o));for(let i of o){if(r.ignore&&r.ignore(i))continue;const{bbox:o}=i;if(a==1/0||y(l[0],l[2],l[1],l[3],o[0],o[2],o[1],o[3])){const o=s.map.searchPointOnLine(i.geometry.coordinates,e,-1,Ri,Ri,r.ignoreZ);(null==o?void 0:o.distance)<Math.min(n.distance,r.maxDistance)&&(n.point=o.point,n.distance=o.distance,n.shpIndex=o.existingShape?o.index:null,n.segment=o.index-Number(!o.existingShape),n.line=i,a=t.geotools.distance(o.point,e),l=t.geotools.getPointBBox(e,a))}}if(n.line){if(r.ignoreZ){const{line:e,segment:t,point:i}=n,o=e.geometry.coordinates;i[2]=ue(i,o[t],o[t+1])}return n}}searchLine(e,o,r,s){const{iEdit:n}=this;r=t.JSUtils.extend({maxDistance:1/0,shapeThreshold:0,ignoreZ:!1},r||{});const a={line:null,point:null,distance:1/0,shpIndex:null,segment:null};let{maxDistance:l,ignoreZ:c}=r,d=l<1/0?t.geotools.getPointBBox(e,l):null;o instanceof i.EditableFeatureProvider&&(o=this.getInBBox(d,o,(e=>"NAVLINK"==e.class)));const{display:h}=n,{x:p,y:g}=h.geoToPixel(e[0],e[1]),u=h._unprj(p,g,-1),A=h._unprj(p,g,1),f=t.vec3.sub([],A,u);for(let e of o){if(r.ignore&&r.ignore(e))continue;const{bbox:i}=e;if(!d||y(d[0],d[2],d[1],d[3],i[0],i[2],i[1],i[3])){const i=e.geometry.coordinates;let o,r=i[0],s=h._g2w(r[0],r[1],c?0:r[2]);for(let n=1;n<i.length;n++){r=i[n],o=s,s=h._g2w(r[0],r[1],c?0:r[2]);const[d,p]=t.vec3.sub([],o,s);if(!d&&!p)continue;const g=o,A=t.vec3.add([],o,[-p,d,0]),y=s,v=t.vec3.normalize([],t.vec3.cross([],t.vec3.sub([],y,A),t.vec3.sub([],g,A)));let m=E(f,u,v,g),S=h._w2g(m);m=b(g,y,m,!0);let _=h._w2g(m),L=t.geotools.distance(_,S);L<Math.min(a.distance,l)&&(a.point=_,a.distance=L,a.line=e)}}}return a.line?a:null}}class Mi{constructor(e,t){this.busy=null,this.display=t,this.iEdit=e,this.observers=e.observers,this.onStart=this.onStart.bind(this),this.onStop=this.onStop.bind(this),e.listeners.add("_layerAdd",(e=>{this.observers.change("ready",!1),this.display.setCenter(this.display.getCenter()),e.detail.layer.addEventListener("viewportReady",this.onStop)})),e.listeners.add("_layerRemove",(e=>{var t,i;e.detail.layer.removeEventListener("viewportReady",this.onStop),null===(t=this.busy)||void 0===t||t.delete(e.detail.layer),(null===(i=this.busy)||void 0===i?void 0:i.size)||this.iEdit.layers.length||this.observers.change("ready",!0)}))}onStart(){if(!this.busy){const e=this.iEdit.layers;this.busy=new t.Set(e),e.length&&this.observers.change("ready",!1)}}onStop(e){const t=e.detail.layer,i=this.busy;i&&(i.delete(t),i.size||(this.observers.change("ready",!0),this.busy=null))}start(){this.display.addEventListener("mapviewchangestart",this.onStart)}stop(){this.display.removeEventListener("mapviewchangestart",this.onStart)}}const Ti=["Navlink.split","Navlink.disconnect","Feature.remove","Coordinates.update"],ji=(e,t)=>{let i=e.__=e.__||String(1e9*Math.random()^0);return t&&(i+=";"+t.id),i};class Bi{constructor(e){this.h=new t.Listener(Ti),this.h.sync(!0),this.history=e,this.w=new Map}add(e,t,i){const o=ji(t,i);let r=this.w.get(o);return r||this.w.set(o,r=((e,t)=>{const i=(i,o)=>{t&&o!=t||e(i)};return i.h=e,i})(t,i)),this.h.add(e,r)}remove(e,t,i){return this.h.remove(e,this.w.get(ji(t,i)))}get(e){return this.h.get(e).map((e=>e[0].h))}trigger(e,t,i){let o=this.history,r=o.active();o.active(!1),this.h.trigger(e,[t,i]),o.active(r)}}const Di=1e9,Gi=Math.PI/180;let zi,Ki=class{constructor(e,t,i,o){this.point=e,this.index=t,this.distance=i,this.existingShape=o}};function Hi(e,t){if("number"==typeof e[0])return t(e);const i=[];let o=e.length;for(;o--;)i[o]=Hi(e[o],t);return i}let Vi=class{constructor(e){this.display=e}distance(e,i){return t.geotools.distance(e,i)}rotatePoint(e,t,i){return this.clipGeoCoord(function(e,t,i){const o=e[0]-t[0],r=e[1]-t[1],s=i*Gi;return[t[0]+(Math.cos(s)*o-Math.sin(s)*r/Math.abs(Math.cos(t[1]*Gi))),t[1]+(Math.sin(s)*o*Math.abs(Math.cos(t[1]*Gi))+Math.cos(s)*r),0^e[2]]}(e,t,i))}movePoint(e,i,o,r){return this.clipGeoCoord(t.geotools.movePoint(e,i,o,r))}scaleGeometry(e,t,i){return Hi(e.coordinates,(e=>this.clipGeoCoord([i[0]+(e[0]-i[0])*t[0],i[1]+(e[1]-i[1])*t[1],0^e[2]])))}rotateGeometry(e,t,i){const o=this;return Hi(e.coordinates,(e=>o.rotatePoint(e,t,i)))}getClosestPoint(e,t,i){const o=e[0]-t[0],r=e[1]-t[1],s=e[1]*t[0]-e[0]*t[1],n=o*i[0]+r*i[1],a=1/(o*o+r*r);return[(n*o+s*r)*a,(n*r-s*o)*a]}searchPointOnLine(e,t,i,o,r,s){const n=this;let a,l,c=null,d=r||1/0,h=!1,p=null,g=null,u=null;if(o!=zi){const a=n.searchPointOnLine(e.slice(o,o+2),t,i,zi,r,s);return a&&(a.index+=o),a}s&&(t=[t[0],t[1]]);for(let i=0;i<e.length;i++){let o=e[i];a=n.distance(o,t),a<=d&&(d=a,p=o[0],g=o[1],u=o[2],c=i,h=!0)}if(d>i||!h){const i=e.map((e=>n.display._g2w(e[0],e[1],s?zi:e[2]))),o=n.display._g2w(t);
// const path = pathGeo.map((c) => map.getPixelCoord(c));
for(var A=0;A<i.length;A++)if(A<i.length-1&&(l=b(i[A],i[A+1],o,!0))){const e=n.clipGeoCoord(n.display._w2g(l));a=n.distance(e,t),a<d&&(d=a,c=A+1,p=e[0],g=e[1],u=l[2],h=!1)}}return null!==c?(s&&(u=h?e[c][2]:ue([p,g],e[c-1],e[c])),new Ki([p,g,u||0],c,d,h)):null}translateGeo(e,t,i){const o=this,r=o.display;return Hi(e,(e=>{const s=r.geoToPixel(e[0],e[1]);return o.getGeoCoord(s.x+t,s.y+i,e[2])}))}translateZ(e,t){return this.display._translateGeoCoord(e,0,0,t)}pixelMove(e,t,i){const o=e.getProvider(),r=this.translateGeo(o.decCoord(e),t,i),s=nt.getTool(e,"_setCoords");s?s(e,r):o.setFeatureCoordinates(e,r)}clipGeoCoord(e,t){const[i,o,r]=e;return e[0]=Math.round(i*Di)/Di,e[1]=Math.round(o*Di)/Di,t&&"number"==typeof r&&(e[2]=Math.round(1e3*r)/1e3),e}getGeoCoord(e,t,i){const o=this.display;let r;return arguments.length>1?r=o.pixelToGeo(e,t):(r=e,r.x!=zi&&r.y!=zi?(i=r.z,r=o.pixelToGeo(r.x,r.y)):e[0]!=zi&&e[1]!=zi&&(i=r[2],r=o.pixelToGeo(r[0],r[1]))),this.clipGeoCoord([r.longitude,r.latitude,0|i])}getPixelCoord(e,t,i){const o=this.display;return 2==arguments.length?e=o.geoToPixel(e,t):e.longitude!=zi&&e.latitude!=zi?e=o.geoToPixel(e.longitude,e.latitude):e[0]!=zi&&e[1]!=zi&&(e=o.geoToPixel(e[0],e[1])),[e.x,e.y,0|e.z]}getEventsMapXY(e){const t=this.display;let i,o;if(e.mapX!=zi)i=e.mapX,o=e.mapY;else{const r=t.getContainer().getBoundingClientRect();i=e.pageX-r.left,o=e.pageY-r.top}return[i,o]}};const Ui="error";let Yi;class Zi{constructor(e,i){this.isCommitInProcess=!1,this._config=e;const o=this;o.layers=[],o.layerMap={},o.observers=new qt,o.listeners=new Dt,o.objects=new Ni(o,i),o.hooks=new Bi(o.objects.history),this._dListener=new Mi(o,i),this._dListener.start();const r=o.objects.overlay.layer,s=this.prvIdLayerMap={};function n(e){o.listeners.trigger(Ui,e)}s[r.getProvider().id]=r,o.listeners.add("_layerAdd",(e=>{const t=e.detail.layer,i=t.getProvider();for(let e of["src","base","delta","id"]){const o=i[e];o&&(s[o]=t)}t.removeEventListener(Ui,n),t.addEventListener(Ui,n)})),o.map=new Vi(i),o.transformer=new Wt(o),o.display=i,o.dump=t.JSUtils.dump}getLayerForClass(e){let t,i,o,r;for(let s of this.layers)s.getProvider&&(r=s.getProvider()),i=r.class,i?e==i&&(o=s):t||(t=s);return o||t}getProviderById(e){const t=this.prvIdLayerMap[e];if(t)return t.getProvider()}getLayerById(e){for(let t of this.layers)if(t.id==e)return t}getLayer(e){let t;if("object"==typeof e){const t=e.getProvider();e=t.src||t.delta||t.base||t.id}return e&&(t=this.prvIdLayerMap[e]),t}destroy(){this._dListener.stop(),this.objects.destroy(),this.listeners.destroy()}getStyle(e,i){const o=this.getLayer(e).getStyleGroup(e,0^this.display.getZoomlevel(),i);return t.JSUtils.extend(!0,[],o)}getResolvedStyle(e,t){const i=this.getStyle(e,t),r=0^this.display.getZoomlevel();for(let t of i)for(let i in t)t[i]=o.styleTools.getValue(i,t,e,r);return i}getCustomStyle(e){return this.getLayer(e)._getCustomStyleGroup(e)}getStyleProperty(e,t){const i=this.getStyle(e);for(let r of i)if(r[t]!=Yi)return o.styleTools.getValue(t,r,e,0^this.display.getZoomlevel())}getZLayer(e){const t=e.getStyle().zLayer;return null!=t?t:1+this.display.getLayers().indexOf(e)}getMaxZLayer(e){const t=this.getLayer(e),i=t.getStyleGroup(e);let r=-1;if(i){let t=0^this.display.getZoomlevel();for(let s of i){let i=o.styleTools.getValue("zLayer",s,e,t);i>r&&(r=i)}}return r>-1?r:this.getZLayer(t)}setStyle(e,t,i){var o;const r=this.getLayer(e);t==Yi?t=r._getCustomStyleGroup(e):"default"==t&&(t=(null===(o=r._getCustomStyleGroup(e))||void 0===o?void 0:o.__default)||Yi),r.setStyleGroup(e,t,i)}}const Ji=(e,t,i,o)=>e.getProvider().readTurnRestriction({link:e,index:t},{link:i,index:o}),Wi=(e,t,i,o,r)=>{t.getProvider().writeTurnRestriction(e,{link:t,index:i},{link:o,index:r})};var Qi={"Navlink.split":[e=>{let t=e.link,i=e.children,o=i[0],r=i[1];const s=t.coord().length-1,n=o.coord().length-1,a=r.coord().length-1;for(let{link:e,index:i}of t.getConnectedLinks(0,!0))Ji(t,0,e,i)&&(Wi(!0,o,0,e,i),Wi(!1,r,0,e,i)),Ji(e,i,t,0)&&(Wi(!0,e,i,o,0),Wi(!1,e,i,r,0));for(let{link:e,index:i}of t.getConnectedLinks(s,!0))Ji(t,s,e,i)&&(Wi(!0,r,a,e,i),Wi(!1,o,n,e,i)),Ji(e,i,t,s)&&(Wi(!0,e,i,r,a),Wi(!1,e,i,o,n))}],"Feature.remove":e=>{let t=e.feature;if("NAVLINK"==t.class){const e=0,i=t.coord().length-1;for(let{link:i,index:o}of t.getConnectedLinks(e,!0))Wi(!1,t,e,i,o);for(let{link:e,index:o}of t.getConnectedLinks(i,!0))Wi(!1,t,i,e,o)}},"Navlink.disconnect":e=>{let t=e.link;const i=e.index;t.getConnectedLinks(i,!0).forEach((e=>{const o=e.link,r=e.index;Wi(!1,t,i,o,r),Wi(!1,o,r,t,i)}))}};const Xi="info",qi=e=>e.properties["@ns:com:here:editor"],$i=e=>!!qi(e).created,eo=e=>!!qi(e).removed;class to{constructor(e){this.pIds={},this.iEdit=e}reserveIds(e,i,o,r){const{pIds:s}=this,n=e.id,a=[];for(const e in i)$i(i[e])&&(s[n][e]||a.push(i[e]));a.length>0?e.reserveId(a,(e=>{for(const t in i){const o=i[t];$i(o)&&!s[n][t]&&(s[n][t]=e.shift())}o(s[n],n)}),r):t.global.setTimeout((()=>{o(s[n],n)}),0)}replaceIds(e,i,o){const{pIds:r,iEdit:s}=this,n="id";let a,l,c,d=0;c=JSON.stringify(e);for(const h in e){d++,l=!1;for(const t in e[h])if($i(e[h][t])){l=!0;break}r[h]||(r[h]={}),l?(s.dump("REQUESTING PERMANENT IDs..",Xi),this.reserveIds(s.getProviderById(h),e[h],((o,r)=>{const l="#"+t.JSUtils.String.random()+"#";let h,p;for(const t in o)(a=e[r][t])&&(h="number"==typeof o[t]?o[t]:'"'+o[t]+'"',p=a[n],"string"==typeof p&&(p=`"${a[n].replace(/(?=[.\\+*?[^\]$(){}\|])/g,"\\")}"`),h!=p&&(c=c.replace(p+":{",l).replace(new RegExp('"link":'+p,"g"),'"link":"'+h+'"').replace(new RegExp(p,"g"),h).replace(l,h+":{")),s.dump(a[n]+" -> "+h,Xi));--d||i(JSON.parse(c))}),o)):d--}!d&&i(e)}send(e,i,o,r){const{pIds:s,iEdit:n}=this;let a=0;function l(){--a||i(t.JSUtils.clone(s))}for(const t in e){a++;const i=n.getProviderById(t),c=e[t],d=[],h=[];let p;for(const e in c)p=c[e],(eo(p)?h:d).push(p);const g=s[t],u={};for(const e in g)u[g[e]]=e;d.length|h.length?i.commit({put:d,remove:h},l,(e=>{o&&o(e)}),r):l()}}submit(e,i,o,r=t.JSUtils.String.random()){const{iEdit:s}=this,n=s._config.services.reverseGeocoder.getISOCC;let a=0;s.dump("COMMIT",r,Xi);const l=()=>{this.replaceIds(e,(e=>{this.send(e,i,o,r)}),o)};function c(e){if(e)return"number"==typeof e[0]?e:c(e[0])}for(const t in e)for(const i in e[t]){const o=e[t][i],r=s.getProviderById(t);eo(o)?$i(o)&&delete e[t][i]:n&&(r.isoCC(o)||(a++,s.dump(o.id,"["+r.detectFeatureClass(o)+"] MISSING ISOCC -> REVERSE GEOCODING..",Xi),((e,t)=>{n(t[0],t[1],(t=>{t&&r.isoCC(e,t),--a||l()}))})(o,c(o.geometry.coordinates))))}a||l()}}const io="NAVLINK";let oo;const ro=e=>{const t=e.class;return t==io?io:String(t)+(e.src||e.base+e.delta||e.id)},so=(e,t,i)=>{const o=t.hooks;if(o)for(let r in o){let s=o[r];s instanceof Array||(s=[s]);for(let o of s)i.hooks[e](r,o,t)}},no=e=>{(e=>{const t=e.objects.history.getChanges(),i=[];let o,r;for(const s in t){r=e.getProviderById(s);for(const e in t[s])o=r.search(e),r._clearOnCommit?(o&&(o.properties["@ns:com:here:editor"].drop=!0),i.push(r,t[s][e].bbox)):o&&(o.properties["@ns:com:here:editor"]={})}for(let e=0;e<i.length;e+=2)r=i[e],r.clear(i[e+1])})(e),e.objects.history.clear(),e.display.refresh()};class ao{constructor(e,i){this._b=0;const o=this,r=(i=(e=>{const i=t.JSUtils.extend(!0,{},n);for(const o in e)switch(o){case"services":t.JSUtils.extend(!0,i[o],e[o]);break;case"editRestrictions":if("function"!=typeof e[o])break;default:i[o]=e[o]}return i})(i||{})).layers;delete i.layers,t.JSUtils.loglevel=i.debug&&"debug";let s=new Zi(i,e);var a;o._i=()=>s,a=s,(e=>{let t;for(let i in e){t=e[i],"function"==typeof t&&(t=[t]);for(let e of t)a.hooks.add(i,e)}})(Qi),o.container=e.getContainer(),r instanceof Array&&r.forEach((e=>this.addLayer(e))),o.active(!0),setTimeout((()=>{const e=s.observers,t=e.get("active"),i=t;e.change("active",t,i),s.layers.length||e.change("ready",!0)}),0)}active(e){let t=this._i(),i=t.observers.get("active");return null!=e&&(e=!!e)!=i&&(i=e,t.objects.listenDisplay(e),t.observers.change("active",e,!0)),i}addEventListener(e,i,o){const{listeners:r}=this._i(),s=r.supported().filter((e=>"_"!=e[0]));String(e).split(" ").forEach((e=>{s.indexOf(e)>-1?r.add.call(r,e,i,o):t.JSUtils.dump(e+" is not a valid event. Use: "+s.join(", "),"warn")}))}removeEventListener(e,t){const{listeners:i}=this._i();i.remove.apply(i,arguments)}addFeature(e,t,i){const o=this._i(),r=arguments,s=[],n={};let a,l,c={};const d=e=>e.x!=oo&&e.y!=oo||e.longitude!=oo&&e.latitude!=oo,h=(e,t)=>{if(d(e)&&(e=o.map.getGeoCoord(e)),"number"==typeof e[0])return e[0]+=t[0],e[1]+=t[1],o.map.clipGeoCoord(e);const i=[];for(let o=0;o<e.length;o++)i[o]=h(e[o],t);return i},p=(e,t)=>{const i=t&&t.id;(c[i]=c[i]||[]).push(e)};if("Feature"==e.type)p(e,t);else if(e instanceof Array)e.forEach((e=>p(e,t)));else{c=e;for(let t in c)"Feature"==(e=c[t]).type&&(c[t]=[e])}if(d(i=r[r.length-1])){i=o.map.getGeoCoord(i);const e=o.display.getViewBounds();l=[i[0]-e.minLon,i[1]-e.maxLat]}else l=[0,0];for(let e in c){c[e].forEach((t=>{const i=t.geometry;i.coordinates=h(i.coordinates,l),"Feature"!=t.type||t instanceof gt||(t=new gt(t)),(t=o.objects.add(t,"undefined"==e?oo:e,n))&&(a=!0,s.push(t))}))}return a&&o.objects.history.saveChanges(),s.length>1?this.createFeatureContainer.apply(this,s):s[0]}addHook(e,t,i){return this._i().hooks.add(e,t,i)}batch(e){if("function"==typeof e){this.beginBatch();try{e()}finally{this.endBatch()}}}beginBatch(){this._b++,this._i().objects.history.active(!1)}endBatch(){const e=this._i().objects.history;this._b>0&&0==--this._b&&(e.active(!0),e.saveChanges())}removeHook(e,t,i){return this._i().hooks.remove(e,t,i)}getHooks(e){return this._i().hooks.get(e)}getFeature(e,t){return this._i().objects.get(e,t)||null}config(e,t){const i=this._i()._config;switch(arguments.length){case 2:i[e]=t;break;case 1:return i[e];case 0:return Object.assign({},i)}}createFeatureContainer(...e){const t=new ci(this._i());return t.push(e.flat()),t}getSelectedFeature(){return this._i().objects.selection.getCurSelObj()||null}clearFeatureSelection(){return this._i().objects.selection.clearSelected()||null}search(e){const t=this._i(),i=[];let o;if("object"==typeof e){const r=e.filter,s=e.layers||t.layers;let n=s.length;for(;n--;){let t=s[n].search(e);t instanceof Array||(t=[t]);let a=t.length;for(;o=t[--a];)r&&!r(o)||i.push(o)}}return i}addLayer(e){if(e){const t=this._i(),i=t.layerMap,o=e.getProvider();if(o&&"FeatureProvider"==o.__type&&o.editable&&(!i[ro(o)]||o.class==io)){if(o._e instanceof Zi){if(o._e===t)return!1;throw new Error("Provider already in use by another editor")}return o._e=t,e.class=o.class,t.listeners.trigger("_layerAdd",{layer:e}),i[ro(o)]=e,t.layers.push(e),so("add",o,t),!0}}return!1}getLayers(e){const{layers:t}=this._i();return e?t[e]:t.slice()}removeLayer(e){if(e){const t=this._i(),{layerMap:i,layers:o}=t;let r=e.getProvider();const s=ro(r);if("FeatureProvider"==r.__type&&r.editable&&i[s])return delete i[s],o.splice(o.indexOf(e),1),t.listeners.trigger("_layerRemove",{layer:e}),so("remove",r,t),delete r._e,!0}return!1}addObserver(e,t){this._i().observers.addObserver(e,t,arguments[2])}get(e){return this._i().observers.get(e)}removeObserver(e,t){this._i().observers.removeObserver(e,t,arguments[2])}destroy(){const e=this;let t=e._i();e.getLayers().forEach((t=>e.removeLayer(t))),e.active(!1),t.destroy();for(let t in e)delete e[t];return e.__proto__={},null}setZoomLevel(e){this._i().display.setZoomlevel(e)}getZoomLevel(){return this._i().display.getZoomlevel()}pixelToGeo(e){const t=this._i().map.getGeoCoord(e);return t?new i.GeoPoint(t[0],t[1]):null}geoToPixel(e){const t=this._i().map.getPixelCoord(e);return t?new i.PixelPoint(t[0],t[1]):null}revert(){const e=this._i();let t=e.observers.get("history.current");for(;t--;)e.objects.history.recoverViewport(-1,!0);no(e)}getDrawingBoard(){const e=this._i();return e._db=e._db||new Pt(e)}getZoneSelector(){return this.getRangeSelector()}getRangeSelector(){const e=this._i();return e._rngSel=e._rngSel||new Kt(e)}getOverlay(){return this._i().objects.overlay.layer}undo(e){for(e=Math.min(this.get("history.current"),e||1);e--;)this._i().objects.history.recoverViewport(-1,!!e)}redo(e){for(e=Math.min(this.get("history.length"),e||1);e--;)this._i().objects.history.recoverViewport(1,!!e)}submit(e){let t,o=!1;const r=[],s=(e=e||{}).ignoreEventBlock;let n=e.layer;const a=e.onError,l=e.onSuccess,c=e.transactionId,d=this._i();if("function"==typeof s)throw new Error("Invalid parameter!");if(s||!d.isCommitInProcess){n=n instanceof Array?n:[n];for(const e in n){const t=n[e];t&&t instanceof i.TileLayer&&"MARKER"==t.type&&(t.base&&r.push(t.base),t.delta&&r.push(t.delta),t.src&&r.push(t.src))}t=d.objects.history.getChanges();for(const e in t)r.length>0&&r.indexOf(e)<0?delete t[e]:o=!0;if(o)return d.listeners.trigger("_beforeSubmit"),((e,t,i,o,r)=>{e.isCommitInProcess||(e.objects.selection.clearSelected(),e.observers.change("ready",e.isCommitInProcess),e.isCommitInProcess=!0,new to(e).submit(t,(t=>{e.isCommitInProcess=!1,i.call(null,t)}),(t=>{e.isCommitInProcess=!1,o.call(null,t)}),r))})(d,t,(function(e){no(d),d.listeners.trigger("_afterSubmit"),l&&l({permanentIDMap:e})}),(function(e){d.listeners.trigger("_afterSubmit"),a&&a(e)}),c),!0}return!1}info(){const e=[],i=this._i().objects.history.getChanges();for(const o in i)for(const r in i[o])e[e.length]=t.JSUtils.clone(i[o][r]);return e}export(){const e=this._i();return JSON.stringify(e.objects.history.getChanges())}import(e){const t=this._i();return"string"==typeof e&&(e=JSON.parse(e)),t.objects.history.import(e)}toGeoJSONCoordinates(e){if(Array.isArray(e)&&"number"!=typeof e[0]){let t=[];for(let i of e)t.push(this.toGeoJSONCoordinates(i));return t}return this._i().map.getGeoCoord(e)}}const lo={dragPlane:"XY"};class co extends gt{behavior(e,t){let i=$.private(this,"b")||Object.assign({},lo);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];break;case 2:const o={};o[e]=t,e=o}i=Object.assign(Object.assign({},i),e),e.dragPlane?delete i.dragAxis:e.dragAxis&&delete i.dragPlane,this.__.b=i}}co.prototype.class="MARKER";class ho extends co{constructor(e,t){super(e,t)}coord(e){return super.coord(e)}getBBox(){const e=this.geometry.coordinates;return[e[0],e[1],e[0],e[1]]}getLink(){const e=Ie.getRoutingData(this);let t;if(e.link){const i=Ie.getRoutingProvider(this);t=i&&i.search(e.link)}return t||null}}class po extends ho{constructor(e,t){super(e,t)}createRoutingPoint(){const e=this;Ie.getRoutingData(e).link||(Ie.connect(e),Ie.getRoutingData(e).link&&Ie.markAsModified(e))}removeRoutingPoint(){const e=this;Ie.getRoutingData(e).link&&(Ie.disconnect(e),Ie.markAsModified(e))}prop(e,i){const o=this,r=arguments.length,s=o.getProvider().getFeatureProperties(o);let n=!1;if(!r||1==r&&"string"==typeof e)return null!=(e=e?s[e]:s)&&"object"==typeof e?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==r){const t={};t[e]=arguments[1],e=t}for(const t in e){const i=e[t],r="object"==typeof i,a=s[t];(r&&JSON.stringify(i)!=JSON.stringify(a)||!r&&a!==i)&&(n||(o._e().objects.history.origin(o),n=!0),s[t]=i)}Ie.getRoutingData(o).link?Ie.connect(o,null):Ie.disconnect(o),n&&(o._e().setStyle(o),Ie.markAsModified(o))}}po.prototype.class="PLACE";class go extends ho{prop(e,i){const o=this;let r=!1;const s=arguments.length,n=o.getProvider().getFeatureProperties(o);if(!s||1==s&&"string"==typeof e)return null!=(e=e?n[e]:n)&&"object"==typeof e?t.JSUtils.extend(!0,new e.constructor,e):e;if(2==s){const t={};t[e]=arguments[1],e=t}for(const t in e){const i=e[t],s="object"==typeof i,a=n[t];(s&&JSON.stringify(i)!=JSON.stringify(a)||!s&&a!==i)&&(r||(o._e().objects.history.origin(o),r=!0),n[t]=i)}Ie.connect(o,null),r&&(o._e().setStyle(o),Ie.markAsModified(o))}}var uo;go.prototype.class="ADDRESS",function(e){e.CROSSING="CROSSING",e.CROSSING_CANDIDATE="CROSSING_CANDIDATE"}(uo||(uo={}));const Ao="#FFFFFF",fo="#FF0000",yo={zIndex:0,type:"Line",stroke:fo,strokeWidth:22,strokeLinecap:"round",opacity:.5},vo={zIndex:1,type:"Line",stroke:Ao,strokeWidth:18,strokeLinecap:"round",opacity:.8},mo={zIndex:2,type:"Line",stroke:"#000000",strokeWidth:14,strokeLinecap:"round",opacity:.8},So={zIndex:3,type:"Circle",stroke:fo,strokeWidth:1,opacity:.5,radius:12,fill:fo},_o={zIndex:4,type:"Circle",stroke:Ao,strokeWidth:2,opacity:1,radius:10,fill:Ao},Lo={zIndex:5,type:"Circle",stroke:Ao,radius:3,fill:Ao};let bo,Eo;function xo(e,t){const i=e.coord();for(let e=0;e<i.length;e++)if(t[0]==i[e][0]&&t[1]==i[e][1])return e;return m(i,t)}class ko{constructor(e,t,i,o,r){this.type="Feature";const{iEditor:s}=e,n=r||o,a=[(n[0]-o[0])/2+o[0],(n[1]-o[1])/2+o[1]],l=s.map.getPixelCoord(a);this._={iEditor:s,xTester:e,link:t,candidate:i,searchPnt:o,foundPnt:r},this.x=l[0],this.y=l[1];const c=!!r;r=r||o;const d=s.display.geoToPixel(o[0],o[1]),h=s.display.geoToPixel(r[0],r[1]);this.distance=P([d.x,d.y],[h.x,h.y]),this.class=c?uo.CROSSING_CANDIDATE:uo.CROSSING,this.type="Feature",this.geometry=c?{type:"LineString",coordinates:[o,r]}:{type:"Point",coordinates:a}}getLinkIndex(){let e=this._;return xo(e.link,e.searchPnt)}getCandidateIndex(){let e=this._;return xo(e.candidate,e.foundPnt||e.searchPnt)}getRelatedLink(){return this._.candidate}connect(){const e=this.getRelatedLink(),t=this._,{iEditor:i,xTester:o}=t,r=this.getLink();if(!e.id||!r.id||e.editState("removed")||e.editState("modified")>o.createTS||r.editState("removed")||r.editState("modified")>o.createTS)return!1;const s=this.class==uo.CROSSING_CANDIDATE,n=this.getCandidateIndex(),a=(t.foundPnt||t.searchPnt).slice(),l=[];let c,d;if(s||(d=it.addShp(r,i.map.clipGeoCoord(a),null,!0)),c=s?this.getLinkIndex():d,!1!==this.getLinkIndex()){s&&r.getConnectedLinks(c).forEach((e=>{it.markAsModified(e,!1,!1)})),(it.connectShpToLink(r,c,e,i.map.clipGeoCoord(a),"number"==typeof n?n:bo).splittedInto||[]).forEach((e=>{null!=e&&l.push(e)}))}this.hide();for(const e in this)"type"!==e&&(this[e]=bo);return o.getCrossings({links:l,croLink:r})}show(){const e=this,t=e._,{iEditor:i,xTester:o}=t,r=i.objects.overlay,s=t.foundPnt||t.searchPnt,n=t.set=t.set||((t,s,n,a)=>{const l=o.getStyle(),c=i.getStyle(n)[0].stroke,d=i.getStyle(a)[0].stroke,h=e=>r.addPath([t,s],e),p=(e,t)=>r.addCircle(e,t),g=t=>i.listeners.trigger(t,e),u=i.getStyleProperty(n,"altitude");if(c&&d){const e=[h(Object.assign(Object.assign(Object.assign({},yo),l.connector1),{altitude:u})),h(Object.assign(Object.assign(Object.assign({},vo),l.connector2),{altitude:u})),h(Object.assign(Object.assign(Object.assign({},mo),l.connector3),{altitude:u})),p(t,Object.assign(Object.assign(Object.assign({},So),l.search1),{altitude:u})),p(t,Object.assign(Object.assign(Object.assign(Object.assign({},_o),{fill:c}),l.search2),{altitude:u})),p(s,Object.assign(Object.assign(Object.assign(Object.assign({},Lo),{fill:d,stroke:d}),l.found),{altitude:u}))];return e.forEach((e=>e.pointerup=g)),e}})(t.searchPnt,s,this.getLink(),this.getRelatedLink());i.objects.overlay.showFeature(n)}hide(){var e;const t=this._;t&&(null===(e=t.set)||void 0===e||e.forEach((e=>e._provider.removeFeature(e))),t.set=null)}getLink(){return this._.link}getConnectedLinks(){return this.class==uo.CROSSING_CANDIDATE?this.getLink().getConnectedLinks(this.getLinkIndex()):[]}}const Co="CROSSING",Po=Co+"_CANDIDATE";class Io{constructor(e,t){this.foundCrossings=[],this.simpleCrossings=[],this.iEditor=e,this.setRelatedLink(t)}clear(){const{foundCrossings:e,simpleCrossings:t}=this;t.forEach((e=>{e.hide&&e.hide()})),e.length=0,t.length=0,this.createTS=0}checkRealCrossing(e,t){let i=[];const o=e._e().getStyleProperty(e,"altitude")?void 0:0,r=(e,t)=>{const i=[],o="number"==typeof t;for(let r of e){let e=o?t:r[2]||0;i[i.length]=[r[0],r[1],e]}return i},s=r(e.geometry.coordinates,o),n=(t,i)=>{let n=!1;const a=[],l=function(e,t){const i=[];for(let o=0;o<e.length-1;o++)for(let r=0;r<t.length-1;r++){const s=S(e[o],e[o+1],t[r],t[r+1]);s.intersects&&s.onSegment&&i.push({point:s.p0,s1:o+1,s2:r+1})}return i}(s,r(t.geometry.coordinates,o));for(var c=0,d=0,h=l.length;c<h-1;d=++c){const e=l[c],{point:t}=e;let i;for(;++d<h;){i=l[d];const o=i.point;t[0]==o[0]&&t[1]==o[1]&&Math.abs(i.s1-e.s1)<=1&&Math.abs(i.s2-e.s2)<=1&&(l.splice(d--,1),h--)}}for(c=0;c<l.length;c++){const{point:r}=l[c];n=!1;for(let e,s=0;s<i.length;s++)if(e=i[s],e.link.id==t.id&&it.isIntersection(this.iEditor,r,e.link.coord()[e.index],!o)){n=!0;break}n||a.push(new ko(this,e,t,r))}return a};if(!e.editState("removed")){const o=e.getConnectedLinks(0,!0).concat(e.getConnectedLinks(s.length-1,!0));t.forEach((e=>{i=i.concat(n(e,o))}))}return i}getNearestLineCandidate(e,t,i,o){if(o===Eo){o=[e.id];const i=e.getConnectedLinks(t,!0);for(const e in i)o.push(i[e].link.id)}const r=e.coord(),s=this.iEditor.objects.getNearestLine(r[t],i,{ignore:e=>-1!=o.indexOf(e.id),maxDistance:this.maxDistance});if(s){if(((e,t)=>{for(const i in e)if(-1!=t.indexOf(e[i].link.id))return!0;return!1})(s.line.getConnectedLinks(s.shpIndex,!0),o))return o.push(s.line.id),this.getNearestLineCandidate(e,t,i,o)}return s}calculateCrossings(e,i){let o,r=[];return this.createTS=+new Date,(Array.isArray(e)?e:[e]).forEach((e=>{if(!(e.editState("removed")||i&&i!=Co&&i!=Po)){const s=t.geotools.extendBBox(e.getBBox(),this.maxDistance),n=this.iEditor.objects.getInBBox(s,e.getProvider()),a=n.indexOf(e);-1!=a&&n.splice(a,1),i!=Po&&(r=r.concat(this.checkRealCrossing(e,n))),i!=Co&&e.coord().forEach(((t,i)=>{(o=this.getNearestLineCandidate(e,i,n))&&o.distance>.001&&r.push(new ko(this,e,o.line,t,o.point))}))}})),r}getRelatedLink(){return this.linkOrig}getCrossings(e){const t=this;return e=e||{},t.setRelatedLink(Eo),e.links?e.croLink&&e.links.length&&(t.relatedLink=t.relatedLink.concat(e.links)):(t.searchType==e.class&&t.maxDistance==e.maxDistance||(t.createTS=0),t.cStyles=e.styles||{},t.searchType=e.class),t.maxDistance=e.maxDistance||t.iEditor._config.snapTolerance||3,(!t.createTS||t.linkOrig.editState("modified")>t.createTS||e.links)&&(t.clear(),t.foundCrossings=t.calculateCrossings(t.relatedLink,t.searchType)),t.getSimplifiedCrossings()}getSimplifiedCrossings(){this.simpleCrossings.length=0;for(let e of this.foundCrossings)this.simpleCrossings.push(e);return this.simpleCrossings}setRelatedLink(e){e&&(this.linkOrig=e,this.relatedLink=[e])}getStyle(){return this.cStyles}}const Ro=e=>e.getProvider().readPedestrianOnly(e),Oo=e=>e.getProvider().readDirection(e),wo=(e,t,i,o)=>{const r=Oo(i);return i.getZLevels()[o]===e.getZLevels()[t]&&("BOTH"==r||(0==o?"START_TO_END":"END_TO_START")==r)},Fo="TURN_RESTRICTION_";class No{constructor(e,i,o,r,s,n){const a=e.objects.overlay,l=0==s?1:r.coord().length-2,c=r.coord(),d=c[s].slice(),h=c[l].slice();it.ignoreZ(i)&&(d[2]=0,h[2]=0);const p=v(d,h,8e-5);let g=((e,t,i,o)=>{const r=((e,t,i,o)=>e.getProvider().readTurnRestriction({link:e,index:t},{link:i,index:o}))(e,t,i,o);return wo(e,t,i,o)?r?"FORBIDDEN":Ro(i)?"PEDESTRIAN":"ALLOWED":"ONEWAY"})(i,o,r,s);const u=a.addPath([p,d,n],null,{type:Fo+"LINE",sign:Fo+g}),A=a.addImage(p,null,{type:Fo+g,rotation:t.geotools.calcBearing(d,p)-90});this.sign=A,this.line=u,this.overlay=a,this.to=r,this.from=i,it.showDirection(r),a.remove(u),A.pointerenter=()=>{a.addFeature(u)},A.pointerleave=()=>{a.remove(u)},A.pointerup=()=>{wo(i,o,r,s)&&!Ro(r)&&(e.objects.history.batch((()=>{((e,t,i,o,r)=>{t.getProvider().writeTurnRestriction(e,{index:i,link:t},{index:r,link:o})})("ALLOWED"==g,i,o,r,s)})),g="ALLOWED"==g?"FORBIDDEN":"ALLOWED",e.objects.history.saveChanges()&&(A.properties.type=Fo+g,u.properties.sign=A.properties.type,e.setStyle(A),e.setStyle(u)))}}hide(){it.hideDirection(this.to),this.overlay.remove(this.sign),this.overlay.remove(this.line),this.sign=null,this.line=null}}var Mo;!function(e){e.BOTH="BOTH",e.FROM_RN="START_TO_END",e.TO_RN="END_TO_START"}(Mo||(Mo={}));class To{constructor(e,t){const i=e._e();this._overlay=i.objects.overlay,this._trs=[];const o=()=>{this.hide(),i.listeners.remove("_clearOverlay",o)};i.listeners.add("_clearOverlay",o),this._l=e,this._i=t,this.show()}_hideOrigin(){this._origin&&this._overlay.remove(this._origin),this._origin=null}_showOrigin(e,i){const o=e.coord(),r=0==i?1:o.length-2;let s=o[i],n=o[r];it.ignoreZ(e)&&(s=[s[0],s[1],0],n=[n[0],n[1],0]);const a={geometry:{coordinates:v(s,n,1e-4),type:"Point"},type:"Feature",properties:{type:"TURN_RESTRICTION_START",rotation:t.geotools.calcBearing(s,n)-90}};this._origin=this._overlay.addFeature(a)}show(){const e=this._l,t=this._i,i=Oo(e),o=0==t?Mo.FROM_RN:Mo.TO_RN;if(i!=Mo.BOTH&&o==i||Ro(e))return;const r=e.getConnectedLinks(t,!0);r.length&&this._showOrigin(e,t),this._trs=r.map((i=>new No(e._e(),e,t,i.link,i.index,this._origin.geometry.coordinates)))}hide(){const e=this._trs;for(const t in e)e[t].hide(),e[t]=null;e.length=0,this._hideOrigin()}isActive(){return this._trs.length>0}}const jo="NAVLINK_DIRECTION_HINT_",Bo=jo+"A",Do=jo+"B",Go=jo+"1WAY",zo=jo+"2WAY",Ko=jo+"BLOCKED";class Ho{constructor(e,i,o,r){const s=i.coord(),n="END_TO_START"==o?180:0,a=[];r||a.push(e.addPoint(s[0].slice(),{type:Bo}),e.addPoint(s[s.length-1].slice(),{type:Do}));for(let i=0;i<s.length-1;i++){const r=s[i],l=s[i+1],c={type:"BLOCKED"==o?Ko:"BOTH"==o?zo:Go};"BLOCKED"!=o&&(c.bearing=n+t.geotools.calcBearing(r,l)-90),a.push(e.addPoint(x(r,l,.5),c))}this.overlay=e,this.points=a}destroy(){this.overlay.remove(this.points),this.points=null}}let Vo;const Uo=e=>{throw new Error(e)},Yo={snapCoordinates:!0};class Zo extends gt{constructor(){super(...arguments),this.setGeoFence=e=>{(isNaN(e)||e<0)&&Uo("Geofence radius should be a positive Number"),this._e()._config.geoFence=+e}}coord(e){return super.coord(e)}checkCrossings(e){const t=this,i=it.private(t),o=i.xt||new Io(t._e(),t);return i.xt=o,o.getCrossings(e)}showDirectionHint(e,t){e={B:"BOTH",F:"START_TO_END",T:"END_TO_START",N:"BLOCKED"}[e]||e;const i=it.private(this),o=i.dh;o&&o.destroy(),i.dh=e&&new Ho(this._e().objects.overlay,this,e,t)}addShape(e,t){let i=!1;const o=this,r=this._e().map.getGeoCoord(e);return r?!1!==(i=it.addShp(o,r,t,Vo,!0))&&it.markAsModified(o):Uo("Invalid coordinate"),i}behavior(e,t){let i=it.private(this,"b")||Object.assign({},Yo);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];i=Object.assign(Object.assign({},i),e);break;case 2:i[e]=t}this.__.b=i}getConnectedLinks(e,t=!1){const i=this,o=i._e(),r=i.coord(),s=r[e],n=[];let a,l;const c=0==e||e==r.length-1,d=it.ignoreZ(i);if(c)for(let r of o.objects.getInBBox(i.bbox,i.getProvider()))r.id!=i.id&&"NAVLINK"==r.class&&(a=r.coord(),l=a.length-1,null!=(e=it.isIntersection(o,a[0],s,d)?0:it.isIntersection(o,a[l],s,d)?l:null)&&n.push(t?{index:e,link:r}:r));return n}getZLevels(e){let t=this.getProvider().readZLevels(this);return"number"==typeof e?t[e]:t.slice(0)}getSelectedShapes(){const e=it.private(this,"selectedShapes"),t=this.geometry.coordinates,i=[];for(let o=0;o<t.length;o++)i[o]=!!e[o];return i}setSelectedShapes(e){const t=this,i=it.private(t,"selectedShapes"),o=t.geometry.coordinates;for(let t=0;t<o.length;t++)i[t]=Boolean(e[t]);it.refreshGeometry(t)}setZLevels(e){const t=this,i=t.getZLevels(),o=t._e().objects.history,r=t.geometry.coordinates.length;e instanceof Array||Uo("Invalid 'zlevel' argument given, no array"),e.length!==r&&Uo("Given 'zlevel' argument is of an invalid size, a length of "+r+" is required!"),o.origin(t);let s=!1;for(let t,o=0;o<e.length;o++)t=0^e[o],t!=i[o]&&(e[o]=t,s=!0);s&&(o.batch((()=>{t.getProvider().writeZLevels(t,e)})),it.refreshGeometry(this),it.markAsModified(this))}simplifyGeometry(e){return de.simplifyGeometry(this,e)}editTurnRestrictions(e){const t=this,i=t.coord(),o=t._e(),r=0==e||e==i.length-1?[e]:e===Vo?[0,i.length-1]:[];o.listeners.trigger("_clearOverlay");const s=r.map((e=>new To(t,e)));return e===Vo?s:s[0]}prop(e,i){const o=this,r=o._e();let s=!1;const n=arguments.length,a=o.getProvider().getFeatureProperties(o);if(0==n||1==n&&"string"==typeof e){let i=e?a[e]:a;return"object"==typeof i?t.JSUtils.extend(!0,new i.constructor,i):i}let l=e;if(2==n){const t={};t[e]=arguments[1],l=t}for(const e in l){const t=l[e],i="object"==typeof t,n=a[e];(i&&JSON.stringify(t)!=JSON.stringify(n)||!i&&n!==t)&&(s||(r.objects.history.origin(o),s=!0),a[e]=t)}s&&(r.setStyle(o),o.editState("selected")&&it.showDirection(o),it.markAsModified(o))}}Zo.prototype.class="NAVLINK";class Jo extends gt{addShape(e,t,i){const o=this,r=o._e().map.getGeoCoord(e);let s=i;return r?((s=de.addCoord(o,r,s,t||0))&&(de.displayShapes(o),de.markAsModified(o)),s):((e=>{throw new Error(e)})("Invalid coordinate"),!1)}coord(e){return super.coord(e)}getSelectedShapes(){var e;const t=this,i=de.private(t,"selectedShapes"),o=de.getCoordinates(t),r=[];for(let t=0;t<o.length;t++){r[t]=[];for(let s=0;s<o[t].length;s++)r[t][s]=!!(null===(e=i[t])||void 0===e?void 0:e[s])}return de.isMultiLineString(t)?r:r[0]}setSelectedShapes(e){var t;const i=this,o=de.private(i,"selectedShapes"),r=de.getCoordinates(i);Array.isArray(null==e?void 0:e[0])||(e=[e]);for(let i=0;i<r.length;i++){o[i]||(o[i]=[]);for(let s=0;s<r[i].length;s++)o[i][s]=Boolean(null===(t=null==e?void 0:e[i])||void 0===t?void 0:t[s])}de.displayShapes(i)}simplifyGeometry(e){return de.simplifyGeometry(this,e)}}Jo.prototype.class="LINE";const Wo={snapCoordinates:!0};class Qo extends gt{addShape(e,t,i){let o=!1;const r=this._e().map.getGeoCoord(e);return e?(1==arguments.length&&(t=$.getPoly(this,r)),!1!==(o=$.addShp(this,r,0^t,0,i))&&$.markAsModified(this)):(e=>{throw new Error(e)})("Invalid coordinate"),o}addHole(e){if(e){e=this._e().map.getPixelCoord(e);const t=this,i=$.getPoly(t,e),o=$.getCoords(t),r=o[i];let s=1/0;for(let i=0;i<r.length;i++){const o=$.getMaxSpace(t,e,r[i]);o<s&&(s=o)}if(s!=1/0&&(s=Math.floor(.5*s),s>8)){const i=e[0],n=e[1],a=[[i-s,n+s],[i+s,n+s],[i+s,n-s],[i-s,n-s],[i-s,n+s]].map((e=>this._e().map.getGeoCoord(e)));return $.isClockwise(r[0])||a.reverse(),r.push(a),$._setCoords(t,o,!0),$.markAsModified(t),!0}return!1}}behavior(e,t){let i=$.private(this,"b")||Object.assign({},Wo);switch(arguments.length){case 0:return i;case 1:if("string"==typeof e)return i[e];i=Object.assign(Object.assign({},i),e);break;case 2:i[e]=t}this.__.b=i}coord(e){return super.coord(e)}}Qo.prototype.class="AREA";const Xo={};let qo;Xo.NAVLINK="Navlink",Xo.AREA="Area",Xo.PLACE="Place",Xo.ADDRESS="Address",Xo.MARKER="Marker",Xo.LINE="Line";const $o=(()=>{function e(e){const i=e=>{if("number"==typeof(e.x!=qo?e.x:e.longitude!=qo?e.longitude:e[0]))return e;const t=[];for(let o of e)t[t.length]=i(o);return t};function o(o,r,s){const n=this;"number"!=typeof o&&"string"!=typeof o?(s=r,r=o):n.id=o,n.type="Feature",n.class=e,n.properties=t.JSUtils.extend({"@ns:com:here:editor":new lt},s||{}),n.geometry={type:"PLACE"==e||"ADDRESS"==e||"MARKER"==e?"Point":"AREA"==e?"MultiPolygon":"LineString",coordinates:i(r)}}return o.prototype=gt.prototype,o}const i={};for(const t in Xo)i[Xo[t]]=e(t);return i})(),er="here.xyz.maps.editor".split(".");let tr=t.global;for(let e=0;e<er.length-1;e++)tr=tr[er[e]]=tr[er[e]]||{};const ir=tr[er.pop()]={Editor:ao,features:$o,PixelCoordinate:function(e,t,i){this.x=e,this.y=t,this.z=i||0},GeoCoordinate:function(e,t,i){this.longitude=e,this.latitude=t,this.z=i||0}};t.global.here.xyz.maps.providers.EditableFeatureProvider.prototype.getFeatureClass=function(e){switch(this.detectFeatureClass(e)){case"NAVLINK":return Zo;case"PLACE":return po;case"ADDRESS":return go;case"AREA":return Qo;case"MARKER":return co;case"LINE":return Jo;default:return this.Feature}},e.Address=go,e.Area=Qo,e.AreaShape=G,e.Crossing=ko,e.DefaultEditorProperties=lt,e.DrawingBoard=Pt,e.DrawingShape=yt,e.Editor=ao,e.EditorEvent=At,e.Feature=gt,e.Line=Jo,e.LineShape=oe,e.Marker=co,e.Navlink=Zo,e.NavlinkShape=Ke,e.Place=po,e.RangeSelector=Kt,e.default=ir,e.defaultBehavior=te,e.features=$o,Object.defineProperty(e,"__esModule",{value:!0})}));
