/*
 * @here/xyz-maps-display
 * (c) 2019-2022 HERE
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@here/xyz-maps-common"),require("@here/xyz-maps-core")):"function"==typeof define&&define.amd?define(["exports","@here/xyz-maps-common","@here/xyz-maps-core"],e):e(((t="undefined"!=typeof globalThis?globalThis:t||self).here=t.here||{},t.here.xyz=t.here.xyz||{},t.here.xyz.maps=t.here.xyz.maps||{}),t.here.xyz.maps.common,t.here.xyz.maps)}(this,(function(t,e,i){"use strict";const s=(t,e,i,s)=>{("string"==typeof e?[e]:e).forEach((e=>{t.addEventListener(e,i,s)}))},r=(t,e,i,s)=>{("string"==typeof e?[e]:e).forEach((e=>{t.removeEventListener(e,i,s)}))},n=(t,e)=>Math.round(parseFloat(((t,e)=>{let i,s;return(s=t.ownerDocument.defaultView.getComputedStyle(t,null))&&(i=s.getPropertyValue(e),""===i&&(i=t.style[e])),i})(t,e)))||0;let o=document.createElement("canvas").getContext("2d"),a="abcdefghijklmnopqrstuvwxyz";a=a+a.toUpperCase()+" 0123456789";let l=a.length,h={};const c="normal 12px Arial",u=(t,e,i,s)=>{t.font=e.font||c,"number"==typeof e.strokeWidth?t.lineWidth=e.strokeWidth:t.lineWidth=1,t.strokeStyle=s,t.fillStyle=i,t.textAlign=e.textAlign||"start",t.lineCap="round",t.lineJoin="round"},d=(t,e,i,s,r)=>{const{fill:n,stroke:o,strokeWidth:a}=r;o&&0!=a&&t.strokeText(e,i,s),n&&t.fillText(e,i,s)},f=(t,e,i,s,r)=>{s=s||128,r=r||128,t.fillStyle="#000",t.fillRect(0,0,s,r),u(t,e,"#fff","#fff"),d(t,i,0,0,e);const n=t.getImageData(0,0,s,r).data;let o=-1,a=-1;for(let t=0;t<r;t++)for(let e=0;e<s;e++){if(0!=n[4*(t*s+e)]){-1==o&&(o=t);break}if(e==s-1&&-1!==o){a=t,t=r;break}}return t.clearRect(0,0,s,r),{height:a-o,min:o,max:a}},p=(t={})=>{let{font:e,strokeWidth:i}=t;e=e||c,i=i||0;const s=e+i;return h[s]||(o.font=e,o.textBaseline="top",h[s]={width:o.measureText(a).width/l,height:f(o,t,"gM").height}),h[s]},g=(t,e)=>{if(!1===e)return[t];null!=e&&!0!==e||(e=14);const i=[];let s=0,r=-1;for(let n,o,a,l=0,h=t.length;l<h;l++)o=t.charAt(l),a=l-s," "==o?r=l:"\n"==o&&(a=1/0,r=l),a>=e&&s<=r&&(n=t.substring(s,r),s=r+1,i.push(n)),l==h-1&&s<=l&&(n=t.substring(s,l+1),i.push(n));return i};let m;const v=(t,e,i,s,r)=>{let n=Math.sin(r),o=Math.cos(r),a=t-i,l=e-s;return[o*a-n*l+i,n*a+o*l+s]},x=(t,e,i,s,r,n)=>t>i&&t<r&&e>s&&e<n,y=e.geometry.intersectBBox,_=(t,e,i,s)=>{const r=t-i,n=e-s;return Math.sqrt(r*r+n*n)},b=(t,e,i,s,r)=>{const n=(s[1]-i[1])*(e[0]-t[0])-(s[0]-i[0])*(e[1]-t[1]);if(0!=n){const o=((s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]))/n,a=((e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]))/n;if(0<=o&&o<=1&&0<=a&&a<=1)return!r||[t[0]+o*(e[0]-t[0]),t[1]+o*(e[1]-t[1]),t[2]+o*(e[2]-t[2])]}return!1},w=t=>t>47&&t<58;class M{constructor(){this.fonts={}}static getInstance(){return this.instance=this.instance||new M}getFontId(t,e){return`${t.font||"normal 12px Arial"}${t.strokeWidth||1}${e}`}initFont(t,e=1){var i;const{fonts:s}=this,r=this.getFontId(t,e);if(!s[r]){null!==(i=t.strokeWidth)&&void 0!==i||(t.strokeWidth=1);const n=96*e,o=((t,e)=>{const i=document.createElement("canvas");return i.width=t,i.height=e,i})(n,n),a=o.getContext("2d",{willReadFrequently:!0});a.textBaseline="top",u(a,t,"#fff","#000");const l=Math.ceil(t.strokeWidth/2),h=l,c=a.measureText("Ã„").actualBoundingBoxAscent,d=Math.ceil(l+c),f=Math.ceil(this.getLetterHeight(a,"bottom")/2),p=Math.ceil(this.getLetterHeight(a,"top")+l)+1;a.setTransform(e,0,0,e,0,0);const g=Math.ceil(p+d);s[r]={name:r,size:0,glyphs:new Map,paddingX:h,paddingY:d,canvas:o,ctx:a,width:n,scale:e,style:t,textMetricsCache:new Map,rowHeight:g*e,letterHeight:p,spaceWidth:a.measureText(" ").width*e,baselineOffset:e*(f+d)}}return s[r]}hasGlyph(t,e){return e.glyphs.has(t)}getGlyph(t,e){let i=e.glyphs.get(t);if(!i){let r=e.canvas.width,{ctx:n,scale:o,paddingX:a}=e;n.clearRect(0,0,r,r),d(n,t,a,e.paddingY,e.style);let l=e.textMetricsCache.get(t);l?e.textMetricsCache.delete(t):l=n.measureText(t);const{width:h}=l,c=Math.round(h+2*a)*o;i={char:t,width:h,data:n.getImageData(0,0,c,e.rowHeight),direction:(s=t.charCodeAt(0),(t=>t>=32&&t<=47||t>=58&&t<=64||t>=91&&t<=96||t>=123&&t<=126)(s)||w(s)?0:(t=>t>=1424&&t<=1791||t>=1872&&t<=1919||t>=2208&&t<=2303||t>=64336&&t<=65023||t>=65136&&t<=65279)(s)?-1:1),advanceX:h*o},e.glyphs.set(t,i),e.size++}var s;return i}getTextWidth(t,e){const{ctx:i}=e;let s=0;for(let r of t){let t=e.glyphs.get(r);if(t)s+=t.width;else{let t=e.textMetricsCache.get(r);t||(t=i.measureText(r),e.textMetricsCache.set(r,t)),s+=t.width}}return s}getLetterHeight(t,e){t.textBaseline=e;const i=t.measureText("gM");return i.actualBoundingBoxDescent+i.actualBoundingBoxAscent}}var T=e.Color.toRGB;const S=M.getInstance(),{meterToPixel:A,pixelToMeter:L}=i.webMercator,z=t=>0^Math.min(t,20),P=1/0;let C;var E;!function(t){t[t.Number=0]="Number",t[t.String=1]="String",t[t.Color=2]="Color",t[t.Size=3]="Size",t[t.Boolean=4]="Boolean",t[t.Float=5]="Float"}(E||(E={}));const I={type:{value:E.Number},zIndex:{value:E.Number},fill:{value:E.Color},stroke:{value:E.Color},strokeWidth:{value:E.Size},radius:{value:E.Size},width:{value:E.Size},height:{value:E.Size},font:{value:E.String},text:{value:E.String},textRef:{value:E.String},offsetX:{value:E.Size},offsetY:{value:E.Size},alignment:{value:E.String},rotation:{value:E.Size},priority:{value:E.Size},repeat:{value:E.Number},collide:{value:E.Size},offset:{value:E.Size},from:{value:E.Size},to:{value:E.Size},checkLineSpace:{value:E.Boolean},extrude:{value:E.Size},extrudeBase:{value:E.Size},intensity:{value:E.Float},weight:{value:E.Float},opacity:{value:E.Float},strokeDasharray:{value:E.Size}},R={};for(let t in I)I[t].value==E.Float&&(R[t]=!0);const k=new Map,F=(t,e,i)=>{let s=U("text",t,e,i);if(!s&&t.textRef&&(s=k.get(t.textRef),s==C&&(s=new Function("f","return f."+t.textRef),k.set(t.textRef,s)),s=s(e,i)),""!=s)return s!==C&&"string"!=typeof s&&(s=String(s)),s},D=(t,e,i={})=>{let s={};for(let e in t)s[Math.round(Number(e))]=t[e];for(let t=1;t<=20;t++)i[t]=j(s,t,e);return i},U=(t,i,s,r,n)=>{let o=i[t];return o instanceof e.Expression?o.resolve(s.properties,n||0):(o="function"==typeof o?o(s,r,i,n):o,o)},O=(t,e=!1)=>{let i="px",s=t;return"string"==typeof t&&(s=parseFloat(t)||0,"m"==t.charAt(t.length-1))?(i="m",s=Math.round(1e3*s)/1e3,[s,i]):(e||(s=Math.round(s||0)),[s,i])},B=(t,e,i,s,r)=>{const n=z(s),o=U(t,e,i,n);let[a,l]=O(o,r);if("m"==l){a=Math.pow(2,s%n)*A(a,n)}return a},H=(t,e,i,s)=>{let r=U("zIndex",t,e,i),n=U("zLayer",t,e,i);return"number"!=typeof n&&(n=s+1),1e6*n+r},G=(t,e,i,s)=>{let r=0;const n=z(i);for(let i of t){let t=H(i,e,n,s);t>r&&(r=t)}return r},N=(t,e,i,s,r)=>{let n,o=0,a=0;const l=z(i);for(let h=0;h<t.length;h++){n=t[h];if("Line"==U("type",n,e,l)&&(!r||!U("altitude",n,e,l))){let t=H(n,e,l,s);t>a&&(a=t);const r=B("strokeWidth",n,e,i,!0);r>o&&(o=r)}}return[o,a]},W=(t,e,i,s,r,n)=>{const o=z(i),a=U("type",t,e,o);let l,h,c,u,d,f,p=0,m=0;r=r||[P,P,-1/0,-1/0];const x=U("fill",t,e,o),y=!n&&U("stroke",t,e,o);if("Image"!=a&&!x&&!y)return null;if("Text"==a){const i=F(t,e,o);if(!i)return null;const r=U("strokeWidth",t,e,o);let n=U("font",t,e,o);const a=S.initFont({font:n,strokeWidth:r,fill:x,stroke:y},s);let l;if(d=0,"LineString"==e.geometry.type||"MultiLineString"==e.geometry.type)d=S.getTextWidth(i,a),f=a.letterHeight;else{const s=U("lineWrap",t,e,o);l=g(i,s);for(let t of l){let e=S.getTextWidth(t,a);e>d&&(d=e)}f=l.length*a.letterHeight}const h=U("textAnchor",t,e,o);if("string"==typeof h)switch(h){case"Top":m+=.5*f;break;case"TopLeft":p+=.5*d,m+=.5*f;break;case"TopRight":p-=.5*d,m+=.5*f;break;case"Bottom":m-=.5*f;break;case"BottomLeft":p+=.5*d,m-=.5*f;break;case"BottomRight":p-=.5*d,m-=.5*f}}else{let i=U("strokeWidth",t,e,o);isNaN(i)&&(i=1),"Circle"==a?(d=2*B("radius",t,e,o)^0,f=d):(d=0^B("width",t,e,o),f=B("height",t,e,o),f=0^(f||d)),f+=i,d+=i}p+=0^U("offsetX",t,e,o),m+=0^U("offsetY",t,e,o);let _="Circle"!=a&&0^U("rotation",t,e,o);if(_){const t=((t,e,i,s=0,r=0)=>{const n=s-(e*=.5),o=s+e,a=r-(i*=.5),l=r+i,h=v(n,a,s,r,t),c=v(o,l,s,r,t),u=v(n,l,s,r,t),d=v(o,a,s,r,t);return[Math.min(h[0],c[0],u[0],d[0]),Math.min(h[1],c[1],u[1],d[1]),Math.max(h[0],c[0],u[0],d[0]),Math.max(h[1],c[1],u[1],d[1])]})(_,d,f,p,m);l=t[0],c=t[1],h=t[2],u=t[3]}else l=p-.5*d,h=l+d,c=m-.5*f,u=c+f;return l<r[0]&&(r[0]=l),h>r[2]&&(r[2]=h),c<r[1]&&(r[1]=c),u>r[3]&&(r[3]=u),r},Z=(t,e,i,s,r,n)=>{const o=z(i);let a,l,h=0;for(let c of t){if(n&&U("altitude",c,e,o))continue;l=W(c,e,i,s,l,!0)||l,a=H(c,e,o,r),a>h&&(h=a)}if(l)return l[4]=h,l},Y=t=>t.type&&t.zIndex!=C,V=(t,e=0,i=1)=>Math.min(i,Math.max(e,t)),X=(t,e,i,s,r)=>((t,e,i)=>t*(1-i)+e*i)(i,s,((t,e,i)=>V((i-t)/(e-t)))(t,e,r)),j=(t,e,i=!0)=>{let s,r,n,o,a=0;for(let l in t){const h=Number(l);s=t[h];const c=Array.isArray(s);let u,d;if(c?u=s:i?[u,d]=O(s):u=s,"px"==d&&(s=u),e<=h){if(0==a)return"m"==d?t[h]:u;if(c){let t=[];for(let i=0;i<u.length;i++)t[i]=X(o,h,r[i],u[i],e);return t}if(h-o>1){let t=r,i=u,s=d!=n,a="m"==d;s&&(a?t=L(t,o):i=L(i,h));return X(o,h,t,i,e)+(s||a?"m":0)}return s}o=h,r=u,n=d,a++}return s},q=t=>{for(let e in t)t[e]=T(t[e]);return t},$=(t,e)=>{t=D(t,e);const i=(e,i)=>t[null!=i?i:e];return i.map=t,i},K=(t,i)=>{for(let s of t)if(!s.__p){for(let t in s)if(t in I){const r=s[t];if(e.ExpressionParser.isJSONExp(r)&&("strokeDasharray"!=t||isNaN(r[0].charAt(0))))s[t]=i.parseJSON(r);else if(r&&"object"==typeof r&&!Array.isArray(r)&&!r.type){"stroke"!=t&&"fill"!=t||q(r);const e=!R[t];s[t]=$(r,e)}}s.__p=!0}return t},Q=(t,s,r)=>{const n=U("anchor",t,s,r),{geometry:o}=s;let a;if("Centroid"==n)a=o._c||(o._c=e.geometry.centroid("Polygon"==o.type?o.coordinates:o.coordinates[0]));else if(a=o._pc,!a){const{bbox:t}=s,e=i.webMercator.lat2y(t[1],1),r=i.webMercator.lat2y(t[3],1),n=i.webMercator.y2lat(.5*(r+e),1);a=o._pc=[.5*(t[0]+t[2]),n]}return a};var J=Object.freeze({__proto__:null,calcBBox:W,createZoomRangeFunction:$,fillMap:D,getExtrude:(t,e,i)=>{const s=z(i);for(let i of t){const t=U("extrude",i,e,s);if(t)return t}return null},getLineWidth:N,getMaxZoom:G,getPixelSize:Z,getPolygonCenter:Q,getSizeInPixel:B,getTextString:F,getValue:U,is3d:(t,e,i)=>{const s=z(i);for(let i of t)if(U("altitude",i,e,s)||U("extrude",i,e,s))return!0;return!1},isStyle:Y,merge:(t,e)=>{if(null===e||!1===e)return null;let i,s=[];for(let r=0,n=t.length;r<n;r++){i=t[r],s.push([i[0],{}]);for(let t in i[1])s[r][1][t]=i[1][t];if(e[r]){s[r][0]=e[r][0];for(let t in e[r][1])s[r][1][t]=e[r][1][t]}}return s},parseColorMap:q,parseSizeValue:O,parseStyleGroup:K}),tt=e.vec3.add,et=e.Color.toRGB;const it=[{type:"ambient",color:"#fff",intensity:.3},{type:"directional",color:"#fff",direction:[0,0,1],intensity:1},{type:"directional",color:"#fff",direction:[-1,0,0],intensity:.2}],st=Symbol(),rt=t=>{var e,i;const s=[0,0,0];let r=0,n=t[st];if(n)return n;t[st]=n={};for(let o of t){const t=et(o.color).slice(0,3);switch(o.type){case"directional":const a=`u_directionalLight[${r++}]`;n[`${a}.color`]=t,n[`${a}.intensity`]=null!==(e=o.intensity)&&void 0!==e?e:1,n[`${a}.direction`]=o.direction;break;case"ambient":n["u_ambient.color"]=tt(s,s,t),n["u_ambient.intensity"]=null!==(i=o.intensity)&&void 0!==i?i:1}}return n.u_numDirectionalLights=r,n};rt(it);class nt{constructor(t,e){this.ready=!1,this.cnt=0,this.tiles=[],this.z={},this.zLength=0,this.zd=!1,this._z3d=1/0,this.layer=t,this.tileSize=t.tileSize||null,this.layers=e,this.id=Math.floor(1e16*Math.random()),this.initStyle()}initStyle(){var t,e,i,s;this.expParser=null===(s=null===(e=(t=this.layer).getStyleManager)||void 0===e?void 0:(i=e.call(t)).getExpressionParser)||void 0===s?void 0:s.call(i)}getExpressionParser(){return this.expParser}getTerrainLayer(){return this.layers.getTerrainLayer()}getZ(t){const e=this.z;if(this.zd){let t=0;for(let i in e)e[i]=t++;this.zLength=t,this.zd=!1,this.z3d=e[this._z3d]}return e[t]||0}getAbsoluteZ(t){const{index:e,layers:i}=this;let s=0,r=0;for(;s<e;)r+=i[s++].zLength;return null!=t&&(r+=this.getZ(t)),r}addZ(t,e){const i=this.z;null==i[t]&&(i[t]=0,this.zd=!0,e&&t<this._z3d&&(this._z3d=t))}getZ3d(){const{layers:t}=this;let e,i=0,s=0;for(;e=t[i++];){if(e._z3d>=0)return s+e.z3d;s+=e.zLength}return s}processStyleGroup(t,e){var i,s;const r=null===(s=(i=this.layer).getStyleGroup)||void 0===s?void 0:s.call(i,t,e);return r&&K(r,this.expParser),r}getLights(t){var e,i;const s=null===(i=(e=this.layer).getStyleManager)||void 0===i?void 0:i.call(e);let r=(null==s?void 0:s.lights)||{};return r.defaultLight||(r.defaultLight||(r.defaultLight=it),s&&(s.lights=r)),r}reset(t){const e=this,i=e.layer;if(e.error=!1,e.cnt=0,e.tiles=[],e.visible=i.isVisible(t)){if(e.ready=!1,i.custom)return;return i.tileSize}e.ready=!0}getRenderIndex(){return this.index+1}}class ot extends Array{constructor(...t){super(...t),this._map={},Object.setPrototypeOf(this,ot.prototype)}indexOf(t){let e=this._map[t.id];return super.indexOf(e)}fixZ(){for(let t=0;t<this.length;t++)this[t].index=t}add(t,e){const s=t.id;let r,n=this._map[s];return n?(this.splice(super.indexOf(n),1),this.splice(e,0,n),r=!1):(n=this._map[s]=new nt(t,this),t instanceof i.TerrainTileLayer&&(this._terrainLayer=n),this.splice(e,0,n),r=!0),this.fixZ(),r}remove(t){let e=this.indexOf(t);return-1!==e&&(this[e]===this._terrainLayer&&(this._terrainLayer=null),this.splice(e,1),delete this._map[t.id],this.fixZ()),e}getTerrainLayer(){return this._terrainLayer}get(t){return"string"!=typeof t&&(t=t.id),this._map[t]}reset(t){const e=new Set;for(let i of this){let s=i.reset(t);s&&e.add(s)}return Array.from(e)}}class at{constructor(t,e){this.display=t,this.render=e}forEachTile(t,e){t.getProvider().getCachedTiles(t.getBBox()).forEach(e)}remove(t,e,i){for(let s of e)this.removeFromTile(t,s,i)}modifyInTile(t,e,i,s){let r=this.isVertexDataInitialized(e);return!!r&&(this.display.updateTile(e,r,s,t),!0)}isVertexDataInitialized(t){return this.display.getBucket(t.quadkey)}addToTile(t,e,i){const s=this.isVertexDataInitialized(e);s&&this.display.updateTile(e,s,i,t)}removeFromTile(t,e,i){let s=this.isVertexDataInitialized(e);s&&this.display.updateTile(e,s,i,t)}add(t,e,i){for(let s of e)this.addToTile(t,s,i)}updateGeometry(t,e,i,s){let r=s.getProvider(),n=r.getCachedTiles(e),o=r.getCachedTiles(t.getBBox());for(var a=0,l=o.length;a<l;a++){let e=n.indexOf(o[a]);-1===e?this.addToTile(t,o[a],s):(this.modifyInTile(t,o[a],i,s),n.splice(e,1))}for(a=0,l=n.length;a<l;a++)this.removeFromTile(t,n[a],s),this.removeFromTile(t,n[a],s)}repaint(t,e,i){let s=this;s.forEachTile(t,(function(e){let r=s.isVertexDataInitialized(e);r?s.display.updateTile(e,r,i,t):e.preview&&(e.preview=undefined)}))}clear(t,e){e=e||[];const i=this.display,s=i.layers.indexOf(t);i.buckets.forEach((function(i){e.length&&!((t,e)=>{let i=t.length;for(var s,r,n=0;n<e.length;n++)if(r=t,s=e[n],i>e[n].length&&(s=r,r=e[n]),0===s.search(r))return!0})(i.quadkey,e)||(i.clear(s),i.ready(s,!1),i.cancelTasks(t),i.luTs=null)})),i.update()}}const lt=[];class ht{constructor(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}lookUp(t,e,i,s,r,n){const o=t.quadkey;let a,l,h=i-s;if(a=Number(o[h]),n.x+=a%2*e/2,n.y+=Number(a>1)*e/2,l=o.substring(0,h),this.hasData(l,r)){let t=e/Math.pow(2,s);const i=[];return this.add(i,l,n.x,n.y,t,0,0,e),i}n.x/=2,n.y/=2}add(t,e,i,s,r,n,o,a){t.push([e,i,s,r,r,0^n,0^o,a,a])}hasData(t,e){const i=this.display.buckets.get(t,!0);if(i)return i.ready(e)&&i.getData(e)}lookDown(t,e,s,r,n){let o,a,l,h,c,u,d=s+r;o=i.tileUtils.getTilesOfLevel(t.quadkey,d);for(let t=0;t<o.length;t++){a=l=0,h=e;for(let i=0;i<r;i++)h/=2,c=o[t][s+i],a+=c%2*h,l+=Number(c>1)*h,i==r-1&&this.hasData(o[t],n)&&(u||(u=[]),this.add(u,o[t],0,0,e,a,l,h))}return u}create(t,e,i,s){const r=t.quadkey.length,n=e.min,o=e.max,a=o-r,l=r-n,h={x:0,y:0};let c,u,d,f=0,p=e.tileSize;i=i||this.down,(s=s||this.up)>l&&(s=l),i>a&&(i=a);const g=s>i?s:i,m=t.index(e);for(;f++<g;){if(u=r-f,u>=n&&(c=this.lookUp(t,p,r,f,m,h)))return c;if(d=r+f,d<=o&&f<i&&(c=this.lookDown(t,p,r,f,m)))return c}return lt}}const ct=1/0;class ut{constructor(t,e,s,r,n,o,a){this.quadkey=i.tileUtils.tileXYToQuadKey(t,o,n),this.tileZoomLevel=t,this.x=e,this.y=s,this.scaledSize=r,this.gridX=n,this.gridY=o,this.bounds=a,this.resultCache={}}static updateTileBBox(t,e,i){const s=ut.tileGeoContainer,[r,n,o,a]=s,l=t+i,h=e+i;return r[0]=t,r[1]=e,n[0]=l,n[1]=e,o[0]=l,o[1]=h,a[0]=t,a[1]=h,s}static intersects(t,e,i,s){return((t,e)=>{for(let i of[t,e])for(let s=0;s<i.length;s++){let r,n=m,o=m,a=m,l=m,h=(s+1)%i.length,c=i[s],u=i[h],d=[u[1]-c[1],c[0]-u[0]];for(let e of t)r=d[0]*e[0]+d[1]*e[1],(n===m||r<n)&&(n=r),(o===m||r>o)&&(o=r);for(let t of e)r=d[0]*t[0]+d[1]*t[1],(a===m||r<a)&&(a=r),(l===m||r>l)&&(l=r);if(o<a||l<n)return!1}return!0})(t,ut.updateTileBBox(e,i,s))}generateTileHierarchy(t,e=ut.minTileSize,i=!0,s=[]){const r=e+Number(i),n=this.resultCache;if(n[r])return n[r];n[r]=s;let{tileZoomLevel:o,gridX:a,gridY:l,scaledSize:h}=this;if(h>e){const r=t.s,n=t.computeDistanceScale(this.x+h/2,this.y+h/2)/r,c=Math.log2(h/e);if(i){if(n*Math.sin(t.rx)>c)return s.push(this),s}o+=1,h*=.5,a*=2,l*=2;for(let[r,n]of[[0,0],[1,0],[0,1],[1,1]]){const c=this.x+r*h,u=this.y+n*h;if(ut.intersects(this.bounds,c,u,h)){new ut(o,c,u,h,a+r,l+n,this.bounds).generateTileHierarchy(t,e,i,s)}}}else{if(!i&&t.isPointAboveHorizon(this.x+h/2,this.y+h/2))return s;s.push(this)}return s}}ut.minTileSize=256,ut.tileGeoContainer=[[0,0],[0,0],[0,0],[0,0]];class dt{constructor(t){this.size=t}init(t,e,i,s){this.cwpx=t[0],this.cwpy=t[1],this.width=e,this.height=i,this.bounds=s;let r=ct,n=-r,o=ct,a=-o;for(let[t,e]of s)t<r&&(r=t),t>n&&(n=t),e<o&&(o=e),e>a&&(a=e);this.minX=r,this.maxX=n,this.minY=o,this.maxY=a}getTiles(t,e=3){const{width:i,height:s}=this;let r=512*(1<<e),n=t-e-Number(!0);const o=Math.pow(2,n)*r,a=this.cwpx*o,l=this.cwpy*o;let h=(a-i/2+this.minX)/r,c=(l-s/2+this.minY)/r,u=(a+i/2+this.maxX-i)/r,d=(l+s/2+this.maxY-s)/r,f=Math.floor(h),p=Math.floor(c),g=Math.floor(u)-f+1,m=Math.floor(d)-p+1,v=(f-h)*r+this.minX,x=(p-c)*r+this.minY;const y=[];for(let t=0;t<m;t++)for(let e=0;e<g;e++){const i=v+e*r,s=x+t*r;if(ut.intersects(this.bounds,i,s,r)){const o=new ut(n,i,s,r,f+e,p+t,this.bounds);y.push(o)}}return y}}const ft=!0;function pt(t,e,i){if(e[t+="EventListener"])for(var s in i)e[t](s,i[s])}class gt{constructor(t,e,i,s,r,o){this.updating=!1,this.dirty=!1,this.globalBgc=!1;const a=this,l=n(t,"width"),h=n(t,"height"),c=((t,e,i,s,r)=>{let n,o,a=document.createElement("canvas"),l=a.style;return((t,e,i)=>{t.setAttribute("width",e),t.setAttribute("height",i)})(a,e,i),a.setAttribute("oncontextmenu","return false;"),((t,e)=>{["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach((function(i){t.style[i]=e}))})(a,"none"),l.top=l.left="0px",l.position="absolute",1!=r&&(l.opacity=String(r)),t.querySelectorAll("canvas[type=layer]"),a.setAttribute("type","layer"),n=t.querySelectorAll("canvas"),o=n[s],o?t.insertBefore(a,o):t.appendChild(a),a})(t,l,h,0);a.previewer=new ht(a,o),a.grid=new dt(e),a.render=r,a.tileSize=e,a.buckets=s,a.layers=new ot,a.w=l,a.h=h,a.canvas=c,c.className="tmc",a.dpr=gt.getPixelRatio(i),a.setSize(l,h),a.setBGColor();const u=new at(a,r);a.listeners={clear:t=>{const{tiles:e,layer:i}=t.detail;u.clear(i,e)},featuresAdd:t=>{const{features:e,tiles:i,layer:s}=t.detail;(null==i?void 0:i.length)&&u.add(e,i,s)},featuresRemove:t=>{const{features:e,tiles:i,layer:s}=t.detail;i&&u.remove(e,i,s)},featureCoordinatesChange:t=>{const{feature:e,prevBBox:i,prevCoordinates:s,layer:r}=t.detail;u.updateGeometry(e,i,s,r)},styleGroupChange:t=>{const{feature:e,styleGroup:i,layer:s}=t.detail;u.repaint(e,i,s)},styleChange:t=>{const{layer:e,style:i}=t.detail,s=a.layers.get(e),{index:r}=s;s.initStyle(),a.setLayerBgColor(i,a.layers[r]),a.buckets.tiles.forEach((t=>t.clear(r)))}}}static getPixelRatio(t){return(t="auto"==t?Math.min(2,e.global.devicePixelRatio||1):t||1)<1?1:t}addLayer(t,e,i){const s=this,r=s.layers;if(r.add(t,e)){const n=r.get(t);return s.buckets.forEach((t=>{t.addLayer(e)})),pt("add",t,s.listeners),t.custom?n:(null==i||i.clearCache(),n.handleTile=e=>{s.isVisible(e,n)&&s.handleTile(e,t)},0==e&&s.setLayerBgColor(t.getStyleManager(),n),n)}}removeLayer(t){const e=this,i=this.layers,s=i.get(t),r=s.tiles,n=i.indexOf(t);if(-1!==n){e.buckets.forEach((e=>{e.cancelTasks(t),e.removeLayer(n)}));for(let i of r){const r=i.tile.quadkey;e.releaseTile(r,s),e.cancel(r,t)}i.remove(t),pt("remove",t,e.listeners)}return n}getBucket(t,e){const i=this;let s;return s=e?i.buckets.create(t,i.layers):i.buckets.get(t),s}handleTile(t,e,i,s){const r=this;let n,o=!1;if(i?o=!0:i=r.getBucket(t.quadkey,ft),null==s&&(s=r.layers.indexOf(e)),t.error&&(r.layers[s].error=!0),!i.ready(s)&&!i.busy(e)&&(n=t.data)){const a=(e,i)=>{t.isLoaded()&&e.ready(e.index(i),!0),r.update(o)};i.ready(s,!1);let l=e.render;l?l(t,n,e,i,a):r.prepareTile(t,n,e,i,a)}}computeDistanceScale(t,e){return 1}setLayerBgColor(t,e){e.bgColor=this.parseColor(t.backgroundColor)}parseColor(t){if(t)return"object"!=typeof t||Array.isArray(t)||(t=$(q(t))),"function"==typeof t?t:this.render.convertColor(t)}processLayerBackgroundColor(t){var e;const i=this,s=(null===(e=i.layers[0])||void 0===e?void 0:e.bgColor)||i.globalBgc;this.bgColor="function"==typeof s?i.render.convertColor(s(0^t)):s}isVisible(t,e){const i=t.quadkey;for(let t of e.tiles)if(t.tile.quadkey==i)return!0;return!1}getContext(){return this.render.getContext()}copyCanvas2d(t=0,e=0,i=this.w,s=this.h){const{canvas:r,dpr:n}=this;t*=n,e*=n,i*=n,s*=n;const o=document.createElement("Canvas");return o.width=i,o.height=s,this.viewport(),o.getContext("2d").drawImage(r,t,e,i,s,0,0,i,s),o}getScreenTile(t,e){return this.tiles.find((e=>e.quadkey==t))}updateTile(t,e,i,s){if(!e)return;const r=e.busy(i);if(r)r.isInterrupted()&&(r.outdated=!0);else{const s=this,r=e.index(i);e.ready(r,!1),s.layers[r].handleTile(t)}}setSize(t,e){const i=this,{dpr:s,canvas:r}=i;i.w=t,i.h=e,r.width=t*s,r.height=e*s,r.style.width=t+"px",r.style.height=e+"px"}cancel(t,e){const i=this.buckets.get(t,!0);i&&i.cancelTasks(e)}preview(t,e,i){const s=this.previewer.create(t,e);return t.preview(i,s),s}useLODTiles(){return!1}initVpTiles(t,e,i){const s=this,r=this.layers,n=s.tiles||[],o=s.tiles=[],a=s.w/2,l=s.h/2,h=this.useLODTiles();for(let i of r){i.reset(e);const r=i.layer;if(!r.tiled)continue;let c=r.tileSize||256,u=c,d=[];if(i.tiles=d,r.isVisible(e)){const e=h&&r.adaptiveGrid,f=t.flatMap((t=>t.generateTileHierarchy(s,c,e)));f.sort(((t,e)=>Math.hypot(t.x-a,t.y-l)-Math.hypot(e.x-l,e.y-l)));for(let t of f){const{quadkey:e,scaledSize:n}=t,a=s.getBucket(e,ft),l=n/u;t.scale=l,t.size=u,t.tile=a,d.push(t),o.find((i=>i.quadkey==e&&i.x==t.x&&i.y==t.y))||(o.push(t),a.i=++this.ti),s.initTile(a,i),r.getTile(e,i.handleTile)}this.freeStaleTilesLayer(d,n,i)}}}freeStaleTilesLayer(t,e,i){for(const{quadkey:s,size:r}of e){let e=!0;for(const{quadkey:i,size:n}of t)if(i==s&&r==n){e=!1;break}if(e){const t=i.layer;t.tileSize==r&&this.releaseTile(s,i),this.cancel(s,t)}}}getCamGroundPositionScreen(){return[this.w/2,this.h/2]}getHorizonYOffset(){return 0}isPointAboveHorizon(t,e){return!1}updateGrid(t,e,i,s){const r=this.centerWorld;this.processLayerBackgroundColor(e),this.setZoom(e),this.viewChange=!0,this.sx=i,this.sy=s;const n=this,o=this.w,a=this.h,l=o,h=Math.max(a,this.getCamGroundPositionScreen()[1]),c=this.getHorizonYOffset(),u=[n.unproject(0,c),n.unproject(l-1,c),n.unproject(l-1,h-1),n.unproject(0,h-1)];this.grid.init(r,o,a,u),this.ti=0;const d=n.grid.getTiles(t);this.initVpTiles(d,t),this.dirty=!0,n.update()}releaseTile(t,e){const i=e.layer,s=i.getCachedTile(t);s&&s.loadStartTs&&(s.isLoaded()||i.cancelTile(s,e.handleTile))}initTile(t,e){const i=e.index,s=this;e.visible?t.ready(i)||t.preview(i)||s.preview(t,e.layer,i):t.ready(i,!0)}update(t){const e=this;e.dirty||(e.dirty=t),e.updating||(e.updating=!0,requestAnimationFrame((()=>{e.viewport(),e.updating=!1})))}setBGColor(t="#ffffff"){const{render:e}=this;"transparent"==t&&(t="rgba(0, 0, 0, 0)"),t=this.parseColor(t),this.globalBgc=t,e.setBackgroundColor(t)}showGrid(t){this.render.grid(t)}setView(t,e,i,s,r,n){this.centerWorld=t,this.setTransform(e,i,s)}setTransform(t,e,i){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=i),this.render.applyTransform()}getLayers(){return this.layers}destroy(){this.render.destroy();var t=this.canvas;t.parentElement.removeChild(t),t.width=t.height=1}clearLayer(t){const e=this.getLayers().indexOf(t);this.buckets.forEach((t=>{t.preview(e,!1),t.ready(e,!1)}))}viewChangeDone(){this.viewChange=!1}getRenderedFeatureAt(t,e,i){return{id:null}}scaleOffsetXYByAltitude(t){return 1}setZoom(t){if(this.zoom!=t)return this.zoom=t,!0}getTerrainHeightAtWorldXY(t,e,i){return null}}const mt=window.console.error,vt=(t,e,i,s=mt)=>{const r=t.createShader(i);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){return s("compileShader "+t.getShaderInfoLog(r)),t.deleteShader(r),null}return r},xt=(t,e,i)=>{const s=vt(t,e,t.VERTEX_SHADER),r=vt(t,i,t.FRAGMENT_SHADER),n=((t,e,i=mt)=>{const s=t.createProgram();for(let i of e)t.attachShader(s,i);if(t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))return i("linkProgram "+t.getProgramInfoLog(s)),t.deleteProgram(s),null;return s})(t,[s,r]);return t.detachShader(n,s),t.detachShader(n,r),t.deleteShader(s),t.deleteShader(r),n},yt=(t,e,i=mt)=>t.replace(/(?<!\/\/.*)#include\s+"([^"]+?)(?:\/([^"]+))?"/g,((t,s,r)=>{let n=e[s];if(n){if(r){const t=function(t,e){const i="#begin",s="#end",r=new RegExp(`${i}\\s+${e}[\\s\\S]*?${s}\\s+${e}`,"g"),n=t.match(r);return null==n?void 0:n[0].replace(`${i} ${e}`,"").replace(`${s} ${e}`,"").trim()}(n,r);if(null==t)return void i(`Block "${r}" not found in "${s}".`);n=t}return n}i(`Include file "${s}" not found.`)}));class _t{constructor(t){for(var e in t)this[e]=t[e]}}var bt;!function(t){t[t.OPAQUE=1]="OPAQUE",t[t.ALPHA=2]="ALPHA",t[t.POST_ALPHA=4]="POST_ALPHA"}(bt||(bt={}));const wt={"light.glsl":"#define GLSLIFY 1\nstruct AmbientLight{vec3 color;float intensity;};struct EmissiveLight{vec3 color;};struct DirectionalLight{vec3 color;float intensity;vec3 direction;};\n#define MAX_DIR_LIGTHS 6\nuniform EmissiveLight u_emissive;uniform AmbientLight u_ambient;uniform DirectionalLight u_directionalLight[MAX_DIR_LIGTHS];uniform int u_numDirectionalLights;vec4 computeBaseLighting(vec3 normal,vec3 color,float colorIntensity,float alpha){vec3 totalLighting=color*u_ambient.color*u_ambient.intensity;for(int i=0;i<MAX_DIR_LIGTHS;i++){if(i>=u_numDirectionalLights)break;vec3 lightDir=normalize(u_directionalLight[i].direction);float diff=max(dot(normal,lightDir),0.0);vec3 directionalColor=u_directionalLight[i].color*color*colorIntensity;vec3 diffuse=diff*directionalColor*u_directionalLight[i].intensity;totalLighting+=diffuse;}vec3 emissive=u_emissive.color*alpha;return vec4(totalLighting+emissive,alpha);}vec4 addSpecularHighlights(vec3 normal,vec4 totalLighting,vec3 surfaceToCam,float shininess,vec3 specular){for(int i=0;i<MAX_DIR_LIGTHS;i++){if(i>=u_numDirectionalLights)break;vec3 lightDir=normalize(u_directionalLight[i].direction);vec3 viewDir=normalize(surfaceToCam);vec3 halfwayDir=normalize(lightDir+viewDir);float spec=pow(max(dot(normal,halfwayDir),0.0),shininess);totalLighting.rgb+=specular*spec*u_directionalLight[i].color*u_directionalLight[i].intensity;}return totalLighting;}\n#ifdef SPECULAR\nvec4 computeLighting(vec3 normal,vec3 color,float colorIntensity,float alpha,vec3 surfaceToCam,float shininess,vec3 specular){vec4 light=computeBaseLighting(normal,color,colorIntensity,alpha);light=addSpecularHighlights(normal,light,surfaceToCam,shininess,specular);return light;}\n#else\nvec4 computeLighting(vec3 normal,vec3 color,float colorIntensity,float alpha){return computeBaseLighting(normal,color,colorIntensity,alpha);}\n#endif\n","utils.glsl":"#define GLSLIFY 1\n#begin heightMapUtils\n#if defined(USE_HEIGHTMAP) || defined(TERRAIN_MODEL_HM)\nuniform sampler2D uHeightMap;uniform vec2 uHeightMapTileSize;uniform float meterPerpixel;float getTerrainHeight(vec2 tilePixelPos){float texSize=uHeightMapTileSize.x;float tileSize=uHeightMapTileSize.y;vec2 uv=(tilePixelPos+0.5)/tileSize;return texture2D(uHeightMap,uv).r;}float sampleHeightWithPadding(vec2 tilePixelPos){float texSize=uHeightMapTileSize.x;float tileSize=uHeightMapTileSize.y;float invTexSize=1.0/texSize;vec2 uv=(tilePixelPos*((texSize-2.0)/tileSize)+1.0+0.5)*invTexSize;uv=clamp(uv,vec2(invTexSize*0.5),vec2(1.0-invTexSize*0.5));return texture2D(uHeightMap,uv).r;}vec3 getTerrainNormal(vec2 tilePixelPos){float hL=getTerrainHeight(tilePixelPos+vec2(-1.0,0.0));float hR=getTerrainHeight(tilePixelPos+vec2(1.0,0.0));float hD=getTerrainHeight(tilePixelPos+vec2(0.0,-1.0));float hU=getTerrainHeight(tilePixelPos+vec2(0.0,1.0));float heightScale=u_zMeterToPixel/uHeightMapTileSize.y;float dx=(hR-hL)*heightScale;float dy=(hU-hD)*heightScale;return normalize(vec3(-dx,-dy,1.0));}\n#endif\n#end heightMapUtils\n#begin altitudeScaleFactor\nuniform bool u_scaleByAltitude;float altitudeScaleFactor(vec3 posWorld,mat4 u_matrix){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);scaleDZ=clamp(scaleDZ,0.5,2.0);return mix(scaleDZ,1.0,float(u_scaleByAltitude));}\n#end altitudeScaleFactor\n"};let Mt;class Tt{constructor(t,e,i,s){this.attributeLocations={},this.attributeDivisors=[],this.uniforms={},this.uniformSetters={},this.terrainPreviewMaxTiles=8,this.macros={M_PI:3.1415927410125732},this.dpr=e,this.usage=t.STATIC_DRAW,i&&(this.macros=Object.assign(Object.assign({},this.macros),i)),this.mode=s||t.TRIANGLES,this.gl=t,this.framebuffer=null,this.glStates=new _t({scissor:!0,blend:!1,depth:!0})}static getMacros(t){return t.heightMapRef?{USE_HEIGHTMAP:128}:null}static getProgramId(t,e){return t.type}init(t,e){this.compile(this.vertexShaderSrc,this.fragmentShaderSrc,this.macros),this.setBufferCache(t),this.glExtAngleInstancedArrays=e}initBuffers(t){const e=this.gl;for(let i in t){let s=t[i];if(s.value)continue;let r=this.buffers.get(s);r||(r=e.createBuffer(),this.buffers.set(s,r)),s.dirty&&(s.dirty=!1,e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,s.data,e.STATIC_DRAW))}}createUniformSetter(t,e){const{gl:i}=this;switch(t.type){case i.FLOAT:return t=>i.uniform1f(e,t);case i.FLOAT_MAT3:return t=>i.uniformMatrix3fv(e,!1,t);case i.FLOAT_MAT4:return t=>i.uniformMatrix4fv(e,!1,t);case i.FLOAT_VEC2:return t=>i.uniform2fv(e,t);case i.FLOAT_VEC3:return t=>i.uniform3fv(e,t);case i.FLOAT_VEC4:return t=>i.uniform4fv(e,t);case i.BOOL:case i.INT:return t=>i.uniform1i(e,t);case i.SAMPLER_2D:if(1===t.size){const t=this.texUnitCount++;return s=>{i.uniform1i(e,t),i.activeTexture(i.TEXTURE0+t),null==s||s.bind()}}const s=this.texUnitCount;this.texUnitCount+=t.size;const r=new Int32Array(t.size);for(let e=0;e<t.size;e++)r[e]=s+e;return t=>{var s;const n=t.length;for(let e=0;e<n;e++)i.activeTexture(i.TEXTURE0+r[e]),null===(s=t[e])||void 0===s||s.bind();i.uniform1iv(e,r)}}return()=>{}}buildSource(t,e,i){i=Object.assign(Object.assign(Object.assign({},this.macros),{DEVICE_PIXEL_RATIO:this.dpr.toFixed(1)}),i);let s="";for(let t in i)s+=`#define ${t} ${i[t]}\n`;return[yt(s+"#define GLSLIFY 1\nvec2 round(vec2 point){vec2 fractPoint=fract(point);point+=step(0.5,fractPoint)-fractPoint;return point;}vec4 snapToScreenPixel(vec4 position,vec2 resolution){resolution*=DEVICE_PIXEL_RATIO;vec2 screenPixel=((position.xy/position.w+1.0)/2.0)*resolution;position.xy=(round(screenPixel)/resolution*2.0-1.0)*position.w;return position;}vec3 rotateY(vec3 v,float a){float s=sin(a);float c=cos(a);return mat3(c,0.0,-s,0.0,1.0,0.0,s,0.0,c)*v;}vec2 rotateZ(vec2 v,float a){float s=sin(a);float c=cos(a);return v*mat2(c,-s,s,c);}float toPixel(vec2 size,float zoom){float value=size.x;if(size.y>0.0){value*=zoom*size.y;}return value;}const float SCALE_UINT16_Z=9000.0/65535.0;"+t,wt),yt(s+e,wt)]}compile(t,e,i){const{gl:s}=this,[r,n]=this.buildSource(t,e,i||{}),o=xt(s,r,n);this.prog=o,this.texUnitCount=0;let a=s.getProgramParameter(o,s.ACTIVE_ATTRIBUTES);for(let t=0;t<a;++t){const e=s.getActiveAttrib(o,t),{name:i,type:r}=e,n=s.getAttribLocation(o,i),a=r==s.FLOAT_MAT2?2:r==s.FLOAT_MAT3?3:r==s.FLOAT_MAT4?4:1;this.attributeLocations[i]={index:n,length:a}}let l=s.getProgramParameter(o,s.ACTIVE_UNIFORMS);for(let t=0;t<l;t++){const e=s.getActiveUniform(o,t),i=e.name,r=s.getUniformLocation(o,i);this.uniforms[i]=r,this.uniformSetters[e.name]=this.createUniformSetter(e,r)}}setBufferCache(t){this.buffers=t}getUniformLocation(t){return this.uniforms[t]}initUniform(t,e){var i,s;null===(s=(i=this.uniformSetters)[t])||void 0===s||s.call(i,e)}initUniforms(t){for(let e in t)this.initUniform(e,t[e])}initViewUniforms(t){}setConstantAttributeValue(t,e){const{gl:i}=this;switch(i.disableVertexAttribArray(t),e.length){case 4:i.vertexAttrib4fv(t,e);break;case 3:i.vertexAttrib3fv(t,e);break;case 2:i.vertexAttrib2fv(t,e);break;case 1:i.vertexAttrib1fv(t,e)}}initAttributes(t){var e;const{gl:i,buffers:s,attributeLocations:r,attributeDivisors:n}=this;for(let o in t){let a=t[o];if(!r[o])continue;let{index:l,length:h}=r[o];const{value:c}=a;if(null!=c){for(let t=0;t<h;++t){const e=l+t;this.setConstantAttributeValue(e,c)}continue}let u=a,d=u.instanced;i.bindBuffer(i.ARRAY_BUFFER,s.get(u));const f=u.bytesPerElement,p=0|Number(d),g=u.stride^0+u.size*f,m=0^u.offset,v=u.size/h;for(let t=0;t<h;++t){const s=l+t;i.enableVertexAttribArray(s),i.vertexAttribPointer(s,v,u.type,u.normalized,g,m+t*v*f),n[s]=p,d&&(null===(e=this.glExtAngleInstancedArrays)||void 0===e||e.vertexAttribDivisorANGLE(s,1))}}}initIndex(t){const{buffers:e,gl:i}=this;let s=e.get(t),r=!0;s||(s=i.createBuffer(),e.set(t,s),r=!1),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s),r||i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.data,i.STATIC_DRAW)}isBufferVisible(t){return!0}initPass(t,e){const i=Boolean(t&e.pass);return i&&this.bindFramebuffer(null),i}dbgGLState(t){const{gl:e}=this;this.__dbgGlEnums||(this.__dbgGlEnums=(t=>{for(let i of["NEVER","LESS","LEQUAL","GREATER","GEQUAL","EQUAL","NOTEQUAL","ALWAYS","KEEP","ZERO","REPLACE","INCR","INCR_WRAP","DECR","DECR_WRAP","INVERT"])t[e[i]]=i;return t})({}))}draw(t,e){var i,s;const{gl:r}=this,{groups:n,instances:o}=t;for(let t of n){let e=t.mode!=Mt?t.mode:this.mode;if(t.uniforms&&this.initUniforms(t.uniforms),t.index){const s=t.index,n=s.length,a=s.type;this.initIndex(s),o?null===(i=this.glExtAngleInstancedArrays)||void 0===i||i.drawElementsInstancedANGLE(e,n,a,0,o):r.drawElements(e,n,a,0)}else{const i=t.arrays.first,n=t.arrays.count;o?null===(s=this.glExtAngleInstancedArrays)||void 0===s||s.drawArraysInstancedANGLE(e,i,n,o):r.drawArrays(e,i,n)}}}toggleCapability(t,e){e?this.gl.enable(t):this.gl.disable(t)}blendFunc(t=this.gl.ONE,e=this.gl.ONE_MINUS_SRC_ALPHA){this.gl.blendFunc(t,e)}initGeometryBuffer(t,e,i){var s,r,n;const o=this,{gl:a,glStates:l}=o;this._pass=e;const h=null!==(s=t.blend)&&void 0!==s?s:l.blend,c=null!==(r=t.depth)&&void 0!==r?r:l.depth,u=null!==(n=t.clip)&&void 0!==n?n:l.scissor,{scissorBox:d}=t,f=!!d;d&&a.scissor(d[0],d[1],d[2],d[3]),o.toggleCapability(a.SCISSOR_TEST,f),o.toggleCapability(a.BLEND,h),o.toggleCapability(a.DEPTH_TEST,c),o.toggleCapability(a.STENCIL_TEST,u),this.blendFunc();const p=t.cullFace();p&&a.cullFace(p),o.toggleCapability(a.CULL_FACE,!!p),null!=t.depthMask&&a.depthMask(t.depthMask);const g=t.colorMask||this.colorMask;null!=g&&a.colorMask(g.r,g.g,g.b,g.a),a.disable(a.POLYGON_OFFSET_FILL)}disableAttributes(){var t;const{attributeLocations:e,attributeDivisors:i,gl:s}=this;for(let r in e){let{index:n,length:o}=e[r];for(;o--;){let e=n+o;i[e]&&(null===(t=this.glExtAngleInstancedArrays)||void 0===t||t.vertexAttribDivisorANGLE(e,0),i[e]=0),s.disableVertexAttribArray(e)}}}delete(){this.gl.deleteProgram(this.prog)}bindFramebuffer(t=this.framebuffer,e=this.gl.canvas.width,i=this.gl.canvas.height){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.viewport(0,0,e,i)}setResolution(t){}setColorMask(t){this.colorMask=t}initLight(t,e){this.initUniforms(t),this.initUniform("u_camWorld",e)}initHeightMap(t,e){var i;if(performance.now(),!t.heightMapRef&&!t.heightMap)return;let s,r=e.tileSize;if(t.heightMap)s=t.heightMap.size;else if("string"==typeof t.heightMapRef){const n=t.heightMapRef;let o=null===(i=e.get(n))||void 0===i?void 0:i.texture;o||(o=e.getEmptyTexture(),r=o.width-e.tilePadding),s=o.width,this.initUniform("uHeightMap",o)}this.gl.uniform2f(this.getUniformLocation("uHeightMapTileSize"),s,r)}}class St extends Tt{constructor(t,e,i){super(t,e,i),this.name="Rect",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform float u_scale;uniform vec4 u_size;uniform mat4 u_matrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_alignMap;uniform vec2 u_resolution;uniform float u_normalizePosition;varying vec2 vSize;varying vec2 vDir;\n#include "utils.glsl/heightMapUtils"\n#include "utils.glsl/altitudeScaleFactor"\nvoid main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;vec2 size=vec2(toPixel(u_size.xy,u_scale),toPixel(u_size.zw,u_scale));size=(size+u_strokeWidth)*.5;float rotation=u_rotation;if(!u_alignMap){rotation*=-1.0;}vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));\n#ifdef USE_HEIGHTMAP\nfloat z=getTerrainHeight(pos);\n#else\nfloat z=a_position.z*SCALE_UINT16_Z;\n#endif\nz+=toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){vec2 posCenterWorld=u_topLeft+pos;vec2 shift=(pixel_offset+rotateZ(dir*vec2(size.x,-size.y),rotation))/u_scale;vec3 posWorld=vec3(posCenterWorld+shift,z);shift*=altitudeScaleFactor(posWorld,u_matrix);gl_Position=u_matrix*vec4(posCenterWorld+shift,z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,z,1.0);vec2 shift=rotateZ(dir*size,rotation);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}vSize=size;vDir=dir;}}',this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying vec2 vSize;varying vec2 vDir;\n#define COLOR_UNDEF -1.0\nvoid main(void){float dx=distance(vDir.x,0.0)*vSize.x;float dy=distance(vDir.y,0.0)*vSize.y;if(dx>vSize.x-u_strokeWidth||dy>vSize.y-u_strokeWidth){gl_FragColor=u_stroke;}else{gl_FragColor=u_fill;if(u_fill[0]==COLOR_UNDEF){gl_FragColor.a=0.0;};}}"}static getProgramId(t,e){return t.type+((null==e?void 0:e.USE_HEIGHTMAP)||"")}}class At extends Tt{constructor(t,e,i){super(t,e,i),this.name="Circle",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform float u_scale;uniform vec2 u_resolution;uniform bool u_alignMap;uniform float u_strokeWidth;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform float u_normalizePosition;varying vec2 v_position;varying float v_radius;\n#include "utils.glsl/heightMapUtils"\n#include "utils.glsl/altitudeScaleFactor"\nvoid main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;float radius=toPixel(u_radius,u_scale);radius=radius+u_strokeWidth/2.0;v_position=dir*radius;v_radius=radius;vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));\n#ifdef USE_HEIGHTMAP\nfloat z=getTerrainHeight(pos);\n#else\nfloat z=a_position.z*SCALE_UINT16_Z;\n#endif\nz+=toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec3 posWorld=vec3(u_topLeft+pos,z);if(u_alignMap){vec2 shift=(pixel_offset+v_position*vec2(1.0,-1.0))/u_scale;shift*=altitudeScaleFactor(posWorld,u_matrix);gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(posWorld,1.0);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+v_position)/u_resolution*2.0,cpos.z/cpos.w,1.0);}}}',this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying float v_radius;varying vec2 v_position;\n#define COLOR_UNDEF -1.0\nvoid main(void){float r=length(v_position);if(r>v_radius)discard;if(r<v_radius-u_strokeWidth){if(u_fill[0]==COLOR_UNDEF)discard;gl_FragColor=u_fill;}else{gl_FragColor=u_stroke;}}"}static getProgramId(t,e){return t.type+((null==e?void 0:e.USE_HEIGHTMAP)||"")}}var Lt='precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute highp vec4 a_normal;attribute float a_lengthSoFar;uniform mat4 u_matrix;uniform highp vec2 u_strokeWidth;uniform highp float u_scale;uniform vec2 u_topLeft;varying vec2 v_normal;\n#ifdef DASHARRAY\nvarying float v_lengthSoFar;varying vec2 v_dashSize;uniform vec2 u_dashSize;uniform vec2 u_dashUnit;\n#endif\nvarying vec2 v_width;varying vec2 v_dir;uniform vec2 u_offset;uniform bool u_no_antialias;\n#include "utils.glsl/altitudeScaleFactor"\nconst float N_SCALE=1.0/8191.0;void main(void){float strokeWidth=toPixel(u_strokeWidth,u_scale)*0.5;float alias=u_no_antialias? 0.0: strokeWidth<1. ? .65 : 1.;float width=(strokeWidth+alias)/u_scale;v_width=vec2(strokeWidth,alias);vec2 dir2=mod(a_normal.zw,2.0)*2.0-1.0;vec2 aliasNormal=floor(a_normal.zw*.5)*N_SCALE;v_normal=dir2*aliasNormal;v_dir=mod(a_normal.xy,2.0);vec2 dir=v_dir*2.0-1.0;vec2 normal=floor(a_normal.xy*.5)*N_SCALE;\n#ifdef DASHARRAY\nv_lengthSoFar=a_lengthSoFar;v_dashSize=vec2(toPixel(vec2(u_dashSize.x,u_dashUnit.x),u_scale),toPixel(vec2(u_dashSize.y,u_dashUnit.y),u_scale));\n#endif\nfloat lineOffset=toPixel(u_offset,u_scale);vec2 position=a_position.xy+normal*-lineOffset/u_scale;vec2 posCenterWorld=vec2(u_topLeft+position);vec2 offset=dir*normal*width;offset*=altitudeScaleFactor(vec3(posCenterWorld+offset,a_position.z),u_matrix);gl_Position=u_matrix*vec4(posCenterWorld+offset,a_position.z,1.0);}',zt="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;varying vec2 v_normal;varying vec2 v_dir;uniform bool u_no_antialias;\n#ifdef DASHARRAY\nuniform highp float u_scale;\n#if (DASHARRAY & 2)\nuniform sampler2D u_dashPattern;\n#endif\nvarying float v_lengthSoFar;uniform sampler2D u_dashTexture;uniform bool u_hasDashTexture;varying vec2 v_dashSize;\n#endif\nvarying vec2 v_width;void main(void){highp float lineWidth=v_width.s+v_width.t;highp float width=length(v_normal)*lineWidth;if(width>lineWidth){discard;}\n#ifdef DASHARRAY\nfloat dashSize=v_dashSize.x+(1.0-step(0.1,v_dashSize.x))*1e5;float gapSize=v_dashSize.y;float totalDashSize=dashSize+gapSize;\n#if DASHARRAY & 2\nfloat dash=texture2D(u_dashPattern,vec2(fract(v_lengthSoFar/totalDashSize*u_scale))).r;gl_FragColor=u_fill*step(0.1,dash);\n#else\nfloat patternPosition=fract(v_lengthSoFar/totalDashSize*u_scale);float dashPosition=dashSize/totalDashSize;\n#if DASHARRAY & 4\nfloat u=patternPosition/dashPosition;gl_FragColor=u_fill*texture2D(u_dashTexture,vec2(u,v_dir.y));\n#else\ngl_FragColor=u_fill*step(patternPosition,dashPosition);\n#endif\n#endif\n#else\ngl_FragColor=u_fill;\n#endif\nif(!u_no_antialias){float antialiasAlpha=1.0-clamp(.5*width-.5*v_width.s+.5,.0,1.);gl_FragColor*=antialiasAlpha;}}";class Pt extends Tt{constructor(t,e){super(t,e),this.name="Line",this.glStates=new _t({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Lt,this.fragmentShaderSrc=zt}isBufferVisible(t){return t.u_strokeWidth[0]>0}}class Ct extends Tt{constructor(t,e,i={}){super(t,e,i),this.name="DashedLine",this.glStates=new _t({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Lt,this.fragmentShaderSrc=zt}static getMacros(t){const{uniforms:e}=t;return{DASHARRAY:1|(e.u_dashPattern?2:0)|(e.u_dashTexture?4:0)}}static getProgramId(t,e){return t.type+e.DASHARRAY}}var Et='precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform float u_fillIntensity;\n#ifdef SPECULAR\n#include "light.glsl"\nuniform vec3 specular;uniform float shininess;uniform vec3 u_camWorld;varying vec3 v_surfaceToCam;varying vec3 fragNormal;\n#endif\nconst vec3 surfaceNormal=vec3(0,0,1);void main(void){\n#ifdef SPECULAR\nvec4 light=computeBaseLighting(surfaceNormal,u_fill.rgb,u_fillIntensity,u_fill.a);light=addSpecularHighlights(surfaceNormal,light,v_surfaceToCam,shininess,specular);gl_FragColor=light;\n#else\ngl_FragColor=u_fill;\n#endif\n}';class It extends Tt{constructor(t,e,i){super(t,e,i),this.name="Polygon",this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform mat4 u_matrix;uniform vec2 u_topLeft;\n#ifdef SPECULAR\nuniform float u_zMeterToPixel;uniform vec3 u_camWorld;varying vec3 v_surfaceToCam;\n#endif\nvoid main(void){float z=a_position.z;vec3 worldPos=vec3(u_topLeft+a_position.xy,z);gl_Position=u_matrix*vec4(worldPos,1.0);\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-worldPos;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\n}",this.fragmentShaderSrc=Et}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}}class Rt extends Tt{constructor(t,e){super(t,e),this.name="Image",this.glStates=new _t({scissor:!0,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_position;attribute vec2 a_textureCoord;uniform highp mat4 u_matrix;uniform highp vec2 u_topLeft;uniform highp vec2 u_resolution;uniform float u_tileScale;varying vec2 v_textureCoord;uniform float u_scale;void main(void){v_textureCoord=a_textureCoord;highp vec4 position=u_matrix*vec4(u_topLeft+a_position*u_tileScale,0.0,1.0);gl_Position=position;}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nvarying vec2 v_textureCoord;uniform sampler2D u_sampler;void main(void){gl_FragColor=texture2D(u_sampler,v_textureCoord);}"}}class kt extends Tt{constructor(t,e,i){super(t,e,i),this.name="Text",this.glStates=new _t({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision highp float;\n#define GLSLIFY 1\nattribute vec3 a_point;attribute vec3 a_position;attribute vec2 a_texcoord;uniform vec2 u_resolution;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform float u_scale;uniform float u_rotate;uniform bool u_alignMap;uniform bool u_fixedView;uniform vec2 u_texSize;uniform float u_normalizePosition;varying vec2 v_texcoord;varying vec4 vColor;\n#include "utils.glsl/heightMapUtils"\n#include "utils.glsl/altitudeScaleFactor"\nconst float OFFSET_SCALE=1.0/32.0;const float PI_05=M_PI*0.5;const float PI_15=M_PI*1.5;const float PI_20=M_PI*2.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 position=floor(a_position.xy/2.0)*u_normalizePosition;vec2 rotLowHi=mod(a_texcoord,32.0);float rotationZ=rotLowHi.y*32.0+rotLowHi.x;v_texcoord=floor(a_texcoord/32.0)/u_texSize;vec2 labelOffset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));labelOffset*=DEVICE_PIXEL_RATIO;rotationZ=rotationZ/1024.0*PI_20;\n#ifdef USE_HEIGHTMAP\nfloat z=getTerrainHeight(position);\n#else\nfloat z=a_position.z*SCALE_UINT16_Z;\n#endif\nz+=toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){float absRotation=mod(u_rotate+rotationZ,PI_20);float rotationY=a_point.z/32767.0*PI_20;if(absRotation>PI_05&&absRotation<PI_15){rotationZ+=M_PI;labelOffset*=-1.0;rotationY*=-1.0;}vec3 offset=vec3(a_point.xy*OFFSET_SCALE+labelOffset,0.0)/u_scale/DEVICE_PIXEL_RATIO;offset=rotateY(offset,rotationY);offset.xy=rotateZ(offset.xy,rotationZ);vec3 posWorld=vec3(u_topLeft+position,z);offset.xy*=altitudeScaleFactor(posWorld,u_matrix);gl_Position=u_matrix*vec4(posWorld+offset,1.0);}else{vec4 cpos=u_matrix*vec4((u_topLeft+position),z,1.0);vec2 offset=rotateZ(a_point.xy*OFFSET_SCALE+labelOffset,rotationZ);gl_Position=vec4(cpos.xy/cpos.w+vec2(1,-1)*offset/DEVICE_PIXEL_RATIO/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}}}',this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform sampler2D u_texture;uniform bool u_strokeOnly;uniform vec4 u_fillColor;uniform vec4 u_strokeColor;void main(){vec4 glyph=texture2D(u_texture,v_texcoord);vec4 color;float glyphAlpha;if(u_strokeOnly){color=u_strokeColor;glyphAlpha=glyph.a;}else{color=u_fillColor;glyphAlpha=glyph.r;}gl_FragColor=glyphAlpha*color;}"}static getProgramId(t,e){return t.type+((null==e?void 0:e.USE_HEIGHTMAP)||"")}blendFunc(){const{gl:t}=this;t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}initGeometryBuffer(t,e,i){const{gl:s}=this;super.initGeometryBuffer(t,e),s.depthMask(!1),s.polygonOffset(0,2048*-i),s.enable(s.POLYGON_OFFSET_FILL)}draw(t){const{gl:e,uniforms:i}=this;e.uniform1f(i.u_strokeOnly,1),super.draw(t),e.uniform1f(i.u_strokeOnly,0),super.draw(t)}initViewUniforms(t){this.initUniform("u_rotate",t.rz),this.initUniform("u_fixedView",t.fixedView)}}class Ft extends Tt{constructor(t,e,i){super(t,e,i),this.name="icon",this.glStates=new _t({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_size;attribute highp vec3 a_position;attribute vec2 a_texcoord;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform bool u_alignMap;uniform vec2 u_resolution;uniform bool u_fixedView;uniform float u_zMeterToPixel;uniform float u_normalizePosition;varying float vOpacity;varying vec2 v_texcoord;\n#include "utils.glsl/altitudeScaleFactor"\nvoid main(void){if(mod(a_position.x,2.0)==1.0){vec2 rotLowHi=mod(a_texcoord,16.0);float roationMSB=mod(a_position.y,2.0);float rotation=rotLowHi.x+floor(rotLowHi.y*16.0)+(roationMSB*256.0);rotation=rotation/511.0*2.0*M_PI;vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec2 offsetXY=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));if(u_alignMap){vec3 posWorld=vec3(u_topLeft+pos,z);vec2 shift=rotateZ(offsetXY+dir*vec2(a_size.x,-a_size.y)*0.5,rotation)/u_scale;shift*=altitudeScaleFactor(posWorld,u_matrix);gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,z,1.0);vec2 shift=rotateZ(dir*a_size,-rotation)*0.5;vec2 offset=offsetXY*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}v_texcoord=floor(a_texcoord/16.0)/4095.0;}}',this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform float u_opacity;uniform sampler2D u_texture;void main(){gl_FragColor=texture2D(u_texture,v_texcoord);gl_FragColor.a*=u_opacity;if(gl_FragColor.a<.1)discard;}"}initViewUniforms(t){this.initUniform("u_fixedView",t.fixedView)}}class Dt extends Tt{constructor(t,e,i){super(t,e,i),this.name="Extrude",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_normal;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_fill;uniform float u_fillIntensity;uniform bool u_strokePass;uniform vec4 u_stroke;\n#include "light.glsl"\n#ifdef SPECULAR\nuniform vec3 u_camWorld;uniform float u_zMeterToPixel;uniform vec3 specular;uniform float shininess;\n#endif\nvarying vec4 v_fill;const vec3 TopSurfaceNormal=vec3(0,0,1);void main(void){vec3 worldPos=vec3(u_topLeft+a_position.xy,a_position.z);gl_Position=u_matrix*vec4(worldPos,1.0);if(u_strokePass){v_fill=u_stroke;}else{vec3 normal=a_normal.xy==TopSurfaceNormal.xy ? TopSurfaceNormal : a_normal;vec4 light=computeBaseLighting(normal,u_fill.rgb,u_fillIntensity,u_fill.a);\n#ifdef SPECULAR\nvec3 surfaceToCam=normalize(u_camWorld-worldPos);surfaceToCam.z*=u_zMeterToPixel;light=addSpecularHighlights(normal,light,surfaceToCam,shininess,specular);\n#endif\nv_fill=light;}}',this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nvarying vec4 v_fill;void main(void){gl_FragColor=v_fill;}"}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}initGeometryBuffer(t,e){const{gl:i}=this;super.initGeometryBuffer(t,e),i.polygonOffset(1,1),i.enable(i.POLYGON_OFFSET_FILL)}draw(t){const{gl:e}=this;super.draw(t),e.disable(e.POLYGON_OFFSET_FILL)}}class Ut extends Tt{constructor(t,e,i){super(t,e,i),this.name="Box",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision mediump float;\n#define GLSLIFY 1\nattribute vec3 a_normal;attribute highp vec3 a_position;attribute highp vec3 a_point;uniform float u_scale;uniform mat4 u_matrix;uniform mat4 u_inverseMatrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform vec2 u_resolution;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;\n#ifdef SPHERE\nvarying vec3 v_rayOrigin;varying vec3 v_rayDirecton;varying vec3 v_worldPos;uniform vec2 u_radius;\n#else\nvarying vec3 vPosition;varying float v_strokeWidth;varying vec3 v_normal;\n#endif\nvarying vec3 vSize;const float EXTENT_SCALE=1.0/32.0;\n#ifdef SPECULAR\nvarying vec3 v_surfaceToCam;uniform vec3 u_camWorld;\n#endif\n#include "utils.glsl/heightMapUtils"\n#include "utils.glsl/altitudeScaleFactor"\nvarying vec2 v_localTilePos;void main(void){\n#ifdef SPHERE\nvec3 dir=a_point*2.0-1.0;vec3 size=vec3(toPixel(u_radius,u_scale))/u_scale;\n#else\nvec3 dir=mod(a_point,2.0)*2.0-1.0;vec3 size=floor(a_point*.5)/u_scale*.5;\n#endif\nvec2 localTilePos=a_position.xy*EXTENT_SCALE;\n#ifdef USE_HEIGHTMAP\nfloat z=getTerrainHeight(localTilePos);\n#else\nfloat z=a_position.z*SCALE_UINT16_Z;\n#endif\nvec3 boxCenter=vec3(u_topLeft+localTilePos,z);boxCenter+=vec3(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale),toPixel(u_offsetZ,u_scale)/u_zMeterToPixel)/u_scale;float scaleDZ=altitudeScaleFactor(boxCenter,u_matrix);size*=scaleDZ;vec3 vertexOffset=vec3(size.xy,size.z/u_zMeterToPixel)*dir;vec3 vertexPos=vec3(boxCenter.xy+rotateZ(vertexOffset.xy,u_rotation),boxCenter.z+vertexOffset.z);vertexPos.z=max(vertexPos.z,0.0);gl_Position=u_matrix*vec4(vertexPos,1.0);\n#ifdef SPHERE\nvec4 origin=u_inverseMatrix*vec4(gl_Position.xy,-1.0,gl_Position.w);v_rayOrigin=origin.xyz/origin.w;v_rayDirecton=vertexPos-v_rayOrigin;v_worldPos=boxCenter;v_rayOrigin.z*=u_zMeterToPixel;v_rayDirecton.z*=u_zMeterToPixel;v_worldPos.z*=u_zMeterToPixel;\n#else\nvPosition=vec3(vertexOffset.xy,vertexOffset.z*u_zMeterToPixel);v_strokeWidth=u_strokeWidth/u_scale*scaleDZ;v_normal=a_normal;\n#endif\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-vertexPos;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\nvSize=size;}',this.fragmentShaderSrc='precision mediump float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform float u_fillIntensity;uniform vec4 u_stroke;varying vec3 vSize;\n#ifdef SPHERE\nvarying vec3 v_worldPos;varying vec3 v_rayOrigin;varying vec3 v_rayDirecton;\n#else\nvarying float v_strokeWidth;varying vec3 vPosition;varying vec3 v_normal;const float smoothness=.25;\n#endif\n#include "light.glsl"\n#ifdef SPECULAR\nuniform vec3 specular;uniform float shininess;varying vec3 v_surfaceToCam;\n#endif\n#ifdef SPHERE\nfloat sphereIntersect(vec3 rayOrigin,vec3 rayDirection,vec3 spherePosition,float sphereRadius){vec3 oc=rayOrigin-spherePosition.xyz;float b=dot(oc,rayDirection);float c=dot(oc,oc)-sphereRadius*sphereRadius;float d=b*b-c;return(d<0.0)?-1.0 :-b-sqrt(d);}\n#endif\nvoid main(void){vec4 color=u_fill;vec3 normal;\n#ifdef SPHERE\nfloat radius=vSize.x;vec3 rayDir=normalize(v_rayDirecton);float distance=sphereIntersect(v_rayOrigin,rayDir,v_worldPos,radius);if(distance==-1.0)discard;vec3 surfacePos=rayDir*distance+v_rayOrigin;normal=normalize(surfacePos-v_worldPos);\n#else\nfloat a=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.xy)-vSize.xy));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.yz)-vSize.yz));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.xz)-vSize.xz));color=mix(u_stroke,u_fill,a);normal=normalize(v_normal);\n#endif\ncolor=computeBaseLighting(normal,color.rgb,u_fillIntensity,u_fill.a);\n#ifdef SPECULAR\ncolor=addSpecularHighlights(normal,color,v_surfaceToCam,shininess,specular);\n#endif\ngl_FragColor=color;}'}static getProgramId(t,e){const i=e?e.SPECULAR|e.USE_HEIGHTMAP:"";return i?t.type+i:t.type}static getMacros(t){let e=super.getMacros(t);return t.uniforms.specular&&(e||(e={}),e.SPECULAR=2),e}}class Ot extends Ut{constructor(t,e,i){super(t,e,Object.assign({SPHERE:!0},i)),this.name="Sphere"}initViewUniforms(t){this.initUniform("u_inverseMatrix",t.inverseMatrix)}}class Bt extends Tt{constructor(t,e,i){super(t,e,i),this.name="Model",this.glStates=new _t({scissor:!1,blend:!1,depth:!0}),this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_offset;attribute vec3 a_normal;attribute vec3 a_tangent;attribute vec4 a_color;attribute vec2 a_uv;attribute mat4 a_modelMatrix;uniform bool useUVMapping;uniform vec2 u_textureSize;uniform mat3 u_normalMatrix;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform bool u_isPixelCoords;uniform float u_zMeterToPixel;uniform float pointSize;varying vec3 v_normal;varying vec2 v_texCoord;varying vec4 v_color;varying vec3 v_lightDir;\n#ifdef SPECULAR\nuniform vec3 u_camWorld;varying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\n#ifdef DBG_GRID\nvarying vec2 v_tilePos;\n#endif\n#ifdef TERRAIN_MODEL_HM\n#include "utils.glsl/heightMapUtils"\n#endif\nvoid main(void){vec4 color=a_color;\n#ifdef TERRAIN_MODEL_HM\nfloat x=mod(a_position.x,32768.0);float y=a_position.y;vec2 normalizedPos=vec2(x,y)/32767.0;float skirtFlag=step(32768.0,a_position.x);float tileSize=uHeightMapTileSize.y;float terrainHeight=getTerrainHeight(normalizedPos*tileSize);float z=terrainHeight*(1.0-0.2*skirtFlag);vec4 position=a_modelMatrix*vec4(x,y,z,1.0);vec3 normal=getTerrainNormal(normalizedPos*tileSize);\n#else\nvec4 position=a_modelMatrix*vec4(a_position,1.0);vec3 normal=a_normal;\n#endif\nfloat xyUnitScale=u_isPixelCoords ? 1.0 : u_zMeterToPixel;\n#ifdef USE_HEIGHTMAP\nvec3 localTilePosition=vec3(a_offset.xy,getTerrainHeight(a_offset.xy));\n#else\nvec3 localTilePosition=a_offset;\n#endif\nvec3 positionTileWorld=localTilePosition+vec3(position.xy*xyUnitScale,position.z);vec4 worldPos=vec4(u_topLeft+positionTileWorld.xy,positionTileWorld.z,1.0);gl_Position=u_matrix*worldPos;gl_PointSize=pointSize;v_normal=normalize(u_normalMatrix*normal);if(useUVMapping){v_texCoord=a_uv;}else{v_texCoord=positionTileWorld.xy/u_textureSize;}\n#ifdef DBG_GRID\nv_tilePos=positionTileWorld.xy;\n#endif\n#ifdef NORMAL_MAP\nv_tangent=normalize(normalMat*a_tangent);\n#endif\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-worldPos.xyz;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\nv_color=color;}',this.fragmentShaderSrc='precision lowp float;\n#define GLSLIFY 1\nuniform vec3 ambient;uniform vec3 diffuse;uniform vec3 emissive;uniform vec3 u_ambientLight;uniform float opacity;uniform float illumination;uniform sampler2D diffuseMap;uniform sampler2D normalMap;varying vec4 v_color;varying vec3 v_normal;varying vec2 v_texCoord;\n#ifdef SPECULAR\nuniform float shininess;uniform vec3 specular;uniform sampler2D specularMap;varying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\n#ifdef DBG_GRID\nvarying vec2 v_tilePos;\n#endif\n#include "light.glsl"\nvoid main(){vec3 normal=normalize(v_normal);\n#ifdef NORMAL_MAP\nfloat flip=float(!gl_FrontFacing)*2.-1.;normal=normal*flip;vec3 tangent=normalize(v_tangent)*flip;vec3 bitangent=normalize(cross(normal,tangent));mat3 matrixTbn=mat3(tangent,bitangent,normal);normal=texture2D(normalMap,v_texCoord).rgb*2.-1.;normal=normalize(matrixTbn*normal);\n#endif\nvec4 diffuseMapColor=texture2D(diffuseMap,v_texCoord);vec3 color=diffuse*diffuseMapColor.rgb*v_color.rgb;vec4 totalColor=computeBaseLighting(normal,color,1.0,opacity*v_color.a);\n#ifdef SPECULAR\ntotalColor=addSpecularHighlights(normal,totalColor,v_surfaceToCam,shininess,specular*texture2D(specularMap,v_texCoord).rgb);\n#endif\ngl_FragColor=totalColor;\n#ifdef DBG_GRID\nfloat min=1.0;float max=512.0-1.0;if(v_tilePos.x<min||v_tilePos.x>max||v_tilePos.y<min||v_tilePos.y>max){gl_FragColor+=vec4(1.0,0.0,0.0,0.5);}\n#endif\n}'}static getMacros(t){const{uniforms:e}=t;let i=super.getMacros(t);return e.illumination>0&&(i||(i={}),i.DIFFUSE=1),e.normalMap.width>1&&(i||(i={}),i.NORMAL_MAP=4),e.shininess>0&&(i||(i={}),i.SPECULAR=2),i}static computeMacroMask(t){return t.DIFFUSE|t.SPECULAR|t.NORMAL_MAP}static getProgramId(t,e){return t.type+this.computeMacroMask(e)}draw(t,e){const{gl:i}=this;e&&(i.polygonOffset(1,1),i.enable(i.POLYGON_OFFSET_FILL)),super.draw(t)}}class Ht extends Bt{constructor(t,e,i){super(t,e,i),this.name="Terrain"}static getMacros(t){const e=super.getMacros(t);return t.heightMap&&(delete e.USE_HEIGHTMAP,e.TERRAIN_MODEL_HM=128),Ht.dbgGrid&&(e.DBG_GRID=8),e}static computeMacroMask(t){return super.computeMacroMask(t)|t.USE_HEIGHTMAP|t.DBG_GRID}}class Gt{constructor(t,e,i={}){var s,r,n,o,a,l,h,c,u;this.gl=t,this.format=i.format||t.RGBA,this.internalFormat=i.internalFormat||this.format,this.flipY=i.flipY||!1,this.halfFloat=i.halfFloat||!1;let d=null===(s=i.mipMaps)||void 0===s||s,f=t.UNSIGNED_BYTE;const p=null==e?void 0:e.data;let g,m;i.float||p instanceof Float32Array?(f=t.FLOAT,i.format&&i.internalFormat||(this.format=this.internalFormat=t.LUMINANCE),g=m=t.NEAREST,null!==(r=(c=e).width)&&void 0!==r||(c.width=Math.sqrt(p.length)),null!==(n=(u=e).height)&&void 0!==n||(u.height=e.width)):this.halfFloat&&(f=null===(o=t.getExtension("OES_texture_half_float"))||void 0===o?void 0:o.HALF_FLOAT_OES,t.getExtension("OES_texture_half_float_linear")),this.type=f,this.mipMaps=d,this.wrapS=null!==(a=i.wrapS)&&void 0!==a?a:t.CLAMP_TO_EDGE,this.wrapT=null!==(l=i.wrapT)&&void 0!==l?l:t.CLAMP_TO_EDGE,this.premultiplyAlpha=null===(h=i.premultiplyAlpha)||void 0===h||h,this.minFilter=null!=g?g:t.LINEAR,this.magFilter=null!=m?m:t.LINEAR,e&&this.set(e)}bind(){const{gl:t,texture:e}=this;e&&t.bindTexture(t.TEXTURE_2D,e)}set(t,e,i){let{gl:s,texture:r,format:n,internalFormat:o,flipY:a,wrapS:l,wrapT:h,type:c,minFilter:u,magFilter:d}=this;const{width:f,height:p}=t,g="number"==typeof e;r||(this.texture=r=s.createTexture()),s.bindTexture(s.TEXTURE_2D,r),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,h),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,a),g||this.width==f&&!this.height&&!p?s.texSubImage2D(s.TEXTURE_2D,0,e||0,i||0,n,c,t):(t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof ImageBitmap?s.texImage2D(s.TEXTURE_2D,0,o,n,s.UNSIGNED_BYTE,t):s.texImage2D(s.TEXTURE_2D,0,o,f,p,0,n,c,t.data),this.width=f,this.height=p),this.mipMaps&&f==p&&(t=>!(t&t-1))(p)?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.generateMipmap(s.TEXTURE_2D)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,u),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,d))}destroy(){const{gl:t,texture:e}=this;e&&(t.deleteTexture(e),this.texture=null)}isDestroyed(){return null===this.texture}getGLTexture(){return this.texture}}const Nt=(()=>{const t=Object.getPrototypeOf(Uint8Array);return e=>e instanceof t})();let Wt;const Zt=(t,e,i,s,r)=>{const n=t[e],o=t[e+1],a=t[e+2],l=t[i],h=t[i+1],c=t[i+2],u=t[s],d=t[s+1],f=t[s+2],p=l-u,g=h-d,m=c-f,v=n-u,x=o-d,y=a-f,_=m*x-g*y,b=p*y-m*v,w=g*v-p*x;r[e]+=_,r[e+1]+=b,r[e+2]+=w,r[i]+=_,r[i+1]+=b,r[i+2]+=w,r[s]+=_,r[s+1]+=b,r[s+2]+=w};class Yt{constructor(t,e,i){this.attributes={},this.uniforms={},this.pass=bt.OPAQUE,this.flat=!0,this.groups=[],this.instances=0,this.pixelPerfect=!1,this.renderScale=1,this._cullFace=0,this._uniformCache={clear:!0,uniforms:{},fromCache:!1},t&&(this.addGroup(t,i),this.type=e)}setHeightMapRef(t){this.heightMapRef=t?"required":null}getHeightMap(){var t;return this.heightMap||!!this.heightMapRef&&(null===(t=this.terrainCache)||void 0===t?void 0:t.get(this.heightMapRef))}static computeNormals(t,e){const i=t.length,s=new Float32Array(i);if(e)for(let i=0,{length:r}=e;i<r;i+=3)Zt(t,3*e[i],3*e[i+1],3*e[i+2],s);else{let e=0;for(;e<i;)Zt(t,e,e+6,e+3,s),e+=9}const r=new Int8Array(i);for(let t,e,n,o=0;o<i;o+=3){t=s[o],e=s[o+1],n=s[o+2];const i=127/Math.sqrt(t*t+e*e+n*n)||0;r[o]=Math.round(t*i),r[o+1]=Math.round(e*i),r[o+2]=Math.round(n*i)}return r}static fromTemplateBuffer(t,e,i){const{flexAttributes:s}=e;let r;if(e.hasIndex()){const i=e.index();if(!i.length)return null;r=new Yt(i,t,e.i32)}else r=new Yt({first:e.first,count:e.count()},t);for(let t in s){let i=s[t];i.value?r.attributes[t]={value:i.value}:i.data.length&&r.addAttribute(t,e.trimAttribute(i))}for(let t in e.uniforms)r.addUniform(t,e.uniforms[t]);return r.light=i||e.light,e.populateGeometryBuffer(r),r}createIndex(t,e){const i=Array.isArray(t)?e?new Uint32Array(t):new Uint16Array(t):t;return{index:{type:i.constructor==Uint32Array?5125:5123,length:t.length,data:i}}}createArrays(t){return{arrays:t}}addGroup(t,e,i){if(t){let s;return s=t.first!=Wt?this.createArrays(t):this.createIndex(t,e),i&&(s.mode=i),this.groups[this.groups.length]=s}}addUniform(t,e){this.uniforms[t]=e}getUniform(t){return this.uniforms[t]}addAttribute(t,e,i=this.attributes){const{data:s}=e;e.type=(t=>t instanceof Int8Array?5120:t instanceof Uint8Array?5121:t instanceof Int16Array?5122:t instanceof Uint16Array?5123:t instanceof Int32Array?5124:t instanceof Uint32Array?5125:t instanceof Float32Array?5126:void 0)(s),e.bytesPerElement=s.BYTES_PER_ELEMENT,e.stride==Wt&&(e.stride=0),e.dirty==Wt&&(e.dirty=!0),i[t]=e}computeNormals(t,e){var i,s;return void 0===t&&(t=null===(i=this.attributes.a_position)||void 0===i?void 0:i.data),void 0===e&&(e=null===(s=this.groups[0].index)||void 0===s?void 0:s.data),Yt.computeNormals(t,e)}getAttributes(){return this.attributes}destroy(t){}isPointBuffer(){const{type:t}=this;return"Line"!=t&&"Extrude"!=t}isFlat(){return this.flat}rayIntersects(t,e,i,s,r){return null}cullFace(t){return t!==Wt&&(this._cullFace=t),this._cullFace}clearUniformCache(){this._uniformCache.clear=!0}getUniformData(){return this._uniformCache.uniforms}compileUniforms(){const t=this._uniformCache;if(t.clear){t.clear=!1,t.fromCache=!1;const{uniforms:i}=this;for(let s in i){let r=i[s];if(r instanceof e.Expression)r=r.resolve();else if(Array.isArray(r)){let i=r[0];i instanceof e.Expression&&(i=i.resolve(),r=t.uniforms[s]||[0,0],r[0]=i,r[1]=0)}t.uniforms[s]=r}}else t.fromCache=!0;return t}needs2AlphaPasses(){return!!(this.pass&bt.POST_ALPHA)}getRenderSpace(){var t;return null===(t=this.getUniform("u_alignMap"))||void 0===t||t?"world":"screen"}}Yt.MODE_GL_POINTS=0,Yt.MODE_GL_LINES=1,Yt.MODE_GL_TRIANGLES=4;const Vt=bt.ALPHA;class Xt extends Tt{constructor(t,e){super(t,e),this.name="Heatmap",this.glStates=new _t({scissor:!1,blend:!0,depth:!1}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute float a_weight;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform bool u_offscreen;uniform float u_normalizePosition;varying vec2 v_texcoord;varying vec2 v_direction;varying float v_weight;void main(void){if(u_offscreen){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;v_direction=3.0*dir;v_weight=a_weight;vec2 posCenter=vec2(u_topLeft+pos);vec2 offset=(dir*u_radius.x*vec2(1.0,-1.0));gl_Position=u_matrix*vec4(posCenter+offset/u_scale,0.0,1.0);}else{gl_Position=vec4(a_position.xy,0,1);v_texcoord=a_position.xy*0.5+0.5;}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform bool u_offscreen;uniform sampler2D u_texture;uniform sampler2D u_gradient;varying float v_weight;uniform float u_intensity;uniform float u_opacity;varying vec2 v_texcoord;varying vec2 v_direction;const float INV_SQRT_2_PI=1.0/sqrt(2.0*M_PI);void main(void){if(u_offscreen){float sqDistance=dot(v_direction,v_direction);float density=INV_SQRT_2_PI*exp(-sqDistance/2.0);gl_FragColor.r=v_weight*u_intensity*density;}else{float r=texture2D(u_texture,v_texcoord).r;gl_FragColor=texture2D(u_gradient,vec2(r,0.5))*u_opacity;}}";let{width:i,height:s}=t.canvas;i*=.5,s*=.5;const r=new Gt(t,{width:i,height:s},{halfFloat:!0,premultiplyAlpha:!1}),n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r.getGLTexture(),0);const o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i,s),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,o),this.offscreen={framebuffer:n,depthStencilAttachment:o,texture:r,scale:.5};const a=new Yt({first:0,count:6},"Heatmap");a.addAttribute("a_position",{data:new Int8Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),size:2,stride:0}),a.addUniform("u_texture",r),a.addUniform("u_offscreen",!1),a.depth=!0,this.offscreenBuffer=a}initPass(t,e){switch(t){case bt.OPAQUE:return this.screenBufferRefreshed=!1;case Vt:const{width:t,height:e}=this.offscreen.texture;return this.bindFramebuffer(this.offscreen.framebuffer,t,e),!0;case bt.POST_ALPHA:this.bindFramebuffer(null);const i=!this.screenBufferRefreshed;return this.screenBufferRefreshed=!0,i}}draw(t){const{gl:e,uniforms:i,offscreen:s}=this;if(this._pass==Vt)this.initUniforms({u_texture:null}),e.uniform1i(i.u_offscreen,1),e.enable(e.BLEND),e.colorMask(!0,!1,!1,!1),e.blendFunc(e.ONE,e.ONE),super.draw(t),this.bindFramebuffer(null);else{const{offscreenBuffer:t}=this;this.initBuffers(t.attributes),this.initUniforms(t.uniforms),this.initAttributes(t.attributes),this.initGeometryBuffer(t,bt.ALPHA),e.depthFunc(e.LEQUAL),super.draw(t),this.clear()}}clear(){const{gl:t,offscreen:e}=this,{width:i,height:s}=e.texture;this.bindFramebuffer(e.framebuffer,i,s),t.colorMask(!0,!0,!0,!0),t.disable(t.SCISSOR_TEST),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),this.bindFramebuffer(null)}setResolution(t){const[e,i]=t,{gl:s,offscreen:r}=this,{scale:n}=r,{width:o,height:a}=r.texture,l=e*n,h=i*n;o==l&&a==h||(r.texture.set({width:l,height:h}),s.bindRenderbuffer(s.RENDERBUFFER,r.depthStencilAttachment),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,l,h))}}class jt extends Tt{constructor(t,e,i){super(t,e,i),this.name="VerticalLine",this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform vec2 u_offsetZ;uniform float u_scale;uniform float u_zMeterToPixel;uniform mat4 u_matrix;uniform vec2 u_topLeft;\n#include "utils.glsl/heightMapUtils"\nvoid main(void){float offsetZ=u_offsetZ.y>0.0 ? u_offsetZ.x : u_offsetZ.x/u_zMeterToPixel/u_scale;\n#ifdef USE_HEIGHTMAP\nfloat positionZ=getTerrainHeight(a_position.xy)+a_position.z*offsetZ;\n#else\nfloat positionZ=a_position.z+offsetZ;\n#endif\nvec3 worldPos=vec3(u_topLeft+a_position.xy,positionZ);gl_Position=u_matrix*vec4(worldPos,1.0);}',this.fragmentShaderSrc=Et,this.mode=t.LINES}static getProgramId(t,e){return t.type+((null==e?void 0:e.USE_HEIGHTMAP)||"")}static getMacros(t){return Tt.getMacros(t)}}class qt extends Tt{constructor(t,e,i){super(t,e,i),this.name="Sky",this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform mat4 u_matrix;uniform vec2 u_horizon;varying vec2 v_texcoord;void main(void){vec4 worldPos=vec4(a_position.x,a_position.y*u_horizon.x,0.0,1.0);gl_Position=u_matrix*worldPos;v_texcoord=vec2(gl_Position.x,a_position.y);}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec2 u_horizon;uniform sampler2D u_fill;varying vec2 v_texcoord;void main(void){float horizonScale=u_horizon.x/u_horizon.y;gl_FragColor=texture2D(u_fill,vec2((1.0-v_texcoord.y)*horizonScale,0.0));}"}}const $t="round",Kt="butt",Qt="miter",Jt="bevel",te=8191;var ee;!function(t){t[t.INSIDE=0]="INSIDE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTTOM=4]="BOTTOM",t[t.TOP=8]="TOP"}(ee||(ee={}));const ie=(t,e,i,s,r,n)=>{let o=ee.INSIDE;return t<i?o|=ee.LEFT:t>s&&(o|=ee.RIGHT),e<r?o|=ee.BOTTOM:e>n&&(o|=ee.TOP),o},se=t=>{let e=t[0],i=t[1],s=e*e+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e*s,t[1]=i*s),t},re=(t,e,i,s,r,n,o,a,l=1)=>{if(t==$t)!1===s?o.push(e,i,e,i,e,i):o.push(e,i,s,e,i,s,e,i,s),r*=Math.SQRT2*l,n*=Math.SQRT2*l,a.push(r<<1,n<<1|1,r<<1,n<<1|1,r<<1|1,n<<1,r<<1|1,n<<1,n<<1|1,r<<1|1,n<<1|1,r<<1|1);else if("square"==t){!1===s?o.push(e,i,e,i,e,i,e,i,e,i,e,i):o.push(e,i,s,e,i,s,e,i,s,e,i,s,e,i,s,e,i,s);let t=n-r,l=r+n;a.push(r<<1,n<<1|1,0,0,l<<1|1,t<<1,0,0,r<<1|1,n<<1,0,0,t<<1|1,l<<1|1,r<<1|1,n<<1|1,l<<1|1,t<<1,r<<1|1,n<<1|1,r<<1,n<<1|1,0,0)}},ne=(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g=0,m=0)=>{u*=.5;const v=!!o;!0===o&&2==n&&(o=0);const x=a+16,y=-16,_=s[r/n-1];let b=g*_,w=m*_;if((g||m)&&(f=!1),b&&w&&m<g){const t=b;b=w,w=t}p&&(h=Kt,"none"!=c&&(c=Qt)),o&&(h=Kt,c="none"),d&&(h="butt",c="miter");let M,T,S=ie(i[0],i[1],y,x,y,x),A=null,L=null;for(let g=0,m=n;m<r;g=m,m+=n){let _=i[g],z=i[g+1];!0===o&&i[g+2];let P=i[m],C=i[m+1];for(!0===o&&i[m+2],M=T=ie(P,C,y,x,y,x);;){if(!(S|M)){null==A&&(A=g),M!==T&&(L=m);break}if(S&M)break;{let t,e,i,s=S||M;s&ee.TOP?(t=(x-z)/(C-z),e=_+(P-_)*t,i=x):s&ee.BOTTOM?(t=(y-z)/(C-z),e=_+(P-_)*t,i=y):s&ee.RIGHT?(t=(x-_)/(P-_),i=z+(C-z)*t,e=x):s&ee.LEFT&&(t=(y-_)/(P-_),i=z+(C-z)*t,e=y),s=ie(e,i,y,x,y,x),S?(S=s,_=e,z=i):(M=s,P=e,C=i)}}null==A||null==L&&m!=r-n||(L||(L=r-n),f&&(A-=n),oe(t,n,e,i,v,o,s,r,A,L+n,a,l,h,h,c,u,d,b,w,p,f),A=null,L=null),S=T}return t.length},oe=(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g,m,v,x,y,_,b,w)=>{let M=l,T=0;l<0?M=a-e+l:T=o[M/e];let S=s[M],A=s[M+1],L=!0===n?s[M+2]:n;b&&([S,A,L]=b);let z,P,C,E,I,R,k,F,D,U,O,B,H,G,N,W,Z,Y,V,X,j,q,$,K=h,Q=null,J=null,tt=null,et=null,it=null,st=null,rt=null,nt=null;if(x&&x<T)return T;let ot=_;for(let h=l+e;h<K;h+=e){let l,b,M=!_&&h==K-e,at=null,lt=!1;M&&w?[E,I,R]=w:(E=s[h],I=s[h+1],R=!0===n?s[h+2]:n),C=p,k=S-E,F=A-I,$=se([k,F]),D=$[1],U=$[0],it=null==it;const ht=T;T=o[h/e];const ct=T-ht;if(length=ct,u&&(A==I&&(A<=0||A>=c)||S==E&&(S<=0||S>=c))&&(ot=!0),x&&x<T&&x>=ht){const t=(x-ht)/ct;E=S-k*t,I=A-F*t,R=L,length*=t,M=!0,K=0}if(v){if(!(v<T)){S=E,A=I,L=R;continue}if(v>=ht){const t=(v-ht)/ct;S-=k*t,A-=F*t,length*=1-t,it=!0}}if(it&&M&&(p="none"),!M){const t=h%(a-e)+e;Q=E-s[t],J=I-s[t+1],at=se([Q,J]),tt=at[1],et=at[0],O=tt+D,B=-et-U,l=k*J-F*Q<0;let i=[O,B];b=1/(i[0]*D-i[1]*U),b==1/0?(lt=!0,O=2,B=2):(lt=!!m||b>3,p==Qt&&lt&&(C=Jt),b>2?([O,B]=se(i),O*=2,B*=2):(O=i[0]*b,B=i[1]*b)),O*=-8191,B*=-8191}if(D*=te,U*=te,N=[-D<<1|1,U<<1|1],Y=[1^N[0],1^N[1]],V=Y,X=Y,W=N,Z=N,!ot){if("none"!=p){if(!M&&C==Qt&&K>2*e&&(X=[O<<1,B<<1],Z=[O<<1|1,B<<1|1]),it||j||(q?(W=[H<<1|1,G<<1|1],p==Qt&&(V=[H<<1,G<<1])):(V=[H<<1,G<<1],p==Qt&&(W=[H<<1|1,G<<1|1]))),!lt&&!M&&p!=Qt){let t=g*O/-8191,e=g*B/-8191;l&&(t*=-1,e*=-1);let i=$[0]*t+$[1]*e;length<i?lt=!0:l?Z=[O<<1|1,B<<1|1]:X=[O<<1,B<<1]}if((!it||M)&&T&&(p==$t&&(q?i.push(P[0],P[1],P[0],P[1],V[0],V[1],V[0],V[1],H<<1,G<<1,H<<1,G<<1):i.push(H<<1|1,G<<1|1,H<<1|1,G<<1|1,W[0],W[1],W[0],W[1],z[0],z[1],z[0],z[1]),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)),!it))if(j){if(!y){let e=0,s=0;if(p!=$t){let t=se([O,B]);e=t[0]*te,s=t[1]*te}e=e<<1|1,s=s<<1|1,q?i.push(0,0,0,0,Y[0],Y[1],e,s,P[0],P[1],e,s):i.push(0,0,0,0,z[0],z[1],e,s,N[0],N[1],e,s),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)}}else if(p!=Qt){let e=se([H,G]);e[0]*=te,e[1]*=te,q?p==Jt?i.push(H<<1|1,G<<1|1,e[0]<<1|1,e[1]<<1|1,V[0],V[1],e[0]<<1,e[1]<<1,P[0],P[1],e[0]<<1,e[1]<<1):i.push(H<<1|1,G<<1|1,e[0]<<1|1,e[1]<<1|1,V[0],V[1],V[0],V[1],P[0],P[1],P[0],P[1]):p==Jt?i.push(W[0],W[1],e[0]<<1|1,e[1]<<1|1,H<<1,G<<1,e[0]<<1,e[1]<<1,z[0],z[1],e[0]<<1|1,e[1]<<1|1):i.push(W[0],W[1],W[0],W[1],H<<1,G<<1,e[0]<<1,e[1]<<1,z[0],z[1],z[0],z[1]),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)}}i.push(W[0],W[1],N[0],N[1],X[0],X[1],Y[0],Y[1],V[0],V[1],Y[0],Y[1],W[0],W[1],N[0],N[1],Z[0],Z[1],N[0],N[1],X[0],X[1],Y[0],Y[1]),r?t.push(S,A,L,E,I,R,S,A,L,S,A,L,E,I,R,E,I,R):t.push(S,A,E,I,S,A,S,A,E,I,E,I),it&&re(d,S,A,r&&L,D,U,t,i),M&&re(f,E,I,r&&R,-D,-U,t,i),null==m||m.push(ht,T,ht,ht,T,T)}ot=!1,z=N,P=Y,H=O,G=B,st=E,rt=I,nt=R,S=E,A=I,L=R,q=l,j=lt}},ae=32,le=(t,e,i)=>{for(var s;++e<t.length;){let r=t.charAt(e),n=null===(s=i.glyphInfos[r])||void 0===s?void 0:s.glyph;if(n){let{direction:t}=n;if(t)return t}}},he=(t,e,i,s,r,n,o)=>{let{offset:a,x:l}=o,{spaceWidth:h}=e,c=e.glyphInfos[t],u=0;const d=r.data,f=null!=s;let p=r.length;const g=n.data;let m=n.length,v=i>>5,x=31&i,y=0;if(c){let{glyph:t}=c,e=c.u1<<5|x,i=c.u2<<5|x,r=c.v1<<5|v,n=c.v2<<5|v,{advanceX:o}=t;y=t.width;let{width:h,height:_}=t.data;u=l+h;const b=l*ae,w=u*ae;_*=ae,d[p++]=b,d[p++]=0,f&&(d[p++]=s),d[p++]=w,d[p++]=_,f&&(d[p++]=s),d[p++]=b,d[p++]=_,f&&(d[p++]=s),d[p++]=w,d[p++]=0,f&&(d[p++]=s),d[p++]=w,d[p++]=_,f&&(d[p++]=s),d[p++]=b,d[p++]=0,f&&(d[p++]=s),g[m++]=e,g[m++]=r,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=n,g[m++]=i,g[m++]=r,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=r,l+=o,a+=12}else" "==t&&(l+=h);r.length=p,n.length=m,o.x=l,o.offset=a,o.boxWidth=u,o.textWidth+=y},ce=(t,e,i,s,r,n,o,a,l,h)=>{for(let c,u,d=e,f=i;d<f;d++){if(c=s?e+(f-1-d):d,u=t.charAt(c),s&&w(t.charCodeAt(c))){let e=c,i=0;for(;--e>=0;)if(!w(t.charCodeAt(e))){for(;++e<=c;)he(t.charAt(e),r,n,o,a,l,h),i++;break}if(i){d+=i-1;continue}}he(u,r,n,o,a,l,h)}},ue=(t,e,i,s,r=0,n)=>{const o=t.length;i.reserve(18*o),s.reserve(12*o),n&&(n=32767*n/(2*Math.PI)^0);const a={x:0,boxWidth:0,offset:0,textWidth:0};let l,h,c,u=0;r=Math.round(r);for(let d=0;d<o;d++){let f=t.charAt(d),p=e.glyphInfos[f],g=d==o-1,m=0;const v=null==p?void 0:p.glyph;if(v&&(m=v.direction),!l){if(" "==f)continue;m=m||1,l=m}if(void 0!==h){let o=!0;if(!m){let i=le(t,d,e);o=i&&i!=h}if(o&&m!=h){let o=d-1;" "==c&&1==m&&o--,o++,ce(t,u,o,-1==h,e,r,n,i,s,a),u=o}}if(g&&u<=d){let o,c=d+Number(" "!=f);o=m?-1==m:h!=l,ce(t,u,c,o,e,r,n,i,s,a)}m&&(h=m),c=f}return{count:a.offset/2,position:i.data,texcoord:s.data,width:a.boxWidth}};let de=M.getInstance();class fe{constructor(t,e,i,s){this.x=0,this.y=0,this.glyphInfos={},this.avgCharWidth=0,this.glyphs=0;const r=de.initFont(t,e);if(this.style=t,this.letterHeight=r.letterHeight,this.lineHeight=r.letterHeight*e,this.baselineOffset=r.baselineOffset,this.rowHeight=r.rowHeight,this.spaceWidth=r.spaceWidth,!i)for(i=1;i<r.rowHeight;)i*=2;i*=e,this.width=i,this.height=i,this.maxWidth=i,this.maxHeight=i,this.style=t,this.scale=e,this.font=r,s&&this.addChars(s)}getTextWidth(t){return de.getTextWidth(t,this.font)}placeGlyph(t){const{rowHeight:e}=this;if(this.x+t>this.width){let t=this.y+2*e;t>this.maxHeight?t>this.height?(this.height*=2,this.width*=2,0==this.x?this.maxWidth=this.maxWidth=this.width:(this.x=this.maxWidth,this.y=0)):(this.x=0,this.y+=e,this.maxHeight=this.height,this.maxWidth=this.width):(this.y+=e,this.maxHeight<this.height?this.x=this.maxWidth:this.x=0)}}addChars(t){const{glyphInfos:e,rowHeight:i}=this;let s=!1;for(let r of t)if(" "!=r&&!e[r]){let t=de.getGlyph(r,this.font),n=r.charCodeAt(0),o=t.data.width,a=t.width;if(n){this.avgCharWidth=(this.avgCharWidth*this.glyphs+a)/++this.glyphs,s=!0,this.placeGlyph(o);const{x:n,y:l}=this;e[r]={u1:n,v1:l,u2:n+o,v2:l+i,glyph:t},this.x+=o}}return s}}class pe extends Gt{constructor(t,e,i){super(t,null,{format:t.LUMINANCE_ALPHA}),this.dirty=!1;const{dpr:s}=t;this.atlas=new fe(e,s,i)}addChars(t){this.dirty=this.atlas.addChars(t)||this.dirty}bufferLength(t,e=2){let i=0;for(let e of t)" "!=e&&i++;return 6*i*e}getAtlas(){return this.atlas}sync(){if(this.dirty){const{atlas:t,gl:e}=this,i=t.glyphInfos;this.set({width:t.width,height:t.height});for(let t in i){let e=i[t];this.set(e.glyph.data,e.u1,e.v1)}}}destroy(){this.atlas=null,super.destroy()}}class ge{constructor(t,e=128){this.length=0,Nt(t)?(this.data=t,this.length=this.size=this.data.length):this.data=new t(this.size=e)}get(t){return this.data[t]}set(t,e=0){const{length:i}=t,s=e+i;s&&this.reserve(s),this.data.set(t,e),this.length=s}push(t){const e=arguments.length;this.reserve(e);for(let t=0;t<e;t++)this.data[this.length++]=arguments[t];return this.length}reserve(t){const{data:e}=this,i=t-(this.size-this.length);i>0&&(this.size+=Math.max(i,this.size),this.data=new e.constructor(this.size),this.length&&this.data.set(e))}trim(){let{size:t,length:e}=this;return t!=e&&(this.data=this.data.slice(0,e)),this.data}}class me{constructor(t,e=!1){this.i32=!1,this._flat=!0,this.instances=0,this.uniforms={},this._flat=t,this.clip=e,this.idOffsets=[],this.cullFace=1028,this.first=0}setRequiresHeightMap(t){this.requiresHeightMap=t,t&&(this._flat=!1)}addUniform(t,e){this.uniforms[t]=e}count(){if(null!=this._cnt)return this._cnt;const{data:t,size:e}=this.flexAttributes.a_position;return t.length/e-this.first}setArray(t,e){this.first=t,this._cnt=e}setIndex(t){this._index=t}index(){return this._index=this._index||[]}hasIndex(){return!!this._index}isEmpty(){return 0==this.count()}trimAttribute(t){const e=t;return e.data instanceof ge&&(e.data=e.data.trim()),e}isFlat(){return this._flat}getPositionAttribute(){return this.flexAttributes.a_position}finalize(t){var e;const i=this,{flexAttributes:s}=i;let r;if(i.hasIndex()){const e=i.index();if(!e.length)return null;r=new Yt(e,t,i.i32)}else r=new Yt({first:i.first,count:i.count()},t);for(let t in s){let n=s[t];(null===(e=n.data)||void 0===e?void 0:e.length)&&r.addAttribute(t,i.trimAttribute(n))}return r.idOffsets=i.idOffsets,r}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(t)}populateGeometryBuffer(t){t.instances=this.instances,t.idOffsets=this.idOffsets,t.cullFace(this.cullFace),t.rayIntersects=this.rayIntersects,t.setHeightMapRef(this.requiresHeightMap)}rayIntersects(t,e,i,s,r){return null}}var ve=1e-6,xe="undefined"!=typeof Float32Array?Float32Array:Array;function ye(){var t=new xe(3);return xe!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function _e(t,e,i){var s=new xe(3);return s[0]=t,s[1]=e,s[2]=i,s}function be(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function we(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Me(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function Te(t,e){var i=e[0],s=e[1],r=e[2],n=i*i+s*s+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Se(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function Ae(t,e,i){var s=e[0],r=e[1],n=e[2],o=i[0],a=i[1],l=i[2];return t[0]=r*l-n*a,t[1]=n*o-s*l,t[2]=s*a-r*o,t}function Le(t,e,i){var s=e[0],r=e[1],n=e[2],o=i[3]*s+i[7]*r+i[11]*n+i[15];return o=o||1,t[0]=(i[0]*s+i[4]*r+i[8]*n+i[12])/o,t[1]=(i[1]*s+i[5]*r+i[9]*n+i[13])/o,t[2]=(i[2]*s+i[6]*r+i[10]*n+i[14])/o,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function ze(){var t=new xe(16);return xe!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Pe(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ce(t,e){var i=e[0],s=e[1],r=e[2],n=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],f=e[11],p=e[12],g=e[13],m=e[14],v=e[15],x=i*a-s*o,y=i*l-r*o,_=i*h-n*o,b=s*l-r*a,w=s*h-n*a,M=r*h-n*l,T=c*g-u*p,S=c*m-d*p,A=c*v-f*p,L=u*m-d*g,z=u*v-f*g,P=d*v-f*m,C=x*P-y*z+_*L+b*A-w*S+M*T;return C?(C=1/C,t[0]=(a*P-l*z+h*L)*C,t[1]=(r*z-s*P-n*L)*C,t[2]=(g*M-m*w+v*b)*C,t[3]=(d*w-u*M-f*b)*C,t[4]=(l*A-o*P-h*S)*C,t[5]=(i*P-r*A+n*S)*C,t[6]=(m*_-p*M-v*y)*C,t[7]=(c*M-d*_+f*y)*C,t[8]=(o*z-a*A+h*T)*C,t[9]=(s*A-i*z-n*T)*C,t[10]=(p*w-g*_+v*x)*C,t[11]=(u*_-c*w-f*x)*C,t[12]=(a*S-o*L-l*T)*C,t[13]=(i*L-s*S+r*T)*C,t[14]=(g*y-p*b-m*x)*C,t[15]=(c*b-u*y+d*x)*C,t):null}function Ee(t,e,i){var s=e[0],r=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],g=e[12],m=e[13],v=e[14],x=e[15],y=i[0],_=i[1],b=i[2],w=i[3];return t[0]=y*s+_*a+b*u+w*g,t[1]=y*r+_*l+b*d+w*m,t[2]=y*n+_*h+b*f+w*v,t[3]=y*o+_*c+b*p+w*x,y=i[4],_=i[5],b=i[6],w=i[7],t[4]=y*s+_*a+b*u+w*g,t[5]=y*r+_*l+b*d+w*m,t[6]=y*n+_*h+b*f+w*v,t[7]=y*o+_*c+b*p+w*x,y=i[8],_=i[9],b=i[10],w=i[11],t[8]=y*s+_*a+b*u+w*g,t[9]=y*r+_*l+b*d+w*m,t[10]=y*n+_*h+b*f+w*v,t[11]=y*o+_*c+b*p+w*x,y=i[12],_=i[13],b=i[14],w=i[15],t[12]=y*s+_*a+b*u+w*g,t[13]=y*r+_*l+b*d+w*m,t[14]=y*n+_*h+b*f+w*v,t[15]=y*o+_*c+b*p+w*x,t}function Ie(t,e,i){var s,r,n,o,a,l,h,c,u,d,f,p,g=i[0],m=i[1],v=i[2];return e===t?(t[12]=e[0]*g+e[4]*m+e[8]*v+e[12],t[13]=e[1]*g+e[5]*m+e[9]*v+e[13],t[14]=e[2]*g+e[6]*m+e[10]*v+e[14],t[15]=e[3]*g+e[7]*m+e[11]*v+e[15]):(s=e[0],r=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],t[0]=s,t[1]=r,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=h,t[7]=c,t[8]=u,t[9]=d,t[10]=f,t[11]=p,t[12]=s*g+a*m+u*v+e[12],t[13]=r*g+l*m+d*v+e[13],t[14]=n*g+h*m+f*v+e[14],t[15]=o*g+c*m+p*v+e[15]),t}function Re(t,e,i){var s=i[0],r=i[1],n=i[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}ye();var ke=function(t,e,i,s,r){var n,o=1/Math.tan(e/2);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(n=1/(s-r),t[10]=(r+s)*n,t[14]=2*r*s*n):(t[10]=-1,t[14]=-2*s),t};var Fe=function(t,e,i,s,r,n,o){var a=1/(e-i),l=1/(s-r),h=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+i)*a,t[13]=(r+s)*l,t[14]=(o+n)*h,t[15]=1,t};class De{constructor(t,e){this.invScaleFactor=[1,1,1],this.localRay={origin:new Float32Array(3),direction:new Float32Array(3),modelMatrix:new Float32Array(16),invModelMatrix:new Float32Array(16)},this.sMat=t,this.iSMat=e,this.origin=[0,0,0],this.direction=[0,0,0],this.sOrigin=[0,0,0],this.sDirection=[0,0,0],this.pIntersection=[0,0,0],this.intersectRayLength=0}static rayIntersectsTriangle(t,e,i,s,r,n){const o=1e-7,a=we([0,0,0],s,i),l=we([0,0,0],r,i),h=Ae([0,0,0],e,l),c=Se(a,h);if(c>-1e-7&&c<o)return null;const u=1/c,d=we([0,0,0],t,i),f=u*Se(d,h);if(f<0||f>1)return null;const p=Ae([0,0,0],d,a),g=u*Se(e,p);if(g<0||f+g>1)return null;const m=u*Se(l,p);return m>o?(n&&be(n,t,Me(n,e,m)),m):null}static getPointAtRayLength(t,e,i,s=[]){return be(s,e,Me(s,i,t))}getInverseWorldScale(t){const{invScaleFactor:e}=this,i=1/t;return e[0]=i,e[1]=i,e[2]=1/(this.scaleZ*this.scale),e}intersectAABBox(t,e,i,s,r,n,o=this.origin,a=this.direction){const[l,h,c]=a,[u,d,f]=o,p=1/l,g=1/h,m=1/c,v=(t-u)*p,x=(s-u)*p,y=(e-d)*g,_=(r-d)*g,b=(i-f)*m,w=(n-f)*m,M=Math.min(Math.min(Math.max(v,x),Math.max(y,_)),Math.max(b,w));if(M<0)return null;const T=Math.max(Math.max(Math.min(v,x),Math.min(y,_)),Math.min(b,w));return T>M?null:T}intersectSphere(t,e){const i=we([],t,this.origin),s=Se(i,this.direction),r=Se(i,i)-s*s,n=e*e;if(r>n)return null;const o=Math.sqrt(n-r),a=s-o,l=s+o;return a<0&&l<0?null:a<0?l:a}intersectEllipsoid(t,e){const i=we([],this.origin,t),s=this.direction,r=e[0]*e[0],n=e[1]*e[1],o=e[2]*e[2],a=s[0]*s[0]/r+s[1]*s[1]/n+s[2]*s[2]/o,l=2*i[0]*s[0]/r+2*i[1]*s[1]/n+2*i[2]*s[2]/o;let h=l*l-4*a*(i[0]*i[0]/r+i[1]*i[1]/n+i[2]*i[2]/o-1);if(h<0)return null;h=Math.sqrt(h);const c=(-l+h)/(2*a),u=(-l-h)/(2*a);return c<u?c:u}init(t,e,i,s,r,n){const{sMat:o,iSMat:a,origin:l,direction:h,sOrigin:c,sDirection:u}=this;this.w=i,this.h=s,this.scale=r,this.scaleZ=n,c[0]=t,c[1]=e,c[2]=-1,h[0]=t,h[1]=e,h[2]=0,Le(l,c,a),Le(h,h,a),Le(u,h,o),we(u,u,c),Te(u,u),we(h,h,l),Te(h,h),this.result={id:null,z:1/0,pointWorld:null}}rayLengthScreenToWorld(t){const e=this.iSMat,i=this.origin[2],s=this.direction[2],r=t[0],n=t[1];let o=t[2];const a=e[3]*r+e[7]*n+e[11]*o+e[15];return o=(e[2]*r+e[6]*n+e[10]*o+e[14])/(a||1),(o-i)/s}getIntersectionTop(){const{result:t}=this;if(t.z!=1/0){let e=De.getPointAtRayLength(t.z,t.origin||this.origin,t.direction||this.direction);if(t.localMatrix){const i=t.z;e=Le([],be([],t.origin,Me([],t.direction,i)),t.localMatrix)}t.pointWorld=e}return t}transformRayToLocal(t){const e=this.origin,i=this.direction,s=this.localRay,r=Ce(s.invModelMatrix,t);Le(s.origin,e,r);const n=s.direction;return n[0]=i[0]*r[0]+i[1]*r[4]+i[2]*r[8],n[1]=i[0]*r[1]+i[1]*r[5]+i[2]*r[9],n[2]=i[0]*r[2]+i[1]*r[6]+i[2]*r[10],Te(n,n),s.modelMatrix=t,s}intersect(t,e,i,s){if(!1===i.pointerEvents)return;const r=this.result,n=this.origin,o=this.direction,a="world"===i.getRenderSpace()&&this.transformRayToLocal(s);a&&(this.origin=a.origin,this.direction=a.direction,t=0,e=0);const l=i.rayIntersects(i,r,t,e,this);return null!=l&&(r.id=l,r.origin=a?a.origin.slice():null,r.direction=a?a.direction.slice():null,r.localMatrix=a?a.modelMatrix:null),this.origin=n,this.direction=o,l}}class Ue extends me{constructor(t=!0){super(t,!0),t||(this.cullFace=null),this.flexAttributes={a_position:{data:new ge(Float32Array),size:t?2:3},a_normal:{data:new ge(Int16Array),size:4},a_lengthSoFar:{data:new ge(Float32Array),size:1}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,s,r){const{attributes:n}=t;let o=n.a_position.data,a=n.a_normal.data,l=n.a_position.size;const h=[0,0,0],c=[0,0,0],u=[0,0,0];let d=r.origin,f=r.direction,p=.5*t.getUniform("u_strokeWidth")[0]/r.scale;const g=t.getUniform("u_scaleByAltitude"),m=1/8192;let v;const x=r.sMat[3],y=r.sMat[7],_=r.sMat[11],b=r.sMat[15];for(let t=0,r=0;t<o.length;r+=12){let n=a[r],w=a[r+1];n=(2*(1&n)-1)*(n>>1)*m;w=(2*(1&w)-1)*(w>>1)*m;let M=o[t++],T=o[t++],S=3==l?o[t++]:0,A=a[r+4],L=a[r+5];A=(2*(1&A)-1)*(A>>1)*m;L=(2*(1&L)-1)*(L>>1)*m;let z=o[t++],P=o[t++],C=3==l?o[t++]:0,E=a[r+8],I=a[r+9];E=(2*(1&E)-1)*(E>>1)*m;I=(2*(1&I)-1)*(I>>1)*m;let R=o[t++],k=o[t++],F=3==l?o[t++]:0;const D=i+M,U=s+T,O=1+(g?0:S*_/(x*D+y*U+b));h[0]=D+n*p*O,h[1]=U+w*p*O,h[2]=S,c[0]=i+z+A*p*O,c[1]=s+P+L*p*O,c[2]=C,u[0]=i+R+E*p*O,u[1]=s+k+I*p*O,u[2]=F;let B=De.rayIntersectsTriangle(d,f,h,c,u);null!=B&&B<=e.z&&(e.z=B,v=t-l)}if(null!=v)for(let i=0,{idOffsets:s}=t,{length:r}=s;i<r;i+=2)if(v<s[i])return e.id=s[i+1]}}const Oe=[0,0,1,0,0,1,0,1,1,0,1,1],Be=(t,e,i,s)=>{const r=new Yt({first:0,count:6},"Image");return r.addAttribute("a_position",{data:new Int16Array([0,0,i,0,0,i,0,i,i,0,i,i]),size:2,stride:0}),r.addAttribute("a_textureCoord",{data:new Int8Array(Oe),size:2,stride:0}),r.addUniform("u_tileScale",1),r.addUniform("u_sampler",new Gt(e,t)),r.zIndex=0,r.clip=!0,r.blend=s,r.pass=s?bt.ALPHA:bt.OPAQUE,r.pixelPerfect=!0,r.pointerEvents=!1,r.cullFace(1028),r},{toRGB:He}=e.Color;let Ge;class Ne{constructor(t,e=[]){this.gl=t,this.ext={};for(let t of e)this.getExtension(t)}getExtension(t){const{ext:e,gl:i}=this;let s=e[t];return void 0===s&&(s=e[t]=i.getExtension(t)),s}}class We{constructor(t,e,i,s){this.tiled=!0,this._modelMatrix=ze(),this._mvpMatrix=ze(),this._invModelMatrix=ze(),this.init(t,e,i,s)}init(t,e,i,s){this.buffer=t,this.z=e,this.data=i,this.layer=s,Pe(this._modelMatrix),this._mmUpdated=!1,this._mvpUpdated=!1,this._iMMUpdate=!0}reset(){this.buffer=null,this.data=null,this.layer=null}getModelMatrix(){return this._modelMatrix}getInverseModelMatrix(){return this._iMMUpdate&&(this._iMMUpdate=!1,Ce(this._invModelMatrix,this._modelMatrix)),this._invModelMatrix}worldToTile(t,e,i){const s=[t,e,i||0];return Le(s,s,this.getInverseModelMatrix())}updateMVPMatrix(t){return this._mmUpdated?this._mvpUpdated?this._mvpMatrix:(this._mvpUpdated=!0,Ee(this._mvpMatrix,t,this._modelMatrix)):t}setTransform(t,e,i){if(!this._mmUpdated){this._mmUpdated=!0,this._iMMUpdate=!0;const s=this._modelMatrix;s[12]=t,s[13]=e,s[0]=i,s[5]=i}return this._modelMatrix}prepareHeightMapReferences(){const t=this.buffer;if("required"==t.heightMapRef&&this.layer.getTerrainLayer())return t.heightMapRef=this.data.tile.quadkey}}class Ze{constructor(){this.pool=[],this.index=0}beginFrame(){this.index=0}getNext(){this.index>=this.pool.length&&this.pool.push(new We);return this.pool[this.index++]}endFrame(){for(let t=this.index;t<this.lastClearedIndex;t++)this.pool[t].reset();this.lastClearedIndex=this.index}getUsedNodes(){return this.pool.slice(0,this.index)}}var Ye=e.Color.toRGB;const Ve={ortho:Fe,create:ze,lookAt:function(t,e,i,s){var r,n,o,a,l,h,c,u,d,f,p=e[0],g=e[1],m=e[2],v=s[0],x=s[1],y=s[2],_=i[0],b=i[1],w=i[2];return Math.abs(p-_)<ve&&Math.abs(g-b)<ve&&Math.abs(m-w)<ve?Pe(t):(c=p-_,u=g-b,d=m-w,r=x*(d*=f=1/Math.hypot(c,u,d))-y*(u*=f),n=y*(c*=f)-v*d,o=v*u-x*c,(f=Math.hypot(r,n,o))?(r*=f=1/f,n*=f,o*=f):(r=0,n=0,o=0),a=u*o-d*n,l=d*r-c*o,h=c*n-u*r,(f=Math.hypot(a,l,h))?(a*=f=1/f,l*=f,h*=f):(a=0,l=0,h=0),t[0]=r,t[1]=a,t[2]=c,t[3]=0,t[4]=n,t[5]=l,t[6]=u,t[7]=0,t[8]=o,t[9]=h,t[10]=d,t[11]=0,t[12]=-(r*p+n*g+o*m),t[13]=-(a*p+l*g+h*m),t[14]=-(c*p+u*g+d*m),t[15]=1,t)},multiply:Ee,perspective:ke,rotateX:function(t,e,i){var s=Math.sin(i),r=Math.cos(i),n=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+h*s,t[5]=o*r+c*s,t[6]=a*r+u*s,t[7]=l*r+d*s,t[8]=h*r-n*s,t[9]=c*r-o*s,t[10]=u*r-a*s,t[11]=d*r-l*s,t},rotateZ:function(t,e,i){var s=Math.sin(i),r=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],h=e[4],c=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+h*s,t[1]=o*r+c*s,t[2]=a*r+u*s,t[3]=l*r+d*s,t[4]=h*r-n*s,t[5]=c*r-o*s,t[6]=u*r-a*s,t[7]=d*r-l*s,t},translate:Ie,scale:Re,clone:function(t){var e=new xe(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},invert:Ce,identity:Pe},Xe=2*Math.PI,je=Math.PI/180,qe=40*je,$e="ANGLE_instanced_arrays",Ke={font:"bold 14px Arial",stroke:"red",fill:"white",strokeWidth:3},Qe=72*je,Je=[[0,0,1]];class ti{constructor(t){this.skyMatrix=new Float32Array([2,0,0,0,0,-1,0,0,0,0,1,0,-1,1,0,1]),this.skyBuffer=(()=>{const t=new Yt({first:0,count:6},"Sky");return t.addAttribute("a_position",{data:new Int8Array([0,0,1,0,0,1,0,1,1,0,1,1]),size:2}),t.id="sky",t.addUniform("u_fill",[0,0,0,1]),t.addUniform("u_horizon",[0,0]),t.clip=!1,t.depth=!1,t.depthMask=!1,t.pass=bt.OPAQUE|bt.ALPHA,t.blend=!1,t})(),this.sky=new We(this.skyBuffer),this.cameraWorld=new Float64Array(3),this.gridTextBuf=new WeakMap,this.tileGrid=!1,this.dbgTile={},this.dbgRenderTile=new We,this.processedLight=[],this.buffers=new WeakMap,this.resolution=[],this.viewUniforms={rz:0,elapsedTime:0,fixedView:0,inverseMatrix:new Float32Array(16)},this._tm=new Float32Array(16),this.reservedStencils=new Map,this.ctxAttr=Object.assign({alpha:!0,antialias:!1,depth:!0,stencil:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},t),this.vPMat=Ve.create(),this.vPRasterMat=Ve.create(),this.vMat=Ve.create(),this.invVPMat=Ve.create(),this.screenMat=Ve.create(),this.invScreenMat=Ve.create(),this._tmpMatrix=Ve.create(),this.worldMatrix=new Float64Array(16),this.localCamera=new Float64Array(3)}getContext(){return this.gl}setPass(t){const{gl:e}=this;switch(this.pass=t,t){case bt.OPAQUE:this.depthMask=!0,this.depthFnc=e.LESS;break;case bt.ALPHA:this.depthFnc=e.LEQUAL,this.depthMask=!1;break;case bt.POST_ALPHA:this.depthFnc=e.EQUAL,this.depthMask=!1,e.disable(e.SCISSOR_TEST),e.clear(e.STENCIL_BUFFER_BIT)}}convertColor(t){return Ye(t)}setBackgroundColor(t){var e,i;null===(e=this.gl)||void 0===e||e.clearColor(t[0],t[1],t[2],null!==(i=t[3])&&void 0!==i?i:1)}setSkyColor(t){this.skyBuffer.addUniform("u_fill",t)}setScale(t,e,i){}setRotation(t,e){}clear(t){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null),t&&this.setBackgroundColor(t),e.colorMask(!0,!0,!0,!0),e.disable(e.SCISSOR_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this.reservedStencils.clear()}init(t,e,i){this.dpr=e;const s=t.getContext("webgl",this.ctxAttr);s.dpr=e,this.startTime=Date.now(),this.gl=s,this.glExt=new Ne(s,["OES_element_index_uint",$e,"OES_texture_float"]),this.terrainHeightMapCache=i,this.terrainHeightMapCache.initEmptyTexture(this.gl),this.initContext();const r=((t,e)=>{const i=Be({width:1,height:1,data:new Uint8ClampedArray([255,255,255,255])},e,1,!1);return i.id="StencilTile",i.clip=!0,i.depth=!1,i.pass=bt.OPAQUE,i})(0,s);r.pass=bt.OPAQUE|bt.ALPHA,r.blend=!0,r.colorMask={r:!1,g:!1,b:!1,a:!1},r.depthMask=!1,this.stencilTile=r,this.depthBufferSize=1<<s.getParameter(s.DEPTH_BITS);const n=this.programConfig={Rect:{program:St},Line:{program:Pt},DashedLine:{program:Ct,default:!1},Text:{program:kt},Image:{program:Rt},Circle:{program:At},Polygon:{program:It},VerticalLine:{program:jt},Extrude:{program:Dt,default:!1},Icon:{program:Ft},Box:{program:Ut,default:!1},Sphere:{program:Ot,default:!1},Model:{program:Bt,default:!1},Terrain:{program:Ht,default:!1},Heatmap:{program:Xt,default:!1},Sky:{program:qt}};this.programs={};for(let t in n){const e=n[t];!1!==e.default&&this.createProgram(t,e.program)}}createProgram(t,e,i){const{gl:s,programs:r,dpr:n}=this;r[t]&&r[t].delete();const o=r[t]=new e(s,n,i);return o.init(this.buffers,this.glExt.getExtension($e)),o}initContext(){const{gl:t}=this;t.enable(t.CULL_FACE),t.cullFace(t.FRONT),t.enable(t.DEPTH_TEST),t.enable(t.SCISSOR_TEST),t.clearStencil(0),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}grid(t){if("object"==typeof t){if(null!=t.grid3d){Ht.dbgGrid=!!t.grid3d;for(let t in this.programs)this.programs[t]instanceof Ht&&(this.programs[t].delete(),delete this.programs[t])}}else this.tileGrid=t}applyTransform(){}updateMapGridMatrix(t,e,i){const s=e/2,r=i/2,n=r/Math.tan(qe/2),o=this._tmpMatrix,a=[s,r,n];return Ve.perspective(o,qe,e/i,.1,1e5),this.updateVPMatrix(o,a,t,0,[1,1,1]),o}updateVPMatrix(t,e,i,s,r,n=this._tm){const[o,a]=e;return Ve.lookAt(n,e,[o,a,0],[0,1,0]),Ve.translate(n,n,[o,a,0]),Ve.rotateX(n,n,-i),Ve.rotateZ(n,n,-s),Ve.scale(n,n,[r[0],-r[1],r[2]]),Ve.translate(n,n,[-o,-a,0]),Ve.multiply(t,t,n)}initView(t,e,i,s,r,n,o,a,l){const h=this.vPMat,c=this.vMat;this.zMeterToPixel=1/n;const u=.5*qe,d=.5*t,f=.5*e,p=f/Math.tan(u),g=Math.sin(u)*p,m=Math.min(s,or),v=.5*Math.PI-u-m;let x=p+(s>m?Math.cos(Math.PI/2-s):Math.sin(m))*(g/Math.sin(v));x*=1.005,this.rz=(r+Xe)%Xe,this.rx=s,this.scale=i,this.setResolution(t,e),this.gl.viewport(0,0,t*this.dpr,e*this.dpr);const y=e/100;Ve.perspective(h,qe,t/e,y,x),this.worldMatrix.set(h),this.updateVPMatrix(this.worldMatrix,[o,a,p],s,r,[l,l,l]),this.updateVPMatrix(h,[d,f,p],s,r,[i,i,i/n],c),Ce(this.invVPMat,h);let _=Ve.identity(this.screenMat);Ve.scale(_,_,[d,-f,1]),Ve.translate(_,_,[1,-1,0]),Ve.multiply(_,_,this.vPMat),Ce(this.invScreenMat,_),this.updateCamWorld(this.cameraWorld);const b=Ve.copy(this.vPRasterMat,h),w=o*l,M=a*l,T=w-Math.round(w)+d%1,S=M-Math.round(M)+f%1;Ve.translate(b,b,[T-Math.round(T),S-Math.round(S),0]),this.distanceCam2Center=p,this.initSharedUniforms(),this.initDisplayUniforms()}updateCamWorld(t){const e=this.invVPMat;t[0]=e[12]/e[15],t[1]=e[13]/e[15],t[2]=e[14]/e[15]}getCameraElevationMeters(){return-this.cameraWorld[2]}initDisplayUniforms(){const{viewUniforms:t}=this;t.rz=this.rz,t.elapsedTime=(Date.now()-this.startTime)/1e3,t.inverseMatrix=this.invVPMat,t.fixedView=this.fixedView}initSharedUniforms(){this.sharedUniforms={u_resolution:this.resolution,u_scale:null,u_topLeft:[0,0],u_matrix:this.vPMat,u_zMeterToPixel:null}}useProgram(t){const e=this.prog;if(e!=t){const i=this.gl;return e&&e.disableAttributes(),i.useProgram(t.prog),this.prog=t,!0}return!1}drawGrid(t,e,i,s){let r=this.dbgRenderTile;r.init(this.getDbgTile(s)),this.drawBuffer(r,t,e,null,null);let n=this.gridTextBuf.get(i);n||(n=((t,e,i)=>{Ge||(Ge=new pe(e,i),Ge.addChars("L0123456789"),Ge.sync());const s=t+" L"+t.length,{length:r}=s,n=new ge(Int16Array,18*r),o=new ge(Uint16Array,12*r),{position:a,count:l,texcoord:h}=ue(s,Ge.atlas,n,o);let c=new Yt({first:0,count:l},"Text");return c.addAttribute("a_position",{data:new Int8Array(a.length).fill(1),size:2,stride:0}),c.addAttribute("a_point",{data:a,size:2,stride:0}),c.addAttribute("a_texcoord",{data:h,size:2,stride:0}),c.pass=bt.ALPHA,c.depth=!1,c.clip=!1,c.addUniform("u_texture",Ge),c.addUniform("u_texSize",[Ge.width,Ge.height]),c.addUniform("u_opacity",1),c.addUniform("u_alignMap",!0),c.addUniform("u_fillColor",He(i.fill)),c.addUniform("u_strokeColor",He(i.stroke)),c})(i.quadkey,this.gl,Ke),this.gridTextBuf.set(i,n)),r.init(n),this.drawBuffer(r,t+4,e+4)}releaseGeometryBuffer(t,e){const{buffers:i,gl:s}=this;let{attributes:r,uniforms:n}=t;for(let t in n){let e=n[t];if(e.format){0===(e.ref=(e.ref||1)-1)&&e.destroy()}}for(let t in r){let e=r[t];if(0===(e.ref=(e.ref||1)-1)){let t=i.get(e);s.deleteBuffer(t)}}for(let e of t.groups){const t=e.index;t&&s.deleteBuffer(i.get(t))}if(t.heightMap){const t=this.terrainHeightMapCache.get(e);t&&(t.texture.destroy(),this.terrainHeightMapCache.delete(e))}t.destroy(t)}initProgram(t,e,i,s=e.getUniformData(),r){const n=e.getAttributes();this.useProgram(t),t.setResolution(this.resolution),t.initBuffers(n),t.initGeometryBuffer(e,i,this.zIndex),t.initAttributes(n),t.initUniforms(this.sharedUniforms),t.initViewUniforms(this.viewUniforms),e.light&&this.bufferLightUniforms&&t.initLight(this.bufferLightUniforms,r||this.cameraWorld),t.initUniforms(s),t.initHeightMap(e,this.terrainHeightMapCache)}drawBuffer(t,e,i,s,r,n){const o=t.buffer,{gl:a,pass:l}=this,h=this.getProgram(o);if(h){const c=null==s&&void 0!==r;r||(r=1);const u=this.zIndex,d=o.flat&&u>this.min3dZIndex;let f=h.initPass(l,o);if(d&&o.pass==bt.OPAQUE&&(f=l==bt.ALPHA),f){const f=o.compileUniforms();if(!h.isBufferVisible(f.uniforms))return;const{sharedUniforms:p}=this;p.u_scale=this.scale*r,p.u_matrix=s||t.updateMVPMatrix(o.pixelPerfect?this.vPRasterMat:this.vPMat),p.u_zMeterToPixel=this.zMeterToPixel/r,o.renderScale=p.u_scale,this.viewUniforms.fixedView=this.fixedView;const g=o.needs2AlphaPasses();let m=null;(n||o.clip&&o.isFlat())&&(m=this.drawStencil(e,i,r));let{depthFnc:v,depthMask:x}=this,y=ti.DEFAULT_COLOR_MASK;g&&(l==bt.ALPHA?(y=ti.NO_COLOR_MASK,x=!0):l==bt.POST_ALPHA&&(null!=m?(a.stencilFunc(a.EQUAL,m,255),a.stencilOp(a.KEEP,a.KEEP,a.KEEP)):(a.stencilFunc(a.EQUAL,0,255),a.stencilOp(a.KEEP,a.KEEP,a.INCR),a.enable(a.STENCIL_TEST)))),a.depthFunc(v),a.depthMask(x),h.setColorMask(y),p.u_topLeft[0]=e,p.u_topLeft[1]=i;const _=(65535-u)/65536;a.depthRange(o.flat?_:0,_);let b=this.cameraWorld;c&&o.light&&(b=this.getLocalCameraPosition(t.getModelMatrix())),this.initProgram(h,o,l,o.getUniformData(),b),g&&l==bt.POST_ALPHA&&a.enable(a.STENCIL_TEST),d&&a.disable(a.DEPTH_TEST),h.draw(o,c)}}}getLocalCameraPosition(t){const{localCamera:e,cameraWorld:i,zMeterToPixel:s}=this;return Le(e,i,Ce([],t)),e}initStencil(t,e,i=Je){this.stencilVal=t,this.stencilSize=e,this.tileStencils=i}reserveStencilValue(t){const{reservedStencils:e}=this;let i=e.get(t);return i||(i=e.size+1,i>255&&(i=1,e.clear(),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)),e.set(t,i)),i}drawStencil(t,e,i){const{gl:s,stencilTile:r,sharedUniforms:n}=this,o=this.getProgram(r),a=16777216*i+this.stencilVal,l=this.reserveStencilValue(a);s.stencilFunc(s.ALWAYS,l,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE);for(let i of this.tileStencils)n.u_topLeft[0]=t+i[0]*this.stencilSize,n.u_topLeft[1]=e+i[1]*this.stencilSize,r.uniforms.u_tileScale=this.stencilSize*i[2],this.initProgram(o,r,this.pass,r.uniforms),s.enable(s.STENCIL_TEST),o.draw(r);return s.stencilFunc(s.EQUAL,l,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),l}initScissor(t,e,i,s){const{gl:r}=this,n=r.canvas.width,o=r.canvas.height;if(this.scale>4||-this.rx>Qe)return[0,0,n,o];const a=t+i,l=e+i,h=[t,l,0],c=[a,l,0],u=[t,e,0],d=[a,e,0];let f=1/0,p=-f,g=f,m=p;for(let t of[h,c,u,d]){let[e,i]=Le(t,t,s);e<f&&(f=e),e>p&&(p=e),i<g&&(g=i),i>m&&(m=i)}f=Math.round(.5*(f+1)*n),p=Math.round(.5*(p+1)*n),g=Math.round(.5*(g+1)*o),m=Math.round(.5*(m+1)*o);return[f,g,p-f,m-g]}initBufferScissorBox(t,e,i){if(t.clip){let s=e.size,{x:r,y:n,tile:o}=e,a=this.vPMat;if(i){const[t,e,o,a,l,h,c,u,d]=i;r+=h,n+=c,s*=u/a}t.scissorBox=this.initScissor(r,n,s,a)}else t.scissorBox=null}draw(t,e){const i=t.data.tile,{preview:s}=t.data,r=i.tile,{layer:n,buffer:o}=t;let{x:a,y:l,scaledSize:h}=i;const{tileSize:c}=n,u=h/c;if(this.zIndex=t.z,this.min3dZIndex=e,this.bufferLightUniforms=o.light?this.processedLight[n.index][o.light]:null,this.stencilVal=null,s){const[e,i,n,h,d,f,p,g,m]=s,v=g/h,x=a+(f-i*v)*u,y=l+(p-n*v)*u,_=v*u;t.setTransform(x,y,_);const{clip:b}=o;let w=!1;v>1&&!o.needs2AlphaPasses()&&o.flat&&(w=o.clip=!0),this.initStencil(r.i,c,t.data.stencils),this.drawBuffer(t,0,0,null,u*v,w),o.clip=b}else{let e;t.setTransform(a,l,u),this.initStencil(r.i,c),u>1?(a=0,l=0):e=o.pixelPerfect?this.vPRasterMat:this.vPMat,this.drawBuffer(t,a,l,e,u)}}drawSky(t,e,i){if(!t)return;this.zIndex=0;const{skyBuffer:s}=this,r=s.getUniform("u_horizon");r[0]=2*t/e,r[1]=2*i,s.clearUniformCache(),this.drawBuffer(this.sky,0,0,this.skyMatrix),this.gl.depthMask(!0)}destroy(){}prepare(t,e,i,s,r,n){}drawCustom(t,e){var i;const s=this,{gl:r}=s;s.prog=null;const n=(65535-e)/65536,o="3d"==t.renderOptions.mode?0:n;r.depthRange(o,n),r.disable(r.SCISSOR_TEST),r.disable(r.STENCIL_TEST),t.render(r,s.worldMatrix),null===(i=this.glExt.getExtension("OES_vertex_array_object"))||void 0===i||i.bindVertexArrayOES(null),r.bindFramebuffer(r.FRAMEBUFFER,null),this.initContext()}getProgram(t){let e=t.progId;const i=t.type;if(!e){const s=this.programConfig[i].program;e=t.progId=s.getProgramId(t,s.getMacros(t))}let s=this.programs[e];if(void 0===s){const r=this.programConfig[i].program;r&&(s=this.createProgram(e,r,r.getMacros(t)))}return s}setResolution(t,e){const{resolution:i}=this;i[0]=t,i[1]=e}getDbgTile(t){var e;return(e=this.dbgTile)[t]||(e[t]=((t=1,e=[1,0,0,1],i=2)=>{const s=new Ue,{flexAttributes:r}=s;ne(r.a_position.data,r.a_normal.data,new Float32Array([0,0,t,0,t,t,0,t,0,0]),new Float32Array([0,t,2*t,3*t,4*t]),10,2,0,t,!1,"butt","none",i);const n=s.finalize("Line");return n.addUniform("u_zIndex",0),n.addUniform("u_fill",e),n.addUniform("u_strokeWidth",[i,0]),n.addUniform("u_offset",[0,0]),n.clip=!1,n.depth=!1,n.pass=bt.ALPHA,n})(t))}}let ei;ti.DEFAULT_COLOR_MASK={r:!0,g:!0,b:!0,a:!0},ti.NO_COLOR_MASK={r:!1,g:!1,b:!1,a:!1};class ii{constructor(t){this.r=[],this.p=[],this.pool=t}init(t,e){this.luTs=null,this.quadkey=t,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0}busy(t){const e=t.id;for(let t in this.tasks){const i=this.tasks[t];if(e==i._lid)return i}}addTask(t,e){t._lid=e.id,this.tasks[t.id]=t}cancelTasks(t){const e=this.tasks;let i;for(let s in e)i=e[s],t&&t.id!=i._lid||(i.cancel(),delete e[s])}removeTask(t,e){delete this.tasks[t.id]}index(t){return this.layers.indexOf(t)}getDisplayLayer(t){return this.layers[this.index(t)]}ready(t,e){return 2==arguments.length&&(this.r[t]=e,e&&(this.luTs=Date.now())),this.r[t]}addLayer(t){this.r.splice(t,0,!1),this.p.splice(t,0,undefined)}removeLayer(t){this.r.splice(t,1),this.p.splice(t,1)}preview(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]}getOverlayingTiles(){const t=[],{quadkey:e}=this,i=e.length;return this.pool.forEach((s=>{const r=s.quadkey;(r.length<i&&0==e.indexOf(r)||r.length>i&&0==r.indexOf(e))&&t.push(s)})),t}}class si extends ii{constructor(t,e,i,s){super(t),this.data=[],this.onDrop=s,this.init(e,i)}clear(t){this.setData(t,ei),this.ready(t,!1),this.preview(t,!1)}init(t,e){super.init(t,e),this.data.length=0}setData(t,e){const i="number"==typeof t?t:this.layers.indexOf(t),s=this.data[i];return s&&s.length&&this.onDrop&&this.onDrop(s,i),this.data[i]=e,i}getData(t){return this.data[t]}addLayer(t){super.addLayer(t),this.data.splice(t,0,ei)}removeLayer(t){super.removeLayer(t),this.setData(t,ei),this.preview(t,ei),this.data.splice(t,1)}}class ri{constructor(t){this.tiles=new e.LRU(t)}setMaxSize(t){this.tiles.setSize(t)}getMaxSize(){return this.tiles.max}get(t,e){if(e){const e=this.tiles._[t];return e&&e.data}return this.tiles.get(t)}forEach(t){return this.tiles.forEach(t)}}class ni extends ri{constructor(t){super(t)}create(t,e){const{tiles:i,onDrop:s}=this;let r,n,o=i.get(t);if(!o&&(o=new si(this,t,e,s),r=i.set(t,o),r&&(n=r.data))){for(let t=0;t<n.length;t++)r.setData(t,null),r.preview(t,null);r.data=null}return o}}class oi extends e.Task{constructor(t){var e;super(t),this.name="TerrainTask",this.time=2,this.gl=t.gl,this.tile=t.displayTile,this.terrainCache=t.terrainCache,this.terrainLayer=t.terrainLayer;const i=null===(e=this.terrainLayer)||void 0===e?void 0:e.layer;this.padding=null==i?void 0:i.getHeightmapPadding()}blitHeightmap(t,e,i,s=0,r=0,n,o=0,a=0,l){const h=this.padding,c=Math.max(0,Math.floor(o)),u=Math.max(0,Math.floor(a)),d=Math.min(i-1,Math.floor(o+l)),f=Math.min(i-1,Math.floor(a+l)),p=(n-1)/(l-1),g=(n-1)/(l-1);for(let n=u;n<=f;n++){const l=r+(n-a)*g,u=Math.min(i-1,Math.max(h,Math.round(l)))*i,f=n*i;for(let r=c;r<=d;r++){const n=s+(r-o)*p,a=Math.min(i-1,Math.max(h,Math.round(n)));e[f+r]=t[u+a]}}}init(t){var e;return this.heightMap=null,{buffers:t.buffers,bufferIndex:0,heightMapIndex:0,heightMap:null,heightMapSize:(null===(e=this.terrainLayer)||void 0===e?void 0:e.tileSize)+1}}exec(t){var e;if(!this.terrainLayer)return;const i=t.buffers;for(;t.bufferIndex<i.length;){const s=i[t.bufferIndex];let r=this.tile.quadkey;if("required"===s.heightMapRef){if(!(this.terrainCache.get(r)||this.heightMap)){const i=this.tile.preview(this.terrainLayer.index);if(!(null==i?void 0:i.length))return;const s=i[t.heightMapIndex],r=null===(e=this.terrainCache.get(s[0]))||void 0===e?void 0:e.data,n=Math.sqrt(null==r?void 0:r.length)||t.heightMapSize,o=(n-1-2*this.padding)/this.terrainLayer.tileSize,a=t.heightMap||(t.heightMap=new Float32Array(n*n));if(r&&this.blitHeightmap(r,a,n,s[1]*o,s[2]*o,s[3]*o,s[5]*o,s[6]*o,s[7]*o),++t.heightMapIndex<i.length)return this.CONTINUE;{const e=new Gt(this.gl,{data:a,width:n,height:n});this.heightMap={data:a,size:n,texture:e,tileSize:this.terrainLayer.tileSize},t.heightMap=null,t.heightMapIndex=0}}s.terrainCache=this.terrainCache,s.heightMapRef=r}else s.heightMap&&(this.heightMap=s.heightMap);return++t.bufferIndex<i.length?this.CONTINUE:this.BREAK}}onDone(t){const e=this.heightMap;return this.heightMap=null,e}}class ai{constructor(){this.length=0,this.buffers=[]}push(t){this.buffers.push(t),this.length++}pop(){if(this.length)return this.length--,this.buffers.pop()}get(t){return this.buffers[t]}set(t,e){this.buffers[t]=e,this.length=this.buffers.length}setIdOffset(t){for(let e of this.buffers)e.setIdOffset(t)}isEmpty(){for(let t of this.buffers)if(t.isEmpty())return!0;return!1}toArray(){return this.buffers}setRequiresHeightMap(t){for(let e of this.buffers)e.setRequiresHeightMap(t);this.requiresHeightMap=t}}const li=(t,e,i,s,r,n)=>{let o=r.length;const a=t=t*s<<2|1,l=e=e*s<<2|3&n,h=2|t,c=l,u=a,d=2|e,f=h,p=d;return"number"==typeof i?(i=Math.round(i/9e3*65535),r.push(a,l,i,u,d,i,f,p,i,a,l,i,f,p,i,h,c,i),o+=18):(r.push(a,l,u,d,f,p,a,l,f,p,h,c),o+=12),o},hi=t=>9e3*t/65535,ci=(t,e,i)=>e>0?t*e*i:t,ui=(t,e,i)=>{const s=t.getUniform("u_offset"),r=ci(s[0],s[1],e),n=ci(s[2],s[3],e),o=t.getUniform("u_offsetZ");return[r,n,ci(o[0],o[1],e)]};class di extends me{constructor(t=!0,e){super(t,!1),this.flexAttributes={a_position:{data:new ge(Uint16Array),size:t?2:3}},e&&(this.normalizePosition=16384/e,this.addUniform("u_normalizePosition",1/this.normalizePosition)),this.first=0}addPoint(t,e,i,s){li(t,e,i,this.normalizePosition,this.flexAttributes.a_position.data)}rayIntersects(t,i,s,r,n){var o;const{type:a,attributes:l}=t,h=t.getUniform("u_alignMap"),c=t.getUniform("u_scaleByAltitude"),{scale:u,scaleZ:d,sMat:f}=n;let p=h?n.getInverseWorldScale(t.renderScale):[1,1,1];const g=h?1/t.renderScale:1;let m,v,[x,y,_]=ui(t,u);if(x*=p[0],y*=p[1],_*=p[2],"Rect"===a){const e=t.getUniform("u_size"),i=t.getUniform("u_strokeWidth")||0;m=.5*(e[0]+i),v=.5*(e[2]+i)}else"Circle"==a&&(m=v=t.getUniform("u_radius")[0]);m*=p[0],v*=p[1];const b=l.a_position,w=b.data,M=b.size,T=[0,0,0],S=[0,0,0];let A,L,z,P,C=null,E=1;h?(L=n.origin,z=n.direction):(A=[0,0,0],P=n.sMat,E=t.renderScale/u,L=n.sOrigin,z=n.sDirection);const I=E/32,R=f[3],k=f[7],F=f[11],D=f[15],U=6*M;for(let t=0,u=0;t<w.length;t+=U,u+=6){let d=s+(w[t]>>2)*I,f=r+(w[t+1]>>2)*I,p=3==M?hi(w[t+2]):0,b=(2&w[t])-1,E=(2&w[t+1])-1,U=t+2*M,O=(2&w[U])-1,B=(2&w[U+1])-1;if("Icon"===a){let t=null===(o=l.a_size)||void 0===o?void 0:o.data;m=.5*t[u]*g,v=.5*t[u+1]*g}if(h){T[0]=S[0]=d+x,T[1]=S[1]=f+y,T[2]=S[2]=p+_;const t=1+(c?0:T[2]*F/(R*T[0]+k*T[1]+D)),e=m*t,i=v*t;T[0]+=b*e,T[1]-=E*i,S[0]+=O*e,S[1]-=B*i}else T[0]=d,T[1]=f,T[2]=p+_,Le(T,T,P),T[0]+=x,T[1]+=y,S[0]=T[0]+O*m,S[1]=T[1]-B*v,S[2]=T[2],T[0]+=b*m,T[1]-=E*v;let H=n.intersectAABBox(T[0],T[1],T[2],S[0],S[1],S[2],L,z);H&&(h||(e.vec3.add(A,L,e.vec3.scale(A,z,H)),H=n.rayLengthScreenToWorld(A)),H<i.z&&(i.z=H,C=t))}if(null!=C)return t.idOffsets[Math.floor(C/U)]}}var fi=e.Color.toRGB;const pi={type:"LinearGradient",stops:{1:"white",.9:"#FCFBAE",.8:"#FAD932",.7:"#F26C19",.5:"#C41D6F",.3:"#70009C",0:"#1E0073"}};class gi extends di{constructor(t,e){super(!0,e),this.flexAttributes.a_weight={data:new ge(Float32Array),size:1}}static verifyAndFixGradient(t){let e=1/0;for(let i in t)i<e&&(e=i);const[i,s,r,n]=fi(t[e]);if(n>0)return(t=Object.assign({},t))[e]=`rgba(${255*i},${255*s},${255*r},0)`,t}addPoint(t,e,i=1){const{flexAttributes:s}=this;li(t,e,void 0,this.normalizePosition,s.a_position.data),s.a_weight.data.push(i,i,i,i,i,i)}}e.TaskManager.getInstance();const mi=Math.PI/180,vi=new Float32Array([-1,-1,-1,-1]);let xi;const yi=(t,e,i,s,r,n,o=0)=>{const a=t.z;for(let l of s){const s=U("type",l,e,a);if("Polygon"==s||"Line"==s){const{type:s,stroke:o,strokeWidth:h}=l;let c=U("stroke",l,e,a),u=U("strokeWidth",l,e,a);if(c&&u){l.type="Line",l.stroke=c,l.strokeWidth=u;for(let s of i)t.create(e,"LineString",s,[l],r,n.clipped,void 0,void 0,!l.fill||u>3);l.type=s,l.stroke=o,l.strokeWidth=u}}else if(0==o){const{bounds:i}=n,s=Q(l,e,a),[o,h]=s;o>=i[0]&&h>=i[1]&&o<i[2]&&h<i[3]&&t.create(e,"Point",s,[l],r)}}};class _i extends e.Task{constructor(t){super(t),this.name="CreateRenderBufferTask",this.time=4,this.factory=t.factory}init(t){const{tile:i,displayLayer:s,onInit:r,onDone:n}=t,o=s.layer,a=i.z+o.levelOffset,l=o.getStyle();let h=1;if(l){const t=l.strokeWidthZoomScale||l.LineStringZoomScale;t&&(h=t(a))}null==r||r();const c={},u=[],{showWireframe:d}=l,f=l.zLayer;return this.factory.init(i,c,o.tileSize,a,f,(t=>{u.push(t)})),{tile:i,data:i.data||[],zoomScale:h,featureIndex:0,chunkSize:16,layer:s,zoom:a,collisions:null,groups:c,showWireframe:d&&"boolean"!=typeof d?e.Color.toRGB(d):d,onDone(t){const e={buffers:t,pendingResources:u};return null==n||n(e),e}}}onDone(t){var e,s,r,n;const o=t.zoom,a=1/i.webMercator.getGroundResolution(o);let l,h=[];const c=t.groups,u=t.layer,d=t.tile;for(l in c){const i=c[l];if(i)for(let o of i.groups){let i=o.type,c=o.shared,f=c.stroke,p=c.strokeWidth,g=i;if(!o.buffer||o.buffer.isEmpty())continue;const m=o.buffer instanceof ai?o.buffer.toArray():[o.buffer];for(let v of m){const m=Yt.fromTemplateBuffer(i,v,c.light);if(null==m)continue;const x=null===(e=c.fill)||void 0===e?void 0:e[3],y=null===(s=c.stroke)||void 0===s?void 0:s[3],_=x<1||y<1;if(m.flat=v.isFlat(),m.addUniform("u_scaleByAltitude",c.scaleByAltitude),m.pointerEvents=o.pointerEvents,"VerticalLine"==g&&(m.addUniform("u_fill",c.stroke),m.addUniform("u_offsetZ",[c.offsetZ,"m"==c.offsetUnit?a:0])),h.push(m),"Line"==i)c.strokeDasharray&&(m.type="DashedLine",m.addUniform("u_dashUnit",["m"==c.strokeDasharray.units[0]?a:0,"m"==c.strokeDasharray.units[1]?a:0])),m.clip=!d.clipped,m.addUniform("u_fill",f),m.addUniform("u_strokeWidth",[p,"m"==c.unit?a:0]),m.addUniform("u_offset",[c.offsetX,"m"==c.offsetUnit?a:0]),m.addUniform("u_no_antialias",!1),m.pass=bt.ALPHA,(!m.isFlat()||c.strokeDasharray||_)&&(m.pass|=bt.POST_ALPHA),m.depth=m.blend=!0;else{if("Polygon"==i||"Extrude"==i){if(m.addUniform("u_fill",c.fill),m.addUniform("u_fillIntensity",c.fillIntensity),"Extrude"==i&&(m.addUniform("u_strokePass",0),c.stroke)){m.addGroup(o.extrudeStrokeIndex,v.i32,1).uniforms={u_strokePass:1,u_stroke:c.stroke}}_&&(m.pass=bt.ALPHA,"Extrude"==i&&(m.pass|=bt.POST_ALPHA),m.depth=m.blend=!0)}else{if("Text"==i||"Icon"==i){"Text"==i?(m.uniforms.u_texture.sync(),m.addUniform("u_fillColor",c.fill||vi),m.addUniform("u_strokeColor",c.stroke||vi)):m.addUniform("u_opacity",c.opacity);const t=m.uniforms.u_texture;m.addUniform("u_texSize",[t.width,t.height]),m.addUniform("u_alignMap","map"==c.alignment),m.pass=bt.ALPHA,m.depth=m.blend=!0}else if("Rect"==i||"Circle"==i||"Box"==i||"Sphere"==i){const t=c.fill||vi;m.addUniform("u_fill",t),m.addUniform("u_fillIntensity",c.fillIntensity),f&&(m.addUniform("u_stroke",f),p==xi&&(p=1)),m.addUniform("u_strokeWidth",0^p);const e="m"==c.unit?a:0;"Circle"==i||"Sphere"==i?m.addUniform("u_radius",[c.width,e]):(t==vi&&(m.pass=bt.ALPHA,m.blend=!0),"Rect"==i&&m.addUniform("u_size",[c.width,e,c.height,e]),m.addUniform("u_rotation",c.rotation*mi)),_&&(m.pass=bt.ALPHA,m.depth=m.blend=!0),m.addUniform("u_alignMap","map"==c.alignment)}else if("Heatmap"==i){m.addUniform("u_radius",[c.width,0]),m.addUniform("u_weight",1),m.addUniform("u_intensity","number"==typeof c.height?c.height:1),m.addUniform("u_opacity",c.opacity),m.pass=bt.ALPHA|bt.POST_ALPHA,m.flat=!0,m.depth=!1,m.blend=!1;const t=(null===(r=c.fill)||void 0===r?void 0:r.stops)||pi.stops,e=this.factory.textureManager.getGradientTexture(t,gi.verifyAndFixGradient);m.addUniform("u_gradient",e)}Array.isArray(c.offsetUnit)&&(m.addUniform("u_offset",[c.offsetX,"m"==c.offsetUnit[0]?a:0,c.offsetY,"m"==c.offsetUnit[1]?a:0]),m.addUniform("u_offsetZ",[c.offsetZ,"m"==c.offsetUnit[2]?a:0]));let e="Model"===i;if("Terrain"===i&&(e=!0,m.addUniform("u_isPixelCoords",!!c.modelMode)),e){m.attributes.a_normal||m.addAttribute("a_normal",{data:m.computeNormals(),size:3,normalized:!0}),m.bbox=v.bbox,m.id=v.id,m.zRange=c.modelMode||null,m.destroy=v.destroy||m.destroy,m.depth=!0;const{showWireframe:e}=t;if(e){m.addGroup(v.generateWireframeIndices(),v.i32,Yt.MODE_GL_LINES).uniforms={diffuse:(!0===e?m.getUniform("diffuse"):e).slice(0,3).map((t=>1-t))}}m.uniforms.pointSize&&(m.groups[0].mode=Yt.MODE_GL_POINTS),m.uniforms.opacity<1&&(m.pass=bt.ALPHA,m.blend=!0)}}m.clip=v.clip,"Model"!=i&&(c.emissive&&m.addUniform("u_emissive.color",c.emissive),c.specular&&(m.addUniform("specular",c.specular),m.addUniform("shininess",c.shininess)))}let{zLayer:b}=o;if("top"==l&&(b=1/0,l=0),l=Number(l),!m.flat){m.clip=!1;const{depthTest:t}=o;t!=xi&&(m.depth=t,m.pass&&t||(m.pass=bt.ALPHA))}u.addZ(l,!m.flat),m.zIndex=l,m.zLayer="number"==typeof b?Math.ceil(b):null,null!==(n=m.clip)&&void 0!==n||(m.clip=!d.clipped||u.layer.getMargin()>0||_)}}}return t.onDone(h.reverse())}exec(t){const{tile:e,data:i,layer:s,zoomScale:r,zoom:n}=t,o=this.factory;let a,l,h,c,u,d=i.length;if(!t.collisions){for(u||(u=!1);t.chunkSize--&&(l=i[t.featureIndex++]);)if(a=s.processStyleGroup(l,n),a){h=l.geometry,c=h.type,a.length||(a=[a]);const t=l.getProvider().decCoord(l);if("MultiLineString"==c||"MultiPoint"==c){const e="MultiPoint"==c?"Point":"LineString";for(let i of t)o.create(l,e,i,a,r)}else if("MultiPolygon"==c){o.create(l,"Polygon",t,a,r);for(let i=0;i<t.length;i++)yi(o,l,t[i],a,r,e,i)}else o.create(l,c,t,a,r),"Polygon"==c&&yi(o,l,t,a,r,e)}u=t.featureIndex<d}if(!u&&o.pendingCollisions.length){t.collisions||(t.collisions=o.pendingCollisions.sort(((t,e)=>t.priority-e.priority)),t.featureIndex=0);let e,i=t.collisions;if(t.chunkSize>=0)for(;t.chunkSize--&&(e=i[t.featureIndex++]);){const{coordinates:t,priority:i,geomType:s}=e;"Point"!=s&&"LineString"!=s||o.create(e.feature,s,t,e.styleGrp,r,!1,i,e)}u=t.featureIndex<i.length}return t.chunkSize=16,u}}class bi{static startTask(t,i,s,r,n,o,a,l){const h=[new _i({priority:4,factory:r}),new oi({priority:4,terrainLayer:t.getTerrainLayer(),terrainCache:n,displayTile:s,gl:o})],c=new e.TaskSequence({tasks:h,onDone:t=>{null==l||l(t[0].buffers,t[0].pendingResources);const e=t[1];e&&n.set(i.quadkey,e)}});return c.start({tile:i,displayLayer:t,onInit:a}),c.outdated=!1,c}}!function(){var t,e=(t=new xe(4),xe!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();const wi=(t,e,i,s,r)=>{const n="number"==typeof r,o=n||!0===r,a=t.length,l=[];let h=0;for(let a=0;a<e.length;a++){for(let l,h,c=0;c<e[a].length;c++){const u=e[a][c];l=i.lon2x(u[0],s),h=i.lat2y(u[1],s),o?t.push(l,h,n?r:u[2]||0):t.push(l,h)}a>0&&(h+=e[a-1].length,l[l.length]=h)}return{dimensions:o?3:2,vertices:t,holes:l,start:a,stop:t.length}},Mi=(t,e,i,s,r)=>{let n;if("number"!=typeof e[0][0][0]){n=[];for(let o of e)n.push(wi(t,o,i,s,r))}else n=[wi(t,e,i,s,r)];return n},Ti=(t,e,i)=>{let s=0;for(let r=e,n=i-1;r<n;r+=3){let e=t[r],i=t[r+1];s+=(t[r+3]-e)*(i+t[r+4])}return s},Si=(t,e,i,s,r,n,o,a)=>{const l=t.holes,h=t.vertices.data,c=t.stop-3;let u=t.start,d=0;o=o||0;let f=0===l.length?-1:u+3*l[d]-6,p=u,g=-1!==f?f+3:c,m=Ti(e.data,p,g)>=0;for(;u<c;){let v,y,_,b;if(m){const t=g-(u-p);v=h[t],_=h[t+1],y=h[t-3],b=h[t-2]}else v=h[u],_=h[u+1],y=h[u+3],b=h[u+4];const w=Math.round(v)-Math.round(y),M=Math.round(_)-Math.round(b);if((w||M)&&(x(v,_,0,0,r,r)||x(y,b,0,0,r,r))){const t=e.length/3;s.push(t+2,t,t+1,t+3,t+2,t+1),null==a||a.push(t,t+1,t+2,t+3,t,t+2,t+1,t+3),e.push(v,_,n,v,_,o,y,b,n,y,b,o);const r=127/Math.sqrt(w*w+M*M),l=-M*r,h=w*r;i.push(l,h,l,h,l,h,l,h)}u===f?(u+=6,p=u,d++,f=d<l.length?t.start+3*l[d]-6:-1,g=-1!==f?f+3:c,m=Ti(e.data,p,g)<0):u+=3}},Ai=(t,e,i,s,r,n,o,a,l)=>{let h=t.length;const c=Mi(t,s,r,n,o);for(;h<t.length;)e.push(0,0),h+=3;if(o>.01)for(let s of c)Si(s,t,e,i,n,o,a,l);return c};function Li(t,e,i=2){const s=e&&e.length,r=s?e[0]*i:t.length;let n=zi(t,0,r,i,!0);const o=[];if(!n||n.next===n.prev)return o;let a,l,h;if(s&&(n=function(t,e,i,s){const r=[];for(let i=0,n=e.length;i<n;i++){const o=zi(t,e[i]*s,i<n-1?e[i+1]*s:t.length,s,!1);o===o.next&&(o.steiner=!0),r.push(Bi(o))}r.sort(Fi);for(let t=0;t<r.length;t++)i=Di(r[t],i);return i}(t,e,n,i)),t.length>80*i){a=t[0],l=t[1];let e=a,s=l;for(let n=i;n<r;n+=i){const i=t[n],r=t[n+1];i<a&&(a=i),r<l&&(l=r),i>e&&(e=i),r>s&&(s=r)}h=Math.max(e-a,s-l),h=0!==h?32767/h:0}return Ci(n,o,i,a,l,h,0),o}function zi(t,e,i,s,r){let n;if(r===function(t,e,i,s){let r=0;for(let n=e,o=i-s;n<i;n+=s)r+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return r}(t,e,i,s)>0)for(let r=e;r<i;r+=s)n=$i(r/s|0,t[r],t[r+1],n);else for(let r=i-s;r>=e;r-=s)n=$i(r/s|0,t[r],t[r+1],n);return n&&Zi(n,n.next)&&(Ki(n),n=n.next),n}function Pi(t,e){if(!t)return t;e||(e=t);let i,s=t;do{if(i=!1,s.steiner||!Zi(s,s.next)&&0!==Wi(s.prev,s,s.next))s=s.next;else{if(Ki(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function Ci(t,e,i,s,r,n,o){if(!t)return;!o&&n&&function(t,e,i,s){let r=t;do{0===r.z&&(r.z=Oi(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,i=1;do{let s,r=t;t=null;let n=null;for(e=0;r;){e++;let o=r,a=0;for(let t=0;t<i&&(a++,o=o.nextZ,o);t++);let l=i;for(;a>0||l>0&&o;)0!==a&&(0===l||!o||r.z<=o.z)?(s=r,r=r.nextZ,a--):(s=o,o=o.nextZ,l--),n?n.nextZ=s:t=s,s.prevZ=n,n=s;r=o}n.nextZ=null,i*=2}while(e>1)}(r)}(t,s,r,n);let a=t;for(;t.prev!==t.next;){const l=t.prev,h=t.next;if(n?Ii(t,s,r,n):Ei(t))e.push(l.i,t.i,h.i),Ki(t),t=h.next,a=h.next;else if((t=h)===a){o?1===o?Ci(t=Ri(Pi(t),e),e,i,s,r,n,2):2===o&&ki(t,e,i,s,r,n):Ci(Pi(t),e,i,s,r,n,1);break}}}function Ei(t){const e=t.prev,i=t,s=t.next;if(Wi(e,i,s)>=0)return!1;const r=e.x,n=i.x,o=s.x,a=e.y,l=i.y,h=s.y,c=Math.min(r,n,o),u=Math.min(a,l,h),d=Math.max(r,n,o),f=Math.max(a,l,h);let p=s.next;for(;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&Gi(r,a,n,l,o,h,p.x,p.y)&&Wi(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function Ii(t,e,i,s){const r=t.prev,n=t,o=t.next;if(Wi(r,n,o)>=0)return!1;const a=r.x,l=n.x,h=o.x,c=r.y,u=n.y,d=o.y,f=Math.min(a,l,h),p=Math.min(c,u,d),g=Math.max(a,l,h),m=Math.max(c,u,d),v=Oi(f,p,e,i,s),x=Oi(g,m,e,i,s);let y=t.prevZ,_=t.nextZ;for(;y&&y.z>=v&&_&&_.z<=x;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&Gi(a,c,l,u,h,d,y.x,y.y)&&Wi(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,_.x>=f&&_.x<=g&&_.y>=p&&_.y<=m&&_!==r&&_!==o&&Gi(a,c,l,u,h,d,_.x,_.y)&&Wi(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;y&&y.z>=v;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&Gi(a,c,l,u,h,d,y.x,y.y)&&Wi(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;_&&_.z<=x;){if(_.x>=f&&_.x<=g&&_.y>=p&&_.y<=m&&_!==r&&_!==o&&Gi(a,c,l,u,h,d,_.x,_.y)&&Wi(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function Ri(t,e){let i=t;do{const s=i.prev,r=i.next.next;!Zi(s,r)&&Yi(s,i,i.next,r)&&ji(s,r)&&ji(r,s)&&(e.push(s.i,i.i,r.i),Ki(i),Ki(i.next),i=t=r),i=i.next}while(i!==t);return Pi(i)}function ki(t,e,i,s,r,n){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&Ni(o,t)){let a=qi(o,t);return o=Pi(o,o.next),a=Pi(a,a.next),Ci(o,e,i,s,r,n,0),void Ci(a,e,i,s,r,n,0)}t=t.next}o=o.next}while(o!==t)}function Fi(t,e){let i=t.x-e.x;if(0===i&&(i=t.y-e.y,0===i)){i=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return i}function Di(t,e){const i=function(t,e){let i=e;const s=t.x,r=t.y;let n,o=-1/0;if(Zi(t,i))return i;do{if(Zi(t,i.next))return i.next;if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=s&&t>o&&(o=t,n=i.x<i.next.x?i:i.next,t===s))return n}i=i.next}while(i!==e);if(!n)return null;const a=n,l=n.x,h=n.y;let c=1/0;i=n;do{if(s>=i.x&&i.x>=l&&s!==i.x&&Hi(r<h?s:o,r,l,h,r<h?o:s,r,i.x,i.y)){const e=Math.abs(r-i.y)/(s-i.x);ji(i,t)&&(e<c||e===c&&(i.x>n.x||i.x===n.x&&Ui(n,i)))&&(n=i,c=e)}i=i.next}while(i!==a);return n}(t,e);if(!i)return e;const s=qi(i,t);return Pi(s,s.next),Pi(i,i.next)}function Ui(t,e){return Wi(t.prev,t,e.prev)<0&&Wi(e.next,t,t.next)<0}function Oi(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function Bi(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function Hi(t,e,i,s,r,n,o,a){return(r-o)*(e-a)>=(t-o)*(n-a)&&(t-o)*(s-a)>=(i-o)*(e-a)&&(i-o)*(n-a)>=(r-o)*(s-a)}function Gi(t,e,i,s,r,n,o,a){return!(t===o&&e===a)&&Hi(t,e,i,s,r,n,o,a)}function Ni(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&Yi(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(ji(t,e)&&ji(e,t)&&function(t,e){let i=t,s=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}(t,e)&&(Wi(t.prev,t,e.prev)||Wi(t,e.prev,e))||Zi(t,e)&&Wi(t.prev,t,t.next)>0&&Wi(e.prev,e,e.next)>0)}function Wi(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function Zi(t,e){return t.x===e.x&&t.y===e.y}function Yi(t,e,i,s){const r=Xi(Wi(t,e,i)),n=Xi(Wi(t,e,s)),o=Xi(Wi(i,s,t)),a=Xi(Wi(i,s,e));return r!==n&&o!==a||(!(0!==r||!Vi(t,i,e))||(!(0!==n||!Vi(t,s,e))||(!(0!==o||!Vi(i,t,s))||!(0!==a||!Vi(i,e,s)))))}function Vi(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function Xi(t){return t>0?1:t<0?-1:0}function ji(t,e){return Wi(t.prev,t,t.next)<0?Wi(t,e,t.next)>=0&&Wi(t,t.prev,e)>=0:Wi(t,e,t.prev)<0||Wi(t,t.next,e)<0}function qi(t,e){const i=Qi(t.i,t.x,t.y),s=Qi(e.i,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function $i(t,e,i,s){const r=Qi(t,e,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function Ki(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Qi(t,e,i){return{i:t,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Ji extends Gt{destroy(t){t&&super.destroy()}}class ts{constructor(t,e,i,s,r,n){this.i=t,this.u1=e,this.v1=s,this.u2=i,this.v2=r,this.atlasWidth=n.width,this.atlasHeight=n.height}normalized(){return{u1:this.u1/this.atlasWidth,v1:this.v1/this.atlasHeight,u2:this.u2/this.atlasWidth,v2:this.v2/this.atlasHeight}}}class es{constructor(t){const i=t.gl,s=t.maxImgSize||256,r=Math.pow(1024/s,2),n=Math.sqrt(r);this.c=new e.LRU(r),this.max=r,this.maxSize=s,this.gl=i,this.d=n}get(t){return this.c.get(t)}init(){let{texture:t,gl:e,maxSize:i,d:s}=this;if(!this.texture){const t=s*i;this.texture=new Ji(this.gl,{width:t,height:t})}}set(t,e){const i=this.c,{d:s,maxSize:r}=this;let n,o=i.get(t),a=!1;o?n=o.i:(n=i.length,n>=i.max&&(o=i.tail.data,n=o.i),a=!0);const l=n%s^0,h=n/s^0,c=l*r,u=h*r,d=c+e.width,f=u+e.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(this.init(),this.texture.set(e,l*r,h*r)),o?(o.u1=c,o.u2=d,o.v1=u,o.v2=f):o=new ts(n,c,d,u,f,this.texture),a&&i.set(t,o),o}destroy(){const{texture:t}=this;t&&t.destroy(!0)}}class is{constructor(t){this.data={},this.scale=10,this.gl=t}create(t){let e=t.reduce(((t,e)=>t+e));const i=512/e;e*=i;const s=new Uint8Array(e),{gl:r}=this;let n=!0,o=0;for(;o<e;)for(let e of t)e*=i,n&&s.fill(255,o,o+e),o+=e,n=!n;return{scale:i,texture:new Ji(r,{width:s.length,height:1,data:s},{format:r.LUMINANCE})}}get(t){const e=String(t);let i=this.data[e];return i||(i=this.data[e]=this.create(t)),i}}class ss{constructor(t=256){this.length=0,this.points=[],this.sqDistance=this.setMinDistance(t)}setMinDistance(t){return this.sqDistance=t*t}add(t,e){const{points:i}=this;i[this.length++]=t,i[this.length++]=e}clear(){this.length=0,this.points.length=0}hasSpace(t,e){const{length:i,points:s,sqDistance:r}=this;let n=0;if(r)for(;n<i;){const i=t-s[n++],o=e-s[n++];if(i*i+o*o<r)return!1}return!0}}const rs=180/Math.PI;var ns;!function(t){t[t.MID_TO_END=1]="MID_TO_END",t[t.MID_TO_START=-1]="MID_TO_START"}(ns||(ns={}));class os{constructor(t){this.length=0,this.dashes=new is(t),this.gl=t,this.pixels=new Float32Array(262144),this.alpha=new Float32Array(131072),this.lineLength=new Float32Array(131072),this.repeat={}}getDistanceGrp(){return this.repeat[this.dId]}projectLine(t,e,i){const{pixels:s,decimals:r}=this;if(!this.length){let n=0;const o="number"==typeof t[0][2]?3:2,a=3===o;for(let l,h,c,u,d,f,p=0,g=t.length;p<g;p++){let g=t[p];if(l=e.lon2x(g[0],i),h=e.lat2y(g[1],i),c=g[2]||0,(!p||Math.round(u*r)-Math.round(l*r)||Math.round(d*r)-Math.round(h*r)||a&&c!=f)&&(s[n++]=l,s[n++]=h,a&&(s[n++]=c),n>o)){const t=u-l,e=d-h;this.lineLength[p]=this.lineLength[p-1]+Math.sqrt(t*t+e*e)}u=l,d=h,f=c}this.length=n,this.dimensions=o}return this.length}placeCached(t,e,i,s){const{collisions:r}=this;for(let n,o=0;o<r.length;o++){n=r[o];let{cx:a,cy:l,cz:h}=n;const c=i<<e.z,u=1<<e.z;a=(a-e.x/u)*c,l=(l-e.y/u)*c,t(a,l,h,s?this.alpha[o]:0,0,n)}}initTile(){const{repeat:t}=this;for(let e in t)t[e].clear()}initFeature(t,e,i){this.decimals=t>=20-Number(512==e)?100:1,this.length=0,this.collisions=null;const{repeat:s}=this;this.dId=i,i&&!s[i]&&(s[i]=new ss)}createLine(t,e,i,s,r,n,o,a,l,h,c,u,d){e.buffer||(e.buffer=new Ue(!h));const f=e.buffer;if(n)if(!Qs(n.pattern)&&n.pattern.length>2&&!n.units.some((t=>t!=n.units[0]))){const t=this.dashes.get(n.pattern);f.addUniform("u_dashPattern",t.texture),f.addUniform("u_dashSize",[t.texture.width/t.scale,0])}else f.addUniform("u_dashSize",n.pattern);this.projectLine(t,i,s);const{pixels:p,length:g,dimensions:m}=this,v=g-m,x=p[0]==p[v]&&p[1]==p[v+1];return ne(f.flexAttributes.a_position.data,f.flexAttributes.a_normal.data,p,this.lineLength,g,m,h,s,r,o,a,l,n&&f.flexAttributes.a_lengthSoFar.data,x,c,u,d)}placeAtSegments(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g){var m;if(this.projectLine(t,i,s),null===(m=this.getDistanceGrp())||void 0===m||m.setMinDistance(null==o?256:o),p<f){const t=p;p=f,f=t}this.placeAlongLine(i,s,r,n,a,l,h,c,u,d,e,f,p,g)}getAbsOffset(t){if("string"==typeof t&&t.endsWith("px"))return parseFloat(t);const{length:e,dimensions:i,lineLength:s}=this;return t*s[e/i-1]}placeAtPoints(t,e,i,s,r,n,o,a,l,h,c=0,u=1,d){this.projectLine(t,i,s);let{length:f,dimensions:p,lineLength:g}=this;const m=g[f/p-1];let v=c*m,x=u*m;if(this.collisions)return this.placeCached(d,i,s);const y=r&&[];let _=!0===e;const b="number"==typeof e?e:null;_&&2==p&&(_=null);let w,M=0;for(let t=0,e=this.pixels;t<f;t+=p){let c,u=e[t],m=e[t+1],T=_?e[t+2]:b,S=t/p;if(w=M,M=g[S+1],v){if(!(v<M))continue;{const i=(v-w)/(M-w),s=t+p,r=e[s],n=e[s+1],o=_?e[s+2]:b;u+=(r-u)*i,m+=(n-m)*i,null!=T&&(T+=(o-T)*i),v==x&&(f=null,x=null),v=null}}if(x&&x&&w>x){const i=(x-w)/(w-g[S-1]),s=t-p,r=e[s],n=e[s+1],o=_?e[s+2]:b;u-=(r-u)*i,m-=(n-m)*i,null!=T&&(T-=(o-T)*i),f=null}if(u>=0&&m>=0&&u<s&&m<s){let t;y&&(t=this.getDistanceGrp(),t&&!t.hasSpace(u,m)||(c=r.insert(u,m,T,l,h,o,a,i,s,n),c&&y.push(c))),y&&!c||(d(u,m,T,0,0,c),null==t||t.add(u,m))}}(null==y?void 0:y.length)&&(this.collisions=y)}placeAlongLine(t,e,i,s,r,n,o,a,l,h,c,u,d,f){if(this.collisions)return this.placeCached(f,t,e,l);let{length:p,dimensions:g,lineLength:m}=this;const v=m[p/g-1];let x=u*v,y=d*v;const _=this.dimensions,b=i&&[],w=this.length/_;let M=this.pixels,T=0,S=Math.pow(2*r+o,2),A=Math.floor(w/2)-1,L=ns.MID_TO_END,z=!1,P=!0===c;const C="number"==typeof c?c:null;let E="number"==typeof c?c:null;P&&2==g&&(P=null);for(let c=1;c<w;c++){if(A+c===w){if(z)break;L=ns.MID_TO_START,A=w}let u=(A+L*c)%w;const d=u-1,p=m[d],g=m[u],v=d*_;let I=M[v],R=M[v+1],k=P?M[v+2]:C;const F=u*_;let D=M[F],U=M[F+1],O=P?M[F+2]:C;if(x){if(!(x<g))continue;if(x>=p){const t=(x-p)/(g-p);I+=(D-I)*t,R+=(U-R)*t,k+=(O-k)*t,L==ns.MID_TO_END?z=!0:c=1/0}}if(y){if(!(y>p)){L==ns.MID_TO_END&&(c=w-A-1);continue}if(y<=g){const t=1-(y-p)/(g-p);D-=(D-I)*t,U-=(U-R)*t,O-=(O-k)*t,L==ns.MID_TO_END&&(c=w-A-1)}}const B=D-I,H=U-R,G=I+.5*B,N=R+.5*H;if(G>=0&&N>=0&&G<e&&N<e){let c=h?B*B+H*H:1/0;if(c>S){if(P){const t=O-k;E=k+.5*t,T=Math.asin(t/Math.sqrt(B*B+H*H+t*t))}let h,u,d=Math.atan2(H,B);if(b&&(u=this.getDistanceGrp(),!u||u.hasSpace(G,N))){let u=r,f=n;if(l&&d&&(u||f)){const t=Math.sin(d),e=Math.cos(d);u=e*r-t*n,f=t*r+e*n}const p=Math.sqrt(S/c),g=[B*p,H*p];h=i.insert(G,N,E,u,f,o/2,a/2,t,e,s,g),h&&(this.alpha[b.length]=d*rs,b.push(h))}b&&!h||(f(G,N,E,l?d*rs:0,T,h),null==u||u.add(G,N))}}}(null==b?void 0:b.length)&&(this.collisions=b)}}const as={Center:{x:.5,y:0},Left:{x:0,y:0},Right:{x:1,y:0},Top:{x:.5,y:-1},TopLeft:{x:0,y:-1},TopRight:{x:1,y:-1},Bottom:{x:.5,y:1},BottomLeft:{x:0,y:1},BottomRight:{x:1,y:1}};class ls extends me{constructor(t=!0,e,i){super(t),this.normalizePosition=32768/e,this.addUniform("u_normalizePosition",1/this.normalizePosition),this.flexAttributes={a_position:{data:new ge(Uint16Array),size:t?2:3},a_point:{data:new ge(Int16Array),size:i?3:2},a_texcoord:{data:new ge(Uint16Array),size:2}},this.first=0}addText(t,e,i,s,r,n,o,a){const{flexAttributes:l}=this;((t,e,i,s,r,n,o,a,l,h=0,c,u="Center",d)=>{const f=r.length-1,p=l.lineHeight,g=as[u]||as.Center;let m=l.baselineOffset+.5*p*(f+r.length*g.y);m*=ae;const v=void 0===d?1:Number(!d);t=t*s<<1|v,e=e*s<<1|v,h=Math.round(1024*h/360);const x=null!==i;let y=2,_=null==c?2:3;x&&(i=Math.round(i/9e3*65535),y=3);let b=o.length/y;for(let s of r){const r=ue(s,l,n,a,h,c),u=r.count*y,d=r.width*g.x*ae;o.reserve(u);for(let s=n.data,r=o.data,a=b+u/y;b<a;b++)s[b*_]-=d,s[b*_+1]-=m,r[b*y]=t,r[b*y+1]=e,x&&(r[b*y+2]=i);o.length+=u,m-=p*ae}})(t,e,i,this.normalizePosition,s,l.a_point.data,l.a_position.data,l.a_texcoord.data,r,n,o,a)}}class hs extends di{constructor(t=!0,e){super(t,e),this.flexAttributes={a_position:{data:new ge(Uint16Array),size:t?2:3},a_size:{data:new ge(Uint8Array),size:2},a_texcoord:{data:new ge(Uint16Array),size:2}},this.first=0}addIcon(t,e,i,s,r,n,o,a){const{normalizePosition:l,flexAttributes:h}=this;((t,e,i,s,r,n,o,a,l,h,c=0)=>{let{u1:u,u2:d,v1:f,v2:p}=r;c=Math.round(511*c/360),li(t,e,i,s,l,c>>8&1);const g=c>>4&15,m=15&c,v=4095/(r.atlasWidth-1),x=4095/(r.atlasHeight-1);u*=v,d*=v,f*=x,p*=x,d>4095&&(d=4095),p>4095&&(p=4095),u=u<<4|m,d=d<<4|m,f=f<<4|g,p=p<<4|g,a.push(n,o,n,o,n,o,n,o,n,o,n,o),h.push(u,p,u,f,d,f,u,p,d,f,d,p)})(t,e,i,l,s,r,n,h.a_size.data,h.a_position.data,h.a_texcoord.data,o)}}class cs extends me{constructor(t=!0,e=!0){super(t,e),this.flexAttributes={a_position:{data:new ge(Float32Array),size:t?2:3}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,s,r){var n;const{attributes:o}=t,a=o.a_position.data,l=o.a_position.size,h=r.origin,c=r.direction,u=[0,0,0],d=[0,0,0],f=[0,0,0];let p=null;for(let r of t.groups){const o=null===(n=r.index)||void 0===n?void 0:n.data;let g=null;if(r.mode!=Yt.MODE_GL_LINES){for(let t=0;t<o.length;t+=3){const r=o[t]*l,n=o[t+1]*l,p=o[t+2]*l;u[0]=i+a[r],u[1]=s+a[r+1],d[0]=i+a[n],d[1]=s+a[n+1],f[0]=i+a[p],f[1]=s+a[p+1],3==l&&(u[2]=a[r+2],d[2]=a[n+2],f[2]=a[p+2]);const m=De.rayIntersectsTriangle(h,c,u,d,f);m&&m<e.z&&(g=r,e.z=m)}if(null!=g)for(let e=0,{idOffsets:i}=t,{length:s}=i;e<s;e+=2)if(g<i[e]){p=i[e+1];break}}}return p}}class us extends cs{constructor(){super(!1,!1),this.flexAttributes.a_normal={data:new ge(Int8Array),size:2,normalized:!0},this.light="defaultLight"}}const ds=new Map;let fs;[[fs,fs,fs],[fs,fs,65154],[fs,fs,65156],[fs,fs,65158],[fs,fs,65160],[65163,65164,65162],[fs,fs,65166],[65169,65170,65168],[fs,fs,65172],[65175,65176,65174],[65179,65180,65178],[65183,65184,65182],[65187,65188,65186],[65191,65192,65190],[fs,fs,65194],[fs,fs,65196],[fs,fs,65198],[fs,fs,65200],[65203,65204,65202],[65207,65208,65206],[65211,65212,65210],[65215,65216,65214],[65219,65220,65218],[65223,65224,65222],[65227,65228,65226],[65231,65232,65230],fs,fs,fs,fs,fs,[1600,1600,1600],[65235,65236,65234],[65239,65240,65238],[65243,65244,65242],[65247,65248,65246],[65251,65252,65250],[65255,65256,65254],[65259,65260,65258],[fs,fs,65262],[fs,fs,65264],[65267,65268,65266]].forEach(((t,e)=>{ds.set(1569+e,t&&{initial:t[0],medial:t[1],final:t[2]})})),ds.set(1662,{initial:64344,medial:64345,final:64343}),ds.set(1740,{initial:64510,medial:64511,final:64509}),ds.set(1670,{initial:64380,medial:64381,final:64379}),ds.set(1705,{initial:64400,medial:64401,final:64399}),ds.set(1711,{initial:64404,medial:64405,final:64403}),ds.set(1688,{final:64395});const ps=new Set([1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]),gs={1570:{isolated:65269,final:65270},1571:{isolated:65271,final:65272},1573:{isolated:65273,final:65274},1575:{isolated:65275,final:65276}},ms=(t,e,i)=>{const s=i>0?t.length-e:e+1;for(let r,n=1;n<s;n++)if(r=t.charCodeAt(e+i*n),!ps.has(r))return{cp:r,map:ds.get(r)}},vs=t=>{var e;if(!(t=>/[\u0600-\u06FF]/.test(t))(t))return t;let i="";for(let s=0;s<t.length;++s){let r=t.charCodeAt(s);if(ds.has(r)){let i=null===(e=ms(t,s,-1))||void 0===e?void 0:e.map;!i||i.initial||i.medial||(i=fs);let n,o=ms(t,s,1),a=null==o?void 0:o.map;if(!a||a.medial||a.final||(a=fs),n=1604==r&&gs[null==o?void 0:o.cp])r=i?n.final:n.isolated,s++;else{const t=ds.get(r);i&&a&&t.medial?r=t.medial:i&&t.final?r=t.final:a&&t.initial&&(r=t.initial)}}i+=String.fromCharCode(r)}return i};class xs extends cs{constructor(t=!1,e=!0){super(t,e),this._flat=!1}rayIntersects(t,e,i,s,r){return null}}const ys=(t,e,i,s)=>{if(s){let r=t.buffer;r||(r=t.buffer=new xs,r.setRequiresHeightMap("terrain"===s));const n=r.flexAttributes.a_position.data;return r.requiresHeightMap&&(s=1),n.push(e,i,0,e,i,s),n.length}},_s=32,bs=.03125;class ws extends di{constructor(t=!0){super(t),this._flat=!1,this.flexAttributes.a_point={data:new ge(Uint16Array),size:3},this.flexAttributes.a_normal={data:new ge(Int8Array),normalized:!0,size:3},this.light="defaultLight"}static getVertexZ(t,e,i){const{tileSize:s,size:r}=t,n=r-1;e=e/s*n,i=i/s*n;return t.data[Math.round(i)*r+Math.round(e)]}rayIntersects(t,e,i,s,r){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=n.a_point.data,[h,c,u]=r.getInverseWorldScale(t.renderScale),d=t.getUniform("u_scaleByAltitude");let f=null;const p=6*a*6;let[g,m,v]=ui(t,r.scale);const{sMat:x}=r,y=x[3],_=x[7],b=x[11],w=x[15];g*=h,m*=c,v*=u;const M=t.getHeightMap();for(let t=0,{length:n}=o;t<n;t+=p){const n=i+o[t]*bs+g,p=s+o[t+1]*bs+m;let x=(M?ws.getVertexZ(M,n,p):2===a?0:hi(o[t+2]))+v;const T=.5*(1+(d?0:x*b/(y*n+_*p+w))),S=(l[t]>>1)*h*T,A=(l[t+1]>>1)*c*T,L=(l[t+2]>>1)*u*T,z=r.intersectAABBox(n-S,p-A,x-L,n+S,p+A,x+L);null!=z&&z<e.z&&(e.z=z,f=t)}if(null!=f)return t.idOffsets[Math.floor(f/p)]}}const Ms=(t,e,i)=>{const s=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],o=i[0]-t[0],a=i[1]-t[1],l=i[2]-t[2];return[Math.floor(127*(r*l-n*a)),Math.floor(127*(n*o-s*l)),Math.floor(127*(s*a-r*o))]};let Ts;const Ss=(t,e,i,s,r,n)=>{Ts=Ts||((t=8,e=6,i=0,s=2*Math.PI,r=0,n=Math.PI,o=1)=>{const a=Math.min(r+n,Math.PI),l=[],h=[],c=[];let u=0;for(let a=0;a<=e;a++){const h=[],d=a/e;for(let e=0;e<=t;e++){const a=e/t,l=Math.sin(r+d*n);c.push(-Math.cos(i+a*s)*l*o,Math.cos(r+d*n)*o,-Math.sin(i+a*s)*l*o),h.push(u++)}l.push(h)}const d=[];for(let i=0;i<e;i++)for(let s=0;s<t;s++){const t=l[i][s+1],n=l[i][s],o=l[i+1][s],u=l[i+1][s+1];if(0!==i||r>0){h.push(t,n,u);const e=c.slice(3*t,3*t+3),i=c.slice(3*n,3*n+3),s=c.slice(3*u,3*u+3),r=Ms(e,i,s);d.push.apply(d,r),d.push.apply(d,r),d.push.apply(d,r)}if(i!==e-1||a<Math.PI){h.push(n,o,u);const t=c.slice(3*n,3*n+3),e=c.slice(3*o,3*o+3),i=c.slice(3*u,3*u+3),s=Ms(t,e,i);d.push.apply(d,s),d.push.apply(d,s),d.push.apply(d,s)}}let f=[];for(let t of h)f.push(127+Math.floor(127*c[3*t]),127+Math.floor(127*c[3*t+1]),127+Math.floor(127*c[3*t+2]));return{normals:f,surfaceNormals:d}})(16,12),t*=_s,e*=_s;const o="number"==typeof i;i=o&&Math.round(i/9e3*65535);const{normals:a,surfaceNormals:l}=Ts;for(let h=0,c=a.length;h<c;h+=3)o?s.push(t,e,i):s.push(t,e),r.push(a[h],a[h+1],a[h+2]),null==n||n.push(l[h],l[h+1],l[h+2])},As=.03125;class Ls extends ws{constructor(t){super(t),this.cullFace=1029,this.flexAttributes.a_point={normalized:!0,data:new ge(Uint8Array),size:3}}rayIntersects(t,e,i,s,r){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=t.getUniform("u_scaleByAltitude"),[h,c,u]=r.getInverseWorldScale(t.renderScale),d=t.uniforms.u_radius[0],f=d*h,p=d*c,g=d*u,{sMat:m}=r,v=m[3],x=m[7],y=m[11],_=m[15],b=1056*a,w=[0,0,0],M=[0,0,0];let T=null,[S,A,L]=ui(t,r.scale);S*=h,A*=c,L*=u;for(let t=0,{length:n}=o;t<n;t+=b){const n=i+o[t]*As+S,h=s+o[t+1]*As+A,c=(3==a?hi(o[t+2]):0)+L,u=1+(l?0:c*y/(v*n+x*h+_));w[0]=n,w[1]=h,w[2]=c,M[0]=f*u,M[1]=p*u,M[2]=g*u;const d=r.intersectEllipsoid(w,M);null!=d&&d<e.z&&(e.z=d,T=t)}if(null!=T)return t.idOffsets[Math.floor(T/b)]}}function zs(){var t=new xe(9);return xe!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Ps(){var t=new xe(4);return xe!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}ye(),_e(1,0,0),_e(0,1,0),Ps(),Ps(),zs();var Cs,Es=e.Color.toRGB;!function(t){t[t.bbox=0]="bbox",t[t.geometry=1]="geometry"}(Cs||(Cs={}));const Is=[1,1,1,1],Rs=180/Math.PI;class ks extends me{constructor(t,e,i,s){super(!1),this.defaultOrientationMatrix=new Float32Array([1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1]),this.hitTest=Cs.bbox,this.flexAttributes={};const{flexAttributes:r}=this;ks.init(t,r),(null==t?void 0:t.index)&&(this._index=t.index),r.a_modelMatrix=i||{data:new ge(Float32Array),size:16,instanced:!0},r.a_offset=s||{data:new ge(Float32Array),size:3,instanced:!0},this.uniforms=Object.assign({},e),this.light="defaultLight"}static calcBBox(t){const{position:e}=t;let i=1/0,s=-i,r=i,n=s,o=i,a=s;for(let t=0,{length:l}=e;t<l;t+=3){const l=e[t],h=e[t+1],c=e[t+2];l<i?i=l:l>s&&(s=l),h<r?r=h:h>n&&(n=h),c<o?o=c:c>a&&(a=c)}return[i,r,o,s,n,a]}static init(t,e={}){var i;if(t){const{position:s,color:r,uv:n}=t;let o,a=Is;e.a_position={data:ks.createFlexArray(s),size:3};const l=null!==(i=t.normal)&&void 0!==i?i:t.normal=Yt.computeNormals(s,t.index);if(l&&(e.a_normal={data:ks.createFlexArray(l),size:3,normalized:l instanceof Int8Array||l instanceof Int16Array}),n&&(e.a_uv={data:ks.createFlexArray(n),size:2}),n&&l){const i=function(t,e,i){const s=new Float32Array(t.length),r=new Float32Array(3),n=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),l=new Float32Array(3),h=new Float32Array(3),c=(null==i?void 0:i.length)||t.length/3;for(let u=0;u<c;u+=3){let c=u,d=u+1,f=u+2;i&&(c=i[c],d=i[d],f=i[f]);const p=3*c,g=3*d,m=3*f,v=2*c,x=2*d,y=2*f;r[0]=t[p],r[1]=t[p+1],r[2]=t[p+2],n[0]=t[g],n[1]=t[g+1],n[2]=t[g+2],o[0]=t[m],o[1]=t[m+1],o[2]=t[m+2],a[0]=e[v],a[1]=e[v+1],a[2]=e[v+2],l[0]=e[x],l[1]=e[x+1],l[2]=e[x+2],h[0]=e[y],h[1]=e[y+1],h[2]=e[y+2];const _=we(n,n,r),b=we(o,o,r),w=we(l,l,a),M=we(h,h,a),T=1/(w[0]*M[1]-M[0]*w[1]),S=r;Number.isFinite(T)?Te(S,Me(S,we(S,Me(_,_,M[1]),Me(b,b,w[1])),T)):(S[0]=1,S[1]=0,S[2]=0),s[p]=s[g]=s[m]=S[0],s[p+1]=s[g+1]=s[m+1]=S[1],s[p+2]=s[g+2]=s[m+2]=S[2]}return s}(s,n,t.index);e.a_tangent={data:ks.createFlexArray(i),size:3}}else e.a_tangent={value:[1,0,0]};if(r)if(Nt(r)||Array.isArray(r)){const t=s.length/3;if(r.length==4*t)a=r,o=4;else if(r.length==3*t){o=4,a=new Uint8Array(4*t);const e=r;for(let t=0;t<e.length;t+=3){let i=t/3*4;a[i]=255*e[t],a[i+1]=255*e[t+1],a[i+2]=255*e[t+2],a[i+3]=255}}}else a=Es(r);e.a_color=o?{data:new ge(a),size:o,normalized:!0}:{value:a}}return e}static createFlexArray(t){return new ge(Nt(t)?t:new Float32Array(t))}addInstance(t,e,i,s=[1,1,1],r=[0,0,0],n=[0,0,0],o){this.instances++,this.flexAttributes.a_offset.data.push(t,e,i);let a=function(t,e,i,s){var r=.5*Math.PI/180;e*=r,i*=r,s*=r;var n=Math.sin(e),o=Math.cos(e),a=Math.sin(i),l=Math.cos(i),h=Math.sin(s),c=Math.cos(s);return t[0]=n*l*c-o*a*h,t[1]=o*a*c+n*l*h,t[2]=o*l*h-n*a*c,t[3]=o*l*c+n*a*h,t}(Ps(),n[0]*Rs,n[1]*Rs,n[2]*Rs),l=function(t,e,i,s){var r=e[0],n=e[1],o=e[2],a=e[3],l=r+r,h=n+n,c=o+o,u=r*l,d=r*h,f=r*c,p=n*h,g=n*c,m=o*c,v=a*l,x=a*h,y=a*c,_=s[0],b=s[1],w=s[2];return t[0]=(1-(p+m))*_,t[1]=(d+y)*_,t[2]=(f-x)*_,t[3]=0,t[4]=(d-y)*b,t[5]=(1-(u+m))*b,t[6]=(g+v)*b,t[7]=0,t[8]=(f+x)*w,t[9]=(g-v)*w,t[10]=(1-(u+p))*w,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}(ze(),a,r,s);const h=this.defaultOrientationMatrix.slice();var c,u,d,f,p,g,m,v,x,y,_,b,w,M,T,S,A,L,z,P,C,E,I,R,k,F,D,U,O,B,H;l=Ee(h,h,l),this.uniforms.u_normalMatrix=(c=zs(),d=(u=l)[0],f=u[1],p=u[2],g=u[3],m=u[4],v=u[5],x=u[6],y=u[7],_=u[8],b=u[9],w=u[10],M=u[11],T=u[12],S=u[13],A=u[14],L=u[15],(H=(z=d*v-f*m)*(B=w*L-M*A)-(P=d*x-p*m)*(O=b*L-M*S)+(C=d*y-g*m)*(U=b*A-w*S)+(E=f*x-p*v)*(D=_*L-M*T)-(I=f*y-g*v)*(F=_*A-w*T)+(R=p*y-g*x)*(k=_*S-b*T))?(H=1/H,c[0]=(v*B-x*O+y*U)*H,c[1]=(x*D-m*B-y*F)*H,c[2]=(m*O-v*D+y*k)*H,c[3]=(p*O-f*B-g*U)*H,c[4]=(d*B-p*D+g*F)*H,c[5]=(f*D-d*O-g*k)*H,c[6]=(S*R-A*I+L*E)*H,c[7]=(A*C-T*R-L*P)*H,c[8]=(T*I-S*C+L*z)*H,c):null);const G=this.flexAttributes.a_modelMatrix.data;G.set(l,G.length)}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_modelMatrix.data.length,t)}rayIntersects(t,e,i,s,r){var n;const{attributes:o}=t,a=o.a_position,l=o.a_modelMatrix.data,h=o.a_offset.data,c=a.data,u=a.size,d=r.origin,f=r.direction,p=[0,0,0],g=[0,0,0],m=[0,0,0];let v=null;for(let r=0,o=0,{length:a}=l;r<a;r+=16,o+=3){const a=l.subarray(r,r+16),x=a[r],y=a[r+5],_=a[r+10],b=a[r+12]+h[o],w=a[r+13]+h[o+1],M=a[r+14]+h[o+2];for(let o of t.groups){const t=null===(n=o.index)||void 0===n?void 0:n.data;if(o.mode!=Yt.MODE_GL_LINES)for(let n=0;n<t.length;n+=3){const o=t[n]*u,a=t[n+1]*u,l=t[n+2]*u,h=c[o]*x,T=c[o+1]*y;p[0]=i+h+b,p[1]=s+T+w;const S=c[a]*x,A=c[a+1]*y;g[0]=i+S+b,g[1]=s+A+w;const L=c[l]*x,z=c[l+1]*y;m[0]=i+L+b,m[1]=s+z+w,3==u&&(p[2]=c[o+2]*_+M,g[2]=c[a+2]*_+M,m[2]=c[l+2]*_+M);const P=De.rayIntersectsTriangle(d,f,p,g,m);P&&P<e.z&&(v=r,e.z=P)}}}if(null!=v)for(let e=0,{idOffsets:i}=t,{length:s}=i;e<s;e+=2)if(v<i[e])return i[e+1]}generateWireframeIndices(){const t=this.index(),e=new Set,i=[];for(let s=0;s<t.length;s+=3){const r=t[s],n=t[s+1],o=t[s+2],a=[[r,n],[n,o],[o,r]];for(const[t,s]of a){const r=t<s?`${t};${s}`:`${s};${t}`;e.has(r)||(e.add(r),i.push(t,s))}}return new(t instanceof Uint32Array?Uint32Array:Uint16Array)(i)}}class Fs{constructor(t){this.cnt=0,this.callbacks={};const e=t.toString(),i=e.indexOf("{")+1,s=e.lastIndexOf("}"),r=e.substring(i,s).trim();let n="",o=null,a=0;r.split("").some(((t,e)=>{if("{"==t&&a++,"}"==t&&a--,!a&&"return"===r.slice(e,e+6))return o=r.slice(e+6).trim().replace(/;?\s*$/,""),!0;n+=t})),this.workerStr=n.trim()+`;self.__main=${o}`}async main(t){this.init();const e=this.cnt++;return this.worker.postMessage({args:t,id:e,method:"__main"}),new Promise(((t,i)=>{this.callbacks[e]=[t,i]}))}init(){if(!this.worker){const t=URL.createObjectURL(new Blob([this.workerStr,"\nself.onmessage = async ({data}) => {try{\n    const {message,transfer} = await self[data.method](data.args);\n        self.postMessage({result: message, id: data.id}, transfer);\n    }catch(error){self.postMessage({error, id: data.id})}\n};"],{type:"text/javascript"}));this.worker=new Worker(t),URL.revokeObjectURL(t),delete this.workerStr,this.worker.onmessage=({data:t})=>{const{result:e,error:i,id:s}=t;let[r,n]=this.callbacks[s];delete this.callbacks[s],i?n(i):r(e)}}return this.worker}destroy(){var t;null===(t=this.worker)||void 0===t||t.terminate(),this.worker=null,this.callbacks=null}}const Ds=function(){const t="default",e=t=>{const[,e,i]=/^(\w+)\s+(.*?)\s*(?:#.*)?$/.exec(t);return[e,i]},i={Ka:"ambient",Kd:"diffuse",Ks:"specular",Ke:"emissive",Ns:"shininess",map_Kd:"diffuseMap",map_Ns:"specularMap",map_Bump:"normalMap",d:"opacity",illum:"illumination"},s=async s=>(async()=>{let r;const n=await fetch(s),o=await n.text(),{geometries:a,mtlLibs:l,faces:h}=(i=>{const s=[[],[],[],[]],[r,n,o,a]=s,l=[],h=[],c=[];let u,d=[t],f={material:t,geometryIndex:0},p=t,g=[[],[],[],[]];const m=()=>{(null==u?void 0:u.position.length)&&(u=void 0)},v=(t,e)=>{const i=t.split("/");for(let t=0;t<i.length;t++){const r=s[t];let n=parseInt(i[t]);isNaN(n)||(n+=n<0?r.length:-1,g[t].push(...r[n]),!t&&e&&u.color.push(...e[n]))}},x=t=>t.map(parseFloat),y=i.split("\n");for(let t=0;t<y.length;t++){const i=y[t].trim();if(""===i||i.startsWith("#"))continue;const[s,_]=e(i);let b=_.split(/\s+/);switch(s){case"v":b.length>3&&(a.push(x(b.slice(3))),b=b.slice(0,3)),r.push(x(b));break;case"vn":o.push(x(b));break;case"vt":n.push(x(b));break;case"f":u||(g=[[],[],[],[]],u={position:g[0],uv:g[1],normal:g[2],color:g[3],object:p,groups:d},f.geometryIndex=h.length,c.push(f),f={geometryIndex:0,material:"default"},h.push(u));const t=a.length>1?a:null;for(let e=0,i=b.length-2;e<i;++e)v(b[0],t),v(b[e+1],t),v(b[e+2],t);break;case"mtllib":l.push(_);break;case"usemtl":f.material=_,m();break;case"g":d=b,m();break;case"o":p=_,m()}}return{faces:c,geometries:h,mtlLibs:l}})(o),c=new URL(s,location.href),u=await Promise.all(l.map((async t=>{let e=await fetch(new URL(t,c).href);if(200==e.status)return await e.text()}))),d=(t=>{let s={};const r={},n=t.split("\n");for(let t=0;t<n.length;t++){const o=n[t].trim();if(""===o||o.startsWith("#"))continue;const[a,l]=e(o),h=l.split(/\s+/);switch(a){case"newmtl":s={},r[l]=s;break;case"d":case"Ns":case"illum":s[i[a]]=parseFloat(h[0]);break;case"Ka":case"Kd":case"Ks":case"Ke":s[i[a]]=h.map(parseFloat);break;case"map_Kd":case"map_Ns":case"map_Bump":s[i[a]]=l}}return r})(u.join("\n"));return r={geometries:a,materials:d,faces:h},r.textures=await(async(t,e)=>{const i={},s=[];for(let r in t){const n=t[r];for(let t in n)if(t.endsWith("Map")){const r=n[t];s.push((async()=>{const t=await fetch(new URL(r,e).href);if(t.status>=400)return;const s=await t.blob(),n=await createImageBitmap(s,{imageOrientation:"flipY",premultiplyAlpha:"none",colorSpaceConversion:"none"});return i[r]=n,n})())}}return await Promise.all(s),i})(d,c),r})();return async({url:t})=>{let e;try{e=await s(t)}catch(t){return{error:t}}let i=[];for(let t of e.geometries)for(let e of["position","uv","normal","color"])t[e]&&(t[e].length?(t[e]=new Float32Array(t[e]),i.push(t[e].buffer)):delete t[e]);for(let t in e.textures)i.push(e.textures[t]);return{message:e,transfer:i}}};class Us extends Fs{constructor(){super(Ds),this.inProgress={}}async load(t){var e;return(e=this.inProgress)[t]||(e[t]=(async()=>{const e=new URL(t,window.top.location.href),i=await this.main({url:e.href});return delete this.inProgress[t],i})())}}class Os extends Gt{constructor(){super(...arguments),this.ref=0}}class Bs{constructor(t){this.models={};const e=new Os(t,{width:1,height:1,data:new Uint8Array([255,255,255,255])});e.ref=1/0,this.unusedTexture=e;const i=new Os(t,{width:1,height:1,data:new Uint8Array([127,127,255,255])});i.ref=1/0,this.unusedNormalTexture=i,this.gl=t,this.onBufferDestroyed=t=>{0===t.attributes.a_position.ref&&delete this.models[t.id]},this.objParser=new Us}destroy(){this.objParser.destroy()}isValid(t){var e,i;return!(!(null===(e=null==t?void 0:t.faces)||void 0===e?void 0:e.length)||!(null===(i=t.geometries)||void 0===i?void 0:i[t.faces[0].geometryIndex]))}async loadObj(t){const e=await this.objParser.load(t);return this.initModel(t,e)}initTexture(t,e,i,s){let r=i[t];return r||(r=new Os(this.gl,e,s),i[t]=r),r}getModel(t){return this.models[t]}initModel(t,e){var i;if(null!=this.models[t])return this.models[t];if(this.isValid(e)){const{geometries:s,materials:r,faces:n}=e,o=new WeakMap,a=e.textures||{},l=[],h={unusedTexture:this.unusedTexture,unusedNormalTexture:this.unusedNormalTexture};for(let t of n){const e=s[t.geometryIndex];if(!e)continue;const n=Object.assign({diffuse:[1,1,1],diffuseMap:"unusedTexture",opacity:1,illumination:1,ambient:[1,1,1],specular:[1,1,1],specularMap:"unusedTexture",shininess:0,normalMap:"unusedNormalTexture",useUVMapping:!0},null==r?void 0:r[t.material]);let c=o.get(e);const u=e.index;n.pointSize="Points"==n.mode?null!==(i=n.pointSize)&&void 0!==i?i:1:0,c||(c=ks.init(e));const d=e.bbox||(e.bbox=ks.calcBBox(e)),f=n;for(let t in n)if(t.endsWith("Map")){const e=f[t];let i=a[e],s=n.wrap,r=this.gl.REPEAT,o=this.gl.REPEAT;"string"==typeof s&&(s=[s,s]),Array.isArray(s)&&([r,o]=s.map((t=>"clamp"==t?this.gl.CLAMP_TO_EDGE:"mirror"==t?this.gl.MIRRORED_REPEAT:this.gl.REPEAT)));const l={flipY:n.flipY,wrapS:r,wrapT:o};f[t]=this.initTexture(e,i,h,l)}const p=f.diffuseMap;if(!f.useUVMapping&&p){const t=n.uvScale||1;f.u_textureSize=[p.width*t,p.height*t]}delete f.mode,delete f.flipY,l.push({attributes:c,bbox:d,uniforms:f,index:u,first:t.start,count:t.count})}this.models[t]={textures:h,parts:l}}else this.models[t]=!1;return this.models[t]}createModelBuffer(t,i,s,r,n,o=ks){const a=this.models[t];let l;if(a){l=new ai;let h,c,u,{parts:d}=a;for(let a=0;a<d.length;a++){let{attributes:f,bbox:p,uniforms:g,index:m,first:v,count:x}=d[a],y=new o(u,u,c,h);c=y.flexAttributes.a_modelMatrix,h=y.flexAttributes.a_offset;for(let t in f){let e=f[t];e.ref=(e.ref||0)+1,y.flexAttributes[t]=e}const _=y.uniforms;for(let t in g){let e=g[t];e instanceof Os&&e.ref++,_[t]=e}i&&(_.specular=e.vec3.add([],_.specular,i),_.shininess+=s),r&&(_.emissive?_.emissive=e.vec3.add([],_.emissive,r):_.emissive=r),m?y.setIndex(m):y.setArray(v||0,x),y.bbox=p,y.cullFace=n,y.id=t,l.set(a,y)}l.get(0).destroy=this.onBufferDestroyed}return l}addPosition(t,e,i,s,r,n,o,a){const{buffers:l}=t,[h]=l;h.addInstance(e,i,s,r,n,o,a);for(let t=1;t<l.length;t++)l[t].instances=h.instances,l[t].uniforms.u_normalMatrix=h.uniforms.u_normalMatrix}}class Hs extends ks{static getVertexZ(t,e,i){const{tileSize:s,size:r}=t,n=r-1;return e=e/s*n,i=i/s*n,t.data[Math.round(i)*r+Math.round(e)]}rayIntersects(t,e,i,s,r){var n;const{attributes:o}=t,a=o.a_position,l=o.a_modelMatrix.data,h=o.a_offset.data,c=a.data,u=a.size;let d=r.origin;d=[d[0]-i,d[1]-s,d[2]],i=0,s=0;const f=r.direction,p=[0,0,0],g=[0,0,0],m=[0,0,0];let v=null;const x=t.getHeightMap(),y=(null==x?void 0:x.skirtHeight)>0,_=8*c.BYTES_PER_ELEMENT,b=y?(1<<_-1)-1:(1<<_)-1,w=(t,e,r,n,o,a,l,h,d)=>{const f=(c[e]&b)*n,p=c[e+1]*o;t[0]=i+f+l,t[1]=s+p+h,t[2]=x?Hs.getVertexZ(x,f,p)*a+d:3===u?c[e+2]*a+d:0};for(let i=0,s=0,{length:r}=l;i<r;i+=16,s+=3){const r=l.subarray(i,i+16),o=r[i],a=r[i+5],c=r[i+10],x=r[i+12]+h[s],y=r[i+13]+h[s+1],_=r[i+14]+h[s+2];for(let s of t.groups){const t=null===(n=s.index)||void 0===n?void 0:n.data;if(s.mode!=Yt.MODE_GL_LINES)for(let s=0;s<t.length;s+=3){const r=t[s]*u,n=t[s+1]*u,l=t[s+2]*u;w(p,r,0,o,a,c,x,y,_),w(g,n,0,o,a,c,x,y,_),w(m,l,0,o,a,c,x,y,_);const h=De.rayIntersectsTriangle(d,f,p,g,m);h&&h<e.z&&(v=i,e.z=h)}}}if(null!=v)for(let e=0,{idOffsets:i}=t,{length:s}=i;e<s;e+=2)if(v<i[e])return i[e+1]}populateGeometryBuffer(t){super.populateGeometryBuffer(t),t.heightMap=this.heightMap}getHeightMapTexture(){return this.uniforms.uHeightMap}}const Gs=document.createElement("canvas"),Ns=Gs.getContext("2d");Gs.width=1,Gs.height=1;function Ws(){let t=this;const e=t._cbs,i=Math.max(t.width,t.height);if(t._cbs=null,!t.skipAutoScale&&i>64){const e=64/i;t=t._r[t.src]=((t,e)=>{const i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t.width*e,i.height=t.height*e,s.drawImage(t,0,0,i.width,i.height),i})(t,e)}else Ns.drawImage(t,0,0);t.ready=!0,t._r=null;for(let i in e)e[i][0](t,e[i][1])}class Zs{constructor(){this.imgData={},this.promises={}}isRequested(t){return!!this.imgData[t]}isReady(t){var e;return null===(e=this.imgData[t])||void 0===e?void 0:e.ready}get(t,e,i,s,r){let n=this.imgData;if(null==n[t]){let o=n[t]=new Image;o.ready=!1,o._cbs={},e&&(o._cbs[i]=[e,s]),o._r=n,o.crossOrigin="Anonymous",o.skipAutoScale=r,o.onload=Ws,o.src=t}else e&&(n[t].ready?e(n[t],s):n[t]._cbs[i]=[e,s]);return n[t]}}class Ys{constructor(t){this.loader=new Zs,this.textures=new Map,this.promises=new Map,this.gl=t,this.atlas=new es({gl:t,maxImgSize:64})}getTexture(t){const e=this.textures.get(t);return e.ref++,e}load(t,e){var i;const{loader:s,promises:r}=this;return null!==(i=this.textures.get(t))&&void 0!==i?i:r[t]||(r[t]=new Promise(((i,n)=>{s.get(t,(s=>{delete r[t];const n=new Gt(this.gl,s,e);n.ref=1/0,this.textures.set(t,n),i(n)}),"*",void 0,!0)})))}loadAtlas(t,e){const{atlas:i,loader:s,promises:r}=this;if(e){const i=this.textures.get(t);return i?new ts(0,e.x,e.x+e.width,e.y,e.y+e.height,i):this.load(t)}return i.get(t)||r[t]||(r[t]=new Promise(((e,n)=>{s.get(t,(s=>{delete r[t];let n=i.set(t,s);this.textures.set(t,i.texture),e(n)}))})))}destroy(){this.atlas.destroy()}}class Vs{constructor(t,e=256,i=1){this.gl=t,this.width=e,this.height=i}isGradient(t){return"string"==typeof(null==t?void 0:t.type)&&"object"==typeof t.stops}createTexture(t,e){const i=this.isGradient(t)?t.stops:t,s=Vs.canvas,r=Vs.ctx,{width:n,height:o}=this;s.width=n,s.height=o;const a=r.createLinearGradient(0,0,n,o),l=(null==e?void 0:e(i))||i;for(var h in l)a.addColorStop(Number(h),l[h]);r.fillStyle=a,r.fillRect(0,0,n,o);const c=r.getImageData(0,0,n,o).data;return new Xs(this.gl,{width:n,height:o,data:c},{premultiplyAlpha:!0})}}Vs.canvas=document.createElement("canvas"),Vs.ctx=Vs.canvas.getContext("2d");class Xs extends Gt{constructor(){super(...arguments),this.ref=0}destroy(){this.cache.delete(this.id),super.destroy()}}class js{constructor(t){this.textures=new Map,this.gradients=new Vs(t,256,1),this.gl=t}getFillTexture(t){const{gradients:i}=this;let s=this.textures.get(t);if(!s){if(i.isGradient(t))s=i.createTexture(t);else{const i=e.Color.toRGB(t,!0);s=new Xs(this.gl,{data:new Uint8Array(i.map((t=>255*t))),width:1,height:1})}this.addTexture(t,s)}return s.ref++,s}getGradientTexture(t,e){let i=this.textures.get(t);return i||(i=this.gradients.createTexture(t,e),this.addTexture(t,i)),i.ref++,i}addTexture(t,e){this.textures.set(t,e),e.id=t,e.cache=this.textures}removeTexture(t){const e=this.textures.get(t);e&&(e.destroy(),this.textures.delete(t))}clear(){for(const t of this.textures.values())t.destroy();this.textures.clear()}}const{toRGB:qs}=e.Color,$s="*";let Ks;const Qs=t=>t instanceof e.Expression,Js=e.ExpressionMode.dynamic,tr=["px","px"];class er{constructor(t,e,i){this.pendingCollisions=[],this.gl=t,this.atlasManager=new Ys(t),this.textureManager=new js(t),this.dpr=i,this.collisions=e,this.lineFactory=new os(t),this.modelFactory=new Bs(t);const s=262144,r=new Uint8Array(1048576);for(let t=0;t<s;t++)r[4*t]=255,r[4*t+1]=0,r[4*t+2]=0,r[4*t+3]=255}toRGBA(t,e=1,i=!0){const s=Array.isArray(t)?[t[0],t[1],t[2],"number"==typeof t[3]?t[3]:1]:qs(t);return s&&(e=s[3]*=e,i&&(s[0]*=e,s[1]*=e,s[2]*=e)),s||null}init(t,e,i,s,r,n){this.tile=t,this.groups=e,this.tileSize=i,this.z=s,this.zLayer=r,this.lineFactory.initTile(),this.pendingCollisions.length=0,this.waitAndRefresh=n}isModelStyle(t){return"Model"===t||"Terrain"===t}createPoint(t,e,i,s,r,n,o,a,l=0,h,c,u,d,f){var p;const m=null===r,v=this.z;let x,y,_;if(l=(l+360)%360,"Text"==t){e.buffer||(e.buffer=new ls(m,this.tileSize,h!=Ks),e.buffer.addUniform("u_texture",new pe(this.gl,e.shared)));const t=e.buffer.uniforms.u_texture,{flexAttributes:a}=e.buffer;t.addChars(c);const f=t.getAtlas();let b=null!==(p=U("lineWrap",n,o,v))&&void 0!==p?p:u;const w=g(c,b);x=a.a_position,y=x.data.length,_=y+t.bufferLength(c,m?2:3),e.buffer.addText(i,s,r,w,f,l,h,d)}else{if(this.isModelStyle(t)){let a,l=U("model",n,o,v);if(!l)return;if("string"==typeof l){if(a=l,l=this.modelFactory.getModel(a),l===Ks)return void(a.endsWith(".obj")&&this.waitAndRefresh(this.modelFactory.loadObj(a)))}else a=l.id||(l.id=Math.random()),l=this.modelFactory.initModel(a,l);if(!1===l)return;let h=e.buffer;const{rotate:c,cullFace:u}=n,d=U("transform",n,o,v),f=U("scale",n,o,v),p=U("translate",n,o,v);if(!e.buffer){let i;u&&(i="Front"==u?this.gl.BACK:this.gl.FRONT);const{shared:s}=e;if(h=e.buffer=this.modelFactory.createModelBuffer(a,s.specular,s.shininess,s.emissive,i,"Terrain"===t?Hs:ks),"Terrain"==t&&o.properties.useHeightMap){const t=h.get(0),e=o.properties.heightMap;t.heightMap={tileSize:this.tileSize,size:Math.sqrt(e.length),data:e,texture:t.getHeightMapTexture(),skirtHeight:o.properties.skirtHeight||0}}}this.modelFactory.addPosition(h,i,s,r,f,p,c,d)}else if("Icon"==t){e.buffer||(e.buffer=new hs(m,this.tileSize));const t=e.buffer,{flexAttributes:a}=t,h=U("src",n,o,v),c=U("width",n,o,v),u=U("height",n,o,v)||c,d=n.atlas,f=this.atlasManager.loadAtlas(h,d);if(f.then)return this.waitAndRefresh(f);x=a.a_position,t.addIcon(i,s,r,f,c,u,l),t.addUniform("u_texture",this.atlasManager.getTexture(h))}else if("Circle"==t||"Rect"==t){const t=e.buffer||(e.buffer=new di(m,this.tileSize));x=t.flexAttributes.a_position,t.addPoint(i,s,r)}else if("Heatmap"==t){const t=e.buffer||(e.buffer=new gi(m,this.tileSize)),r=U("weight",n,o,v);t.addPoint(i,s,r)}else if("Sphere"==t){const t=e.buffer||(e.buffer=new Ls(m)),{flexAttributes:n}=t;x=n.a_position,Ss(i,s,r,x.data,n.a_point.data,n.a_normal.data)}else{if("Box"!=t)return void(r>0&&"VerticalLine"==t&&ys(e,i,s,r));{let t=U("width",n,o,v),a=U("height",n,o,v)||t,l=U("depth",n,o,v)||t;const h=e.buffer||(e.buffer=new ws(m)),{flexAttributes:c}=h;x=c.a_position,((t,e,i,s,r,n,o,a,l)=>{if(t*=_s,e*=_s,"number"==typeof i){i=Math.round(i/9e3*65535),o.reserve(108);for(let s=0;s<36;s++)o.data[o.length++]=t,o.data[o.length++]=e,o.data[o.length++]=i}else{o.reserve(72);for(let i=0;i<36;i++)o.data[o.length++]=t,o.data[o.length++]=e}s<<=1,r<<=1,n<<=1,a.push(0|s,1|r,1|n,1|s,1|r,1|n,0|s,1|r,0|n,0|s,1|r,0|n,1|s,1|r,1|n,1|s,1|r,0|n,0|s,0|r,0|n,1|s,0|r,1|n,0|s,0|r,1|n,1|s,0|r,0|n,1|s,0|r,1|n,0|s,0|r,0|n,0|s,1|r,0|n,0|s,0|r,0|n,0|s,1|r,1|n,0|s,0|r,0|n,0|s,0|r,1|n,0|s,1|r,1|n,1|s,1|r,0|n,1|s,1|r,1|n,1|s,0|r,0|n,1|s,0|r,0|n,1|s,1|r,1|n,1|s,0|r,1|n,0|s,0|r,1|n,1|s,1|r,1|n,0|s,1|r,1|n,0|s,0|r,1|n,1|s,0|r,1|n,1|s,1|r,1|n,0|s,0|r,0|n,1|s,1|r,0|n,0|s,1|r,0|n,0|s,0|r,0|n,1|s,0|r,0|n,1|s,1|r,0|n),l&&l.push(0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1)})(i,s,r,t,a,l,x.data,c.a_point.data,c.a_normal.data)}}_=null==x?void 0:x.data.length,y=_-12}f&&e.buffer.setRequiresHeightMap(!0),e.buffer.setIdOffset(o.id),a&&x&&a.attrs.push({buffer:x,start:y,stop:_})}create(t,e,i,s,r,n,o,a,l=!0){var h,u,d;const{tile:f,groups:p,tileSize:g}=this,m=this.z;let v,x,y,_,b,w,M,T,S,A,L,z,P,C,E,I,R,k,D,B,H,G,N,Z,Y,V,X,j,q,$,K,Q,J,tt,et,it={};if(this.lineFactory.initFeature(m,g,null==a?void 0:a.id),o!==Ks||"Point"!==e||f.isInside(i)){for(let st=0,rt=s.length;st<rt;st++){if(_=s[st],w=U("type",_,t,m),!w)continue;if(M=U("opacity",_,t,m),0===M)continue;let rt,nt="Polygon"==e||U("collide",_,t,m);if(o==Ks&&("Text"==w&&!nt||!1===nt)){let e=U("collisionGroup",_,t,m)||"0",i=it[e];const s=W(_,t,m,this.dpr,null==i?void 0:i.bbox);if(s){i||(i=it[e]={id:e,bbox:null,priority:Number.MAX_SAFE_INTEGER,repeat:-Number.MAX_SAFE_INTEGER,styleGrp:[]}),i.bbox=s,i.styleGrp.push(_);const r=U("priority",_,t,m);r<i.priority&&(i.priority=r);const n=U("repeat",_,t,m);n<i.repeat&&(i.repeat=n),i.id+=`${w}${r||"?"}${n||"?"}`}continue}(M==Ks||M>=.98)&&(M=1),"Image"==w&&(w="Icon"),T=Ks,S=Ks,z=Ks,A=Ks,P=Ks,C=Ks,E=Ks,I=Ks,R=Ks,k=Ks,H=Ks,G=Ks,X=0,j=0,$=Ks,Q=Ks,K=r,J="px",tt=Ks;let ot,at,lt,ht,ct=l,ut=!1,dt=null,ft=!1,pt=1;L=0^U("rotation",_,t,m);let gt=U("altitude",_,t,m);if(this.isModelStyle(w))"Terrain"===w&&(dt=[t.properties.minHeight,t.properties.maxHeight]),(d=_).modelId||(d.modelId=Math.random()),Z=w.charAt(0)+_.modelId,ut=!0,ft=!0;else if("Icon"==w)Q=U("alignment",_,t,m)||"viewport",Z=(gt?"AI":"I")+(Q||""),ut=!0;else{let i;if(z=U("stroke",_,t,m),"Line"==w){if(!z)continue;if(C=U("strokeWidth",_,t,m,Js),!C)continue;Qs(C)?i=C.id():([C,J]=O(C),i=C),R=U("strokeLinecap",_,t,m)||"round",k=U("strokeLinejoin",_,t,m)||"round";const e=U("offset",_,t,m);if([X,tt]=O(e),Z=(gt?"AL":"L")+J+X+tt+R+k,E=U("strokeDasharray",_,t,m,Js),Qs(E))Z+=E.id(),E={pattern:E,units:tr};else if(Array.isArray(E)&&E[0]){let t=[],e=[];for(let i=0;i<E.length;i++){const[s,r]=O(E[i]);t[i]=s,e[i]=r,Z+=s+r}E={pattern:t,units:e}}else E=Ks;E&&(I=U("strokeDashimage",_,t,m),I&&(Z+=I.slice(-8)))}else if(C=U("strokeWidth",_,t,m),i=C,"VerticalLine"==w)q=U("offsetZ",_,t,m)||0,Z="VL"+z+q,[q,tt]=O(q),gt==Ks&&(gt=!0);else if(S=U("fill",_,t,m),"Polygon"==w){if(!S||"Polygon"!=e)continue;D=U("extrude",_,t,m),B=U("extrudeBase",_,t,m),ft=!0,D>0||B>0?(Z="E",w="Extrude"):Z="P"}else{if("Polygon"==e)continue;if(Q=U("alignment",_,t,m),"Text"==w){if($=F(_,t,m),!$)continue;$=vs($),T=U("font",_,t,m)||c,Q==Ks&&(Q="Point"==e?"viewport":"map"),Z="T"+(T||$s)}else if("Circle"==w){let e;H=G=U("radius",_,t,m,Js),Qs(H)?e=H.id||(H.id=H++):([H,J]=O(H),e=H),Z=(gt?"AC":"C")+J+e||$s}else if("Heatmap"==w){H=U("radius",_,t,m),[H,J]=O(H),A=S;const e=U("intensity",_,t,m);G=e,Z="H"+(H||$s)+JSON.stringify(S)+e}else if("Rect"==w)H=U("width",_,t,m),[H,J]=O(H),G=U("height",_,t,m),G=G?O(G)[0]:H,Z=(gt?"AR":"R")+L+J+H+G;else{if("Box"!=w&&"Sphere"!=w)continue;{"Box"==w?Z="B"+L:(H=G=U("radius",_,t,m),[H,J]=O(H),Z="S"+H);const e=U("pointerEvents",_,t,m);"boolean"==typeof e&&(ct=e),Z+=ct,Q="map",ft=!0}}ut=!0,Z+=Q||""}!A&&S&&(A=this.toRGBA(S,M)),z&&(P=this.toRGBA(z,M),"Text"==w&&(K=1),Qs(C)||("number"!=typeof C?C=1:(C*=K,C<0&&(C=1)))),Z+=(z||$s)+(i||$s)+(S||$s)}if(ut){X=U("offsetX",_,t,m),j=U("offsetY",_,t,m),q=U("offsetZ",_,t,m);const e=O(X);X=e[0];const i=O(j);j=i[0];const s=O(q);q=s[0],tt=[e[1],i[1],s[1]],Z+=X+(j<<8)+(q<<16)+tt[0]+tt[1]+tt[2]}ft&&(ht=U("light",_,t,m),ht&&(Z+=ht),ot=U("emissive",_,t,m),ot&&(Z+=ot,ot=this.toRGBA(ot).slice(0,3)),lt=U("specular",_,t,m),lt&&(at=null!==(h=U("shininess",_,t,m))&&void 0!==h?h:32,Z+=lt+at,lt=this.toRGBA(lt).slice(0,3)),pt=null!==(u=U("fillIntensity",_,t,m))&&void 0!==u?u:1),Z+=100*M^0,b=U("zIndex",_,t,m);let mt,vt=U("zLayer",_,t,m);vt==Ks&&(vt=this.zLayer),Z=vt+Z,gt&&(mt=U("depthTest",_,t,m),mt||(Z="ND"+Z));let xt=U("scaleByAltitude",_,t,m);if(xt=xt==Ks?"m"==J:!!xt,xt&&(Z+="SA"),N=p[b]=p[b]||{index:{},groups:[]},V=N.index[Z],V==Ks?(V=N.index[Z]=N.groups.length,Y=N.groups[V]={type:w,zLayer:vt,depthTest:mt,pointerEvents:ct,shared:{unit:J,font:T,fill:A,fillIntensity:pt,opacity:M,stroke:P,strokeWidth:C,strokeLinecap:R,strokeLinejoin:k,strokeDasharray:E,strokeDashimage:I,width:H,height:G,depth:rt,rotation:L,offsetX:X,offsetY:j,offsetZ:q,offsetUnit:tt,alignment:Q,modelMode:dt,scaleByAltitude:xt,emissive:ot,shininess:at,specular:lt,light:ht}}):Y=N.groups[V],"Point"==e){const e="terrain"===gt;if("VerticalLine"==w){if(e||"number"==typeof gt||i[2]>0){const t="number"==typeof gt?gt:i[2];if(t>0||e){const s=f.lon2x(i[0],g),r=f.lat2y(i[1],g);ys(Y,s,r,e?"terrain":t)}}}else{const s=f.lon2x(i[0],g),r=f.lat2y(i[1],g),n="number"==typeof gt?gt:e?null:gt?i[2]||0:null;if(a){if(et=this.collisions.insert(s,r,n,a.offsetX,a.offsetY,a.width,a.height,f,g,a.priority),!et)return;a=null}this.createPoint(w,Y,s,r,n,_,t,et,L,Ks,$,Ks,"Text"==w&&U("textAnchor",_,t,m),e)}}else if("LineString"==e)if("Line"==w){if(I){const t=this.atlasManager.load(I,{mipMaps:!1});if(t.then)return void this.waitAndRefresh(t)}this.lineFactory.createLine(i,Y,f,g,n,E,R,k,C,gt,X,U("from",_,t,m),U("to",_,t,m)),I&&Y.buffer.addUniform("u_dashTexture",this.atlasManager.getTexture(I)),Y.buffer.setIdOffset(t.id)}else{let e="Text"==w,s=U("anchor",_,t,m);null!=s||(s=e?"Line":"Coordinate");const r=e&&U("textAnchor",_,t,m),n=e?!nt:!1===nt;let l,h;const c=U("from",_,t,m),u=U("to",_,t,m);if("Line"==s){const e="map"==Q;if(a)l=2*a.width,h=2*a.height;else if("Icon"==w)l=U("width",_,t,m),h=U("height",_,t,m)||H;else if("Text"==w){Y.buffer||(Y.buffer=new ls(!0,this.tileSize,!0),Y.buffer.addUniform("u_texture",new pe(this.gl,_)));const t=Y.buffer.uniforms.u_texture.getAtlas();l=t.getTextWidth($),h=t.letterHeight}else l=H,h=G,"Circle"==w&&(l*=2,h*=2);let s=U("checkLineSpace",_,t,m);s==Ks&&(s=!0),this.lineFactory.placeAtSegments(i,gt,f,g,n&&this.collisions,o,U("repeat",_,t,m),X,j,l,h,e,s,c,u,((e,i,s,n,o,a)=>{this.createPoint(w,Y,e,i,s,_,t,a,n+L,o,$,!1,r)}))}else a?(l=a.width,h=a.height):(l=H/2,h=G/2),this.lineFactory.placeAtPoints(i,gt,f,g,n&&this.collisions,o,l,h,X,j,c,u,((e,i,s,n,o,a)=>{this.createPoint(w,Y,e,i,s,_,t,a,n+L,Ks,$,Ks,r)}))}else if("Polygon"==w||"Extrude"==w){Y.buffer||(Y.buffer="Polygon"==w?new cs(!gt):new us);const e=Y.buffer,s=e.index(),r=e.getPositionAttribute(),n=r.data;if(v=n.length,"Extrude"==w){let t;z&&(t=Y.extrudeStrokeIndex=Y.extrudeStrokeIndex||[]),x=Ai(n,Y.buffer.flexAttributes.a_normal.data,s,i,f,g,D,B,t)}else"Polygon"==w&&(x=Mi(n,i,f,g,3===r.size));if(Y.buffer.setIdOffset(t.id),!y){const e=t.geometry;if(e._xyz)y=e._xyz;else{y=[];for(let t of x){let e=t.dimensions,i=Li(n.data.subarray(t.start,t.stop),t.holes,e),s=(t.start-v)/e;for(let t of i)y.push(s+t)}f.clipped||(e._xyz=y)}}for(let t,i=0,r=v/x[0].dimensions;i<y.length;i++)t=r+y[i],e.i32=e.i32||t>65535,s.push(t)}}for(let s in it){const r=it[s],[n,o,a,l]=r.bbox,h=.5*(a-n),c=.5*(l-o);r.feature=t,r.geomType=e,r.coordinates=i,r.offsetX=n+h,r.offsetY=o+c,r.width=h,r.height=c,this.pendingCollisions.push(r)}}}destroy(){this.modelFactory.destroy()}}const ir={time:4,priority:3,init([t,e,i]){const s=t.projectCollisionsToScreen(e,null);return s.sort(((t,e)=>t.priority-e.priority)),{startTs:performance.now(),screenCollisionData:s,index:0,sorted:!1,updated:!1,processBatchSize:100,visibleMap:[],visibleViewport:[],collisionHandler:t,onDone:i}},exec(t){const{collisionHandler:e,screenCollisionData:i,visibleMap:s,visibleViewport:r,processBatchSize:n}=t,o=i;for(let i=t.index,a=o.length;i<a;){const a=o[i++],l=e.processCollision(a,s,r);if(t.updated||(t.updated=l),i%n==0)return t.index=i,!0}return!1},onDone(t){t.onDone(t.updated)}};class sr{constructor(t){this.tiles={},this.display=t,this.debug(!1),this.task=e.TaskManager.getInstance().create(ir)}getTileCache(t){var e,i;return(e=this.tiles)[i=0^t]||(e[i]=new Map)}debug(t){t?this.dbgLayers||setTimeout((()=>{const t=bo.getInstances().find((t=>t._display==this.display));this.dbgLayers=Array(2).fill(0).map((()=>new i.TileLayer({pointerEvents:!1,min:2,max:28,tileSize:512,provider:new i.LocalProvider({}),adaptiveGrid:!0,style:{zLayer:1e5,styleGroups:{box:[{zIndex:0,type:"Rect",strokeWidth:2,stroke:({properties:t})=>t.color,width:({properties:t})=>t.width,height:({properties:t})=>t.height,collide:!0}]},assign:()=>"box"}}))),this.dbgLayers.forEach((e=>{t.addLayer(e),this.display.layers.get(e).skipDbgGrid=!0}))}),0):this.dbgLayers&&this.dbgLayers.forEach((t=>t.getProvider().clear())),this.dbg=t}dbgBBoxes(t,e,s,r){const n=bo.getInstances().pop(),o="number"==typeof e;for(let a of t.boxes){let t,l,h=.5*(a.maxX-a.minX),c=.5*(a.maxY-a.minY);if(o)t=i.webMercator.x2lon(a.maxX-h,1),l=i.webMercator.y2lat(a.maxY-c,1),r||(r=256<<e),h*=r,c*=r;else{const i=n.pixelToGeo(a.minX+h,a.minY+c);t=i.longitude,l=i.latitude,s=e?"orange":"green"}this.dbgLayers[Number(!o)].addFeature({type:"Feature",geometry:{type:"Point",coordinates:[t,l]},properties:{color:s,width:2*h,height:2*c}})}}getTileCacheKey(t,e){return t}getLayerId(t){return String(t.layer.id||t.id)}intersects(t,e){const i=t.boxes;for(let t=0,s=e.length;t<s;++t){const s=e[t].boxes;for(let t=0,e=s.length;t<e;++t){const e=s[t];for(let t=0,s=i.length;t<s;++t){const s=i[t];if(s.minX<=e.maxX&&e.minX<=s.maxX&&s.minY<=e.maxY&&e.minY<=s.maxY)return!0}}}return!1}updateBBoxes(t,e,i,s,r,n,o,a){for(let l=0;l<=o;l++){let h=.75*(l/o-.5),c=i*h+t,u=s*h+e;a[l]={minX:c-r,maxX:c+r,minY:u-n,maxY:u+n}}}getTargetZoom(t,e){return t.length}initTile(t,e){let{quadkey:s,x:r,y:n,z:o}=t;const a=this.getTargetZoom(s,e),l=this.getTileCache(a);this.clearTile(s,e,a);const h={};for(let t=-1;t<2;t++)for(let e=-1;e<2;e++){let s=i.tileUtils.tileXYToQuadKey(o,n+t,r+e),a=l.get(s);if(a)for(let t in a)h[s]=a[t]}const c=this.getTileCacheKey(s,e);this.curLayerTileCollision={tileSize:e.tileSize,tileKey:c,tileCache:l,data:[],layer:e,existing:h},this.updated=!1}insert(t,e,i,s,r,n,o,a,l,h=Number.MAX_SAFE_INTEGER,c){let u=a.x,d=a.y,f=a.z,p=4,g=l<<f;const m=1/(1<<f);t/=g,e/=g,p/=g,n/=g,o/=g,t+=u*m,e+=d*m,n+=p,o+=p;const v=Math.min(n,o),x=Math.max(n,o),y=t+s/g,_=e+r/g;let b,w=Math.floor(x/v);c&&w>1.5?(n=v,o=v,w=Math.floor(.7*w),b=new Array(w),this.updateBBoxes(y,_,c[0]/g,c[1]/g,v,v,w,b)):b=[{minX:y-n,maxX:y+n,minY:_-o,maxY:_+o}];const M={cx:t,cy:e,cz:i,halfWidth:n,halfHeight:o,offsetX:s,offsetY:r,boxes:b,slope:c,priority:h,attrs:[]},{data:T,existing:S}=this.curLayerTileCollision,{dbg:A}=this;if(this.intersects(M,T))return!1;for(let t in S)if(this.intersects(M,S[t]))return A&&this.dbgBBoxes(M,f,"#680025",g),!1;return this.updated=!0,T.push(M),M}completeTile(t){let{tileKey:e,data:i,tileCache:s,tileSize:r,layer:n}=this.curLayerTileCollision;this.curLayerTileCollision=null;const o=s.get(e)||{};return o[this.getLayerId(n)]=i,s.set(e,o),t&&this.updated&&this.updateTileSync(this.display.getScreenTile(e,r),n),this.updated}clearTile(t,e,i=this.getTargetZoom(t,e)){const s=this.getLayerId(e),r=this.getTileCache(i);if(this.curLayerTileCollision&&this.getLayerId(this.curLayerTileCollision.layer)==s)return;const n=r.get(t);if(null==n?void 0:n[s]){delete n[s];let e=!0;for(let t in n){e=!1;break}e&&r.delete(t)}}updateTileSync(t,e){if(t){const i=this.projectCollisionsToScreen([e],[t]);return this.intersectCollisionData(i)}}update(t,e){this.isUpdating||(this.isUpdating=!0,setTimeout((()=>{this.dbg&&(this.dbgSkipNextRefresh=!this.dbgSkipNextRefresh)&&this.dbgLayers[1].getProvider().clear(),this.task.start([this,this.display.layers,t=>{this.isUpdating=!1,t&&(null==e||e())}])}),250))}projectCollisionsToScreen(t,e){const{centerWorld:i,w:s,h:r,s:n,zoom:o}=this.display,a=256<<o,l=i[0]*a-.5*s,h=i[1]*a-.5*r,c=[];for(let i of t)this.collisionsWorld2Screen(c,a,l,h,e||i.tiles,i,n);return c}collisionsWorld2Screen(t,e,i,s,r,n,o){const a=this.getLayerId(n),l=new Set;for(let n of r){const{quadkey:r,scale:h}=n;if(l.has(r))continue;l.add(r);const c=r.length,u=this.getTileCache(c).get(r);u&&this.updateTileCollisionData(a,e,i,s,h,u,o,t)}}intersectCollisionData(t){t.sort(((t,e)=>t.priority-e.priority));const e=[],i=[];let s=!1;for(let r of t){const t=this.processCollision(r,e,i);s||(s=t)}return s}processCollision(t,e,i){let s,r=!1,n=this.intersects(t,i);t.slope?s=e:(n||(n=this.intersects(t,e)),s=i),n||(s[s.length]=t);for(let{buffer:e,start:i,stop:s}of t.attrs){const{data:t,size:o}=e;if(n==!(1&~t[i])){for(;i<s;)t[i]^=1,i+=o;e.dirty=!0,r=!0}}return this.dbg&&this.dbgBBoxes(t,n),r}updateTileCollisionData(t,e,i,s,r,n,o,a){const{display:l}=this;for(let h in n){if(h!=t)continue;const c=n[t];for(let t of c){let{attrs:n,cx:h,cy:c,slope:u,halfWidth:d,halfHeight:f,offsetX:p,offsetY:g}=t,m=h*e-i,v=c*e-s;d*=e/r,f*=e/r;const x=t.boxes.length;let y;if(x>1){y=new Array(x),m+=p/o,v+=g/o;let[t,e]=l.project(m,v,0),i=l.project(m+u[0],v+u[1],0);const s=(i[0]-t)/o,r=(i[1]-e)/o;this.updateBBoxes(t,e,s,r,d,f,y.length-1,y)}else{let[t,e]=l.project(m,v,0);y=[{minX:t-d+p,maxX:t+d+p,minY:e-f+g,maxY:e+f+g}]}a.push({boxes:y,attrs:n,slope:u,priority:t.priority})}}}removeTiles(t){for(let e in this.tiles)this.tiles[e].forEach(((i,s)=>{this.clearTile(s,t,Number(e))}))}}class rr extends Map{constructor(){super(...arguments),this.tilePadding=2}init(t){this.tileSize=t,this.clear()}initEmptyTexture(t){const e=1+this.tilePadding;this.emptyTexture=new Gt(t,{data:new Float32Array(e*e),height:e,width:e})}getEmptyTexture(){return this.emptyTexture}}const nr=Math.PI/180,or=66.33*nr,ar=60*nr,lr=[3,9],hr=(t,e)=>{const i=t.length,s=e.length-i;let r=0,n=0,o=1;for(let t=0;t<s;t++){o*=.5;const s=Number(e.charAt(i+t));r+=s%2*o,n+=Number(s>1)*o}return[r,n,o]},cr=Symbol();class ur extends gt{constructor(t,e,i,s){super(t,e,i||"auto",new ni(512),new ti(s),lr),this.name="gl-test",this.worldCenter=[0,0],this.renderTilePool=new Ze,this._zSortedTileBuffers={tileBuffers:[],min3dZIndex:0,maxZIndex:0},this.dpr<2&&this.buckets.setMaxSize(2*this.buckets.getMaxSize());const r=this;this.collision=new sr(r),this.buckets.onDrop=function(t,e){const{quadkey:i,layers:s}=this;r.collision.clearTile(i,s[e]),r.releaseBuffers(t,i)};const{render:n}=r;this.terrainCache=new rr,n.init(this.canvas,this.dpr,this.terrainCache),this.rayCaster=new De(n.screenMat,n.invScreenMat),this.factory=new er(n.gl,this.collision,this.dpr)}refreshTile(t,e){const i=this.layers.get(e);if(i){const e=this.buckets.get(t,!0);if(e){const s=i.layer,{index:r}=i;e.preview(r,!1),e.ready(r,!1),e.cancelTasks(s);const n=s.getCachedTile(e.quadkey);n&&this.getScreenTile(t,i.tileSize)&&this.handleTile(n,s,e,r)}}}releaseBuffers(t,e){const i=this.render;if(t)for(let s of t)i.releaseGeometryBuffer(s,e)}initLights(t){const e=t.getLights();let i=e[cr];if(!i){i={};for(let t in e){const s=e[t];i[t]=rt(s)}e[cr]=i}this.render.processedLight[t.index]=i}initSky(t){const e=this.factory.textureManager.getFillTexture(t);this.render.setSkyColor(e)}addLayer(t,e,s){const r=super.addLayer(t,e,s);return r&&t instanceof i.TerrainTileLayer&&this.terrainCache.init(t.tileSize),0==(null==r?void 0:r.index)&&this.initSky((null==s?void 0:s.skyColor)||[1,0,0,1]),r}removeLayer(t){const e=this.layers.get(t);return this.collision.removeTiles(e),this.render.processedLight[e.index]=void 0,super.removeLayer(t)}unproject(t,e,i,s){if(s||(s=this.render.invScreenMat),"number"==typeof i){const r=[t,e,i];return Le(r,r,s),r}const r=[t,e,0],n=[t,e,1];Le(r,r,s),Le(n,n,s);const o=r[2],a=n[2],l=o===a?0:(0-o)/(a-o);return[r[0]*(1-l)+n[0]*l,r[1]*(1-l)+n[1]*l]}project(t,e,i=0,s=this.sx,r=this.sy,n=this.render.screenMat){const o=[t-s,e-r,i];return Le(o,o,n)}updateHorizonOffsets(t){this.horizonY=this.calcHorizonYOffset(t),this.horizonYFixed=this.calcHorizonYOffset(t,this.gridTopWorldAtFixedTilePitch,ar)}setSize(t,e){super.setSize(t,e),this.initRenderer();const i=i=>{const s=Ce([],this.render.updateMapGridMatrix(i,t,e));return this.unproject(0,1,null,s)};this.gridTopWorldAtPitchClamp=i(or),this.gridTopWorldAtFixedTilePitch=i(ar),this.maxHorizonY=this.calcHorizonYOffset(85/180*Math.PI)/e,this.updateHorizonOffsets(this.rx)}setTransform(t,e,i){const s=2*Math.PI;e=(e+s)%s,this.s=t,this.rz=e,this.rx!=i&&this.updateHorizonOffsets(i),this.rx=i}setView(t,e,i,s,r=this.groundResolution,n=this.worldSize){super.setView(t,e,i,s,r,n),this.groundResolution=r,this.worldCenter[0]=t[0],this.worldCenter[1]=t[1],this.worldSize=n,this.initRenderer()}initRenderer(){this.render.gl&&this.render.initView(this.w,this.h,this.s,this.rx,this.rz,this.groundResolution,this.worldCenter[0],this.worldCenter[1],this.worldSize)}prepareTile(t,e,i,s,r){const n=this,o=n.render.gl,a=i.tileSize,{quadkey:l}=s,h=i.id,c=this.layers.get(h);if("image"==t.type&&(e instanceof Image||e instanceof ImageBitmap)){const t=Be(e,o,a,c.index>0);c.addZ(t.zIndex),s.preview(s.setData(i,[t]),null),r(s,i)}else if(e.length){let e;const o=(t,o)=>{s.preview(s.setData(i,t),null),o.length&&o.forEach((t=>{t.then((()=>this.refreshTile(l,h)))}));n.collision.completeTile(!0)&&(this.dirty=!0);let a=s.getOverlayingTiles();for(let t of a)t.preview(c.index,null);e.outdated?(e.outdated=!1,e.restart()):s.removeTask(e,i),r(s,i)};e=bi.startTask(c,t,s,this.factory,this.terrainCache,this.render.gl,(()=>{n.collision.initTile(t,c)}),o),s.addTask(e,i)}else s.preview(s.setData(i,[]),null),r(s,i)}orderBuffers(t,e,i,s,r,n){for(let o of e){let{zLayer:e,zIndex:a}=o;null!=e||(e=i.getRenderIndex());let l,h=1e8*e+10*a;o.flat||(h+=1),s[h]=0,n?(l=this.renderTilePool.getNext(),l.init(o,h,r,i)):l={buffer:o,z:h,data:r,layer:i,tiled:n},t[t.length]=l}}initLayerBuffers(t){var e;const{buckets:i}=this;let s,r=[],n={};for(let o of t){this.initLights(o);let t=o.tiles;if(o.cnt=0,s={},o.layer.tiled){if(t){let a=o.index,l=t.length;for(let h of t){let t=h.tile,c=null===(e=t.data)||void 0===e?void 0:e[o.index];if(!o.ready&&t.ready(a)&&++o.cnt==l&&(o.ready=!0),c)c.length&&this.orderBuffers(r,c,o,n,{tile:h},!0);else{let e;if((e=t.preview(a))&&e.length)for(let l of e){const[e]=l,c=hr(e,t.quadkey);if(s[e]){s[e].push(c);continue}s[e]=[c];let u,d=i.get(e,!0);u=null==d?void 0:d.getData(a),(null==u?void 0:u.length)&&this.orderBuffers(r,u,o,n,{tile:h,preview:l,stencils:s[e]},!0)}}}}}else{o.ready=!0;const t=o.layer,{renderOptions:e}=t;this.orderBuffers(r,[{zLayer:e.zLayer,zIndex:e.zIndex,pass:e.alpha||1,flat:t.flat}],o,n,o.layer,!1)}}let o=0;for(let t of Object.keys(n).sort(((t,e)=>Number(t)-Number(e))))n[t]=o++;let a=1/0;for(let t,e,i=0;i<r.length;i++)e=r[i],e.prepareHeightMapReferences(),t=e.z=n[e.z],!e.buffer.flat&&t<a&&(a=t);return{tileBuffers:r,min3dZIndex:a,maxZIndex:o}}getCamGroundPositionScreen(){const{cameraWorld:t}=this.render;return this.project(t[0],t[1])}getHorizonYOffset(){return this.horizonY}calcHorizonYOffset(t=this.rx,e=this.gridTopWorldAtPitchClamp,i=or){let s=0;if(t>i){const{w:i,h:r}=this,n=this.render.updateMapGridMatrix(t,i,r);s=(1-this.project(e[0],e[1],0,0,0,n)[1])*r/2}return s}isPointAboveHorizon(t,e){return this.rx>ar&&this.project(t,e)[1]<this.horizonYFixed}useLODTiles(){return this.rx>ar}viewport(t){const e=this,{layers:i,render:s}=e;let r;e.dirty&&(e.dirty=!1,e.updateCollisions()),s.fixedView=Number(!this.viewChange),this.renderTilePool.beginFrame();const n=this.initLayerBuffers(i),{tileBuffers:o,min3dZIndex:a,maxZIndex:l}=n;s.clear(e.bgColor),s.drawSky(this.horizonY,this.h,this.maxHorizonY),s.zIndexLength=l,s.setPass(bt.OPAQUE);let h=o.length;for(;h--;){let t=o[h];(null==t?void 0:t.tiled)&&s.draw(t,a)}s.setPass(bt.ALPHA),o.sort(((t,e)=>10*(t.z-e.z)+t.buffer.pass-e.buffer.pass)),this._zSortedTileBuffers=n;let c=0;do{let t=!1;for(h=0,r=o.length;h<r;h++){let e=o[h];e.buffer.pass&bt.POST_ALPHA&&(t=!0),(null==e?void 0:e.z)==c&&(e.tiled?s.draw(e,a):s.drawCustom(e.data,e.z))}s.pass==bt.POST_ALPHA?s.setPass(bt.ALPHA):t&&(s.setPass(bt.POST_ALPHA),c--)}while(++c<l);if(s.tileGrid)for(let t of e.tiles)for(let i of e.layers)if(!i.skipDbgGrid&&-1!==i.tiles.indexOf(t)){s.drawGrid(t.x,t.y,t.tile,t.size*t.scale);break}this.renderTilePool.endFrame()}updateCollisions(){this.collision.update(this.tiles,(()=>this.update()))}destroy(){super.destroy(),this.factory.destroy()}getTerrainHeightAtWorldXY(t,e,i){var s,r,n;const{tileBuffers:o}=this._zSortedTileBuffers;let a=o.length;for(;a--;){if(!o[a].tiled||!o[a].buffer.pointerEvents)continue;const l=o[a];let{layer:h}=l;const c=l.data.tile;if(i!==h.layer)continue;const u=(null===(s=l.data.preview)||void 0===s?void 0:s[0])||c.quadkey,d=null===(n=null===(r=h.layer.getCachedTile(u))||void 0===r?void 0:r.data)||void 0===n?void 0:n[0];if(!(null==d?void 0:d.getHeightMap()))continue;const[f,p]=l.worldToTile(t,e,0),g=c.size;if(f<0||p<0||f>g||p>g)continue;const m=f/g,v=p/g;return d.getHeightAt(m,v)}return null}getRenderedFeatureAt(t,e,i){this.rayCaster.init(t,e,this.w,this.h,this.s,1/this.groundResolution);let s=null;const r=this.rayCaster.origin[2]+.001,{tileBuffers:n,min3dZIndex:o}=this._zSortedTileBuffers;let a=n.length;for(;a--;){if(!n[a].tiled||!n[a].buffer.pointerEvents)continue;const t=n[a];let{buffer:e,z:l,data:h,layer:c}=t;if(-1==(null==i?void 0:i.indexOf(c.layer)))continue;let u=!1;if(e.flat){if(!(l>o))continue;u=!0}const{x:d,y:f,size:p}=h.tile;let g=0,m=r;e.zRange&&(g=e.zRange[0],m=e.zRange[1]);const v=t.getModelMatrix(),x=Le([],[0,0,g],v),y=Le([],[p,p,m],v);if(!this.rayCaster.intersectAABBox(x[0],x[1],x[2],y[0],y[1],y[2]))continue;if(null!=this.rayCaster.intersect(d,f,e,v)&&(s=c,u))break}const l=this.rayCaster.getIntersectionTop();return l.layer=null==s?void 0:s.layer,this.viewport(!0),l}viewChangeDone(){this.viewChange=!1,this.update()}scaleOffsetXYByAltitude(t){const e=this.render.vPMat;return 1-t[2]*e[11]/(e[3]*t[0]+e[7]*t[1]+e[15])}setZoom(t){if(super.setZoom(t))return this.buckets.forEach((t=>{for(let e of t.data)if(e)for(let t of e)t.clearUniformCache()})),!0}computeDistanceScale(t,e){const i=[t,e,0,1],s=function(t,e,i){var s=e[0],r=e[1],n=e[2],o=e[3];return t[0]=i[0]*s+i[4]*r+i[8]*n+i[12]*o,t[1]=i[1]*s+i[5]*r+i[9]*n+i[13]*o,t[2]=i[2]*s+i[6]*r+i[10]*n+i[14]*o,t[3]=i[3]*s+i[7]*r+i[11]*n+i[15]*o,t}(i,i,this.render.screenMat);return s[3]/this.render.distanceCam2Center}get geometryBufferCount(){var t,e;return 0^(null===(e=null===(t=this._zSortedTileBuffers)||void 0===t?void 0:t.tileBuffers)||void 0===e?void 0:e.length)}}ur.zoomBehavior="float";const dr=new Zs,fr=2*Math.PI,pr=Math.PI/180,gr=Math.log(2048)/Math.log(2),mr=gr+9,vr=(t,e,i,s,r,n,o,a,l,h,c,u)=>{const d=o.z;e+=0^U("offsetX",s,r,d),i+=0^U("offsetY",s,r,d);let f,p,g,m,v,x,y=U("rotation",s,r,d),_=e+512<<gr|i+512|(y+360)%360<<mr;c[_]||(c[_]=1,y&&(y*=pr,l.translate(e,i),l.rotate(y),v=e,x=i,e=0,i=0),"Text"==t?(s.stroke&&0!=s.strokeWidth&&l.strokeText(n,e,i),s.fill&&l.fillText(n,e,i)):"Circle"==t?(p=U("radius",s,r,d),l.moveTo(e+p,i),l.arc(e,i,p,0,fr,!1)):(g=U("width",s,r,d),m=U("height",s,r,d)||g,e-=g/2,i-=m/2,"Image"==t?(f=U("src",s,r,d),dr.isReady(f)?l.drawImage(dr.get(f),e,i,g,m):dr.get(f,(()=>u.updateTile(o,a,h)),o.quadkey)):"Rect"==t&&l.rect(e,i,g,m)),y&&(l.rotate(-y),l.translate(-v,-x)))},xr=Math;class yr{constructor(){this.o=.5}init(t){return this.o=t,!0}createSymbol(t,e){let i;return i="Circle"==e.type?e.radius:e.width,t-i>0}drawSymbol(t,e,i,s,r,n,o,a,l,h,c){vr(r.type,e,i,r,o,!1,n,a,s,l,h,c)}angle(t,e){return Math.atan2(t,e)}place(t,e,i,s,r,n,o,a,l,h){let c,u,d,f,p,g,m,v,x,y;const _=this.o;for(let b=0;b<t.length;b++)d=Math.round(e.lon2x(t[b][0])),f=Math.round(e.lat2y(t[b][1])),b&&(x=d-c,y=f-u,p=xr.sqrt(xr.pow(x,2)+xr.pow(y,2))-16,g=this.createSymbol(p,r),g&&(m=(x*_+c)*h,v=(y*_+u)*h,i.setTransform(h,0,0,h,m,v),i.rotate(this.angle(y,x)),i.translate(-m,-v),this.drawSymbol(g,m,v,i,r,e,s,n,o,a,l),i.setTransform(h,0,0,h,0,0))),c=d,u=f}}const _r=(t,e,i)=>{let s,r,n,o,a=t.length-1;for(e.moveTo(n=Math.round(i.lon2x(t[a][0])),o=Math.round(i.lat2y(t[a][1])));a--;)s=Math.round(i.lon2x(t[a][0])),r=Math.round(i.lat2y(t[a][1])),(n-s||o-r)&&e.lineTo(n=s,o=r)},br="round",wr=[];let Mr,Tr=new class extends yr{constructor(t){super(),super.init(.5),this.setCharWidth(t)}setCharWidth(t){this.cw=t}init(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0}angle(t,e){return Math.atan(t/e)}createSymbol(t){const e=this.label,i=this.cw,s=this.lw;let r,n,o=Math.floor(t/s);return o>0&&(r=e,o>1&&(o=1+Math.floor((o-1)/8),n=new Array(Math.floor(1.5*(t-s)/i/o)).join(" "),r=e+new Array(o).join(n+e))),r}drawSymbol(t,e,i,s,r){r.stroke&&s.strokeText(t,e,i),r.fill&&s.fillText(t,e,i)}}(p({font:c}).width),Sr=new yr;var Ar=(t,e,i)=>{t.globalAlpha=e.opacity==Mr?1:e.opacity;const s=e.font,r=e.stroke;let n,o;if(r&&(t.strokeStyle=r,n=e.strokeWidth,s&&(i=1),n&&"number"==typeof n||(n=1),t.lineWidth=n*i),e.fill&&(t.fillStyle=e.fill),s){let i=e.font||c;Tr.setCharWidth(p(e).width),t.font=i,t.textAlign=e.textAlign||"center",t.textBaseline=e.textBaseline||"middle"}else t.lineCap=e.strokeLinecap||br,t.lineJoin=e.strokeLinejoin||br,o=e.strokeDasharray,o instanceof Array?t.setLineDash(o):t.setLineDash(wr),(e.fill||e.stroke)&&t.beginPath();return!0},Lr=(t,e,i,s,r,n,o,a,l,h)=>{let c=i.getProvider().decCoord(i),u=i.geometry.type;const d=t.z;let f=U("type",r,i,d);if("LineString"==u){if("Circle"==f||"Rect"==f||"Image"==f){const s=U("offset",r,i,d);if(s!=Mr)return Sr.init(s),void Sr.place(c,t,e,i,r,n,o,a,l,h);u="MultiPoint"}}else if(("Polygon"==u||"MultiPolygon"==u)&&"Polygon"!=f&&"Line"!=f){const h=i.bbox;return vr(f,Math.round(t.lon2x(h[0]+(h[2]-h[0])/2)),Math.round(t.lat2y(h[1]+(h[3]-h[1])/2)),r,i,s,t,n,e,o,a,l)}if("Point"==u)vr(f,Math.round(t.lon2x(c[0])),Math.round(t.lat2y(c[1])),r,i,s,t,n,e,o,a,l);else if("Text"==f){if(!Tr.init(s))return;if("MultiLineString"==u)for(var p=0;p<c.length;p++)Tr.place(c[p],t,e,i,r,n,o,a,l,h);else"LineString"==u&&Tr.place(c,t,e,i,r,n,o,a,l,h)}else if("LineString"==u)_r(c,e,t);else if("Polygon"==u||"MultiLineString"==u)for(var g=0;g<c.length;g++)_r(c[g],e,t);else if("MultiPolygon"==u)for(p=0;p<c.length;p++)for(g=0;g<c[p].length;g++)_r(c[p][g],e,t);else if("MultiPoint"==u){let h=c.length;for(;h--;)vr(f,Math.round(t.lon2x(c[h][0])),Math.round(t.lat2y(c[h][1])),r,i,s,t,n,e,o,a,l)}};let zr;class Pr{constructor(t,e,i){this.tm=t,this.exclusiveTimeMS=i,this.dpr=e}spawn(t,e,i,s,r,n,o,a){let l=this.createTask(t,e,i,s,r,i.bounds,n,o,a);return this.tm.start(l),l}createTask(t,e,i,s,r,n,o,a,l){const h=this.dpr;let c=r.index(s),u=r.getContext(c),d=this.tm.create({priority:t,time:this.exclusiveTimeMS,init:function(){if(!l){u.setTransform(h,0,0,h,0,0);let t=s.getStyle().backgroundColor;t?(u.fillStyle=t,u.globalAlpha=1,u.fillRect(0,0,256,256)):u.clearRect(0,0,256,256)}return{tile:i,ctx:u,data:o,lI:0,gI:0,fI:0,style:zr,dTile:r,layer:s,bI:100}},onDone:function(){r.dirty(c),a(u,this)},exec:function(t){let i,s=t.tile,r=t.data,n=r.length;if(n){for(;!(i=r[t.lI])&&t.lI<n;)++t.lI;if(i){let n=i[t.gI];if(n){let i=t.ctx,o=n.shared,a=o.font!=zr;for(t.style!=o&&(t.style=o,Ar(i,o,r.swzs),t.pmap={});t.bI--;){let r=t.fI++;const l=n.data;let c=l.features[r];if(!c){a?i.setTransform(h,0,0,h,0,0):(o.fill&&i.fill(),o.stroke&&(o.strokeWidth||o.strokeWidth==zr)&&i.stroke()),t.fI=0,t.gI++;break}{let n,o=l.styles[r];if(a&&(n=F(o,c,s.z),!n))continue;Lr(s,i,c,n,o,t.dTile,t.layer,t.pmap,e,h)}}}else t.fI=0,t.gI=0,t.lI++;return t.bI=100,this.CONTINUE}}}});return d}}const Cr=256;class Er{constructor(t,i){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;let s=e.TaskManager.getInstance(),r=this;r.ts=t,r.dpr=i,r.painter=new Pr(s,i,4)}drawGrid(t,e,i){let s=i+"  L"+i.length;const r=this.ctx;r.strokeRect(t,e,Cr,Cr),r.strokeText(s,t+8,e+16),r.fillText(s,t+8,e+16)}applyTransform(){const t=this,e=t.s,i=t.rz;if(t._s!=e||t._rz!=i){t._s=e,t._rz=i;const s=t.ctx,r=t.canvas,n=r.width,o=r.height,a=n/2-t.sx,l=o/2-t.sy,h=t.dpr;s.setTransform(1,0,0,1,n/2,o/2),s.rotate(i),s.translate(-n/2+a,-o/2+l),s.scale(e,e),s.translate(-a,-l),s.scale(h,h)}}init(t){let e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t}setBuckets(t){this.buckets=t}clear(){}convertColor(t){return t}setBackgroundColor(t){this.buckets.bgColor(t)}grid(t){this.debug=t}setScale(t,e,i){let s=this;s.s=t,s.sx=e,s.sy=i}setRotation(t,e){this.rz=t}prepare(t,e,i,s,r,n){return this.painter.spawn(3,s,e,i,r,t,n)}tile(t,e,i){const s=this;e=Math.round(e),i=Math.round(i),s.ctx.drawImage(t.combine(),e,i,Cr,Cr),s.debug&&s.drawGrid(e,i,t.quadkey)}preview(t,e,i,s){let r=t.getContext(s);r.clearRect(0,0,t.size,t.size);for(let i=0,n=e.length;i<n;i++){let n,o=e[i],a=this.buckets.get(o[0],!0);a&&(n=a.getData(s))&&(r.setTransform(1,0,0,1,0,0),r.drawImage(n,o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8]),t.dirty(s))}}destroy(){}getContext(){return this.ctx}}let Ir;class Rr extends ii{constructor(t,e,i,s,r){super(t);let n=i.length;this.c=new Array(n),this.init(e,i),this.size=s,this.ctx=t.claimCtx(s),this.canvas=this.ctx.canvas,this.ctx.fillStyle=r}destroy(t){if(t!=Ir)(e=this.c[t])&&(e.canvas&&this.pool.releaseCtx(e),this.c[t]=Ir);else{let t=this.c.length;for(var e;t--;)(e=this.c[t])&&e.canvas&&(this.pool.releaseCtx(e),this.c[t]=Ir)}}init(t,e){super.init(t,e);let i=e.length;for(this.c.length=i;i--;)this.c[i]=Ir;this._c=!1,this._ready=!1}dirty(t,e){let i=this.c[t],s=e!=i;e&&i&&s&&this.destroy(t),e||(s=!0,e=this.c[t]),s&&(this.c[t]=e,this._c=!1)}clear(t){let e;(e=this.c[t])&&(e.setTransform&&this.pool.releaseCtx(e),this.c[t]=Ir,this.preview(t,Ir),this.ready(t,!1),this._c=!1,this.combine())}getContext(t){return this.c[t]||(this.c[t]=this.pool.claimCtx(this.size)),this.c[t]}getData(t){return this.c[t]&&(this.c[t].canvas||this.c[t])}combine(){let t,e=this,i=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,i,i);for(let s=0;s<e.c.length;s++)(t=this.getData(s))&&e.ctx.drawImage(t,0,0,i,i)}return e.canvas}addLayer(t){super.addLayer(t);let e=this;e.c.splice(t,0,Ir),e._c=!1,e._ready=!1}removeLayer(t){super.removeLayer(t);this.destroy(t),this.c.splice(t,1),this._c=!1}}let kr=[];const Fr={length:0,max:128,clear:function(){this.length=0},create:function(t){let e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return kr.length?(this.length++,kr.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,kr.push(t),this.length--}};class Dr extends ri{constructor(t,e){super(t||256),this.ctxCache=Fr,this._bgc=null,this.tSize=e}bgColor(t){this._bgc=t,this.forEach((e=>{e.ctx.fillStyle=t}))}clear(){this.tiles.clear(),Fr.clear()}releaseCtx(t){return Fr.release(t)}claimCtx(t){if(Fr.length<Fr.max)return Fr.get(t);{let e=this.tiles.tail.data;return e.destroy(),Fr.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)}}create(t,e){let i=this.tiles.get(t);return i||(this.tiles.length>=this.tiles.max?(i=this.tiles.tail.data,i.destroy(),i.init(t,e),i.size=this.tSize):i=new Rr(this,t,e,this.tSize,this._bgc),this.tiles.set(t,i)),i}}const Ur=c,Or=()=>1,Br="*";let Hr;class Gr{constructor(t,e){this.tm=t,this.ms=e}exclusiveRuntime(t){this.ms=t}spawn(t,e,i,s,r,n,o,a){let l=this.createTask(t,e,i,s,r,n,o);return this.tm.start(l,a),l}createTask(t,e,i,s,r,n,o){const a=[],l=this.ms,h=this.tm.create({time:l,priority:t,init:function(){if(s){let t=s.length,e=Date.now();for(;t--;)s[t];h.time=l-(Date.now()-e)}return[i,s,r,0,a,300,e,{}]},name:"cluster",onDone:function(){const t=e.getStyle(),s=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||Or;a.swzs=s(i.z),o(a,this)},exec:function(t){let e=t[0],i=t[1],s=t[2],r=t[6],o=i.length,a=t[4];const l=e.z;let h,c,u,d,f,p,g,m,v,x,y,_,b,w,M,T,S,A,L,z,P;if(i&&!(t[3]>=o)){for(;t[5]--&&(f=i[t[3]++]);)if(p=f.id,!s[p]&&(s[p]=!0,u=r.getStyleGroup(f,l),u)){u.length||(u=[u]);for(let t=0,e=u.length;t<e;t++)d=u[t],Y(d)&&(h=U("zIndex",d,f,l),g=U("type",d,f,l),M=U("opacity",d,f,l),_=Hr,y=Hr,b=Hr,w=Hr,A=Hr,T=Hr,S=Hr,L=Hr,z=Hr,P=Hr,"Image"==g?c="I":(y=U("fill",d,f,l),b=U("stroke",d,f,l),w=U("strokeWidth",d,f,l),"Line"==g?(T=U("strokeLinecap",d,f,l),S=U("strokeLinejoin",d,f,l),A=U("strokeDasharray",d,f,l),c="L"+(T||Br)+(S||Br)+(A||Br)):"Text"==g?(_=U("font",d,f,l)||Ur,c="T"+(_||Br)):"Circle"==g?(L=U("radius",d,f,l),c="C"+L||Br):(z=U("width",d,f,l),P=U("height",d,f,l)||z,c="R"+z+P),c+=(b||Br)+(w||Br)+(y||Br)),M!=Hr&&(c+=100*M^0),m=a[h]=a[h]||[],x=m[c],x==Hr?(x=m[c]=m.length,v=m[x]={shared:{font:_,fill:y,opacity:M,stroke:b,strokeWidth:w,strokeLinecap:T,strokeLinejoin:S,strokeDasharray:A},data:new n}):v=m[x],v.data.add(f,d))}return t[5]=300,t[3]<o}}});return h}}let Nr={1:[512,3,512],2:[128,2,128],3:[64,1,128]};let Wr;const Zr=(t,e,i,s,r)=>{const n=Math.sin(r),o=Math.cos(r),a=t-i,l=e-s;return[o*a-n*l+i,n*a+o*l+s]};class Yr{constructor(){this.features=[],this.styles=[]}add(t,e){this.features.push(t),this.styles.push(e)}}class Vr extends gt{constructor(t,i,s,r){i=i||256,s=0^gt.getPixelRatio(s);const n=Nr[s][1],o=new Er(i*s,s),a=Nr[s][0],l=new Dr(a,i*s);o.setBuckets(l),super(t,i,s,l,o,n),this.cluster=new Gr(e.TaskManager.getInstance(),4),o.init(this.canvas)}preview(t,e,i){const s=super.preview(t,e,i);return s&&this.render.preview(t,s,e,i),s}prepareTile(t,e,i,s,r){let n=this,o=n.render;if("image"==t.type){const t=s.index(i);s.dirty(t,e),r(s,i)}else if(e.length)s.addTask(n.cluster.spawn(4,i,t,e,{},Yr,((e,a)=>{s.removeTask(a,i),null==s&&(s=Wr),s.addTask(o.prepare(e,t,i,n,s,((t,e)=>{s.removeTask(e,i),r(s,i)})),i)})),i);else{const t=s.index(i);s.destroy(t),s.dirty(t),r(s,i)}}viewport(t){const e=this,i=e.tiles,s=e.render,r=e.layers,n=r.length,o=i.length;(this.dirty||t)&&(this.render.clear(),this.dirty=!1);for(let e of i){if(256!=e.scaledSize)continue;const i=e.tile;if(e.lrTs!==i.luTs||t){e.lrTs=i.luTs,s.tile(i,e.x,e.y);for(var a,l=0;l<n;l++)!(a=r[l]).ready&&i.ready(l)&&++a.cnt==o&&(a.ready=!0)}}}addLayer(t,e,i){t.tileSize=256;const s=super.addLayer(t,e,i);return s&&this.setupTilePool(),s}removeLayer(t){const e=super.removeLayer(t);return-1!==e&&this.setupTilePool(),e}setSize(t,e){const i=this;super.setSize(t,e),i.setupTilePool(),i.render._s=Wr,i.setTransform(i.s,i.rz,i.rx)}destroy(){super.destroy(),this.buckets.clear()}setupTilePool(){let t=this;const e=(Math.ceil(t.w/256)+1)*(Math.ceil(t.h/256)+1);let i=e;const s=Nr[t.dpr];let r=e*t.getLayers().length;i<s[0]&&(i=s[0]),t.buckets.setMaxSize(i),r<s[2]&&(r=s[2]),t.buckets.ctxCache.max=r}update(t){super.update()}project(t,e){const i=this,s=i.s;return Zr(t*=s,e*=s,i.w/2,i.h/2,i.rz)}unproject(t,e){let i=this,s=i.s;const r=i.w/2,n=i.h/2;let o=Zr(t,e,r,n,-i.rz);return o[0]=(o[0]-r)/s+r,o[1]=(o[1]-n)/s+n,o}}Vr.zoomBehavior="fixed";const Xr=0===navigator.platform.indexOf("Win")?.0025:.0015;class jr{constructor(t,e,i,s){this.passive=!1;try{let t=Object.defineProperty({},"passive",{get:()=>{this.passive=!0}});window.addEventListener("testPassive",null,t),window.removeEventListener("testPassive",null,t)}catch(t){}this.el=t,this.settings=i,this.map=e,this.ams=0^s,this.onSpin=this.onSpin.bind(this)}onSpin(t){const{settings:i,el:s,map:r}=this,n=i.zoom;if(n){let i=-(t=t||e.global.event).deltaY;if(t.deltaMode===t.DOM_DELTA_LINE&&(i*=32.001953125),i){const e=r.getZoomlevel();let o,a;"fixed"==n?t.shiftKey?o=e+(i>0?.1:-.1):(o=Math.round(e+(i<0?-1:1)),a=!0):o=e+i*Xr;let l=s.getBoundingClientRect();this.zoom(o,t.pageX-l.left,t.pageY-l.top,a)}}t.preventDefault&&t.preventDefault(),t.returnValue=!1}enable(){s(this.el,["wheel","DOMMouseScroll"],this.onSpin)}disable(){r(this.el,["wheel","DOMMouseScroll"],this.onSpin)}zoom(t,e,i,s){const{map:r,ams:n}=this;r.setZoomlevel(t,e,i,s&&n)}}const qr=t=>t,$r=t=>Math.sin(Math.PI*t*.5);var Kr=Object.freeze({__proto__:null,easeOut:t=>1-Math.pow(1-t,1.5),easeOutCubic:t=>1-(t=1-t)*t*t,easeOutSine:$r,linear:qr});class Qr{constructor(t,e,i,s,r){this.ts=0,this.af=null,this.from="number"==typeof t?[t]:t,this.to="number"==typeof e?[e]:e,this.duration=i,"function"==typeof s&&(r=s,s="linear"),this.easing=Kr[s]||qr,this.animator=r,this.animate=this.animate.bind(this)}animate(){const{duration:t}=this,e=Math.min(Date.now()-this.ts,t);let i=this.from.map(((i,s)=>{const r=this.to[s];return i+this.easing(e/t)*(r-i)}));this.animator(1==i.length?i[0]:i),e<t?this.af=requestAnimationFrame(this.animate):(this.af=null,this.done())}async start(){return new Promise((t=>{this.done=t,this.ts?t():(this.ts=Date.now(),this.animate())}))}stop(){null!=this.af&&(cancelAnimationFrame(this.af),this.af=null)}}const Jr=(t,e)=>{let i,s,r=t.targetTouches;if(r){let t,n=r.length,o=r[n-1];if(n){let a=e.getBoundingClientRect(),l=o.pageX-a.left,h=o.pageY-a.top;n>1?(t=r[n-2],i=(l+t.pageX-a.left)/2,s=(h+t.pageY-a.top)/2):(i=l,s=h)}}else i=t.clientX,s=t.clientY;return[0^i,0^s]},tn=t=>{const e=t.targetTouches,i=e.length,s=e[i-2];if(s){const t=e[i-1],r=s.clientX-t.clientX,n=s.clientY-t.clientY;return 180*Math.atan2(n,r)/Math.PI}};class en{constructor(t,i,n,o,a){this.scrollHandler=new jr(t,i,o,a.zoomAnimationMs);let l,h,c,u,d,f,p,g=this,m=null,v=Date.now();const x=[],y=[],b=(t,e,i)=>{const s=a[t];return Math.abs(e-l)>s||Math.abs(i-h)>s},w=()=>{p=0,x.length=0,y.length=0};function M(t){let e=1;if(null!=t.scale)return t.scale;let i=t.targetTouches,s=i.length,r=i[s-1],n=i[s-2];if(n){let t=_(r.clientX,r.clientY,n.clientX,n.clientY);null==m&&(m=t),e=t/m}return e}function T(t,e){if(!d){if(!b("minPanMapThreshold",t,e))return!0;n.cancel()}if(f=Date.now(),o.drag&&!i.lockViewport().pan){let s=t-c,r=e-u;p<8?(x[p]=s,y[p]=r,p++):p=0,i.pan(s,r),d=!0}c=t,u=e}function S(t){if(d){let t=Date.now();t-f<25&&n.pan(t,3*x.reduce(((t,e)=>t+e),0),3*y.reduce(((t,e)=>t+e),0))}}let A,L,z,P,C,E,I,R,k,F=null;function D(e){w();let s=e.targetTouches,r=s.length,n=Jr(e,t);if(c=n[0],u=n[1],l=c,h=u,M(e),d=!1,2==r){k=0;let t=s[r-1],n=s[r-2];C=t.clientX,E=t.clientY,I=n.clientX,R=n.clientY,m=_(C,E,I,R),P=i.getZoomlevel(),A=i.rotate(),L=i.pitch(),z=tn(e)}}function U(e){let s=e.targetTouches,r=s.length,n=Jr(e,t),a=M(e);if(r>1){if(o.pitch){if(++k<5)return void e.preventDefault();const t=s[r-1],n=s[r-2],o=E-t.clientY,a=R-n.clientY;if(F||0!=F&&Math.abs(n.clientY-t.clientY)<110&&Math.sign(o)==Math.sign(a))return F=!0,i.pitch(L+.2*o),void e.preventDefault();F=!1}o.zoom&&g.scrollHandler.zoom(P+Math.log2(a),n[0],n[1],!1),o.rotate&&i.rotate(A+tn(e)-z)}T(n[0],n[1]),c=n[0],u=n[1],e.preventDefault()}function O(e){let i=Jr(e,t),s=e.targetTouches.length;F=null,i&&(c=i[0],u=i[1],l=c,h=u),s<2&&(m=null);let r=Date.now(),n=r-v;s&&(v=r),M(e),0==s&&1==e.changedTouches.length&&n>350&&S()}let B=null;function H(e){B=e.button,w(),d=!1,s(t,"mousemove",G),A=i.rotate(),L=i.pitch(),c=e.clientX,u=e.clientY,l=c,h=u}function G(t){var e;null===(e=g.resetAnimation)||void 0===e||e.stop();const s=t.clientX,r=t.clientY;0==B?T(s,r):2==B&&(o.rotate&&b("minRotateMapThreshold",s,r)&&i.rotate(A+.25*(c-s)),o.pitch&&b("minPanMapThreshold",s,r)&&i.pitch(L+.1*(u-r)))}function N(e){if(B=null,r(t,"mousemove",G),d)S();else if(o.rotate){const t=i.rotate();A!=t&&Math.abs(t)<=5&&(g.resetAnimation=new Qr(t,0,500,"easeOutSine",(t=>i.rotate(t))),g.resetAnimation.start())}}g.scroll=t=>{let{scrollHandler:e}=this;t?e.enable():e.disable()},g.drag=i=>{const n=i?s:r;setTimeout((()=>{n(t,"touchstart",D),n(e.global,"touchend",O),n(t,"touchmove",U),n(t,"mousedown",H),n(e.global,"mouseup",N)}),0)},g.getOptions=()=>o}}class sn{constructor(t,e,i,s,r){this.type=t,this.timeStamp=Date.now(),null!=e&&(this.data=this.detail=e),i&&(this.mapX=s,this.mapY=r,this.nativeEvent=i,this.button=i.button)}stopPropagation(){const t=this.nativeEvent;if("mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()}toString(){return"MapEvent "+this.type}}const rn="pointerup",nn="pointerenter",on="pointerleave",an="pointerdown",ln="pointermove",hn="pressmove",cn="dbltap",un=[rn,nn,on,an,ln,hn,"tap",cn];function dn(t){return-1!==un.indexOf(t)}function fn(t,e){let i=e.type;"touchstart"!=i&&"touchmove"!=i&&"touchend"!=i||(e=e.changedTouches[e.changedTouches.length-1]);let s=t.getBoundingClientRect();return[e.pageX-s.left,e.pageY-s.top]}class pn extends e.Task{constructor(t){super(),this.interval=50,this.findTarget=t,this._active=!1}isActive(){return this._active}setPointerEvent(t){this.ev=t}exec(){this.findTarget(this.ev),this._active=!1,this.ev=null}start(){this._active=!0,setTimeout((()=>super.start()),this.interval)}}class gn{constructor(t,i,s,r){this.disabled={},this.hActive=!1,this.cnt=0,this.el=t,this.cbs=new e.Listener(["click"]);const{disabled:n}=this;let o,a,l,h,c,u=!1,d=!1,f=0,p=this.cbs;p.sync(!0),un.forEach((t=>{p.addEvent(t),n[t]=!1}));const g=new pn((function(e){let i=fn(t,e),s=x(i);v(ln,e,i,s),s?c?c.feature.id!==s.feature.id&&(v(on,e,i,c),v(nn,e,i,s)):v(nn,e,i,s):c&&v(on,e,i,c);c=s}));function m(t,e,s,r,n){let o=new sn(t,n,e,s,r);return n&&(o.target=n.feature,o.detail.display=i),o}function v(t,e,i,s){p.trigger(t,[m(t,e,i[0],i[1],s)],!1)}function x(t){return i.getFeatureAt({x:t[0],y:t[1]},{layers:i._layers.filter((t=>t.pointerEvents()))})}let y=!1;this.onPointerDown=function(e){const s="touchstart"==e.type;s||!y?(l=i.getCenter(),d=!0,u=!1,o=fn(t,e),a=x(o),v(an,e,o,a),s&&e.target.parentNode==t&&(y=!0)):y=!1},this.onPointerMove=function(e){const i="mousemove"==e.type;if(i&&y)return;let s,l,h;if(d){let i=r.minPanMapThreshold;if(!u&&(s=fn(t,e),l=s[0]-o[0],h=s[1]-o[1],Math.abs(l)<i&&Math.abs(h)<i))return}var c;u=!0,d?a&&p.isListened(hn)&&(s=fn(t,e),l=s[0]-o[0],h=s[1]-o[1],p.trigger(hn,[m(hn,e,s[0],s[1],a),l,h],!1)):i&&(p.isListened(nn)||p.isListened(on)||p.isListened(ln))&&(c=e,g.setPointerEvent(c),g.isActive()||n.pointerenter||n.pointerleave||g.start())},this.onPointerUp=function(e){if(d){let s=i.getCenter();if(!(l.longitude!=s.longitude||l.latitude!=s.latitude)&&e.target.parentNode==t&&(a||!u)){let i=fn(t,e);v("tap",e,i,a),v(rn,e,i,a),function(t){let e=Date.now(),i=a&&a.feature;e-f<250&&!u&&h==i&&v(cn,t,o,a),h=i,f=e}(e)}d=u=!1}}}getGlobalHandlers(){const{onPointerDown:t,onPointerMove:e,onPointerUp:i}=this;return{touchstart:t,touchmove:e,touchend:i,mousedown:t,mouseup:i,mousemove:e}}enable(t){dn(t)&&delete this.disabled[t]}disable(t){dn(t)&&(this.disabled[t]=!0)}destroy(){let t=this.getGlobalHandlers();if(this.hActive){for(let e in t)r(this.el,e,t[e]);this.hActive=!1}}addEventListener(t,e,i){if(dn(t)&&this.cbs.add(t,e,i)){this.cnt++;let t,e=this.getGlobalHandlers();if(!this.hActive)for(let i in e){t=e[i];let{el:r}=this;if("mouseup"==i)for(;r.parentNode;)r=r.parentNode;s(r,i,t),this.hActive=!0}}}removeEventListener(t,e,i){const{cbs:s,el:n}=this;if(dn(t)&&s.remove(t,e,i)&&! --this.cnt&&this.hActive){let t=this.getGlobalHandlers();for(let e in t)s.isListened(e)||r(n,e,t[e]);this.hActive=!1}}}const mn=(t,e,i)=>{let s=!1;for(let r=0,n=i.length-1;r<i.length;n=r++){const o=i[r][0],a=i[r][1],l=i[n][0],h=i[n][1];a>e!=h>e&&t<(l-o)*(e-a)/(h-a)+o&&(s=!s)}return s};class vn{constructor(t,e){this.map=t,this.dpr=e}pointToLineDistanceSq(t,e,i,s,r,n){const o=r-i,a=n-s,l=o*o+a*a;let h,c,u,d,f=-1;if(0!=l){h=t-i,c=e-s;f=(h*o+c*a)/l}f<0?(u=i,d=s):f>1?(u=r,d=n):(u=i+f*o,d=s+f*a);const p=t-u,g=e-d;return this.sideOfLine=o*c-h*a<0?-1:1,p*p+g*g}pointInPolygon(t,e,i){for(let s=0;s<i.length;s++)if(mn(t,e,i[s])!=!s)return!1;return!0}pointInBox(t,e,i,s,r){for(let[n,o]of t){if(n>=e&&n<=i&&o>=s&&o<=r)return!0}}linesIntersectBox(t,e,i,s,r){const n=[[e,r],[i,r],[i,s],[e,s],[e,r]];for(let e=0,i=t.length-1;e<i;e++)for(let i=0;i<n.length-1;i++)if(b(t[e],t[e+1],n[i],n[i+1],!1))return!0}getOffsetLineData(t,e,i){let s=[];for(let r of e){const e=U("offset",r,t,i)||0;e&&s.find((t=>t.offset==e))||s.push({offset:e,width:.5*B("strokeWidth",r,t,i,!0)})}return s.length,s}geometry(t,e,i,s,r,n,o,a,l,h){let c=!1;const{dpr:u,map:d}=this,f=!t&&!e;let p=this.screenX,g=this.screenY,m=1;if("Point"==s){if(l=l||Z(r,o,a,u,n,h)){let s=i[0],n=i[1];const h=U("alignment",r[0],o,a);if(h&&"viewport"!=h)[s,n]=d._g2w(s,n),p=this.worldX,g=this.worldY,m=1/d._s;else{const t=d.geoToPixel(s,n);s=t.x,n=t.y}const u=s+l[0]*m,f=n+l[1]*m,v=s+l[2]*m,x=n+l[3]*m;c=y(p,p+t,g,g+e,u,v,f,x)}}else if("LineString"==s){l=l||N(r,o,a,n,h);let t=i.length,[e]=l;if(e)if(f){let e,s,n,h=d.geoToPixel(i[0][0],i[0][1]),u=this.getOffsetLineData(o,r,a);u.length||(e=Math.pow(.5*l[0],2));for(let r=1;r<t;r++){if(s=d.geoToPixel(i[r][0],i[r][1]),n=this.pointToLineDistanceSq(p,g,h.x,h.y,s.x,s.y),u.length){for(let t of u){const{offset:e,width:i}=t,s=Math.pow(e-this.sideOfLine*i,2);if(e){if(n>s){if(c=n-Math.pow(e+this.sideOfLine*i,2)<=i*i)break}}else if(c=n<=i*i)break}if(c)break}else if(c=n<=e)break;h=s}}else{const t=.5*l[0],e=d.pixelToGeo(p-t,g-t),s=d.pixelToGeo(p+t,g+t),r=e.longitude,n=s.longitude,o=s.latitude,a=e.latitude;if(c=this.pointInBox(i,r,n,o,a)||this.linesIntersectBox(i,r,n,o,a),!c)return!1}}else if("Polygon"==s){let s,u=!1;if(!r.find((t=>{const e=U("type",t,o,a),i="Line"==e,r="Polygon"==e;return u||(u=i),s||(s=!(i&&r)&&t),r}))){if(u){const s=this.geometry(t,e,i,"MultiLineString",r,n,o,a,null,h);if(s)return s}return s&&this.geometry(t,e,Q(s,o,a),"Point",r,n,o,a,null,h)}if(f){const{longitude:t,latitude:e}=d.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i),!c)return!1}else{const e=d.pixelToGeo(p-t,g-t),s=d.pixelToGeo(p+t,g+t),r=e.longitude,n=s.longitude,o=s.latitude,a=e.latitude;for(let t=0;t<i.length&&(c=this.pointInBox(i[t],r,n,o,a),!c);t++);if(!c){const{longitude:t,latitude:e}=d.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i)||this.linesIntersectBox(i[0],r,n,o,a),!c)return!1}}l=l||[G(r,o,a,n)]}else{let d,f;if("MultiPolygon"==s?(d="Polygon",l=l||[G(r,o,a,n)]):"MultiPoint"==s?(d="Point",l=l||Z(r,o,a,u,n)):"MultiLineString"==s&&(d="LineString",l=l||N(r,o,a,n)),d)for(let s=0,u=i.length;s<u;s++)if(f=this.geometry(t,e,i[s],d,r,n,o,a,l,h),f){c=!0;break}}return c&&l}init(t,e){this.screenX=t,this.screenY=e,[this.worldX,this.worldY]=this.map._unprj(t,e)}feature(t,e,i,s,r,n,o){return this.geometry(t,e,i.geometry.coordinates,i.geometry.type,s,r,i,n,null,o)}}const xn=Array.from({length:33},((t,e)=>32*Math.pow(2,Math.max(0,e-20+3)))),yn=t=>"number"==typeof t;class _n{constructor(t,e,i){this.map=t,this.layers=e,this.hit=new vn(t,i)}getFeaturesInRect(t,e,i,s,r,n){var o;const{map:a,hit:l}=this,h=a.getZoomlevel(),c=xn[Math.ceil(h)],u=0^Math.min(20,h),d={},f=(i-t)/2,p=(s-e)/2;let g=t+f,m=e+p,v=180,x=-180,y=180,_=-180;[t,e]=a._unprj(t,e),[i,s]=a._unprj(i,s);let b,w,M,T,S,A,L,z,P=[a._w2g(t-c,e-c),a._w2g(i+c,e-c),a._w2g(i+c,s+c),a._w2g(t-c,s+c)],C=4,E=[];for(;C--;){let t=P[C][0],e=P[C][1];t<v&&(v=t),t>x&&(x=t),e<y&&(y=e),e>_&&(_=e)}b=[v,y,x,_],r&&!Array.isArray(r)&&(r=[]),l.init(g,m);let I=r.length;for(;I--;){M=r[I],w=null===(o=M.getProvider)||void 0===o?void 0:o.call(M,h);const t=this.layers.get(M);if((null==w?void 0:w.search)&&M.isVisible(h))for(S=w.search(b),A=S.length;A--;)if(T=S[A],(L=t.processStyleGroup(T,u))&&(z=l.feature(f,p,T,L,I,h,n))){let t=z[z.length-1],e=d[t]=d[t]||[];(e[I]=e[I]||[]).push(T)}}const R={layer:null,features:null};for(let t of Object.keys(d).sort(((t,e)=>Number(t)-Number(e)))){let e=d[t];for(let t,i=0;i<e.length;i++)if(t=e[i]){const e=r[i];R.layer==e?R.features=R.features.concat(t):E.push({layer:e,features:t})}}return E}search(t,e,i,s,r,n){const{map:o}=this,a=o._layers;if(r=r?r.slice().sort(((t,e)=>Number(a.indexOf(t)>a.indexOf(e)))):a,yn(t)&&yn(e)&&yn(i)&&yn(s))return this.getFeaturesInRect(t,e,i,s,r,n)}}const bn=e.global.setTimeout,wn=e.global.setInterval,Mn="mapviewchange",Tn=Mn+"start",Sn=Mn+"end",An=1e3/30;let Ln=1e3/60;const zn=!0,Pn=(t,e,i)=>{let s;return"function"==typeof Event?s=new Event(t):(s=document.createEvent("Event"),s.initEvent(t,!0,!0)),s.detail=s.data={map:e,layer:i},s};class Cn{constructor(t,i,s){this.watchTimer=null,this.map=t,this.trigger=i,this.renderInfo=s,Ln=e.global.__XYZTST_MVCEDelayMs||Ln,this.changeWatcher=this.changeWatcher.bind(this),this.readyWatcher=this.readyWatcher.bind(this)}centerChanged(t){return this.center.longitude!=t.longitude||this.center.latitude!=t.latitude}vpChanged(t,e,i){const{viewport:s,rz:r,rx:n}=this;return!(s.minLon!=t.minLon||s.maxLon!=t.maxLon||s.minLat!=t.minLat||s.maxLat!=t.maxLat||r!=e||n!=i)}changeWatcher(){const{map:t,readyTimer:e,watchTimer:i,viewport:s,center:r}=this;let n=t.getViewBounds(),o=t.getCenter(),a=t.rotate(),l=t.pitch(),h=Mn,c={changed:{center:!0}};if(s){if(c.changed.center=this.centerChanged(o),this.vpChanged(n,a,l))return clearInterval(i),this.watchTimer=this.viewport=this.rz=this.rx=null,e&&clearTimeout(e),this.readyTimer=bn(this.readyWatcher,Ln);this.viewport=n,this.rz=a,this.rx=l,this.center=o}else this.triggeredLayers={},h=Tn,this.viewport=n,this.rz=a,this.center=o,this.endTriggered=!0;this.trigger(h,c,zn)}readyWatcher(){const{map:t,triggeredLayers:e}=this;let i,s,r,n=this.renderInfo.getLayers(),o=!0;if(this.endTriggered){this.endTriggered=!1;const e=t.getCenter();this.trigger(Sn,{changed:{center:this.centerChanged(e)}},zn)}for(let a=0;a<n.length;a++)if(s=n[a],i=s.layer,r=i.id,s.ready){if(!e[r]&&(e[r]=!0,!s.error)){let e=Pn("viewportReady",t,i);i._l.trigger("viewportReady",e,!0)}}else o=!1;o||(this.readyTimer=bn(this.readyWatcher,Ln))}watch(t){const{readyTimer:e,watchTimer:i}=this;e&&(clearTimeout(e),this.readyTimer=null),t?i||(this.watchTimer=wn(this.changeWatcher,An)):i&&(clearInterval(i),this.watchTimer=null)}}let En;class In{constructor(t,e,i,s){this._v=!0;let r=this;r.map=i,r.cPrefix=t.className+"-ui-",r.parent=t,r.opt=e,e.visible&&(r.create(t,e),r.enable())}show(){const t=this;t.html||t.create(t.parent,t.opt),t.html.style.display="inline"}hide(){const t=this.html;t&&(t.style.display="none")}enable(){this.active=!0,this.toggleListeners(!0)}disable(){this.active=!1,this.toggleListeners(!1)}destroy(){const t=this;t.disable(),t.parent.removeChild(t.html)}toggleListeners(t){const e=this,{listeners:i}=e;for(let s in i){const r=e.querySelectorAll(s);for(let n in i[s])r.forEach((r=>{const o=i[s][n];t?r.addEventListener(n,i[s][n]._=o.bind(e)):r.removeEventListener(n,o._)}))}}insertRule(t,e){En=En||function(){let t=document.createElement("style");return document.head.appendChild(t),t}();let i=En.sheet;i.insertRule?i.insertRule(t+" {"+e+"}",i.cssRules.length):i.addRule&&i.addRule(t,e)}create(t,e){let i=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix);i=i.replace(/\>[\s]+\</g,"><");let s=(r=i,(new DOMParser).parseFromString(r,"text/html").body.childNodes[0]);var r;let n=s.style,o=e.position,a="."+t.className+" ";for(let t in o)n[t]=o[t];if(this.style)for(let t in this.style)this.insertRule(a+this.prefixClass(t),this.style[t]);this.html=t.appendChild(s)}prefixClass(t){return t=t.replace(/\./g,"."+this.cPrefix)}querySelector(t){return this.html.querySelector(this.prefixClass(t))}querySelectorAll(t){return this.html.querySelectorAll(this.prefixClass(t))}}class Rn extends In{constructor(t,e,i,s){super(t,e,i),this.maxPitch=s.maxPitch}enable(){super.enable();const t=this.querySelector(".needle"),e=this.map;e.addEventListener("mapviewchange",this._rl=i=>{t.style.transform=`rotate(${e.rotate()}deg) rotateX(${Math.min(60,e.pitch())}deg) scale(0.7,1.1)`}),this._rl()}disable(){super.disable(),this.map.removeEventListener("mapviewchange",this._rl),this.a&&(this.a.stop(),this.a=null)}}Rn.prototype.listeners={".btn":{click:async function(t){if(!this.aip){const{map:t}=this,e=(t.rotate()+360)%360,i=t.pitch();let s=e<180?0:360,r=0;e||i||(r=this.maxPitch,s=0),this.a=new Qr([e,i],[s,r],500,"easeOutCubic",(e=>{t.rotate(e[0]),t.pitch(e[1])})),await this.a.start(),this.a=null}}}},Rn.prototype.style={".compass":"        position: absolute;        right:  10px;        bottom: 96px;        text-align: center;        font-family: sans-serif;        color: white;        height: 28px;        background-color: #0f1621;        user-select: none;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;        overflow: hidden;",".compass .needle":"        padding: 4px 0px;        line-height: 10px;",".compass .btn":"        width: 100%;        height: 100%;",".compass:hover":"        background-color: #383c45;        cursor: pointer;"},Rn.prototype.templ='<div class="compass">        <div class="btn">            <div class="needle">&#9650;<br>&#9661;</div>        </div>    </div>';class kn extends In{constructor(t,e,i,s){super(t,e,i),this.ams=250;let r=this;s&&s.zoomAnimationMs&&(r.ams=s.zoomAnimationMs)}enable(){super.enable();let t=this.querySelector(".info"),e=this.map;t.innerText=e.getZoomlevel(),e.addEventListener("mapviewchangeend",this._zll=function(i){t.innerText=Math.round(10*e.getZoomlevel())/10})}disable(){super.disable(),this.map.removeEventListener("mapviewchangeend",this._zll)}}kn.prototype.listeners={".zoomBtn":{click:function(t){let e=0^t.srcElement.getAttribute("dir");this.map.setZoomlevel(this.map.getZoomlevel()+e,this.ams)}}},kn.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},kn.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';class Fn extends In{constructor(t,e,i){super(t,e,i)}add(t){((t,e,i,s)=>{const r=document.createElement(t);e&&(r.className=e),i&&(r.innerText=i),s&&s.appendChild(r)})("div",this.prefixClass(".src").substr(1),"Â© "+t.label,this.html)}setData(t){const e=this;if(e.data=t,e.html){e.html.innerText="";for(let i of t)e.add(i)}}}Fn.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},Fn.prototype.templ='<div class="copyright-popup"></div>';const Dn=e.global.document,Un=!0,On=!1,Bn="addLayer removeLayer",Hn="zoomlevel",Gn=(t,e)=>{let i,s,r,n=t.scopes,o=n.length;if(!o)return Un;for(;i=n[--o];){const t=i.layer.getProvider(e),n=t&&t.level||e;if(s=i.minLevel||-1/0,r=i.maxLevel||1/0,n>=s&&n<=r)return Un}return On},Nn=(t,e)=>{t.style.display=e?"inline":"none"};const Wn={defaultOwner:"XYZ",termsAndConditions:{label:"Terms and Conditions",url:!1}};class Zn extends In{constructor(t,i,s){super(t,e.JSUtils.extend(!0,e.JSUtils.clone(Wn),i),s),this.sources=new e.Map,this.sLen=0,this.srcWidth=0;const r=this,{termsAndConditions:n,defaultOwner:o}=r.opt;r.$src=r.querySelector(".sources"),r.$cDefault=r.querySelector(".cDefault"),r.$btn=r.querySelector(".btn"),this.details=new Fn(t,{visible:!1},s),this.setDefaultOwner(o),this.setTermsAndConditions(n)}setTermsAndConditions(t){const{url:e,label:i}=t,s=this.querySelector(".terms");e?(s.lastChild.href=e,i&&(s.lastChild.innerText=i)):Nn(s,On)}setDefaultOwner(t){"string"==typeof t&&this.setOwnerLabel(this.$cDefault,t)}enable(){let t=this;super.enable(),t.map.addObserver(Hn,t.onZoomChange=(e,i,s)=>{if(Math.abs((0^i)-(0^s))){t.sources.forEach((t=>{Nn(t.el,Gn(t,i))})),t.showDetails(!1),t.handleOverflow()}}),t.map.addEventListener(Bn,t.onLayerChange=e=>{let i=e.detail.layer;i.getAttribution((s=>{t.active&&("addLayer"==e.type?s.forEach((e=>t.addSource(e,i))):s.forEach((e=>t.removeSource(e,i))))}))}),t.map.addEventListener("resize",t.onResize=()=>t.handleOverflow())}disable(){let t=this;super.disable(),t.map.removeObserver(Hn,t.onZoomChange),t.map.removeEventListener(Bn,t.onLayerChange),t.map.removeEventListener("resize",t.onResize)}getSourceLabelsString(){const t=0^this.map.getZoomlevel();let e="";for(let i of this.sources.values())Gn(i,t)&&(e+=`${this.formatLabel(i.label)} `);return e}getColors(){return{color:window.getComputedStyle(this.$cDefault).getPropertyValue("color"),backgroundColor:window.getComputedStyle(this.html).getPropertyValue("background-color")}}calcWidth(){const t=0^this.map.getZoomlevel(),e=this.sources;let i=0;return e.forEach((e=>{i+=Gn(e,t)&&e.width})),i}handleOverflow(){const t=this,e=t.$btn,i=t.map.getWidth(),s=t.calcWidth(),r=i-132^0;t.$src.style.width=(r<s?r-10:s)+"px",s>Math.min(r,384)?Nn(e,Un):(Nn(e,On),t.showDetails(!1))}showDetails(t){const e=this,i=e.details,s=e.map.getZoomlevel();e.$btn.innerText=t?"-":"+",t?(i.show(),i.setData(e.sources.values().filter((t=>Gn(t,s))))):i.hide()}formatLabel(t){return t.startsWith("Â©")?t:"Â© "+t}setOwnerLabel(t,e,i,s){e=this.formatLabel(e),s?t.innerHTML=`<a href='${s}' target='_blank' rel='noopener noreferrer'>${e}</a>`:t.innerText=e,i&&(t.setAttribute("title",i),t.setAttribute("aria-label",i))}addSource(t,e){const i=this,s=i.sources,r=t.label,n=t.scopes,o=0^i.map.getZoomlevel();let a,l=s.get(r);l?(a=l.el,l.cnt++):(a=Dn.createElement("span"),a.className=this.prefixClass(".source").substr(1),i.setOwnerLabel(a,r,t.alt,t.url),i.$src.appendChild(a),l={label:r,scopes:[],el:a,cnt:1,width:a.getBoundingClientRect().width},s.set(r,l),i.sLen++,i.srcWidth+=l.width),null!=n&&n.forEach((t=>l.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e}))),Nn(i.$cDefault,On),Nn(a,Gn(l,o)),i.handleOverflow()}removeSource(t,e){const i=this,s=t.label,r=i.sources.get(s);let n,o;if(r){if(o=r.scopes,n=t.scopes)for(let t,i=0;i<n.length;i++){t=n[i];for(let s,r=0;i<o.length;r++)if(s=o[r],s.layer==e&&s.minLevel==t.minLevel&&s.maxLevel==t.maxLevel){o.splice(r,1);break}}--r.cnt||(i.$src.removeChild(r.el),i.sources.delete(s),i.handleOverflow(),--i.sLen||Nn(i.$cDefault,Un))}}}Zn.prototype.listeners={".btn":{click:function(t){const e="+"==this.$btn.innerText;this.showDetails(e)}}},Zn.prototype.style={".copyright *":"        color: rgba(255,255,255,.8);        font-family: arial;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".copyright .btn":"        display: none;        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".terms, .cDefault, .source":"        white-space: nowrap;        padding-right: 4px;"},Zn.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="cDefault"></span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="terms" style="white-space: nowrap;">|            <a target="_blank" style="white-space: nowrap;" href="">Terms and Conditions</a></span>        </span>    </div>';class Yn extends In{constructor(t,e,i){super(t,e,i);const{url:s}=e;s&&this.setSrc(s)}setSrc(t){this.html.style.backgroundImage=`url(${t})`}getImage(){const t=window.getComputedStyle(this.html),e=Math.round(parseFloat(t.getPropertyValue("width"))),i=Math.round(parseFloat(t.getPropertyValue("height")));return new Promise((s=>{const r=new Image;r.onload=()=>s({img:r,width:e,height:i}),r.src=t.getPropertyValue("background-image").slice(5,-2)}))}}Yn.prototype.style={".logo":"        position: absolute;        bottom: 6px;        left: 6px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjdweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMjcgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzA0QjZDOCIgcG9pbnRzPSItNy44NjQyMTYxOWUtMTQgOSAxMyAxNS45Njg4NjgxIDEzIDMyIDAgMjQuNDc4MDIyNiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzBBNTdENCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAuNTAwMDAwLCAyMC41MDAwMDApIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjUwMDAwMCwgLTIwLjUwMDAwMCkgIiBwb2ludHM9IjE0IDkgMjcgMTUuOTY4ODY4MSAyNyAzMiAxNCAyNC40NzgwMjI2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTIiIGZpbGw9IiMwQTk0REUiIHBvaW50cz0iMCA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMCAyNyA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMTUiPjwvcG9seWdvbj4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==);        background-repeat: no-repeat;        background-size: contain;        width: 32px;        height: 32px;        cursor: pointer;"},Yn.prototype.templ='<div class="logo"></div>';const Vn={Compass:Rn,ZoomControl:kn,Copyright:Zn,Logo:Yn};let Xn;class jn{constructor(t,e,i){const s=Object.assign({},e.UI||e.ui||{}),r=this.components={};this.el=t,s.HERE!=Xn&&(s.Logo=s.HERE);for(let n in Vn){let o=s[n];!1!==o&&("object"!=typeof o&&(o={}),o.visible==Xn&&(o.visible=!0),o.visible&&(r[n]=new Vn[n](t,o,i,e)))}}static initComponentOptions(){}get(t){return this.components[t]}destroy(){const{components:t}=this;for(let e in t)t[e].destroy(),delete t[e]}}const{isFunction:qn}=e.JSUtils;class $n{constructor(t={}){this.animation=null;let e=this;this.easing=t.easing,qn(t.onStart)&&(e.onStart=t.onStart),qn(t.onStop)&&(e.onStop=t.onStop)}onStart(){}onStop(){}async animate(t,e,i,s){const r=this;r.active||(r.active=!0,r.onStart(),r.animation=new Qr(t,e,i,this.easing,s),await r.animation.start(),r.onStop(),r.active=!1,r.animation=null)}stop(){var t;null===(t=this.animation)||void 0===t||t.stop(),this.active=!1}}class Kn extends $n{constructor(t,e={}){e.easing=e.easing||"easeOutCubic",super(e),this.map=t}start(t,e,i,s){const{map:r}=this;this.animate(r.getZoomlevel(),t,s,(t=>{r.setZoomlevel(t,e,i)}))}}const Qn=e.JSUtils.isFunction;class Jn{constructor(t,e){e=e||{};const i=this;i.map=t,i.duration=e.duration||500,Qn(e.onStart)&&(i.onStart=e.onStart),Qn(e.onStop)&&(i.onStop=e.onStop),i.raf=()=>{i._pan()&&(i.rafId=requestAnimationFrame(i.raf))}}_pan(){const t=this,e=t.deltaX,i=t.deltaY,s=t.duration,r=t.startTs,n=Math.min(Date.now()-r,s)/s,o=$r(n)*e,a=$r(n)*i;if(t.map.pan(o-t.lastDx||0,a-t.lastDy||0),o!=e||a!=i)return t.lastDx=o,t.lastDy=a,!0;t.onStop()}pan(t,e,i){this.startTs=t,this.deltaX=e,this.deltaY=i,this.onStart(),this.raf()}cancel(){const t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0}onStart(){}onStop(){}}const to={ui:{},behavior:{drag:!0,pitch:!1,rotate:!1},rotate:0,pitch:0,zoomlevel:18,center:{longitude:8.534,latitude:50.162},layers:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,minRotateMapThreshold:4,minPitchMapThreshold:4,zoomAnimationMs:100,maxPitch:50,singleWorldView:!1,cameraTerrainOffset:200};class eo extends $n{constructor(t,e={}){e.easing=e.easing||"easeOut",super(e),this.map=t}start(t,e,s){const{map:r}=this,n=r.getZoomlevel(),o=r._worldSizeFixed,a=r.getCenter(),l=i.webMercator.lon2x(a.longitude,o),h=i.webMercator.lat2y(a.latitude,o),c=i.webMercator.lon2x(t.longitude,o),u=i.webMercator.lat2y(t.latitude,o),d=Math.max(r.getWidth(),r.getHeight()),f=d/Math.pow(2,e-n),p=_(c,u,l,h)||1,g=1.42,m=2.0164,v=t=>(Math.exp(t)-Math.exp(-t))/2,x=t=>(Math.exp(t)+Math.exp(-t))/2,y=t=>{const e=(f*f-d*d+(t?-1:1)*m*m*p*p)/(2*(t?f:d)*m*p);return Math.log(Math.sqrt(e*e+1)-e)},b=y(0),w=t=>{return d*(x(b)*(v(e=b+g*t)/x(e))-v(b))/m;var e},M=(y(1)-b)/g,T=d*Math.pow(2,n);s=s||1e3*M*.77,this.animate(0,M,s,(s=>{const a=w(s)/p,f=l+(c-l)*a,m=h+(u-h)*a;let v,y;s>=M?(v=t,y=e):(v=new i.GeoPoint(i.webMercator.x2lon(f,o),i.webMercator.y2lat(m,o)),y=Math.log(T/(t=>d*(x(b)/x(b+g*t)))(s))/Math.LN2,y=isNaN(y)?n:y),r.setZoomlevel(y),r.setCenter(v)}))}}class io{constructor(t,e){this.map=t,this._prevCamPos={longitude:0,latitude:0,altitude:0},this._prevTime=null,this._camTerrainSmoothedAltitude=null,this._options=e}computeCamSpeed(t){const e=performance.now()/1e3;let i=0;if(null!=this._prevTime){const s=e-this._prevTime;if(s>0){const e=t.longitude-this._prevCamPos.longitude,r=t.latitude-this._prevCamPos.latitude,n=t.altitude-this._prevCamPos.altitude;i=Math.sqrt(e*e+r*r+n*n)/s}}return this._prevCamPos.longitude=t.longitude,this._prevCamPos.latitude=t.latitude,this._prevCamPos.altitude=t.altitude,this._prevTime=e,i}getTerrainHeightAtGeo(t,e){const i=this.map,s=i.geoToPixel(t,e),r=i._unprj(s.x,s.y);return i._getTerrainAtWorldXY(r[0],r[1])}ensureAboveTerrain(){if(this._camTerrainGuard)return null;const t=this.map,e=t.getCamera().position,i=this.getTerrainHeightAtGeo(e.longitude,e.latitude);if(null==i)return;let s=this._camTerrainSmoothedAltitude;if(null==s)s=i;else{const t=.85;s=s*t+i*(1-t)}this._camTerrainSmoothedAltitude=s;const r=s+this._options.cameraTerrainOffset,n=r-e.altitude;if(n>2){this._camTerrainGuard=!0;const i=n>5?r:e.altitude+.2*n;return t.setAltitude(i),this._camTerrainGuard=!1,r}return null}}const so=i.webMercator,ro=i.webMercator.earthCircumference;let no="fixed";const oo=180,ao=-180,lo=85.05112878,ho=-85.05112878,co=256,uo="longitude",fo="latitude",po="zoom",go="pitch",mo="rotate",vo="addLayer",xo="removeLayer";let yo,_o=[];let bo=class{constructor(t,s){this._s=1,this._rz=0,this._rx=0,this._cWorldFixed=new i.PixelPoint(0,0),this._c=new i.GeoPoint(0,0),this._pc=new i.GeoPoint(0,0),this._ox=0,this._oy=0,this._cfg=s=e.JSUtils.extend(!0,e.JSUtils.extend(!0,{},to),s||{});const r=this;r.id=1e6*Math.random()^0;const n=document.createElement("div");n.className="_"+e.JSUtils.String.random(11),n.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",n.style.position="relative",t.appendChild(n),this._el=n,this.resize();const o=s.zoomLevel||s.zoomlevel;s.maxLevel=Math.min(28,s.maxLevel),s.maxPitch=Math.min(85,s.maxPitch),this._z=0^Math.min(20,o),this._worldSizeFixed=Math.pow(2,this._z)*co,this._worldSize=Math.pow(2,o)*co,this._l=new e.Listener(["center","rotation","zoomlevel","pitch","mapviewchangestart","mapviewchange","mapviewchangeend","resize",vo,xo]);let a=this._l,l=[];r._layers=l;const h="canvas"==s.renderer?Vr:ur;"string"==typeof h.zoomBehavior&&(no=h.zoomBehavior);const c=new h(n,256,s.devicePixelRatio,s.renderOptions||{});r._mvListener=new Cn(r,(function(t,e,i){a.trigger(t,[new sn(t,e)],i)}),c),r._display=c,this._camController=new io(r,s),this.setBackgroundColor(s.backgroundColor),this._search=new _n(r,c.layers,c.dpr);const u=this._evDispatcher=new gn(n,r,l,s);a.add("mapviewchangestart",(t=>u.disable("pointerenter"))),a.add("mapviewchangeend",(t=>u.enable("pointerenter"))),a.add("mapviewchangeend",(t=>c.viewChangeDone())),this._zoomAnimator=new Kn(r),this._flightAnimator=new eo(r);const d=Object.assign(Object.assign({},s.behavior),s.behaviour);d[po]==yo&&(d[po]=no);let f=this._b=new en(n,r,new Jn(r),d,s);f.drag(!0),f.scroll(!0),this._vplock={pan:!1,minLevel:s.minLevel,maxLevel:s.maxLevel};const p=s.UI||s.ui||{};p.Compass==yo&&(p.Compass=d[mo]||d[go]),this.ui=new jn(n,s,r),r.setCenter(s.center),r.pitch(s.pitch),r.rotate(s.rotate),r.setZoomlevel(o),r._layerChangeListener=r._layerChangeListener.bind(r),r._onTerrainReadyListener=t=>{this._ensureCamAboveTerrain()};for(let t of s.layers||[])r.addLayer(t);_o.push(this),s.debug&&this.debug(s.debug)}static getInstances(){return _o.slice()}get _cWorld(){const t=this._worldSize/this._worldSizeFixed;return new i.PixelPoint(this._cWorldFixed.x*t,this._cWorldFixed.y*t)}_layerChangeListener(t){var e;this.refresh(null!==(e="clear"===t.type)&&void 0!==e?e:t.detail.layer)}initViewPort(){const t=this._s,e=this._worldSizeFixed,s=this._cWorldFixed.x,r=this._cWorldFixed.y,n=this._w/2,o=this._h/2,a=s-n/t,l=r-o/t;this._tlwx=s-n,this._tlwy=r-o,this._ox=s-n/t-a,this._oy=r-o/t-l;let h=so.x2lon(a,e),c=so.y2lat(l,e),u=s+n/t,d=r+o/t,f=so.x2lon(u,e),p=so.y2lat(d,e);return this._vp=new i.GeoRect(h,p,f,c),[s/e,r/e]}updateGrid(){const t=this._display,e=this._c,i=this._pc;this._mvListener.watch(!0),this._groundResolutionFixed=ro(e.latitude)/this._worldSizeFixed,t.setView(this.initViewPort(),this._s,this._rz,this._rx,this._groundResolutionFixed,this._worldSize);const s=this.getZoomlevel();for(let t of this._layers)t._initZoom(s);t.updateGrid(this._z,s,this._ox,this._oy),i[uo]==e[uo]&&i[fo]==e[fo]||(this._l.trigger("center",["center",e,i],!0),this._pc=e),this._ensureCamAboveTerrain()}_ensureCamAboveTerrain(){this._terrainLayer&&this._camController.ensureAboveTerrain()}_getTerrainAtWorldXY(t,e){return this._display.getTerrainHeightAtWorldXY(t,e,this._terrainLayer)}_clipLatitude(t){return Math.min(lo,Math.max(ho,t))}_setCenter(t,e){const s=this._worldSizeFixed,r=this._worldSize;if(2!=arguments.length&&(t instanceof Array?(e=t[1],t=t[0]):(e=(t=t||this._c)[fo],t=t[uo])),isNaN(t)||isNaN(e)||"number"!=typeof t||"number"!=typeof e)return!1;if(t>oo?t-=360:t<ao&&(t+=360),e=this._clipLatitude(e),!this._repeatWorldViewX){const e=360/r*this._w*.5,i=t-e,s=t+e;i<-180&&(t-=i%180),s>180&&(t-=s%180)}if(this._cWorldFixed=new i.PixelPoint(so.lon2x(t,s),so.lat2y(e,s)),this._maxZoomExtent){const t=(r/this._h-1)*this._h*.5,i=r/s,n=this._cWorldFixed.y*i,o=r/2;let a=0;const l=n+t;l<o&&(a=l);const h=n-t;h>o&&(a=h),a&&(this._cWorldFixed.y+=(o-a)/i,e=so.y2lat(this._cWorldFixed.y,s))}return this._c=new i.GeoPoint(t,e),!0}calculateMaxZoomExtent(){return Math.max(Math.log2(this._h/co),Math.log2(this._w/co))}repaint(){this.updateGrid()}debug(t){this._display.showGrid(t),this.updateGrid()}pitch(t){if(t!==yo){const e=this._cfg.maxPitch,i=(t=Math.max(0,Math.min(e,Math.round(t%360*10)/10)))*Math.PI/180,s=this._rx;s!=i&&(this._rx=i,this.updateGrid(),this._l.trigger("pitch",["pitch",t,180*s/Math.PI],!0))}return 180*this._rx/Math.PI}rotate(t){if(t!==yo){const e=Math.round(10*t||0)/10,i=e*Math.PI/180,s=this._rz;if(i!==s){const t=this._cx,r=this._cy,n=this._display.unproject(t,r),o=this._cWorldFixed;o.x+=n[0]-t,o.y+=n[1]-r,this._rz=i,this.updateGrid(),this._l.trigger("rotation",["rotation",e,s/Math.PI*180],!0)}}return this._rz/Math.PI*180}setBackgroundColor(t){this._display.setBGColor(t),this.refresh()}addEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.add(t,e);this._evDispatcher.addEventListener(t,e)}))}removeEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.remove(t,e);this._evDispatcher.removeEventListener(t,e)}))}getViewBounds(){let t=this._vp,e=t.minLon,s=t.maxLon,r=t.minLat,n=t.maxLat;return r<=ho&&(r=-90),n>=lo&&(n=90),e<ao&&(e=ao),s>oo&&(s=oo),new i.GeoRect(e,r,s,n)}setViewBounds(t,e){const s=arguments;let r,n,o,a;if("number"==typeof t?t=[s[0],s[1],s[2],s[3]]:"FeatureCollection"==t.type?t=t.features:"Feature"==t.type&&(t=[t]),Array.isArray(t)){if("object"==typeof t[0]){const e=[1/0,1/0,-1/0,-1/0];for(let s of t)i.utils.calcBBox(s,e);t=e}r=t[0],n=t[1],o=t[2],a=t[3]}else{const e=t;r=e.minLon,n=e.minLat,o=e.maxLon,a=e.maxLat}const l=function(t,e,i,s,r,n){let o,a,l,h=Math.pow(2,20)*co;for(let c=20;c>=0;--c)if(l=20-c,o=(so.lon2x(i,h)>>l)-(so.lon2x(t,h)>>l),a=(so.lat2y(e,h)>>l)-(so.lat2y(s,h)>>l),o<=r&&a<=n)return c;return 0}(r,n,o,a,this.getWidth(),this.getHeight()),h=new i.GeoPoint(r+(o-r)/2,n+(a-n)/2);e?this.flyTo(h,l,!0===e?{}:e):(this.setZoomlevel(l),this.setCenter(h))}getFeatureAt(t,e){e=e||{};const i=this.getFeaturesAt(t,e);if(i.length){const t=i[i.length-1];return t.feature=t.features[0],t}}getFeaturesAt(t,e){var s;let r,n,o,a,l=!1;e=e||{};let{layers:h}=e;if(h&&!Array.isArray(h)&&(h=[h]),t.x!=yo&&t.y!=yo){let c=t.x,u=t.y,d=0^e.width,f=e.height||d;if(!d&&!f){l=!0;const t=this._display.getRenderedFeatureAt(c,u,h);if(null!=t.id){const{layer:e}=t,r=e.getProvider(0^this.getZoomlevel()),n=null===(s=null==r?void 0:r.search)||void 0===s?void 0:s.call(r,t.id);if(n){const{pointWorld:s}=t;let r=null;if(s){const t=this._w2g(s[0],s[1],s[2]);r=new i.GeoPoint(t[0],t[1],t[2])}return[{layer:e,features:[n],intersectionPoint:r}]}}}r=c-d/2,n=c+d/2,o=u-f/2,a=u+f/2}else t.minX!=yo&&t.maxX!=yo&&(r=t.minX,o=t.minY,n=t.maxX,a=t.maxY);return r!=yo&&this._search.search(r,o,n,a,h,l)}snapshot(t,e,i,s,r){if(!t)return;e||(e=0),i||(i=0),s||(s=this._w),r||(r=this._h),s+e>this._w&&(s=this._w-e),r+i>this._h&&(r=this._h-i);const n=this._display,{dpr:o}=n,a=n.copyCanvas2d(e,i,s,r),l=Math.ceil(11/3),h=this.ui.get("Copyright"),c=h.getSourceLabelsString(),u=h.getColors(),d=h.calcWidth();(async()=>{const e=await this.ui.get("Logo").getImage(),i=a.getContext("2d");i.scale(o,o),i.font="11px sans-serif",i.textBaseline="hanging",i.fillStyle=u.backgroundColor,i.fillRect(s-d-2*l,r-11-l,s+2*l,11+l),i.fillStyle=u.color,i.fillText(c,s-d-l,r-11),i.drawImage(e.img,2*l,r-e.height-2*l),a.style.width=`${s}px`,a.style.height=`${r}px`,t(a)})()}getBehavior(){const t={},e=this._b.getOptions();for(let i in e)t[i]=!!e[i];return t}setBehavior(t,e){let i=typeof t,s="object"==i?t:{};const r=this._b.getOptions();"string"==i&&(s[t]=e);let n=s[po];n!=yo&&(r[po]="fixed"==n||"float"==n?n:!!n&&no);for(let t of["drag",go,mo]){let e=s[t];e!=yo&&(r[t]=!!e)}}getZoomlevel(){return this._z+Math.log(this._s)/Math.LN2}setZoomlevel(t,e,i,s){const r=this._vplock,n=this._z,o=this._s;if(t=Math.round(1e3*t)/1e3,t=Math.max(Math.min(t,r.maxLevel),r.minLevel,this._maxZoomExtent),2==arguments.length&&(s=e,e=yo),e!=yo&&i!=yo||(e=this._cx,i=this._cy),n!=t||1!=o)if(this._worldSize=Math.pow(2,t)*co,s)this._zoomAnimator.start(t,e,i,"number"==typeof s?s:250);else{const s=this.getZoomlevel(),r=this._display.unproject(e,i),o=0^Math.min(20,t),a=n-o,l=this._worldSizeFixed,h=Math.pow(2,t-o);a&&(this._z=0^Math.min(20,t),this._worldSizeFixed=Math.pow(2,this._z)*co),this._display.setView(this.initViewPort(),h*Math.pow(.5,a),this._rz,this._rx,this._groundResolutionFixed,this._worldSize);const c=this._display.unproject(e,i);this._setCenter(so.x2lon(this._cWorldFixed.x+r[0]-c[0],l),so.y2lat(this._cWorldFixed.y+r[1]-c[1],l)),this._s=h,this.updateGrid(),this._l.trigger("zoomlevel",["zoomlevel",this.getZoomlevel(),s],!0)}}setAltitude(t,e=0){const i=this.getCamera().position,s=this._altToZoom(t),r=this.geoToPixel(i.longitude,i.latitude,0);this.setZoomlevel(s,r.x,r.y,e)}_altToZoom(t){const e=this.getZoomlevel(),i=this.getCamera().position;return e+Math.log2(i.altitude/t)}setCenter(t,e){this._setCenter.apply(this,arguments)&&this.updateGrid()}getCenter(){return new i.GeoPoint(this._c.longitude,this._c.latitude)}flyTo(t,e,i){e&&"object"!=typeof e||(i=e,e=this.getZoomlevel()),this._flightAnimator.stop(),this._flightAnimator.start(t,e,null==i?void 0:i.duration)}lockViewport(t){const e=this._vplock;if(t){let i=t.pan,s=t.minLevel,r=t.maxLevel;s=!1===s?this._cfg.minLevel:s,r=!1===r?this._cfg.maxLevel:r,i!=yo&&(e.pan=i),"number"==typeof s&&(e.minLevel=s),"number"==typeof r&&(e.maxLevel=r)}return e}pan(t,e){if(0!=t||0!=e){const i=this._worldSizeFixed,s=this._cx,r=this._cy,n=this._cWorldFixed,o=this._display.unproject(s+t,r+e),a=n.x-o[0]+s,l=n.y-o[1]+r;this.setCenter(so.x2lon(a,i),so.y2lat(l,i))}}getLayers(t){const e=this._layers;return t!=yo?e[t]:e.slice()}addLayer(t,e){var s,r;const n=this._layers;if(-1==n.indexOf(t)){if(e==yo&&(e=n.length),t instanceof i.TerrainTileLayer){if(this._terrainLayer)throw new Error("Only one TerrainTileLayer instance can be added to the MapDisplay. Please ensure you add a single terrain layer to avoid conflicts.");this._terrainLayer=t,t.addEventListener("viewportReady",this._onTerrainReadyListener)}this._display.addLayer(t,e,null===(r=(s=t).getStyleManager)||void 0===r?void 0:r.call(s)),t.addEventListener("clear",this._layerChangeListener),t.addEventListener("layerVisibilityChange",this._layerChangeListener);const o={index:e,layer:t,map:this,context:this._display.getContext(),canvas:this._display.canvas};t.dispatchEvent("layerAdd",o),this._l.trigger(vo,[new sn(vo,o)]),n.splice(e,0,t),this.updateGrid()}}removeLayer(t){const e=this._layers,s=e.indexOf(t);s>=0&&(t instanceof i.TerrainTileLayer&&(this._terrainLayer=null,t.removeEventListener("viewportReady",this._onTerrainReadyListener)),this._display.removeLayer(t),t.removeEventListener("clear",this._layerChangeListener),t.removeEventListener("layerVisibilityChange",this._layerChangeListener),e.splice(s,1),this.updateGrid(),this._l.trigger(xo,[new sn(xo,{index:s,layer:t})]))}refresh(t){t instanceof Array||(t=[t]);for(let e of t)e instanceof i.TileLayer&&this._display.clearLayer(e);this.updateGrid()}pixelToGeo(t,e){1==arguments.length&&(e=t.y,t=t.x);const s=this._unprj(t,e),[r,n]=this._w2g(s);return new i.GeoPoint(r,n)}_unprj(t,e,i){Array.isArray(t)&&([t,e,i]=t);const s=this._ox,r=this._oy,n=this._display.unproject(t,e,i);return n[0]+=s,n[1]+=r,n}_w2g(t,e,i){Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]);const s=this._worldSizeFixed;let r=t+this._tlwx,n=e+this._tlwy;return r%=s,n%=s,n<0&&(n+=s),[so.x2lon(r,s),so.y2lat(n,s),i]}geoToPixel(t,e,s){e==yo&&(s=t.altitude,e=t.latitude,t=t.longitude);let[r,n]=this._g2w(t,e);return[r,n]=this._prj([r,n,s||0]),new i.PixelPoint(r,n)}_g2w(t,e,i){Array.isArray(t)&&([t,e,i]=t),e=this._clipLatitude(e);const s=this._worldSizeFixed,r=this._tlwx,n=this._tlwy;return[so.lon2x(t,s)-r,so.lat2y(e,s)-n,i||0]}_prj(t){return this._display.project(t[0],t[1],t[2])}getCamera(){let t,e,i=0;if(this._display instanceof ur){const s=this._display.render.cameraWorld,r=this._w2g(s[0],s[1],s[2]);t=r[0],e=r[1],i=r[2]}else t=this._c.longitude,e=this._c.latitude;return{position:{longitude:t,latitude:e,altitude:i}}}_translateGeoCoord(t,e,i,s){const r=this,n=r._groundResolutionFixed/r._s;let[o,a,l]=t;if(l+=s*n,e||i){const[t,s,n]=r._g2w(o,a,l);[o,a,l]=r._w2g([t+e,s+i,n])}return[o,a,l]}_scaleOffsetXYByAltitude(t,e){return(e?1:this._display.scaleOffsetXYByAltitude(t))/this._s}destroy(){const t=this._el;this.ui.destroy(),this._layers.forEach((t=>this.removeLayer(t))),this._display.destroy(),t.parentNode.removeChild(t),this._mvListener.watch(!1),this._evDispatcher.destroy(),this._b.drag(!1),this._b.scroll(!1);const e=this;e.__proto__=null,Object.keys(e).forEach((t=>delete e[t])),_o.splice(_o.indexOf(e),1)}resize(t,e){const i=this._el;t!=yo&&e!=yo||(t=n(i.parentNode,"width"),e=n(i.parentNode,"height"));const{_w:s,_h:r}=this;if(s!==t||r!==e){i.style.width=t+"px",i.style.height=e+"px",this._w=t,this._h=e,this._cx=t/2,this._cy=e/2;const{singleWorldView:s}=this._cfg;this._maxZoomExtent=s?this.calculateMaxZoomExtent():0,this._repeatWorldViewX=!s||"latitude"===s,this._display&&(this._display.setSize(t,e),this.setZoomlevel(this.getZoomlevel()),this.updateGrid(),this._l.trigger("resize",[new sn("resize",{width:t,height:e})]))}}getWidth(){return this._w}getHeight(){return this._h}addObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.add(t,e)}removeObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.remove(t,e)}getContainer(){return this._el.parentNode}getTerrainPointAt(t){var e;const i=this._terrainLayer;return i&&(null===(e=this.getFeatureAt(t,{layers:i}))||void 0===e?void 0:e.intersectionPoint)||null}};bo.fillZoomMap=D;class wo{constructor(t={}){var e,i,s;this.running=!1,this.paused=!1,this.pauseOffset=0,this.startTime=0,this.rafId=null,this.duration=null!==(e=t.duration)&&void 0!==e?e:1e3,this.loop=null!==(i=t.loop)&&void 0!==i&&i,this.easing=null!==(s=t.easing)&&void 0!==s?s:qr}start(){this.running=!0,this.paused=!1,this.pauseOffset=0,this.startTime=performance.now(),this.rafId=requestAnimationFrame(this.frame.bind(this))}pause(){this.running&&!this.paused&&(this.paused=!0,this.pauseOffsetStart=performance.now())}resume(){this.running&&this.paused&&(this.paused=!1,null!=this.pauseOffsetStart&&(this.pauseOffset+=performance.now()-this.pauseOffsetStart,this.pauseOffsetStart=void 0))}cancel(){this.running=!1,null!=this.rafId&&cancelAnimationFrame(this.rafId)}isRunning(){return this.running&&!this.paused}onComplete(t){this.onCompleteCb=t}complete(){return new Promise((t=>{this.onComplete((()=>t()))}))}frame(t){var e;if(!this.running)return;if(this.paused)return void(this.rafId=requestAnimationFrame(this.frame.bind(this)));const i=t-this.startTime-this.pauseOffset;let s=Math.max(0,Math.min(1,i/this.duration));s=this.easing(s),this.updateFrame(s),i>=this.duration?this.loop?(this.startTime=performance.now(),this.pauseOffset=0,this.rafId=requestAnimationFrame(this.frame.bind(this))):(this.running=!1,null===(e=this.onCompleteCb)||void 0===e||e.call(this)):this.rafId=requestAnimationFrame(this.frame.bind(this))}updateFrame(t){}}const Mo=(t,e,i)=>t*(1-i)+e*i,To=(t,e,i)=>[Mo(t[0],e[0],i),Mo(t[1],e[1],i)];const So={scale:Re,rotate:function(t,e,i,s){var r,n,o,a,l,h,c,u,d,f,p,g,m,v,x,y,_,b,w,M,T,S,A,L,z=s[0],P=s[1],C=s[2],E=Math.hypot(z,P,C);return E<ve?null:(z*=E=1/E,P*=E,C*=E,r=Math.sin(i),o=1-(n=Math.cos(i)),a=e[0],l=e[1],h=e[2],c=e[3],u=e[4],d=e[5],f=e[6],p=e[7],g=e[8],m=e[9],v=e[10],x=e[11],y=z*z*o+n,_=P*z*o+C*r,b=C*z*o-P*r,w=z*P*o-C*r,M=P*P*o+n,T=C*P*o+z*r,S=z*C*o+P*r,A=P*C*o-z*r,L=C*C*o+n,t[0]=a*y+u*_+g*b,t[1]=l*y+d*_+m*b,t[2]=h*y+f*_+v*b,t[3]=c*y+p*_+x*b,t[4]=a*w+u*M+g*T,t[5]=l*w+d*M+m*T,t[6]=h*w+f*M+v*T,t[7]=c*w+p*M+x*T,t[8]=a*S+u*A+g*L,t[9]=l*S+d*A+m*L,t[10]=h*S+f*A+v*L,t[11]=c*S+p*A+x*L,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},translate:Ie,create:ze,identity:Pe},Ao={transformMat4:Le},Lo=e.global.here.xyz.maps;Lo.Map=bo,Lo.styleTools=J,t.FollowPathAnimationController=class extends wo{constructor(t,i,s={}){var r,n,o,a,l,h,c,u,d,f;null!==(r=s.duration)&&void 0!==r||(s.duration=5e3),super(s),this.totalLen=0,this.lastBearing=0,this.display=t,this.coords=i,this.speed=s.speed,this.autoRotate=null===(n=s.autoRotate)||void 0===n||n,this.headingSmoothing=null!==(o=s.headingSmoothing)&&void 0!==o?o:.95,this.mode=null!==(a=s.mode)&&void 0!==a?a:"drone",this.altitude=null!==(l=s.altitude)&&void 0!==l?l:"drone"===this.mode?5e3:0,this.cameraOffset=null!==(h=s.cameraOffset)&&void 0!==h?h:[0,0],this.lookAheadMeters=null!==(c=s.lookAheadMeters)&&void 0!==c?c:0,this.segLens=[0];for(let t=0;t<this.coords.length-1;t++)this.segLens.push(this.segLens[t]+e.geotools.distance(this.coords[t],this.coords[t+1]));this.totalLen=this.segLens[this.segLens.length-1],this.lastBearing=e.geotools.calcBearing(this.coords[0],this.coords[1]),this.speed&&this.speed>0&&(this.duration=this.totalLen/this.speed*1e3),this.pitch="car"===this.mode?85:"drone"===this.mode?50:(u=s.pitch,d=0,f=85,Math.max(d,Math.min(f,u)))}updateFrame(t){const i=t*this.totalLen,{i:s,t:r}=this.locateAlong(i),n=this.coords[s],o=this.coords[Math.min(s+1,this.coords.length-1)],a=To(n,o,r);let l=(null!=n[2]&&null!=o[2]?n[2]+(o[2]-n[2])*r:0)+this.altitude;this.display.setAltitude(l);let h,c=a;if("drone"===this.mode&&this.cameraOffset&&(c=e.geotools.movePoint(a,this.cameraOffset[0],this.lastBearing),l+=this.cameraOffset[1]),t>=1)h=this.lastBearing;else{const t=Math.min(i+Math.max(1,this.lookAheadMeters),this.totalLen-.001),{i:s,t:r}=this.locateAlong(t),n=this.coords[s],o=this.coords[Math.min(s+1,this.coords.length-1)],l=To(n,o,r);h="car"===this.mode?e.geotools.calcBearing(c,l):e.geotools.calcBearing(a,l)}const u=(d=this.lastBearing,f=h,p=1-this.headingSmoothing,(d+((f-d+540)%360-180)*(p=Math.max(0,Math.min(1,p)))+360)%360);var d,f,p;this.lastBearing=u,this.display.setCenter(c[0],c[1]),this.display.pitch(this.pitch),this.autoRotate&&this.display.rotate((360-u)%360)}locateAlong(t){const e=this.segLens,i=e.length-1;if(t<=0)return{i:0,t:0};if(t>=e[i])return{i:i-1,t:1};let s=0,r=i;for(;s<r;){const i=s+r>>1;e[i]<=t?s=i+1:r=i}const n=Math.max(0,s-1),o=e[n+1]-e[n];return{i:n,t:o>0?(t-e[n])/o:0}}},t.Map=bo,t.MapEvent=sn,t.default=bo,t.mat4=So,t.styleTools=J,t.vec3=Ao,Object.defineProperty(t,"__esModule",{value:!0})}));
