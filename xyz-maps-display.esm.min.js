/*
 * @here/xyz-maps-display
 * (c) 2019-2022 HERE
 */
import{geometry as t,Color as e,Expression as i,ExpressionParser as s,vec3 as r,global as n,LRU as o,TaskManager as a,ExpressionMode as l,Listener as h,Task as c,JSUtils as u,Map as d,geotools as f}from"@here/xyz-maps-common";import{webMercator as p,tileUtils as g,TileLayer as m,LocalProvider as v,GeoPoint as x,PixelPoint as y,GeoRect as _,utils as b,TerrainTileLayer as w}from"@here/xyz-maps-core";const A=(t,e,i,s)=>{("string"==typeof e?[e]:e).forEach((e=>{t.addEventListener(e,i,s)}))},S=(t,e,i,s)=>{("string"==typeof e?[e]:e).forEach((e=>{t.removeEventListener(e,i,s)}))},M=(t,e)=>Math.round(parseFloat(((t,e)=>{let i,s;return(s=t.ownerDocument.defaultView.getComputedStyle(t,null))&&(i=s.getPropertyValue(e),""===i&&(i=t.style[e])),i})(t,e)))||0;let T=document.createElement("canvas").getContext("2d"),L="abcdefghijklmnopqrstuvwxyz";L=L+L.toUpperCase()+" 0123456789";let z=L.length,P={};const C="normal 12px Arial",I=(t,e,i,s)=>{t.font=e.font||C,"number"==typeof e.strokeWidth?t.lineWidth=e.strokeWidth:t.lineWidth=1,t.strokeStyle=s,t.fillStyle=i,t.textAlign=e.textAlign||"start",t.lineCap="round",t.lineJoin="round"},E=(t,e,i,s,r)=>{const{fill:n,stroke:o,strokeWidth:a}=r;o&&0!=a&&t.strokeText(e,i,s),n&&t.fillText(e,i,s)},k=(t,e,i,s,r)=>{s=s||128,r=r||128,t.fillStyle="#000",t.fillRect(0,0,s,r),I(t,e,"#fff","#fff"),E(t,i,0,0,e);const n=t.getImageData(0,0,s,r).data;let o=-1,a=-1;for(let t=0;t<r;t++)for(let e=0;e<s;e++){if(0!=n[4*(t*s+e)]){-1==o&&(o=t);break}if(e==s-1&&-1!==o){a=t,t=r;break}}return t.clearRect(0,0,s,r),{height:a-o,min:o,max:a}},R=(t={})=>{let{font:e,strokeWidth:i}=t;e=e||C,i=i||0;const s=e+i;return P[s]||(T.font=e,T.textBaseline="top",P[s]={width:T.measureText(L).width/z,height:k(T,t,"gM").height}),P[s]},F=(t,e)=>{if(!1===e)return[t];null!=e&&!0!==e||(e=14);const i=[];let s=0,r=-1;for(let n,o,a,l=0,h=t.length;l<h;l++)o=t.charAt(l),a=l-s," "==o?r=l:"\n"==o&&(a=1/0,r=l),a>=e&&s<=r&&(n=t.substring(s,r),s=r+1,i.push(n)),l==h-1&&s<=l&&(n=t.substring(s,l+1),i.push(n));return i};let D;const O=(t,e,i,s,r)=>{let n=Math.sin(r),o=Math.cos(r),a=t-i,l=e-s;return[o*a-n*l+i,n*a+o*l+s]},U=(t,e,i,s,r,n)=>t>i&&t<r&&e>s&&e<n,B=t.intersectBBox,W=(t,e,i,s)=>{const r=t-i,n=e-s;return Math.sqrt(r*r+n*n)},N=(t,e,i,s,r)=>{const n=(s[1]-i[1])*(e[0]-t[0])-(s[0]-i[0])*(e[1]-t[1]);if(0!=n){const o=((s[0]-i[0])*(t[1]-i[1])-(s[1]-i[1])*(t[0]-i[0]))/n,a=((e[0]-t[0])*(t[1]-i[1])-(e[1]-t[1])*(t[0]-i[0]))/n;if(0<=o&&o<=1&&0<=a&&a<=1)return!r||[t[0]+o*(e[0]-t[0]),t[1]+o*(e[1]-t[1]),t[2]+o*(e[2]-t[2])]}return!1},G=t=>t>47&&t<58;class Z{constructor(){this.fonts={}}static getInstance(){return this.instance=this.instance||new Z}getFontId(t,e){return`${t.font||"normal 12px Arial"}${t.strokeWidth||1}${e}`}initFont(t,e=1){var i;const{fonts:s}=this,r=this.getFontId(t,e);if(!s[r]){null!==(i=t.strokeWidth)&&void 0!==i||(t.strokeWidth=1);const n=96*e,o=((t,e)=>{const i=document.createElement("canvas");return i.width=t,i.height=e,i})(n,n),a=o.getContext("2d",{willReadFrequently:!0});a.textBaseline="top",I(a,t,"#fff","#000");const l=Math.ceil(t.strokeWidth/2),h=l,c=a.measureText("Ã„").actualBoundingBoxAscent,u=Math.ceil(l+c),d=Math.ceil(this.getLetterHeight(a,"bottom")/2),f=Math.ceil(this.getLetterHeight(a,"top")+l)+1;a.setTransform(e,0,0,e,0,0);const p=Math.ceil(f+u);s[r]={name:r,size:0,glyphs:new Map,paddingX:h,paddingY:u,canvas:o,ctx:a,width:n,scale:e,style:t,textMetricsCache:new Map,rowHeight:p*e,letterHeight:f,spaceWidth:a.measureText(" ").width*e,baselineOffset:e*(d+u)}}return s[r]}hasGlyph(t,e){return e.glyphs.has(t)}getGlyph(t,e){let i=e.glyphs.get(t);if(!i){let r=e.canvas.width,{ctx:n,scale:o,paddingX:a}=e;n.clearRect(0,0,r,r),E(n,t,a,e.paddingY,e.style);let l=e.textMetricsCache.get(t);l?e.textMetricsCache.delete(t):l=n.measureText(t);const{width:h}=l,c=Math.round(h+2*a)*o;i={char:t,width:h,data:n.getImageData(0,0,c,e.rowHeight),direction:(s=t.charCodeAt(0),(t=>t>=32&&t<=47||t>=58&&t<=64||t>=91&&t<=96||t>=123&&t<=126)(s)||G(s)?0:(t=>t>=1424&&t<=1791||t>=1872&&t<=1919||t>=2208&&t<=2303||t>=64336&&t<=65023||t>=65136&&t<=65279)(s)?-1:1),advanceX:h*o},e.glyphs.set(t,i),e.size++}var s;return i}getTextWidth(t,e){const{ctx:i}=e;let s=0;for(let r of t){let t=e.glyphs.get(r);if(t)s+=t.width;else{let t=e.textMetricsCache.get(r);t||(t=i.measureText(r),e.textMetricsCache.set(r,t)),s+=t.width}}return s}getLetterHeight(t,e){t.textBaseline=e;const i=t.measureText("gM");return i.actualBoundingBoxDescent+i.actualBoundingBoxAscent}}var H=e.toRGB;const Y=Z.getInstance(),{meterToPixel:V,pixelToMeter:X}=p,j=t=>0^Math.min(t,20),q=1/0;let $;var K;!function(t){t[t.Number=0]="Number",t[t.String=1]="String",t[t.Color=2]="Color",t[t.Size=3]="Size",t[t.Boolean=4]="Boolean",t[t.Float=5]="Float"}(K||(K={}));const Q={type:{value:K.Number},zIndex:{value:K.Number},fill:{value:K.Color},stroke:{value:K.Color},strokeWidth:{value:K.Size},radius:{value:K.Size},width:{value:K.Size},height:{value:K.Size},font:{value:K.String},text:{value:K.String},textRef:{value:K.String},offsetX:{value:K.Size},offsetY:{value:K.Size},alignment:{value:K.String},rotation:{value:K.Size},priority:{value:K.Size},repeat:{value:K.Number},collide:{value:K.Size},offset:{value:K.Size},from:{value:K.Size},to:{value:K.Size},checkLineSpace:{value:K.Boolean},extrude:{value:K.Size},extrudeBase:{value:K.Size},intensity:{value:K.Float},weight:{value:K.Float},opacity:{value:K.Float},strokeDasharray:{value:K.Size}},J={};for(let t in Q)Q[t].value==K.Float&&(J[t]=!0);const tt=new Map,et=(t,e,i)=>{let s=st("text",t,e,i);if(!s&&t.textRef&&(s=tt.get(t.textRef),s==$&&(s=new Function("f","return f."+t.textRef),tt.set(t.textRef,s)),s=s(e,i)),""!=s)return s!==$&&"string"!=typeof s&&(s=String(s)),s},it=(t,e,i={})=>{let s={};for(let e in t)s[Math.round(Number(e))]=t[e];for(let t=1;t<=20;t++)i[t]=pt(s,t,e);return i},st=(t,e,s,r,n)=>{let o=e[t];return o instanceof i?o.resolve(s.properties,n||0):(o="function"==typeof o?o(s,r,e,n):o,o)},rt=(t,e=!1)=>{let i="px",s=t;return"string"==typeof t&&(s=parseFloat(t)||0,"m"==t.charAt(t.length-1))?(i="m",s=Math.round(1e3*s)/1e3,[s,i]):(e||(s=Math.round(s||0)),[s,i])},nt=(t,e,i,s,r)=>{const n=j(s),o=st(t,e,i,n);let[a,l]=rt(o,r);if("m"==l){a=Math.pow(2,s%n)*V(a,n)}return a},ot=(t,e,i,s)=>{let r=st("zIndex",t,e,i),n=st("zLayer",t,e,i);return"number"!=typeof n&&(n=s+1),1e6*n+r},at=(t,e,i,s)=>{let r=0;const n=j(i);for(let i of t){let t=ot(i,e,n,s);t>r&&(r=t)}return r},lt=(t,e,i,s,r)=>{let n,o=0,a=0;const l=j(i);for(let h=0;h<t.length;h++){n=t[h];if("Line"==st("type",n,e,l)&&(!r||!st("altitude",n,e,l))){let t=ot(n,e,l,s);t>a&&(a=t);const r=nt("strokeWidth",n,e,i,!0);r>o&&(o=r)}}return[o,a]},ht=(t,e,i,s,r,n)=>{const o=j(i),a=st("type",t,e,o);let l,h,c,u,d,f,p=0,g=0;r=r||[q,q,-1/0,-1/0];const m=st("fill",t,e,o),v=!n&&st("stroke",t,e,o);if("Image"!=a&&!m&&!v)return null;if("Text"==a){const i=et(t,e,o);if(!i)return null;const r=st("strokeWidth",t,e,o);let n=st("font",t,e,o);const a=Y.initFont({font:n,strokeWidth:r,fill:m,stroke:v},s);let l;if(d=0,"LineString"==e.geometry.type||"MultiLineString"==e.geometry.type)d=Y.getTextWidth(i,a),f=a.letterHeight;else{const s=st("lineWrap",t,e,o);l=F(i,s);for(let t of l){let e=Y.getTextWidth(t,a);e>d&&(d=e)}f=l.length*a.letterHeight}const h=st("textAnchor",t,e,o);if("string"==typeof h)switch(h){case"Top":g+=.5*f;break;case"TopLeft":p+=.5*d,g+=.5*f;break;case"TopRight":p-=.5*d,g+=.5*f;break;case"Bottom":g-=.5*f;break;case"BottomLeft":p+=.5*d,g-=.5*f;break;case"BottomRight":p-=.5*d,g-=.5*f}}else{let i=st("strokeWidth",t,e,o);isNaN(i)&&(i=1),"Circle"==a?(d=2*nt("radius",t,e,o)^0,f=d):(d=0^nt("width",t,e,o),f=nt("height",t,e,o),f=0^(f||d)),f+=i,d+=i}p+=0^st("offsetX",t,e,o),g+=0^st("offsetY",t,e,o);let x="Circle"!=a&&0^st("rotation",t,e,o);if(x){const t=((t,e,i,s=0,r=0)=>{const n=s-(e*=.5),o=s+e,a=r-(i*=.5),l=r+i,h=O(n,a,s,r,t),c=O(o,l,s,r,t),u=O(n,l,s,r,t),d=O(o,a,s,r,t);return[Math.min(h[0],c[0],u[0],d[0]),Math.min(h[1],c[1],u[1],d[1]),Math.max(h[0],c[0],u[0],d[0]),Math.max(h[1],c[1],u[1],d[1])]})(x,d,f,p,g);l=t[0],c=t[1],h=t[2],u=t[3]}else l=p-.5*d,h=l+d,c=g-.5*f,u=c+f;return l<r[0]&&(r[0]=l),h>r[2]&&(r[2]=h),c<r[1]&&(r[1]=c),u>r[3]&&(r[3]=u),r},ct=(t,e,i,s,r,n)=>{const o=j(i);let a,l,h=0;for(let c of t){if(n&&st("altitude",c,e,o))continue;l=ht(c,e,i,s,l,!0)||l,a=ot(c,e,o,r),a>h&&(h=a)}if(l)return l[4]=h,l},ut=t=>t.type&&t.zIndex!=$,dt=(t,e=0,i=1)=>Math.min(i,Math.max(e,t)),ft=(t,e,i,s,r)=>((t,e,i)=>t*(1-i)+e*i)(i,s,((t,e,i)=>dt((i-t)/(e-t)))(t,e,r)),pt=(t,e,i=!0)=>{let s,r,n,o,a=0;for(let l in t){const h=Number(l);s=t[h];const c=Array.isArray(s);let u,d;if(c?u=s:i?[u,d]=rt(s):u=s,"px"==d&&(s=u),e<=h){if(0==a)return"m"==d?t[h]:u;if(c){let t=[];for(let i=0;i<u.length;i++)t[i]=ft(o,h,r[i],u[i],e);return t}if(h-o>1){let t=r,i=u,s=d!=n,a="m"==d;s&&(a?t=X(t,o):i=X(i,h));return ft(o,h,t,i,e)+(s||a?"m":0)}return s}o=h,r=u,n=d,a++}return s},gt=t=>{for(let e in t)t[e]=H(t[e]);return t},mt=(t,e)=>{t=it(t,e);const i=(e,i)=>t[null!=i?i:e];return i.map=t,i},vt=(t,e)=>{for(let i of t)if(!i.__p){for(let t in i)if(t in Q){const r=i[t];if(s.isJSONExp(r)&&("strokeDasharray"!=t||isNaN(r[0].charAt(0))))i[t]=e.parseJSON(r);else if(r&&"object"==typeof r&&!Array.isArray(r)&&!r.type){"stroke"!=t&&"fill"!=t||gt(r);const e=!J[t];i[t]=mt(r,e)}}i.__p=!0}return t},xt=(e,i,s)=>{const r=st("anchor",e,i,s),{geometry:n}=i;let o;if("Centroid"==r)o=n._c||(n._c=t.centroid("Polygon"==n.type?n.coordinates:n.coordinates[0]));else if(o=n._pc,!o){const{bbox:t}=i,e=p.lat2y(t[1],1),s=p.lat2y(t[3],1),r=p.y2lat(.5*(s+e),1);o=n._pc=[.5*(t[0]+t[2]),r]}return o};var yt=Object.freeze({__proto__:null,calcBBox:ht,createZoomRangeFunction:mt,fillMap:it,getExtrude:(t,e,i)=>{const s=j(i);for(let i of t){const t=st("extrude",i,e,s);if(t)return t}return null},getLineWidth:lt,getMaxZoom:at,getPixelSize:ct,getPolygonCenter:xt,getSizeInPixel:nt,getTextString:et,getValue:st,is3d:(t,e,i)=>{const s=j(i);for(let i of t)if(st("altitude",i,e,s)||st("extrude",i,e,s))return!0;return!1},isStyle:ut,merge:(t,e)=>{if(null===e||!1===e)return null;let i,s=[];for(let r=0,n=t.length;r<n;r++){i=t[r],s.push([i[0],{}]);for(let t in i[1])s[r][1][t]=i[1][t];if(e[r]){s[r][0]=e[r][0];for(let t in e[r][1])s[r][1][t]=e[r][1][t]}}return s},parseColorMap:gt,parseSizeValue:rt,parseStyleGroup:vt}),_t=r.add,bt=e.toRGB;const wt=[{type:"ambient",color:"#fff",intensity:.3},{type:"directional",color:"#fff",direction:[0,0,1],intensity:1},{type:"directional",color:"#fff",direction:[-1,0,0],intensity:.2}],At=Symbol(),St=t=>{var e,i;const s=[0,0,0];let r=0,n=t[At];if(n)return n;t[At]=n={};for(let o of t){const t=bt(o.color).slice(0,3);switch(o.type){case"directional":const a=`u_directionalLight[${r++}]`;n[`${a}.color`]=t,n[`${a}.intensity`]=null!==(e=o.intensity)&&void 0!==e?e:1,n[`${a}.direction`]=o.direction;break;case"ambient":n["u_ambient.color"]=_t(s,s,t),n["u_ambient.intensity"]=null!==(i=o.intensity)&&void 0!==i?i:1}}return n.u_numDirectionalLights=r,n};St(wt);class Mt{constructor(t,e){this.ready=!1,this.cnt=0,this.tiles=[],this.z={},this.zLength=0,this.zd=!1,this._z3d=1/0,this.layer=t,this.tileSize=t.tileSize||null,this.layers=e,this.id=Math.floor(1e16*Math.random()),this.initStyle()}initStyle(){var t,e,i,s;this.expParser=null===(s=null===(e=(t=this.layer).getStyleManager)||void 0===e?void 0:(i=e.call(t)).getExpressionParser)||void 0===s?void 0:s.call(i)}getExpressionParser(){return this.expParser}getZ(t){const e=this.z;if(this.zd){let t=0;for(let i in e)e[i]=t++;this.zLength=t,this.zd=!1,this.z3d=e[this._z3d]}return e[t]||0}getAbsoluteZ(t){const{index:e,layers:i}=this;let s=0,r=0;for(;s<e;)r+=i[s++].zLength;return null!=t&&(r+=this.getZ(t)),r}addZ(t,e){const i=this.z;null==i[t]&&(i[t]=0,this.zd=!0,e&&t<this._z3d&&(this._z3d=t))}getZ3d(){const{layers:t}=this;let e,i=0,s=0;for(;e=t[i++];){if(e._z3d>=0)return s+e.z3d;s+=e.zLength}return s}processStyleGroup(t,e){var i,s;const r=null===(s=(i=this.layer).getStyleGroup)||void 0===s?void 0:s.call(i,t,e);return r&&vt(r,this.expParser),r}getLights(t){var e,i;const s=null===(i=(e=this.layer).getStyleManager)||void 0===i?void 0:i.call(e);let r=(null==s?void 0:s.lights)||{};return r.defaultLight||(r.defaultLight||(r.defaultLight=wt),s&&(s.lights=r)),r}reset(t){const e=this,i=e.layer;if(e.error=!1,e.cnt=0,e.tiles=[],e.visible=i.isVisible(t)){if(e.ready=!1,i.custom)return;return i.tileSize}e.ready=!0}}class Tt extends Array{constructor(...t){super(...t),this._map={},Object.setPrototypeOf(this,Tt.prototype)}indexOf(t){let e=this._map[t.id];return super.indexOf(e)}fixZ(){for(let t=0;t<this.length;t++)this[t].index=t}add(t,e){const i=t.id;let s,r=this._map[i];return r?(this.splice(super.indexOf(r),1),this.splice(e,0,r),s=!1):(r=this._map[i]=new Mt(t,this),this.splice(e,0,r),s=!0),this.fixZ(),s}remove(t){let e=this.indexOf(t);return-1!==e&&(this.splice(e,1),delete this._map[t.id],this.fixZ()),e}get(t){return"string"!=typeof t&&(t=t.id),this._map[t]}reset(t){const e=new Set;for(let i of this){let s=i.reset(t);s&&e.add(s)}return Array.from(e)}}class Lt{constructor(t,e){this.display=t,this.render=e}forEachTile(t,e){t.getProvider().getCachedTiles(t.getBBox()).forEach(e)}remove(t,e,i){for(let s of e)this.removeFromTile(t,s,i)}modifyInTile(t,e,i,s){let r=this.isVertexDataInitialized(e);return!!r&&(this.display.updateTile(e,r,s,t),!0)}isVertexDataInitialized(t){return this.display.getBucket(t.quadkey)}addToTile(t,e,i){const s=this.isVertexDataInitialized(e);s&&this.display.updateTile(e,s,i,t)}removeFromTile(t,e,i){let s=this.isVertexDataInitialized(e);s&&this.display.updateTile(e,s,i,t)}add(t,e,i){for(let s of e)this.addToTile(t,s,i)}updateGeometry(t,e,i,s){let r=s.getProvider(),n=r.getCachedTiles(e),o=r.getCachedTiles(t.getBBox());for(var a=0,l=o.length;a<l;a++){let e=n.indexOf(o[a]);-1===e?this.addToTile(t,o[a],s):(this.modifyInTile(t,o[a],i,s),n.splice(e,1))}for(a=0,l=n.length;a<l;a++)this.removeFromTile(t,n[a],s),this.removeFromTile(t,n[a],s)}repaint(t,e,i){let s=this;s.forEachTile(t,(function(e){let r=s.isVertexDataInitialized(e);r?s.display.updateTile(e,r,i,t):e.preview&&(e.preview=undefined)}))}clear(t,e){e=e||[];const i=this.display,s=i.layers.indexOf(t);i.buckets.forEach((function(i){e.length&&!((t,e)=>{let i=t.length;for(var s,r,n=0;n<e.length;n++)if(r=t,s=e[n],i>e[n].length&&(s=r,r=e[n]),0===s.search(r))return!0})(i.quadkey,e)||(i.clear(s),i.ready(s,!1),i.cancelTasks(t),i.luTs=null)})),i.update()}}const zt=[];class Pt{constructor(t,e){this.display=t,"number"==typeof e?(this.down=e,this.up=e):(this.down=e[0],this.up=e[1])}lookUp(t,e,i,s,r,n){const o=t.quadkey;let a,l,h,c=i-s;if(a=Number(o[c]),n.x+=a%2*e/2,n.y+=Number(a>1)*e/2,h=o.substring(0,c),this.hasData(h,r)){let t=e/Math.pow(2,s);return l=[],this.add(l,h,n.x,n.y,t,0,0,e),l}n.x/=2,n.y/=2}add(t,e,i,s,r,n,o,a){t.push([e,i,s,r,r,0^n,0^o,a,a])}hasData(t,e){const i=this.display.buckets.get(t,!0);if(i)return i.ready(e)&&i.getData(e)}lookDown(t,e,i,s,r){let n,o,a,l,h,c,u=i+s;n=g.getTilesOfLevel(t.quadkey,u);for(let t=0;t<n.length;t++){o=a=0,l=e;for(let u=0;u<s;u++)l/=2,h=n[t][i+u],o+=h%2*l,a+=Number(h>1)*l,u==s-1&&this.hasData(n[t],r)&&(c=c||[],this.add(c,n[t],0,0,e,o,a,l))}return c}create(t,e,i,s){const r=t.quadkey.length,n=e.min,o=e.max,a=o-r,l=r-n,h={x:0,y:0};let c,u,d,f=0,p=e.tileSize;i=i||this.down,(s=s||this.up)>l&&(s=l),i>a&&(i=a);const g=s>i?s:i,m=t.index(e);for(;f++<g;){if(u=r-f,u>=n&&(c=this.lookUp(t,p,r,f,m,h)))return c;if(d=r+f,d<=o&&f<i&&(c=this.lookDown(t,p,r,f,m)))return c}return zt}}const Ct=1/0;class It{constructor(t,e,i,s,r,n,o){this.quadkey=g.tileXYToQuadKey(t,n,r),this.tileZoomLevel=t,this.x=e,this.y=i,this.scaledSize=s,this.gridX=r,this.gridY=n,this.bounds=o,this.resultCache={}}static updateTileBBox(t,e,i){const s=It.tileGeoContainer,[r,n,o,a]=s,l=t+i,h=e+i;return r[0]=t,r[1]=e,n[0]=l,n[1]=e,o[0]=l,o[1]=h,a[0]=t,a[1]=h,s}static intersects(t,e,i,s){return((t,e)=>{for(let i of[t,e])for(let s=0;s<i.length;s++){let r,n=D,o=D,a=D,l=D,h=(s+1)%i.length,c=i[s],u=i[h],d=[u[1]-c[1],c[0]-u[0]];for(let e of t)r=d[0]*e[0]+d[1]*e[1],(n===D||r<n)&&(n=r),(o===D||r>o)&&(o=r);for(let t of e)r=d[0]*t[0]+d[1]*t[1],(a===D||r<a)&&(a=r),(l===D||r>l)&&(l=r);if(o<a||l<n)return!1}return!0})(t,It.updateTileBBox(e,i,s))}generateTileHierarchy(t,e=It.minTileSize,i=!0,s=[]){const r=e+Number(i),n=this.resultCache;if(n[r])return n[r];n[r]=s;let{tileZoomLevel:o,gridX:a,gridY:l,scaledSize:h}=this;if(h>e){const r=t.s,n=t.computeDistanceScale(this.x+h/2,this.y+h/2)/r,c=Math.log2(h/e);if(i){if(n*Math.sin(t.rx)>c)return s.push(this),s}o+=1,h*=.5,a*=2,l*=2;for(let[r,n]of[[0,0],[1,0],[0,1],[1,1]]){const c=this.x+r*h,u=this.y+n*h;if(It.intersects(this.bounds,c,u,h)){new It(o,c,u,h,a+r,l+n,this.bounds).generateTileHierarchy(t,e,i,s)}}}else{if(!i&&t.isPointAboveHorizon(this.x+h/2,this.y+h/2))return s;s.push(this)}return s}}It.minTileSize=256,It.tileGeoContainer=[[0,0],[0,0],[0,0],[0,0]];class Et{constructor(t){this.size=t}init(t,e,i,s){this.cwpx=t[0],this.cwpy=t[1],this.width=e,this.height=i,this.bounds=s;let r=Ct,n=-r,o=Ct,a=-o;for(let[t,e]of s)t<r&&(r=t),t>n&&(n=t),e<o&&(o=e),e>a&&(a=e);this.minX=r,this.maxX=n,this.minY=o,this.maxY=a}getTiles(t,e=3){const{width:i,height:s}=this;let r=512*(1<<e),n=t-e-Number(!0);const o=Math.pow(2,n)*r,a=this.cwpx*o,l=this.cwpy*o;let h=(a-i/2+this.minX)/r,c=(l-s/2+this.minY)/r,u=(a+i/2+this.maxX-i)/r,d=(l+s/2+this.maxY-s)/r,f=Math.floor(h),p=Math.floor(c),g=Math.floor(u)-f+1,m=Math.floor(d)-p+1,v=(f-h)*r+this.minX,x=(p-c)*r+this.minY;const y=[];for(let t=0;t<m;t++)for(let e=0;e<g;e++){const i=v+e*r,s=x+t*r;if(It.intersects(this.bounds,i,s,r)){const o=new It(n,i,s,r,f+e,p+t,this.bounds);y.push(o)}}return y}}const kt=!0;function Rt(t,e,i){if(e[t+="EventListener"])for(var s in i)e[t](s,i[s])}class Ft{constructor(t,e,i,s,r,n){this.updating=!1,this.dirty=!1,this.globalBgc=!1;const o=this,a=M(t,"width"),l=M(t,"height"),h=((t,e,i,s,r)=>{let n,o,a=document.createElement("canvas"),l=a.style;return((t,e,i)=>{t.setAttribute("width",e),t.setAttribute("height",i)})(a,e,i),a.setAttribute("oncontextmenu","return false;"),((t,e)=>{["-webkit-user-select","-moz-user-select","-ms-user-select","user-select"].forEach((function(i){t.style[i]=e}))})(a,"none"),l.top=l.left="0px",l.position="absolute",1!=r&&(l.opacity=String(r)),t.querySelectorAll("canvas[type=layer]"),a.setAttribute("type","layer"),n=t.querySelectorAll("canvas"),o=n[s],o?t.insertBefore(a,o):t.appendChild(a),a})(t,a,l,0);o.previewer=new Pt(o,n),o.grid=new Et(e),o.render=r,o.tileSize=e,o.buckets=s,o.layers=new Tt,o.w=a,o.h=l,o.canvas=h,h.className="tmc",o.dpr=Ft.getPixelRatio(i),o.setSize(a,l),o.setBGColor();const c=new Lt(o,r);o.listeners={clear:t=>{const{tiles:e,layer:i}=t.detail;c.clear(i,e)},featuresAdd:t=>{const{features:e,tiles:i,layer:s}=t.detail;(null==i?void 0:i.length)&&c.add(e,i,s)},featuresRemove:t=>{const{features:e,tiles:i,layer:s}=t.detail;i&&c.remove(e,i,s)},featureCoordinatesChange:t=>{const{feature:e,prevBBox:i,prevCoordinates:s,layer:r}=t.detail;c.updateGeometry(e,i,s,r)},styleGroupChange:t=>{const{feature:e,styleGroup:i,layer:s}=t.detail;c.repaint(e,i,s)},styleChange:t=>{const{layer:e,style:i}=t.detail,s=o.layers.get(e),{index:r}=s;s.initStyle(),o.setLayerBgColor(i,o.layers[r]),o.buckets.tiles.forEach((t=>t.clear(r)))}}}static getPixelRatio(t){return(t="auto"==t?Math.min(2,n.devicePixelRatio||1):t||1)<1?1:t}addLayer(t,e,i){const s=this,r=s.layers;if(r.add(t,e)){const n=r.get(t);return s.buckets.forEach((t=>{t.addLayer(e)})),Rt("add",t,s.listeners),t.custom?n:(null==i||i.clearCache(),n.handleTile=e=>{s.isVisible(e,n)&&s.handleTile(e,t)},0==e&&s.setLayerBgColor(t.getStyleManager(),n),n)}}removeLayer(t){const e=this,i=this.layers,s=i.get(t),r=s.tiles,n=i.indexOf(t);if(-1!==n){e.buckets.forEach((e=>{e.cancelTasks(t),e.removeLayer(n)}));for(let i of r){const r=i.tile.quadkey;e.releaseTile(r,s),e.cancel(r,t)}i.remove(t),Rt("remove",t,e.listeners)}return n}getBucket(t,e){const i=this;let s;return s=e?i.buckets.create(t,i.layers):i.buckets.get(t),s}handleTile(t,e,i,s){const r=this;let n,o=!1;if(i?o=!0:i=r.getBucket(t.quadkey,kt),null==s&&(s=r.layers.indexOf(e)),t.error&&(r.layers[s].error=!0),!i.ready(s)&&!i.busy(e)&&(n=t.data)){const a=(e,i)=>{t.isLoaded()&&e.ready(e.index(i),!0),r.update(o)};i.ready(s,!1);let l=e.render;l?l(t,n,e,i,a):r.prepareTile(t,n,e,i,a)}}computeDistanceScale(t,e){return 1}setLayerBgColor(t,e){e.bgColor=this.parseColor(t.backgroundColor)}parseColor(t){if(t)return"object"!=typeof t||Array.isArray(t)||(t=mt(gt(t))),"function"==typeof t?t:this.render.convertColor(t)}processLayerBackgroundColor(t){var e;const i=this,s=(null===(e=i.layers[0])||void 0===e?void 0:e.bgColor)||i.globalBgc;this.bgColor="function"==typeof s?i.render.convertColor(s(0^t)):s}isVisible(t,e){const i=t.quadkey;for(let t of e.tiles)if(t.tile.quadkey==i)return!0;return!1}getContext(){return this.render.getContext()}copyCanvas2d(t=0,e=0,i=this.w,s=this.h){const{canvas:r,dpr:n}=this;t*=n,e*=n,i*=n,s*=n;const o=document.createElement("Canvas");return o.width=i,o.height=s,this.viewport(),o.getContext("2d").drawImage(r,t,e,i,s,0,0,i,s),o}getScreenTile(t,e){return this.tiles.find((e=>e.quadkey==t))}updateTile(t,e,i,s){if(!e)return;const r=e.busy(i);if(r)r.isInterrupted()&&(r.outdated=!0);else{const s=this,r=e.index(i);e.ready(r,!1),s.layers[r].handleTile(t)}}setSize(t,e){const i=this,{dpr:s,canvas:r}=i;i.w=t,i.h=e,r.width=t*s,r.height=e*s,r.style.width=t+"px",r.style.height=e+"px"}cancel(t,e){const i=this.buckets.get(t,!0);i&&i.cancelTasks(e)}preview(t,e,i){const s=this.previewer.create(t,e);return t.preview(i,s),s}useLODTiles(){return!1}initVpTiles(t,e,i){const s=this,r=this.layers,n=s.tiles||[],o=s.tiles=[],a=s.w/2,l=s.h/2,h=this.useLODTiles();for(let i of r){i.reset(e);const r=i.layer;if(!r.tiled)continue;let c=r.tileSize||256,u=c,d=[];if(i.tiles=d,r.isVisible(e)){const e=h&&r.adaptiveGrid,f=t.flatMap((t=>t.generateTileHierarchy(s,c,e)));f.sort(((t,e)=>Math.hypot(t.x-a,t.y-l)-Math.hypot(e.x-l,e.y-l)));for(let t of f){const{quadkey:e,scaledSize:n}=t,a=s.getBucket(e,kt),l=n/u;t.scale=l,t.size=u,t.tile=a,d.push(t),o.find((i=>i.quadkey==e&&i.x==t.x&&i.y==t.y))||(o.push(t),a.i=++this.ti),s.initTile(a,i),r.getTile(e,i.handleTile)}this.freeStaleTilesLayer(d,n,i)}}}freeStaleTilesLayer(t,e,i){for(const{quadkey:s,size:r}of e){let e=!0;for(const{quadkey:i,size:n}of t)if(i==s&&r==n){e=!1;break}if(e){const t=i.layer;t.tileSize==r&&this.releaseTile(s,i),this.cancel(s,t)}}}getCamGroundPositionScreen(){return[this.w/2,this.h/2]}getHorizonYOffset(){return 0}isPointAboveHorizon(t,e){return!1}updateGrid(t,e,i,s){const r=this.centerWorld;this.processLayerBackgroundColor(e),this.setZoom(e),this.viewChange=!0,this.sx=i,this.sy=s;const n=this,o=this.w,a=this.h,l=o,h=Math.max(a,this.getCamGroundPositionScreen()[1]),c=this.getHorizonYOffset(),u=[n.unproject(0,c),n.unproject(l-1,c),n.unproject(l-1,h-1),n.unproject(0,h-1)];this.grid.init(r,o,a,u),this.ti=0;const d=n.grid.getTiles(t);this.initVpTiles(d,t),this.dirty=!0,n.update()}releaseTile(t,e){const i=e.layer,s=i.getCachedTile(t);s&&s.loadStartTs&&(s.isLoaded()||i.cancelTile(s,e.handleTile))}initTile(t,e){const i=e.index,s=this;e.visible?t.ready(i)||t.preview(i)||s.preview(t,e.layer,i):t.ready(i,!0)}update(t){const e=this;e.dirty||(e.dirty=t),e.updating||(e.updating=!0,requestAnimationFrame((()=>{e.viewport(),e.updating=!1})))}setBGColor(t="#ffffff"){const{render:e}=this;"transparent"==t&&(t="rgba(0, 0, 0, 0)"),t=this.parseColor(t),this.globalBgc=t,e.setBackgroundColor(t)}showGrid(t){this.render.grid(t)}setView(t,e,i,s,r,n){this.centerWorld=t,this.setTransform(e,i,s)}setTransform(t,e,i){this.render.setScale(this.s=t,0,0),this.render.setRotation(this.rz=e,this.rx=i),this.render.applyTransform()}getLayers(){return this.layers}destroy(){this.render.destroy();var t=this.canvas;t.parentElement.removeChild(t),t.width=t.height=1}clearLayer(t){const e=this.getLayers().indexOf(t);this.buckets.forEach((t=>{t.preview(e,!1),t.ready(e,!1)}))}viewChangeDone(){this.viewChange=!1}getRenderedFeatureAt(t,e,i){return{id:null}}scaleOffsetXYByAltitude(t){return 1}setZoom(t){if(this.zoom!=t)return this.zoom=t,!0}getTerrainHeightAtWorldXY(t,e,i){return null}}const Dt=window.console.error,Ot=(t,e,i,s=Dt)=>{const r=t.createShader(i);if(t.shaderSource(r,e),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){return s("compileShader "+t.getShaderInfoLog(r)),t.deleteShader(r),null}return r},Ut=(t,e,i)=>{const s=Ot(t,e,t.VERTEX_SHADER),r=Ot(t,i,t.FRAGMENT_SHADER),n=((t,e,i=Dt)=>{const s=t.createProgram();for(let i of e)t.attachShader(s,i);if(t.linkProgram(s),!t.getProgramParameter(s,t.LINK_STATUS))return i("linkProgram "+t.getProgramInfoLog(s)),t.deleteProgram(s),null;return s})(t,[s,r]);return t.detachShader(n,s),t.detachShader(n,r),t.deleteShader(s),t.deleteShader(r),n},Bt=(t,e,i=Dt)=>t.replace(/(?<!\/\/.*)#include\s+"([^"]+?)(?:\/([^"]+))?"/g,((t,s,r)=>{const n=e[s];if(n){if(r){let t=function(t,e){const i="#begin",s="#end",r=new RegExp(`${i}\\s+${e}[\\s\\S]*?${s}\\s+${e}`,"g"),n=t.match(r);return null==n?void 0:n[0].replace(`${i} ${e}`,"").replace(`${s} ${e}`,"").trim()}(n,r);if(null==t)return void i(`Block "${r}" not found in "${s}".`)}return n}i(`Include file "${s}" not found.`)}));class Wt{constructor(t){for(var e in t)this[e]=t[e]}}var Nt;!function(t){t[t.OPAQUE=1]="OPAQUE",t[t.ALPHA=2]="ALPHA",t[t.POST_ALPHA=4]="POST_ALPHA"}(Nt||(Nt={}));const Gt={"light.glsl":"#define GLSLIFY 1\nstruct AmbientLight{vec3 color;float intensity;};struct EmissiveLight{vec3 color;};struct DirectionalLight{vec3 color;float intensity;vec3 direction;};\n#define MAX_DIR_LIGTHS 6\nuniform EmissiveLight u_emissive;uniform AmbientLight u_ambient;uniform DirectionalLight u_directionalLight[MAX_DIR_LIGTHS];uniform int u_numDirectionalLights;vec4 computeBaseLighting(vec3 normal,vec3 color,float colorIntensity,float alpha){vec3 totalLighting=color*u_ambient.color*u_ambient.intensity;for(int i=0;i<MAX_DIR_LIGTHS;i++){if(i>=u_numDirectionalLights)break;vec3 lightDir=normalize(u_directionalLight[i].direction);float diff=max(dot(normal,lightDir),0.0);vec3 directionalColor=u_directionalLight[i].color*color*colorIntensity;vec3 diffuse=diff*directionalColor*u_directionalLight[i].intensity;totalLighting+=diffuse;}vec3 emissive=u_emissive.color*alpha;return vec4(totalLighting+emissive,alpha);}vec4 addSpecularHighlights(vec3 normal,vec4 totalLighting,vec3 surfaceToCam,float shininess,vec3 specular){for(int i=0;i<MAX_DIR_LIGTHS;i++){if(i>=u_numDirectionalLights)break;vec3 lightDir=normalize(u_directionalLight[i].direction);vec3 viewDir=normalize(surfaceToCam);vec3 halfwayDir=normalize(lightDir+viewDir);float spec=pow(max(dot(normal,halfwayDir),0.0),shininess);totalLighting.rgb+=specular*spec*u_directionalLight[i].color*u_directionalLight[i].intensity;}return totalLighting;}\n#ifdef SPECULAR\nvec4 computeLighting(vec3 normal,vec3 color,float colorIntensity,float alpha,vec3 surfaceToCam,float shininess,vec3 specular){vec4 light=computeBaseLighting(normal,color,colorIntensity,alpha);light=addSpecularHighlights(normal,light,surfaceToCam,shininess,specular);return light;}\n#else\nvec4 computeLighting(vec3 normal,vec3 color,float colorIntensity,float alpha){return computeBaseLighting(normal,color,colorIntensity,alpha);}\n#endif\n"};let Zt;class Ht{constructor(t,e,i,s){this.attributeLocations={},this.attributeDivisors=[],this.uniforms={},this.uniformSetters={},this.textureUnits=0,this.macros={M_PI:3.1415927410125732},this.dpr=e,this.usage=t.STATIC_DRAW,i&&(this.macros=Object.assign(Object.assign({},this.macros),i)),this.mode=s||t.TRIANGLES,this.gl=t,this.framebuffer=null,this.glStates=new Wt({scissor:!0,blend:!1,depth:!0})}static getMacros(t){return null}static getProgramId(t,e){return t.type}init(t,e){this.compile(this.vertexShaderSrc,this.fragmentShaderSrc,this.macros),this.setBufferCache(t),this.glExtAngleInstancedArrays=e}initBuffers(t){const e=this.gl;for(let i in t){let s=t[i];if(s.value)continue;let r=this.buffers.get(s);r||(r=e.createBuffer(),this.buffers.set(s,r)),s.dirty&&(s.dirty=!1,e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,s.data,e.STATIC_DRAW))}}createUniformSetter(t,e){const{gl:i}=this;switch(t.type){case i.FLOAT:return t=>i.uniform1f(e,t);case i.FLOAT_MAT3:return t=>i.uniformMatrix3fv(e,!1,t);case i.FLOAT_MAT4:return t=>i.uniformMatrix4fv(e,!1,t);case i.FLOAT_VEC2:return t=>i.uniform2fv(e,t);case i.FLOAT_VEC3:return t=>i.uniform3fv(e,t);case i.FLOAT_VEC4:return t=>i.uniform4fv(e,t);case i.BOOL:case i.INT:return t=>i.uniform1i(e,t);case i.SAMPLER_2D:const t=this.textureUnits++;return s=>{i.uniform1i(e,t),i.activeTexture(i.TEXTURE0+t),null==s||s.bind()}}return()=>{}}buildSource(t,e,i){i=Object.assign(Object.assign(Object.assign({},this.macros),{DEVICE_PIXEL_RATIO:this.dpr.toFixed(1)}),i);let s="";for(let t in i)s+=`#define ${t} ${i[t]}\n`;return[Bt(s+"#define GLSLIFY 1\nvec2 round(vec2 point){vec2 fractPoint=fract(point);point+=step(0.5,fractPoint)-fractPoint;return point;}vec4 snapToScreenPixel(vec4 position,vec2 resolution){resolution*=DEVICE_PIXEL_RATIO;vec2 screenPixel=((position.xy/position.w+1.0)/2.0)*resolution;position.xy=(round(screenPixel)/resolution*2.0-1.0)*position.w;return position;}vec3 rotateY(vec3 v,float a){float s=sin(a);float c=cos(a);return mat3(c,0.0,-s,0.0,1.0,0.0,s,0.0,c)*v;}vec2 rotateZ(vec2 v,float a){float s=sin(a);float c=cos(a);return v*mat2(c,-s,s,c);}float toPixel(vec2 size,float zoom){float value=size.x;if(size.y>0.0){value*=zoom*size.y;}return value;}const float SCALE_UINT16_Z=9000.0/65535.0;"+t,Gt),Bt(s+e,Gt)]}compile(t,e,i){const{gl:s}=this,[r,n]=this.buildSource(t,e,i||{}),o=Ut(s,r,n);this.prog=o;let a=s.getProgramParameter(o,s.ACTIVE_ATTRIBUTES);for(let t=0;t<a;++t){const e=s.getActiveAttrib(o,t),{name:i,type:r}=e,n=s.getAttribLocation(o,i),a=r==s.FLOAT_MAT2?2:r==s.FLOAT_MAT3?3:r==s.FLOAT_MAT4?4:1;this.attributeLocations[i]={index:n,length:a}}let l=s.getProgramParameter(o,s.ACTIVE_UNIFORMS);for(let t=0;t<l;t++){const e=s.getActiveUniform(o,t),i=e.name,r=s.getUniformLocation(o,i);this.uniforms[i]=r,this.uniformSetters[e.name]=this.createUniformSetter(e,r)}}setBufferCache(t){this.buffers=t}getUniformLocation(t){return this.uniforms[t]}initUniform(t,e){var i,s;null===(s=(i=this.uniformSetters)[t])||void 0===s||s.call(i,e)}initUniforms(t){for(let e in t)this.initUniform(e,t[e])}initViewUniforms(t){}setConstantAttributeValue(t,e){const{gl:i}=this;switch(i.disableVertexAttribArray(t),e.length){case 4:i.vertexAttrib4fv(t,e);break;case 3:i.vertexAttrib3fv(t,e);break;case 2:i.vertexAttrib2fv(t,e);break;case 1:i.vertexAttrib1fv(t,e)}}initAttributes(t){var e;const{gl:i,buffers:s,attributeLocations:r,attributeDivisors:n}=this;for(let o in t){let a=t[o];if(!r[o])continue;let{index:l,length:h}=r[o];const{value:c}=a;if(null!=c){for(let t=0;t<h;++t){const e=l+t;this.setConstantAttributeValue(e,c)}continue}let u=a,d=u.instanced;i.bindBuffer(i.ARRAY_BUFFER,s.get(u));const f=u.bytesPerElement,p=0|Number(d),g=u.stride^0+u.size*f,m=0^u.offset,v=u.size/h;for(let t=0;t<h;++t){const s=l+t;i.enableVertexAttribArray(s),i.vertexAttribPointer(s,v,u.type,u.normalized,g,m+t*v*f),n[s]=p,d&&(null===(e=this.glExtAngleInstancedArrays)||void 0===e||e.vertexAttribDivisorANGLE(s,1))}}}initIndex(t){const{buffers:e,gl:i}=this;let s=e.get(t),r=!0;s||(s=i.createBuffer(),e.set(t,s),r=!1),i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,s),r||i.bufferData(i.ELEMENT_ARRAY_BUFFER,t.data,i.STATIC_DRAW)}isBufferVisible(t){return!0}initPass(t,e){const i=Boolean(t&e.pass);return i&&this.bindFramebuffer(null),i}dbgGLState(t){const{gl:e}=this;this.__dbgGlEnums||(this.__dbgGlEnums=(t=>{for(let i of["NEVER","LESS","LEQUAL","GREATER","GEQUAL","EQUAL","NOTEQUAL","ALWAYS","KEEP","ZERO","REPLACE","INCR","INCR_WRAP","DECR","DECR_WRAP","INVERT"])t[e[i]]=i;return t})({}))}draw(t,e){var i,s;const{gl:r}=this,{groups:n,instances:o}=t;for(let t of n){let e=t.mode!=Zt?t.mode:this.mode;if(t.uniforms&&this.initUniforms(t.uniforms),t.index){const s=t.index,n=s.length,a=s.type;this.initIndex(s),o?null===(i=this.glExtAngleInstancedArrays)||void 0===i||i.drawElementsInstancedANGLE(e,n,a,0,o):r.drawElements(e,n,a,0)}else{const i=t.arrays.first,n=t.arrays.count;o?null===(s=this.glExtAngleInstancedArrays)||void 0===s||s.drawArraysInstancedANGLE(e,i,n,o):r.drawArrays(e,i,n)}}}toggleCapability(t,e){e?this.gl.enable(t):this.gl.disable(t)}blendFunc(t=this.gl.ONE,e=this.gl.ONE_MINUS_SRC_ALPHA){this.gl.blendFunc(t,e)}initGeometryBuffer(t,e,i){var s,r,n;const o=this,{gl:a,glStates:l}=o;this._pass=e;const h=null!==(s=t.blend)&&void 0!==s?s:l.blend,c=null!==(r=t.depth)&&void 0!==r?r:l.depth,u=null!==(n=t.clip)&&void 0!==n?n:l.scissor,{scissorBox:d}=t,f=!!d;d&&a.scissor(d[0],d[1],d[2],d[3]),o.toggleCapability(a.SCISSOR_TEST,f),o.toggleCapability(a.BLEND,h),o.toggleCapability(a.DEPTH_TEST,c),o.toggleCapability(a.STENCIL_TEST,u),this.blendFunc();const p=t.cullFace();p&&a.cullFace(p),o.toggleCapability(a.CULL_FACE,!!p),null!=t.depthMask&&a.depthMask(t.depthMask);const g=t.colorMask||this.colorMask;null!=g&&a.colorMask(g.r,g.g,g.b,g.a),a.disable(a.POLYGON_OFFSET_FILL)}disableAttributes(){var t;const{attributeLocations:e,attributeDivisors:i,gl:s}=this;for(let r in e){let{index:n,length:o}=e[r];for(;o--;){let e=n+o;i[e]&&(null===(t=this.glExtAngleInstancedArrays)||void 0===t||t.vertexAttribDivisorANGLE(e,0),i[e]=0),s.disableVertexAttribArray(e)}}}delete(){this.gl.deleteProgram(this.prog)}bindFramebuffer(t=this.framebuffer,e=this.gl.canvas.width,i=this.gl.canvas.height){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.gl.viewport(0,0,e,i)}setResolution(t){}setColorMask(t){this.colorMask=t}initLight(t,e){this.initUniforms(t),this.initUniform("u_camWorld",e)}}class Yt extends Ht{constructor(t,e){super(t,e),this.name="Rect",this.glStates=new Wt({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform float u_scale;uniform vec4 u_size;uniform mat4 u_matrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_alignMap;uniform vec2 u_resolution;uniform bool u_scaleByAltitude;uniform float u_normalizePosition;varying vec2 vSize;varying vec2 vDir;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;vec2 size=vec2(toPixel(u_size.xy,u_scale),toPixel(u_size.zw,u_scale));size=(size+u_strokeWidth)*.5;float rotation=u_rotation;if(!u_alignMap){rotation*=-1.0;}vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){vec2 posCenterWorld=u_topLeft+pos;vec2 shift=(pixel_offset+rotateZ(dir*vec2(size.x,-size.y),rotation))/u_scale;vec3 posWorld=vec3(posCenterWorld+shift,z);if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posCenterWorld+shift,z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,z,1.0);vec2 shift=rotateZ(dir*size,rotation);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}vSize=size;vDir=dir;}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying vec2 vSize;varying vec2 vDir;\n#define COLOR_UNDEF -1.0\nvoid main(void){float dx=distance(vDir.x,0.0)*vSize.x;float dy=distance(vDir.y,0.0)*vSize.y;if(dx>vSize.x-u_strokeWidth||dy>vSize.y-u_strokeWidth){gl_FragColor=u_stroke;}else{gl_FragColor=u_fill;if(u_fill[0]==COLOR_UNDEF){gl_FragColor.a=0.0;};}}"}}class Vt extends Ht{constructor(t,e){super(t,e),this.name="Circle",this.glStates=new Wt({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute highp vec3 a_position;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform float u_scale;uniform vec2 u_resolution;uniform bool u_alignMap;uniform float u_strokeWidth;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;uniform float u_normalizePosition;varying vec2 v_position;varying float v_radius;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;float radius=toPixel(u_radius,u_scale);radius=radius+u_strokeWidth/2.0;v_position=dir*radius;v_radius=radius;vec2 pixel_offset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec3 posWorld=vec3(u_topLeft+pos,z);if(u_alignMap){vec2 shift=(pixel_offset+v_position*vec2(1.0,-1.0))/u_scale;if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(posWorld,1.0);vec2 offset=pixel_offset*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+v_position)/u_resolution*2.0,cpos.z/cpos.w,1.0);}}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform vec4 u_stroke;uniform float u_strokeWidth;varying float v_radius;varying vec2 v_position;\n#define COLOR_UNDEF -1.0\nvoid main(void){float r=length(v_position);if(r>v_radius)discard;if(r<v_radius-u_strokeWidth){if(u_fill[0]==COLOR_UNDEF)discard;gl_FragColor=u_fill;}else{gl_FragColor=u_stroke;}}"}}var Xt="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute highp vec4 a_normal;attribute float a_lengthSoFar;uniform mat4 u_matrix;uniform highp vec2 u_strokeWidth;uniform highp float u_scale;uniform vec2 u_topLeft;varying vec2 v_normal;\n#ifdef DASHARRAY\nvarying float v_lengthSoFar;varying vec2 v_dashSize;uniform vec2 u_dashSize;uniform vec2 u_dashUnit;\n#endif\nvarying vec2 v_width;varying vec2 v_dir;uniform vec2 u_offset;uniform bool u_no_antialias;uniform bool u_scaleByAltitude;const float N_SCALE=1.0/8191.0;void main(void){float strokeWidth=toPixel(u_strokeWidth,u_scale)*0.5;float alias=u_no_antialias? 0.0: strokeWidth<1. ? .65 : 1.;float width=(strokeWidth+alias)/u_scale;v_width=vec2(strokeWidth,alias);vec2 dir2=mod(a_normal.zw,2.0)*2.0-1.0;vec2 aliasNormal=floor(a_normal.zw*.5)*N_SCALE;v_normal=dir2*aliasNormal;v_dir=mod(a_normal.xy,2.0);vec2 dir=v_dir*2.0-1.0;vec2 normal=floor(a_normal.xy*.5)*N_SCALE;\n#ifdef DASHARRAY\nv_lengthSoFar=a_lengthSoFar;v_dashSize=vec2(toPixel(vec2(u_dashSize.x,u_dashUnit.x),u_scale),toPixel(vec2(u_dashSize.y,u_dashUnit.y),u_scale));\n#endif\nfloat lineOffset=toPixel(u_offset,u_scale);vec2 position=a_position.xy+normal*-lineOffset/u_scale;vec2 posCenterWorld=vec2(u_topLeft+position);vec2 offset=dir*normal*width;if(!u_scaleByAltitude){vec3 posWorld=vec3(posCenterWorld+offset,a_position.z);float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);offset*=scaleDZ;}gl_Position=u_matrix*vec4(posCenterWorld+offset,a_position.z,1.0);}",jt="precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;varying vec2 v_normal;varying vec2 v_dir;uniform bool u_no_antialias;\n#ifdef DASHARRAY\nuniform highp float u_scale;\n#if (DASHARRAY & 2)\nuniform sampler2D u_dashPattern;\n#endif\nvarying float v_lengthSoFar;uniform sampler2D u_dashTexture;uniform bool u_hasDashTexture;varying vec2 v_dashSize;\n#endif\nvarying vec2 v_width;void main(void){highp float lineWidth=v_width.s+v_width.t;highp float width=length(v_normal)*lineWidth;if(width>lineWidth){discard;}\n#ifdef DASHARRAY\nfloat dashSize=v_dashSize.x+(1.0-step(0.1,v_dashSize.x))*1e5;float gapSize=v_dashSize.y;float totalDashSize=dashSize+gapSize;\n#if DASHARRAY & 2\nfloat dash=texture2D(u_dashPattern,vec2(fract(v_lengthSoFar/totalDashSize*u_scale))).r;gl_FragColor=u_fill*step(0.1,dash);\n#else\nfloat patternPosition=fract(v_lengthSoFar/totalDashSize*u_scale);float dashPosition=dashSize/totalDashSize;\n#if DASHARRAY & 4\nfloat u=patternPosition/dashPosition;gl_FragColor=u_fill*texture2D(u_dashTexture,vec2(u,v_dir.y));\n#else\ngl_FragColor=u_fill*step(patternPosition,dashPosition);\n#endif\n#endif\n#else\ngl_FragColor=u_fill;\n#endif\nif(!u_no_antialias){float antialiasAlpha=1.0-clamp(.5*width-.5*v_width.s+.5,.0,1.);gl_FragColor*=antialiasAlpha;}}";class qt extends Ht{constructor(t,e){super(t,e),this.name="Line",this.glStates=new Wt({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Xt,this.fragmentShaderSrc=jt}isBufferVisible(t){return t.u_strokeWidth[0]>0}}class $t extends Ht{constructor(t,e,i={}){super(t,e,i),this.name="DashedLine",this.glStates=new Wt({blend:!0,scissor:!0,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc=Xt,this.fragmentShaderSrc=jt}static getMacros(t){const{uniforms:e}=t;return{DASHARRAY:1|(e.u_dashPattern?2:0)|(e.u_dashTexture?4:0)}}static getProgramId(t,e){return t.type+e.DASHARRAY}}class Kt extends Ht{constructor(t,e,i){super(t,e,i),this.name="Polygon",this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform vec2 u_offsetZ;uniform float u_scale;uniform float u_zMeterToPixel;uniform mat4 u_matrix;uniform vec2 u_topLeft;\n#ifdef SPECULAR\nuniform vec3 u_camWorld;varying vec3 v_surfaceToCam;\n#endif\nvoid main(void){float z=a_position.z+u_offsetZ.x/u_zMeterToPixel/u_scale;vec3 worldPos=vec3(u_topLeft+a_position.xy,z);gl_Position=u_matrix*vec4(worldPos,1.0);\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-worldPos;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\n}",this.fragmentShaderSrc='precision lowp float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform float u_fillIntensity;\n#ifdef SPECULAR\n#include "light.glsl"\nuniform vec3 specular;uniform float shininess;uniform vec3 u_camWorld;varying vec3 v_surfaceToCam;varying vec3 fragNormal;\n#endif\nconst vec3 surfaceNormal=vec3(0,0,1);void main(void){\n#ifdef SPECULAR\nvec4 light=computeBaseLighting(surfaceNormal,u_fill.rgb,u_fillIntensity,u_fill.a);light=addSpecularHighlights(surfaceNormal,light,v_surfaceToCam,shininess,specular);gl_FragColor=light;\n#else\ngl_FragColor=u_fill;\n#endif\n}'}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}}class Qt extends Ht{constructor(t,e){super(t,e),this.name="Image",this.glStates=new Wt({scissor:!0,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_position;attribute vec2 a_textureCoord;uniform highp mat4 u_matrix;uniform highp vec2 u_topLeft;uniform highp vec2 u_resolution;uniform float u_tileScale;varying vec2 v_textureCoord;uniform float u_scale;void main(void){v_textureCoord=a_textureCoord;highp vec4 position=u_matrix*vec4(u_topLeft+a_position*u_tileScale,0.0,1.0);gl_Position=position;}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nvarying vec2 v_textureCoord;uniform sampler2D u_sampler;void main(void){gl_FragColor=texture2D(u_sampler,v_textureCoord);}"}}class Jt extends Ht{constructor(t,e){super(t,e),this.name="Text",this.glStates=new Wt({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision highp float;\n#define GLSLIFY 1\nattribute vec3 a_point;attribute vec3 a_position;attribute vec2 a_texcoord;uniform vec2 u_resolution;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform float u_scale;uniform float u_rotate;uniform bool u_alignMap;uniform bool u_fixedView;uniform vec2 u_texSize;uniform bool u_scaleByAltitude;uniform float u_normalizePosition;varying vec2 v_texcoord;varying vec4 vColor;const float OFFSET_SCALE=1.0/32.0;const float PI_05=M_PI*0.5;const float PI_15=M_PI*1.5;const float PI_20=M_PI*2.0;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 position=floor(a_position.xy/2.0)*u_normalizePosition;vec2 rotLowHi=mod(a_texcoord,32.0);float rotationZ=rotLowHi.y*32.0+rotLowHi.x;v_texcoord=floor(a_texcoord/32.0)/u_texSize;vec2 labelOffset=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));labelOffset*=DEVICE_PIXEL_RATIO;rotationZ=rotationZ/1024.0*PI_20;float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;if(u_alignMap){float absRotation=mod(u_rotate+rotationZ,PI_20);float rotationY=a_point.z/32767.0*PI_20;if(absRotation>PI_05&&absRotation<PI_15){rotationZ+=M_PI;labelOffset*=-1.0;rotationY*=-1.0;}vec3 offset=vec3(a_point.xy*OFFSET_SCALE+labelOffset,0.0)/u_scale/DEVICE_PIXEL_RATIO;offset=rotateY(offset,rotationY);offset.xy=rotateZ(offset.xy,rotationZ);vec3 posWorld=vec3(u_topLeft+position,z);if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);offset.xy*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld+offset,1.0);}else{vec4 cpos=u_matrix*vec4((u_topLeft+position),z,1.0);vec2 offset=rotateZ(a_point.xy*OFFSET_SCALE+labelOffset,rotationZ);gl_Position=vec4(cpos.xy/cpos.w+vec2(1,-1)*offset/DEVICE_PIXEL_RATIO/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}}}",this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform sampler2D u_texture;uniform bool u_strokeOnly;uniform vec4 u_fillColor;uniform vec4 u_strokeColor;void main(){vec4 glyph=texture2D(u_texture,v_texcoord);vec4 color;float glyphAlpha;if(u_strokeOnly){color=u_strokeColor;glyphAlpha=glyph.a;}else{color=u_fillColor;glyphAlpha=glyph.r;}gl_FragColor=glyphAlpha*color;}"}blendFunc(){const{gl:t}=this;t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA)}initGeometryBuffer(t,e,i){const{gl:s}=this;super.initGeometryBuffer(t,e),s.depthMask(!1),s.polygonOffset(0,2048*-i),s.enable(s.POLYGON_OFFSET_FILL)}draw(t){const{gl:e,uniforms:i}=this;e.uniform1f(i.u_strokeOnly,1),super.draw(t),e.uniform1f(i.u_strokeOnly,0),super.draw(t)}initViewUniforms(t){this.initUniform("u_rotate",t.rz),this.initUniform("u_fixedView",t.fixedView)}}class te extends Ht{constructor(t,e){super(t,e),this.name="icon",this.glStates=new Wt({blend:!0,scissor:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec2 a_size;attribute highp vec3 a_position;attribute vec2 a_texcoord;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform vec4 u_offset;uniform vec2 u_offsetZ;uniform bool u_alignMap;uniform vec2 u_resolution;uniform bool u_fixedView;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;uniform float u_normalizePosition;varying float vOpacity;varying vec2 v_texcoord;void main(void){if(mod(a_position.x,2.0)==1.0){vec2 rotLowHi=mod(a_texcoord,16.0);float roationMSB=mod(a_position.y,2.0);float rotation=rotLowHi.x+floor(rotLowHi.y*16.0)+(roationMSB*256.0);rotation=rotation/511.0*2.0*M_PI;vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;float z=a_position.z*SCALE_UINT16_Z+toPixel(u_offsetZ,u_scale)/u_zMeterToPixel/u_scale;vec2 offsetXY=vec2(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale));if(u_alignMap){vec3 posWorld=vec3(u_topLeft+pos,z);vec2 shift=rotateZ(offsetXY+dir*vec2(a_size.x,-a_size.y)*0.5,rotation)/u_scale;if(!u_scaleByAltitude){float scaleDZ=1.0+posWorld.z*u_matrix[2][3]/(u_matrix[0][3]*posWorld.x+u_matrix[1][3]*posWorld.y+u_matrix[3][3]);shift*=scaleDZ;}gl_Position=u_matrix*vec4(posWorld.xy+shift,posWorld.z,1.0);}else{vec4 cpos=u_matrix*vec4(u_topLeft+pos,z,1.0);vec2 shift=rotateZ(dir*a_size,-rotation)*0.5;vec2 offset=offsetXY*vec2(1.0,-1.0);gl_Position=vec4(cpos.xy/cpos.w+(offset+shift)/u_resolution*2.0,cpos.z/cpos.w,1.0);}if(u_fixedView){gl_Position=snapToScreenPixel(gl_Position,u_resolution);}v_texcoord=floor(a_texcoord/16.0)/4095.0;}}",this.fragmentShaderSrc="precision mediump float;\n#define GLSLIFY 1\nvarying vec2 v_texcoord;uniform float u_opacity;uniform sampler2D u_texture;void main(){gl_FragColor=texture2D(u_texture,v_texcoord);gl_FragColor.a*=u_opacity;if(gl_FragColor.a<.1)discard;}"}initViewUniforms(t){this.initUniform("u_fixedView",t.fixedView)}}class ee extends Ht{constructor(t,e,i){super(t,e,i),this.name="Extrude",this.glStates=new Wt({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc='precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_normal;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform vec4 u_fill;uniform float u_fillIntensity;uniform bool u_strokePass;uniform vec4 u_stroke;\n#include "light.glsl"\n#ifdef SPECULAR\nuniform vec3 u_camWorld;uniform float u_zMeterToPixel;uniform vec3 specular;uniform float shininess;\n#endif\nvarying vec4 v_fill;const vec3 TopSurfaceNormal=vec3(0,0,1);void main(void){vec3 worldPos=vec3(u_topLeft+a_position.xy,a_position.z);gl_Position=u_matrix*vec4(worldPos,1.0);if(u_strokePass){v_fill=u_stroke;}else{vec3 normal=a_normal.xy==TopSurfaceNormal.xy ? TopSurfaceNormal : a_normal;vec4 light=computeBaseLighting(normal,u_fill.rgb,u_fillIntensity,u_fill.a);\n#ifdef SPECULAR\nvec3 surfaceToCam=normalize(u_camWorld-worldPos);surfaceToCam.z*=u_zMeterToPixel;light=addSpecularHighlights(normal,light,surfaceToCam,shininess,specular);\n#endif\nv_fill=light;}}',this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nvarying vec4 v_fill;void main(void){gl_FragColor=v_fill;}"}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}initGeometryBuffer(t,e){const{gl:i}=this;super.initGeometryBuffer(t,e),i.polygonOffset(1,1),i.enable(i.POLYGON_OFFSET_FILL)}draw(t){const{gl:e}=this;super.draw(t),e.disable(e.POLYGON_OFFSET_FILL)}}class ie extends Ht{constructor(t,e,i){super(t,e,i),this.name="Box",this.glStates=new Wt({scissor:!1,blend:!1,depth:!0}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision mediump float;\n#define GLSLIFY 1\nattribute vec3 a_normal;attribute highp vec3 a_position;attribute highp vec3 a_point;uniform float u_scale;uniform mat4 u_matrix;uniform mat4 u_inverseMatrix;uniform float u_strokeWidth;uniform vec2 u_topLeft;uniform float u_rotation;uniform vec4 u_offset;uniform bool u_alignMap;uniform vec2 u_resolution;uniform vec2 u_offsetZ;uniform float u_zMeterToPixel;uniform bool u_scaleByAltitude;\n#ifdef SPHERE\nvarying vec3 v_rayOrigin;varying vec3 v_rayDirecton;varying vec3 v_worldPos;uniform vec2 u_radius;\n#else\nvarying vec3 vPosition;varying float v_strokeWidth;varying vec3 v_normal;\n#endif\nvarying vec3 vSize;const float EXTENT_SCALE=1.0/32.0;\n#ifdef SPECULAR\nvarying vec3 v_surfaceToCam;uniform vec3 u_camWorld;\n#endif\nvoid main(void){\n#ifdef SPHERE\nvec3 dir=a_point*2.0-1.0;vec3 size=vec3(toPixel(u_radius,u_scale))/u_scale;\n#else\nvec3 dir=mod(a_point,2.0)*2.0-1.0;vec3 size=floor(a_point*.5)/u_scale*.5;\n#endif\nvec3 boxCenter=vec3(u_topLeft+a_position.xy*EXTENT_SCALE,a_position.z*SCALE_UINT16_Z);boxCenter+=vec3(toPixel(u_offset.xy,u_scale),toPixel(u_offset.zw,u_scale),toPixel(u_offsetZ,u_scale)/u_zMeterToPixel)/u_scale;float scaleDZ=1.0+(u_scaleByAltitude ? 0.0 : boxCenter.z*u_matrix[2][3]/(u_matrix[0][3]*boxCenter.x+u_matrix[1][3]*boxCenter.y+u_matrix[3][3]));size*=scaleDZ;vec3 vertexOffset=vec3(size.xy,size.z/u_zMeterToPixel)*dir;vec3 vertexPos=vec3(boxCenter.xy+rotateZ(vertexOffset.xy,u_rotation),boxCenter.z+vertexOffset.z);vertexPos.z=max(vertexPos.z,0.0);gl_Position=u_matrix*vec4(vertexPos,1.0);\n#ifdef SPHERE\nvec4 origin=u_inverseMatrix*vec4(gl_Position.xy,-1.0,gl_Position.w);v_rayOrigin=origin.xyz/origin.w;v_rayDirecton=vertexPos-v_rayOrigin;v_worldPos=boxCenter;v_rayOrigin.z*=u_zMeterToPixel;v_rayDirecton.z*=u_zMeterToPixel;v_worldPos.z*=u_zMeterToPixel;\n#else\nvPosition=vec3(vertexOffset.xy,vertexOffset.z*u_zMeterToPixel);v_strokeWidth=u_strokeWidth/u_scale*scaleDZ;v_normal=a_normal;\n#endif\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-vertexPos;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\nvSize=size;}",this.fragmentShaderSrc='precision mediump float;\n#define GLSLIFY 1\nuniform vec4 u_fill;uniform float u_fillIntensity;uniform vec4 u_stroke;varying vec3 vSize;\n#ifdef SPHERE\nvarying vec3 v_worldPos;varying vec3 v_rayOrigin;varying vec3 v_rayDirecton;\n#else\nvarying float v_strokeWidth;varying vec3 vPosition;varying vec3 v_normal;const float smoothness=.25;\n#endif\n#include "light.glsl"\n#ifdef SPECULAR\nuniform vec3 specular;uniform float shininess;varying vec3 v_surfaceToCam;\n#endif\n#ifdef SPHERE\nfloat sphereIntersect(vec3 rayOrigin,vec3 rayDirection,vec3 spherePosition,float sphereRadius){vec3 oc=rayOrigin-spherePosition.xyz;float b=dot(oc,rayDirection);float c=dot(oc,oc)-sphereRadius*sphereRadius;float d=b*b-c;return(d<0.0)?-1.0 :-b-sqrt(d);}\n#endif\nvoid main(void){vec4 color=u_fill;vec3 normal;\n#ifdef SPHERE\nfloat radius=vSize.x;vec3 rayDir=normalize(v_rayDirecton);float distance=sphereIntersect(v_rayOrigin,rayDir,v_worldPos,radius);if(distance==-1.0)discard;vec3 surfacePos=rayDir*distance+v_rayOrigin;normal=normalize(surfacePos-v_worldPos);\n#else\nfloat a=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.xy)-vSize.xy));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.yz)-vSize.yz));a*=smoothstep(v_strokeWidth,v_strokeWidth+smoothness,length(abs(vPosition.xz)-vSize.xz));color=mix(u_stroke,u_fill,a);normal=normalize(v_normal);\n#endif\ncolor=computeBaseLighting(normal,color.rgb,u_fillIntensity,u_fill.a);\n#ifdef SPECULAR\ncolor=addSpecularHighlights(normal,color,v_surfaceToCam,shininess,specular);\n#endif\ngl_FragColor=color;}'}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}}class se extends ie{constructor(t,e){super(t,e,{SPHERE:!0}),this.name="Sphere"}static getProgramId(t,e){const i=null==e?void 0:e.SPECULAR;return i?t.type+i:t.type}static getMacros(t){const{uniforms:e}=t;let i;return e.specular&&(i={SPECULAR:2}),i}initViewUniforms(t){this.initUniform("u_inverseMatrix",t.inverseMatrix)}}class re extends Ht{constructor(t,e,i){super(t,e,i),this.name="Model",this.glStates=new Wt({scissor:!1,blend:!1,depth:!0}),this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute vec3 a_offset;attribute vec3 a_normal;attribute vec3 a_tangent;attribute vec4 a_color;attribute vec2 a_uv;attribute mat4 a_modelMatrix;uniform bool useUVMapping;uniform vec2 u_textureSize;uniform mat3 u_normalMatrix;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform bool u_isPixelCoords;uniform float u_zMeterToPixel;uniform float pointSize;varying vec3 v_normal;varying vec2 v_texCoord;varying vec4 v_color;varying vec3 v_lightDir;\n#ifdef SPECULAR\nuniform vec3 u_camWorld;varying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\n#ifdef DBG_GRID\nvarying vec2 v_tilePos;\n#endif\nvoid main(void){vec4 position=a_modelMatrix*vec4(a_position,1.0);float xyUnitScale=u_isPixelCoords ? 1.0 : u_zMeterToPixel;vec3 positionTileWorld=a_offset+vec3(position.xy*xyUnitScale,position.z);vec4 worldPos=vec4(u_topLeft+positionTileWorld.xy,positionTileWorld.z,1.0);gl_Position=u_matrix*worldPos;gl_PointSize=pointSize;v_normal=normalize(u_normalMatrix*a_normal);if(useUVMapping){v_texCoord=a_uv;}else{v_texCoord=positionTileWorld.xy/u_textureSize;}\n#ifdef DBG_GRID\nv_tilePos=positionTileWorld.xy;\n#endif\n#ifdef NORMAL_MAP\nv_tangent=normalize(normalMat*a_tangent);\n#endif\n#ifdef SPECULAR\nv_surfaceToCam=u_camWorld-worldPos.xyz;v_surfaceToCam.z*=u_zMeterToPixel;\n#endif\nv_color=a_color;}",this.fragmentShaderSrc='precision lowp float;\n#define GLSLIFY 1\nuniform vec3 ambient;uniform vec3 diffuse;uniform vec3 emissive;uniform vec3 u_ambientLight;uniform float opacity;uniform float illumination;uniform sampler2D diffuseMap;uniform sampler2D normalMap;varying vec4 v_color;varying vec3 v_normal;varying vec2 v_texCoord;\n#ifdef SPECULAR\nuniform float shininess;uniform vec3 specular;uniform sampler2D specularMap;varying vec3 v_surfaceToCam;\n#endif\n#ifdef NORMAL_MAP\nvarying vec3 v_tangent;\n#endif\n#ifdef DBG_GRID\nvarying vec2 v_tilePos;\n#endif\n#include "light.glsl"\nvoid main(){vec3 normal=normalize(v_normal);\n#ifdef NORMAL_MAP\nfloat flip=float(!gl_FrontFacing)*2.-1.;normal=normal*flip;vec3 tangent=normalize(v_tangent)*flip;vec3 bitangent=normalize(cross(normal,tangent));mat3 matrixTbn=mat3(tangent,bitangent,normal);normal=texture2D(normalMap,v_texCoord).rgb*2.-1.;normal=normalize(matrixTbn*normal);\n#endif\nvec4 diffuseMapColor=texture2D(diffuseMap,v_texCoord);vec3 color=diffuse*diffuseMapColor.rgb*v_color.rgb;vec4 totalColor=computeBaseLighting(normal,color,1.0,opacity*v_color.a);\n#ifdef SPECULAR\ntotalColor=addSpecularHighlights(normal,totalColor,v_surfaceToCam,shininess,specular*texture2D(specularMap,v_texCoord).rgb);\n#endif\ngl_FragColor=totalColor;\n#ifdef DBG_GRID\nfloat min=1.0;float max=512.0-1.0;if(v_tilePos.x<min||v_tilePos.x>max||v_tilePos.y<min||v_tilePos.y>max){gl_FragColor+=vec4(1.0,0.0,0.0,0.5);}\n#endif\n}'}static getMacros(t){const{uniforms:e}=t;let i;return e.illumination>0&&(i={DIFFUSE:1}),e.normalMap.width>1&&(i||(i={}),i.NORMAL_MAP=4),e.shininess>0&&(i||(i={}),i.SPECULAR=2),re.dbgGrid&&(i||(i={}),i.DBG_GRID=8),i}static getProgramId(t,e){return t.type+(e?e.DIFFUSE|e.SPECULAR|e.NORMAL_MAP:"")}draw(t,e){const{gl:i}=this;e&&(i.polygonOffset(1,1),i.enable(i.POLYGON_OFFSET_FILL)),super.draw(t)}}class ne{constructor(t,e,i={}){var s,r,n,o,a,l,h,c,u;this.gl=t,this.format=i.format||t.RGBA,this.internalFormat=i.internalFormat||this.format,this.flipY=i.flipY||!1,this.halfFloat=i.halfFloat||!1;let d=null===(s=i.mipMaps)||void 0===s||s,f=t.UNSIGNED_BYTE;const p=null==e?void 0:e.data;let g,m;if(i.float||p instanceof Float32Array){f=t.FLOAT,this.format=this.internalFormat=t.LUMINANCE,g=m=t.NEAREST;const i=Math.sqrt(p.length);null!==(r=(c=e).width)&&void 0!==r||(c.width=i),null!==(n=(u=e).height)&&void 0!==n||(u.height=i)}else this.halfFloat&&(f=null===(o=t.getExtension("OES_texture_half_float"))||void 0===o?void 0:o.HALF_FLOAT_OES,t.getExtension("OES_texture_half_float_linear"));this.type=f,this.mipMaps=d,this.wrapS=null!==(a=i.wrapS)&&void 0!==a?a:t.CLAMP_TO_EDGE,this.wrapT=null!==(l=i.wrapT)&&void 0!==l?l:t.CLAMP_TO_EDGE,this.premultiplyAlpha=null===(h=i.premultiplyAlpha)||void 0===h||h,this.minFilter=null!=g?g:t.LINEAR,this.magFilter=null!=m?m:t.LINEAR,e&&this.set(e)}bind(){const{gl:t,texture:e}=this;e&&t.bindTexture(t.TEXTURE_2D,e)}set(t,e,i){let{gl:s,texture:r,format:n,internalFormat:o,flipY:a,wrapS:l,wrapT:h,type:c,minFilter:u,magFilter:d}=this;const{width:f,height:p}=t,g="number"==typeof e;r||(this.texture=r=s.createTexture()),s.bindTexture(s.TEXTURE_2D,r),s.pixelStorei(s.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,h),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,a),g||this.width==f&&!this.height&&!p?s.texSubImage2D(s.TEXTURE_2D,0,e||0,i||0,n,c,t):(t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof ImageBitmap?s.texImage2D(s.TEXTURE_2D,0,o,n,s.UNSIGNED_BYTE,t):s.texImage2D(s.TEXTURE_2D,0,o,f,p,0,n,c,t.data),this.width=f,this.height=p),this.mipMaps&&f==p&&(t=>!(t&t-1))(p)?(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),s.generateMipmap(s.TEXTURE_2D)):(s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,u),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,d))}onDestroyed(t){}destroy(){const{gl:t,texture:e}=this;e&&t.deleteTexture(e),this.texture=null,this.onDestroyed(this)}getGLTexture(){return this.texture}}const oe=(()=>{const t=Object.getPrototypeOf(Uint8Array);return e=>e instanceof t})();let ae;const le=(t,e,i,s,r)=>{const n=t[e],o=t[e+1],a=t[e+2],l=t[i],h=t[i+1],c=t[i+2],u=t[s],d=t[s+1],f=t[s+2],p=l-u,g=h-d,m=c-f,v=n-u,x=o-d,y=a-f,_=m*x-g*y,b=p*y-m*v,w=g*v-p*x;r[e]+=_,r[e+1]+=b,r[e+2]+=w,r[i]+=_,r[i+1]+=b,r[i+2]+=w,r[s]+=_,r[s+1]+=b,r[s+2]+=w};class he{constructor(t,e,i){this.attributes={},this.uniforms={},this.pass=Nt.OPAQUE,this.flat=!0,this.groups=[],this.instances=0,this.pixelPerfect=!1,this._cullFace=0,this._uniformCache={clear:!0,uniforms:{},fromCache:!1},t&&(this.addGroup(t,i),this.type=e)}static computeNormals(t,e){const i=t.length,s=new Float32Array(i);if(e)for(let i=0,{length:r}=e;i<r;i+=3)le(t,3*e[i],3*e[i+1],3*e[i+2],s);else{let e=0;for(;e<i;)le(t,e,e+6,e+3,s),e+=9}const r=new Int8Array(i);for(let t,e,n,o=0;o<i;o+=3){t=s[o],e=s[o+1],n=s[o+2];const i=127/Math.sqrt(t*t+e*e+n*n)||0;r[o]=Math.round(t*i),r[o+1]=Math.round(e*i),r[o+2]=Math.round(n*i)}return r}static fromTemplateBuffer(t,e,i){const{flexAttributes:s}=e;let r;if(e.hasIndex()){const i=e.index();if(!i.length)return null;r=new he(i,t,e.i32)}else r=new he({first:e.first,count:e.count()},t);for(let t in s){let i=s[t];i.value?r.attributes[t]={value:i.value}:i.data.length&&r.addAttribute(t,e.trimAttribute(i))}r.instances=e.instances,r.idOffsets=e.idOffsets,r.rayIntersects=e.rayIntersects,r.cullFace(e.cullFace);for(let t in e.uniforms)r.addUniform(t,e.uniforms[t]);return r.light=i||e.light,r}createIndex(t,e){const i=Array.isArray(t)?e?new Uint32Array(t):new Uint16Array(t):t;return{index:{type:i.constructor==Uint32Array?5125:5123,length:t.length,data:i}}}createArrays(t){return{arrays:t}}addGroup(t,e,i){if(t){let s;return s=t.first!=ae?this.createArrays(t):this.createIndex(t,e),i&&(s.mode=i),this.groups[this.groups.length]=s}}addUniform(t,e){this.uniforms[t]=e}getUniform(t){return this.uniforms[t]}addAttribute(t,e,i=this.attributes){const{data:s}=e;e.type=(t=>t instanceof Int8Array?5120:t instanceof Uint8Array?5121:t instanceof Int16Array?5122:t instanceof Uint16Array?5123:t instanceof Int32Array?5124:t instanceof Uint32Array?5125:t instanceof Float32Array?5126:void 0)(s),e.bytesPerElement=s.BYTES_PER_ELEMENT,e.stride==ae&&(e.stride=0),e.dirty==ae&&(e.dirty=!0),i[t]=e}computeNormals(t,e){var i,s;return void 0===t&&(t=null===(i=this.attributes.a_position)||void 0===i?void 0:i.data),void 0===e&&(e=null===(s=this.groups[0].index)||void 0===s?void 0:s.data),he.computeNormals(t,e)}getAttributes(){return this.attributes}destroy(t){}isPointBuffer(){const{type:t}=this;return"Line"!=t&&"Extrude"!=t}isFlat(){return this.flat}rayIntersects(t,e,i,s,r){return null}cullFace(t){return t!==ae&&(this._cullFace=t),this._cullFace}clearUniformCache(){this._uniformCache.clear=!0}getUniformData(){return this._uniformCache.uniforms}compileUniforms(){const t=this._uniformCache;if(t.clear){t.clear=!1,t.fromCache=!1;const{uniforms:e}=this;for(let s in e){let r=e[s];if(r instanceof i)r=r.resolve();else if(Array.isArray(r)){let e=r[0];e instanceof i&&(e=e.resolve(),r=t.uniforms[s]||[0,0],r[0]=e,r[1]=0)}t.uniforms[s]=r}}else t.fromCache=!0;return t}needs2AlphaPasses(){return!!(this.pass&Nt.POST_ALPHA)}}he.MODE_GL_POINTS=0,he.MODE_GL_LINES=1,he.MODE_GL_TRIANGLES=4;const ce=Nt.ALPHA;class ue extends Ht{constructor(t,e){super(t,e),this.name="Heatmap",this.glStates=new Wt({scissor:!1,blend:!0,depth:!1}),this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;attribute float a_weight;uniform vec2 u_radius;uniform mat4 u_matrix;uniform vec2 u_topLeft;uniform float u_scale;uniform bool u_offscreen;uniform float u_normalizePosition;varying vec2 v_texcoord;varying vec2 v_direction;varying float v_weight;void main(void){if(u_offscreen){vec2 dir=mod(floor(a_position.xy/2.0),2.0)*2.0-1.0;vec2 pos=floor(a_position.xy/4.0)*u_normalizePosition;v_direction=3.0*dir;v_weight=a_weight;vec2 posCenter=vec2(u_topLeft+pos);vec2 offset=(dir*u_radius.x*vec2(1.0,-1.0));gl_Position=u_matrix*vec4(posCenter+offset/u_scale,0.0,1.0);}else{gl_Position=vec4(a_position.xy,0,1);v_texcoord=a_position.xy*0.5+0.5;}}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform bool u_offscreen;uniform sampler2D u_texture;uniform sampler2D u_gradient;varying float v_weight;uniform float u_intensity;uniform float u_opacity;varying vec2 v_texcoord;varying vec2 v_direction;const float INV_SQRT_2_PI=1.0/sqrt(2.0*M_PI);void main(void){if(u_offscreen){float sqDistance=dot(v_direction,v_direction);float density=INV_SQRT_2_PI*exp(-sqDistance/2.0);gl_FragColor.r=v_weight*u_intensity*density;}else{float r=texture2D(u_texture,v_texcoord).r;gl_FragColor=texture2D(u_gradient,vec2(r,0.5))*u_opacity;}}";let{width:i,height:s}=t.canvas;i*=.5,s*=.5;const r=new ne(t,{width:i,height:s},{halfFloat:!0,premultiplyAlpha:!1}),n=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,n),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,r.getGLTexture(),0);const o=t.createRenderbuffer();t.bindRenderbuffer(t.RENDERBUFFER,o),t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i,s),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,o),this.offscreen={framebuffer:n,depthStencilAttachment:o,texture:r,scale:.5};const a=new he({first:0,count:6},"Heatmap");a.addAttribute("a_position",{data:new Int8Array([-1,1,1,1,1,-1,-1,1,1,-1,-1,-1]),size:2,stride:0}),a.addUniform("u_texture",r),a.addUniform("u_offscreen",!1),a.depth=!0,this.offscreenBuffer=a}initPass(t,e){switch(t){case Nt.OPAQUE:return this.screenBufferRefreshed=!1;case ce:const{width:t,height:e}=this.offscreen.texture;return this.bindFramebuffer(this.offscreen.framebuffer,t,e),!0;case Nt.POST_ALPHA:this.bindFramebuffer(null);const i=!this.screenBufferRefreshed;return this.screenBufferRefreshed=!0,i}}draw(t){const{gl:e,uniforms:i,offscreen:s}=this;if(this._pass==ce)this.initUniforms({u_texture:null}),e.uniform1i(i.u_offscreen,1),e.enable(e.BLEND),e.colorMask(!0,!1,!1,!1),e.blendFunc(e.ONE,e.ONE),super.draw(t),this.bindFramebuffer(null);else{const{offscreenBuffer:t}=this;this.initBuffers(t.attributes),this.initUniforms(t.uniforms),this.initAttributes(t.attributes),this.initGeometryBuffer(t,Nt.ALPHA),e.depthFunc(e.LEQUAL),super.draw(t),this.clear()}}clear(){const{gl:t,offscreen:e}=this,{width:i,height:s}=e.texture;this.bindFramebuffer(e.framebuffer,i,s),t.colorMask(!0,!0,!0,!0),t.disable(t.SCISSOR_TEST),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT),this.bindFramebuffer(null)}setResolution(t){const[e,i]=t,{gl:s,offscreen:r}=this,{scale:n}=r,{width:o,height:a}=r.texture,l=e*n,h=i*n;o==l&&a==h||(r.texture.set({width:l,height:h}),s.bindRenderbuffer(s.RENDERBUFFER,r.depthStencilAttachment),s.renderbufferStorage(s.RENDERBUFFER,s.DEPTH_STENCIL,l,h))}}class de extends Kt{constructor(t,e,i){super(t,e,i),this.name="VerticalLine",this.mode=t.LINES}static getProgramId(t,e){return"VerticalLine"}static getMacros(t){return null}}class fe extends Ht{constructor(t,e,i){super(t,e,i),this.name="Sky",this.mode=t.TRIANGLES,this.vertexShaderSrc="precision lowp float;\n#define GLSLIFY 1\nattribute vec3 a_position;uniform mat4 u_matrix;uniform vec2 u_horizon;varying vec2 v_texcoord;void main(void){vec4 worldPos=vec4(a_position.x,a_position.y*u_horizon.x,0.0,1.0);gl_Position=u_matrix*worldPos;v_texcoord=vec2(gl_Position.x,a_position.y);}",this.fragmentShaderSrc="precision lowp float;\n#define GLSLIFY 1\nuniform vec2 u_horizon;uniform sampler2D u_fill;varying vec2 v_texcoord;void main(void){float horizonScale=u_horizon.x/u_horizon.y;gl_FragColor=texture2D(u_fill,vec2((1.0-v_texcoord.y)*horizonScale,0.0));}"}}const pe="round",ge="butt",me="miter",ve="bevel",xe=8191;var ye;!function(t){t[t.INSIDE=0]="INSIDE",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.BOTTOM=4]="BOTTOM",t[t.TOP=8]="TOP"}(ye||(ye={}));const _e=(t,e,i,s,r,n)=>{let o=ye.INSIDE;return t<i?o|=ye.LEFT:t>s&&(o|=ye.RIGHT),e<r?o|=ye.BOTTOM:e>n&&(o|=ye.TOP),o},be=t=>{let e=t[0],i=t[1],s=e*e+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e*s,t[1]=i*s),t},we=(t,e,i,s,r,n,o,a,l=1)=>{if(t==pe)!1===s?o.push(e,i,e,i,e,i):o.push(e,i,s,e,i,s,e,i,s),r*=Math.SQRT2*l,n*=Math.SQRT2*l,a.push(r<<1,n<<1|1,r<<1,n<<1|1,r<<1|1,n<<1,r<<1|1,n<<1,n<<1|1,r<<1|1,n<<1|1,r<<1|1);else if("square"==t){!1===s?o.push(e,i,e,i,e,i,e,i,e,i,e,i):o.push(e,i,s,e,i,s,e,i,s,e,i,s,e,i,s,e,i,s);let t=n-r,l=r+n;a.push(r<<1,n<<1|1,0,0,l<<1|1,t<<1,0,0,r<<1|1,n<<1,0,0,t<<1|1,l<<1|1,r<<1|1,n<<1|1,l<<1|1,t<<1,r<<1|1,n<<1|1,r<<1,n<<1|1,0,0)}},Ae=(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g=0,m=0)=>{u*=.5;const v=!!o;!0===o&&2==n&&(o=0);const x=a+16,y=-16,_=s[r/n-1];let b=g*_,w=m*_;if((g||m)&&(f=!1),b&&w&&m<g){const t=b;b=w,w=t}p&&(h=ge,"none"!=c&&(c=me)),o&&(h=ge,c="none"),d&&(h="butt",c="miter");let A,S,M=_e(i[0],i[1],y,x,y,x),T=null,L=null;for(let g=0,m=n;m<r;g=m,m+=n){let _=i[g],z=i[g+1];!0===o&&i[g+2];let P=i[m],C=i[m+1];for(!0===o&&i[m+2],A=S=_e(P,C,y,x,y,x);;){if(!(M|A)){null==T&&(T=g),A!==S&&(L=m);break}if(M&A)break;{let t,e,i,s=M||A;s&ye.TOP?(t=(x-z)/(C-z),e=_+(P-_)*t,i=x):s&ye.BOTTOM?(t=(y-z)/(C-z),e=_+(P-_)*t,i=y):s&ye.RIGHT?(t=(x-_)/(P-_),i=z+(C-z)*t,e=x):s&ye.LEFT&&(t=(y-_)/(P-_),i=z+(C-z)*t,e=y),s=_e(e,i,y,x,y,x),M?(M=s,_=e,z=i):(A=s,P=e,C=i)}}null==T||null==L&&m!=r-n||(L||(L=r-n),f&&(T-=n),Se(t,n,e,i,v,o,s,r,T,L+n,a,l,h,h,c,u,d,b,w,p,f),T=null,L=null),M=S}return t.length},Se=(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g,m,v,x,y,_,b,w)=>{let A=l,S=0;l<0?A=a-e+l:S=o[A/e];let M=s[A],T=s[A+1],L=!0===n?s[A+2]:n;b&&([M,T,L]=b);let z,P,C,I,E,k,R,F,D,O,U,B,W,N,G,Z,H,Y,V,X,j,q,$,K=h,Q=null,J=null,tt=null,et=null,it=null,st=null,rt=null,nt=null;if(x&&x<S)return S;let ot=_;for(let h=l+e;h<K;h+=e){let l,b,A=!_&&h==K-e,at=null,lt=!1;A&&w?[I,E,k]=w:(I=s[h],E=s[h+1],k=!0===n?s[h+2]:n),C=p,R=M-I,F=T-E,$=be([R,F]),D=$[1],O=$[0],it=null==it;const ht=S;S=o[h/e];const ct=S-ht;if(length=ct,u&&(T==E&&(T<=0||T>=c)||M==I&&(M<=0||M>=c))&&(ot=!0),x&&x<S&&x>=ht){const t=(x-ht)/ct;I=M-R*t,E=T-F*t,k=L,length*=t,A=!0,K=0}if(v){if(!(v<S)){M=I,T=E,L=k;continue}if(v>=ht){const t=(v-ht)/ct;M-=R*t,T-=F*t,length*=1-t,it=!0}}if(it&&A&&(p="none"),!A){const t=h%(a-e)+e;Q=I-s[t],J=E-s[t+1],at=be([Q,J]),tt=at[1],et=at[0],U=tt+D,B=-et-O,l=R*J-F*Q<0;let i=[U,B];b=1/(i[0]*D-i[1]*O),b==1/0?(lt=!0,U=2,B=2):(lt=!!m||b>3,p==me&&lt&&(C=ve),b>2?([U,B]=be(i),U*=2,B*=2):(U=i[0]*b,B=i[1]*b)),U*=-8191,B*=-8191}if(D*=xe,O*=xe,G=[-D<<1|1,O<<1|1],Y=[1^G[0],1^G[1]],V=Y,X=Y,Z=G,H=G,!ot){if("none"!=p){if(!A&&C==me&&K>2*e&&(X=[U<<1,B<<1],H=[U<<1|1,B<<1|1]),it||j||(q?(Z=[W<<1|1,N<<1|1],p==me&&(V=[W<<1,N<<1])):(V=[W<<1,N<<1],p==me&&(Z=[W<<1|1,N<<1|1]))),!lt&&!A&&p!=me){let t=g*U/-8191,e=g*B/-8191;l&&(t*=-1,e*=-1);let i=$[0]*t+$[1]*e;length<i?lt=!0:l?H=[U<<1|1,B<<1|1]:X=[U<<1,B<<1]}if((!it||A)&&S&&(p==pe&&(q?i.push(P[0],P[1],P[0],P[1],V[0],V[1],V[0],V[1],W<<1,N<<1,W<<1,N<<1):i.push(W<<1|1,N<<1|1,W<<1|1,N<<1|1,Z[0],Z[1],Z[0],Z[1],z[0],z[1],z[0],z[1]),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)),!it))if(j){if(!y){let e=0,s=0;if(p!=pe){let t=be([U,B]);e=t[0]*xe,s=t[1]*xe}e=e<<1|1,s=s<<1|1,q?i.push(0,0,0,0,Y[0],Y[1],e,s,P[0],P[1],e,s):i.push(0,0,0,0,z[0],z[1],e,s,G[0],G[1],e,s),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)}}else if(p!=me){let e=be([W,N]);e[0]*=xe,e[1]*=xe,q?p==ve?i.push(W<<1|1,N<<1|1,e[0]<<1|1,e[1]<<1|1,V[0],V[1],e[0]<<1,e[1]<<1,P[0],P[1],e[0]<<1,e[1]<<1):i.push(W<<1|1,N<<1|1,e[0]<<1|1,e[1]<<1|1,V[0],V[1],V[0],V[1],P[0],P[1],P[0],P[1]):p==ve?i.push(Z[0],Z[1],e[0]<<1|1,e[1]<<1|1,W<<1,N<<1,e[0]<<1,e[1]<<1,z[0],z[1],e[0]<<1|1,e[1]<<1|1):i.push(Z[0],Z[1],Z[0],Z[1],W<<1,N<<1,e[0]<<1,e[1]<<1,z[0],z[1],z[0],z[1]),r?t.push(st,rt,nt,st,rt,nt,st,rt,nt):t.push(st,rt,st,rt,st,rt),null==m||m.push(ht,ht,ht)}}i.push(Z[0],Z[1],G[0],G[1],X[0],X[1],Y[0],Y[1],V[0],V[1],Y[0],Y[1],Z[0],Z[1],G[0],G[1],H[0],H[1],G[0],G[1],X[0],X[1],Y[0],Y[1]),r?t.push(M,T,L,I,E,k,M,T,L,M,T,L,I,E,k,I,E,k):t.push(M,T,I,E,M,T,M,T,I,E,I,E),it&&we(d,M,T,r&&L,D,O,t,i),A&&we(f,I,E,r&&k,-D,-O,t,i),null==m||m.push(ht,S,ht,ht,S,S)}ot=!1,z=G,P=Y,W=U,N=B,st=I,rt=E,nt=k,M=I,T=E,L=k,q=l,j=lt}},Me=32,Te=(t,e,i)=>{for(var s;++e<t.length;){let r=t.charAt(e),n=null===(s=i.glyphInfos[r])||void 0===s?void 0:s.glyph;if(n){let{direction:t}=n;if(t)return t}}},Le=(t,e,i,s,r,n,o)=>{let{offset:a,x:l}=o,{spaceWidth:h}=e,c=e.glyphInfos[t],u=0;const d=r.data,f=null!=s;let p=r.length;const g=n.data;let m=n.length,v=i>>5,x=31&i,y=0;if(c){let{glyph:t}=c,e=c.u1<<5|x,i=c.u2<<5|x,r=c.v1<<5|v,n=c.v2<<5|v,{advanceX:o}=t;y=t.width;let{width:h,height:_}=t.data;u=l+h;const b=l*Me,w=u*Me;_*=Me,d[p++]=b,d[p++]=0,f&&(d[p++]=s),d[p++]=w,d[p++]=_,f&&(d[p++]=s),d[p++]=b,d[p++]=_,f&&(d[p++]=s),d[p++]=w,d[p++]=0,f&&(d[p++]=s),d[p++]=w,d[p++]=_,f&&(d[p++]=s),d[p++]=b,d[p++]=0,f&&(d[p++]=s),g[m++]=e,g[m++]=r,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=n,g[m++]=i,g[m++]=r,g[m++]=i,g[m++]=n,g[m++]=e,g[m++]=r,l+=o,a+=12}else" "==t&&(l+=h);r.length=p,n.length=m,o.x=l,o.offset=a,o.boxWidth=u,o.textWidth+=y},ze=(t,e,i,s,r,n,o,a,l,h)=>{for(let c,u,d=e,f=i;d<f;d++){if(c=s?e+(f-1-d):d,u=t.charAt(c),s&&G(t.charCodeAt(c))){let e=c,i=0;for(;--e>=0;)if(!G(t.charCodeAt(e))){for(;++e<=c;)Le(t.charAt(e),r,n,o,a,l,h),i++;break}if(i){d+=i-1;continue}}Le(u,r,n,o,a,l,h)}},Pe=(t,e,i,s,r=0,n)=>{const o=t.length;i.reserve(18*o),s.reserve(12*o),n&&(n=32767*n/(2*Math.PI)^0);const a={x:0,boxWidth:0,offset:0,textWidth:0};let l,h,c,u=0;r=Math.round(r);for(let d=0;d<o;d++){let f=t.charAt(d),p=e.glyphInfos[f],g=d==o-1,m=0;const v=null==p?void 0:p.glyph;if(v&&(m=v.direction),!l){if(" "==f)continue;m=m||1,l=m}if(void 0!==h){let o=!0;if(!m){let i=Te(t,d,e);o=i&&i!=h}if(o&&m!=h){let o=d-1;" "==c&&1==m&&o--,o++,ze(t,u,o,-1==h,e,r,n,i,s,a),u=o}}if(g&&u<=d){let o,c=d+Number(" "!=f);o=m?-1==m:h!=l,ze(t,u,c,o,e,r,n,i,s,a)}m&&(h=m),c=f}return{count:a.offset/2,position:i.data,texcoord:s.data,width:a.boxWidth}};let Ce=Z.getInstance();class Ie{constructor(t,e,i,s){this.x=0,this.y=0,this.glyphInfos={},this.avgCharWidth=0,this.glyphs=0;const r=Ce.initFont(t,e);if(this.style=t,this.letterHeight=r.letterHeight,this.lineHeight=r.letterHeight*e,this.baselineOffset=r.baselineOffset,this.rowHeight=r.rowHeight,this.spaceWidth=r.spaceWidth,!i)for(i=1;i<r.rowHeight;)i*=2;i*=e,this.width=i,this.height=i,this.maxWidth=i,this.maxHeight=i,this.style=t,this.scale=e,this.font=r,s&&this.addChars(s)}getTextWidth(t){return Ce.getTextWidth(t,this.font)}placeGlyph(t){const{rowHeight:e}=this;if(this.x+t>this.width){let t=this.y+2*e;t>this.maxHeight?t>this.height?(this.height*=2,this.width*=2,0==this.x?this.maxWidth=this.maxWidth=this.width:(this.x=this.maxWidth,this.y=0)):(this.x=0,this.y+=e,this.maxHeight=this.height,this.maxWidth=this.width):(this.y+=e,this.maxHeight<this.height?this.x=this.maxWidth:this.x=0)}}addChars(t){const{glyphInfos:e,rowHeight:i}=this;let s=!1;for(let r of t)if(" "!=r&&!e[r]){let t=Ce.getGlyph(r,this.font),n=r.charCodeAt(0),o=t.data.width,a=t.width;if(n){this.avgCharWidth=(this.avgCharWidth*this.glyphs+a)/++this.glyphs,s=!0,this.placeGlyph(o);const{x:n,y:l}=this;e[r]={u1:n,v1:l,u2:n+o,v2:l+i,glyph:t},this.x+=o}}return s}}class Ee extends ne{constructor(t,e,i){super(t,null,{format:t.LUMINANCE_ALPHA}),this.dirty=!1;const{dpr:s}=t;this.atlas=new Ie(e,s,i)}addChars(t){this.dirty=this.atlas.addChars(t)||this.dirty}bufferLength(t,e=2){let i=0;for(let e of t)" "!=e&&i++;return 6*i*e}getAtlas(){return this.atlas}sync(){if(this.dirty){const{atlas:t,gl:e}=this,i=t.glyphInfos;this.set({width:t.width,height:t.height});for(let t in i){let e=i[t];this.set(e.glyph.data,e.u1,e.v1)}}}destroy(){this.atlas=null,super.destroy()}}class ke{constructor(t,e=128){this.length=0,oe(t)?(this.data=t,this.length=this.size=this.data.length):this.data=new t(this.size=e)}get(t){return this.data[t]}set(t,e=0){const{length:i}=t,s=e+i;s&&this.reserve(s),this.data.set(t,e),this.length=s}push(t){const e=arguments.length;this.reserve(e);for(let t=0;t<e;t++)this.data[this.length++]=arguments[t];return this.length}reserve(t){const{data:e}=this,i=t-(this.size-this.length);i>0&&(this.size+=Math.max(i,this.size),this.data=new e.constructor(this.size),this.length&&this.data.set(e))}trim(){let{size:t,length:e}=this;return t!=e&&(this.data=this.data.slice(0,e)),this.data}}class Re{constructor(t,e=!1){this.i32=!1,this._flat=!0,this.instances=0,this.uniforms={},this._flat=t,this.clip=e,this.idOffsets=[],this.cullFace=1028,this.first=0}addUniform(t,e){this.uniforms[t]=e}count(){if(null!=this._cnt)return this._cnt;const{data:t,size:e}=this.flexAttributes.a_position;return t.length/e-this.first}setArray(t,e){this.first=t,this._cnt=e}setIndex(t){this._index=t}index(){return this._index=this._index||[]}hasIndex(){return!!this._index}isEmpty(){return 0==this.count()}trimAttribute(t){const e=t;return e.data instanceof ke&&(e.data=e.data.trim()),e}isFlat(){return this._flat}finalize(t){var e;const i=this,{flexAttributes:s}=i;let r;if(i.hasIndex()){const e=i.index();if(!e.length)return null;r=new he(e,t,i.i32)}else r=new he({first:i.first,count:i.count()},t);for(let t in s){let n=s[t];(null===(e=n.data)||void 0===e?void 0:e.length)&&r.addAttribute(t,i.trimAttribute(n))}return r.idOffsets=i.idOffsets,r}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(t)}rayIntersects(t,e,i,s,r){return null}}var Fe=1e-6,De="undefined"!=typeof Float32Array?Float32Array:Array;function Oe(){var t=new De(3);return De!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ue(t,e,i){var s=new De(3);return s[0]=t,s[1]=e,s[2]=i,s}function Be(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function We(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Ne(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function Ge(t,e){var i=e[0],s=e[1],r=e[2],n=i*i+s*s+r*r;return n>0&&(n=1/Math.sqrt(n)),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Ze(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function He(t,e,i){var s=e[0],r=e[1],n=e[2],o=i[0],a=i[1],l=i[2];return t[0]=r*l-n*a,t[1]=n*o-s*l,t[2]=s*a-r*o,t}function Ye(t,e,i){var s=e[0],r=e[1],n=e[2],o=i[3]*s+i[7]*r+i[11]*n+i[15];return o=o||1,t[0]=(i[0]*s+i[4]*r+i[8]*n+i[12])/o,t[1]=(i[1]*s+i[5]*r+i[9]*n+i[13])/o,t[2]=(i[2]*s+i[6]*r+i[10]*n+i[14])/o,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function Ve(){var t=new De(16);return De!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function Xe(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function je(t,e){var i=e[0],s=e[1],r=e[2],n=e[3],o=e[4],a=e[5],l=e[6],h=e[7],c=e[8],u=e[9],d=e[10],f=e[11],p=e[12],g=e[13],m=e[14],v=e[15],x=i*a-s*o,y=i*l-r*o,_=i*h-n*o,b=s*l-r*a,w=s*h-n*a,A=r*h-n*l,S=c*g-u*p,M=c*m-d*p,T=c*v-f*p,L=u*m-d*g,z=u*v-f*g,P=d*v-f*m,C=x*P-y*z+_*L+b*T-w*M+A*S;return C?(C=1/C,t[0]=(a*P-l*z+h*L)*C,t[1]=(r*z-s*P-n*L)*C,t[2]=(g*A-m*w+v*b)*C,t[3]=(d*w-u*A-f*b)*C,t[4]=(l*T-o*P-h*M)*C,t[5]=(i*P-r*T+n*M)*C,t[6]=(m*_-p*A-v*y)*C,t[7]=(c*A-d*_+f*y)*C,t[8]=(o*z-a*T+h*S)*C,t[9]=(s*T-i*z-n*S)*C,t[10]=(p*w-g*_+v*x)*C,t[11]=(u*_-c*w-f*x)*C,t[12]=(a*M-o*L-l*S)*C,t[13]=(i*L-s*M+r*S)*C,t[14]=(g*y-p*b-m*x)*C,t[15]=(c*b-u*y+d*x)*C,t):null}function qe(t,e,i){var s=e[0],r=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],g=e[12],m=e[13],v=e[14],x=e[15],y=i[0],_=i[1],b=i[2],w=i[3];return t[0]=y*s+_*a+b*u+w*g,t[1]=y*r+_*l+b*d+w*m,t[2]=y*n+_*h+b*f+w*v,t[3]=y*o+_*c+b*p+w*x,y=i[4],_=i[5],b=i[6],w=i[7],t[4]=y*s+_*a+b*u+w*g,t[5]=y*r+_*l+b*d+w*m,t[6]=y*n+_*h+b*f+w*v,t[7]=y*o+_*c+b*p+w*x,y=i[8],_=i[9],b=i[10],w=i[11],t[8]=y*s+_*a+b*u+w*g,t[9]=y*r+_*l+b*d+w*m,t[10]=y*n+_*h+b*f+w*v,t[11]=y*o+_*c+b*p+w*x,y=i[12],_=i[13],b=i[14],w=i[15],t[12]=y*s+_*a+b*u+w*g,t[13]=y*r+_*l+b*d+w*m,t[14]=y*n+_*h+b*f+w*v,t[15]=y*o+_*c+b*p+w*x,t}function $e(t,e,i){var s,r,n,o,a,l,h,c,u,d,f,p,g=i[0],m=i[1],v=i[2];return e===t?(t[12]=e[0]*g+e[4]*m+e[8]*v+e[12],t[13]=e[1]*g+e[5]*m+e[9]*v+e[13],t[14]=e[2]*g+e[6]*m+e[10]*v+e[14],t[15]=e[3]*g+e[7]*m+e[11]*v+e[15]):(s=e[0],r=e[1],n=e[2],o=e[3],a=e[4],l=e[5],h=e[6],c=e[7],u=e[8],d=e[9],f=e[10],p=e[11],t[0]=s,t[1]=r,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=h,t[7]=c,t[8]=u,t[9]=d,t[10]=f,t[11]=p,t[12]=s*g+a*m+u*v+e[12],t[13]=r*g+l*m+d*v+e[13],t[14]=n*g+h*m+f*v+e[14],t[15]=o*g+c*m+p*v+e[15]),t}function Ke(t,e,i){var s=i[0],r=i[1],n=i[2];return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}Oe();var Qe=function(t,e,i,s,r){var n,o=1/Math.tan(e/2);return t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(n=1/(s-r),t[10]=(r+s)*n,t[14]=2*r*s*n):(t[10]=-1,t[14]=-2*s),t};var Je=function(t,e,i,s,r,n,o){var a=1/(e-i),l=1/(s-r),h=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+i)*a,t[13]=(r+s)*l,t[14]=(o+n)*h,t[15]=1,t};class ti{constructor(t,e){this.localRay={origin:new Float32Array(3),direction:new Float32Array(3),modelMatrix:new Float32Array(16),invModelMatrix:new Float32Array(16)},this.sMat=t,this.iSMat=e,this.origin=[0,0,0],this.direction=[0,0,0],this.sOrigin=[0,0,0],this.sDirection=[0,0,0],this.pIntersection=[0,0,0],this.intersectRayLength=0}static rayIntersectsTriangle(t,e,i,s,r,n){const o=1e-7,a=We([0,0,0],s,i),l=We([0,0,0],r,i),h=He([0,0,0],e,l),c=Ze(a,h);if(c>-1e-7&&c<o)return null;const u=1/c,d=We([0,0,0],t,i),f=u*Ze(d,h);if(f<0||f>1)return null;const p=He([0,0,0],d,a),g=u*Ze(e,p);if(g<0||f+g>1)return null;const m=u*Ze(l,p);return m>o?(n&&Be(n,t,Ne(n,e,m)),m):null}static getPointAtRayLength(t,e,i,s=[]){return Be(s,e,Ne(s,i,t))}getInverseScale(t){return t?this.invMapScale:this.invVpScale}intersectAABBox(t,e,i,s,r,n,o=this.origin,a=this.direction){const[l,h,c]=a,[u,d,f]=o,p=1/l,g=1/h,m=1/c,v=(t-u)*p,x=(s-u)*p,y=(e-d)*g,_=(r-d)*g,b=(i-f)*m,w=(n-f)*m,A=Math.min(Math.min(Math.max(v,x),Math.max(y,_)),Math.max(b,w));if(A<0)return null;const S=Math.max(Math.max(Math.min(v,x),Math.min(y,_)),Math.min(b,w));return S>A?null:S}intersectSphere(t,e){const i=We([],t,this.origin),s=Ze(i,this.direction),r=Ze(i,i)-s*s,n=e*e;if(r>n)return null;const o=Math.sqrt(n-r),a=s-o,l=s+o;return a<0&&l<0?null:a<0?l:a}intersectEllipsoid(t,e){const i=We([],this.origin,t),s=this.direction,r=e[0]*e[0],n=e[1]*e[1],o=e[2]*e[2],a=s[0]*s[0]/r+s[1]*s[1]/n+s[2]*s[2]/o,l=2*i[0]*s[0]/r+2*i[1]*s[1]/n+2*i[2]*s[2]/o;let h=l*l-4*a*(i[0]*i[0]/r+i[1]*i[1]/n+i[2]*i[2]/o-1);if(h<0)return null;h=Math.sqrt(h);const c=(-l+h)/(2*a),u=(-l-h)/(2*a);return c<u?c:u}init(t,e,i,s,r,n){const{sMat:o,iSMat:a,origin:l,direction:h,sOrigin:c,sDirection:u}=this;this.w=i,this.h=s,this.scale=r,this.invMapScale=[1/r,1/r,1/r/n],this.invVpScale=[2/i,2/s],this.scaleZ=n,c[0]=t,c[1]=e,c[2]=-1,h[0]=t,h[1]=e,h[2]=0,Ye(l,c,a),Ye(h,h,a),Ye(u,h,o),We(u,u,c),Ge(u,u),We(h,h,l),Ge(h,h),this.result={id:null,z:1/0,pointWorld:null}}rayLengthScreenToWorld(t){const e=this.iSMat,i=this.origin[2],s=this.direction[2],r=t[0],n=t[1];let o=t[2];const a=e[3]*r+e[7]*n+e[11]*o+e[15];return o=(e[2]*r+e[6]*n+e[10]*o+e[14])/(a||1),(o-i)/s}getIntersectionTop(){const{result:t}=this;if(t.z!=1/0){let e=ti.getPointAtRayLength(t.z,t.origin||this.origin,t.direction||this.direction);if(t.localMatrix){const i=t.z;e=Ye([],Be([],t.origin,Ne([],t.direction,i)),t.localMatrix)}t.pointWorld=e}return t}transformRayToLocal(t){const e=this.localRay,i=je(e.invModelMatrix,t);Ye(e.origin,this.origin,i);const s=this.direction,r=e.direction;return r[0]=s[0]*i[0]+s[1]*i[4]+s[2]*i[8],r[1]=s[0]*i[1]+s[1]*i[5]+s[2]*i[9],r[2]=s[0]*i[2]+s[1]*i[6]+s[2]*i[10],Ge(r,r),e.modelMatrix=t,e}intersect(t,e,i,s){if(!1===i.pointerEvents)return;const r=this.result;let n=this.origin,o=this.direction;s&&(this.origin=s.origin,this.direction=s.direction,t=0,e=0);const a=i.rayIntersects(i,r,t,e,this);return null!=a&&(r.id=a,r.origin=null==s?void 0:s.origin.slice(),r.direction=null==s?void 0:s.direction.slice(),r.localMatrix=null==s?void 0:s.modelMatrix),this.origin=n,this.direction=o,a}}class ei extends Re{constructor(t=!0){super(t,!0),t||(this.cullFace=null),this.flexAttributes={a_position:{data:new ke(Float32Array),size:t?2:3},a_normal:{data:new ke(Int16Array),size:4},a_lengthSoFar:{data:new ke(Float32Array),size:1}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,s,r){const{attributes:n}=t;let o=n.a_position.data,a=n.a_normal.data,l=n.a_position.size;const h=[0,0,0],c=[0,0,0],u=[0,0,0];let d=r.origin,f=r.direction,p=.5*t.getUniform("u_strokeWidth")[0]/r.scale;const g=t.getUniform("u_scaleByAltitude"),m=1/8192;let v;const x=r.sMat[3],y=r.sMat[7],_=r.sMat[11],b=r.sMat[15];for(let t=0,r=0;t<o.length;r+=12){let n=a[r],w=a[r+1];n=(2*(1&n)-1)*(n>>1)*m;w=(2*(1&w)-1)*(w>>1)*m;let A=o[t++],S=o[t++],M=3==l?o[t++]:0,T=a[r+4],L=a[r+5];T=(2*(1&T)-1)*(T>>1)*m;L=(2*(1&L)-1)*(L>>1)*m;let z=o[t++],P=o[t++],C=3==l?o[t++]:0,I=a[r+8],E=a[r+9];I=(2*(1&I)-1)*(I>>1)*m;E=(2*(1&E)-1)*(E>>1)*m;let k=o[t++],R=o[t++],F=3==l?o[t++]:0;const D=i+A,O=s+S,U=1+(g?0:M*_/(x*D+y*O+b));h[0]=D+n*p*U,h[1]=O+w*p*U,h[2]=M,c[0]=i+z+T*p*U,c[1]=s+P+L*p*U,c[2]=C,u[0]=i+k+I*p*U,u[1]=s+R+E*p*U,u[2]=F;let B=ti.rayIntersectsTriangle(d,f,h,c,u);null!=B&&B<=e.z&&(e.z=B,v=t-l)}if(null!=v)for(let i=0,{idOffsets:s}=t,{length:r}=s;i<r;i+=2)if(v<s[i])return e.id=s[i+1]}}const ii=[0,0,1,0,0,1,0,1,1,0,1,1],si=(t,e,i,s)=>{const r=new he({first:0,count:6},"Image");return r.addAttribute("a_position",{data:new Int16Array([0,0,i,0,0,i,0,i,i,0,i,i]),size:2,stride:0}),r.addAttribute("a_textureCoord",{data:new Int8Array(ii),size:2,stride:0}),r.addUniform("u_tileScale",1),r.addUniform("u_sampler",new ne(e,t)),r.zIndex=0,r.clip=!0,r.blend=s,r.pass=s?Nt.ALPHA:Nt.OPAQUE,r.pixelPerfect=!0,r.pointerEvents=!1,r.cullFace(1028),r},{toRGB:ri}=e;let ni;class oi{constructor(t,e=[]){this.gl=t,this.ext={};for(let t of e)this.getExtension(t)}getExtension(t){const{ext:e,gl:i}=this;let s=e[t];return void 0===s&&(s=e[t]=i.getExtension(t)),s}}class ai{constructor(t,e,i,s){this.tiled=!0,this._modelMatrix=Ve(),this._mvpMatrix=Ve(),this._invModelMatrix=Ve(),this.init(t,e,i,s)}init(t,e,i,s){this.buffer=t,this.z=e,this.data=i,this.layer=s,Xe(this._modelMatrix),this._mmUpdated=!1,this._mvpUpdated=!1,this._iMMUpdate=!0}reset(){this.buffer=null,this.data=null,this.layer=null}getModelMatrix(){return this._modelMatrix}getInverseModelMatrix(){return this._iMMUpdate&&(this._iMMUpdate=!1,je(this._invModelMatrix,this._modelMatrix)),this._invModelMatrix}worldToTile(t,e,i){const s=[t,e,i||0];return Ye(s,s,this.getInverseModelMatrix())}updateMVPMatrix(t){return this._mmUpdated?this._mvpUpdated?this._mvpMatrix:(this._mvpUpdated=!0,qe(this._mvpMatrix,t,this._modelMatrix)):t}setTransform(t,e,i){if(!this._mmUpdated){this._mmUpdated=!0,this._iMMUpdate=!0;const s=this._modelMatrix;s[12]=t,s[13]=e,s[0]=i,s[5]=i}return this._modelMatrix}}class li{constructor(){this.pool=[],this.index=0}beginFrame(){this.index=0}getNext(){this.index>=this.pool.length&&this.pool.push(new ai);return this.pool[this.index++]}endFrame(){for(let t=this.index;t<this.lastClearedIndex;t++)this.pool[t].reset();this.lastClearedIndex=this.index}getUsedNodes(){return this.pool.slice(0,this.index)}}var hi=e.toRGB;const ci={ortho:Je,create:Ve,lookAt:function(t,e,i,s){var r,n,o,a,l,h,c,u,d,f,p=e[0],g=e[1],m=e[2],v=s[0],x=s[1],y=s[2],_=i[0],b=i[1],w=i[2];return Math.abs(p-_)<Fe&&Math.abs(g-b)<Fe&&Math.abs(m-w)<Fe?Xe(t):(c=p-_,u=g-b,d=m-w,r=x*(d*=f=1/Math.hypot(c,u,d))-y*(u*=f),n=y*(c*=f)-v*d,o=v*u-x*c,(f=Math.hypot(r,n,o))?(r*=f=1/f,n*=f,o*=f):(r=0,n=0,o=0),a=u*o-d*n,l=d*r-c*o,h=c*n-u*r,(f=Math.hypot(a,l,h))?(a*=f=1/f,l*=f,h*=f):(a=0,l=0,h=0),t[0]=r,t[1]=a,t[2]=c,t[3]=0,t[4]=n,t[5]=l,t[6]=u,t[7]=0,t[8]=o,t[9]=h,t[10]=d,t[11]=0,t[12]=-(r*p+n*g+o*m),t[13]=-(a*p+l*g+h*m),t[14]=-(c*p+u*g+d*m),t[15]=1,t)},multiply:qe,perspective:Qe,rotateX:function(t,e,i){var s=Math.sin(i),r=Math.cos(i),n=e[4],o=e[5],a=e[6],l=e[7],h=e[8],c=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*r+h*s,t[5]=o*r+c*s,t[6]=a*r+u*s,t[7]=l*r+d*s,t[8]=h*r-n*s,t[9]=c*r-o*s,t[10]=u*r-a*s,t[11]=d*r-l*s,t},rotateZ:function(t,e,i){var s=Math.sin(i),r=Math.cos(i),n=e[0],o=e[1],a=e[2],l=e[3],h=e[4],c=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*r+h*s,t[1]=o*r+c*s,t[2]=a*r+u*s,t[3]=l*r+d*s,t[4]=h*r-n*s,t[5]=c*r-o*s,t[6]=u*r-a*s,t[7]=d*r-l*s,t},translate:$e,scale:Ke,clone:function(t){var e=new De(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},invert:je,identity:Xe},ui=2*Math.PI,di=Math.PI/180,fi=40*di,pi="ANGLE_instanced_arrays",gi={font:"bold 14px Arial",stroke:"red",fill:"white",strokeWidth:3},mi=72*di,vi=[[0,0,1]];class xi{constructor(t){this.skyMatrix=new Float32Array([2,0,0,0,0,-1,0,0,0,0,1,0,-1,1,0,1]),this.skyBuffer=(()=>{const t=new he({first:0,count:6},"Sky");return t.addAttribute("a_position",{data:new Int8Array([0,0,1,0,0,1,0,1,1,0,1,1]),size:2}),t.id="sky",t.addUniform("u_fill",[0,0,0,1]),t.addUniform("u_horizon",[0,0]),t.clip=!1,t.depth=!1,t.depthMask=!1,t.pass=Nt.OPAQUE|Nt.ALPHA,t.blend=!1,t})(),this.sky=new ai(this.skyBuffer),this.cameraWorld=new Float64Array(3),this.gridTextBuf=new WeakMap,this.tileGrid=!1,this.dbgTile={},this.dbgRenderTile=new ai,this.processedLight=[],this.buffers=new WeakMap,this.resolution=[],this.viewUniforms={rz:0,elapsedTime:0,fixedView:0,inverseMatrix:new Float32Array(16)},this._tm=new Float32Array(16),this.reservedStencils=new Map,this.ctxAttr=Object.assign({alpha:!0,antialias:!1,depth:!0,stencil:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1},t),this.vPMat=ci.create(),this.vPRasterMat=ci.create(),this.vMat=ci.create(),this.invVPMat=ci.create(),this.screenMat=ci.create(),this.invScreenMat=ci.create(),this._tmpMatrix=ci.create(),this.worldMatrix=new Float64Array(16),this.localCamera=new Float64Array(3)}getContext(){return this.gl}setPass(t){const{gl:e}=this;switch(this.pass=t,t){case Nt.OPAQUE:this.depthMask=!0,this.depthFnc=e.LESS;break;case Nt.ALPHA:this.depthFnc=e.LEQUAL,this.depthMask=!1;break;case Nt.POST_ALPHA:this.depthFnc=e.EQUAL,this.depthMask=!1,e.disable(e.SCISSOR_TEST),e.clear(e.STENCIL_BUFFER_BIT)}}convertColor(t){return hi(t)}setBackgroundColor(t){var e,i;null===(e=this.gl)||void 0===e||e.clearColor(t[0],t[1],t[2],null!==(i=t[3])&&void 0!==i?i:1)}setSkyColor(t){this.skyBuffer.addUniform("u_fill",t)}setScale(t,e,i){}setRotation(t,e){}clear(t){const{gl:e}=this;e.bindFramebuffer(e.FRAMEBUFFER,null),t&&this.setBackgroundColor(t),e.colorMask(!0,!0,!0,!0),e.disable(e.SCISSOR_TEST),e.depthMask(!0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT),this.reservedStencils.clear()}init(t,e){this.dpr=e;const i=t.getContext("webgl",this.ctxAttr);i.dpr=e,this.startTime=Date.now(),this.gl=i,this.glExt=new oi(i,["OES_element_index_uint",pi,"OES_texture_float"]),this.initContext();const s=((t,e)=>{const i=si({width:1,height:1,data:new Uint8ClampedArray([255,255,255,255])},e,1,!1);return i.id="StencilTile",i.clip=!0,i.depth=!1,i.pass=Nt.OPAQUE,i})(0,i);s.pass=Nt.OPAQUE|Nt.ALPHA,s.blend=!0,s.colorMask={r:!1,g:!1,b:!1,a:!1},s.depthMask=!1,this.stencilTile=s,this.depthBufferSize=1<<i.getParameter(i.DEPTH_BITS);const r=this.programConfig={Rect:{program:Yt},Line:{program:qt},DashedLine:{program:$t,default:!1},Text:{program:Jt},Image:{program:Qt},Circle:{program:Vt},Polygon:{program:Kt},VerticalLine:{program:de},Extrude:{program:ee,default:!1},Icon:{program:te},Box:{program:ie,default:!1},Sphere:{program:se,default:!1},Model:{program:re,default:!1},Heatmap:{program:ue,default:!1},Sky:{program:fe}};this.programs={};for(let t in r){const e=r[t];!1!==e.default&&this.createProgram(t,e.program)}}createProgram(t,e,i){const{gl:s,programs:r,dpr:n}=this;r[t]&&r[t].delete();const o=r[t]=new e(s,n,i);return o.init(this.buffers,this.glExt.getExtension(pi)),o}initContext(){const{gl:t}=this;t.enable(t.CULL_FACE),t.cullFace(t.FRONT),t.enable(t.DEPTH_TEST),t.enable(t.SCISSOR_TEST),t.clearStencil(0),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA)}grid(t){if("object"==typeof t){if(null!=t.grid3d){re.dbgGrid=!!t.grid3d;for(let t in this.programs)t.startsWith("Model")&&(this.programs[t].delete(),delete this.programs[t])}}else this.tileGrid=t}applyTransform(){}updateMapGridMatrix(t,e,i){const s=e/2,r=i/2,n=r/Math.tan(fi/2),o=this._tmpMatrix,a=[s,r,n];return ci.perspective(o,fi,e/i,.1,1e5),this.updateVPMatrix(o,a,t,0,[1,1,1]),o}updateVPMatrix(t,e,i,s,r,n=this._tm){const[o,a]=e;return ci.lookAt(n,e,[o,a,0],[0,1,0]),ci.translate(n,n,[o,a,0]),ci.rotateX(n,n,-i),ci.rotateZ(n,n,-s),ci.scale(n,n,[r[0],-r[1],r[2]]),ci.translate(n,n,[-o,-a,0]),ci.multiply(t,t,n)}initView(t,e,i,s,r,n,o,a,l){const h=this.vPMat,c=this.vMat;this.zMeterToPixel=1/n;const u=.5*fi,d=.5*t,f=.5*e,p=f/Math.tan(u),g=Math.sin(u)*p,m=Math.min(s,_r),v=.5*Math.PI-u-m;let x=p+(s>m?Math.cos(Math.PI/2-s):Math.sin(m))*(g/Math.sin(v));x*=1.005,this.rz=(r+ui)%ui,this.rx=s,this.scale=i,this.setResolution(t,e),this.gl.viewport(0,0,t*this.dpr,e*this.dpr);const y=e/100;ci.perspective(h,fi,t/e,y,x),this.worldMatrix.set(h),this.updateVPMatrix(this.worldMatrix,[o,a,p],s,r,[l,l,l]),this.updateVPMatrix(h,[d,f,p],s,r,[i,i,i/n],c),je(this.invVPMat,h);let _=ci.identity(this.screenMat);ci.scale(_,_,[d,-f,1]),ci.translate(_,_,[1,-1,0]),ci.multiply(_,_,this.vPMat),je(this.invScreenMat,_),this.updateCamWorld(this.cameraWorld);const b=ci.copy(this.vPRasterMat,h),w=o*l,A=a*l,S=w-Math.round(w)+d%1,M=A-Math.round(A)+f%1;ci.translate(b,b,[S-Math.round(S),M-Math.round(M),0]),this.distanceCam2Center=p,this.initSharedUniforms(),this.initDisplayUniforms()}updateCamWorld(t){const e=this.invVPMat;t[0]=e[12]/e[15],t[1]=e[13]/e[15],t[2]=e[14]/e[15]}getCameraElevationMeters(){return-this.cameraWorld[2]}initDisplayUniforms(){const{viewUniforms:t}=this;t.rz=this.rz,t.elapsedTime=(Date.now()-this.startTime)/1e3,t.inverseMatrix=this.invVPMat,t.fixedView=this.fixedView}initSharedUniforms(){this.sharedUniforms={u_resolution:this.resolution,u_scale:null,u_topLeft:[0,0],u_matrix:this.vPMat,u_zMeterToPixel:null}}useProgram(t){const e=this.prog;if(e!=t){const i=this.gl;return e&&e.disableAttributes(),i.useProgram(t.prog),this.prog=t,!0}return!1}drawGrid(t,e,i,s){let r=this.dbgRenderTile;r.init(this.getDbgTile(s)),this.drawBuffer(r,t,e,null,null);let n=this.gridTextBuf.get(i);n||(n=((t,e,i)=>{ni||(ni=new Ee(e,i),ni.addChars("L0123456789"),ni.sync());const s=t+" L"+t.length,{length:r}=s,n=new ke(Int16Array,18*r),o=new ke(Uint16Array,12*r),{position:a,count:l,texcoord:h}=Pe(s,ni.atlas,n,o);let c=new he({first:0,count:l},"Text");return c.addAttribute("a_position",{data:new Int8Array(a.length).fill(1),size:2,stride:0}),c.addAttribute("a_point",{data:a,size:2,stride:0}),c.addAttribute("a_texcoord",{data:h,size:2,stride:0}),c.pass=Nt.ALPHA,c.depth=!1,c.clip=!1,c.addUniform("u_texture",ni),c.addUniform("u_texSize",[ni.width,ni.height]),c.addUniform("u_opacity",1),c.addUniform("u_alignMap",!0),c.addUniform("u_fillColor",ri(i.fill)),c.addUniform("u_strokeColor",ri(i.stroke)),c})(i.quadkey,this.gl,gi),this.gridTextBuf.set(i,n)),r.init(n),this.drawBuffer(r,t+4,e+4)}deleteBuffer(t){const{buffers:e,gl:i}=this;let{attributes:s,uniforms:r}=t;for(let t in r){let e=r[t];if(e.format){0===(e.ref=(e.ref||1)-1)&&e.destroy()}}for(let t in s){let r=s[t];if(0===(r.ref=(r.ref||1)-1)){let t=e.get(r);i.deleteBuffer(t)}}for(let s of t.groups){const t=s.index;t&&i.deleteBuffer(e.get(t))}t.destroy(t)}initProgram(t,e,i,s=e.getUniformData(),r){const n=e.getAttributes();this.useProgram(t),t.setResolution(this.resolution),t.initBuffers(n),t.initGeometryBuffer(e,i,this.zIndex),t.initAttributes(n),t.initUniforms(this.sharedUniforms),t.initViewUniforms(this.viewUniforms),e.light&&this.bufferLightUniforms&&t.initLight(this.bufferLightUniforms,r||this.cameraWorld),t.initUniforms(s)}drawBuffer(t,e,i,s,r,n){const o=t.buffer,{gl:a,pass:l}=this,h=this.getProgram(o);if(h){const c=null==s&&void 0!==r;r||(r=1);const u=this.zIndex,d=o.flat&&u>this.min3dZIndex;let f=h.initPass(l,o);if(d&&o.pass==Nt.OPAQUE&&(f=l==Nt.ALPHA),f){const f=o.compileUniforms();if(!h.isBufferVisible(f.uniforms))return;const{sharedUniforms:p}=this;p.u_scale=this.scale*r,p.u_matrix=s||t.updateMVPMatrix(o.pixelPerfect?this.vPRasterMat:this.vPMat),p.u_zMeterToPixel=this.zMeterToPixel/r,this.viewUniforms.fixedView=this.fixedView;const g=o.needs2AlphaPasses();let m=null;(n||o.clip&&o.isFlat())&&(m=this.drawStencil(e,i,r));let{depthFnc:v,depthMask:x}=this,y=xi.DEFAULT_COLOR_MASK;g&&(l==Nt.ALPHA?(y=xi.NO_COLOR_MASK,x=!0):l==Nt.POST_ALPHA&&(null!=m?(a.stencilFunc(a.EQUAL,m,255),a.stencilOp(a.KEEP,a.KEEP,a.KEEP)):(a.stencilFunc(a.EQUAL,0,255),a.stencilOp(a.KEEP,a.KEEP,a.INCR),a.enable(a.STENCIL_TEST)))),a.depthFunc(v),a.depthMask(x),h.setColorMask(y),p.u_topLeft[0]=e,p.u_topLeft[1]=i;const _=(65535-u)/65536;a.depthRange(o.flat?_:0,_);let b=this.cameraWorld;c&&o.light&&(b=this.getLocalCameraPosition(t.getModelMatrix())),this.initProgram(h,o,l,o.getUniformData(),b),g&&l==Nt.POST_ALPHA&&a.enable(a.STENCIL_TEST),d&&a.disable(a.DEPTH_TEST),h.draw(o,c)}}}getLocalCameraPosition(t){const{localCamera:e,cameraWorld:i,zMeterToPixel:s}=this;return Ye(e,i,je([],t)),e}initStencil(t,e,i=vi){this.stencilVal=t,this.stencilSize=e,this.tileStencils=i}reserveStencilValue(t){const{reservedStencils:e}=this;let i=e.get(t);return i||(i=e.size+1,i>255&&(i=1,e.clear(),this.gl.clear(this.gl.STENCIL_BUFFER_BIT)),e.set(t,i)),i}drawStencil(t,e,i){const{gl:s,stencilTile:r,sharedUniforms:n}=this,o=this.getProgram(r),a=16777216*i+this.stencilVal,l=this.reserveStencilValue(a);s.stencilFunc(s.ALWAYS,l,255),s.stencilOp(s.REPLACE,s.REPLACE,s.REPLACE);for(let i of this.tileStencils)n.u_topLeft[0]=t+i[0]*this.stencilSize,n.u_topLeft[1]=e+i[1]*this.stencilSize,r.uniforms.u_tileScale=this.stencilSize*i[2],this.initProgram(o,r,this.pass,r.uniforms),s.enable(s.STENCIL_TEST),o.draw(r);return s.stencilFunc(s.EQUAL,l,255),s.stencilOp(s.KEEP,s.KEEP,s.KEEP),l}initScissor(t,e,i,s){const{gl:r}=this,n=r.canvas.width,o=r.canvas.height;if(this.scale>4||-this.rx>mi)return[0,0,n,o];const a=t+i,l=e+i,h=[t,l,0],c=[a,l,0],u=[t,e,0],d=[a,e,0];let f=1/0,p=-f,g=f,m=p;for(let t of[h,c,u,d]){let[e,i]=Ye(t,t,s);e<f&&(f=e),e>p&&(p=e),i<g&&(g=i),i>m&&(m=i)}f=Math.round(.5*(f+1)*n),p=Math.round(.5*(p+1)*n),g=Math.round(.5*(g+1)*o),m=Math.round(.5*(m+1)*o);return[f,g,p-f,m-g]}initBufferScissorBox(t,e,i){if(t.clip){let s=e.size,{x:r,y:n,tile:o}=e,a=this.vPMat;if(i){const[t,e,o,a,l,h,c,u,d]=i;r+=h,n+=c,s*=u/a}t.scissorBox=this.initScissor(r,n,s,a)}else t.scissorBox=null}draw(t,e){const i=t.data.tile,{preview:s}=t.data,r=i.tile,{layer:n,buffer:o}=t;let{x:a,y:l,scaledSize:h}=i;const{tileSize:c}=n,u=h/c;if(this.zIndex=t.z,this.min3dZIndex=e,this.bufferLightUniforms=o.light?this.processedLight[n.index][o.light]:null,this.stencilVal=null,s){const[e,i,n,h,d,f,p,g,m]=s,v=g/h,x=a+(f-i*v)*u,y=l+(p-n*v)*u,_=v*u;t.setTransform(x,y,_);const{clip:b}=o;let w=!1;v>1&&!o.needs2AlphaPasses()&&o.flat&&(w=o.clip=!0),this.initStencil(r.i,c,t.data.stencils),this.drawBuffer(t,0,0,null,u*v,w),o.clip=b}else{let e;t.setTransform(a,l,u),this.initStencil(r.i,c),u>1?(a=0,l=0):e=o.pixelPerfect?this.vPRasterMat:this.vPMat,this.drawBuffer(t,a,l,e,u)}}drawSky(t,e,i){if(!t)return;this.zIndex=0;const{skyBuffer:s}=this,r=s.getUniform("u_horizon");r[0]=2*t/e,r[1]=2*i,s.clearUniformCache(),this.drawBuffer(this.sky,0,0,this.skyMatrix),this.gl.depthMask(!0)}destroy(){}prepare(t,e,i,s,r,n){}drawCustom(t,e){var i;const s=this,{gl:r}=s;s.prog=null;const n=(65535-e)/65536,o="3d"==t.renderOptions.mode?0:n;r.depthRange(o,n),r.disable(r.SCISSOR_TEST),r.disable(r.STENCIL_TEST),t.render(r,s.worldMatrix),null===(i=this.glExt.getExtension("OES_vertex_array_object"))||void 0===i||i.bindVertexArrayOES(null),r.bindFramebuffer(r.FRAMEBUFFER,null),this.initContext()}getProgram(t){let e=t.progId;const i=t.type;if(!e){const s=this.programConfig[i].program;e=t.progId=s.getProgramId(t,s.getMacros(t))}let s=this.programs[e];if(void 0===s){const r=this.programConfig[i].program;r&&(s=this.createProgram(e,r,r.getMacros(t)))}return s}setResolution(t,e){const{resolution:i}=this;i[0]=t,i[1]=e}getDbgTile(t){var e;return(e=this.dbgTile)[t]||(e[t]=((t=1,e=[1,0,0,1],i=2)=>{const s=new ei,{flexAttributes:r}=s;Ae(r.a_position.data,r.a_normal.data,new Float32Array([0,0,t,0,t,t,0,t,0,0]),new Float32Array([0,t,2*t,3*t,4*t]),10,2,0,t,!1,"butt","none",i);const n=s.finalize("Line");return n.addUniform("u_zIndex",0),n.addUniform("u_fill",e),n.addUniform("u_strokeWidth",[i,0]),n.addUniform("u_offset",[0,0]),n.clip=!1,n.depth=!1,n.pass=Nt.ALPHA,n})(t))}}let yi;xi.DEFAULT_COLOR_MASK={r:!0,g:!0,b:!0,a:!0},xi.NO_COLOR_MASK={r:!1,g:!1,b:!1,a:!1};class _i{constructor(t){this.r=[],this.p=[],this.pool=t}init(t,e){this.luTs=null,this.quadkey=t,this.layers=e,this.tasks={},this.r.length=0,this.p.length=0}busy(t){const e=t.id;for(let t in this.tasks){const i=this.tasks[t];if(e==i._lid)return i}}addTask(t,e){t._lid=e.id,this.tasks[t.id]=t}cancelTasks(t){const e=this.tasks;let i;for(let s in e)i=e[s],t&&t.id!=i._lid||(i.cancel(),delete e[s])}removeTask(t,e){delete this.tasks[t.id]}index(t){return this.layers.indexOf(t)}getDisplayLayer(t){return this.layers[this.index(t)]}ready(t,e){return 2==arguments.length&&(this.r[t]=e,e&&(this.luTs=Date.now())),this.r[t]}addLayer(t){this.r.splice(t,0,!1),this.p.splice(t,0,undefined)}removeLayer(t){this.r.splice(t,1),this.p.splice(t,1)}preview(t,e){return 2==arguments.length&&(this.p[t]=e),this.p[t]}getOverlayingTiles(){const t=[],{quadkey:e}=this,i=e.length;return this.pool.forEach((s=>{const r=s.quadkey;(r.length<i&&0==e.indexOf(r)||r.length>i&&0==r.indexOf(e))&&t.push(s)})),t}}class bi extends _i{constructor(t,e,i,s){super(t),this.data=[],this.onDrop=s,this.init(e,i)}clear(t){this.setData(t,yi),this.ready(t,!1),this.preview(t,!1)}init(t,e){super.init(t,e),this.data.length=0}setData(t,e){const i="number"==typeof t?t:this.layers.indexOf(t),s=this.data[i];return s&&s.length&&this.onDrop&&this.onDrop(s,i),this.data[i]=e,i}getData(t){return this.data[t]}addLayer(t){super.addLayer(t),this.data.splice(t,0,yi)}removeLayer(t){super.removeLayer(t),this.setData(t,yi),this.preview(t,yi),this.data.splice(t,1)}}class wi{constructor(t){this.tiles=new o(t)}setSize(t){this.tiles.setSize(t)}get(t,e){if(e){const e=this.tiles._[t];return e&&e.data}return this.tiles.get(t)}forEach(t){return this.tiles.forEach(t)}}class Ai extends wi{constructor(t){super(t)}create(t,e){const{tiles:i,onDrop:s}=this;let r,n,o=i.get(t);if(!o&&(o=new bi(this,t,e,s),r=i.set(t,o),r&&(n=r.data))){for(let t=0;t<n.length;t++)r.setData(t,null),r.preview(t,null);r.data=null}return o}}class Si{constructor(){this.length=0,this.buffers=[]}push(t){this.buffers.push(t),this.length++}pop(){if(this.length)return this.length--,this.buffers.pop()}get(t){return this.buffers[t]}set(t,e){this.buffers[t]=e,this.length=this.buffers.length}setIdOffset(t){for(let e of this.buffers)e.setIdOffset(t)}isEmpty(){for(let t of this.buffers)if(t.isEmpty())return!0;return!1}toArray(){return this.buffers}}const Mi=(t,e,i,s,r,n)=>{let o=r.length;const a=t=t*s<<2|1,l=e=e*s<<2|3&n,h=2|t,c=l,u=a,d=2|e,f=h,p=d;return"number"==typeof i?(i=Math.round(i/9e3*65535),r.push(a,l,i,u,d,i,f,p,i,a,l,i,f,p,i,h,c,i),o+=18):(r.push(a,l,u,d,f,p,a,l,f,p,h,c),o+=12),o},Ti=t=>9e3*t/65535,Li=(t,e,i)=>e>0?t*e*i:t,zi=(t,e,i)=>{const s=t.getUniform("u_offset"),r=Li(s[0],s[1],e),n=Li(s[2],s[3],e),o=t.getUniform("u_offsetZ");return[r,n,Li(o[0],o[1],e)]};class Pi extends Re{constructor(t=!0,e){super(t,!1),this.flexAttributes={a_position:{data:new ke(Uint16Array),size:t?2:3}},e&&(this.normalizePosition=16384/e,this.addUniform("u_normalizePosition",1/this.normalizePosition)),this.first=0}addPoint(t,e,i,s){Mi(t,e,i,this.normalizePosition,this.flexAttributes.a_position.data)}rayIntersects(t,e,i,s,n){var o;const{type:a,attributes:l}=t,h=t.getUniform("u_alignMap"),c=t.getUniform("u_scaleByAltitude"),{scale:u,scaleZ:d,sMat:f}=n,p=h?1/n.scale:1;let g,m,[v,x,y]=zi(t,u);if(y=-y/d/u,"Rect"===a){const e=t.getUniform("u_size"),i=t.getUniform("u_strokeWidth")||0;g=.5*(e[0]+i),m=.5*(e[2]+i)}else"Circle"==a&&(g=m=t.getUniform("u_radius")[0]);g*=p,m*=p;const _=l.a_position,b=_.data,w=_.size,A=[0,0,0],S=[0,0,0];let M,T,L,z=null;h?(T=n.origin,L=n.direction,v/=u,x/=u):M=[0,0,0];const P=f[3],C=f[7],I=f[11],E=f[15],k=6*w;for(let t=0,u=0;t<b.length;t+=k,u+=6){let d=i+(b[t]>>2)/32,f=s+(b[t+1]>>2)/32,_=3==w?Ti(b[t+2]):0,k=(2&b[t])-1,R=(2&b[t+1])-1,F=t+2*w,D=(2&b[F])-1,O=(2&b[F+1])-1;if("Icon"===a){let t=null===(o=l.a_size)||void 0===o?void 0:o.data;g=.5*t[u]*p,m=.5*t[u+1]*p}if(h){A[0]=S[0]=d+v,A[1]=S[1]=f+x,A[2]=S[2]=_+y;const t=1+(c?0:A[2]*I/(P*A[0]+C*A[1]+E)),e=g*t,i=m*t;A[0]+=k*e,A[1]-=R*i,S[0]+=D*e,S[1]-=O*i}else A[0]=d,A[1]=f,A[2]=_+y,Ye(A,A,n.sMat),A[0]+=v,A[1]+=x,S[0]=A[0]+D*g,S[1]=A[1]-O*m,S[2]=A[2],A[0]+=k*g,A[1]-=R*m,T=n.sOrigin,L=n.sDirection;let U=n.intersectAABBox(A[0],A[1],A[2],S[0],S[1],S[2],T,L);U&&(h||(r.add(M,T,r.scale(M,L,U)),U=n.rayLengthScreenToWorld(M)),U<e.z&&(e.z=U,z=t))}if(null!=z)return t.idOffsets[Math.floor(z/k)]}}var Ci=e.toRGB;const Ii={type:"LinearGradient",stops:{1:"white",.9:"#FCFBAE",.8:"#FAD932",.7:"#F26C19",.5:"#C41D6F",.3:"#70009C",0:"#1E0073"}};class Ei extends Pi{constructor(t,e){super(!0,e),this.flexAttributes.a_weight={data:new ke(Float32Array),size:1}}static verifyAndFixGradient(t){let e=1/0;for(let i in t)i<e&&(e=i);const[i,s,r,n]=Ci(t[e]);if(n>0)return(t=Object.assign({},t))[e]=`rgba(${255*i},${255*s},${255*r},0)`,t}addPoint(t,e,i=1){const{flexAttributes:s}=this;Mi(t,e,void 0,this.normalizePosition,s.a_position.data),s.a_weight.data.push(i,i,i,i,i,i)}}const ki=a.getInstance(),Ri=Math.PI/180,Fi=new Float32Array([-1,-1,-1,-1]);let Di;const Oi=(t,e,i,s,r,n,o=0)=>{const a=t.z;for(let l of s){const s=st("type",l,e,a);if("Polygon"==s||"Line"==s){const{type:s,stroke:o,strokeWidth:h}=l;let c=st("stroke",l,e,a),u=st("strokeWidth",l,e,a);if(c&&u){l.type="Line",l.stroke=c,l.strokeWidth=u;for(let s of i)t.create(e,"LineString",s,[l],r,n.clipped,void 0,void 0,!l.fill||u>3);l.type=s,l.stroke=o,l.strokeWidth=u}}else if(0==o){const{bounds:i}=n,s=xt(l,e,a),[o,h]=s;o>=i[0]&&h>=i[1]&&o<i[2]&&h<i[3]&&t.create(e,"Point",s,[l],r)}}};!function(){var t,e=(t=new De(4),De!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t)}();const Ui=(t,e,i,s,r)=>{const n="number"==typeof r,o=n||!0===r,a=t.length,l=[];let h=0;for(let a=0;a<e.length;a++){for(let l,h,c=0;c<e[a].length;c++){const u=e[a][c];l=i.lon2x(u[0],s),h=i.lat2y(u[1],s),o?t.push(l,h,n?r:u[2]||0):t.push(l,h)}a>0&&(h+=e[a-1].length,l[l.length]=h)}return{dimensions:o?3:2,vertices:t,holes:l,start:a,stop:t.length}},Bi=(t,e,i,s,r)=>{let n;if("number"!=typeof e[0][0][0]){n=[];for(let o of e)n.push(Ui(t,o,i,s,r))}else n=[Ui(t,e,i,s,r)];return n},Wi=(t,e,i)=>{let s=0;for(let r=e,n=i-1;r<n;r+=3){let e=t[r],i=t[r+1];s+=(t[r+3]-e)*(i+t[r+4])}return s},Ni=(t,e,i,s,r,n,o,a)=>{const l=t.holes,h=t.vertices.data,c=t.stop-3;let u=t.start,d=0;o=o||0;let f=0===l.length?-1:u+3*l[d]-6,p=u,g=-1!==f?f+3:c,m=Wi(e.data,p,g)>=0;for(;u<c;){let v,x,y,_;if(m){const t=g-(u-p);v=h[t],y=h[t+1],x=h[t-3],_=h[t-2]}else v=h[u],y=h[u+1],x=h[u+3],_=h[u+4];const b=Math.round(v)-Math.round(x),w=Math.round(y)-Math.round(_);if((b||w)&&(U(v,y,0,0,r,r)||U(x,_,0,0,r,r))){const t=e.length/3;s.push(t+2,t,t+1,t+3,t+2,t+1),null==a||a.push(t,t+1,t+2,t+3,t,t+2,t+1,t+3),e.push(v,y,n,v,y,o,x,_,n,x,_,o);const r=127/Math.sqrt(b*b+w*w),l=-w*r,h=b*r;i.push(l,h,l,h,l,h,l,h)}u===f?(u+=6,p=u,d++,f=d<l.length?t.start+3*l[d]-6:-1,g=-1!==f?f+3:c,m=Wi(e.data,p,g)<0):u+=3}},Gi=(t,e,i,s,r,n,o,a,l)=>{let h=t.length;const c=Bi(t,s,r,n,o);for(;h<t.length;)e.push(0,0),h+=3;if(o>.01)for(let s of c)Ni(s,t,e,i,n,o,a,l);return c};function Zi(t,e,i=2){const s=e&&e.length,r=s?e[0]*i:t.length;let n=Hi(t,0,r,i,!0);const o=[];if(!n||n.next===n.prev)return o;let a,l,h;if(s&&(n=function(t,e,i,s){const r=[];for(let i=0,n=e.length;i<n;i++){const o=Hi(t,e[i]*s,i<n-1?e[i+1]*s:t.length,s,!1);o===o.next&&(o.steiner=!0),r.push(es(o))}r.sort(Ki);for(let t=0;t<r.length;t++)i=Qi(r[t],i);return i}(t,e,n,i)),t.length>80*i){a=t[0],l=t[1];let e=a,s=l;for(let n=i;n<r;n+=i){const i=t[n],r=t[n+1];i<a&&(a=i),r<l&&(l=r),i>e&&(e=i),r>s&&(s=r)}h=Math.max(e-a,s-l),h=0!==h?32767/h:0}return Vi(n,o,i,a,l,h,0),o}function Hi(t,e,i,s,r){let n;if(r===function(t,e,i,s){let r=0;for(let n=e,o=i-s;n<i;n+=s)r+=(t[o]-t[n])*(t[n+1]+t[o+1]),o=n;return r}(t,e,i,s)>0)for(let r=e;r<i;r+=s)n=ds(r/s|0,t[r],t[r+1],n);else for(let r=i-s;r>=e;r-=s)n=ds(r/s|0,t[r],t[r+1],n);return n&&os(n,n.next)&&(fs(n),n=n.next),n}function Yi(t,e){if(!t)return t;e||(e=t);let i,s=t;do{if(i=!1,s.steiner||!os(s,s.next)&&0!==ns(s.prev,s,s.next))s=s.next;else{if(fs(s),s=e=s.prev,s===s.next)break;i=!0}}while(i||s!==e);return e}function Vi(t,e,i,s,r,n,o){if(!t)return;!o&&n&&function(t,e,i,s){let r=t;do{0===r.z&&(r.z=ts(r.x,r.y,e,i,s)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==t);r.prevZ.nextZ=null,r.prevZ=null,function(t){let e,i=1;do{let s,r=t;t=null;let n=null;for(e=0;r;){e++;let o=r,a=0;for(let t=0;t<i&&(a++,o=o.nextZ,o);t++);let l=i;for(;a>0||l>0&&o;)0!==a&&(0===l||!o||r.z<=o.z)?(s=r,r=r.nextZ,a--):(s=o,o=o.nextZ,l--),n?n.nextZ=s:t=s,s.prevZ=n,n=s;r=o}n.nextZ=null,i*=2}while(e>1)}(r)}(t,s,r,n);let a=t;for(;t.prev!==t.next;){const l=t.prev,h=t.next;if(n?ji(t,s,r,n):Xi(t))e.push(l.i,t.i,h.i),fs(t),t=h.next,a=h.next;else if((t=h)===a){o?1===o?Vi(t=qi(Yi(t),e),e,i,s,r,n,2):2===o&&$i(t,e,i,s,r,n):Vi(Yi(t),e,i,s,r,n,1);break}}}function Xi(t){const e=t.prev,i=t,s=t.next;if(ns(e,i,s)>=0)return!1;const r=e.x,n=i.x,o=s.x,a=e.y,l=i.y,h=s.y,c=Math.min(r,n,o),u=Math.min(a,l,h),d=Math.max(r,n,o),f=Math.max(a,l,h);let p=s.next;for(;p!==e;){if(p.x>=c&&p.x<=d&&p.y>=u&&p.y<=f&&ss(r,a,n,l,o,h,p.x,p.y)&&ns(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function ji(t,e,i,s){const r=t.prev,n=t,o=t.next;if(ns(r,n,o)>=0)return!1;const a=r.x,l=n.x,h=o.x,c=r.y,u=n.y,d=o.y,f=Math.min(a,l,h),p=Math.min(c,u,d),g=Math.max(a,l,h),m=Math.max(c,u,d),v=ts(f,p,e,i,s),x=ts(g,m,e,i,s);let y=t.prevZ,_=t.nextZ;for(;y&&y.z>=v&&_&&_.z<=x;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&ss(a,c,l,u,h,d,y.x,y.y)&&ns(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,_.x>=f&&_.x<=g&&_.y>=p&&_.y<=m&&_!==r&&_!==o&&ss(a,c,l,u,h,d,_.x,_.y)&&ns(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(;y&&y.z>=v;){if(y.x>=f&&y.x<=g&&y.y>=p&&y.y<=m&&y!==r&&y!==o&&ss(a,c,l,u,h,d,y.x,y.y)&&ns(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;_&&_.z<=x;){if(_.x>=f&&_.x<=g&&_.y>=p&&_.y<=m&&_!==r&&_!==o&&ss(a,c,l,u,h,d,_.x,_.y)&&ns(_.prev,_,_.next)>=0)return!1;_=_.nextZ}return!0}function qi(t,e){let i=t;do{const s=i.prev,r=i.next.next;!os(s,r)&&as(s,i,i.next,r)&&cs(s,r)&&cs(r,s)&&(e.push(s.i,i.i,r.i),fs(i),fs(i.next),i=t=r),i=i.next}while(i!==t);return Yi(i)}function $i(t,e,i,s,r,n){let o=t;do{let t=o.next.next;for(;t!==o.prev;){if(o.i!==t.i&&rs(o,t)){let a=us(o,t);return o=Yi(o,o.next),a=Yi(a,a.next),Vi(o,e,i,s,r,n,0),void Vi(a,e,i,s,r,n,0)}t=t.next}o=o.next}while(o!==t)}function Ki(t,e){let i=t.x-e.x;if(0===i&&(i=t.y-e.y,0===i)){i=(t.next.y-t.y)/(t.next.x-t.x)-(e.next.y-e.y)/(e.next.x-e.x)}return i}function Qi(t,e){const i=function(t,e){let i=e;const s=t.x,r=t.y;let n,o=-1/0;if(os(t,i))return i;do{if(os(t,i.next))return i.next;if(r<=i.y&&r>=i.next.y&&i.next.y!==i.y){const t=i.x+(r-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(t<=s&&t>o&&(o=t,n=i.x<i.next.x?i:i.next,t===s))return n}i=i.next}while(i!==e);if(!n)return null;const a=n,l=n.x,h=n.y;let c=1/0;i=n;do{if(s>=i.x&&i.x>=l&&s!==i.x&&is(r<h?s:o,r,l,h,r<h?o:s,r,i.x,i.y)){const e=Math.abs(r-i.y)/(s-i.x);cs(i,t)&&(e<c||e===c&&(i.x>n.x||i.x===n.x&&Ji(n,i)))&&(n=i,c=e)}i=i.next}while(i!==a);return n}(t,e);if(!i)return e;const s=us(i,t);return Yi(s,s.next),Yi(i,i.next)}function Ji(t,e){return ns(t.prev,t,e.prev)<0&&ns(e.next,t,t.next)<0}function ts(t,e,i,s,r){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-i)*r|0)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-s)*r|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function es(t){let e=t,i=t;do{(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next}while(e!==t);return i}function is(t,e,i,s,r,n,o,a){return(r-o)*(e-a)>=(t-o)*(n-a)&&(t-o)*(s-a)>=(i-o)*(e-a)&&(i-o)*(n-a)>=(r-o)*(s-a)}function ss(t,e,i,s,r,n,o,a){return!(t===o&&e===a)&&is(t,e,i,s,r,n,o,a)}function rs(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){let i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&as(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&(cs(t,e)&&cs(e,t)&&function(t,e){let i=t,s=!1;const r=(t.x+e.x)/2,n=(t.y+e.y)/2;do{i.y>n!=i.next.y>n&&i.next.y!==i.y&&r<(i.next.x-i.x)*(n-i.y)/(i.next.y-i.y)+i.x&&(s=!s),i=i.next}while(i!==t);return s}(t,e)&&(ns(t.prev,t,e.prev)||ns(t,e.prev,e))||os(t,e)&&ns(t.prev,t,t.next)>0&&ns(e.prev,e,e.next)>0)}function ns(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function os(t,e){return t.x===e.x&&t.y===e.y}function as(t,e,i,s){const r=hs(ns(t,e,i)),n=hs(ns(t,e,s)),o=hs(ns(i,s,t)),a=hs(ns(i,s,e));return r!==n&&o!==a||(!(0!==r||!ls(t,i,e))||(!(0!==n||!ls(t,s,e))||(!(0!==o||!ls(i,t,s))||!(0!==a||!ls(i,e,s)))))}function ls(t,e,i){return e.x<=Math.max(t.x,i.x)&&e.x>=Math.min(t.x,i.x)&&e.y<=Math.max(t.y,i.y)&&e.y>=Math.min(t.y,i.y)}function hs(t){return t>0?1:t<0?-1:0}function cs(t,e){return ns(t.prev,t,t.next)<0?ns(t,e,t.next)>=0&&ns(t,t.prev,e)>=0:ns(t,e,t.prev)<0||ns(t,t.next,e)<0}function us(t,e){const i=ps(t.i,t.x,t.y),s=ps(e.i,e.x,e.y),r=t.next,n=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,s.next=i,i.prev=s,n.next=s,s.prev=n,s}function ds(t,e,i,s){const r=ps(t,e,i);return s?(r.next=s.next,r.prev=s,s.next.prev=r,s.next=r):(r.prev=r,r.next=r),r}function fs(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function ps(t,e,i){return{i:t,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class gs extends ne{destroy(t){t&&super.destroy()}}class ms{constructor(t,e,i,s,r,n){this.i=t,this.u1=e,this.v1=s,this.u2=i,this.v2=r,this.atlasWidth=n.width,this.atlasHeight=n.height}normalized(){return{u1:this.u1/this.atlasWidth,v1:this.v1/this.atlasHeight,u2:this.u2/this.atlasWidth,v2:this.v2/this.atlasHeight}}}class vs{constructor(t){const e=t.gl,i=t.maxImgSize||256,s=Math.pow(1024/i,2),r=Math.sqrt(s);this.c=new o(s),this.max=s,this.maxSize=i,this.gl=e,this.d=r}get(t){return this.c.get(t)}init(){let{texture:t,gl:e,maxSize:i,d:s}=this;if(!this.texture){const t=s*i;this.texture=new gs(this.gl,{width:t,height:t})}}set(t,e){const i=this.c,{d:s,maxSize:r}=this;let n,o=i.get(t),a=!1;o?n=o.i:(n=i.length,n>=i.max&&(o=i.tail.data,n=o.i),a=!0);const l=n%s^0,h=n/s^0,c=l*r,u=h*r,d=c+e.width,f=u+e.height;return(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement)&&(this.init(),this.texture.set(e,l*r,h*r)),o?(o.u1=c,o.u2=d,o.v1=u,o.v2=f):o=new ms(n,c,d,u,f,this.texture),a&&i.set(t,o),o}destroy(){const{texture:t}=this;t&&t.destroy(!0)}}class xs{constructor(t){this.data={},this.scale=10,this.gl=t}create(t){let e=t.reduce(((t,e)=>t+e));const i=512/e;e*=i;const s=new Uint8Array(e),{gl:r}=this;let n=!0,o=0;for(;o<e;)for(let e of t)e*=i,n&&s.fill(255,o,o+e),o+=e,n=!n;return{scale:i,texture:new gs(r,{width:s.length,height:1,data:s},{format:r.LUMINANCE})}}get(t){const e=String(t);let i=this.data[e];return i||(i=this.data[e]=this.create(t)),i}}class ys{constructor(t=256){this.length=0,this.points=[],this.sqDistance=this.setMinDistance(t)}setMinDistance(t){return this.sqDistance=t*t}add(t,e){const{points:i}=this;i[this.length++]=t,i[this.length++]=e}clear(){this.length=0,this.points.length=0}hasSpace(t,e){const{length:i,points:s,sqDistance:r}=this;let n=0;if(r)for(;n<i;){const i=t-s[n++],o=e-s[n++];if(i*i+o*o<r)return!1}return!0}}const _s=180/Math.PI;var bs;!function(t){t[t.MID_TO_END=1]="MID_TO_END",t[t.MID_TO_START=-1]="MID_TO_START"}(bs||(bs={}));class ws{constructor(t){this.length=0,this.dashes=new xs(t),this.gl=t,this.pixels=new Float32Array(262144),this.alpha=new Float32Array(131072),this.lineLength=new Float32Array(131072),this.repeat={}}getDistanceGrp(){return this.repeat[this.dId]}projectLine(t,e,i){const{pixels:s,decimals:r}=this;if(!this.length){let n=0;const o="number"==typeof t[0][2]?3:2,a=3===o;for(let l,h,c,u,d,f,p=0,g=t.length;p<g;p++){let g=t[p];if(l=e.lon2x(g[0],i),h=e.lat2y(g[1],i),c=g[2]||0,(!p||Math.round(u*r)-Math.round(l*r)||Math.round(d*r)-Math.round(h*r)||a&&c!=f)&&(s[n++]=l,s[n++]=h,a&&(s[n++]=c),n>o)){const t=u-l,e=d-h;this.lineLength[p]=this.lineLength[p-1]+Math.sqrt(t*t+e*e)}u=l,d=h,f=c}this.length=n,this.dimensions=o}return this.length}placeCached(t,e,i,s){const{collisions:r}=this;for(let n,o=0;o<r.length;o++){n=r[o];let{cx:a,cy:l,cz:h}=n;const c=i<<e.z,u=1<<e.z;a=(a-e.x/u)*c,l=(l-e.y/u)*c,t(a,l,h,s?this.alpha[o]:0,0,n)}}initTile(){const{repeat:t}=this;for(let e in t)t[e].clear()}initFeature(t,e,i){this.decimals=t>=20-Number(512==e)?100:1,this.length=0,this.collisions=null;const{repeat:s}=this;this.dId=i,i&&!s[i]&&(s[i]=new ys)}createLine(t,e,i,s,r,n,o,a,l,h,c,u,d){e.buffer||(e.buffer=new ei(!h));const f=e.buffer;if(n)if(!fr(n.pattern)&&n.pattern.length>2&&!n.units.some((t=>t!=n.units[0]))){const t=this.dashes.get(n.pattern);f.addUniform("u_dashPattern",t.texture),f.addUniform("u_dashSize",[t.texture.width/t.scale,0])}else f.addUniform("u_dashSize",n.pattern);this.projectLine(t,i,s);const{pixels:p,length:g,dimensions:m}=this,v=g-m,x=p[0]==p[v]&&p[1]==p[v+1];return Ae(f.flexAttributes.a_position.data,f.flexAttributes.a_normal.data,p,this.lineLength,g,m,h,s,r,o,a,l,n&&f.flexAttributes.a_lengthSoFar.data,x,c,u,d)}placeAtSegments(t,e,i,s,r,n,o,a,l,h,c,u,d,f,p,g){var m;if(this.projectLine(t,i,s),null===(m=this.getDistanceGrp())||void 0===m||m.setMinDistance(null==o?256:o),p<f){const t=p;p=f,f=t}this.placeAlongLine(i,s,r,n,a,l,h,c,u,d,e,f,p,g)}getAbsOffset(t){if("string"==typeof t&&t.endsWith("px"))return parseFloat(t);const{length:e,dimensions:i,lineLength:s}=this;return t*s[e/i-1]}placeAtPoints(t,e,i,s,r,n,o,a,l,h,c=0,u=1,d){this.projectLine(t,i,s);let{length:f,dimensions:p,lineLength:g}=this;const m=g[f/p-1];let v=c*m,x=u*m;if(this.collisions)return this.placeCached(d,i,s);const y=r&&[];let _=!0===e;const b="number"==typeof e?e:null;_&&2==p&&(_=null);let w,A=0;for(let t=0,e=this.pixels;t<f;t+=p){let c,u=e[t],m=e[t+1],S=_?e[t+2]:b,M=t/p;if(w=A,A=g[M+1],v){if(!(v<A))continue;{const i=(v-w)/(A-w),s=t+p,r=e[s],n=e[s+1],o=_?e[s+2]:b;u+=(r-u)*i,m+=(n-m)*i,null!=S&&(S+=(o-S)*i),v==x&&(f=null,x=null),v=null}}if(x&&x&&w>x){const i=(x-w)/(w-g[M-1]),s=t-p,r=e[s],n=e[s+1],o=_?e[s+2]:b;u-=(r-u)*i,m-=(n-m)*i,null!=S&&(S-=(o-S)*i),f=null}if(u>=0&&m>=0&&u<s&&m<s){let t;y&&(t=this.getDistanceGrp(),t&&!t.hasSpace(u,m)||(c=r.insert(u,m,S,l,h,o,a,i,s,n),c&&y.push(c))),y&&!c||(d(u,m,S,0,0,c),null==t||t.add(u,m))}}(null==y?void 0:y.length)&&(this.collisions=y)}placeAlongLine(t,e,i,s,r,n,o,a,l,h,c,u,d,f){if(this.collisions)return this.placeCached(f,t,e,l);let{length:p,dimensions:g,lineLength:m}=this;const v=m[p/g-1];let x=u*v,y=d*v;const _=this.dimensions,b=i&&[],w=this.length/_;let A=this.pixels,S=0,M=Math.pow(2*r+o,2),T=Math.floor(w/2)-1,L=bs.MID_TO_END,z=!1,P=!0===c;const C="number"==typeof c?c:null;let I="number"==typeof c?c:null;P&&2==g&&(P=null);for(let c=1;c<w;c++){if(T+c===w){if(z)break;L=bs.MID_TO_START,T=w}let u=(T+L*c)%w;const d=u-1,p=m[d],g=m[u],v=d*_;let E=A[v],k=A[v+1],R=P?A[v+2]:C;const F=u*_;let D=A[F],O=A[F+1],U=P?A[F+2]:C;if(x){if(!(x<g))continue;if(x>=p){const t=(x-p)/(g-p);E+=(D-E)*t,k+=(O-k)*t,R+=(U-R)*t,L==bs.MID_TO_END?z=!0:c=1/0}}if(y){if(!(y>p)){L==bs.MID_TO_END&&(c=w-T-1);continue}if(y<=g){const t=1-(y-p)/(g-p);D-=(D-E)*t,O-=(O-k)*t,U-=(U-R)*t,L==bs.MID_TO_END&&(c=w-T-1)}}const B=D-E,W=O-k,N=E+.5*B,G=k+.5*W;if(N>=0&&G>=0&&N<e&&G<e){let c=h?B*B+W*W:1/0;if(c>M){if(P){const t=U-R;I=R+.5*t,S=Math.asin(t/Math.sqrt(B*B+W*W+t*t))}let h,u,d=Math.atan2(W,B);if(b&&(u=this.getDistanceGrp(),!u||u.hasSpace(N,G))){let u=r,f=n;if(l&&d&&(u||f)){const t=Math.sin(d),e=Math.cos(d);u=e*r-t*n,f=t*r+e*n}const p=Math.sqrt(M/c),g=[B*p,W*p];h=i.insert(N,G,I,u,f,o/2,a/2,t,e,s,g),h&&(this.alpha[b.length]=d*_s,b.push(h))}b&&!h||(f(N,G,I,l?d*_s:0,S,h),null==u||u.add(N,G))}}}(null==b?void 0:b.length)&&(this.collisions=b)}}const As={Center:{x:.5,y:0},Left:{x:0,y:0},Right:{x:1,y:0},Top:{x:.5,y:-1},TopLeft:{x:0,y:-1},TopRight:{x:1,y:-1},Bottom:{x:.5,y:1},BottomLeft:{x:0,y:1},BottomRight:{x:1,y:1}};class Ss extends Re{constructor(t=!0,e,i){super(t),this.normalizePosition=32768/e,this.addUniform("u_normalizePosition",1/this.normalizePosition),this.flexAttributes={a_position:{data:new ke(Uint16Array),size:t?2:3},a_point:{data:new ke(Int16Array),size:i?3:2},a_texcoord:{data:new ke(Uint16Array),size:2}},this.first=0}addText(t,e,i,s,r,n,o,a){const{flexAttributes:l}=this;((t,e,i,s,r,n,o,a,l,h=0,c,u="Center",d)=>{const f=r.length-1,p=l.lineHeight,g=As[u]||As.Center;let m=l.baselineOffset+.5*p*(f+r.length*g.y);m*=Me;const v=void 0===d?1:Number(!d);t=t*s<<1|v,e=e*s<<1|v,h=Math.round(1024*h/360);const x=null!==i;let y=2,_=null==c?2:3;x&&(i=Math.round(i/9e3*65535),y=3);let b=o.length/y;for(let s of r){const r=Pe(s,l,n,a,h,c),u=r.count*y,d=r.width*g.x*Me;o.reserve(u);for(let s=n.data,r=o.data,a=b+u/y;b<a;b++)s[b*_]-=d,s[b*_+1]-=m,r[b*y]=t,r[b*y+1]=e,x&&(r[b*y+2]=i);o.length+=u,m-=p*Me}})(t,e,i,this.normalizePosition,s,l.a_point.data,l.a_position.data,l.a_texcoord.data,r,n,o,a)}}class Ms extends Pi{constructor(t=!0,e){super(t,e),this.flexAttributes={a_position:{data:new ke(Uint16Array),size:t?2:3},a_size:{data:new ke(Uint8Array),size:2},a_texcoord:{data:new ke(Uint16Array),size:2}},this.first=0}addIcon(t,e,i,s,r,n,o,a){const{normalizePosition:l,flexAttributes:h}=this;((t,e,i,s,r,n,o,a,l,h,c=0)=>{let{u1:u,u2:d,v1:f,v2:p}=r;c=Math.round(511*c/360),Mi(t,e,i,s,l,c>>8&1);const g=c>>4&15,m=15&c,v=4095/(r.atlasWidth-1),x=4095/(r.atlasHeight-1);u*=v,d*=v,f*=x,p*=x,d>4095&&(d=4095),p>4095&&(p=4095),u=u<<4|m,d=d<<4|m,f=f<<4|g,p=p<<4|g,a.push(n,o,n,o,n,o,n,o,n,o,n,o),h.push(u,p,u,f,d,f,u,p,d,f,d,p)})(t,e,i,l,s,r,n,h.a_size.data,h.a_position.data,h.a_texcoord.data,o)}}class Ts extends Re{constructor(t=!0,e=!0){super(t,e),this.flexAttributes={a_position:{data:new ke(Float32Array),size:t?2:3}},this.first=0}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_position.data.length,t)}rayIntersects(t,e,i,s,r){var n;const{attributes:o}=t,a=o.a_position.data,l=o.a_position.size,h=r.origin,c=r.direction,u=[0,0,0],d=[0,0,0],f=[0,0,0];let p=null;for(let r of t.groups){const o=null===(n=r.index)||void 0===n?void 0:n.data;let g=null;if(r.mode!=he.MODE_GL_LINES){for(let t=0;t<o.length;t+=3){const r=o[t]*l,n=o[t+1]*l,p=o[t+2]*l;u[0]=i+a[r],u[1]=s+a[r+1],d[0]=i+a[n],d[1]=s+a[n+1],f[0]=i+a[p],f[1]=s+a[p+1],3==l&&(u[2]=a[r+2],d[2]=a[n+2],f[2]=a[p+2]);const m=ti.rayIntersectsTriangle(h,c,u,d,f);m&&m<e.z&&(g=r,e.z=m)}if(null!=g)for(let e=0,{idOffsets:i}=t,{length:s}=i;e<s;e+=2)if(g<i[e]){p=i[e+1];break}}}return p}}class Ls extends Ts{constructor(){super(!1,!1),this.flexAttributes.a_normal={data:new ke(Int8Array),size:2,normalized:!0},this.light="defaultLight"}}const zs=new Map;let Ps;[[Ps,Ps,Ps],[Ps,Ps,65154],[Ps,Ps,65156],[Ps,Ps,65158],[Ps,Ps,65160],[65163,65164,65162],[Ps,Ps,65166],[65169,65170,65168],[Ps,Ps,65172],[65175,65176,65174],[65179,65180,65178],[65183,65184,65182],[65187,65188,65186],[65191,65192,65190],[Ps,Ps,65194],[Ps,Ps,65196],[Ps,Ps,65198],[Ps,Ps,65200],[65203,65204,65202],[65207,65208,65206],[65211,65212,65210],[65215,65216,65214],[65219,65220,65218],[65223,65224,65222],[65227,65228,65226],[65231,65232,65230],Ps,Ps,Ps,Ps,Ps,[1600,1600,1600],[65235,65236,65234],[65239,65240,65238],[65243,65244,65242],[65247,65248,65246],[65251,65252,65250],[65255,65256,65254],[65259,65260,65258],[Ps,Ps,65262],[Ps,Ps,65264],[65267,65268,65266]].forEach(((t,e)=>{zs.set(1569+e,t&&{initial:t[0],medial:t[1],final:t[2]})})),zs.set(1662,{initial:64344,medial:64345,final:64343}),zs.set(1740,{initial:64510,medial:64511,final:64509}),zs.set(1670,{initial:64380,medial:64381,final:64379}),zs.set(1705,{initial:64400,medial:64401,final:64399}),zs.set(1711,{initial:64404,medial:64405,final:64403}),zs.set(1688,{final:64395});const Cs=new Set([1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773]),Is={1570:{isolated:65269,final:65270},1571:{isolated:65271,final:65272},1573:{isolated:65273,final:65274},1575:{isolated:65275,final:65276}},Es=(t,e,i)=>{const s=i>0?t.length-e:e+1;for(let r,n=1;n<s;n++)if(r=t.charCodeAt(e+i*n),!Cs.has(r))return{cp:r,map:zs.get(r)}},ks=t=>{var e;if(!(t=>/[\u0600-\u06FF]/.test(t))(t))return t;let i="";for(let s=0;s<t.length;++s){let r=t.charCodeAt(s);if(zs.has(r)){let i=null===(e=Es(t,s,-1))||void 0===e?void 0:e.map;!i||i.initial||i.medial||(i=Ps);let n,o=Es(t,s,1),a=null==o?void 0:o.map;if(!a||a.medial||a.final||(a=Ps),n=1604==r&&Is[null==o?void 0:o.cp])r=i?n.final:n.isolated,s++;else{const t=zs.get(r);i&&a&&t.medial?r=t.medial:i&&t.final?r=t.final:a&&t.initial&&(r=t.initial)}}i+=String.fromCharCode(r)}return i};class Rs extends Ts{constructor(t=!1,e=!0){super(t,e)}rayIntersects(t,e,i,s,r){return null}}const Fs=(t,e,i,s)=>{if(s){t.buffer||(t.buffer=new Rs);const r=t.buffer.flexAttributes.a_position.data;return r.push(e,i,0,e,i,s),r.length}},Ds=32,Os=.03125;class Us extends Pi{constructor(t=!0){super(t),this._flat=!1,this.flexAttributes.a_point={data:new ke(Uint16Array),size:3},this.flexAttributes.a_normal={data:new ke(Int8Array),normalized:!0,size:3},this.light="defaultLight"}rayIntersects(t,e,i,s,r){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=n.a_point.data,[h,c,u]=r.getInverseScale(!0),d=t.getUniform("u_scaleByAltitude");let f=null;const p=6*a*6;let[g,m,v]=zi(t,r.scale);const{sMat:x}=r,y=x[3],_=x[7],b=x[11],w=x[15];g*=h,m*=c,v*=u;for(let t=0,{length:n}=o;t<n;t+=p){const n=i+o[t]*Os+g,p=s+o[t+1]*Os+m,x=(3==a?Ti(o[t+2]):0)+v,A=1+(d?0:x*b/(y*n+_*p+w)),S=(l[t]>>1)*h*A,M=(l[t+1]>>1)*c*A,T=(l[t+2]>>1)*u*A,L=r.intersectAABBox(n-S,p-M,x-T,n+S,p+M,x+T);null!=L&&L<e.z&&(e.z=L,f=t)}if(null!=f)return t.idOffsets[Math.floor(f/p)]}}const Bs=(t,e,i)=>{const s=e[0]-t[0],r=e[1]-t[1],n=e[2]-t[2],o=i[0]-t[0],a=i[1]-t[1],l=i[2]-t[2];return[Math.floor(127*(r*l-n*a)),Math.floor(127*(n*o-s*l)),Math.floor(127*(s*a-r*o))]};let Ws;const Ns=(t,e,i,s,r,n,o)=>{Ws=Ws||((t=8,e=6,i=0,s=2*Math.PI,r=0,n=Math.PI,o=1)=>{const a=Math.min(r+n,Math.PI),l=[],h=[],c=[];let u=0;for(let a=0;a<=e;a++){const h=[],d=a/e;for(let e=0;e<=t;e++){const a=e/t,l=Math.sin(r+d*n);c.push(-Math.cos(i+a*s)*l*o,Math.cos(r+d*n)*o,-Math.sin(i+a*s)*l*o),h.push(u++)}l.push(h)}const d=[];for(let i=0;i<e;i++)for(let s=0;s<t;s++){const t=l[i][s+1],n=l[i][s],o=l[i+1][s],u=l[i+1][s+1];if(0!==i||r>0){h.push(t,n,u);const e=c.slice(3*t,3*t+3),i=c.slice(3*n,3*n+3),s=c.slice(3*u,3*u+3),r=Bs(e,i,s);d.push.apply(d,r),d.push.apply(d,r),d.push.apply(d,r)}if(i!==e-1||a<Math.PI){h.push(n,o,u);const t=c.slice(3*n,3*n+3),e=c.slice(3*o,3*o+3),i=c.slice(3*u,3*u+3),s=Bs(t,e,i);d.push.apply(d,s),d.push.apply(d,s),d.push.apply(d,s)}}let f=[];for(let t of h)f.push(127+Math.floor(127*c[3*t]),127+Math.floor(127*c[3*t+1]),127+Math.floor(127*c[3*t+2]));return{normals:f,surfaceNormals:d}})(16,12),t*=Ds,e*=Ds;const a="number"==typeof i;i=Math.round(i/9e3*65535);const{normals:l,surfaceNormals:h}=Ws;for(let s=0,c=l.length;s<c;s+=3)a?r.push(t,e,i):r.push(t,e),n.push(l[s],l[s+1],l[s+2]),null==o||o.push(h[s],h[s+1],h[s+2])},Gs=.03125;class Zs extends Us{constructor(t){super(t),this.cullFace=1029,this.flexAttributes.a_point={normalized:!0,data:new ke(Uint8Array),size:3}}rayIntersects(t,e,i,s,r){const{attributes:n}=t,o=n.a_position.data,a=n.a_position.size,l=t.getUniform("u_scaleByAltitude"),[h,c,u]=r.getInverseScale(!0),[d]=t.uniforms.u_radius,f=d*h,p=d*c,g=d*u,{sMat:m}=r,v=m[3],x=m[7],y=m[11],_=m[15],b=1056*a,w=[0,0,0],A=[0,0,0];let S=null,[M,T,L]=zi(t,r.scale);M*=h,T*=c,L*=u;for(let t=0,{length:n}=o;t<n;t+=b){const n=i+o[t]*Gs+M,h=s+o[t+1]*Gs+T,c=(3==a?Ti(o[t+2]):0)+L,u=1+(l?0:c*y/(v*n+x*h+_));w[0]=n,w[1]=h,w[2]=c,A[0]=f*u,A[1]=p*u,A[2]=g*u;const d=r.intersectEllipsoid(w,A);null!=d&&d<e.z&&(e.z=d,S=t)}if(null!=S)return t.idOffsets[Math.floor(S/b)]}}function Hs(){var t=new De(9);return De!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function Ys(){var t=new De(4);return De!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}Oe(),Ue(1,0,0),Ue(0,1,0),Ys(),Ys(),Hs();var Vs,Xs=e.toRGB;!function(t){t[t.bbox=0]="bbox",t[t.geometry=1]="geometry"}(Vs||(Vs={}));const js=[1,1,1,1],qs=180/Math.PI;class $s extends Re{constructor(t,e,i,s){super(!1),this.defaultOrientationMatrix=new Float32Array([1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1]),this.hitTest=Vs.bbox,this.flexAttributes={};const{flexAttributes:r}=this;$s.init(t,r),(null==t?void 0:t.index)&&(this._index=t.index),r.a_modelMatrix=i||{data:new ke(Float32Array),size:16,instanced:!0},r.a_offset=s||{data:new ke(Float32Array),size:3,instanced:!0},this.uniforms=Object.assign({},e),this.light="defaultLight"}static calcBBox(t){const{position:e}=t;let i=1/0,s=-i,r=i,n=s,o=i,a=s;for(let t=0,{length:l}=e;t<l;t+=3){const l=e[t],h=e[t+1],c=e[t+2];l<i?i=l:l>s&&(s=l),h<r?r=h:h>n&&(n=h),c<o?o=c:c>a&&(a=c)}return[i,r,o,s,n,a]}static init(t,e={}){if(t){const{position:i,color:s,uv:r}=t;let n,o=js;e.a_position={data:$s.createFlexArray(i),size:3};const a=t.normal||(t.normal=he.computeNormals(i,t.index));if(a&&(e.a_normal={data:$s.createFlexArray(a),size:3,normalized:a instanceof Int8Array||a instanceof Int16Array}),r&&(e.a_uv={data:$s.createFlexArray(r),size:2}),r&&a){const s=function(t,e,i){const s=new Float32Array(t.length),r=new Float32Array(3),n=new Float32Array(3),o=new Float32Array(3),a=new Float32Array(3),l=new Float32Array(3),h=new Float32Array(3),c=(null==i?void 0:i.length)||t.length/3;for(let u=0;u<c;u+=3){let c=u,d=u+1,f=u+2;i&&(c=i[c],d=i[d],f=i[f]);const p=3*c,g=3*d,m=3*f,v=2*c,x=2*d,y=2*f;r[0]=t[p],r[1]=t[p+1],r[2]=t[p+2],n[0]=t[g],n[1]=t[g+1],n[2]=t[g+2],o[0]=t[m],o[1]=t[m+1],o[2]=t[m+2],a[0]=e[v],a[1]=e[v+1],a[2]=e[v+2],l[0]=e[x],l[1]=e[x+1],l[2]=e[x+2],h[0]=e[y],h[1]=e[y+1],h[2]=e[y+2];const _=We(n,n,r),b=We(o,o,r),w=We(l,l,a),A=We(h,h,a),S=1/(w[0]*A[1]-A[0]*w[1]),M=r;Number.isFinite(S)?Ge(M,Ne(M,We(M,Ne(_,_,A[1]),Ne(b,b,w[1])),S)):(M[0]=1,M[1]=0,M[2]=0),s[p]=s[g]=s[m]=M[0],s[p+1]=s[g+1]=s[m+1]=M[1],s[p+2]=s[g+2]=s[m+2]=M[2]}return s}(i,r,t.index);e.a_tangent={data:$s.createFlexArray(s),size:3}}else e.a_tangent={value:[1,0,0]};if(s)if(oe(s)||Array.isArray(s)){const t=i.length/3;if(s.length==4*t)o=s,n=4;else if(s.length==3*t){n=4,o=new Uint8Array(4*t);const e=s;for(let t=0;t<e.length;t+=3){let i=t/3*4;o[i]=255*e[t],o[i+1]=255*e[t+1],o[i+2]=255*e[t+2],o[i+3]=255}}}else o=Xs(s);e.a_color=n?{data:new ke(o),size:n,normalized:!0}:{value:o}}return e}static createFlexArray(t){return new ke(oe(t)?t:new Float32Array(t))}addInstance(t,e,i,s=[1,1,1],r=[0,0,0],n=[0,0,0],o){this.instances++,this.flexAttributes.a_offset.data.push(t,e,i);let a=function(t,e,i,s){var r=.5*Math.PI/180;e*=r,i*=r,s*=r;var n=Math.sin(e),o=Math.cos(e),a=Math.sin(i),l=Math.cos(i),h=Math.sin(s),c=Math.cos(s);return t[0]=n*l*c-o*a*h,t[1]=o*a*c+n*l*h,t[2]=o*l*h-n*a*c,t[3]=o*l*c+n*a*h,t}(Ys(),n[0]*qs,n[1]*qs,n[2]*qs),l=function(t,e,i,s){var r=e[0],n=e[1],o=e[2],a=e[3],l=r+r,h=n+n,c=o+o,u=r*l,d=r*h,f=r*c,p=n*h,g=n*c,m=o*c,v=a*l,x=a*h,y=a*c,_=s[0],b=s[1],w=s[2];return t[0]=(1-(p+m))*_,t[1]=(d+y)*_,t[2]=(f-x)*_,t[3]=0,t[4]=(d-y)*b,t[5]=(1-(u+m))*b,t[6]=(g+v)*b,t[7]=0,t[8]=(f+x)*w,t[9]=(g-v)*w,t[10]=(1-(u+p))*w,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}(Ve(),a,r,s);const h=this.defaultOrientationMatrix.slice();var c,u,d,f,p,g,m,v,x,y,_,b,w,A,S,M,T,L,z,P,C,I,E,k,R,F,D,O,U,B,W;l=qe(h,h,l),this.uniforms.u_normalMatrix=(c=Hs(),d=(u=l)[0],f=u[1],p=u[2],g=u[3],m=u[4],v=u[5],x=u[6],y=u[7],_=u[8],b=u[9],w=u[10],A=u[11],S=u[12],M=u[13],T=u[14],L=u[15],(W=(z=d*v-f*m)*(B=w*L-A*T)-(P=d*x-p*m)*(U=b*L-A*M)+(C=d*y-g*m)*(O=b*T-w*M)+(I=f*x-p*v)*(D=_*L-A*S)-(E=f*y-g*v)*(F=_*T-w*S)+(k=p*y-g*x)*(R=_*M-b*S))?(W=1/W,c[0]=(v*B-x*U+y*O)*W,c[1]=(x*D-m*B-y*F)*W,c[2]=(m*U-v*D+y*R)*W,c[3]=(p*U-f*B-g*O)*W,c[4]=(d*B-p*D+g*F)*W,c[5]=(f*D-d*U-g*R)*W,c[6]=(M*k-T*E+L*I)*W,c[7]=(T*C-S*k-L*P)*W,c[8]=(S*E-M*C+L*z)*W,c):null);const N=this.flexAttributes.a_modelMatrix.data;N.set(l,N.length)}setIdOffset(t){var e;null===(e=this.idOffsets)||void 0===e||e.push(this.flexAttributes.a_modelMatrix.data.length,t)}rayIntersects(t,e,i,s,r){var n;const{attributes:o}=t,a=o.a_position,l=o.a_modelMatrix.data,h=o.a_offset.data,c=a.data,u=a.size,d=r.origin,f=r.direction,p=[0,0,0],g=[0,0,0],m=[0,0,0];let v=null;for(let r=0,o=0,{length:a}=l;r<a;r+=16,o+=3){const a=l.subarray(r,r+16),x=a[r],y=a[r+5],_=a[r+10],b=a[r+12]+h[o],w=a[r+13]+h[o+1],A=a[r+14]+h[o+2];for(let o of t.groups){const t=null===(n=o.index)||void 0===n?void 0:n.data;if(o.mode!=he.MODE_GL_LINES)for(let n=0;n<t.length;n+=3){const o=t[n]*u,a=t[n+1]*u,l=t[n+2]*u;p[0]=i+c[o]*x+b,p[1]=s+c[o+1]*y+w,g[0]=i+c[a]*x+b,g[1]=s+c[a+1]*y+w,m[0]=i+c[l]*x+b,m[1]=s+c[l+1]*y+w,3==u&&(p[2]=c[o+2]*_+A,g[2]=c[a+2]*_+A,m[2]=c[l+2]*_+A);const h=ti.rayIntersectsTriangle(d,f,p,g,m);h&&h<e.z&&(v=r,e.z=h)}}}if(null!=v)for(let e=0,{idOffsets:i}=t,{length:s}=i;e<s;e+=2)if(v<i[e])return i[e+1]}generateWireframeIndices(){const t=this.index(),e=new Set,i=[];for(let s=0;s<t.length;s+=3){const r=t[s],n=t[s+1],o=t[s+2],a=[[r,n],[n,o],[o,r]];for(const[t,s]of a){const r=t<s?`${t};${s}`:`${s};${t}`;e.has(r)||(e.add(r),i.push(t,s))}}return new(t instanceof Uint32Array?Uint32Array:Uint16Array)(i)}}class Ks{constructor(t){this.cnt=0,this.callbacks={};const e=t.toString(),i=e.indexOf("{")+1,s=e.lastIndexOf("}"),r=e.substring(i,s).trim();let n="",o=null,a=0;r.split("").some(((t,e)=>{if("{"==t&&a++,"}"==t&&a--,!a&&"return"===r.slice(e,e+6))return o=r.slice(e+6).trim().replace(/;?\s*$/,""),!0;n+=t})),this.workerStr=n.trim()+`;self.__main=${o}`}async main(t){this.init();const e=this.cnt++;return this.worker.postMessage({args:t,id:e,method:"__main"}),new Promise(((t,i)=>{this.callbacks[e]=[t,i]}))}init(){if(!this.worker){const t=URL.createObjectURL(new Blob([this.workerStr,"\nself.onmessage = async ({data}) => {try{\n    const {message,transfer} = await self[data.method](data.args);\n        self.postMessage({result: message, id: data.id}, transfer);\n    }catch(error){self.postMessage({error, id: data.id})}\n};"],{type:"text/javascript"}));this.worker=new Worker(t),URL.revokeObjectURL(t),delete this.workerStr,this.worker.onmessage=({data:t})=>{const{result:e,error:i,id:s}=t;let[r,n]=this.callbacks[s];delete this.callbacks[s],i?n(i):r(e)}}return this.worker}destroy(){var t;null===(t=this.worker)||void 0===t||t.terminate(),this.worker=null,this.callbacks=null}}const Qs=function(){const t="default",e=t=>{const[,e,i]=/^(\w+)\s+(.*?)\s*(?:#.*)?$/.exec(t);return[e,i]},i={Ka:"ambient",Kd:"diffuse",Ks:"specular",Ke:"emissive",Ns:"shininess",map_Kd:"diffuseMap",map_Ns:"specularMap",map_Bump:"normalMap",d:"opacity",illum:"illumination"},s=async s=>(async()=>{let r;const n=await fetch(s),o=await n.text(),{geometries:a,mtlLibs:l,faces:h}=(i=>{const s=[[],[],[],[]],[r,n,o,a]=s,l=[],h=[],c=[];let u,d=[t],f={material:t,geometryIndex:0},p=t,g=[[],[],[],[]];const m=()=>{(null==u?void 0:u.position.length)&&(u=void 0)},v=(t,e)=>{const i=t.split("/");for(let t=0;t<i.length;t++){const r=s[t];let n=parseInt(i[t]);isNaN(n)||(n+=n<0?r.length:-1,g[t].push(...r[n]),!t&&e&&u.color.push(...e[n]))}},x=t=>t.map(parseFloat),y=i.split("\n");for(let t=0;t<y.length;t++){const i=y[t].trim();if(""===i||i.startsWith("#"))continue;const[s,_]=e(i);let b=_.split(/\s+/);switch(s){case"v":b.length>3&&(a.push(x(b.slice(3))),b=b.slice(0,3)),r.push(x(b));break;case"vn":o.push(x(b));break;case"vt":n.push(x(b));break;case"f":u||(g=[[],[],[],[]],u={position:g[0],uv:g[1],normal:g[2],color:g[3],object:p,groups:d},f.geometryIndex=h.length,c.push(f),f={geometryIndex:0,material:"default"},h.push(u));const t=a.length>1?a:null;for(let e=0,i=b.length-2;e<i;++e)v(b[0],t),v(b[e+1],t),v(b[e+2],t);break;case"mtllib":l.push(_);break;case"usemtl":f.material=_,m();break;case"g":d=b,m();break;case"o":p=_,m()}}return{faces:c,geometries:h,mtlLibs:l}})(o),c=new URL(s,location.href),u=await Promise.all(l.map((async t=>{let e=await fetch(new URL(t,c).href);if(200==e.status)return await e.text()}))),d=(t=>{let s={};const r={},n=t.split("\n");for(let t=0;t<n.length;t++){const o=n[t].trim();if(""===o||o.startsWith("#"))continue;const[a,l]=e(o),h=l.split(/\s+/);switch(a){case"newmtl":s={},r[l]=s;break;case"d":case"Ns":case"illum":s[i[a]]=parseFloat(h[0]);break;case"Ka":case"Kd":case"Ks":case"Ke":s[i[a]]=h.map(parseFloat);break;case"map_Kd":case"map_Ns":case"map_Bump":s[i[a]]=l}}return r})(u.join("\n"));return r={geometries:a,materials:d,faces:h},r.textures=await(async(t,e)=>{const i={},s=[];for(let r in t){const n=t[r];for(let t in n)if(t.endsWith("Map")){const r=n[t];s.push((async()=>{const t=await fetch(new URL(r,e).href);if(t.status>=400)return;const s=await t.blob(),n=await createImageBitmap(s,{imageOrientation:"flipY",premultiplyAlpha:"none",colorSpaceConversion:"none"});return i[r]=n,n})())}}return await Promise.all(s),i})(d,c),r})();return async({url:t})=>{let e;try{e=await s(t)}catch(t){return{error:t}}let i=[];for(let t of e.geometries)for(let e of["position","uv","normal","color"])t[e]&&(t[e].length?(t[e]=new Float32Array(t[e]),i.push(t[e].buffer)):delete t[e]);for(let t in e.textures)i.push(e.textures[t]);return{message:e,transfer:i}}};class Js extends Ks{constructor(){super(Qs),this.inProgress={}}async load(t){var e;return(e=this.inProgress)[t]||(e[t]=(async()=>{const e=new URL(t,window.top.location.href),i=await this.main({url:e.href});return delete this.inProgress[t],i})())}}class tr extends ne{constructor(){super(...arguments),this.ref=0}}class er{constructor(t){this.models={};const e=new tr(t,{width:1,height:1,data:new Uint8Array([255,255,255,255])});e.ref=1/0,this.unusedTexture=e;const i=new tr(t,{width:1,height:1,data:new Uint8Array([127,127,255,255])});i.ref=1/0,this.unusedNormalTexture=i,this.gl=t,this.onBufferDestroyed=t=>{0===t.attributes.a_position.ref&&delete this.models[t.id]},this.objParser=new Js}destroy(){this.objParser.destroy()}isValid(t){var e,i;return!(!(null===(e=null==t?void 0:t.faces)||void 0===e?void 0:e.length)||!(null===(i=t.geometries)||void 0===i?void 0:i[t.faces[0].geometryIndex]))}async loadObj(t){const e=await this.objParser.load(t);return this.initModel(t,e)}initTexture(t,e,i,s){let r=i[t];return r||(r=new tr(this.gl,e,s),i[t]=r),r}getModel(t){return this.models[t]}initModel(t,e){var i;if(null!=this.models[t])return this.models[t];if(this.isValid(e)){const{geometries:s,materials:r,faces:n}=e,o=new WeakMap,a=e.textures||{},l=[],h={unusedTexture:this.unusedTexture,unusedNormalTexture:this.unusedNormalTexture};for(let t of n){const e=s[t.geometryIndex];if(!e)continue;const n=Object.assign({diffuse:[1,1,1],diffuseMap:"unusedTexture",opacity:1,illumination:1,ambient:[1,1,1],specular:[1,1,1],specularMap:"unusedTexture",shininess:0,normalMap:"unusedNormalTexture",useUVMapping:!0},null==r?void 0:r[t.material]);let c=o.get(e);const u=e.index;n.pointSize="Points"==n.mode?null!==(i=n.pointSize)&&void 0!==i?i:1:0,c||(c=$s.init(e));const d=e.bbox||(e.bbox=$s.calcBBox(e)),f=n;for(let t in n)if(t.endsWith("Map")){const e=f[t];let i=a[e],s=n.wrap,r=this.gl.REPEAT,o=this.gl.REPEAT;"string"==typeof s&&(s=[s,s]),Array.isArray(s)&&([r,o]=s.map((t=>"clamp"==t?this.gl.CLAMP_TO_EDGE:"mirror"==t?this.gl.MIRRORED_REPEAT:this.gl.REPEAT)));const l={flipY:n.flipY,wrapS:r,wrapT:o};f[t]=this.initTexture(e,i,h,l)}const p=f.diffuseMap;if(!f.useUVMapping&&p){const t=n.uvScale||1;f.u_textureSize=[p.width*t,p.height*t]}delete f.mode,delete f.flipY,l.push({attributes:c,bbox:d,uniforms:f,index:u,first:t.start,count:t.count})}this.models[t]={textures:h,parts:l}}else this.models[t]=!1;return this.models[t]}createModelBuffer(t,e,i,s,n){const o=this.models[t];let a;if(o){a=new Si;let l,h,c,{parts:u}=o;for(let o=0;o<u.length;o++){let{attributes:d,bbox:f,uniforms:p,index:g,first:m,count:v}=u[o],x=new $s(c,c,h,l);h=x.flexAttributes.a_modelMatrix,l=x.flexAttributes.a_offset;for(let t in d){let e=d[t];e.ref=(e.ref||0)+1,x.flexAttributes[t]=e}const y=x.uniforms;for(let t in p){let e=p[t];e instanceof tr&&e.ref++,y[t]=e}e&&(y.specular=r.add([],y.specular,e),y.shininess+=i),s&&(y.emissive?y.emissive=r.add([],y.emissive,s):y.emissive=s),g?x.setIndex(g):x.setArray(m||0,v),x.bbox=f,x.cullFace=n,x.id=t,a.set(o,x)}a.get(0).destroy=this.onBufferDestroyed}return a}addPosition(t,e,i,s,r,n,o,a){const{buffers:l}=t,[h]=l;h.addInstance(e,i,s,r,n,o,a);for(let t=1;t<l.length;t++)l[t].instances=h.instances,l[t].uniforms.u_normalMatrix=h.uniforms.u_normalMatrix}}const ir=document.createElement("canvas"),sr=ir.getContext("2d");ir.width=1,ir.height=1;function rr(){let t=this;const e=t._cbs,i=Math.max(t.width,t.height);if(t._cbs=null,!t.skipAutoScale&&i>64){const e=64/i;t=t._r[t.src]=((t,e)=>{const i=document.createElement("canvas"),s=i.getContext("2d");return i.width=t.width*e,i.height=t.height*e,s.drawImage(t,0,0,i.width,i.height),i})(t,e)}else sr.drawImage(t,0,0);t.ready=!0,t._r=null;for(let i in e)e[i][0](t,e[i][1])}class nr{constructor(){this.imgData={},this.promises={}}isRequested(t){return!!this.imgData[t]}isReady(t){var e;return null===(e=this.imgData[t])||void 0===e?void 0:e.ready}get(t,e,i,s,r){let n=this.imgData;if(null==n[t]){let o=n[t]=new Image;o.ready=!1,o._cbs={},e&&(o._cbs[i]=[e,s]),o._r=n,o.crossOrigin="Anonymous",o.skipAutoScale=r,o.onload=rr,o.src=t}else e&&(n[t].ready?e(n[t],s):n[t]._cbs[i]=[e,s]);return n[t]}}class or{constructor(t){this.loader=new nr,this.textures=new Map,this.promises=new Map,this.gl=t,this.atlas=new vs({gl:t,maxImgSize:64})}getTexture(t){const e=this.textures.get(t);return e.ref++,e}load(t,e){var i;const{loader:s,promises:r}=this;return null!==(i=this.textures.get(t))&&void 0!==i?i:r[t]||(r[t]=new Promise(((i,n)=>{s.get(t,(s=>{delete r[t];const n=new ne(this.gl,s,e);n.ref=1/0,this.textures.set(t,n),i(n)}),"*",void 0,!0)})))}loadAtlas(t,e){const{atlas:i,loader:s,promises:r}=this;if(e){const i=this.textures.get(t);return i?new ms(0,e.x,e.x+e.width,e.y,e.y+e.height,i):this.load(t)}return i.get(t)||r[t]||(r[t]=new Promise(((e,n)=>{s.get(t,(s=>{delete r[t];let n=i.set(t,s);this.textures.set(t,i.texture),e(n)}))})))}destroy(){this.atlas.destroy()}}class ar{constructor(t,e=256,i=1){this.gl=t,this.width=e,this.height=i}isGradient(t){return"string"==typeof(null==t?void 0:t.type)&&"object"==typeof t.stops}createTexture(t,e){const i=this.isGradient(t)?t.stops:t,s=ar.canvas,r=ar.ctx,{width:n,height:o}=this;s.width=n,s.height=o;const a=r.createLinearGradient(0,0,n,o),l=(null==e?void 0:e(i))||i;for(var h in l)a.addColorStop(Number(h),l[h]);r.fillStyle=a,r.fillRect(0,0,n,o);const c=r.getImageData(0,0,n,o).data;return new lr(this.gl,{width:n,height:o,data:c},{premultiplyAlpha:!0})}}ar.canvas=document.createElement("canvas"),ar.ctx=ar.canvas.getContext("2d");class lr extends ne{constructor(){super(...arguments),this.ref=0}destroy(){this.cache.delete(this.id),super.destroy()}}class hr{constructor(t){this.textures=new Map,this.gradients=new ar(t,256,1),this.gl=t}getFillTexture(t){const{gradients:i}=this;let s=this.textures.get(t);if(!s){if(i.isGradient(t))s=i.createTexture(t);else{const i=e.toRGB(t,!0);s=new lr(this.gl,{data:new Uint8Array(i.map((t=>255*t))),width:1,height:1})}this.addTexture(t,s)}return s.ref++,s}getGradientTexture(t,e){let i=this.textures.get(t);return i||(i=this.gradients.createTexture(t,e),this.addTexture(t,i)),i.ref++,i}addTexture(t,e){this.textures.set(t,e),e.id=t,e.cache=this.textures}removeTexture(t){const e=this.textures.get(t);e&&(e.destroy(),this.textures.delete(t))}clear(){for(const t of this.textures.values())t.destroy();this.textures.clear()}}const{toRGB:cr}=e,ur="*";let dr;const fr=t=>t instanceof i,pr=l.dynamic,gr=["px","px"];class mr{constructor(t,e,i){this.pendingCollisions=[],this.gl=t,this.atlasManager=new or(t),this.textureManager=new hr(t),this.dpr=i,this.collisions=e,this.lineFactory=new ws(t),this.modelFactory=new er(t);const s=262144,r=new Uint8Array(1048576);for(let t=0;t<s;t++)r[4*t]=255,r[4*t+1]=0,r[4*t+2]=0,r[4*t+3]=255}toRGBA(t,e=1,i=!0){const s=Array.isArray(t)?[t[0],t[1],t[2],"number"==typeof t[3]?t[3]:1]:cr(t);return s&&(e=s[3]*=e,i&&(s[0]*=e,s[1]*=e,s[2]*=e)),s||null}init(t,e,i,s,r,n){this.tile=t,this.groups=e,this.tileSize=i,this.z=s,this.zLayer=r,this.lineFactory.initTile(),this.pendingCollisions.length=0,this.waitAndRefresh=n}createPoint(t,e,i,s,r,n,o,a,l=0,h,c,u,d){var f;const p=null===r,g=this.z;let m,v,x;if(l=(l+360)%360,"Text"==t){e.buffer||(e.buffer=new Ss(p,this.tileSize,h!=dr),e.buffer.addUniform("u_texture",new Ee(this.gl,e.shared)));const t=e.buffer.uniforms.u_texture,{flexAttributes:a}=e.buffer;t.addChars(c);const y=t.getAtlas();let _=null!==(f=st("lineWrap",n,o,g))&&void 0!==f?f:u;const b=F(c,_);m=a.a_position,v=m.data.length,x=v+t.bufferLength(c,p?2:3),e.buffer.addText(i,s,r,b,y,l,h,d)}else{if("Model"==t){let t,a=st("model",n,o,g);if(!a)return;if("string"==typeof a){if(t=a,a=this.modelFactory.getModel(t),a===dr)return void(t.endsWith(".obj")&&this.waitAndRefresh(this.modelFactory.loadObj(t)))}else t=a.id||(a.id=Math.random()),a=this.modelFactory.initModel(t,a);if(!1===a)return;let l=e.buffer;const{rotate:h,cullFace:c}=n,u=st("transform",n,o,g),d=st("scale",n,o,g),f=st("translate",n,o,g);if(!e.buffer){let i;c&&(i="Front"==c?this.gl.BACK:this.gl.FRONT);const{shared:s}=e;l=e.buffer=this.modelFactory.createModelBuffer(t,s.specular,s.shininess,s.emissive,i)}this.modelFactory.addPosition(l,i,s,r,d,f,h,u)}else if("Icon"==t){e.buffer||(e.buffer=new Ms(p,this.tileSize));const t=e.buffer,{flexAttributes:a}=t,h=st("src",n,o,g),c=st("width",n,o,g),u=st("height",n,o,g)||c,d=n.atlas,f=this.atlasManager.loadAtlas(h,d);if(f.then)return this.waitAndRefresh(f);m=a.a_position,t.addIcon(i,s,r,f,c,u,l),t.addUniform("u_texture",this.atlasManager.getTexture(h))}else if("Circle"==t||"Rect"==t){const t=e.buffer||(e.buffer=new Pi(p,this.tileSize));m=t.flexAttributes.a_position,t.addPoint(i,s,r)}else if("Heatmap"==t){const t=e.buffer||(e.buffer=new Ei(p,this.tileSize)),r=st("weight",n,o,g);t.addPoint(i,s,r)}else if("Sphere"==t){st("radius",n,o,g);const t=e.buffer||(e.buffer=new Zs(p)),{flexAttributes:a}=t;m=a.a_position,Ns(i,s,r,0,m.data,a.a_point.data,a.a_normal.data)}else{if("Box"!=t)return void(r>0&&"VerticalLine"==t&&Fs(e,i,s,r));{let t=st("width",n,o,g),a=st("height",n,o,g)||t,l=st("depth",n,o,g)||t;const h=e.buffer||(e.buffer=new Us(p)),{flexAttributes:c}=h;m=c.a_position,((t,e,i,s,r,n,o,a,l)=>{if(t*=Ds,e*=Ds,"number"==typeof i){i=Math.round(i/9e3*65535),o.reserve(108);for(let s=0;s<36;s++)o.data[o.length++]=t,o.data[o.length++]=e,o.data[o.length++]=i}else{o.reserve(72);for(let i=0;i<36;i++)o.data[o.length++]=t,o.data[o.length++]=e}s<<=1,r<<=1,n<<=1,a.push(0|s,1|r,1|n,1|s,1|r,1|n,0|s,1|r,0|n,0|s,1|r,0|n,1|s,1|r,1|n,1|s,1|r,0|n,0|s,0|r,0|n,1|s,0|r,1|n,0|s,0|r,1|n,1|s,0|r,0|n,1|s,0|r,1|n,0|s,0|r,0|n,0|s,1|r,0|n,0|s,0|r,0|n,0|s,1|r,1|n,0|s,0|r,0|n,0|s,0|r,1|n,0|s,1|r,1|n,1|s,1|r,0|n,1|s,1|r,1|n,1|s,0|r,0|n,1|s,0|r,0|n,1|s,1|r,1|n,1|s,0|r,1|n,0|s,0|r,1|n,1|s,1|r,1|n,0|s,1|r,1|n,0|s,0|r,1|n,1|s,0|r,1|n,1|s,1|r,1|n,0|s,0|r,0|n,1|s,1|r,0|n,0|s,1|r,0|n,0|s,0|r,0|n,1|s,0|r,0|n,1|s,1|r,0|n),l&&l.push(0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1)})(i,s,r,t,a,l,m.data,c.a_point.data,c.a_normal.data)}}x=null==m?void 0:m.data.length,v=x-12}e.buffer.setIdOffset(o.id),a&&m&&a.attrs.push({buffer:m,start:v,stop:x})}create(t,e,i,s,r,n,o,a,l=!0){var h,c,u;const{tile:d,groups:f,tileSize:p}=this,g=this.z;let m,v,x,y,_,b,w,A,S,M,T,L,z,P,I,E,k,R,F,D,O,U,B,W,N,G,Z,H,Y,V,X,j,q,$,K,Q={};if(this.lineFactory.initFeature(g,p,null==a?void 0:a.id),o!==dr||"Point"!==e||d.isInside(i)){for(let J=0,tt=s.length;J<tt;J++){if(y=s[J],b=st("type",y,t,g),!b)continue;if(w=st("opacity",y,t,g),0===w)continue;let tt,it="Polygon"==e||st("collide",y,t,g);if(o==dr&&("Text"==b&&!it||!1===it)){let e=st("collisionGroup",y,t,g)||"0",i=Q[e];const s=ht(y,t,g,this.dpr,null==i?void 0:i.bbox);if(s){i||(i=Q[e]={id:e,bbox:null,priority:Number.MAX_SAFE_INTEGER,repeat:-Number.MAX_SAFE_INTEGER,styleGrp:[]}),i.bbox=s,i.styleGrp.push(y);const r=st("priority",y,t,g);r<i.priority&&(i.priority=r);const n=st("repeat",y,t,g);n<i.repeat&&(i.repeat=n),i.id+=`${b}${r||"?"}${n||"?"}`}continue}(w==dr||w>=.98)&&(w=1),"Image"==b&&(b="Icon"),A=dr,S=dr,L=dr,M=dr,z=dr,P=dr,I=dr,E=dr,k=dr,R=dr,O=dr,U=dr,Z=0,H=0,V=dr,j=dr,X=r,q="px",$=dr;let nt,ot,at,lt,ct=l,ut=!1,dt=null,ft=!1,pt=1;T=0^st("rotation",y,t,g);let gt=st("altitude",y,t,g);if("Model"==b)(u=y).modelId||(u.modelId=Math.random()),y.terrain&&(dt=[t.properties.minHeight,t.properties.maxHeight]),W="M"+y.modelId,ut=!0,ft=!0;else if("Icon"==b)j=st("alignment",y,t,g)||"viewport",W=(gt?"AI":"I")+(j||""),ut=!0;else{let i;if(L=st("stroke",y,t,g),"Line"==b){if(!L)continue;if(P=st("strokeWidth",y,t,g,pr),!P)continue;fr(P)?i=P.id():([P,q]=rt(P),i=P),k=st("strokeLinecap",y,t,g)||"round",R=st("strokeLinejoin",y,t,g)||"round";const e=st("offset",y,t,g);if([Z,$]=rt(e),W=(gt?"AL":"L")+q+Z+$+k+R,I=st("strokeDasharray",y,t,g,pr),fr(I))W+=I.id(),I={pattern:I,units:gr};else if(Array.isArray(I)&&I[0]){let t=[],e=[];for(let i=0;i<I.length;i++){const[s,r]=rt(I[i]);t[i]=s,e[i]=r,W+=s+r}I={pattern:t,units:e}}else I=dr;I&&(E=st("strokeDashimage",y,t,g),E&&(W+=E.slice(-8)))}else if(P=st("strokeWidth",y,t,g),i=P,"VerticalLine"==b)Y=st("offsetZ",y,t,g)||0,W="VL"+L+Y,gt==dr&&(gt=!0);else if(S=st("fill",y,t,g),"Polygon"==b){if(!S||"Polygon"!=e)continue;F=st("extrude",y,t,g),D=st("extrudeBase",y,t,g),ft=!0,F>0||D>0?(W="E",b="Extrude"):W="P"}else{if("Polygon"==e)continue;if(j=st("alignment",y,t,g),"Text"==b){if(V=et(y,t,g),!V)continue;V=ks(V),A=st("font",y,t,g)||C,j==dr&&(j="Point"==e?"viewport":"map"),W="T"+(A||ur)}else if("Circle"==b){let e;O=U=st("radius",y,t,g,pr),fr(O)?e=O.id||(O.id=O++):([O,q]=rt(O),e=O),W=(gt?"AC":"C")+q+e||ur}else if("Heatmap"==b){O=st("radius",y,t,g),[O,q]=rt(O),M=S;const e=st("intensity",y,t,g);U=e,W="H"+(O||ur)+JSON.stringify(S)+e}else if("Rect"==b)O=st("width",y,t,g),[O,q]=rt(O),U=st("height",y,t,g),U=U?rt(U)[0]:O,W=(gt?"AR":"R")+T+q+O+U;else{if("Box"!=b&&"Sphere"!=b)continue;{"Box"==b?W="B"+T:(O=U=st("radius",y,t,g),[O,q]=rt(O),W="S"+O);const e=st("pointerEvents",y,t,g);"boolean"==typeof e&&(ct=e),W+=ct,ft=!0}}ut=!0,W+=j||""}!M&&S&&(M=this.toRGBA(S,w)),L&&(z=this.toRGBA(L,w),"Text"==b&&(X=1),fr(P)||("number"!=typeof P?P=1:(P*=X,P<0&&(P=1)))),W+=(L||ur)+(i||ur)+(S||ur)}ut&&(Z=st("offsetX",y,t,g),H=st("offsetY",y,t,g),Y=st("offsetZ",y,t,g),$=new Array(3),[Z,$[0]]=rt(Z),[H,$[1]]=rt(H),[Y,$[2]]=rt(Y),W+=Z+(H<<8)+(Y<<16)+$[0]+$[1]+$[2]),ft&&(lt=st("light",y,t,g),lt&&(W+=lt),nt=st("emissive",y,t,g),nt&&(W+=nt,nt=this.toRGBA(nt).slice(0,3)),at=st("specular",y,t,g),at&&(ot=null!==(h=st("shininess",y,t,g))&&void 0!==h?h:32,W+=at+ot,at=this.toRGBA(at).slice(0,3)),pt=null!==(c=st("fillIntensity",y,t,g))&&void 0!==c?c:1),W+=100*w^0,_=st("zIndex",y,t,g);let mt,vt=st("zLayer",y,t,g);vt==dr&&(vt=this.zLayer),W=vt+W,gt&&(mt=st("depthTest",y,t,g),mt||(W="ND"+W));let xt=st("scaleByAltitude",y,t,g);if(xt=xt==dr?"m"==q:!!xt,xt&&(W+="SA"),B=f[_]=f[_]||{index:{},groups:[]},G=B.index[W],G==dr?(G=B.index[W]=B.groups.length,N=B.groups[G]={type:b,zLayer:vt,depthTest:mt,pointerEvents:ct,shared:{unit:q,font:A,fill:M,fillIntensity:pt,opacity:w,stroke:z,strokeWidth:P,strokeLinecap:k,strokeLinejoin:R,strokeDasharray:I,strokeDashimage:E,width:O,height:U,depth:tt,rotation:T,offsetX:Z,offsetY:H,offsetZ:Y,offsetUnit:$,alignment:j,modelMode:dt,scaleByAltitude:xt,emissive:nt,shininess:ot,specular:at,light:lt}}):N=B.groups[G],"Point"==e)if("VerticalLine"==b){if("number"==typeof gt||i[2]>0){const t="number"==typeof gt?gt:i[2];if(t>0){const e=d.lon2x(i[0],p),s=d.lat2y(i[1],p);Fs(N,e,s,t)}}}else{const e=d.lon2x(i[0],p),s=d.lat2y(i[1],p),r="number"==typeof gt?gt:gt?i[2]||0:null;if(a){if(K=this.collisions.insert(e,s,r,a.offsetX,a.offsetY,a.width,a.height,d,p,a.priority),!K)return;a=null}this.createPoint(b,N,e,s,r,y,t,K,T,dr,V,dr,"Text"==b&&st("textAnchor",y,t,g))}else if("LineString"==e)if("Line"==b){if(E){const t=this.atlasManager.load(E,{mipMaps:!1});if(t.then)return void this.waitAndRefresh(t)}this.lineFactory.createLine(i,N,d,p,n,I,k,R,P,gt,Z,st("from",y,t,g),st("to",y,t,g)),E&&N.buffer.addUniform("u_dashTexture",this.atlasManager.getTexture(E)),N.buffer.setIdOffset(t.id)}else{let e="Text"==b,s=st("anchor",y,t,g);null!=s||(s=e?"Line":"Coordinate");const r=e&&st("textAnchor",y,t,g),n=e?!it:!1===it;let l,h;const c=st("from",y,t,g),u=st("to",y,t,g);if("Line"==s){const e="map"==j;if(a)l=2*a.width,h=2*a.height;else if("Icon"==b)l=st("width",y,t,g),h=st("height",y,t,g)||O;else if("Text"==b){N.buffer||(N.buffer=new Ss(!0,this.tileSize,!0),N.buffer.addUniform("u_texture",new Ee(this.gl,y)));const t=N.buffer.uniforms.u_texture.getAtlas();l=t.getTextWidth(V),h=t.letterHeight}else l=O,h=U,"Circle"==b&&(l*=2,h*=2);let s=st("checkLineSpace",y,t,g);s==dr&&(s=!0),this.lineFactory.placeAtSegments(i,gt,d,p,n&&this.collisions,o,st("repeat",y,t,g),Z,H,l,h,e,s,c,u,((e,i,s,n,o,a)=>{this.createPoint(b,N,e,i,s,y,t,a,n+T,o,V,!1,r)}))}else a?(l=a.width,h=a.height):(l=O/2,h=U/2),this.lineFactory.placeAtPoints(i,gt,d,p,n&&this.collisions,o,l,h,Z,H,c,u,((e,i,s,n,o,a)=>{this.createPoint(b,N,e,i,s,y,t,a,n+T,dr,V,dr,r)}))}else if("Polygon"==b||"Extrude"==b){N.buffer||(N.buffer="Polygon"==b?new Ts(!gt):new Ls);const e=N.buffer,s=e.index(),{flexAttributes:r}=e,n=r.a_position.data;if(m=n.length,"Extrude"==b){let t;L&&(t=N.extrudeStrokeIndex=N.extrudeStrokeIndex||[]),v=Gi(n,N.buffer.flexAttributes.a_normal.data,s,i,d,p,F,D,t)}else"Polygon"==b&&(v=Bi(n,i,d,p,!e.isFlat()));if(N.buffer.setIdOffset(t.id),!x){const e=t.geometry;if(e._xyz)x=e._xyz;else{x=[];for(let t of v){let e=t.dimensions,i=Zi(n.data.subarray(t.start,t.stop),t.holes,e),s=(t.start-m)/e;for(let t of i)x.push(s+t)}d.clipped||(e._xyz=x)}}for(let t,i=0,r=m/v[0].dimensions;i<x.length;i++)t=r+x[i],e.i32=e.i32||t>65535,s.push(t)}}for(let s in Q){const r=Q[s],[n,o,a,l]=r.bbox,h=.5*(a-n),c=.5*(l-o);r.feature=t,r.geomType=e,r.coordinates=i,r.offsetX=n+h,r.offsetY=o+c,r.width=h,r.height=c,this.pendingCollisions.push(r)}}}destroy(){this.modelFactory.destroy()}}const vr={time:4,priority:3,init([t,e,i]){const s=t.projectCollisionsToScreen(e,null);return s.sort(((t,e)=>t.priority-e.priority)),{startTs:performance.now(),screenCollisionData:s,index:0,sorted:!1,updated:!1,processBatchSize:100,visibleMap:[],visibleViewport:[],collisionHandler:t,onDone:i}},exec(t){const{collisionHandler:e,screenCollisionData:i,visibleMap:s,visibleViewport:r,processBatchSize:n}=t,o=i;for(let i=t.index,a=o.length;i<a;){const a=o[i++],l=e.processCollision(a,s,r);if(t.updated||(t.updated=l),i%n==0)return t.index=i,!0}return!1},onDone(t){t.onDone(t.updated)}};class xr{constructor(t){this.tiles={},this.display=t,this.debug(!1),this.task=a.getInstance().create(vr)}getTileCache(t){var e,i;return(e=this.tiles)[i=0^t]||(e[i]=new Map)}debug(t){t?this.dbgLayers||setTimeout((()=>{const t=Fo.getInstances().find((t=>t._display==this.display));this.dbgLayers=Array(2).fill(0).map((()=>new m({pointerEvents:!1,min:2,max:28,tileSize:512,provider:new v({}),adaptiveGrid:!0,style:{zLayer:1e5,styleGroups:{box:[{zIndex:0,type:"Rect",strokeWidth:2,stroke:({properties:t})=>t.color,width:({properties:t})=>t.width,height:({properties:t})=>t.height,collide:!0}]},assign:()=>"box"}}))),this.dbgLayers.forEach((e=>{t.addLayer(e),this.display.layers.get(e).skipDbgGrid=!0}))}),0):this.dbgLayers&&this.dbgLayers.forEach((t=>t.getProvider().clear())),this.dbg=t}dbgBBoxes(t,e,i,s){const r=Fo.getInstances().pop(),n="number"==typeof e;for(let o of t.boxes){let t,a,l=.5*(o.maxX-o.minX),h=.5*(o.maxY-o.minY);if(n)t=p.x2lon(o.maxX-l,1),a=p.y2lat(o.maxY-h,1),s||(s=256<<e),l*=s,h*=s;else{const s=r.pixelToGeo(o.minX+l,o.minY+h);t=s.longitude,a=s.latitude,i=e?"orange":"green"}this.dbgLayers[Number(!n)].addFeature({type:"Feature",geometry:{type:"Point",coordinates:[t,a]},properties:{color:i,width:2*l,height:2*h}})}}getTileCacheKey(t,e){return t}getLayerId(t){return String(t.layer.id||t.id)}intersects(t,e){const i=t.boxes;for(let t=0,s=e.length;t<s;++t){const s=e[t].boxes;for(let t=0,e=s.length;t<e;++t){const e=s[t];for(let t=0,s=i.length;t<s;++t){const s=i[t];if(s.minX<=e.maxX&&e.minX<=s.maxX&&s.minY<=e.maxY&&e.minY<=s.maxY)return!0}}}return!1}updateBBoxes(t,e,i,s,r,n,o,a){for(let l=0;l<=o;l++){let h=.75*(l/o-.5),c=i*h+t,u=s*h+e;a[l]={minX:c-r,maxX:c+r,minY:u-n,maxY:u+n}}}getTargetZoom(t,e){return t.length}initTile(t,e){let{quadkey:i,x:s,y:r,z:n}=t;const o=this.getTargetZoom(i,e),a=this.getTileCache(o);this.clearTile(i,e,o);const l={};for(let t=-1;t<2;t++)for(let e=-1;e<2;e++){let i=g.tileXYToQuadKey(n,r+t,s+e),o=a.get(i);if(o)for(let t in o)l[i]=o[t]}const h=this.getTileCacheKey(i,e);this.curLayerTileCollision={tileSize:e.tileSize,tileKey:h,tileCache:a,data:[],layer:e,existing:l},this.updated=!1}insert(t,e,i,s,r,n,o,a,l,h=Number.MAX_SAFE_INTEGER,c){let u=a.x,d=a.y,f=a.z,p=4,g=l<<f;const m=1/(1<<f);t/=g,e/=g,p/=g,n/=g,o/=g,t+=u*m,e+=d*m,n+=p,o+=p;const v=Math.min(n,o),x=Math.max(n,o),y=t+s/g,_=e+r/g;let b,w=Math.floor(x/v);c&&w>1.5?(n=v,o=v,w=Math.floor(.7*w),b=new Array(w),this.updateBBoxes(y,_,c[0]/g,c[1]/g,v,v,w,b)):b=[{minX:y-n,maxX:y+n,minY:_-o,maxY:_+o}];const A={cx:t,cy:e,cz:i,halfWidth:n,halfHeight:o,offsetX:s,offsetY:r,boxes:b,slope:c,priority:h,attrs:[]},{data:S,existing:M}=this.curLayerTileCollision,{dbg:T}=this;if(this.intersects(A,S))return!1;for(let t in M)if(this.intersects(A,M[t]))return T&&this.dbgBBoxes(A,f,"#680025",g),!1;return this.updated=!0,S.push(A),A}completeTile(t){let{tileKey:e,data:i,tileCache:s,tileSize:r,layer:n}=this.curLayerTileCollision;this.curLayerTileCollision=null;const o=s.get(e)||{};return o[this.getLayerId(n)]=i,s.set(e,o),t&&this.updated&&this.updateTileSync(this.display.getScreenTile(e,r),n),this.updated}clearTile(t,e,i=this.getTargetZoom(t,e)){const s=this.getLayerId(e),r=this.getTileCache(i);if(this.curLayerTileCollision&&this.getLayerId(this.curLayerTileCollision.layer)==s)return;const n=r.get(t);if(null==n?void 0:n[s]){delete n[s];let e=!0;for(let t in n){e=!1;break}e&&r.delete(t)}}updateTileSync(t,e){if(t){const i=this.projectCollisionsToScreen([e],[t]);return this.intersectCollisionData(i)}}update(t,e){this.isUpdating||(this.isUpdating=!0,setTimeout((()=>{this.dbg&&(this.dbgSkipNextRefresh=!this.dbgSkipNextRefresh)&&this.dbgLayers[1].getProvider().clear(),this.task.start([this,this.display.layers,t=>{this.isUpdating=!1,t&&(null==e||e())}])}),250))}projectCollisionsToScreen(t,e){const{centerWorld:i,w:s,h:r,s:n,zoom:o}=this.display,a=256<<o,l=i[0]*a-.5*s,h=i[1]*a-.5*r,c=[];for(let i of t)this.collisionsWorld2Screen(c,a,l,h,e||i.tiles,i,n);return c}collisionsWorld2Screen(t,e,i,s,r,n,o){const a=this.getLayerId(n),l=new Set;for(let n of r){const{quadkey:r,scale:h}=n;if(l.has(r))continue;l.add(r);const c=r.length,u=this.getTileCache(c).get(r);u&&this.updateTileCollisionData(a,e,i,s,h,u,o,t)}}intersectCollisionData(t){t.sort(((t,e)=>t.priority-e.priority));const e=[],i=[];let s=!1;for(let r of t){const t=this.processCollision(r,e,i);s||(s=t)}return s}processCollision(t,e,i){let s,r=!1,n=this.intersects(t,i);t.slope?s=e:(n||(n=this.intersects(t,e)),s=i),n||(s[s.length]=t);for(let{buffer:e,start:i,stop:s}of t.attrs){const{data:t,size:o}=e;if(n==!(1&~t[i])){for(;i<s;)t[i]^=1,i+=o;e.dirty=!0,r=!0}}return this.dbg&&this.dbgBBoxes(t,n),r}updateTileCollisionData(t,e,i,s,r,n,o,a){const{display:l}=this;for(let h in n){if(h!=t)continue;const c=n[t];for(let t of c){let{attrs:n,cx:h,cy:c,slope:u,halfWidth:d,halfHeight:f,offsetX:p,offsetY:g}=t,m=h*e-i,v=c*e-s;d*=e/r,f*=e/r;const x=t.boxes.length;let y;if(x>1){y=new Array(x),m+=p/o,v+=g/o;let[t,e]=l.project(m,v,0),i=l.project(m+u[0],v+u[1],0);const s=(i[0]-t)/o,r=(i[1]-e)/o;this.updateBBoxes(t,e,s,r,d,f,y.length-1,y)}else{let[t,e]=l.project(m,v,0);y=[{minX:t-d+p,maxX:t+d+p,minY:e-f+g,maxY:e+f+g}]}a.push({boxes:y,attrs:n,slope:u,priority:t.priority})}}}removeTiles(t){for(let e in this.tiles)this.tiles[e].forEach(((i,s)=>{this.clearTile(s,t,Number(e))}))}}const yr=Math.PI/180,_r=66.33*yr,br=60*yr,wr=[3,9],Ar=(t,e)=>{const i=t.length,s=e.length-i;let r=0,n=0,o=1;for(let t=0;t<s;t++){o*=.5;const s=Number(e.charAt(i+t));r+=s%2*o,n+=Number(s>1)*o}return[r,n,o]},Sr=Symbol();class Mr extends Ft{constructor(t,e,i,s){super(t,e,i||"auto",new Ai(512),new xi(s),wr),this.name="gl-test",this.worldCenter=[0,0],this.renderTilePool=new li,this._zSortedTileBuffers={tileBuffers:[],min3dZIndex:0,maxZIndex:0},this.dpr<2&&this.buckets.setSize(1024);const r=this;this.collision=new xr(r),this.buckets.onDrop=function(t,e){const{quadkey:i,layers:s}=this;r.collision.clearTile(i,s[e]),r.releaseBuffers(t)};const{render:n}=r;n.init(this.canvas,this.dpr),this.rayCaster=new ti(n.screenMat,n.invScreenMat),this.factory=new mr(n.gl,this.collision,this.dpr)}refreshTile(t,e){const i=this.layers.get(e);if(i){const e=this.buckets.get(t,!0);if(e){const s=i.layer,{index:r}=i;e.preview(r,!1),e.ready(r,!1),e.cancelTasks(s);const n=s.getCachedTile(e.quadkey);n&&this.getScreenTile(t,i.tileSize)&&this.handleTile(n,s,e,r)}}}releaseBuffers(t){const e=this.render;if(t)for(let i of t)e.deleteBuffer(i)}initLights(t){const e=t.getLights();let i=e[Sr];if(!i){i={};for(let t in e){const s=e[t];i[t]=St(s)}e[Sr]=i}this.render.processedLight[t.index]=i}initSky(t){const e=this.factory.textureManager.getFillTexture(t);this.render.setSkyColor(e)}addLayer(t,e,i){const s=super.addLayer(t,e,i);return 0==(null==s?void 0:s.index)&&this.initSky((null==i?void 0:i.skyColor)||[1,0,0,1]),s}removeLayer(t){const e=this.layers.get(t);return this.collision.removeTiles(e),this.render.processedLight[e.index]=void 0,super.removeLayer(t)}unproject(t,e,i,s){if(s||(s=this.render.invScreenMat),"number"==typeof i){const r=[t,e,i];return Ye(r,r,s),r}const r=[t,e,0],n=[t,e,1];Ye(r,r,s),Ye(n,n,s);const o=r[2],a=n[2],l=o===a?0:(0-o)/(a-o);return[r[0]*(1-l)+n[0]*l,r[1]*(1-l)+n[1]*l]}project(t,e,i=0,s=this.sx,r=this.sy,n=this.render.screenMat){const o=[t-s,e-r,i];return Ye(o,o,n)}updateHorizonOffsets(t){this.horizonY=this.calcHorizonYOffset(t),this.horizonYFixed=this.calcHorizonYOffset(t,this.gridTopWorldAtFixedTilePitch,br)}setSize(t,e){super.setSize(t,e),this.initRenderer();const i=i=>{const s=je([],this.render.updateMapGridMatrix(i,t,e));return this.unproject(0,1,null,s)};this.gridTopWorldAtPitchClamp=i(_r),this.gridTopWorldAtFixedTilePitch=i(br),this.maxHorizonY=this.calcHorizonYOffset(85/180*Math.PI)/e,this.updateHorizonOffsets(this.rx)}setTransform(t,e,i){const s=2*Math.PI;e=(e+s)%s,this.s=t,this.rz=e,this.rx!=i&&this.updateHorizonOffsets(i),this.rx=i}setView(t,e,i,s,r=this.groundResolution,n=this.worldSize){super.setView(t,e,i,s,r,n),this.groundResolution=r,this.worldCenter[0]=t[0],this.worldCenter[1]=t[1],this.worldSize=n,this.initRenderer()}initRenderer(){this.render.gl&&this.render.initView(this.w,this.h,this.s,this.rx,this.rz,this.groundResolution,this.worldCenter[0],this.worldCenter[1],this.worldSize)}prepareTile(t,i,s,r,n){const o=this,a=o.render.gl,l=s.tileSize,{quadkey:h}=r,c=s.id,u=this.layers.get(c);if("image"==t.type&&(i instanceof Image||i instanceof ImageBitmap)){const t=si(i,a,l,u.index>0);u.addZ(t.zIndex),r.preview(r.setData(s,[t]),null),n(r,s)}else if(i.length){const i=((t,i,s,r,n,o)=>{const a=t.layer,l=[],h=t=>{l.push(t)},c=ki.create({time:4,priority:4,init:function(){const o=s.z+a.levelOffset,l=a.getStyle();let c=1;if(l){const t=l.strokeWidthZoomScale||l.LineStringZoomScale;t&&(c=t(o))}null==n||n();const u={};r.init(s,u,i,o,l.zLayer,h);const{showWireframe:d}=l;return{tile:s,data:s.data||[],zoomScale:c,featureIndex:0,chunkSize:16,layer:t,zoom:o,collisions:null,groups:u,showWireframe:d&&"boolean"!=typeof d?e.toRGB(d):d}},name:"createBuffer",onDone:function(e){var i,n,h,c;const u=e.zoom,d=1/p.getGroundResolution(u);let f,g=[];const m=e.groups;for(f in m){const o=m[f];if(o)for(let l of o.groups){let o=l.type,u=l.shared,p=u.stroke,m=u.strokeWidth,v=o;if(!l.buffer||l.buffer.isEmpty())continue;const x=l.buffer instanceof Si?l.buffer.toArray():[l.buffer];for(let y of x){const x=he.fromTemplateBuffer(o,y,u.light);if(null==x)continue;const _=null===(i=u.fill)||void 0===i?void 0:i[3],b=null===(n=u.stroke)||void 0===n?void 0:n[3],w=_<1||b<1;if(x.flat=y.isFlat(),x.addUniform("u_scaleByAltitude",u.scaleByAltitude),x.pointerEvents=l.pointerEvents,"VerticalLine"==v&&(x.addUniform("u_fill",u.stroke),x.addUniform("u_offsetZ",[u.offsetZ,0])),g.push(x),"Line"==o)u.strokeDasharray&&(x.type="DashedLine",x.addUniform("u_dashUnit",["m"==u.strokeDasharray.units[0]?d:0,"m"==u.strokeDasharray.units[1]?d:0])),x.clip=!s.clipped,x.addUniform("u_fill",p),x.addUniform("u_strokeWidth",[m,"m"==u.unit?d:0]),x.addUniform("u_offset",[u.offsetX,"m"==u.offsetUnit?d:0]),x.addUniform("u_no_antialias",!1),x.pass=Nt.ALPHA,(!x.isFlat()||u.strokeDasharray||w)&&(x.pass|=Nt.POST_ALPHA),x.depth=x.blend=!0;else{if("Polygon"==o||"Extrude"==o)x.addUniform("u_fill",u.fill),x.addUniform("u_fillIntensity",u.fillIntensity),"Extrude"==o&&(x.addUniform("u_strokePass",0),u.stroke)&&(x.addGroup(l.extrudeStrokeIndex,y.i32,1).uniforms={u_strokePass:1,u_stroke:u.stroke}),w&&(x.pass=Nt.ALPHA,"Extrude"==o&&(x.pass|=Nt.POST_ALPHA),x.depth=x.blend=!0);else{if("Text"==o||"Icon"==o){"Text"==o?(x.uniforms.u_texture.sync(),x.addUniform("u_fillColor",u.fill||Fi),x.addUniform("u_strokeColor",u.stroke||Fi)):x.addUniform("u_opacity",u.opacity);const t=x.uniforms.u_texture;x.addUniform("u_texSize",[t.width,t.height]),x.addUniform("u_alignMap","map"==u.alignment),x.pass=Nt.ALPHA,x.depth=x.blend=!0}else if("Rect"==o||"Circle"==o||"Box"==o||"Sphere"==o){const t=u.fill||Fi;x.addUniform("u_fill",t),x.addUniform("u_fillIntensity",u.fillIntensity),p&&(x.addUniform("u_stroke",p),m==Di&&(m=1)),x.addUniform("u_strokeWidth",0^m);const e="m"==u.unit?d:0;"Circle"==o||"Sphere"==o?x.addUniform("u_radius",[u.width,e]):(t==Fi&&(x.pass=Nt.ALPHA,x.blend=!0),"Rect"==o&&x.addUniform("u_size",[u.width,e,u.height,e]),x.addUniform("u_rotation",u.rotation*Ri)),w&&(x.pass=Nt.ALPHA,x.depth=x.blend=!0),x.addUniform("u_alignMap","map"==u.alignment)}else if("Heatmap"==o){x.addUniform("u_radius",[u.width,0]),x.addUniform("u_weight",1),x.addUniform("u_intensity","number"==typeof u.height?u.height:1),x.addUniform("u_opacity",u.opacity),x.pass=Nt.ALPHA|Nt.POST_ALPHA,x.flat=!0,x.depth=!1,x.blend=!1;const t=(null===(h=u.fill)||void 0===h?void 0:h.stops)||Ii.stops,e=r.textureManager.getGradientTexture(t,Ei.verifyAndFixGradient);x.addUniform("u_gradient",e)}if(u.offsetUnit&&(x.addUniform("u_offset",[u.offsetX,"m"==u.offsetUnit[0]?d:0,u.offsetY,"m"==u.offsetUnit[1]?d:0]),x.addUniform("u_offsetZ",[u.offsetZ,"m"==u.offsetUnit[2]?d:0])),"Model"==o){x.addUniform("u_isPixelCoords",!!u.modelMode),x.attributes.a_normal||x.addAttribute("a_normal",{data:x.computeNormals(),size:3,normalized:!0}),x.bbox=y.bbox,x.id=y.id,x.zRange=u.modelMode||null,x.destroy=y.destroy||x.destroy,x.depth=!0;const{showWireframe:t}=e;t&&(x.addGroup(y.generateWireframeIndices(),y.i32,he.MODE_GL_LINES).uniforms={diffuse:(!0===t?x.getUniform("diffuse"):t).slice(0,3).map((t=>1-t))}),x.uniforms.pointSize&&(x.groups[0].mode=he.MODE_GL_POINTS),x.uniforms.opacity<1&&(x.pass=Nt.ALPHA,x.blend=!0)}}x.clip=y.clip,"Model"!=o&&(u.emissive&&x.addUniform("u_emissive.color",u.emissive),u.specular&&(x.addUniform("specular",u.specular),x.addUniform("shininess",u.shininess)))}let{zLayer:A}=l;if("top"==f&&(A=1/0,f=0),f=Number(f),!x.flat){x.clip=!1;const{depthTest:t}=l;t!=Di&&(x.depth=t,x.pass&&t||(x.pass=Nt.ALPHA))}t.addZ(f,!x.flat),x.zIndex=f,x.zLayer="number"==typeof A?Math.ceil(A):null,null!==(c=x.clip)&&void 0!==c||(x.clip=!s.clipped||a.getMargin()>0||w)}}}o(g.reverse(),l)},exec:function(t){const{tile:e,data:i,layer:s,zoomScale:n,zoom:o}=t;let a,l,h,c,u,d=i.length;if(!t.collisions){for(u||(u=!1);t.chunkSize--&&(l=i[t.featureIndex++]);)if(a=s.processStyleGroup(l,o),a){h=l.geometry,c=h.type,a.length||(a=[a]);const t=l.getProvider().decCoord(l);if("MultiLineString"==c||"MultiPoint"==c){const e="MultiPoint"==c?"Point":"LineString";for(let i of t)r.create(l,e,i,a,n)}else if("MultiPolygon"==c){r.create(l,"Polygon",t,a,n);for(let i=0;i<t.length;i++)Oi(r,l,t[i],a,n,e,i)}else r.create(l,c,t,a,n),"Polygon"==c&&Oi(r,l,t,a,n,e)}u=t.featureIndex<d}if(!u&&r.pendingCollisions.length){t.collisions||(t.collisions=r.pendingCollisions.sort(((t,e)=>t.priority-e.priority)),t.featureIndex=0);let e,i=t.collisions;if(t.chunkSize>=0)for(;t.chunkSize--&&(e=i[t.featureIndex++]);){const{coordinates:t,priority:i,geomType:s}=e;"Point"!=s&&"LineString"!=s||r.create(e.feature,s,t,e.styleGrp,n,!1,i,e)}u=t.featureIndex<i.length}return t.chunkSize=16,u}});return c.outdated=!1,ki.start(c),c})(u,l,t,this.factory,(()=>{o.collision.initTile(t,u)}),((t,e)=>{r.preview(r.setData(s,t),null),e.length&&e.forEach((t=>{t.then((()=>this.refreshTile(h,c)))}));o.collision.completeTile(!0)&&(this.dirty=!0);let a=r.getOverlayingTiles();for(let t of a)t.preview(u.index,null);i.outdated?(i.outdated=!1,i.restart()):r.removeTask(i,s),n(r,s)}));r.addTask(i,s)}else r.preview(r.setData(s,[]),null),n(r,s)}orderBuffers(t,e,i,s,r,n){for(let o of e){let{zLayer:e,zIndex:a}=o;null==e&&(e=i.index+1);let l,h=1e8*e+10*a;o.flat||(h+=1),s[h]=0,n?(l=this.renderTilePool.getNext(),l.init(o,h,r,i)):l={buffer:o,z:h,data:r,layer:i,tiled:n},t[t.length]=l}}initLayerBuffers(t){var e;const{buckets:i}=this;let s,r=[],n={};for(let o of t){this.initLights(o);let t=o.tiles;if(o.cnt=0,s={},o.layer.tiled){if(t){let a=o.index,l=t.length;for(let h of t){let t=h.tile,c=null===(e=t.data)||void 0===e?void 0:e[o.index];if(!o.ready&&t.ready(a)&&++o.cnt==l&&(o.ready=!0),c)c.length&&this.orderBuffers(r,c,o,n,{tile:h},!0);else{let e;if((e=t.preview(a))&&e.length)for(let l of e){const[e]=l,c=Ar(e,t.quadkey);if(s[e]){s[e].push(c);continue}s[e]=[c];let u,d=i.get(e,!0);u=null==d?void 0:d.getData(a),(null==u?void 0:u.length)&&this.orderBuffers(r,u,o,n,{tile:h,preview:l,stencils:s[e]},!0)}}}}}else{o.ready=!0;const t=o.layer,{renderOptions:e}=t;this.orderBuffers(r,[{zLayer:e.zLayer,zIndex:e.zIndex,pass:e.alpha||1,flat:t.flat}],o,n,o.layer,!1)}}let o=0;for(let t of Object.keys(n).sort(((t,e)=>Number(t)-Number(e))))n[t]=o++;let a=1/0;for(let t,e,i=0;i<r.length;i++)e=r[i],t=e.z=n[e.z],!e.buffer.flat&&t<a&&(a=t);return{tileBuffers:r,min3dZIndex:a,maxZIndex:o}}getCamGroundPositionScreen(){const{cameraWorld:t}=this.render;return this.project(t[0],t[1])}getHorizonYOffset(){return this.horizonY}calcHorizonYOffset(t=this.rx,e=this.gridTopWorldAtPitchClamp,i=_r){let s=0;if(t>i){const{w:i,h:r}=this,n=this.render.updateMapGridMatrix(t,i,r);s=(1-this.project(e[0],e[1],0,0,0,n)[1])*r/2}return s}isPointAboveHorizon(t,e){return this.rx>br&&this.project(t,e)[1]<this.horizonYFixed}useLODTiles(){return this.rx>br}viewport(t){const e=this,{layers:i,render:s}=e;let r;e.dirty&&(e.dirty=!1,e.updateCollisions()),s.fixedView=Number(!this.viewChange),this.renderTilePool.beginFrame();const n=this.initLayerBuffers(i),{tileBuffers:o,min3dZIndex:a,maxZIndex:l}=n;s.clear(e.bgColor),s.drawSky(this.horizonY,this.h,this.maxHorizonY),s.zIndexLength=l,s.setPass(Nt.OPAQUE);let h=o.length;for(;h--;){let t=o[h];(null==t?void 0:t.tiled)&&s.draw(t,a)}s.setPass(Nt.ALPHA),o.sort(((t,e)=>10*(t.z-e.z)+t.buffer.pass-e.buffer.pass)),this._zSortedTileBuffers=n;let c=0;do{let t=!1;for(h=0,r=o.length;h<r;h++){let e=o[h];e.buffer.pass&Nt.POST_ALPHA&&(t=!0),(null==e?void 0:e.z)==c&&(e.tiled?s.draw(e,a):s.drawCustom(e.data,e.z))}s.pass==Nt.POST_ALPHA?s.setPass(Nt.ALPHA):t&&(s.setPass(Nt.POST_ALPHA),c--)}while(++c<l);if(s.tileGrid)for(let t of e.tiles)for(let i of e.layers)if(!i.skipDbgGrid&&-1!==i.tiles.indexOf(t)){s.drawGrid(t.x,t.y,t.tile,t.size*t.scale);break}this.renderTilePool.endFrame()}updateCollisions(){this.collision.update(this.tiles,(()=>this.update()))}destroy(){super.destroy(),this.factory.destroy()}getTerrainHeightAtWorldXY(t,e,i){var s,r,n;const{tileBuffers:o}=this._zSortedTileBuffers;let a=o.length;for(;a--;){if(!o[a].tiled||!o[a].buffer.pointerEvents)continue;const l=o[a];let{layer:h}=l;const c=l.data.tile;if(i!==h.layer)continue;const u=(null===(s=l.data.preview)||void 0===s?void 0:s[0])||c.quadkey,d=null===(n=null===(r=h.layer.getCachedTile(u))||void 0===r?void 0:r.data)||void 0===n?void 0:n[0];if(!(null==d?void 0:d.getHeightMap()))continue;const[f,p]=l.worldToTile(t,e,0),g=c.size;if(f<0||p<0||f>g||p>g)continue;const m=f/g,v=p/g;return d.getHeightAt(m,v)}return null}getRenderedFeatureAt(t,e,i){this.rayCaster.init(t,e,this.w,this.h,this.s,1/this.groundResolution);let s=null;const r=this.rayCaster.origin[2]+.001,{tileBuffers:n,min3dZIndex:o}=this._zSortedTileBuffers;let a=n.length;for(;a--;){if(!n[a].tiled||!n[a].buffer.pointerEvents)continue;const t=n[a];let{buffer:e,z:l,data:h,layer:c}=t;if(-1==(null==i?void 0:i.indexOf(c.layer)))continue;let u=!1;if(e.flat){if(!(l>o))continue;u=!0}const{x:d,y:f,size:p}=h.tile;let g=0,m=r;e.zRange&&(g=e.zRange[0],m=e.zRange[1]);const v=t.getModelMatrix(),x=Ye([],[0,0,g],v),y=Ye([],[p,p,m],v);if(!this.rayCaster.intersectAABBox(x[0],x[1],x[2],y[0],y[1],y[2]))continue;const _=v&&this.rayCaster.transformRayToLocal(v);if(null!=this.rayCaster.intersect(d,f,e,_)&&(s=c,u))break}const l=this.rayCaster.getIntersectionTop();return l.layer=null==s?void 0:s.layer,this.viewport(!0),l}viewChangeDone(){this.viewChange=!1,this.update()}scaleOffsetXYByAltitude(t){const e=this.render.vPMat;return 1-t[2]*e[11]/(e[3]*t[0]+e[7]*t[1]+e[15])}setZoom(t){if(super.setZoom(t))return this.buckets.forEach((t=>{for(let e of t.data)if(e)for(let t of e)t.clearUniformCache()})),!0}computeDistanceScale(t,e){const i=[t,e,0,1],s=function(t,e,i){var s=e[0],r=e[1],n=e[2],o=e[3];return t[0]=i[0]*s+i[4]*r+i[8]*n+i[12]*o,t[1]=i[1]*s+i[5]*r+i[9]*n+i[13]*o,t[2]=i[2]*s+i[6]*r+i[10]*n+i[14]*o,t[3]=i[3]*s+i[7]*r+i[11]*n+i[15]*o,t}(i,i,this.render.screenMat);return s[3]/this.render.distanceCam2Center}get geometryBufferCount(){var t,e;return 0^(null===(e=null===(t=this._zSortedTileBuffers)||void 0===t?void 0:t.tileBuffers)||void 0===e?void 0:e.length)}}Mr.zoomBehavior="float";const Tr=new nr,Lr=2*Math.PI,zr=Math.PI/180,Pr=Math.log(2048)/Math.log(2),Cr=Pr+9,Ir=(t,e,i,s,r,n,o,a,l,h,c,u)=>{const d=o.z;e+=0^st("offsetX",s,r,d),i+=0^st("offsetY",s,r,d);let f,p,g,m,v,x,y=st("rotation",s,r,d),_=e+512<<Pr|i+512|(y+360)%360<<Cr;c[_]||(c[_]=1,y&&(y*=zr,l.translate(e,i),l.rotate(y),v=e,x=i,e=0,i=0),"Text"==t?(s.stroke&&0!=s.strokeWidth&&l.strokeText(n,e,i),s.fill&&l.fillText(n,e,i)):"Circle"==t?(p=st("radius",s,r,d),l.moveTo(e+p,i),l.arc(e,i,p,0,Lr,!1)):(g=st("width",s,r,d),m=st("height",s,r,d)||g,e-=g/2,i-=m/2,"Image"==t?(f=st("src",s,r,d),Tr.isReady(f)?l.drawImage(Tr.get(f),e,i,g,m):Tr.get(f,(()=>u.updateTile(o,a,h)),o.quadkey)):"Rect"==t&&l.rect(e,i,g,m)),y&&(l.rotate(-y),l.translate(-v,-x)))},Er=Math;class kr{constructor(){this.o=.5}init(t){return this.o=t,!0}createSymbol(t,e){let i;return i="Circle"==e.type?e.radius:e.width,t-i>0}drawSymbol(t,e,i,s,r,n,o,a,l,h,c){Ir(r.type,e,i,r,o,!1,n,a,s,l,h,c)}angle(t,e){return Math.atan2(t,e)}place(t,e,i,s,r,n,o,a,l,h){let c,u,d,f,p,g,m,v,x,y;const _=this.o;for(let b=0;b<t.length;b++)d=Math.round(e.lon2x(t[b][0])),f=Math.round(e.lat2y(t[b][1])),b&&(x=d-c,y=f-u,p=Er.sqrt(Er.pow(x,2)+Er.pow(y,2))-16,g=this.createSymbol(p,r),g&&(m=(x*_+c)*h,v=(y*_+u)*h,i.setTransform(h,0,0,h,m,v),i.rotate(this.angle(y,x)),i.translate(-m,-v),this.drawSymbol(g,m,v,i,r,e,s,n,o,a,l),i.setTransform(h,0,0,h,0,0))),c=d,u=f}}const Rr=(t,e,i)=>{let s,r,n,o,a=t.length-1;for(e.moveTo(n=Math.round(i.lon2x(t[a][0])),o=Math.round(i.lat2y(t[a][1])));a--;)s=Math.round(i.lon2x(t[a][0])),r=Math.round(i.lat2y(t[a][1])),(n-s||o-r)&&e.lineTo(n=s,o=r)},Fr="round",Dr=[];let Or,Ur=new class extends kr{constructor(t){super(),super.init(.5),this.setCharWidth(t)}setCharWidth(t){this.cw=t}init(t){return"string"!=typeof t&&(t=String(t)),this.lw=t.length*this.cw,this.label=t,!0}angle(t,e){return Math.atan(t/e)}createSymbol(t){const e=this.label,i=this.cw,s=this.lw;let r,n,o=Math.floor(t/s);return o>0&&(r=e,o>1&&(o=1+Math.floor((o-1)/8),n=new Array(Math.floor(1.5*(t-s)/i/o)).join(" "),r=e+new Array(o).join(n+e))),r}drawSymbol(t,e,i,s,r){r.stroke&&s.strokeText(t,e,i),r.fill&&s.fillText(t,e,i)}}(R({font:C}).width),Br=new kr;var Wr=(t,e,i)=>{t.globalAlpha=e.opacity==Or?1:e.opacity;const s=e.font,r=e.stroke;let n,o;if(r&&(t.strokeStyle=r,n=e.strokeWidth,s&&(i=1),n&&"number"==typeof n||(n=1),t.lineWidth=n*i),e.fill&&(t.fillStyle=e.fill),s){let i=e.font||C;Ur.setCharWidth(R(e).width),t.font=i,t.textAlign=e.textAlign||"center",t.textBaseline=e.textBaseline||"middle"}else t.lineCap=e.strokeLinecap||Fr,t.lineJoin=e.strokeLinejoin||Fr,o=e.strokeDasharray,o instanceof Array?t.setLineDash(o):t.setLineDash(Dr),(e.fill||e.stroke)&&t.beginPath();return!0},Nr=(t,e,i,s,r,n,o,a,l,h)=>{let c=i.getProvider().decCoord(i),u=i.geometry.type;const d=t.z;let f=st("type",r,i,d);if("LineString"==u){if("Circle"==f||"Rect"==f||"Image"==f){const s=st("offset",r,i,d);if(s!=Or)return Br.init(s),void Br.place(c,t,e,i,r,n,o,a,l,h);u="MultiPoint"}}else if(("Polygon"==u||"MultiPolygon"==u)&&"Polygon"!=f&&"Line"!=f){const h=i.bbox;return Ir(f,Math.round(t.lon2x(h[0]+(h[2]-h[0])/2)),Math.round(t.lat2y(h[1]+(h[3]-h[1])/2)),r,i,s,t,n,e,o,a,l)}if("Point"==u)Ir(f,Math.round(t.lon2x(c[0])),Math.round(t.lat2y(c[1])),r,i,s,t,n,e,o,a,l);else if("Text"==f){if(!Ur.init(s))return;if("MultiLineString"==u)for(var p=0;p<c.length;p++)Ur.place(c[p],t,e,i,r,n,o,a,l,h);else"LineString"==u&&Ur.place(c,t,e,i,r,n,o,a,l,h)}else if("LineString"==u)Rr(c,e,t);else if("Polygon"==u||"MultiLineString"==u)for(var g=0;g<c.length;g++)Rr(c[g],e,t);else if("MultiPolygon"==u)for(p=0;p<c.length;p++)for(g=0;g<c[p].length;g++)Rr(c[p][g],e,t);else if("MultiPoint"==u){let h=c.length;for(;h--;)Ir(f,Math.round(t.lon2x(c[h][0])),Math.round(t.lat2y(c[h][1])),r,i,s,t,n,e,o,a,l)}};let Gr;class Zr{constructor(t,e,i){this.tm=t,this.exclusiveTimeMS=i,this.dpr=e}spawn(t,e,i,s,r,n,o,a){let l=this.createTask(t,e,i,s,r,i.bounds,n,o,a);return this.tm.start(l),l}createTask(t,e,i,s,r,n,o,a,l){const h=this.dpr;let c=r.index(s),u=r.getContext(c),d=this.tm.create({priority:t,time:this.exclusiveTimeMS,init:function(){if(!l){u.setTransform(h,0,0,h,0,0);let t=s.getStyle().backgroundColor;t?(u.fillStyle=t,u.globalAlpha=1,u.fillRect(0,0,256,256)):u.clearRect(0,0,256,256)}return{tile:i,ctx:u,data:o,lI:0,gI:0,fI:0,style:Gr,dTile:r,layer:s,bI:100}},onDone:function(){r.dirty(c),a(u,this)},exec:function(t){let i,s=t.tile,r=t.data,n=r.length;if(n){for(;!(i=r[t.lI])&&t.lI<n;)++t.lI;if(i){let n=i[t.gI];if(n){let i=t.ctx,o=n.shared,a=o.font!=Gr;for(t.style!=o&&(t.style=o,Wr(i,o,r.swzs),t.pmap={});t.bI--;){let r=t.fI++;const l=n.data;let c=l.features[r];if(!c){a?i.setTransform(h,0,0,h,0,0):(o.fill&&i.fill(),o.stroke&&(o.strokeWidth||o.strokeWidth==Gr)&&i.stroke()),t.fI=0,t.gI++;break}{let n,o=l.styles[r];if(a&&(n=et(o,c,s.z),!n))continue;Nr(s,i,c,n,o,t.dTile,t.layer,t.pmap,e,h)}}}else t.fI=0,t.gI=0,t.lI++;return t.bI=100,this.CONTINUE}}}});return d}}const Hr=256;class Yr{constructor(t,e){this.dpr=1,this.debug=!1,this.rz=0,this.sx=0,this.sy=0,this.s=1;let i=a.getInstance(),s=this;s.ts=t,s.dpr=e,s.painter=new Zr(i,e,4)}drawGrid(t,e,i){let s=i+"  L"+i.length;const r=this.ctx;r.strokeRect(t,e,Hr,Hr),r.strokeText(s,t+8,e+16),r.fillText(s,t+8,e+16)}applyTransform(){const t=this,e=t.s,i=t.rz;if(t._s!=e||t._rz!=i){t._s=e,t._rz=i;const s=t.ctx,r=t.canvas,n=r.width,o=r.height,a=n/2-t.sx,l=o/2-t.sy,h=t.dpr;s.setTransform(1,0,0,1,n/2,o/2),s.rotate(i),s.translate(-n/2+a,-o/2+l),s.scale(e,e),s.translate(-a,-l),s.scale(h,h)}}init(t){let e=t.getContext("2d",{alpha:!1});e.font="bold 14px Arial",e.lineWidth=3,e.strokeStyle="red",e.fillStyle="white",e.textAlign="start",e.textBaseline="alphabetic",this.ctx=e,this.canvas=t}setBuckets(t){this.buckets=t}clear(){}convertColor(t){return t}setBackgroundColor(t){this.buckets.bgColor(t)}grid(t){this.debug=t}setScale(t,e,i){let s=this;s.s=t,s.sx=e,s.sy=i}setRotation(t,e){this.rz=t}prepare(t,e,i,s,r,n){return this.painter.spawn(3,s,e,i,r,t,n)}tile(t,e,i){const s=this;e=Math.round(e),i=Math.round(i),s.ctx.drawImage(t.combine(),e,i,Hr,Hr),s.debug&&s.drawGrid(e,i,t.quadkey)}preview(t,e,i,s){let r=t.getContext(s);r.clearRect(0,0,t.size,t.size);for(let i=0,n=e.length;i<n;i++){let n,o=e[i],a=this.buckets.get(o[0],!0);a&&(n=a.getData(s))&&(r.setTransform(1,0,0,1,0,0),r.drawImage(n,o[1],o[2],o[3],o[4],o[5],o[6],o[7],o[8]),t.dirty(s))}}destroy(){}getContext(){return this.ctx}}let Vr;class Xr extends _i{constructor(t,e,i,s,r){super(t);let n=i.length;this.c=new Array(n),this.init(e,i),this.size=s,this.ctx=t.claimCtx(s),this.canvas=this.ctx.canvas,this.ctx.fillStyle=r}destroy(t){if(t!=Vr)(e=this.c[t])&&(e.canvas&&this.pool.releaseCtx(e),this.c[t]=Vr);else{let t=this.c.length;for(var e;t--;)(e=this.c[t])&&e.canvas&&(this.pool.releaseCtx(e),this.c[t]=Vr)}}init(t,e){super.init(t,e);let i=e.length;for(this.c.length=i;i--;)this.c[i]=Vr;this._c=!1,this._ready=!1}dirty(t,e){let i=this.c[t],s=e!=i;e&&i&&s&&this.destroy(t),e||(s=!0,e=this.c[t]),s&&(this.c[t]=e,this._c=!1)}clear(t){let e;(e=this.c[t])&&(e.setTransform&&this.pool.releaseCtx(e),this.c[t]=Vr,this.preview(t,Vr),this.ready(t,!1),this._c=!1,this.combine())}getContext(t){return this.c[t]||(this.c[t]=this.pool.claimCtx(this.size)),this.c[t]}getData(t){return this.c[t]&&(this.c[t].canvas||this.c[t])}combine(){let t,e=this,i=e.size;if(!e._c){e._c=!0,e.ctx.fillRect(0,0,i,i);for(let s=0;s<e.c.length;s++)(t=this.getData(s))&&e.ctx.drawImage(t,0,0,i,i)}return e.canvas}addLayer(t){super.addLayer(t);let e=this;e.c.splice(t,0,Vr),e._c=!1,e._ready=!1}removeLayer(t){super.removeLayer(t);this.destroy(t),this.c.splice(t,1),this._c=!1}}let jr=[];const qr={length:0,max:128,clear:function(){this.length=0},create:function(t){let e=document.createElement("canvas");return e.width=e.height=t,this.length++,e.getContext("2d")},get:function(t){return jr.length?(this.length++,jr.shift()):this.create(t)},release:function(t){t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,t.canvas.width,t.canvas.height),t.lineWidth=1,t.globalAlpha=1,jr.push(t),this.length--}};class $r extends wi{constructor(t,e){super(t||256),this.ctxCache=qr,this._bgc=null,this.tSize=e}bgColor(t){this._bgc=t,this.forEach((e=>{e.ctx.fillStyle=t}))}clear(){this.tiles.clear(),qr.clear()}setSize(t){this.tiles.setSize(t)}releaseCtx(t){return qr.release(t)}claimCtx(t){if(qr.length<qr.max)return qr.get(t);{let e=this.tiles.tail.data;return e.destroy(),qr.release(e.ctx),e.ctx=null,e.canvas=null,this.tiles.remove(e.quadkey),e.cancelTasks(),this.claimCtx(t)}}create(t,e){let i=this.tiles.get(t);return i||(this.tiles.length>=this.tiles.max?(i=this.tiles.tail.data,i.destroy(),i.init(t,e),i.size=this.tSize):i=new Xr(this,t,e,this.tSize,this._bgc),this.tiles.set(t,i)),i}}const Kr=C,Qr=()=>1,Jr="*";let tn;class en{constructor(t,e){this.tm=t,this.ms=e}exclusiveRuntime(t){this.ms=t}spawn(t,e,i,s,r,n,o,a){let l=this.createTask(t,e,i,s,r,n,o);return this.tm.start(l,a),l}createTask(t,e,i,s,r,n,o){const a=[],l=this.ms,h=this.tm.create({time:l,priority:t,init:function(){if(s){let t=s.length,e=Date.now();for(;t--;)s[t];h.time=l-(Date.now()-e)}return[i,s,r,0,a,300,e,{}]},name:"cluster",onDone:function(){const t=e.getStyle(),s=t&&(t.strokeWidthZoomScale||t.LineStringZoomScale)||Qr;a.swzs=s(i.z),o(a,this)},exec:function(t){let e=t[0],i=t[1],s=t[2],r=t[6],o=i.length,a=t[4];const l=e.z;let h,c,u,d,f,p,g,m,v,x,y,_,b,w,A,S,M,T,L,z,P;if(i&&!(t[3]>=o)){for(;t[5]--&&(f=i[t[3]++]);)if(p=f.id,!s[p]&&(s[p]=!0,u=r.getStyleGroup(f,l),u)){u.length||(u=[u]);for(let t=0,e=u.length;t<e;t++)d=u[t],ut(d)&&(h=st("zIndex",d,f,l),g=st("type",d,f,l),A=st("opacity",d,f,l),_=tn,y=tn,b=tn,w=tn,T=tn,S=tn,M=tn,L=tn,z=tn,P=tn,"Image"==g?c="I":(y=st("fill",d,f,l),b=st("stroke",d,f,l),w=st("strokeWidth",d,f,l),"Line"==g?(S=st("strokeLinecap",d,f,l),M=st("strokeLinejoin",d,f,l),T=st("strokeDasharray",d,f,l),c="L"+(S||Jr)+(M||Jr)+(T||Jr)):"Text"==g?(_=st("font",d,f,l)||Kr,c="T"+(_||Jr)):"Circle"==g?(L=st("radius",d,f,l),c="C"+L||Jr):(z=st("width",d,f,l),P=st("height",d,f,l)||z,c="R"+z+P),c+=(b||Jr)+(w||Jr)+(y||Jr)),A!=tn&&(c+=100*A^0),m=a[h]=a[h]||[],x=m[c],x==tn?(x=m[c]=m.length,v=m[x]={shared:{font:_,fill:y,opacity:A,stroke:b,strokeWidth:w,strokeLinecap:S,strokeLinejoin:M,strokeDasharray:T},data:new n}):v=m[x],v.data.add(f,d))}return t[5]=300,t[3]<o}}});return h}}let sn={1:[512,3,512],2:[128,2,128],3:[64,1,128]};let rn;const nn=(t,e,i,s,r)=>{const n=Math.sin(r),o=Math.cos(r),a=t-i,l=e-s;return[o*a-n*l+i,n*a+o*l+s]};class on{constructor(){this.features=[],this.styles=[]}add(t,e){this.features.push(t),this.styles.push(e)}}class an extends Ft{constructor(t,e,i,s){e=e||256,i=0^Ft.getPixelRatio(i);const r=sn[i][1],n=new Yr(e*i,i),o=sn[i][0],l=new $r(o,e*i);n.setBuckets(l),super(t,e,i,l,n,r),this.cluster=new en(a.getInstance(),4),n.init(this.canvas)}preview(t,e,i){const s=super.preview(t,e,i);return s&&this.render.preview(t,s,e,i),s}prepareTile(t,e,i,s,r){let n=this,o=n.render;if("image"==t.type){const t=s.index(i);s.dirty(t,e),r(s,i)}else if(e.length)s.addTask(n.cluster.spawn(4,i,t,e,{},on,((e,a)=>{s.removeTask(a,i),null==s&&(s=rn),s.addTask(o.prepare(e,t,i,n,s,((t,e)=>{s.removeTask(e,i),r(s,i)})),i)})),i);else{const t=s.index(i);s.destroy(t),s.dirty(t),r(s,i)}}viewport(t){const e=this,i=e.tiles,s=e.render,r=e.layers,n=r.length,o=i.length;(this.dirty||t)&&(this.render.clear(),this.dirty=!1);for(let e of i){if(256!=e.scaledSize)continue;const i=e.tile;if(e.lrTs!==i.luTs||t){e.lrTs=i.luTs,s.tile(i,e.x,e.y);for(var a,l=0;l<n;l++)!(a=r[l]).ready&&i.ready(l)&&++a.cnt==o&&(a.ready=!0)}}}addLayer(t,e,i){t.tileSize=256;const s=super.addLayer(t,e,i);return s&&this.setupTilePool(),s}removeLayer(t){const e=super.removeLayer(t);return-1!==e&&this.setupTilePool(),e}setSize(t,e){const i=this;super.setSize(t,e),i.setupTilePool(),i.render._s=rn,i.setTransform(i.s,i.rz,i.rx)}destroy(){super.destroy(),this.buckets.clear()}setupTilePool(){let t=this;const e=(Math.ceil(t.w/256)+1)*(Math.ceil(t.h/256)+1);let i=e;const s=sn[t.dpr];let r=e*t.getLayers().length;i<s[0]&&(i=s[0]),t.buckets.setSize(i),r<s[2]&&(r=s[2]),t.buckets.ctxCache.max=r}update(t){super.update()}project(t,e){const i=this,s=i.s;return nn(t*=s,e*=s,i.w/2,i.h/2,i.rz)}unproject(t,e){let i=this,s=i.s;const r=i.w/2,n=i.h/2;let o=nn(t,e,r,n,-i.rz);return o[0]=(o[0]-r)/s+r,o[1]=(o[1]-n)/s+n,o}}an.zoomBehavior="fixed";const ln=0===navigator.platform.indexOf("Win")?.0025:.0015;class hn{constructor(t,e,i,s){this.passive=!1;try{let t=Object.defineProperty({},"passive",{get:()=>{this.passive=!0}});window.addEventListener("testPassive",null,t),window.removeEventListener("testPassive",null,t)}catch(t){}this.el=t,this.settings=i,this.map=e,this.ams=0^s,this.onSpin=this.onSpin.bind(this)}onSpin(t){const{settings:e,el:i,map:s}=this,r=e.zoom;if(r){let e=-(t=t||n.event).deltaY;if(t.deltaMode===t.DOM_DELTA_LINE&&(e*=32.001953125),e){const n=s.getZoomlevel();let o,a;"fixed"==r?t.shiftKey?o=n+(e>0?.1:-.1):(o=Math.round(n+(e<0?-1:1)),a=!0):o=n+e*ln;let l=i.getBoundingClientRect();this.zoom(o,t.pageX-l.left,t.pageY-l.top,a)}}t.preventDefault&&t.preventDefault(),t.returnValue=!1}enable(){A(this.el,["wheel","DOMMouseScroll"],this.onSpin)}disable(){S(this.el,["wheel","DOMMouseScroll"],this.onSpin)}zoom(t,e,i,s){const{map:r,ams:n}=this;r.setZoomlevel(t,e,i,s&&n)}}const cn=t=>t,un=t=>Math.sin(Math.PI*t*.5);var dn=Object.freeze({__proto__:null,easeOut:t=>1-Math.pow(1-t,1.5),easeOutCubic:t=>1-(t=1-t)*t*t,easeOutSine:un,linear:cn});class fn{constructor(t,e,i,s,r){this.ts=0,this.af=null,this.from="number"==typeof t?[t]:t,this.to="number"==typeof e?[e]:e,this.duration=i,"function"==typeof s&&(r=s,s="linear"),this.easing=dn[s]||cn,this.animator=r,this.animate=this.animate.bind(this)}animate(){const{duration:t}=this,e=Math.min(Date.now()-this.ts,t);let i=this.from.map(((i,s)=>{const r=this.to[s];return i+this.easing(e/t)*(r-i)}));this.animator(1==i.length?i[0]:i),e<t?this.af=requestAnimationFrame(this.animate):(this.af=null,this.done())}async start(){return new Promise((t=>{this.done=t,this.ts?t():(this.ts=Date.now(),this.animate())}))}stop(){null!=this.af&&(cancelAnimationFrame(this.af),this.af=null)}}const pn=(t,e)=>{let i,s,r=t.targetTouches;if(r){let t,n=r.length,o=r[n-1];if(n){let a=e.getBoundingClientRect(),l=o.pageX-a.left,h=o.pageY-a.top;n>1?(t=r[n-2],i=(l+t.pageX-a.left)/2,s=(h+t.pageY-a.top)/2):(i=l,s=h)}}else i=t.clientX,s=t.clientY;return[0^i,0^s]},gn=t=>{const e=t.targetTouches,i=e.length,s=e[i-2];if(s){const t=e[i-1],r=s.clientX-t.clientX,n=s.clientY-t.clientY;return 180*Math.atan2(n,r)/Math.PI}};class mn{constructor(t,e,i,s,r){this.scrollHandler=new hn(t,e,s,r.zoomAnimationMs);let o,a,l,h,c,u,d,f=this,p=null,g=Date.now();const m=[],v=[],x=(t,e,i)=>{const s=r[t];return Math.abs(e-o)>s||Math.abs(i-a)>s},y=()=>{d=0,m.length=0,v.length=0};function _(t){let e=1;if(null!=t.scale)return t.scale;let i=t.targetTouches,s=i.length,r=i[s-1],n=i[s-2];if(n){let t=W(r.clientX,r.clientY,n.clientX,n.clientY);null==p&&(p=t),e=t/p}return e}function b(t,r){if(!c){if(!x("minPanMapThreshold",t,r))return!0;i.cancel()}if(u=Date.now(),s.drag&&!e.lockViewport().pan){let i=t-l,s=r-h;d<8?(m[d]=i,v[d]=s,d++):d=0,e.pan(i,s),c=!0}l=t,h=r}function w(t){if(c){let t=Date.now();t-u<25&&i.pan(t,3*m.reduce(((t,e)=>t+e),0),3*v.reduce(((t,e)=>t+e),0))}}let M,T,L,z,P,C,I,E,k,R=null;function F(i){y();let s=i.targetTouches,r=s.length,n=pn(i,t);if(l=n[0],h=n[1],o=l,a=h,_(i),c=!1,2==r){k=0;let t=s[r-1],n=s[r-2];P=t.clientX,C=t.clientY,I=n.clientX,E=n.clientY,p=W(P,C,I,E),z=e.getZoomlevel(),M=e.rotate(),T=e.pitch(),L=gn(i)}}function D(i){let r=i.targetTouches,n=r.length,o=pn(i,t),a=_(i);if(n>1){if(s.pitch){if(++k<5)return void i.preventDefault();const t=r[n-1],s=r[n-2],o=C-t.clientY,a=E-s.clientY;if(R||0!=R&&Math.abs(s.clientY-t.clientY)<110&&Math.sign(o)==Math.sign(a))return R=!0,e.pitch(T+.2*o),void i.preventDefault();R=!1}s.zoom&&f.scrollHandler.zoom(z+Math.log2(a),o[0],o[1],!1),s.rotate&&e.rotate(M+gn(i)-L)}b(o[0],o[1]),l=o[0],h=o[1],i.preventDefault()}function O(e){let i=pn(e,t),s=e.targetTouches.length;R=null,i&&(l=i[0],h=i[1],o=l,a=h),s<2&&(p=null);let r=Date.now(),n=r-g;s&&(g=r),_(e),0==s&&1==e.changedTouches.length&&n>350&&w()}let U=null;function B(i){U=i.button,y(),c=!1,A(t,"mousemove",N),M=e.rotate(),T=e.pitch(),l=i.clientX,h=i.clientY,o=l,a=h}function N(t){var i;null===(i=f.resetAnimation)||void 0===i||i.stop();const r=t.clientX,n=t.clientY;0==U?b(r,n):2==U&&(s.rotate&&x("minRotateMapThreshold",r,n)&&e.rotate(M+.25*(l-r)),s.pitch&&x("minPanMapThreshold",r,n)&&e.pitch(T+.1*(h-n)))}function G(i){if(U=null,S(t,"mousemove",N),c)w();else if(s.rotate){const t=e.rotate();M!=t&&Math.abs(t)<=5&&(f.resetAnimation=new fn(t,0,500,"easeOutSine",(t=>e.rotate(t))),f.resetAnimation.start())}}f.scroll=t=>{let{scrollHandler:e}=this;t?e.enable():e.disable()},f.drag=e=>{const i=e?A:S;setTimeout((()=>{i(t,"touchstart",F),i(n,"touchend",O),i(t,"touchmove",D),i(t,"mousedown",B),i(n,"mouseup",G)}),0)},f.getOptions=()=>s}}class vn{constructor(t,e,i,s,r){this.type=t,this.timeStamp=Date.now(),null!=e&&(this.data=this.detail=e),i&&(this.mapX=s,this.mapY=r,this.nativeEvent=i,this.button=i.button)}stopPropagation(){const t=this.nativeEvent;if("mousemove"==t.type||"touchmove"==t.type)return t.stopImmediatePropagation(),t.preventDefault()}toString(){return"MapEvent "+this.type}}const xn="pointerup",yn="pointerenter",_n="pointerleave",bn="pointerdown",wn="pointermove",An="pressmove",Sn="dbltap",Mn=[xn,yn,_n,bn,wn,An,"tap",Sn];function Tn(t){return-1!==Mn.indexOf(t)}function Ln(t,e){let i=e.type;"touchstart"!=i&&"touchmove"!=i&&"touchend"!=i||(e=e.changedTouches[e.changedTouches.length-1]);let s=t.getBoundingClientRect();return[e.pageX-s.left,e.pageY-s.top]}class zn extends c{constructor(t){super(),this.interval=50,this.findTarget=t,this._active=!1}isActive(){return this._active}setPointerEvent(t){this.ev=t}exec(){this.findTarget(this.ev),this._active=!1,this.ev=null}start(){this._active=!0,setTimeout((()=>super.start()),this.interval)}}class Pn{constructor(t,e,i,s){this.disabled={},this.hActive=!1,this.cnt=0,this.el=t,this.cbs=new h(["click"]);const{disabled:r}=this;let n,o,a,l,c,u=!1,d=!1,f=0,p=this.cbs;p.sync(!0),Mn.forEach((t=>{p.addEvent(t),r[t]=!1}));const g=new zn((function(e){let i=Ln(t,e),s=x(i);v(wn,e,i,s),s?c?c.feature.id!==s.feature.id&&(v(_n,e,i,c),v(yn,e,i,s)):v(yn,e,i,s):c&&v(_n,e,i,c);c=s}));function m(t,i,s,r,n){let o=new vn(t,n,i,s,r);return n&&(o.target=n.feature,o.detail.display=e),o}function v(t,e,i,s){p.trigger(t,[m(t,e,i[0],i[1],s)],!1)}function x(t){return e.getFeatureAt({x:t[0],y:t[1]},{layers:e._layers.filter((t=>t.pointerEvents()))})}let y=!1;this.onPointerDown=function(i){const s="touchstart"==i.type;s||!y?(a=e.getCenter(),d=!0,u=!1,n=Ln(t,i),o=x(n),v(bn,i,n,o),s&&i.target.parentNode==t&&(y=!0)):y=!1},this.onPointerMove=function(e){const i="mousemove"==e.type;if(i&&y)return;let a,l,h;if(d){let i=s.minPanMapThreshold;if(!u&&(a=Ln(t,e),l=a[0]-n[0],h=a[1]-n[1],Math.abs(l)<i&&Math.abs(h)<i))return}var c;u=!0,d?o&&p.isListened(An)&&(a=Ln(t,e),l=a[0]-n[0],h=a[1]-n[1],p.trigger(An,[m(An,e,a[0],a[1],o),l,h],!1)):i&&(p.isListened(yn)||p.isListened(_n)||p.isListened(wn))&&(c=e,g.setPointerEvent(c),g.isActive()||r.pointerenter||r.pointerleave||g.start())},this.onPointerUp=function(i){if(d){let s=e.getCenter();if(!(a.longitude!=s.longitude||a.latitude!=s.latitude)&&i.target.parentNode==t&&(o||!u)){let e=Ln(t,i);v("tap",i,e,o),v(xn,i,e,o),function(t){let e=Date.now(),i=o&&o.feature;e-f<250&&!u&&l==i&&v(Sn,t,n,o),l=i,f=e}(i)}d=u=!1}}}getGlobalHandlers(){const{onPointerDown:t,onPointerMove:e,onPointerUp:i}=this;return{touchstart:t,touchmove:e,touchend:i,mousedown:t,mouseup:i,mousemove:e}}enable(t){Tn(t)&&delete this.disabled[t]}disable(t){Tn(t)&&(this.disabled[t]=!0)}destroy(){let t=this.getGlobalHandlers();if(this.hActive){for(let e in t)S(this.el,e,t[e]);this.hActive=!1}}addEventListener(t,e,i){if(Tn(t)&&this.cbs.add(t,e,i)){this.cnt++;let t,e=this.getGlobalHandlers();if(!this.hActive)for(let i in e){t=e[i];let{el:s}=this;if("mouseup"==i)for(;s.parentNode;)s=s.parentNode;A(s,i,t),this.hActive=!0}}}removeEventListener(t,e,i){const{cbs:s,el:r}=this;if(Tn(t)&&s.remove(t,e,i)&&! --this.cnt&&this.hActive){let t=this.getGlobalHandlers();for(let e in t)s.isListened(e)||S(r,e,t[e]);this.hActive=!1}}}const Cn=(t,e,i)=>{let s=!1;for(let r=0,n=i.length-1;r<i.length;n=r++){const o=i[r][0],a=i[r][1],l=i[n][0],h=i[n][1];a>e!=h>e&&t<(l-o)*(e-a)/(h-a)+o&&(s=!s)}return s};class In{constructor(t,e){this.map=t,this.dpr=e}pointToLineDistanceSq(t,e,i,s,r,n){const o=r-i,a=n-s,l=o*o+a*a;let h,c,u,d,f=-1;if(0!=l){h=t-i,c=e-s;f=(h*o+c*a)/l}f<0?(u=i,d=s):f>1?(u=r,d=n):(u=i+f*o,d=s+f*a);const p=t-u,g=e-d;return this.sideOfLine=o*c-h*a<0?-1:1,p*p+g*g}pointInPolygon(t,e,i){for(let s=0;s<i.length;s++)if(Cn(t,e,i[s])!=!s)return!1;return!0}pointInBox(t,e,i,s,r){for(let[n,o]of t){if(n>=e&&n<=i&&o>=s&&o<=r)return!0}}linesIntersectBox(t,e,i,s,r){const n=[[e,r],[i,r],[i,s],[e,s],[e,r]];for(let e=0,i=t.length-1;e<i;e++)for(let i=0;i<n.length-1;i++)if(N(t[e],t[e+1],n[i],n[i+1],!1))return!0}getOffsetLineData(t,e,i){let s=[];for(let r of e){const e=st("offset",r,t,i)||0;e&&s.find((t=>t.offset==e))||s.push({offset:e,width:.5*nt("strokeWidth",r,t,i,!0)})}return s.length,s}geometry(t,e,i,s,r,n,o,a,l,h){let c=!1;const{dpr:u,map:d}=this,f=!t&&!e;let p=this.screenX,g=this.screenY,m=1;if("Point"==s){if(l=l||ct(r,o,a,u,n,h)){let s=i[0],n=i[1];const h=st("alignment",r[0],o,a);if(h&&"viewport"!=h)[s,n]=d._g2w(s,n),p=this.worldX,g=this.worldY,m=1/d._s;else{const t=d.geoToPixel(s,n);s=t.x,n=t.y}const u=s+l[0]*m,f=n+l[1]*m,v=s+l[2]*m,x=n+l[3]*m;c=B(p,p+t,g,g+e,u,v,f,x)}}else if("LineString"==s){l=l||lt(r,o,a,n,h);let t=i.length,[e]=l;if(e)if(f){let e,s,n,h=d.geoToPixel(i[0][0],i[0][1]),u=this.getOffsetLineData(o,r,a);u.length||(e=Math.pow(.5*l[0],2));for(let r=1;r<t;r++){if(s=d.geoToPixel(i[r][0],i[r][1]),n=this.pointToLineDistanceSq(p,g,h.x,h.y,s.x,s.y),u.length){for(let t of u){const{offset:e,width:i}=t,s=Math.pow(e-this.sideOfLine*i,2);if(e){if(n>s){if(c=n-Math.pow(e+this.sideOfLine*i,2)<=i*i)break}}else if(c=n<=i*i)break}if(c)break}else if(c=n<=e)break;h=s}}else{const t=.5*l[0],e=d.pixelToGeo(p-t,g-t),s=d.pixelToGeo(p+t,g+t),r=e.longitude,n=s.longitude,o=s.latitude,a=e.latitude;if(c=this.pointInBox(i,r,n,o,a)||this.linesIntersectBox(i,r,n,o,a),!c)return!1}}else if("Polygon"==s){let s,u=!1;if(!r.find((t=>{const e=st("type",t,o,a),i="Line"==e,r="Polygon"==e;return u||(u=i),s||(s=!(i&&r)&&t),r}))){if(u){const s=this.geometry(t,e,i,"MultiLineString",r,n,o,a,null,h);if(s)return s}return s&&this.geometry(t,e,xt(s,o,a),"Point",r,n,o,a,null,h)}if(f){const{longitude:t,latitude:e}=d.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i),!c)return!1}else{const e=d.pixelToGeo(p-t,g-t),s=d.pixelToGeo(p+t,g+t),r=e.longitude,n=s.longitude,o=s.latitude,a=e.latitude;for(let t=0;t<i.length&&(c=this.pointInBox(i[t],r,n,o,a),!c);t++);if(!c){const{longitude:t,latitude:e}=d.pixelToGeo(p,g);if(c=this.pointInPolygon(t,e,i)||this.linesIntersectBox(i[0],r,n,o,a),!c)return!1}}l=l||[at(r,o,a,n)]}else{let d,f;if("MultiPolygon"==s?(d="Polygon",l=l||[at(r,o,a,n)]):"MultiPoint"==s?(d="Point",l=l||ct(r,o,a,u,n)):"MultiLineString"==s&&(d="LineString",l=l||lt(r,o,a,n)),d)for(let s=0,u=i.length;s<u;s++)if(f=this.geometry(t,e,i[s],d,r,n,o,a,l,h),f){c=!0;break}}return c&&l}init(t,e){this.screenX=t,this.screenY=e,[this.worldX,this.worldY]=this.map._unprj(t,e)}feature(t,e,i,s,r,n,o){return this.geometry(t,e,i.geometry.coordinates,i.geometry.type,s,r,i,n,null,o)}}const En=Array.from({length:33},((t,e)=>32*Math.pow(2,Math.max(0,e-20+3)))),kn=t=>"number"==typeof t;class Rn{constructor(t,e,i){this.map=t,this.layers=e,this.hit=new In(t,i)}getFeaturesInRect(t,e,i,s,r,n){var o;const{map:a,hit:l}=this,h=a.getZoomlevel(),c=En[Math.ceil(h)],u=0^Math.min(20,h),d={},f=(i-t)/2,p=(s-e)/2;let g=t+f,m=e+p,v=180,x=-180,y=180,_=-180;[t,e]=a._unprj(t,e),[i,s]=a._unprj(i,s);let b,w,A,S,M,T,L,z,P=[a._w2g(t-c,e-c),a._w2g(i+c,e-c),a._w2g(i+c,s+c),a._w2g(t-c,s+c)],C=4,I=[];for(;C--;){let t=P[C][0],e=P[C][1];t<v&&(v=t),t>x&&(x=t),e<y&&(y=e),e>_&&(_=e)}b=[v,y,x,_],r&&!Array.isArray(r)&&(r=[]),l.init(g,m);let E=r.length;for(;E--;){A=r[E],w=null===(o=A.getProvider)||void 0===o?void 0:o.call(A,h);const t=this.layers.get(A);if((null==w?void 0:w.search)&&A.isVisible(h))for(M=w.search(b),T=M.length;T--;)if(S=M[T],(L=t.processStyleGroup(S,u))&&(z=l.feature(f,p,S,L,E,h,n))){let t=z[z.length-1],e=d[t]=d[t]||[];(e[E]=e[E]||[]).push(S)}}const k={layer:null,features:null};for(let t of Object.keys(d).sort(((t,e)=>Number(t)-Number(e)))){let e=d[t];for(let t,i=0;i<e.length;i++)if(t=e[i]){const e=r[i];k.layer==e?k.features=k.features.concat(t):I.push({layer:e,features:t})}}return I}search(t,e,i,s,r,n){const{map:o}=this,a=o._layers;if(r=r?r.slice().sort(((t,e)=>Number(a.indexOf(t)>a.indexOf(e)))):a,kn(t)&&kn(e)&&kn(i)&&kn(s))return this.getFeaturesInRect(t,e,i,s,r,n)}}const Fn=n.setTimeout,Dn=n.setInterval,On="mapviewchange",Un=On+"start",Bn=On+"end",Wn=1e3/30;let Nn=1e3/60;const Gn=!0,Zn=(t,e,i)=>{let s;return"function"==typeof Event?s=new Event(t):(s=document.createEvent("Event"),s.initEvent(t,!0,!0)),s.detail=s.data={map:e,layer:i},s};class Hn{constructor(t,e,i){this.watchTimer=null,this.map=t,this.trigger=e,this.renderInfo=i,Nn=n.__XYZTST_MVCEDelayMs||Nn,this.changeWatcher=this.changeWatcher.bind(this),this.readyWatcher=this.readyWatcher.bind(this)}centerChanged(t){return this.center.longitude!=t.longitude||this.center.latitude!=t.latitude}vpChanged(t,e,i){const{viewport:s,rz:r,rx:n}=this;return!(s.minLon!=t.minLon||s.maxLon!=t.maxLon||s.minLat!=t.minLat||s.maxLat!=t.maxLat||r!=e||n!=i)}changeWatcher(){const{map:t,readyTimer:e,watchTimer:i,viewport:s,center:r}=this;let n=t.getViewBounds(),o=t.getCenter(),a=t.rotate(),l=t.pitch(),h=On,c={changed:{center:!0}};if(s){if(c.changed.center=this.centerChanged(o),this.vpChanged(n,a,l))return clearInterval(i),this.watchTimer=this.viewport=this.rz=this.rx=null,e&&clearTimeout(e),this.readyTimer=Fn(this.readyWatcher,Nn);this.viewport=n,this.rz=a,this.rx=l,this.center=o}else this.triggeredLayers={},h=Un,this.viewport=n,this.rz=a,this.center=o,this.endTriggered=!0;this.trigger(h,c,Gn)}readyWatcher(){const{map:t,triggeredLayers:e}=this;let i,s,r,n=this.renderInfo.getLayers(),o=!0;if(this.endTriggered){this.endTriggered=!1;const e=t.getCenter();this.trigger(Bn,{changed:{center:this.centerChanged(e)}},Gn)}for(let a=0;a<n.length;a++)if(s=n[a],i=s.layer,r=i.id,s.ready){if(!e[r]&&(e[r]=!0,!s.error)){let e=Zn("viewportReady",t,i);i._l.trigger("viewportReady",e,!0)}}else o=!1;o||(this.readyTimer=Fn(this.readyWatcher,Nn))}watch(t){const{readyTimer:e,watchTimer:i}=this;e&&(clearTimeout(e),this.readyTimer=null),t?i||(this.watchTimer=Dn(this.changeWatcher,Wn)):i&&(clearInterval(i),this.watchTimer=null)}}let Yn;class Vn{constructor(t,e,i,s){this._v=!0;let r=this;r.map=i,r.cPrefix=t.className+"-ui-",r.parent=t,r.opt=e,e.visible&&(r.create(t,e),r.enable())}show(){const t=this;t.html||t.create(t.parent,t.opt),t.html.style.display="inline"}hide(){const t=this.html;t&&(t.style.display="none")}enable(){this.active=!0,this.toggleListeners(!0)}disable(){this.active=!1,this.toggleListeners(!1)}destroy(){const t=this;t.disable(),t.parent.removeChild(t.html)}toggleListeners(t){const e=this,{listeners:i}=e;for(let s in i){const r=e.querySelectorAll(s);for(let n in i[s])r.forEach((r=>{const o=i[s][n];t?r.addEventListener(n,i[s][n]._=o.bind(e)):r.removeEventListener(n,o._)}))}}insertRule(t,e){Yn=Yn||function(){let t=document.createElement("style");return document.head.appendChild(t),t}();let i=Yn.sheet;i.insertRule?i.insertRule(t+" {"+e+"}",i.cssRules.length):i.addRule&&i.addRule(t,e)}create(t,e){let i=this.templ.replace(/class\=\"/g,'class="'+this.cPrefix);i=i.replace(/\>[\s]+\</g,"><");let s=(r=i,(new DOMParser).parseFromString(r,"text/html").body.childNodes[0]);var r;let n=s.style,o=e.position,a="."+t.className+" ";for(let t in o)n[t]=o[t];if(this.style)for(let t in this.style)this.insertRule(a+this.prefixClass(t),this.style[t]);this.html=t.appendChild(s)}prefixClass(t){return t=t.replace(/\./g,"."+this.cPrefix)}querySelector(t){return this.html.querySelector(this.prefixClass(t))}querySelectorAll(t){return this.html.querySelectorAll(this.prefixClass(t))}}class Xn extends Vn{constructor(t,e,i,s){super(t,e,i),this.maxPitch=s.maxPitch}enable(){super.enable();const t=this.querySelector(".needle"),e=this.map;e.addEventListener("mapviewchange",this._rl=i=>{t.style.transform=`rotate(${e.rotate()}deg) rotateX(${Math.min(60,e.pitch())}deg) scale(0.7,1.1)`}),this._rl()}disable(){super.disable(),this.map.removeEventListener("mapviewchange",this._rl),this.a&&(this.a.stop(),this.a=null)}}Xn.prototype.listeners={".btn":{click:async function(t){if(!this.aip){const{map:t}=this,e=(t.rotate()+360)%360,i=t.pitch();let s=e<180?0:360,r=0;e||i||(r=this.maxPitch,s=0),this.a=new fn([e,i],[s,r],500,"easeOutCubic",(e=>{t.rotate(e[0]),t.pitch(e[1])})),await this.a.start(),this.a=null}}}},Xn.prototype.style={".compass":"        position: absolute;        right:  10px;        bottom: 96px;        text-align: center;        font-family: sans-serif;        color: white;        height: 28px;        background-color: #0f1621;        user-select: none;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;        overflow: hidden;",".compass .needle":"        padding: 4px 0px;        line-height: 10px;",".compass .btn":"        width: 100%;        height: 100%;",".compass:hover":"        background-color: #383c45;        cursor: pointer;"},Xn.prototype.templ='<div class="compass">        <div class="btn">            <div class="needle">&#9650;<br>&#9661;</div>        </div>    </div>';class jn extends Vn{constructor(t,e,i,s){super(t,e,i),this.ams=250;let r=this;s&&s.zoomAnimationMs&&(r.ams=s.zoomAnimationMs)}enable(){super.enable();let t=this.querySelector(".info"),e=this.map;t.innerText=e.getZoomlevel(),e.addEventListener("mapviewchangeend",this._zll=function(i){t.innerText=Math.round(10*e.getZoomlevel())/10})}disable(){super.disable(),this.map.removeEventListener("mapviewchangeend",this._zll)}}jn.prototype.listeners={".zoomBtn":{click:function(t){let e=0^t.srcElement.getAttribute("dir");this.map.setZoomlevel(this.map.getZoomlevel()+e,this.ams)}}},jn.prototype.style={".zoomctrl":"        position: absolute;        right:  10px;        bottom: 20px;        text-align: center;        font-family: sans-serif;        color: white;        user-select: none;",".zoomctrl div":"        background-color: #0f1621;        border-radius: 4px;        font-size: 12px;        width: 28px;        margin: 2px;",".zoomctrl .zoomBtn":"        height: 28px;        font-size: 32px;        /* border: 1px solid white; */        line-height: 22px;        font-weight: 200;",".zoomctrl .zoomBtn:hover":"        background-color: #383c45;        cursor: pointer;"},jn.prototype.templ='<div class="zoomctrl">         <div class="zoomBtn" dir="1">+</div>         <div class="info">L</div>        <div class="zoomBtn" dir="-1">-</div>     </div>';class qn extends Vn{constructor(t,e,i){super(t,e,i)}add(t){((t,e,i,s)=>{const r=document.createElement(t);e&&(r.className=e),i&&(r.innerText=i),s&&s.appendChild(r)})("div",this.prefixClass(".src").substr(1),"Â© "+t.label,this.html)}setData(t){const e=this;if(e.data=t,e.html){e.html.innerText="";for(let i of t)e.add(i)}}}qn.prototype.style={".copyright-popup":"        user-select: none;        background-color: rgba(0,0,0,0.1);        position: absolute;        bottom: 15px;        padding: 2px;        right: 120px;        z-index: 1;        width:  auto;        color: #fff;        font-family: arial;        font-size: 11px;        opacity: 0.8;        height: auto;",".src":"        opacity: 0.8;        margin: 4px;    "},qn.prototype.templ='<div class="copyright-popup"></div>';const $n=n.document,Kn=!0,Qn=!1,Jn="addLayer removeLayer",to="zoomlevel",eo=(t,e)=>{let i,s,r,n=t.scopes,o=n.length;if(!o)return Kn;for(;i=n[--o];){const t=i.layer.getProvider(e),n=t&&t.level||e;if(s=i.minLevel||-1/0,r=i.maxLevel||1/0,n>=s&&n<=r)return Kn}return Qn},io=(t,e)=>{t.style.display=e?"inline":"none"};const so={defaultOwner:"XYZ",termsAndConditions:{label:"Terms and Conditions",url:!1}};class ro extends Vn{constructor(t,e,i){super(t,u.extend(!0,u.clone(so),e),i),this.sources=new d,this.sLen=0,this.srcWidth=0;const s=this,{termsAndConditions:r,defaultOwner:n}=s.opt;s.$src=s.querySelector(".sources"),s.$cDefault=s.querySelector(".cDefault"),s.$btn=s.querySelector(".btn"),this.details=new qn(t,{visible:!1},i),this.setDefaultOwner(n),this.setTermsAndConditions(r)}setTermsAndConditions(t){const{url:e,label:i}=t,s=this.querySelector(".terms");e?(s.lastChild.href=e,i&&(s.lastChild.innerText=i)):io(s,Qn)}setDefaultOwner(t){"string"==typeof t&&this.setOwnerLabel(this.$cDefault,t)}enable(){let t=this;super.enable(),t.map.addObserver(to,t.onZoomChange=(e,i,s)=>{if(Math.abs((0^i)-(0^s))){t.sources.forEach((t=>{io(t.el,eo(t,i))})),t.showDetails(!1),t.handleOverflow()}}),t.map.addEventListener(Jn,t.onLayerChange=e=>{let i=e.detail.layer;i.getAttribution((s=>{t.active&&("addLayer"==e.type?s.forEach((e=>t.addSource(e,i))):s.forEach((e=>t.removeSource(e,i))))}))}),t.map.addEventListener("resize",t.onResize=()=>t.handleOverflow())}disable(){let t=this;super.disable(),t.map.removeObserver(to,t.onZoomChange),t.map.removeEventListener(Jn,t.onLayerChange),t.map.removeEventListener("resize",t.onResize)}getSourceLabelsString(){const t=0^this.map.getZoomlevel();let e="";for(let i of this.sources.values())eo(i,t)&&(e+=`${this.formatLabel(i.label)} `);return e}getColors(){return{color:window.getComputedStyle(this.$cDefault).getPropertyValue("color"),backgroundColor:window.getComputedStyle(this.html).getPropertyValue("background-color")}}calcWidth(){const t=0^this.map.getZoomlevel(),e=this.sources;let i=0;return e.forEach((e=>{i+=eo(e,t)&&e.width})),i}handleOverflow(){const t=this,e=t.$btn,i=t.map.getWidth(),s=t.calcWidth(),r=i-132^0;t.$src.style.width=(r<s?r-10:s)+"px",s>Math.min(r,384)?io(e,Kn):(io(e,Qn),t.showDetails(!1))}showDetails(t){const e=this,i=e.details,s=e.map.getZoomlevel();e.$btn.innerText=t?"-":"+",t?(i.show(),i.setData(e.sources.values().filter((t=>eo(t,s))))):i.hide()}formatLabel(t){return t.startsWith("Â©")?t:"Â© "+t}setOwnerLabel(t,e,i,s){e=this.formatLabel(e),s?t.innerHTML=`<a href='${s}' target='_blank' rel='noopener noreferrer'>${e}</a>`:t.innerText=e,i&&(t.setAttribute("title",i),t.setAttribute("aria-label",i))}addSource(t,e){const i=this,s=i.sources,r=t.label,n=t.scopes,o=0^i.map.getZoomlevel();let a,l=s.get(r);l?(a=l.el,l.cnt++):(a=$n.createElement("span"),a.className=this.prefixClass(".source").substr(1),i.setOwnerLabel(a,r,t.alt,t.url),i.$src.appendChild(a),l={label:r,scopes:[],el:a,cnt:1,width:a.getBoundingClientRect().width},s.set(r,l),i.sLen++,i.srcWidth+=l.width),null!=n&&n.forEach((t=>l.scopes.push({minLevel:t.minLevel,maxLevel:t.maxLevel,layer:e}))),io(i.$cDefault,Qn),io(a,eo(l,o)),i.handleOverflow()}removeSource(t,e){const i=this,s=t.label,r=i.sources.get(s);let n,o;if(r){if(o=r.scopes,n=t.scopes)for(let t,i=0;i<n.length;i++){t=n[i];for(let s,r=0;i<o.length;r++)if(s=o[r],s.layer==e&&s.minLevel==t.minLevel&&s.maxLevel==t.maxLevel){o.splice(r,1);break}}--r.cnt||(i.$src.removeChild(r.el),i.sources.delete(s),i.handleOverflow(),--i.sLen||io(i.$cDefault,Kn))}}}ro.prototype.listeners={".btn":{click:function(t){const e="+"==this.$btn.innerText;this.showDetails(e)}}},ro.prototype.style={".copyright *":"        color: rgba(255,255,255,.8);        font-family: arial;        text-decoration: none;",".copyright":"        right: 0px;        bottom: 0px;        padding: 1px 4px;        margin: 0px;        background-color: rgba(0,0,0,.1);        position: absolute;        font-size: 11px;        line-height: 13px;        overflow: hidden;        white-space: nowrap;        user-select: none;",".sources":"        width:auto;        max-width: 384px;        float: left;        white-space: nowrap;        overflow: hidden;        text-overflow: ellipsis;        border-right: 2px;",".copyright .btn":"        display: none;        font-family: sans-serif;        font-weight: bold;        text-align: center;        height: 12px;        width: 12px;        float: left;        padding: 0px;        line-height: 9px;        margin: 1px 2px 0px;        background-color: inherit;        box-sizing: border-box;        border-radius: 3px;        border: 1px solid;",".terms, .cDefault, .source":"        white-space: nowrap;        padding-right: 4px;"},ro.prototype.templ='<div class="copyright">        <span style="float: left; white-space: nowrap;">            <span class="sources"></span>            <span class="cDefault"></span>         </span>        <span class="tac" style="float: right; white-space: nowrap;">            <span class="btn">+</span>            <span class="terms" style="white-space: nowrap;">|            <a target="_blank" style="white-space: nowrap;" href="">Terms and Conditions</a></span>        </span>    </div>';class no extends Vn{constructor(t,e,i){super(t,e,i);const{url:s}=e;s&&this.setSrc(s)}setSrc(t){this.html.style.backgroundImage=`url(${t})`}getImage(){const t=window.getComputedStyle(this.html),e=Math.round(parseFloat(t.getPropertyValue("width"))),i=Math.round(parseFloat(t.getPropertyValue("height")));return new Promise((s=>{const r=new Image;r.onload=()=>s({img:r,width:e,height:i}),r.src=t.getPropertyValue("background-image").slice(5,-2)}))}}no.prototype.style={".logo":"        position: absolute;        bottom: 6px;        left: 6px;        z-index: 1;        margin:  0px;        background-image: url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB3aWR0aD0iMjdweCIgaGVpZ2h0PSIzMnB4IiB2aWV3Qm94PSIwIDAgMjcgMzIiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+CiAgICA8IS0tIEdlbmVyYXRvcjogU2tldGNoIDUyLjYgKDY3NDkxKSAtIGh0dHA6Ly93d3cuYm9oZW1pYW5jb2RpbmcuY29tL3NrZXRjaCAtLT4KICAgIDx0aXRsZT5Hcm91cCAzPC90aXRsZT4KICAgIDxkZXNjPkNyZWF0ZWQgd2l0aCBTa2V0Y2guPC9kZXNjPgogICAgPGcgaWQ9IlBhZ2UtMSIgc3Ryb2tlPSJub25lIiBzdHJva2Utd2lkdGg9IjEiIGZpbGw9Im5vbmUiIGZpbGwtcnVsZT0iZXZlbm9kZCI+CiAgICAgICAgPGcgaWQ9Ikdyb3VwLTMiPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzA0QjZDOCIgcG9pbnRzPSItNy44NjQyMTYxOWUtMTQgOSAxMyAxNS45Njg4NjgxIDEzIDMyIDAgMjQuNDc4MDIyNiI+PC9wb2x5Z29uPgogICAgICAgICAgICA8cG9seWdvbiBpZD0iUGF0aCIgZmlsbD0iIzBBNTdENCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMjAuNTAwMDAwLCAyMC41MDAwMDApIHNjYWxlKC0xLCAxKSB0cmFuc2xhdGUoLTIwLjUwMDAwMCwgLTIwLjUwMDAwMCkgIiBwb2ludHM9IjE0IDkgMjcgMTUuOTY4ODY4MSAyNyAzMiAxNCAyNC40NzgwMjI2Ij48L3BvbHlnb24+CiAgICAgICAgICAgIDxwb2x5Z29uIGlkPSJQYXRoLTIiIGZpbGw9IiMwQTk0REUiIHBvaW50cz0iMCA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMCAyNyA3Ljc5MTIyNDMxIDEzLjU1MDIxNTEgMTUiPjwvcG9seWdvbj4KICAgICAgICA8L2c+CiAgICA8L2c+Cjwvc3ZnPg==);        background-repeat: no-repeat;        background-size: contain;        width: 32px;        height: 32px;        cursor: pointer;"},no.prototype.templ='<div class="logo"></div>';const oo={Compass:Xn,ZoomControl:jn,Copyright:ro,Logo:no};let ao;class lo{constructor(t,e,i){const s=Object.assign({},e.UI||e.ui||{}),r=this.components={};this.el=t,s.HERE!=ao&&(s.Logo=s.HERE);for(let n in oo){let o=s[n];!1!==o&&("object"!=typeof o&&(o={}),o.visible==ao&&(o.visible=!0),o.visible&&(r[n]=new oo[n](t,o,i,e)))}}static initComponentOptions(){}get(t){return this.components[t]}destroy(){const{components:t}=this;for(let e in t)t[e].destroy(),delete t[e]}}const{isFunction:ho}=u;class co{constructor(t={}){this.animation=null;let e=this;this.easing=t.easing,ho(t.onStart)&&(e.onStart=t.onStart),ho(t.onStop)&&(e.onStop=t.onStop)}onStart(){}onStop(){}async animate(t,e,i,s){const r=this;r.active||(r.active=!0,r.onStart(),r.animation=new fn(t,e,i,this.easing,s),await r.animation.start(),r.onStop(),r.active=!1,r.animation=null)}stop(){var t;null===(t=this.animation)||void 0===t||t.stop(),this.active=!1}}class uo extends co{constructor(t,e={}){e.easing=e.easing||"easeOutCubic",super(e),this.map=t}start(t,e,i,s){const{map:r}=this;this.animate(r.getZoomlevel(),t,s,(t=>{r.setZoomlevel(t,e,i)}))}}const fo=u.isFunction;class po{constructor(t,e){e=e||{};const i=this;i.map=t,i.duration=e.duration||500,fo(e.onStart)&&(i.onStart=e.onStart),fo(e.onStop)&&(i.onStop=e.onStop),i.raf=()=>{i._pan()&&(i.rafId=requestAnimationFrame(i.raf))}}_pan(){const t=this,e=t.deltaX,i=t.deltaY,s=t.duration,r=t.startTs,n=Math.min(Date.now()-r,s)/s,o=un(n)*e,a=un(n)*i;if(t.map.pan(o-t.lastDx||0,a-t.lastDy||0),o!=e||a!=i)return t.lastDx=o,t.lastDy=a,!0;t.onStop()}pan(t,e,i){this.startTs=t,this.deltaX=e,this.deltaY=i,this.onStart(),this.raf()}cancel(){const t=this.rafId;t&&(cancelAnimationFrame(t),this.rafId=null),this.onStop(),this.startTs=0,this.lastDx=0,this.lastDy=0}onStart(){}onStop(){}}const go={ui:{},behavior:{drag:!0,pitch:!1,rotate:!1},rotate:0,pitch:0,zoomlevel:18,center:{longitude:8.534,latitude:50.162},layers:null,maxLevel:20,minLevel:2,debug:!1,minPanMapThreshold:4,minRotateMapThreshold:4,minPitchMapThreshold:4,zoomAnimationMs:100,maxPitch:50,singleWorldView:!1,cameraTerrainOffset:200};class mo extends co{constructor(t,e={}){e.easing=e.easing||"easeOut",super(e),this.map=t}start(t,e,i){const{map:s}=this,r=s.getZoomlevel(),n=s._worldSizeFixed,o=s.getCenter(),a=p.lon2x(o.longitude,n),l=p.lat2y(o.latitude,n),h=p.lon2x(t.longitude,n),c=p.lat2y(t.latitude,n),u=Math.max(s.getWidth(),s.getHeight()),d=u/Math.pow(2,e-r),f=W(h,c,a,l)||1,g=1.42,m=2.0164,v=t=>(Math.exp(t)-Math.exp(-t))/2,y=t=>(Math.exp(t)+Math.exp(-t))/2,_=t=>{const e=(d*d-u*u+(t?-1:1)*m*m*f*f)/(2*(t?d:u)*m*f);return Math.log(Math.sqrt(e*e+1)-e)},b=_(0),w=t=>{return u*(y(b)*(v(e=b+g*t)/y(e))-v(b))/m;var e},A=(_(1)-b)/g,S=u*Math.pow(2,r);i=i||1e3*A*.77,this.animate(0,A,i,(i=>{const o=w(i)/f,d=a+(h-a)*o,m=l+(c-l)*o;let v,_;i>=A?(v=t,_=e):(v=new x(p.x2lon(d,n),p.y2lat(m,n)),_=Math.log(S/(t=>u*(y(b)/y(b+g*t)))(i))/Math.LN2,_=isNaN(_)?r:_),s.setZoomlevel(_),s.setCenter(v)}))}}class vo{constructor(t,e){this.map=t,this._prevCamPos={longitude:0,latitude:0,altitude:0},this._prevTime=null,this._camTerrainSmoothedAltitude=null,this._options=e}computeCamSpeed(t){const e=performance.now()/1e3;let i=0;if(null!=this._prevTime){const s=e-this._prevTime;if(s>0){const e=t.longitude-this._prevCamPos.longitude,r=t.latitude-this._prevCamPos.latitude,n=t.altitude-this._prevCamPos.altitude;i=Math.sqrt(e*e+r*r+n*n)/s}}return this._prevCamPos.longitude=t.longitude,this._prevCamPos.latitude=t.latitude,this._prevCamPos.altitude=t.altitude,this._prevTime=e,i}getTerrainHeightAtGeo(t,e){const i=this.map,s=i.geoToPixel(t,e),r=i._unprj(s.x,s.y);return i._getTerrainAtWorldXY(r[0],r[1])}ensureAboveTerrain(){if(this._camTerrainGuard)return null;const t=this.map,e=t.getCamera().position,i=this.getTerrainHeightAtGeo(e.longitude,e.latitude);if(null==i)return;let s=this._camTerrainSmoothedAltitude;if(null==s)s=i;else{const t=.85;s=s*t+i*(1-t)}this._camTerrainSmoothedAltitude=s;const r=s+this._options.cameraTerrainOffset,n=r-e.altitude;if(n>2){this._camTerrainGuard=!0;const i=n>5?r:e.altitude+.2*n;return t.setAltitude(i),this._camTerrainGuard=!1,r}return null}}const xo=p,yo=p.earthCircumference;let _o="fixed";const bo=180,wo=-180,Ao=85.05112878,So=-85.05112878,Mo=256,To="longitude",Lo="latitude",zo="zoom",Po="pitch",Co="rotate",Io="addLayer",Eo="removeLayer";let ko,Ro=[];let Fo=class{constructor(t,e){this._s=1,this._rz=0,this._rx=0,this._cWorldFixed=new y(0,0),this._c=new x(0,0),this._pc=new x(0,0),this._ox=0,this._oy=0,this._cfg=e=u.extend(!0,u.extend(!0,{},go),e||{});const i=this;i.id=1e6*Math.random()^0;const s=document.createElement("div");s.className="_"+u.String.random(11),s.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",s.style.position="relative",t.appendChild(s),this._el=s,this.resize();const r=e.zoomLevel||e.zoomlevel;e.maxLevel=Math.min(28,e.maxLevel),e.maxPitch=Math.min(85,e.maxPitch),this._z=0^Math.min(20,r),this._worldSizeFixed=Math.pow(2,this._z)*Mo,this._worldSize=Math.pow(2,r)*Mo,this._l=new h(["center","rotation","zoomlevel","pitch","mapviewchangestart","mapviewchange","mapviewchangeend","resize",Io,Eo]);let n=this._l,o=[];i._layers=o;const a="canvas"==e.renderer?an:Mr;"string"==typeof a.zoomBehavior&&(_o=a.zoomBehavior);const l=new a(s,256,e.devicePixelRatio,e.renderOptions||{});i._mvListener=new Hn(i,(function(t,e,i){n.trigger(t,[new vn(t,e)],i)}),l),i._display=l,this._camController=new vo(i,e),this.setBackgroundColor(e.backgroundColor),this._search=new Rn(i,l.layers,l.dpr);const c=this._evDispatcher=new Pn(s,i,o,e);n.add("mapviewchangestart",(t=>c.disable("pointerenter"))),n.add("mapviewchangeend",(t=>c.enable("pointerenter"))),n.add("mapviewchangeend",(t=>l.viewChangeDone())),this._zoomAnimator=new uo(i),this._flightAnimator=new mo(i);const d=Object.assign(Object.assign({},e.behavior),e.behaviour);d[zo]==ko&&(d[zo]=_o);let f=this._b=new mn(s,i,new po(i),d,e);f.drag(!0),f.scroll(!0),this._vplock={pan:!1,minLevel:e.minLevel,maxLevel:e.maxLevel};const p=e.UI||e.ui||{};p.Compass==ko&&(p.Compass=d[Co]||d[Po]),this.ui=new lo(s,e,i),i.setCenter(e.center),i.pitch(e.pitch),i.rotate(e.rotate),i.setZoomlevel(r),i._layerChangeListener=i._layerChangeListener.bind(i),i._onTerrainReadyListener=t=>{this._camController.ensureAboveTerrain()};for(let t of e.layers||[])i.addLayer(t);Ro.push(this),e.debug&&this.debug(e.debug)}static getInstances(){return Ro.slice()}get _cWorld(){const t=this._worldSize/this._worldSizeFixed;return new y(this._cWorldFixed.x*t,this._cWorldFixed.y*t)}_layerChangeListener(t){var e;this.refresh(null!==(e="clear"===t.type)&&void 0!==e?e:t.detail.layer)}initViewPort(){const t=this._s,e=this._worldSizeFixed,i=this._cWorldFixed.x,s=this._cWorldFixed.y,r=this._w/2,n=this._h/2,o=i-r/t,a=s-n/t;this._tlwx=i-r,this._tlwy=s-n,this._ox=i-r/t-o,this._oy=s-n/t-a;let l=xo.x2lon(o,e),h=xo.y2lat(a,e),c=i+r/t,u=s+n/t,d=xo.x2lon(c,e),f=xo.y2lat(u,e);return this._vp=new _(l,f,d,h),[i/e,s/e]}updateGrid(){const t=this._display,e=this._c,i=this._pc;this._mvListener.watch(!0),this._groundResolution=yo(e.latitude)/this._worldSizeFixed,t.setView(this.initViewPort(),this._s,this._rz,this._rx,this._groundResolution,this._worldSize);const s=this.getZoomlevel();for(let t of this._layers)t._initZoom(s);t.updateGrid(this._z,s,this._ox,this._oy),i[To]==e[To]&&i[Lo]==e[Lo]||(this._l.trigger("center",["center",e,i],!0),this._pc=e),this._camController.ensureAboveTerrain()}_getTerrainAtWorldXY(t,e){return this._display.getTerrainHeightAtWorldXY(t,e,this._terrainLayer)}_clipLatitude(t){return Math.min(Ao,Math.max(So,t))}_setCenter(t,e){const i=this._worldSizeFixed,s=this._worldSize;if(2!=arguments.length&&(t instanceof Array?(e=t[1],t=t[0]):(e=(t=t||this._c)[Lo],t=t[To])),isNaN(t)||isNaN(e)||"number"!=typeof t||"number"!=typeof e)return!1;if(t>bo?t-=360:t<wo&&(t+=360),e=this._clipLatitude(e),!this._repeatWorldViewX){const e=360/s*this._w*.5,i=t-e,r=t+e;i<-180&&(t-=i%180),r>180&&(t-=r%180)}if(this._cWorldFixed=new y(xo.lon2x(t,i),xo.lat2y(e,i)),this._maxZoomExtent){const t=(s/this._h-1)*this._h*.5,r=s/i,n=this._cWorldFixed.y*r,o=s/2;let a=0;const l=n+t;l<o&&(a=l);const h=n-t;h>o&&(a=h),a&&(this._cWorldFixed.y+=(o-a)/r,e=xo.y2lat(this._cWorldFixed.y,i))}return this._c=new x(t,e),!0}calculateMaxZoomExtent(){return Math.max(Math.log2(this._h/Mo),Math.log2(this._w/Mo))}repaint(){this.updateGrid()}debug(t){this._display.showGrid(t),this.updateGrid()}pitch(t){if(t!==ko){const e=this._cfg.maxPitch,i=(t=Math.max(0,Math.min(e,Math.round(t%360*10)/10)))*Math.PI/180,s=this._rx;s!=i&&(this._rx=i,this.updateGrid(),this._l.trigger("pitch",["pitch",t,180*s/Math.PI],!0))}return 180*this._rx/Math.PI}rotate(t){if(t!==ko){const e=Math.round(10*t||0)/10,i=e*Math.PI/180,s=this._rz;if(i!==s){const t=this._cx,r=this._cy,n=this._display.unproject(t,r),o=this._cWorldFixed;o.x+=n[0]-t,o.y+=n[1]-r,this._rz=i,this.updateGrid(),this._l.trigger("rotation",["rotation",e,s/Math.PI*180],!0)}}return this._rz/Math.PI*180}setBackgroundColor(t){this._display.setBGColor(t),this.refresh()}addEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.add(t,e);this._evDispatcher.addEventListener(t,e)}))}removeEventListener(t,e){const i=this._l;t.split(" ").forEach((t=>{if(i.isDefined(t))return i.remove(t,e);this._evDispatcher.removeEventListener(t,e)}))}getViewBounds(){let t=this._vp,e=t.minLon,i=t.maxLon,s=t.minLat,r=t.maxLat;return s<=So&&(s=-90),r>=Ao&&(r=90),e<wo&&(e=wo),i>bo&&(i=bo),new _(e,s,i,r)}setViewBounds(t,e){const i=arguments;let s,r,n,o;if("number"==typeof t?t=[i[0],i[1],i[2],i[3]]:"FeatureCollection"==t.type?t=t.features:"Feature"==t.type&&(t=[t]),Array.isArray(t)){if("object"==typeof t[0]){const e=[1/0,1/0,-1/0,-1/0];for(let i of t)b.calcBBox(i,e);t=e}s=t[0],r=t[1],n=t[2],o=t[3]}else{const e=t;s=e.minLon,r=e.minLat,n=e.maxLon,o=e.maxLat}const a=function(t,e,i,s,r,n){let o,a,l,h=Math.pow(2,20)*Mo;for(let c=20;c>=0;--c)if(l=20-c,o=(xo.lon2x(i,h)>>l)-(xo.lon2x(t,h)>>l),a=(xo.lat2y(e,h)>>l)-(xo.lat2y(s,h)>>l),o<=r&&a<=n)return c;return 0}(s,r,n,o,this.getWidth(),this.getHeight()),l=new x(s+(n-s)/2,r+(o-r)/2);e?this.flyTo(l,a,!0===e?{}:e):(this.setZoomlevel(a),this.setCenter(l))}getFeatureAt(t,e){e=e||{};const i=this.getFeaturesAt(t,e);if(i.length){const t=i[i.length-1];return t.feature=t.features[0],t}}getFeaturesAt(t,e){var i;let s,r,n,o,a=!1;e=e||{};let{layers:l}=e;if(l&&!Array.isArray(l)&&(l=[l]),t.x!=ko&&t.y!=ko){let h=t.x,c=t.y,u=0^e.width,d=e.height||u;if(!u&&!d){a=!0;const t=this._display.getRenderedFeatureAt(h,c,l);if(null!=t.id){const{layer:e}=t,s=e.getProvider(0^this.getZoomlevel()),r=null===(i=null==s?void 0:s.search)||void 0===i?void 0:i.call(s,t.id);if(r){const{pointWorld:i}=t;let s=null;if(i){const t=this._w2g(i[0],i[1],i[2]);s=new x(t[0],t[1],t[2])}return[{layer:e,features:[r],intersectionPoint:s}]}}}s=h-u/2,r=h+u/2,n=c-d/2,o=c+d/2}else t.minX!=ko&&t.maxX!=ko&&(s=t.minX,n=t.minY,r=t.maxX,o=t.maxY);return s!=ko&&this._search.search(s,n,r,o,l,a)}snapshot(t,e,i,s,r){if(!t)return;e||(e=0),i||(i=0),s||(s=this._w),r||(r=this._h),s+e>this._w&&(s=this._w-e),r+i>this._h&&(r=this._h-i);const n=this._display,{dpr:o}=n,a=n.copyCanvas2d(e,i,s,r),l=Math.ceil(11/3),h=this.ui.get("Copyright"),c=h.getSourceLabelsString(),u=h.getColors(),d=h.calcWidth();(async()=>{const e=await this.ui.get("Logo").getImage(),i=a.getContext("2d");i.scale(o,o),i.font="11px sans-serif",i.textBaseline="hanging",i.fillStyle=u.backgroundColor,i.fillRect(s-d-2*l,r-11-l,s+2*l,11+l),i.fillStyle=u.color,i.fillText(c,s-d-l,r-11),i.drawImage(e.img,2*l,r-e.height-2*l),a.style.width=`${s}px`,a.style.height=`${r}px`,t(a)})()}getBehavior(){const t={},e=this._b.getOptions();for(let i in e)t[i]=!!e[i];return t}setBehavior(t,e){let i=typeof t,s="object"==i?t:{};const r=this._b.getOptions();"string"==i&&(s[t]=e);let n=s[zo];n!=ko&&(r[zo]="fixed"==n||"float"==n?n:!!n&&_o);for(let t of["drag",Po,Co]){let e=s[t];e!=ko&&(r[t]=!!e)}}getZoomlevel(){return this._z+Math.log(this._s)/Math.LN2}setZoomlevel(t,e,i,s){const r=this._vplock,n=this._z,o=this._s;if(t=Math.round(1e3*t)/1e3,t=Math.max(Math.min(t,r.maxLevel),r.minLevel,this._maxZoomExtent),2==arguments.length&&(s=e,e=ko),e!=ko&&i!=ko||(e=this._cx,i=this._cy),n!=t||1!=o)if(this._worldSize=Math.pow(2,t)*Mo,s)this._zoomAnimator.start(t,e,i,"number"==typeof s?s:250);else{const s=this.getZoomlevel(),r=this._display.unproject(e,i),o=0^Math.min(20,t),a=n-o,l=this._worldSizeFixed,h=Math.pow(2,t-o);a&&(this._z=0^Math.min(20,t),this._worldSizeFixed=Math.pow(2,this._z)*Mo),this._display.setView(this.initViewPort(),h*Math.pow(.5,a),this._rz,this._rx,this._groundResolution,this._worldSize);const c=this._display.unproject(e,i);this._setCenter(xo.x2lon(this._cWorldFixed.x+r[0]-c[0],l),xo.y2lat(this._cWorldFixed.y+r[1]-c[1],l)),this._s=h,this.updateGrid(),this._l.trigger("zoomlevel",["zoomlevel",this.getZoomlevel(),s],!0)}}setAltitude(t,e=0){const i=this.getCamera().position,s=this._altToZoom(t),r=this.geoToPixel(i.longitude,i.latitude,0);this.setZoomlevel(s,r.x,r.y,e)}_altToZoom(t){const e=this.getZoomlevel(),i=this.getCamera().position;return e+Math.log2(i.altitude/t)}setCenter(t,e){this._setCenter.apply(this,arguments)&&this.updateGrid()}getCenter(){return new x(this._c.longitude,this._c.latitude)}flyTo(t,e,i){e&&"object"!=typeof e||(i=e,e=this.getZoomlevel()),this._flightAnimator.stop(),this._flightAnimator.start(t,e,null==i?void 0:i.duration)}lockViewport(t){const e=this._vplock;if(t){let i=t.pan,s=t.minLevel,r=t.maxLevel;s=!1===s?this._cfg.minLevel:s,r=!1===r?this._cfg.maxLevel:r,i!=ko&&(e.pan=i),"number"==typeof s&&(e.minLevel=s),"number"==typeof r&&(e.maxLevel=r)}return e}pan(t,e){if(0!=t||0!=e){const i=this._worldSizeFixed,s=this._cx,r=this._cy,n=this._cWorldFixed,o=this._display.unproject(s+t,r+e),a=n.x-o[0]+s,l=n.y-o[1]+r;this.setCenter(xo.x2lon(a,i),xo.y2lat(l,i))}}getLayers(t){const e=this._layers;return t!=ko?e[t]:e.slice()}addLayer(t,e){var i,s;const r=this._layers;if(-1==r.indexOf(t)){if(e==ko&&(e=r.length),t instanceof w){if(this._terrainLayer)throw new Error("Only one TerrainTileLayer instance can be added to the MapDisplay. Please ensure you add a single terrain layer to avoid conflicts.");this._terrainLayer=t,t.addEventListener("viewportReady",this._onTerrainReadyListener)}this._display.addLayer(t,e,null===(s=(i=t).getStyleManager)||void 0===s?void 0:s.call(i)),t.addEventListener("clear",this._layerChangeListener),t.addEventListener("layerVisibilityChange",this._layerChangeListener);const n={index:e,layer:t,map:this,context:this._display.getContext(),canvas:this._display.canvas};t.dispatchEvent("layerAdd",n),this._l.trigger(Io,[new vn(Io,n)]),r.splice(e,0,t),this.updateGrid()}}removeLayer(t){const e=this._layers,i=e.indexOf(t);i>=0&&(t instanceof w&&(this._terrainLayer=null,t.removeEventListener("viewportReady",this._onTerrainReadyListener)),this._display.removeLayer(t),t.removeEventListener("clear",this._layerChangeListener),t.removeEventListener("layerVisibilityChange",this._layerChangeListener),e.splice(i,1),this.updateGrid(),this._l.trigger(Eo,[new vn(Eo,{index:i,layer:t})]))}refresh(t){t instanceof Array||(t=[t]);for(let e of t)e instanceof m&&this._display.clearLayer(e);this.updateGrid()}pixelToGeo(t,e){1==arguments.length&&(e=t.y,t=t.x);const i=this._unprj(t,e),[s,r]=this._w2g(i);return new x(s,r)}_unprj(t,e,i){Array.isArray(t)&&([t,e,i]=t);const s=this._ox,r=this._oy,n=this._display.unproject(t,e,i);return n[0]+=s,n[1]+=r,n}_w2g(t,e,i){Array.isArray(t)&&(i=t[2],e=t[1],t=t[0]);const s=this._worldSizeFixed;let r=t+this._tlwx,n=e+this._tlwy;return r%=s,n%=s,n<0&&(n+=s),[xo.x2lon(r,s),xo.y2lat(n,s),i]}geoToPixel(t,e,i){e==ko&&(i=t.altitude,e=t.latitude,t=t.longitude);let[s,r]=this._g2w(t,e);return[s,r]=this._prj([s,r,i||0]),new y(s,r)}_g2w(t,e,i){Array.isArray(t)&&([t,e,i]=t),e=this._clipLatitude(e);const s=this._worldSizeFixed,r=this._tlwx,n=this._tlwy;return[xo.lon2x(t,s)-r,xo.lat2y(e,s)-n,i||0]}_prj(t){return this._display.project(t[0],t[1],t[2])}getCamera(){const t=this._display.render.cameraWorld,[e,i,s]=this._w2g(t[0],t[1],t[2]);return{position:{longitude:e,latitude:i,altitude:s}}}_translateGeoCoord(t,e,i,s){const r=this,n=r._groundResolution/r._s;let[o,a,l]=t;if(l+=s*n,e||i){const[t,s,n]=r._g2w(o,a,l);[o,a,l]=r._w2g([t+e,s+i,n])}return[o,a,l]}_scaleOffsetXYByAltitude(t,e){return(e?1:this._display.scaleOffsetXYByAltitude(t))/this._s}destroy(){const t=this._el;this.ui.destroy(),this._layers.forEach((t=>this.removeLayer(t))),this._display.destroy(),t.parentNode.removeChild(t),this._mvListener.watch(!1),this._evDispatcher.destroy(),this._b.drag(!1),this._b.scroll(!1);const e=this;e.__proto__=null,Object.keys(e).forEach((t=>delete e[t])),Ro.splice(Ro.indexOf(e),1)}resize(t,e){const i=this._el;t!=ko&&e!=ko||(t=M(i.parentNode,"width"),e=M(i.parentNode,"height"));const{_w:s,_h:r}=this;if(s!==t||r!==e){i.style.width=t+"px",i.style.height=e+"px",this._w=t,this._h=e,this._cx=t/2,this._cy=e/2;const{singleWorldView:s}=this._cfg;this._maxZoomExtent=s?this.calculateMaxZoomExtent():0,this._repeatWorldViewX=!s||"latitude"===s,this._display&&(this._display.setSize(t,e),this.setZoomlevel(this.getZoomlevel()),this.updateGrid(),this._l.trigger("resize",[new vn("resize",{width:t,height:e})]))}}getWidth(){return this._w}getHeight(){return this._h}addObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.add(t,e)}removeObserver(t,e){return"zoomLevel"==t&&(t="zoomlevel"),this._l.remove(t,e)}getContainer(){return this._el.parentNode}getTerrainPointAt(t){var e;const i=this._terrainLayer;return i&&(null===(e=this.getFeatureAt(t,{layers:i}))||void 0===e?void 0:e.intersectionPoint)||null}};Fo.fillZoomMap=it;class Do{constructor(t={}){var e,i,s;this.running=!1,this.paused=!1,this.pauseOffset=0,this.startTime=0,this.rafId=null,this.duration=null!==(e=t.duration)&&void 0!==e?e:1e3,this.loop=null!==(i=t.loop)&&void 0!==i&&i,this.easing=null!==(s=t.easing)&&void 0!==s?s:cn}start(){this.running=!0,this.paused=!1,this.pauseOffset=0,this.startTime=performance.now(),this.rafId=requestAnimationFrame(this.frame.bind(this))}pause(){this.running&&!this.paused&&(this.paused=!0,this.pauseOffsetStart=performance.now())}resume(){this.running&&this.paused&&(this.paused=!1,null!=this.pauseOffsetStart&&(this.pauseOffset+=performance.now()-this.pauseOffsetStart,this.pauseOffsetStart=void 0))}cancel(){this.running=!1,null!=this.rafId&&cancelAnimationFrame(this.rafId)}isRunning(){return this.running&&!this.paused}onComplete(t){this.onCompleteCb=t}complete(){return new Promise((t=>{this.onComplete((()=>t()))}))}frame(t){var e;if(!this.running)return;if(this.paused)return void(this.rafId=requestAnimationFrame(this.frame.bind(this)));const i=t-this.startTime-this.pauseOffset;let s=Math.max(0,Math.min(1,i/this.duration));s=this.easing(s),this.updateFrame(s),i>=this.duration?this.loop?(this.startTime=performance.now(),this.pauseOffset=0,this.rafId=requestAnimationFrame(this.frame.bind(this))):(this.running=!1,null===(e=this.onCompleteCb)||void 0===e||e.call(this)):this.rafId=requestAnimationFrame(this.frame.bind(this))}updateFrame(t){}}const Oo=(t,e,i)=>t*(1-i)+e*i,Uo=(t,e,i)=>[Oo(t[0],e[0],i),Oo(t[1],e[1],i)];class Bo extends Do{constructor(t,e,i={}){var s,r,n,o,a,l,h,c,u,d;null!==(s=i.duration)&&void 0!==s||(i.duration=5e3),super(i),this.totalLen=0,this.lastBearing=0,this.display=t,this.coords=e,this.speed=i.speed,this.autoRotate=null===(r=i.autoRotate)||void 0===r||r,this.headingSmoothing=null!==(n=i.headingSmoothing)&&void 0!==n?n:.95,this.mode=null!==(o=i.mode)&&void 0!==o?o:"drone",this.altitude=null!==(a=i.altitude)&&void 0!==a?a:"drone"===this.mode?5e3:0,this.cameraOffset=null!==(l=i.cameraOffset)&&void 0!==l?l:[0,0],this.lookAheadMeters=null!==(h=i.lookAheadMeters)&&void 0!==h?h:0,this.segLens=[0];for(let t=0;t<this.coords.length-1;t++)this.segLens.push(this.segLens[t]+f.distance(this.coords[t],this.coords[t+1]));this.totalLen=this.segLens[this.segLens.length-1],this.lastBearing=f.calcBearing(this.coords[0],this.coords[1]),this.speed&&this.speed>0&&(this.duration=this.totalLen/this.speed*1e3),this.pitch="car"===this.mode?85:"drone"===this.mode?50:(c=i.pitch,u=0,d=85,Math.max(u,Math.min(d,c)))}updateFrame(t){const e=t*this.totalLen,{i:i,t:s}=this.locateAlong(e),r=this.coords[i],n=this.coords[Math.min(i+1,this.coords.length-1)],o=Uo(r,n,s);let a=(null!=r[2]&&null!=n[2]?r[2]+(n[2]-r[2])*s:0)+this.altitude;this.display.setAltitude(a);let l,h=o;if("drone"===this.mode&&this.cameraOffset&&(h=f.movePoint(o,this.cameraOffset[0],this.lastBearing),a+=this.cameraOffset[1]),t>=1)l=this.lastBearing;else{const t=Math.min(e+Math.max(1,this.lookAheadMeters),this.totalLen-.001),{i:i,t:s}=this.locateAlong(t),r=this.coords[i],n=this.coords[Math.min(i+1,this.coords.length-1)],a=Uo(r,n,s);l="car"===this.mode?f.calcBearing(h,a):f.calcBearing(o,a)}const c=(u=this.lastBearing,d=l,p=1-this.headingSmoothing,(u+((d-u+540)%360-180)*(p=Math.max(0,Math.min(1,p)))+360)%360);var u,d,p;this.lastBearing=c,this.display.setCenter(h[0],h[1]),this.display.pitch(this.pitch),this.autoRotate&&this.display.rotate((360-c)%360)}locateAlong(t){const e=this.segLens,i=e.length-1;if(t<=0)return{i:0,t:0};if(t>=e[i])return{i:i-1,t:1};let s=0,r=i;for(;s<r;){const i=s+r>>1;e[i]<=t?s=i+1:r=i}const n=Math.max(0,s-1),o=e[n+1]-e[n];return{i:n,t:o>0?(t-e[n])/o:0}}}const Wo={scale:Ke,rotate:function(t,e,i,s){var r,n,o,a,l,h,c,u,d,f,p,g,m,v,x,y,_,b,w,A,S,M,T,L,z=s[0],P=s[1],C=s[2],I=Math.hypot(z,P,C);return I<Fe?null:(z*=I=1/I,P*=I,C*=I,r=Math.sin(i),o=1-(n=Math.cos(i)),a=e[0],l=e[1],h=e[2],c=e[3],u=e[4],d=e[5],f=e[6],p=e[7],g=e[8],m=e[9],v=e[10],x=e[11],y=z*z*o+n,_=P*z*o+C*r,b=C*z*o-P*r,w=z*P*o-C*r,A=P*P*o+n,S=C*P*o+z*r,M=z*C*o+P*r,T=P*C*o-z*r,L=C*C*o+n,t[0]=a*y+u*_+g*b,t[1]=l*y+d*_+m*b,t[2]=h*y+f*_+v*b,t[3]=c*y+p*_+x*b,t[4]=a*w+u*A+g*S,t[5]=l*w+d*A+m*S,t[6]=h*w+f*A+v*S,t[7]=c*w+p*A+x*S,t[8]=a*M+u*T+g*L,t[9]=l*M+d*T+m*L,t[10]=h*M+f*T+v*L,t[11]=c*M+p*T+x*L,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)},translate:$e,create:Ve,identity:Xe},No={transformMat4:Ye},Go=n.here.xyz.maps;Go.Map=Fo,Go.styleTools=yt;export{Bo as FollowPathAnimationController,Fo as Map,vn as MapEvent,Fo as default,Wo as mat4,yt as styleTools,No as vec3};
